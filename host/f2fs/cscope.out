cscope 15 $HOME/git/sallocate-app/f2fs               0000986749
	@acl.c

12 
	~<lšux/f2fs_fs.h
>

13 
	~"f2fs.h
"

14 
	~"x©Œ.h
"

15 
	~"aş.h
"

17 
šlše
 
size_t
 
	$f2fs_aş_size
(
couÁ
)

19 ià(
couÁ
 <= 4) {

20  (
f2fs_aş_h—d”
) +

21 
couÁ
 * (
f2fs_aş_’Œy_shÜt
);

23  (
f2fs_aş_h—d”
) +

24 4 * (
f2fs_aş_’Œy_shÜt
) +

25 (
couÁ
 - 4è* (
f2fs_aş_’Œy
);

27 
	}
}

29 
šlše
 
	$f2fs_aş_couÁ
(
size_t
 
size
)

31 
ssize_t
 
s
;

32 
size
 -ğ(
f2fs_aş_h—d”
);

33 
s
 = 
size
 - 4 * (
f2fs_aş_’Œy_shÜt
);

34 ià(
s
 < 0) {

35 ià(
size
 % (
f2fs_aş_’Œy_shÜt
))

37  
size
 / (
f2fs_aş_’Œy_shÜt
);

39 ià(
s
 % (
f2fs_aş_’Œy
))

41  
s
 / (
f2fs_aş_’Œy
) + 4;

43 
	}
}

45 
posix_aş
 *
	$f2fs_aş_äom_disk
(cÚ¡ *
v®ue
, 
size_t
 
size
)

47 
i
, 
couÁ
;

48 
posix_aş
 *
aş
;

49 
f2fs_aş_h—d”
 *
hdr
 = (f2fs_aş_h—d” *)
v®ue
;

50 
f2fs_aş_’Œy
 *
’Œy
 = (f2fs_aş_’Œy *)(
hdr
 + 1);

51 cÚ¡ *
’d
 = 
v®ue
 + 
size
;

53 ià(
size
 < (
f2fs_aş_h—d”
))

54  
	`ERR_PTR
(-
EINVAL
);

56 ià(
hdr
->
a_v”siÚ
 !ğ
	`ıu_to_Ë32
(
F2FS_ACL_VERSION
))

57  
	`ERR_PTR
(-
EINVAL
);

59 
couÁ
 = 
	`f2fs_aş_couÁ
(
size
);

60 ià(
couÁ
 < 0)

61  
	`ERR_PTR
(-
EINVAL
);

62 ià(
couÁ
 == 0)

63  
NULL
;

65 
aş
 = 
	`posix_aş_®loc
(
couÁ
, 
GFP_NOFS
);

66 ià(!
aş
)

67  
	`ERR_PTR
(-
ENOMEM
);

69 
i
 = 0; i < 
couÁ
; i++) {

71 ià((*)
’Œy
 > 
’d
)

72 
ç
;

74 
aş
->
a_’Œ›s
[
i
].
e_g
 = 
	`Ë16_to_ıu
(
’Œy
->e_tag);

75 
aş
->
a_’Œ›s
[
i
].
e_³rm
 = 
	`Ë16_to_ıu
(
’Œy
->e_perm);

77 
aş
->
a_’Œ›s
[
i
].
e_g
) {

78 
ACL_USER_OBJ
:

79 
ACL_GROUP_OBJ
:

80 
ACL_MASK
:

81 
ACL_OTHER
:

82 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

83 (
f2fs_aş_’Œy_shÜt
));

86 
ACL_USER
:

87 
aş
->
a_’Œ›s
[
i
].
e_uid
 =

88 
	`make_kuid
(&
š™_u£r_ns
,

89 
	`Ë32_to_ıu
(
’Œy
->
e_id
));

90 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

91 (
f2fs_aş_’Œy
));

93 
ACL_GROUP
:

94 
aş
->
a_’Œ›s
[
i
].
e_gid
 =

95 
	`make_kgid
(&
š™_u£r_ns
,

96 
	`Ë32_to_ıu
(
’Œy
->
e_id
));

97 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

98 (
f2fs_aş_’Œy
));

101 
ç
;

104 ià((*)
’Œy
 !ğ
’d
)

105 
ç
;

106  
aş
;

107 
ç
:

108 
	`posix_aş_»Ëa£
(
aş
);

109  
	`ERR_PTR
(-
EINVAL
);

110 
	}
}

112 *
	$f2fs_aş_to_disk
(
f2fs_sb_šfo
 *
sbi
,

113 cÚ¡ 
posix_aş
 *
aş
, 
size_t
 *
size
)

115 
f2fs_aş_h—d”
 *
f2fs_aş
;

116 
f2fs_aş_’Œy
 *
’Œy
;

117 
i
;

119 
f2fs_aş
 = 
	`f2fs_km®loc
(
sbi
, (
f2fs_aş_h—d”
) +

120 
aş
->
a_couÁ
 * (
f2fs_aş_’Œy
),

121 
GFP_NOFS
);

122 ià(!
f2fs_aş
)

123  
	`ERR_PTR
(-
ENOMEM
);

125 
f2fs_aş
->
a_v”siÚ
 = 
	`ıu_to_Ë32
(
F2FS_ACL_VERSION
);

126 
’Œy
 = (
f2fs_aş_’Œy
 *)(
f2fs_aş
 + 1);

128 
i
 = 0; i < 
aş
->
a_couÁ
; i++) {

130 
’Œy
->
e_g
 = 
	`ıu_to_Ë16
(
aş
->
a_’Œ›s
[
i
].e_tag);

131 
’Œy
->
e_³rm
 = 
	`ıu_to_Ë16
(
aş
->
a_’Œ›s
[
i
].e_perm);

133 
aş
->
a_’Œ›s
[
i
].
e_g
) {

134 
ACL_USER
:

135 
’Œy
->
e_id
 = 
	`ıu_to_Ë32
(

136 
	`äom_kuid
(&
š™_u£r_ns
,

137 
aş
->
a_’Œ›s
[
i
].
e_uid
));

138 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

139 (
f2fs_aş_’Œy
));

141 
ACL_GROUP
:

142 
’Œy
->
e_id
 = 
	`ıu_to_Ë32
(

143 
	`äom_kgid
(&
š™_u£r_ns
,

144 
aş
->
a_’Œ›s
[
i
].
e_gid
));

145 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

146 (
f2fs_aş_’Œy
));

148 
ACL_USER_OBJ
:

149 
ACL_GROUP_OBJ
:

150 
ACL_MASK
:

151 
ACL_OTHER
:

152 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

153 (
f2fs_aş_’Œy_shÜt
));

156 
ç
;

159 *
size
 = 
	`f2fs_aş_size
(
aş
->
a_couÁ
);

160  (*)
f2fs_aş
;

162 
ç
:

163 
	`kvä“
(
f2fs_aş
);

164  
	`ERR_PTR
(-
EINVAL
);

165 
	}
}

167 
posix_aş
 *
	$__f2fs_g‘_aş
(
šode
 *šode, 
ty³
,

168 
·ge
 *
d·ge
)

170 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
;

171 *
v®ue
 = 
NULL
;

172 
posix_aş
 *
aş
;

173 
»tv®
;

175 ià(
ty³
 =ğ
ACL_TYPE_ACCESS
)

176 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
;

178 
»tv®
 = 
	`f2fs_g‘x©Œ
(
šode
, 
Çme_šdex
, "", 
NULL
, 0, 
d·ge
);

179 ià(
»tv®
 > 0) {

180 
v®ue
 = 
	`f2fs_km®loc
(
	`F2FS_I_SB
(
šode
), 
»tv®
, 
GFP_F2FS_ZERO
);

181 ià(!
v®ue
)

182  
	`ERR_PTR
(-
ENOMEM
);

183 
»tv®
 = 
	`f2fs_g‘x©Œ
(
šode
, 
Çme_šdex
, "", 
v®ue
,

184 
»tv®
, 
d·ge
);

187 ià(
»tv®
 > 0)

188 
aş
 = 
	`f2fs_aş_äom_disk
(
v®ue
, 
»tv®
);

189 ià(
»tv®
 =ğ-
ENODATA
)

190 
aş
 = 
NULL
;

192 
aş
 = 
	`ERR_PTR
(
»tv®
);

193 
	`kvä“
(
v®ue
);

195  
aş
;

196 
	}
}

198 
posix_aş
 *
	$f2fs_g‘_aş
(
šode
 *šode, 
ty³
)

200  
	`__f2fs_g‘_aş
(
šode
, 
ty³
, 
NULL
);

201 
	}
}

203 
	$__f2fs_£t_aş
(
šode
 *šode, 
ty³
,

204 
posix_aş
 *
aş
, 
·ge
 *
age
)

206 
Çme_šdex
;

207 *
v®ue
 = 
NULL
;

208 
size_t
 
size
 = 0;

209 
”rÜ
;

210 
umode_t
 
mode
 = 
šode
->
i_mode
;

212 
ty³
) {

213 
ACL_TYPE_ACCESS
:

214 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
;

215 ià(
aş
 && !
age
) {

216 
”rÜ
 = 
	`posix_aş_upd©e_mode
(
šode
, &
mode
, &
aş
);

217 ià(
”rÜ
)

218  
”rÜ
;

219 
	`£t_aş_šode
(
šode
, 
mode
);

223 
ACL_TYPE_DEFAULT
:

224 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
;

225 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

226  
aş
 ? -
EACCES
 : 0;

230  -
EINVAL
;

233 ià(
aş
) {

234 
v®ue
 = 
	`f2fs_aş_to_disk
(
	`F2FS_I_SB
(
šode
), 
aş
, &
size
);

235 ià(
	`IS_ERR
(
v®ue
)) {

236 
	`ş—r_šode_æag
(
šode
, 
FI_ACL_MODE
);

237  
	`PTR_ERR
(
v®ue
);

241 
”rÜ
 = 
	`f2fs_£tx©Œ
(
šode
, 
Çme_šdex
, "", 
v®ue
, 
size
, 
age
, 0);

243 
	`kvä“
(
v®ue
);

244 ià(!
”rÜ
)

245 
	`£t_ÿched_aş
(
šode
, 
ty³
, 
aş
);

247 
	`ş—r_šode_æag
(
šode
, 
FI_ACL_MODE
);

248  
”rÜ
;

249 
	}
}

251 
	$f2fs_£t_aş
(
šode
 *šode, 
posix_aş
 *
aş
, 
ty³
)

253 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

254  -
EIO
;

256  
	`__f2fs_£t_aş
(
šode
, 
ty³
, 
aş
, 
NULL
);

257 
	}
}

263 
posix_aş
 *
	$f2fs_aş_şÚe
(cÚ¡ 
posix_aş
 *
aş
,

264 
gå_t
 
æags
)

266 
posix_aş
 *
şÚe
 = 
NULL
;

268 ià(
aş
) {

269 
size
 = (
posix_aş
è+ 
aş
->
a_couÁ
 *

270 (
posix_aş_’Œy
);

271 
şÚe
 = 
	`kmemdup
(
aş
, 
size
, 
æags
);

272 ià(
şÚe
)

273 
	`»fcouÁ_£t
(&
şÚe
->
a_»fcouÁ
, 1);

275  
şÚe
;

276 
	}
}

278 
	$f2fs_aş_ü—‹_masq
(
posix_aş
 *
aş
, 
umode_t
 *
mode_p
)

280 
posix_aş_’Œy
 *
·
, *
³
;

281 
posix_aş_’Œy
 *
group_obj
 = 
NULL
, *
mask_obj
 = NULL;

282 
umode_t
 
mode
 = *
mode_p
;

283 
nÙ_equiv
 = 0;

287 
	`FOREACH_ACL_ENTRY
(
·
, 
aş
, 
³
) {

288 
·
->
e_g
) {

289 
ACL_USER_OBJ
:

290 
·
->
e_³rm
 &ğ(
mode
 >> 6è| ~
S_IRWXO
;

291 
mode
 &ğ(
·
->
e_³rm
 << 6è| ~
S_IRWXU
;

294 
ACL_USER
:

295 
ACL_GROUP
:

296 
nÙ_equiv
 = 1;

299 
ACL_GROUP_OBJ
:

300 
group_obj
 = 
·
;

303 
ACL_OTHER
:

304 
·
->
e_³rm
 &ğ
mode
 | ~
S_IRWXO
;

305 
mode
 &ğ
·
->
e_³rm
 | ~
S_IRWXO
;

308 
ACL_MASK
:

309 
mask_obj
 = 
·
;

310 
nÙ_equiv
 = 1;

314  -
EIO
;

318 ià(
mask_obj
) {

319 
mask_obj
->
e_³rm
 &ğ(
mode
 >> 3è| ~
S_IRWXO
;

320 
mode
 &ğ(
mask_obj
->
e_³rm
 << 3è| ~
S_IRWXG
;

322 ià(!
group_obj
)

323  -
EIO
;

324 
group_obj
->
e_³rm
 &ğ(
mode
 >> 3è| ~
S_IRWXO
;

325 
mode
 &ğ(
group_obj
->
e_³rm
 << 3è| ~
S_IRWXG
;

328 *
mode_p
 = (*mode_°& ~
S_IRWXUGO
è| 
mode
;

329  
nÙ_equiv
;

330 
	}
}

332 
	$f2fs_aş_ü—‹
(
šode
 *
dœ
, 
umode_t
 *
mode
,

333 
posix_aş
 **
deçuÉ_aş
, posix_aş **
aş
,

334 
·ge
 *
d·ge
)

336 
posix_aş
 *
p
;

337 
posix_aş
 *
şÚe
;

338 
»t
;

340 *
aş
 = 
NULL
;

341 *
deçuÉ_aş
 = 
NULL
;

343 ià(
	`S_ISLNK
(*
mode
è|| !
	`IS_POSIXACL
(
dœ
))

346 
p
 = 
	`__f2fs_g‘_aş
(
dœ
, 
ACL_TYPE_DEFAULT
, 
d·ge
);

347 ià(!
p
 ||… =ğ
	`ERR_PTR
(-
EOPNOTSUPP
)) {

348 *
mode
 &ğ~
	`cu¼’t_umask
();

351 ià(
	`IS_ERR
(
p
))

352  
	`PTR_ERR
(
p
);

354 
şÚe
 = 
	`f2fs_aş_şÚe
(
p
, 
GFP_NOFS
);

355 ià(!
şÚe
) {

356 
»t
 = -
ENOMEM
;

357 
»Ëa£_aş
;

360 
»t
 = 
	`f2fs_aş_ü—‹_masq
(
şÚe
, 
mode
);

361 ià(
»t
 < 0)

362 
»Ëa£_şÚe
;

364 ià(
»t
 == 0)

365 
	`posix_aş_»Ëa£
(
şÚe
);

367 *
aş
 = 
şÚe
;

369 ià(!
	`S_ISDIR
(*
mode
))

370 
	`posix_aş_»Ëa£
(
p
);

372 *
deçuÉ_aş
 = 
p
;

376 
»Ëa£_şÚe
:

377 
	`posix_aş_»Ëa£
(
şÚe
);

378 
»Ëa£_aş
:

379 
	`posix_aş_»Ëa£
(
p
);

380  
»t
;

381 
	}
}

383 
	$f2fs_š™_aş
(
šode
 *šode, šod*
dœ
, 
·ge
 *
age
,

384 
·ge
 *
d·ge
)

386 
posix_aş
 *
deçuÉ_aş
 = 
NULL
, *
aş
 = NULL;

387 
”rÜ
 = 0;

389 
”rÜ
 = 
	`f2fs_aş_ü—‹
(
dœ
, &
šode
->
i_mode
, &
deçuÉ_aş
, &
aş
, 
d·ge
);

390 ià(
”rÜ
)

391  
”rÜ
;

393 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

395 ià(
deçuÉ_aş
) {

396 
”rÜ
 = 
	`__f2fs_£t_aş
(
šode
, 
ACL_TYPE_DEFAULT
, 
deçuÉ_aş
,

397 
age
);

398 
	`posix_aş_»Ëa£
(
deçuÉ_aş
);

400 
šode
->
i_deçuÉ_aş
 = 
NULL
;

402 ià(
aş
) {

403 ià(!
”rÜ
)

404 
”rÜ
 = 
	`__f2fs_£t_aş
(
šode
, 
ACL_TYPE_ACCESS
, 
aş
,

405 
age
);

406 
	`posix_aş_»Ëa£
(
aş
);

408 
šode
->
i_aş
 = 
NULL
;

411  
”rÜ
;

412 
	}
}

	@acl.h

12 #iâdeà
__F2FS_ACL_H__


13 
	#__F2FS_ACL_H__


	)

15 
	~<lšux/posix_aş_x©Œ.h
>

17 
	#F2FS_ACL_VERSION
 0x0001

	)

19 
	sf2fs_aş_’Œy
 {

20 
__Ë16
 
	me_g
;

21 
__Ë16
 
	me_³rm
;

22 
__Ë32
 
	me_id
;

25 
	sf2fs_aş_’Œy_shÜt
 {

26 
__Ë16
 
	me_g
;

27 
__Ë16
 
	me_³rm
;

30 
	sf2fs_aş_h—d”
 {

31 
__Ë32
 
	ma_v”siÚ
;

34 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


36 
posix_aş
 *
f2fs_g‘_aş
(
šode
 *, );

37 
f2fs_£t_aş
(
šode
 *, 
posix_aş
 *, );

38 
f2fs_š™_aş
(
šode
 *, šod*, 
·ge
 *,

39 
·ge
 *);

41 
	#f2fs_g‘_aş
 
NULL


	)

42 
	#f2fs_£t_aş
 
NULL


	)

44 
šlše
 
	$f2fs_š™_aş
(
šode
 *šode, šod*
dœ
,

45 
·ge
 *
age
, ·g*
d·ge
)

48 
	}
}

	@checkpoint.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/bio.h
>

10 
	~<lšux/m·ge.h
>

11 
	~<lšux/wr™eback.h
>

12 
	~<lšux/blkdev.h
>

13 
	~<lšux/f2fs_fs.h
>

14 
	~<lšux/·gevec.h
>

15 
	~<lšux/sw­.h
>

17 
	~"f2fs.h
"

18 
	~"node.h
"

19 
	~"£gm’t.h
"

20 
	~"Œaû.h
"

21 
	~<Œaû/ev’ts/f2fs.h
>

23 
kmem_ÿche
 *
	gšo_’Œy_¦ab
;

24 
kmem_ÿche
 *
	gf2fs_šode_’Œy_¦ab
;

26 
	$f2fs_¡İ_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
’d_io
)

28 
	`f2fs_bud_çuÉ_©Œ
(
sbi
, 0, 0);

29 
	`£t_ck±_æags
(
sbi
, 
CP_ERROR_FLAG
);

30 ià(!
’d_io
)

31 
	`f2fs_æush_m”ged_wr™es
(
sbi
);

32 
	}
}

37 
·ge
 *
	$f2fs_g¿b_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

39 
add»ss_¥aû
 *
m­pšg
 = 
	`META_MAPPING
(
sbi
);

40 
·ge
 *·gğ
NULL
;

41 
»³©
:

42 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
m­pšg
, 
šdex
, 
çl£
);

43 ià(!
·ge
) {

44 
	`cÚd_»sched
();

45 
»³©
;

47 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
META
, 
Œue
,rue);

48 ià(!
	`PageU±od©e
(
·ge
))

49 
	`S‘PageU±od©e
(
·ge
);

50  
·ge
;

51 
	}
}

56 
·ge
 *
	$__g‘_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
,

57 
boŞ
 
is_m‘a
)

59 
add»ss_¥aû
 *
m­pšg
 = 
	`META_MAPPING
(
sbi
);

60 
·ge
 *page;

61 
f2fs_io_šfo
 
fio
 = {

62 .
sbi
 = sbi,

63 .
ty³
 = 
META
,

64 .
İ
 = 
REQ_OP_READ
,

65 .
İ_æags
 = 
REQ_META
 | 
REQ_PRIO
,

66 .
Şd_blkaddr
 = 
šdex
,

67 .
Ãw_blkaddr
 = 
šdex
,

68 .
’üy±ed_·ge
 = 
NULL
,

69 .
is_pÜ
 = !
is_m‘a
,

71 
”r
;

73 ià(
	`uÆik–y
(!
is_m‘a
))

74 
fio
.
İ_æags
 &ğ~
REQ_META
;

75 
»³©
:

76 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
m­pšg
, 
šdex
, 
çl£
);

77 ià(!
·ge
) {

78 
	`cÚd_»sched
();

79 
»³©
;

81 ià(
	`PageU±od©e
(
·ge
))

82 
out
;

84 
fio
.
·ge
 =…age;

86 
”r
 = 
	`f2fs_subm™_·ge_bio
(&
fio
);

87 ià(
”r
) {

88 
	`f2fs_put_·ge
(
·ge
, 1);

89  
	`ERR_PTR
(
”r
);

92 
	`lock_·ge
(
·ge
);

93 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

94 
	`f2fs_put_·ge
(
·ge
, 1);

95 
»³©
;

98 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

99 
	`f2fs_put_·ge
(
·ge
, 1);

100  
	`ERR_PTR
(-
EIO
);

102 
out
:

103  
·ge
;

104 
	}
}

106 
·ge
 *
	$f2fs_g‘_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

108  
	`__g‘_m‘a_·ge
(
sbi
, 
šdex
, 
Œue
);

109 
	}
}

111 
·ge
 *
	$f2fs_g‘_m‘a_·ge_noç
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

113 
·ge
 *page;

114 
couÁ
 = 0;

116 
»Œy
:

117 
·ge
 = 
	`__g‘_m‘a_·ge
(
sbi
, 
šdex
, 
Œue
);

118 ià(
	`IS_ERR
(
·ge
)) {

119 ià(
	`PTR_ERR
(
·ge
è=ğ-
EIO
 &&

120 ++
couÁ
 <ğ
DEFAULT_RETRY_IO_COUNT
)

121 
»Œy
;

122 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

124  
·ge
;

125 
	}
}

128 
·ge
 *
	$f2fs_g‘_tmp_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

130  
	`__g‘_m‘a_·ge
(
sbi
, 
šdex
, 
çl£
);

131 
	}
}

133 
boŞ
 
	$__is_b™m­_v®id
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
,

134 
ty³
)

136 
£g_’Œy
 *
£
;

137 
£gno
, 
off£t
;

138 
boŞ
 
exi¡
;

140 ià(
ty³
 !ğ
DATA_GENERIC_ENHANCE
 &&y³ !ğ
DATA_GENERIC_ENHANCE_READ
)

141  
Œue
;

143 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blkaddr
);

144 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blkaddr
);

145 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

147 
exi¡
 = 
	`f2fs_‹¡_b™
(
off£t
, 
£
->
cur_v®id_m­
);

148 ià(!
exi¡
 && 
ty³
 =ğ
DATA_GENERIC_ENHANCE
) {

149 
	`f2fs_”r
(
sbi
, "Inconsistentƒrror blkaddr:%u, sit bitmap:%d",

150 
blkaddr
, 
exi¡
);

151 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

152 
	`WARN_ON
(1);

154  
exi¡
;

155 
	}
}

157 
boŞ
 
	$f2fs_is_v®id_blkaddr
(
f2fs_sb_šfo
 *
sbi
,

158 
block_t
 
blkaddr
, 
ty³
)

160 
ty³
) {

161 
META_NAT
:

163 
META_SIT
:

164 ià(
	`uÆik–y
(
blkaddr
 >ğ
	`SIT_BLK_CNT
(
sbi
)))

165  
çl£
;

167 
META_SSA
:

168 ià(
	`uÆik–y
(
blkaddr
 >ğ
	`MAIN_BLKADDR
(
sbi
) ||

169 
blkaddr
 < 
	`SM_I
(
sbi
)->
s§_blkaddr
))

170  
çl£
;

172 
META_CP
:

173 ià(
	`uÆik–y
(
blkaddr
 >ğ
	`SIT_I
(
sbi
)->
s™_ba£_addr
 ||

174 
blkaddr
 < 
	`__¡¬t_ı_addr
(
sbi
)))

175  
çl£
;

177 
META_POR
:

178 ià(
	`uÆik–y
(
blkaddr
 >ğ
	`MAX_BLKADDR
(
sbi
) ||

179 
blkaddr
 < 
	`MAIN_BLKADDR
(
sbi
)))

180  
çl£
;

182 
DATA_GENERIC
:

183 
DATA_GENERIC_ENHANCE
:

184 
DATA_GENERIC_ENHANCE_READ
:

185 ià(
	`uÆik–y
(
blkaddr
 >ğ
	`MAX_BLKADDR
(
sbi
) ||

186 
blkaddr
 < 
	`MAIN_BLKADDR
(
sbi
))) {

187 
	`f2fs_w¬n
(
sbi
, "access invalid blkaddr:%u",

188 
blkaddr
);

189 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

190 
	`WARN_ON
(1);

191  
çl£
;

193  
	`__is_b™m­_v®id
(
sbi
, 
blkaddr
, 
ty³
);

196 
META_GENERIC
:

197 ià(
	`uÆik–y
(
blkaddr
 < 
	`SEG0_BLKADDR
(
sbi
) ||

198 
blkaddr
 >ğ
	`MAIN_BLKADDR
(
sbi
)))

199  
çl£
;

202 
	`BUG
();

205  
Œue
;

206 
	}
}

211 
	$f2fs_¿_m‘a_·ges
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t
, 
Ä·ges
,

212 
ty³
, 
boŞ
 
sync
)

214 
·ge
 *page;

215 
block_t
 
blkno
 = 
¡¬t
;

216 
f2fs_io_šfo
 
fio
 = {

217 .
sbi
 = sbi,

218 .
ty³
 = 
META
,

219 .
İ
 = 
REQ_OP_READ
,

220 .
İ_æags
 = 
sync
 ? (
REQ_META
 | 
REQ_PRIO
è: 
REQ_RAHEAD
,

221 .
’üy±ed_·ge
 = 
NULL
,

222 .
š_li¡
 = 
çl£
,

223 .
is_pÜ
 = (
ty³
 =ğ
META_POR
),

225 
blk_¶ug
 
¶ug
;

227 ià(
	`uÆik–y
(
ty³
 =ğ
META_POR
))

228 
fio
.
İ_æags
 &ğ~
REQ_META
;

230 
	`blk_¡¬t_¶ug
(&
¶ug
);

231 ; 
Ä·ges
-- > 0; 
blkno
++) {

233 ià(!
	`f2fs_is_v®id_blkaddr
(
sbi
, 
blkno
, 
ty³
))

234 
out
;

236 
ty³
) {

237 
META_NAT
:

238 ià(
	`uÆik–y
(
blkno
 >=

239 
	`NAT_BLOCK_OFFSET
(
	`NM_I
(
sbi
)->
max_nid
)))

240 
blkno
 = 0;

242 
fio
.
Ãw_blkaddr
 = 
	`cu¼’t_Çt_addr
(
sbi
,

243 
blkno
 * 
NAT_ENTRY_PER_BLOCK
);

245 
META_SIT
:

247 
fio
.
Ãw_blkaddr
 = 
	`cu¼’t_s™_addr
(
sbi
,

248 
blkno
 * 
SIT_ENTRY_PER_BLOCK
);

250 
META_SSA
:

251 
META_CP
:

252 
META_POR
:

253 
fio
.
Ãw_blkaddr
 = 
blkno
;

256 
	`BUG
();

259 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`META_MAPPING
(
sbi
),

260 
fio
.
Ãw_blkaddr
, 
çl£
);

261 ià(!
·ge
)

263 ià(
	`PageU±od©e
(
·ge
)) {

264 
	`f2fs_put_·ge
(
·ge
, 1);

268 
fio
.
·ge
 =…age;

269 
	`f2fs_subm™_·ge_bio
(&
fio
);

270 
	`f2fs_put_·ge
(
·ge
, 0);

272 
out
:

273 
	`blk_fšish_¶ug
(&
¶ug
);

274  
blkno
 - 
¡¬t
;

275 
	}
}

277 
	$f2fs_¿_m‘a_·ges_cÚd
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

279 
·ge
 *page;

280 
boŞ
 
»adah—d
 = 
çl£
;

282 
·ge
 = 
	`fšd_g‘_·ge
(
	`META_MAPPING
(
sbi
), 
šdex
);

283 ià(!
·ge
 || !
	`PageU±od©e
(page))

284 
»adah—d
 = 
Œue
;

285 
	`f2fs_put_·ge
(
·ge
, 0);

287 ià(
»adah—d
)

288 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
šdex
, 
BIO_MAX_PAGES
, 
META_POR
, 
Œue
);

289 
	}
}

291 
	$__f2fs_wr™e_m‘a_·ge
(
·ge
 *page,

292 
wr™eback_cÚŒŞ
 *
wbc
,

293 
io¡©_ty³
 
io_ty³
)

295 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

297 
	`Œaû_f2fs_wr™•age
(
·ge
, 
META
);

299 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

300 
»dœty_out
;

301 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

302 
»dœty_out
;

303 ià(
wbc
->
fÜ_»şaim
 && 
·ge
->
šdex
 < 
	`GET_SUM_BLOCK
(
sbi
, 0))

304 
»dœty_out
;

306 
	`f2fs_do_wr™e_m‘a_·ge
(
sbi
, 
·ge
, 
io_ty³
);

307 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_META
);

309 ià(
wbc
->
fÜ_»şaim
)

310 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
NULL
, 
·ge
, 0, 
META
);

312 
	`uÆock_·ge
(
·ge
);

314 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

315 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
META
);

319 
»dœty_out
:

320 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

321  
AOP_WRITEPAGE_ACTIVATE
;

322 
	}
}

324 
	$f2fs_wr™e_m‘a_·ge
(
·ge
 *page,

325 
wr™eback_cÚŒŞ
 *
wbc
)

327  
	`__f2fs_wr™e_m‘a_·ge
(
·ge
, 
wbc
, 
FS_META_IO
);

328 
	}
}

330 
	$f2fs_wr™e_m‘a_·ges
(
add»ss_¥aû
 *
m­pšg
,

331 
wr™eback_cÚŒŞ
 *
wbc
)

333 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_M_SB
(
m­pšg
);

334 
diff
, 
wr™‹n
;

336 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

337 
sk_wr™e
;

340 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_ALL
 &&

341 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
) <

342 
	`Ä_·ges_to_sk
(
sbi
, 
META
))

343 
sk_wr™e
;

346 ià(!
	`mu‹x_Œylock
(&
sbi
->
ı_mu‹x
))

347 
sk_wr™e
;

349 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
META
);

350 
diff
 = 
	`Ä_·ges_to_wr™e
(
sbi
, 
META
, 
wbc
);

351 
wr™‹n
 = 
	`f2fs_sync_m‘a_·ges
(
sbi
, 
META
, 
wbc
->
Ä_to_wr™e
, 
FS_META_IO
);

352 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

353 
wbc
->
Ä_to_wr™e
 = 
	`max
(()0, wbc->Ä_to_wr™- 
wr™‹n
 - 
diff
);

356 
sk_wr™e
:

357 
wbc
->
·ges_sk³d
 +ğ
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
);

358 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
META
);

360 
	}
}

362 
	$f2fs_sync_m‘a_·ges
(
f2fs_sb_šfo
 *
sbi
, 
·ge_ty³
 
ty³
,

363 
Ä_to_wr™e
, 
io¡©_ty³
 
io_ty³
)

365 
add»ss_¥aû
 *
m­pšg
 = 
	`META_MAPPING
(
sbi
);

366 
pgoff_t
 
šdex
 = 0, 
´ev
 = 
ULONG_MAX
;

367 
·gevec
 
pvec
;

368 
nwr™‹n
 = 0;

369 
Ä_·ges
;

370 
wr™eback_cÚŒŞ
 
wbc
 = {

371 .
fÜ_»şaim
 = 0,

373 
blk_¶ug
 
¶ug
;

375 
	`·gevec_š™
(&
pvec
);

377 
	`blk_¡¬t_¶ug
(&
¶ug
);

379 (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
m­pšg
, &
šdex
,

380 
PAGECACHE_TAG_DIRTY
))) {

381 
i
;

383 
i
 = 0; i < 
Ä_·ges
; i++) {

384 
·ge
 *·gğ
pvec
.
·ges
[
i
];

386 ià(
´ev
 =ğ
ULONG_MAX
)

387 
´ev
 = 
·ge
->
šdex
 - 1;

388 ià(
Ä_to_wr™e
 !ğ
LONG_MAX
 && 
·ge
->
šdex
 !ğ
´ev
 + 1) {

389 
	`·gevec_»Ëa£
(&
pvec
);

390 
¡İ
;

393 
	`lock_·ge
(
·ge
);

395 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

396 
cÚtšue_uÆock
:

397 
	`uÆock_·ge
(
·ge
);

400 ià(!
	`PageDœty
(
·ge
)) {

402 
cÚtšue_uÆock
;

405 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
META
, 
Œue
,rue);

407 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

408 
cÚtšue_uÆock
;

410 ià(
	`__f2fs_wr™e_m‘a_·ge
(
·ge
, &
wbc
, 
io_ty³
)) {

411 
	`uÆock_·ge
(
·ge
);

414 
nwr™‹n
++;

415 
´ev
 = 
·ge
->
šdex
;

416 ià(
	`uÆik–y
(
nwr™‹n
 >ğ
Ä_to_wr™e
))

419 
	`·gevec_»Ëa£
(&
pvec
);

420 
	`cÚd_»sched
();

422 
¡İ
:

423 ià(
nwr™‹n
)

424 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
ty³
);

426 
	`blk_fšish_¶ug
(&
¶ug
);

428  
nwr™‹n
;

429 
	}
}

431 
	$f2fs_£t_m‘a_·ge_dœty
(
·ge
 *page)

433 
	`Œaû_f2fs_£t_·ge_dœty
(
·ge
, 
META
);

435 ià(!
	`PageU±od©e
(
·ge
))

436 
	`S‘PageU±od©e
(
·ge
);

437 ià(!
	`PageDœty
(
·ge
)) {

438 
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

439 
	`šc_·ge_couÁ
(
	`F2FS_P_SB
(
·ge
), 
F2FS_DIRTY_META
);

440 
	`f2fs_£t_·ge_´iv©e
(
·ge
, 0);

441 
	`f2fs_Œaû_pid
(
·ge
);

445 
	}
}

447 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gf2fs_m‘a_aİs
 = {

448 .
wr™•age
 = 
f2fs_wr™e_m‘a_·ge
,

449 .
	gwr™•ages
 = 
f2fs_wr™e_m‘a_·ges
,

450 .
	g£t_·ge_dœty
 = 
f2fs_£t_m‘a_·ge_dœty
,

451 .
	gšv®id©•age
 = 
f2fs_šv®id©e_·ge
,

452 .
	g»Ëa£·ge
 = 
f2fs_»Ëa£_·ge
,

453 #ifdeà
CONFIG_MIGRATION


454 .
	gmig¿‹·ge
 = 
f2fs_mig¿‹_·ge
,

458 
	$__add_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

459 
devidx
, 
ty³
)

461 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ty³
];

462 
šo_’Œy
 *
e
, *
tmp
;

464 
tmp
 = 
	`f2fs_kmem_ÿche_®loc
(
šo_’Œy_¦ab
, 
GFP_NOFS
);

466 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
 | 
__GFP_NOFAIL
);

468 
	`¥š_lock
(&
im
->
šo_lock
);

469 
e
 = 
	`¿dix_Œ“_lookup
(&
im
->
šo_roÙ
, 
šo
);

470 ià(!
e
) {

471 
e
 = 
tmp
;

472 ià(
	`uÆik–y
(
	`¿dix_Œ“_š£¹
(&
im
->
šo_roÙ
, 
šo
, 
e
)))

473 
	`f2fs_bug_Ú
(
sbi
, 1);

475 
	`mem£t
(
e
, 0, (
šo_’Œy
));

476 
e
->
šo
 = ino;

478 
	`li¡_add_
(&
e
->
li¡
, &
im
->
šo_li¡
);

479 ià(
ty³
 !ğ
ORPHAN_INO
)

480 
im
->
šo_num
++;

483 ià(
ty³
 =ğ
FLUSH_INO
)

484 
	`f2fs_£t_b™
(
devidx
, (*)&
e
->
dœty_deviû
);

486 
	`¥š_uÆock
(&
im
->
šo_lock
);

487 
	`¿dix_Œ“_´–ßd_’d
();

489 ià(
e
 !ğ
tmp
)

490 
	`kmem_ÿche_ä“
(
šo_’Œy_¦ab
, 
tmp
);

491 
	}
}

493 
	$__»move_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
)

495 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ty³
];

496 
šo_’Œy
 *
e
;

498 
	`¥š_lock
(&
im
->
šo_lock
);

499 
e
 = 
	`¿dix_Œ“_lookup
(&
im
->
šo_roÙ
, 
šo
);

500 ià(
e
) {

501 
	`li¡_d–
(&
e
->
li¡
);

502 
	`¿dix_Œ“_d–‘e
(&
im
->
šo_roÙ
, 
šo
);

503 
im
->
šo_num
--;

504 
	`¥š_uÆock
(&
im
->
šo_lock
);

505 
	`kmem_ÿche_ä“
(
šo_’Œy_¦ab
, 
e
);

508 
	`¥š_uÆock
(&
im
->
šo_lock
);

509 
	}
}

511 
	$f2fs_add_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
)

514 
	`__add_šo_’Œy
(
sbi
, 
šo
, 0, 
ty³
);

515 
	}
}

517 
	$f2fs_»move_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
)

520 
	`__»move_šo_’Œy
(
sbi
, 
šo
, 
ty³
);

521 
	}
}

524 
boŞ
 
	$f2fs_exi¡_wr™‹n_d©a
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
mode
)

526 
šode_mªagem’t
 *
im
 = &
sbi
->im[
mode
];

527 
šo_’Œy
 *
e
;

529 
	`¥š_lock
(&
im
->
šo_lock
);

530 
e
 = 
	`¿dix_Œ“_lookup
(&
im
->
šo_roÙ
, 
šo
);

531 
	`¥š_uÆock
(&
im
->
šo_lock
);

532  
e
 ? 
Œue
 : 
çl£
;

533 
	}
}

535 
	$f2fs_»Ëa£_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
®l
)

537 
šo_’Œy
 *
e
, *
tmp
;

538 
i
;

540 
i
 = 
®l
 ? 
ORPHAN_INO
 : 
APPEND_INO
; i < 
MAX_INO_ENTRY
; i++) {

541 
šode_mªagem’t
 *
im
 = &
sbi
->im[
i
];

543 
	`¥š_lock
(&
im
->
šo_lock
);

544 
	`li¡_fÜ_—ch_’Œy_§ã
(
e
, 
tmp
, &
im
->
šo_li¡
, 
li¡
) {

545 
	`li¡_d–
(&
e
->
li¡
);

546 
	`¿dix_Œ“_d–‘e
(&
im
->
šo_roÙ
, 
e
->
šo
);

547 
	`kmem_ÿche_ä“
(
šo_’Œy_¦ab
, 
e
);

548 
im
->
šo_num
--;

550 
	`¥š_uÆock
(&
im
->
šo_lock
);

552 
	}
}

554 
	$f2fs_£t_dœty_deviû
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

555 
devidx
, 
ty³
)

557 
	`__add_šo_’Œy
(
sbi
, 
šo
, 
devidx
, 
ty³
);

558 
	}
}

560 
boŞ
 
	$f2fs_is_dœty_deviû
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

561 
devidx
, 
ty³
)

563 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ty³
];

564 
šo_’Œy
 *
e
;

565 
boŞ
 
is_dœty
 = 
çl£
;

567 
	`¥š_lock
(&
im
->
šo_lock
);

568 
e
 = 
	`¿dix_Œ“_lookup
(&
im
->
šo_roÙ
, 
šo
);

569 ià(
e
 && 
	`f2fs_‹¡_b™
(
devidx
, (*)&e->
dœty_deviû
))

570 
is_dœty
 = 
Œue
;

571 
	`¥š_uÆock
(&
im
->
šo_lock
);

572  
is_dœty
;

573 
	}
}

575 
	$f2fs_acquœe_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
)

577 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ORPHAN_INO
];

578 
”r
 = 0;

580 
	`¥š_lock
(&
im
->
šo_lock
);

582 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_ORPHAN
)) {

583 
	`¥š_uÆock
(&
im
->
šo_lock
);

584 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_ORPHAN
);

585  -
ENOSPC
;

588 ià(
	`uÆik–y
(
im
->
šo_num
 >ğ
sbi
->
max_Üphªs
))

589 
”r
 = -
ENOSPC
;

591 
im
->
šo_num
++;

592 
	`¥š_uÆock
(&
im
->
šo_lock
);

594  
”r
;

595 
	}
}

597 
	$f2fs_»Ëa£_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
)

599 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ORPHAN_INO
];

601 
	`¥š_lock
(&
im
->
šo_lock
);

602 
	`f2fs_bug_Ú
(
sbi
, 
im
->
šo_num
 == 0);

603 
im
->
šo_num
--;

604 
	`¥š_uÆock
(&
im
->
šo_lock
);

605 
	}
}

607 
	$f2fs_add_Üphª_šode
(
šode
 *inode)

610 
	`__add_šo_’Œy
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
, 0, 
ORPHAN_INO
);

611 
	`f2fs_upd©e_šode_·ge
(
šode
);

612 
	}
}

614 
	$f2fs_»move_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

617 
	`__»move_šo_’Œy
(
sbi
, 
šo
, 
ORPHAN_INO
);

618 
	}
}

620 
	$»cov”_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

622 
šode
 *inode;

623 
node_šfo
 
ni
;

624 
”r
;

626 
šode
 = 
	`f2fs_ig‘_»Œy
(
sbi
->
sb
, 
šo
);

627 ià(
	`IS_ERR
(
šode
)) {

632 
	`f2fs_bug_Ú
(
sbi
, 
	`PTR_ERR
(
šode
è=ğ-
ENOENT
);

633  
	`PTR_ERR
(
šode
);

636 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

637 ià(
”r
) {

638 
	`ut
(
šode
);

639 
”r_out
;

642 
	`ş—r_Æšk
(
šode
);

645 
	`ut
(
šode
);

647 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
šo
, &
ni
);

648 ià(
”r
)

649 
”r_out
;

652 ià(
ni
.
blk_addr
 !ğ
NULL_ADDR
) {

653 
”r
 = -
EIO
;

654 
”r_out
;

658 
”r_out
:

659 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

660 
	`f2fs_w¬n
(
sbi
, "%s: orphan failed (ino=%x),„un fscko fix.",

661 
__func__
, 
šo
);

662  
”r
;

663 
	}
}

665 
	$f2fs_»cov”_Üphª_šodes
(
f2fs_sb_šfo
 *
sbi
)

667 
block_t
 
¡¬t_blk
, 
Üphª_blocks
, 
i
, 
j
;

668 
s_æags
 = 
sbi
->
sb
->s_flags;

669 
”r
 = 0;

670 #ifdeà
CONFIG_QUOTA


671 
quÙa_’abËd
;

674 ià(!
	`is_£t_ck±_æags
(
sbi
, 
CP_ORPHAN_PRESENT_FLAG
))

677 ià(
	`bdev_»ad_Úly
(
sbi
->
sb
->
s_bdev
)) {

678 
	`f2fs_šfo
(
sbi
, "write‡ccess unavailable, skipping orphan cleanup");

682 ià(
s_æags
 & 
SB_RDONLY
) {

683 
	`f2fs_šfo
(
sbi
, "orphan cleanup on„eadonly fs");

684 
sbi
->
sb
->
s_æags
 &ğ~
SB_RDONLY
;

687 #ifdeà
CONFIG_QUOTA


689 
sbi
->
sb
->
s_æags
 |ğ
SB_ACTIVE
;

695 
quÙa_’abËd
 = 
	`f2fs_’abË_quÙa_fes
(
sbi
, 
s_æags
 & 
SB_RDONLY
);

698 
¡¬t_blk
 = 
	`__¡¬t_ı_addr
(
sbi
è+ 1 + 
	`__ı_·ylßd
(sbi);

699 
Üphª_blocks
 = 
	`__¡¬t_sum_addr
(
sbi
è- 1 - 
	`__ı_·ylßd
(sbi);

701 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
¡¬t_blk
, 
Üphª_blocks
, 
META_CP
, 
Œue
);

703 
i
 = 0; i < 
Üphª_blocks
; i++) {

704 
·ge
 *page;

705 
f2fs_Üphª_block
 *
Üphª_blk
;

707 
·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
¡¬t_blk
 + 
i
);

708 ià(
	`IS_ERR
(
·ge
)) {

709 
”r
 = 
	`PTR_ERR
(
·ge
);

710 
out
;

713 
Üphª_blk
 = (
f2fs_Üphª_block
 *)
	`·ge_add»ss
(
·ge
);

714 
j
 = 0; j < 
	`Ë32_to_ıu
(
Üphª_blk
->
’Œy_couÁ
); j++) {

715 
nid_t
 
šo
 = 
	`Ë32_to_ıu
(
Üphª_blk
->šo[
j
]);

716 
”r
 = 
	`»cov”_Üphª_šode
(
sbi
, 
šo
);

717 ià(
”r
) {

718 
	`f2fs_put_·ge
(
·ge
, 1);

719 
out
;

722 
	`f2fs_put_·ge
(
·ge
, 1);

725 
	`ş—r_ck±_æags
(
sbi
, 
CP_ORPHAN_PRESENT_FLAG
);

726 
out
:

727 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_RECOVERED
);

729 #ifdeà
CONFIG_QUOTA


731 ià(
quÙa_’abËd
)

732 
	`f2fs_quÙa_off_umouÁ
(
sbi
->
sb
);

734 
sbi
->
sb
->
s_æags
 = s_flags;

736  
”r
;

737 
	}
}

739 
	$wr™e_Üphª_šodes
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
)

741 
li¡_h—d
 *
h—d
;

742 
f2fs_Üphª_block
 *
Üphª_blk
 = 
NULL
;

743 
ÃÁr›s
 = 0;

744 
šdex
 = 1;

745 
Üphª_blocks
;

746 
·ge
 *·gğ
NULL
;

747 
šo_’Œy
 *
Üphª
 = 
NULL
;

748 
šode_mªagem’t
 *
im
 = &
sbi
->im[
ORPHAN_INO
];

750 
Üphª_blocks
 = 
	`GET_ORPHAN_BLOCKS
(
im
->
šo_num
);

757 
h—d
 = &
im
->
šo_li¡
;

760 
	`li¡_fÜ_—ch_’Œy
(
Üphª
, 
h—d
, 
li¡
) {

761 ià(!
·ge
) {

762 
·ge
 = 
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
¡¬t_blk
++);

763 
Üphª_blk
 =

764 (
f2fs_Üphª_block
 *)
	`·ge_add»ss
(
·ge
);

765 
	`mem£t
(
Üphª_blk
, 0, (*orphan_blk));

768 
Üphª_blk
->
šo
[
ÃÁr›s
++] = 
	`ıu_to_Ë32
(
Üphª
->ino);

770 ià(
ÃÁr›s
 =ğ
F2FS_ORPHANS_PER_BLOCK
) {

776 
Üphª_blk
->
blk_addr
 = 
	`ıu_to_Ë16
(
šdex
);

777 
Üphª_blk
->
blk_couÁ
 = 
	`ıu_to_Ë16
(
Üphª_blocks
);

778 
Üphª_blk
->
’Œy_couÁ
 = 
	`ıu_to_Ë32
(
ÃÁr›s
);

779 
	`£t_·ge_dœty
(
·ge
);

780 
	`f2fs_put_·ge
(
·ge
, 1);

781 
šdex
++;

782 
ÃÁr›s
 = 0;

783 
·ge
 = 
NULL
;

787 ià(
·ge
) {

788 
Üphª_blk
->
blk_addr
 = 
	`ıu_to_Ë16
(
šdex
);

789 
Üphª_blk
->
blk_couÁ
 = 
	`ıu_to_Ë16
(
Üphª_blocks
);

790 
Üphª_blk
->
’Œy_couÁ
 = 
	`ıu_to_Ë32
(
ÃÁr›s
);

791 
	`£t_·ge_dœty
(
·ge
);

792 
	`f2fs_put_·ge
(
·ge
, 1);

794 
	}
}

796 
__u32
 
	$f2fs_checkpošt_chksum
(
f2fs_sb_šfo
 *
sbi
,

797 
f2fs_checkpošt
 *
ck±
)

799 
chksum_ofs
 = 
	`Ë32_to_ıu
(
ck±
->
checksum_off£t
);

800 
__u32
 
chksum
;

802 
chksum
 = 
	`f2fs_üc32
(
sbi
, 
ck±
, 
chksum_ofs
);

803 ià(
chksum_ofs
 < 
CP_CHKSUM_OFFSET
) {

804 
chksum_ofs
 +ğ(
chksum
);

805 
chksum
 = 
	`f2fs_chksum
(
sbi
, chksum, (
__u8
 *)
ck±
 + 
chksum_ofs
,

806 
F2FS_BLKSIZE
 - 
chksum_ofs
);

808  
chksum
;

809 
	}
}

811 
	$g‘_checkpošt_v”siÚ
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
ı_addr
,

812 
f2fs_checkpošt
 **
ı_block
, 
·ge
 **
ı_·ge
,

813 *
v”siÚ
)

815 
size_t
 
üc_off£t
 = 0;

816 
__u32
 
üc
;

818 *
ı_·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
ı_addr
);

819 ià(
	`IS_ERR
(*
ı_·ge
))

820  
	`PTR_ERR
(*
ı_·ge
);

822 *
ı_block
 = (
f2fs_checkpošt
 *)
	`·ge_add»ss
(*
ı_·ge
);

824 
üc_off£t
 = 
	`Ë32_to_ıu
((*
ı_block
)->
checksum_off£t
);

825 ià(
üc_off£t
 < 
CP_MIN_CHKSUM_OFFSET
 ||

826 
üc_off£t
 > 
CP_CHKSUM_OFFSET
) {

827 
	`f2fs_put_·ge
(*
ı_·ge
, 1);

828 
	`f2fs_w¬n
(
sbi
, "šv®id crc_off£t: %zu", 
üc_off£t
);

829  -
EINVAL
;

832 
üc
 = 
	`f2fs_checkpošt_chksum
(
sbi
, *
ı_block
);

833 ià(
üc
 !ğ
	`cur_ı_üc
(*
ı_block
)) {

834 
	`f2fs_put_·ge
(*
ı_·ge
, 1);

835 
	`f2fs_w¬n
(
sbi
, "invalid crc value");

836  -
EINVAL
;

839 *
v”siÚ
 = 
	`cur_ı_v”siÚ
(*
ı_block
);

841 
	}
}

843 
·ge
 *
	$v®id©e_checkpošt
(
f2fs_sb_šfo
 *
sbi
,

844 
block_t
 
ı_addr
, *
v”siÚ
)

846 
·ge
 *
ı_·ge_1
 = 
NULL
, *
ı_·ge_2
 = NULL;

847 
f2fs_checkpošt
 *
ı_block
 = 
NULL
;

848 
cur_v”siÚ
 = 0, 
´e_v”siÚ
 = 0;

849 
”r
;

851 
”r
 = 
	`g‘_checkpošt_v”siÚ
(
sbi
, 
ı_addr
, &
ı_block
,

852 &
ı_·ge_1
, 
v”siÚ
);

853 ià(
”r
)

854  
NULL
;

856 ià(
	`Ë32_to_ıu
(
ı_block
->
ı_·ck_tÙ®_block_couÁ
) >

857 
sbi
->
blocks_³r_£g
) {

858 
	`f2fs_w¬n
(
sbi
, "invalid cp_pack_total_block_count:%u",

859 
	`Ë32_to_ıu
(
ı_block
->
ı_·ck_tÙ®_block_couÁ
));

860 
šv®id_ı
;

862 
´e_v”siÚ
 = *
v”siÚ
;

864 
ı_addr
 +ğ
	`Ë32_to_ıu
(
ı_block
->
ı_·ck_tÙ®_block_couÁ
) - 1;

865 
”r
 = 
	`g‘_checkpošt_v”siÚ
(
sbi
, 
ı_addr
, &
ı_block
,

866 &
ı_·ge_2
, 
v”siÚ
);

867 ià(
”r
)

868 
šv®id_ı
;

869 
cur_v”siÚ
 = *
v”siÚ
;

871 ià(
cur_v”siÚ
 =ğ
´e_v”siÚ
) {

872 *
v”siÚ
 = 
cur_v”siÚ
;

873 
	`f2fs_put_·ge
(
ı_·ge_2
, 1);

874  
ı_·ge_1
;

876 
	`f2fs_put_·ge
(
ı_·ge_2
, 1);

877 
šv®id_ı
:

878 
	`f2fs_put_·ge
(
ı_·ge_1
, 1);

879  
NULL
;

880 
	}
}

882 
	$f2fs_g‘_v®id_checkpošt
(
f2fs_sb_šfo
 *
sbi
)

884 
f2fs_checkpošt
 *
ı_block
;

885 
f2fs_su³r_block
 *
fsb
 = 
sbi
->
¿w_su³r
;

886 
·ge
 *
ı1
, *
ı2
, *
cur_·ge
;

887 
blk_size
 = 
sbi
->
blocksize
;

888 
ı1_v”siÚ
 = 0, 
ı2_v”siÚ
 = 0;

889 
ı_¡¬t_blk_no
;

890 
ı_blks
 = 1 + 
	`__ı_·ylßd
(
sbi
);

891 
block_t
 
ı_blk_no
;

892 
i
;

893 
”r
;

895 
sbi
->
ck±
 = 
	`f2fs_kz®loc
(sbi, 
	`¬¿y_size
(
blk_size
, 
ı_blks
),

896 
GFP_KERNEL
);

897 ià(!
sbi
->
ck±
)

898  -
ENOMEM
;

903 
ı_¡¬t_blk_no
 = 
	`Ë32_to_ıu
(
fsb
->
ı_blkaddr
);

904 
ı1
 = 
	`v®id©e_checkpošt
(
sbi
, 
ı_¡¬t_blk_no
, &
ı1_v”siÚ
);

907 
ı_¡¬t_blk_no
 += (()1) <<

908 
	`Ë32_to_ıu
(
fsb
->
log_blocks_³r_£g
);

909 
ı2
 = 
	`v®id©e_checkpošt
(
sbi
, 
ı_¡¬t_blk_no
, &
ı2_v”siÚ
);

911 ià(
ı1
 && 
ı2
) {

912 ià(
	`v”_aá”
(
ı2_v”siÚ
, 
ı1_v”siÚ
))

913 
cur_·ge
 = 
ı2
;

915 
cur_·ge
 = 
ı1
;

916 } ià(
ı1
) {

917 
cur_·ge
 = 
ı1
;

918 } ià(
ı2
) {

919 
cur_·ge
 = 
ı2
;

921 
”r
 = -
EFSCORRUPTED
;

922 
ç_no_ı
;

925 
ı_block
 = (
f2fs_checkpošt
 *)
	`·ge_add»ss
(
cur_·ge
);

926 
	`memıy
(
sbi
->
ck±
, 
ı_block
, 
blk_size
);

928 ià(
cur_·ge
 =ğ
ı1
)

929 
sbi
->
cur_ı_·ck
 = 1;

931 
sbi
->
cur_ı_·ck
 = 2;

934 ià(
	`f2fs_§n™y_check_ck±
(
sbi
)) {

935 
”r
 = -
EFSCORRUPTED
;

936 
ä“_ç_no_ı
;

939 ià(
ı_blks
 <= 1)

940 
dÚe
;

942 
ı_blk_no
 = 
	`Ë32_to_ıu
(
fsb
->
ı_blkaddr
);

943 ià(
cur_·ge
 =ğ
ı2
)

944 
ı_blk_no
 +ğ1 << 
	`Ë32_to_ıu
(
fsb
->
log_blocks_³r_£g
);

946 
i
 = 1; i < 
ı_blks
; i++) {

947 *
s™_b™m­_±r
;

948 *
ck±
 = (*)
sbi
->ckpt;

950 
cur_·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
ı_blk_no
 + 
i
);

951 ià(
	`IS_ERR
(
cur_·ge
)) {

952 
”r
 = 
	`PTR_ERR
(
cur_·ge
);

953 
ä“_ç_no_ı
;

955 
s™_b™m­_±r
 = 
	`·ge_add»ss
(
cur_·ge
);

956 
	`memıy
(
ck±
 + 
i
 * 
blk_size
, 
s™_b™m­_±r
, blk_size);

957 
	`f2fs_put_·ge
(
cur_·ge
, 1);

959 
dÚe
:

960 
	`f2fs_put_·ge
(
ı1
, 1);

961 
	`f2fs_put_·ge
(
ı2
, 1);

964 
ä“_ç_no_ı
:

965 
	`f2fs_put_·ge
(
ı1
, 1);

966 
	`f2fs_put_·ge
(
ı2
, 1);

967 
ç_no_ı
:

968 
	`kvä“
(
sbi
->
ck±
);

969  
”r
;

970 
	}
}

972 
	$__add_dœty_šode
(
šode
 *šode, 
šode_ty³
 
ty³
)

974 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

975 
æag
 = (
ty³
 =ğ
DIR_INODE
è? 
FI_DIRTY_DIR
 : 
FI_DIRTY_FILE
;

977 ià(
	`is_šode_æag_£t
(
šode
, 
æag
))

980 
	`£t_šode_æag
(
šode
, 
æag
);

981 ià(!
	`f2fs_is_vŞ©e_fe
(
šode
))

982 
	`li¡_add_
(&
	`F2FS_I
(
šode
)->
dœty_li¡
,

983 &
sbi
->
šode_li¡
[
ty³
]);

984 
	`¡©_šc_dœty_šode
(
sbi
, 
ty³
);

985 
	}
}

987 
	$__»move_dœty_šode
(
šode
 *šode, 
šode_ty³
 
ty³
)

989 
æag
 = (
ty³
 =ğ
DIR_INODE
è? 
FI_DIRTY_DIR
 : 
FI_DIRTY_FILE
;

991 ià(
	`g‘_dœty_·ges
(
šode
è|| !
	`is_šode_æag_£t
(šode, 
æag
))

994 
	`li¡_d–_š™
(&
	`F2FS_I
(
šode
)->
dœty_li¡
);

995 
	`ş—r_šode_æag
(
šode
, 
æag
);

996 
	`¡©_dec_dœty_šode
(
	`F2FS_I_SB
(
šode
), 
ty³
);

997 
	}
}

999 
	$f2fs_upd©e_dœty_·ge
(
šode
 *šode, 
·ge
 *page)

1001 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1002 
šode_ty³
 
ty³
 = 
	`S_ISDIR
(
šode
->
i_mode
è? 
DIR_INODE
 : 
FILE_INODE
;

1004 ià(!
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`S_ISREG
(inode->i_mode) &&

1005 !
	`S_ISLNK
(
šode
->
i_mode
))

1008 
	`¥š_lock
(&
sbi
->
šode_lock
[
ty³
]);

1009 ià(
ty³
 !ğ
FILE_INODE
 || 
	`‹¡_İt
(
sbi
, 
DATA_FLUSH
))

1010 
	`__add_dœty_šode
(
šode
, 
ty³
);

1011 
	`šode_šc_dœty_·ges
(
šode
);

1012 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ty³
]);

1014 
	`f2fs_£t_·ge_´iv©e
(
·ge
, 0);

1015 
	`f2fs_Œaû_pid
(
·ge
);

1016 
	}
}

1018 
	$f2fs_»move_dœty_šode
(
šode
 *inode)

1020 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1021 
šode_ty³
 
ty³
 = 
	`S_ISDIR
(
šode
->
i_mode
è? 
DIR_INODE
 : 
FILE_INODE
;

1023 ià(!
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`S_ISREG
(inode->i_mode) &&

1024 !
	`S_ISLNK
(
šode
->
i_mode
))

1027 ià(
ty³
 =ğ
FILE_INODE
 && !
	`‹¡_İt
(
sbi
, 
DATA_FLUSH
))

1030 
	`¥š_lock
(&
sbi
->
šode_lock
[
ty³
]);

1031 
	`__»move_dœty_šode
(
šode
, 
ty³
);

1032 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ty³
]);

1033 
	}
}

1035 
	$f2fs_sync_dœty_šodes
(
f2fs_sb_šfo
 *
sbi
, 
šode_ty³
 
ty³
)

1037 
li¡_h—d
 *
h—d
;

1038 
šode
 *inode;

1039 
f2fs_šode_šfo
 *
fi
;

1040 
boŞ
 
is_dœ
 = (
ty³
 =ğ
DIR_INODE
);

1041 
šo
 = 0;

1043 
	`Œaû_f2fs_sync_dœty_šodes_’‹r
(
sbi
->
sb
, 
is_dœ
,

1044 
	`g‘_·ges
(
sbi
, 
is_dœ
 ?

1045 
F2FS_DIRTY_DENTS
 : 
F2FS_DIRTY_DATA
));

1046 
»Œy
:

1047 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1048  -
EIO
;

1050 
	`¥š_lock
(&
sbi
->
šode_lock
[
ty³
]);

1052 
h—d
 = &
sbi
->
šode_li¡
[
ty³
];

1053 ià(
	`li¡_em±y
(
h—d
)) {

1054 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ty³
]);

1055 
	`Œaû_f2fs_sync_dœty_šodes_ex™
(
sbi
->
sb
, 
is_dœ
,

1056 
	`g‘_·ges
(
sbi
, 
is_dœ
 ?

1057 
F2FS_DIRTY_DENTS
 : 
F2FS_DIRTY_DATA
));

1060 
fi
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
f2fs_šode_šfo
, 
dœty_li¡
);

1061 
šode
 = 
	`ig¿b
(&
fi
->
vfs_šode
);

1062 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ty³
]);

1063 ià(
šode
) {

1064 
cur_šo
 = 
šode
->
i_šo
;

1066 
	`F2FS_I
(
šode
)->
ı_sk
 = 
cu¼’t
;

1068 
	`fem­_fd©awr™e
(
šode
->
i_m­pšg
);

1070 
	`F2FS_I
(
šode
)->
ı_sk
 = 
NULL
;

1072 
	`ut
(
šode
);

1074 ià(
šo
 =ğ
cur_šo
)

1075 
	`cÚd_»sched
();

1077 
šo
 = 
cur_šo
;

1083 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
DATA
);

1084 
	`cÚd_»sched
();

1086 
»Œy
;

1087 
	}
}

1089 
	$f2fs_sync_šode_m‘a
(
f2fs_sb_šfo
 *
sbi
)

1091 
li¡_h—d
 *
h—d
 = &
sbi
->
šode_li¡
[
DIRTY_META
];

1092 
šode
 *inode;

1093 
f2fs_šode_šfo
 *
fi
;

1094 
s64
 
tÙ®
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
);

1096 
tÙ®
--) {

1097 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1098  -
EIO
;

1100 
	`¥š_lock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1101 ià(
	`li¡_em±y
(
h—d
)) {

1102 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1105 
fi
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
f2fs_šode_šfo
,

1106 
gdœty_li¡
);

1107 
šode
 = 
	`ig¿b
(&
fi
->
vfs_šode
);

1108 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1109 ià(
šode
) {

1110 
	`sync_šode_m‘ad©a
(
šode
, 0);

1113 ià(
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
))

1114 
	`f2fs_upd©e_šode_·ge
(
šode
);

1115 
	`ut
(
šode
);

1119 
	}
}

1121 
	$__´•¬e_ı_block
(
f2fs_sb_šfo
 *
sbi
)

1123 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1124 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1125 
nid_t
 
Ï¡_nid
 = 
nm_i
->
Ãxt_sÿn_nid
;

1127 
	`Ãxt_ä“_nid
(
sbi
, &
Ï¡_nid
);

1128 
ck±
->
v®id_block_couÁ
 = 
	`ıu_to_Ë64
(
	`v®id_u£r_blocks
(
sbi
));

1129 
ck±
->
v®id_node_couÁ
 = 
	`ıu_to_Ë32
(
	`v®id_node_couÁ
(
sbi
));

1130 
ck±
->
v®id_šode_couÁ
 = 
	`ıu_to_Ë32
(
	`v®id_šode_couÁ
(
sbi
));

1131 
ck±
->
Ãxt_ä“_nid
 = 
	`ıu_to_Ë32
(
Ï¡_nid
);

1132 
	}
}

1134 
boŞ
 
	$__Ãed_æush_quÙa
(
f2fs_sb_šfo
 *
sbi
)

1136 
boŞ
 
»t
 = 
çl£
;

1138 ià(!
	`is_jouº®Ëd_quÙa
(
sbi
))

1139  
çl£
;

1141 
	`down_wr™e
(&
sbi
->
quÙa_£m
);

1142 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_QUOTA_SKIP_FLUSH
)) {

1143 
»t
 = 
çl£
;

1144 } ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
)) {

1145 
»t
 = 
çl£
;

1146 } ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_QUOTA_NEED_FLUSH
)) {

1147 
	`ş—r_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_FLUSH
);

1148 
»t
 = 
Œue
;

1149 } ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_QDATA
)) {

1150 
»t
 = 
Œue
;

1152 
	`up_wr™e
(&
sbi
->
quÙa_£m
);

1153  
»t
;

1154 
	}
}

1159 
	$block_İ”©iÚs
(
f2fs_sb_šfo
 *
sbi
)

1161 
wr™eback_cÚŒŞ
 
wbc
 = {

1162 .
sync_mode
 = 
WB_SYNC_ALL
,

1163 .
Ä_to_wr™e
 = 
LONG_MAX
,

1164 .
fÜ_»şaim
 = 0,

1166 
blk_¶ug
 
¶ug
;

1167 
”r
 = 0, 
út
 = 0;

1169 
	`blk_¡¬t_¶ug
(&
¶ug
);

1171 
»Œy_æush_quÙas
:

1172 
	`f2fs_lock_®l
(
sbi
);

1173 ià(
	`__Ãed_æush_quÙa
(
sbi
)) {

1174 
locked
;

1176 ià(++
út
 > 
DEFAULT_RETRY_QUOTA_FLUSH_COUNT
) {

1177 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_SKIP_FLUSH
);

1178 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_FLUSH
);

1179 
»Œy_æush_d’ts
;

1181 
	`f2fs_uÆock_®l
(
sbi
);

1184 
locked
 = 
	`down_»ad_Œylock
(&
sbi
->
sb
->
s_umouÁ
);

1185 
	`f2fs_quÙa_sync
(
sbi
->
sb
, -1);

1186 ià(
locked
)

1187 
	`up_»ad
(&
sbi
->
sb
->
s_umouÁ
);

1188 
	`cÚd_»sched
();

1189 
»Œy_æush_quÙas
;

1192 
»Œy_æush_d’ts
:

1194 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
)) {

1195 
	`f2fs_uÆock_®l
(
sbi
);

1196 
”r
 = 
	`f2fs_sync_dœty_šodes
(
sbi
, 
DIR_INODE
);

1197 ià(
”r
)

1198 
out
;

1199 
	`cÚd_»sched
();

1200 
»Œy_æush_quÙas
;

1207 
	`down_wr™e
(&
sbi
->
node_chªge
);

1209 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
)) {

1210 
	`up_wr™e
(&
sbi
->
node_chªge
);

1211 
	`f2fs_uÆock_®l
(
sbi
);

1212 
”r
 = 
	`f2fs_sync_šode_m‘a
(
sbi
);

1213 ià(
”r
)

1214 
out
;

1215 
	`cÚd_»sched
();

1216 
»Œy_æush_quÙas
;

1219 
»Œy_æush_nodes
:

1220 
	`down_wr™e
(&
sbi
->
node_wr™e
);

1222 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
)) {

1223 
	`up_wr™e
(&
sbi
->
node_wr™e
);

1224 
	`©omic_šc
(&
sbi
->
wb_sync_»q
[
NODE
]);

1225 
”r
 = 
	`f2fs_sync_node_·ges
(
sbi
, &
wbc
, 
çl£
, 
FS_CP_NODE_IO
);

1226 
	`©omic_dec
(&
sbi
->
wb_sync_»q
[
NODE
]);

1227 ià(
”r
) {

1228 
	`up_wr™e
(&
sbi
->
node_chªge
);

1229 
	`f2fs_uÆock_®l
(
sbi
);

1230 
out
;

1232 
	`cÚd_»sched
();

1233 
»Œy_æush_nodes
;

1240 
	`__´•¬e_ı_block
(
sbi
);

1241 
	`up_wr™e
(&
sbi
->
node_chªge
);

1242 
out
:

1243 
	`blk_fšish_¶ug
(&
¶ug
);

1244  
”r
;

1245 
	}
}

1247 
	$unblock_İ”©iÚs
(
f2fs_sb_šfo
 *
sbi
)

1249 
	`up_wr™e
(&
sbi
->
node_wr™e
);

1250 
	`f2fs_uÆock_®l
(
sbi
);

1251 
	}
}

1253 
	$f2fs_wa™_Ú_®l_·ges_wr™eback
(
f2fs_sb_šfo
 *
sbi
)

1255 
	`DEFINE_WAIT
(
wa™
);

1258 
	`´•¬e_to_wa™
(&
sbi
->
ı_wa™
, &
wa™
, 
TASK_UNINTERRUPTIBLE
);

1260 ià(!
	`g‘_·ges
(
sbi
, 
F2FS_WB_CP_DATA
))

1263 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1266 
	`io_scheduË_timeout
(5*
HZ
);

1268 
	`fšish_wa™
(&
sbi
->
ı_wa™
, &
wa™
);

1269 
	}
}

1271 
	$upd©e_ck±_æags
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

1273 
Üphª_num
 = 
sbi
->
im
[
ORPHAN_INO
].
šo_num
;

1274 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1275 
æags
;

1277 
	`¥š_lock_œq§ve
(&
sbi
->
ı_lock
, 
æags
);

1279 ià((
ıc
->
»asÚ
 & 
CP_UMOUNT
) &&

1280 
	`Ë32_to_ıu
(
ck±
->
ı_·ck_tÙ®_block_couÁ
) >

1281 
sbi
->
blocks_³r_£g
 - 
	`NM_I
(sbi)->
Çt_b™s_blocks
)

1282 
	`di§bË_Çt_b™s
(
sbi
, 
çl£
);

1284 ià(
ıc
->
»asÚ
 & 
CP_TRIMMED
)

1285 
	`__£t_ck±_æags
(
ck±
, 
CP_TRIMMED_FLAG
);

1287 
	`__ş—r_ck±_æags
(
ck±
, 
CP_TRIMMED_FLAG
);

1289 ià(
ıc
->
»asÚ
 & 
CP_UMOUNT
)

1290 
	`__£t_ck±_æags
(
ck±
, 
CP_UMOUNT_FLAG
);

1292 
	`__ş—r_ck±_æags
(
ck±
, 
CP_UMOUNT_FLAG
);

1294 ià(
ıc
->
»asÚ
 & 
CP_FASTBOOT
)

1295 
	`__£t_ck±_æags
(
ck±
, 
CP_FASTBOOT_FLAG
);

1297 
	`__ş—r_ck±_æags
(
ck±
, 
CP_FASTBOOT_FLAG
);

1299 ià(
Üphª_num
)

1300 
	`__£t_ck±_æags
(
ck±
, 
CP_ORPHAN_PRESENT_FLAG
);

1302 
	`__ş—r_ck±_æags
(
ck±
, 
CP_ORPHAN_PRESENT_FLAG
);

1304 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_FSCK
) ||

1305 
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_RESIZEFS
))

1306 
	`__£t_ck±_æags
(
ck±
, 
CP_FSCK_FLAG
);

1308 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
))

1309 
	`__£t_ck±_æags
(
ck±
, 
CP_DISABLED_FLAG
);

1311 
	`__ş—r_ck±_æags
(
ck±
, 
CP_DISABLED_FLAG
);

1313 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED_QUICK
))

1314 
	`__£t_ck±_æags
(
ck±
, 
CP_DISABLED_QUICK_FLAG
);

1316 
	`__ş—r_ck±_æags
(
ck±
, 
CP_DISABLED_QUICK_FLAG
);

1318 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_QUOTA_SKIP_FLUSH
))

1319 
	`__£t_ck±_æags
(
ck±
, 
CP_QUOTA_NEED_FSCK_FLAG
);

1321 
	`__ş—r_ck±_æags
(
ck±
, 
CP_QUOTA_NEED_FSCK_FLAG
);

1323 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
))

1324 
	`__£t_ck±_æags
(
ck±
, 
CP_QUOTA_NEED_FSCK_FLAG
);

1327 
	`__£t_ck±_æags
(
ck±
, 
CP_CRC_RECOVERY_FLAG
);

1328 
	`__ş—r_ck±_æags
(
ck±
, 
CP_NOCRC_RECOVERY_FLAG
);

1330 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
ı_lock
, 
æags
);

1331 
	}
}

1333 
	$comm™_checkpošt
(
f2fs_sb_šfo
 *
sbi
,

1334 *
¤c
, 
block_t
 
blk_addr
)

1336 
wr™eback_cÚŒŞ
 
wbc
 = {

1337 .
fÜ_»şaim
 = 0,

1345 
·ge
 *·gğ
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
blk_addr
);

1346 
”r
;

1348 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
META
, 
Œue
,rue);

1350 
	`memıy
(
	`·ge_add»ss
(
·ge
), 
¤c
, 
PAGE_SIZE
);

1352 
	`£t_·ge_dœty
(
·ge
);

1353 ià(
	`uÆik–y
(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
)))

1354 
	`f2fs_bug_Ú
(
sbi
, 1);

1357 
”r
 = 
	`__f2fs_wr™e_m‘a_·ge
(
·ge
, &
wbc
, 
FS_CP_META_IO
);

1358 ià(
	`uÆik–y
(
”r
 && 
	`f2fs_ı_”rÜ
(
sbi
))) {

1359 
	`f2fs_put_·ge
(
·ge
, 1);

1363 
	`f2fs_bug_Ú
(
sbi
, 
”r
);

1364 
	`f2fs_put_·ge
(
·ge
, 0);

1367 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
META_FLUSH
);

1368 
	}
}

1370 
	$do_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

1372 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1373 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1374 
Üphª_num
 = 
sbi
->
im
[
ORPHAN_INO
].
šo_num
, 
æags
;

1375 
block_t
 
¡¬t_blk
;

1376 
d©a_sum_blocks
, 
Üphª_blocks
;

1377 
__u32
 
üc32
 = 0;

1378 
i
;

1379 
ı_·ylßd_blks
 = 
	`__ı_·ylßd
(
sbi
);

1380 
su³r_block
 *
sb
 = 
sbi
->sb;

1381 
cur£g_šfo
 *
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_NODE
);

1382 
u64
 
kby‹s_wr™‹n
;

1383 
”r
;

1386 
	`f2fs_sync_m‘a_·ges
(
sbi
, 
META
, 
LONG_MAX
, 
FS_CP_META_IO
);

1387 
	`f2fs_bug_Ú
(
sbi
, 
	`g‘_·ges
(sbi, 
F2FS_DIRTY_META
) &&

1388 !
	`f2fs_ı_”rÜ
(
sbi
));

1394 
ck±
->
–­£d_time
 = 
	`ıu_to_Ë64
(
	`g‘_mtime
(
sbi
, 
Œue
));

1395 
ck±
->
ä“_£gm’t_couÁ
 = 
	`ıu_to_Ë32
(
	`ä“_£gm’ts
(
sbi
));

1396 
i
 = 0; i < 
NR_CURSEG_NODE_TYPE
; i++) {

1397 
ck±
->
cur_node_£gno
[
i
] =

1398 
	`ıu_to_Ë32
(
	`cur£g_£gno
(
sbi
, 
i
 + 
CURSEG_HOT_NODE
));

1399 
ck±
->
cur_node_blkoff
[
i
] =

1400 
	`ıu_to_Ë16
(
	`cur£g_blkoff
(
sbi
, 
i
 + 
CURSEG_HOT_NODE
));

1401 
ck±
->
®loc_ty³
[
i
 + 
CURSEG_HOT_NODE
] =

1402 
	`cur£g_®loc_ty³
(
sbi
, 
i
 + 
CURSEG_HOT_NODE
);

1404 
i
 = 0; i < 
NR_CURSEG_DATA_TYPE
; i++) {

1405 
ck±
->
cur_d©a_£gno
[
i
] =

1406 
	`ıu_to_Ë32
(
	`cur£g_£gno
(
sbi
, 
i
 + 
CURSEG_HOT_DATA
));

1407 
ck±
->
cur_d©a_blkoff
[
i
] =

1408 
	`ıu_to_Ë16
(
	`cur£g_blkoff
(
sbi
, 
i
 + 
CURSEG_HOT_DATA
));

1409 
ck±
->
®loc_ty³
[
i
 + 
CURSEG_HOT_DATA
] =

1410 
	`cur£g_®loc_ty³
(
sbi
, 
i
 + 
CURSEG_HOT_DATA
);

1414 
d©a_sum_blocks
 = 
	`f2fs_Åages_fÜ_summ¬y_æush
(
sbi
, 
çl£
);

1415 
	`¥š_lock_œq§ve
(&
sbi
->
ı_lock
, 
æags
);

1416 ià(
d©a_sum_blocks
 < 
NR_CURSEG_DATA_TYPE
)

1417 
	`__£t_ck±_æags
(
ck±
, 
CP_COMPACT_SUM_FLAG
);

1419 
	`__ş—r_ck±_æags
(
ck±
, 
CP_COMPACT_SUM_FLAG
);

1420 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
ı_lock
, 
æags
);

1422 
Üphª_blocks
 = 
	`GET_ORPHAN_BLOCKS
(
Üphª_num
);

1423 
ck±
->
ı_·ck_¡¬t_sum
 = 
	`ıu_to_Ë32
(1 + 
ı_·ylßd_blks
 +

1424 
Üphª_blocks
);

1426 ià(
	`__»maš_node_summ¬›s
(
ıc
->
»asÚ
))

1427 
ck±
->
ı_·ck_tÙ®_block_couÁ
 = 
	`ıu_to_Ë32
(
F2FS_CP_PACKS
+

1428 
ı_·ylßd_blks
 + 
d©a_sum_blocks
 +

1429 
Üphª_blocks
 + 
NR_CURSEG_NODE_TYPE
);

1431 
ck±
->
ı_·ck_tÙ®_block_couÁ
 = 
	`ıu_to_Ë32
(
F2FS_CP_PACKS
 +

1432 
ı_·ylßd_blks
 + 
d©a_sum_blocks
 +

1433 
Üphª_blocks
);

1436 
	`upd©e_ck±_æags
(
sbi
, 
ıc
);

1439 
	`g‘_s™_b™m­
(
sbi
, 
	`__b™m­_±r
(sbi, 
SIT_BITMAP
));

1440 
	`g‘_Çt_b™m­
(
sbi
, 
	`__b™m­_±r
(sbi, 
NAT_BITMAP
));

1442 
üc32
 = 
	`f2fs_checkpošt_chksum
(
sbi
, 
ck±
);

1443 *((
__Ë32
 *)((*)
ck±
 +

1444 
	`Ë32_to_ıu
(
ck±
->
checksum_off£t
)))

1445 ğ
	`ıu_to_Ë32
(
üc32
);

1447 
¡¬t_blk
 = 
	`__¡¬t_ı_Ãxt_addr
(
sbi
);

1450 ià(
	`’abËd_Çt_b™s
(
sbi
, 
ıc
)) {

1451 
__u64
 
ı_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

1452 
block_t
 
blk
;

1454 
ı_v”
 |ğ((
__u64
)
üc32
 << 32);

1455 *(
__Ë64
 *)
nm_i
->
Çt_b™s
 = 
	`ıu_to_Ë64
(
ı_v”
);

1457 
blk
 = 
¡¬t_blk
 + 
sbi
->
blocks_³r_£g
 - 
nm_i
->
Çt_b™s_blocks
;

1458 
i
 = 0; i < 
nm_i
->
Çt_b™s_blocks
; i++)

1459 
	`f2fs_upd©e_m‘a_·ge
(
sbi
, 
nm_i
->
Çt_b™s
 +

1460 (
i
 << 
F2FS_BLKSIZE_BITS
), 
blk
 + i);

1464 
	`f2fs_upd©e_m‘a_·ge
(
sbi
, 
ck±
, 
¡¬t_blk
++);

1466 
i
 = 1; i < 1 + 
ı_·ylßd_blks
; i++)

1467 
	`f2fs_upd©e_m‘a_·ge
(
sbi
, (*)
ck±
 + 
i
 * 
F2FS_BLKSIZE
,

1468 
¡¬t_blk
++);

1470 ià(
Üphª_num
) {

1471 
	`wr™e_Üphª_šodes
(
sbi
, 
¡¬t_blk
);

1472 
¡¬t_blk
 +ğ
Üphª_blocks
;

1475 
	`f2fs_wr™e_d©a_summ¬›s
(
sbi
, 
¡¬t_blk
);

1476 
¡¬t_blk
 +ğ
d©a_sum_blocks
;

1479 
kby‹s_wr™‹n
 = 
sbi
->kbytes_written;

1480 ià(
sb
->
s_bdev
->
bd_·¹
)

1481 
kby‹s_wr™‹n
 +ğ
	`BD_PART_WRITTEN
(
sbi
);

1483 
£g_i
->
jouº®
->
šfo
.
kby‹s_wr™‹n
 = 
	`ıu_to_Ë64
(kbytes_written);

1485 ià(
	`__»maš_node_summ¬›s
(
ıc
->
»asÚ
)) {

1486 
	`f2fs_wr™e_node_summ¬›s
(
sbi
, 
¡¬t_blk
);

1487 
¡¬t_blk
 +ğ
NR_CURSEG_NODE_TYPE
;

1491 
sbi
->
Ï¡_v®id_block_couÁ
 = sbi->
tÙ®_v®id_block_couÁ
;

1492 
	`³rıu_couÁ”_£t
(&
sbi
->
®loc_v®id_block_couÁ
, 0);

1495 
	`f2fs_sync_m‘a_·ges
(
sbi
, 
META
, 
LONG_MAX
, 
FS_CP_META_IO
);

1496 
	`f2fs_bug_Ú
(
sbi
, 
	`g‘_·ges
(sbi, 
F2FS_DIRTY_META
) &&

1497 !
	`f2fs_ı_”rÜ
(
sbi
));

1500 
	`f2fs_wa™_Ú_®l_·ges_wr™eback
(
sbi
);

1503 
”r
 = 
	`f2fs_æush_deviû_ÿche
(
sbi
);

1504 ià(
”r
)

1505  
”r
;

1508 
	`comm™_checkpošt
(
sbi
, 
ck±
, 
¡¬t_blk
);

1509 
	`f2fs_wa™_Ú_®l_·ges_wr™eback
(
sbi
);

1515 ià(
	`f2fs_sb_has_’üy±
(
sbi
))

1516 
	`šv®id©e_m­pšg_·ges
(
	`META_MAPPING
(
sbi
),

1517 
	`MAIN_BLKADDR
(
sbi
), 
	`MAX_BLKADDR
(sbi) - 1);

1519 
	`f2fs_»Ëa£_šo_’Œy
(
sbi
, 
çl£
);

1521 
	`f2fs_»£t_fsync_node_šfo
(
sbi
);

1523 
	`ş—r_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

1524 
	`ş—r_sbi_æag
(
sbi
, 
SBI_NEED_CP
);

1525 
	`ş—r_sbi_æag
(
sbi
, 
SBI_QUOTA_SKIP_FLUSH
);

1527 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1528 
sbi
->
unu§bË_block_couÁ
 = 0;

1529 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1531 
	`__£t_ı_Ãxt_·ck
(
sbi
);

1537 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
) ||

1538 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
))

1539 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

1541 
	`f2fs_bug_Ú
(
sbi
, 
	`g‘_·ges
(sbi, 
F2FS_DIRTY_DENTS
));

1543  
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)è? -
EIO
 : 0;

1544 
	}
}

1549 
	$f2fs_wr™e_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

1551 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1552 
ck±_v”
;

1553 
”r
 = 0;

1555 ià(
	`f2fs_»adÚly
(
sbi
->
sb
è|| 
	`f2fs_hw_is_»adÚly
(sbi))

1556  -
EROFS
;

1558 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
))) {

1559 ià(
ıc
->
»asÚ
 !ğ
CP_PAUSE
)

1561 
	`f2fs_w¬n
(
sbi
, "Start checkpoint disabled!");

1563 
	`mu‹x_lock
(&
sbi
->
ı_mu‹x
);

1565 ià(!
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_DIRTY
) &&

1566 ((
ıc
->
»asÚ
 & 
CP_FASTBOOT
è|| (ıc->»asÚ & 
CP_SYNC
) ||

1567 ((
ıc
->
»asÚ
 & 
CP_DISCARD
è&& !
sbi
->
disÿrd_blks
)))

1568 
out
;

1569 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1570 
”r
 = -
EIO
;

1571 
out
;

1574 
	`Œaû_f2fs_wr™e_checkpošt
(
sbi
->
sb
, 
ıc
->
»asÚ
, "start block_ops");

1576 
”r
 = 
	`block_İ”©iÚs
(
sbi
);

1577 ià(
”r
)

1578 
out
;

1580 
	`Œaû_f2fs_wr™e_checkpošt
(
sbi
->
sb
, 
ıc
->
»asÚ
, "finish block_ops");

1582 
	`f2fs_æush_m”ged_wr™es
(
sbi
);

1585 ià(
ıc
->
»asÚ
 & 
CP_DISCARD
) {

1586 ià(!
	`f2fs_exi¡_Œim_ÿndid©es
(
sbi
, 
ıc
)) {

1587 
	`unblock_İ”©iÚs
(
sbi
);

1588 
out
;

1591 ià(
	`NM_I
(
sbi
)->
dœty_Çt_út
 == 0 &&

1592 
	`SIT_I
(
sbi
)->
dœty_£Ár›s
 == 0 &&

1593 
	`´eä“_£gm’ts
(
sbi
) == 0) {

1594 
	`f2fs_æush_s™_’Œ›s
(
sbi
, 
ıc
);

1595 
	`f2fs_ş—r_´eä“_£gm’ts
(
sbi
, 
ıc
);

1596 
	`unblock_İ”©iÚs
(
sbi
);

1597 
out
;

1606 
ck±_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

1607 
ck±
->
checkpošt_v”
 = 
	`ıu_to_Ë64
(++
ck±_v”
);

1610 
”r
 = 
	`f2fs_æush_Çt_’Œ›s
(
sbi
, 
ıc
);

1611 ià(
”r
)

1612 
¡İ
;

1614 
	`f2fs_æush_s™_’Œ›s
(
sbi
, 
ıc
);

1617 
”r
 = 
	`do_checkpošt
(
sbi
, 
ıc
);

1618 ià(
”r
)

1619 
	`f2fs_»Ëa£_disÿrd_addrs
(
sbi
);

1621 
	`f2fs_ş—r_´eä“_£gm’ts
(
sbi
, 
ıc
);

1622 
¡İ
:

1623 
	`unblock_İ”©iÚs
(
sbi
);

1624 
	`¡©_šc_ı_couÁ
(
sbi
->
¡©_šfo
);

1626 ià(
ıc
->
»asÚ
 & 
CP_RECOVERY
)

1627 
	`f2fs_nÙiû
(
sbi
, "checkpošt: v”siÚ = %Îx", 
ck±_v”
);

1630 
	`f2fs_upd©e_time
(
sbi
, 
CP_TIME
);

1631 
	`Œaû_f2fs_wr™e_checkpošt
(
sbi
->
sb
, 
ıc
->
»asÚ
, "finish checkpoint");

1632 
out
:

1633 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

1634  
”r
;

1635 
	}
}

1637 
	$f2fs_š™_šo_’Œy_šfo
(
f2fs_sb_šfo
 *
sbi
)

1639 
i
;

1641 
i
 = 0; i < 
MAX_INO_ENTRY
; i++) {

1642 
šode_mªagem’t
 *
im
 = &
sbi
->im[
i
];

1644 
	`INIT_RADIX_TREE
(&
im
->
šo_roÙ
, 
GFP_ATOMIC
);

1645 
	`¥š_lock_š™
(&
im
->
šo_lock
);

1646 
	`INIT_LIST_HEAD
(&
im
->
šo_li¡
);

1647 
im
->
šo_num
 = 0;

1650 
sbi
->
max_Üphªs
 = (sbi->
blocks_³r_£g
 - 
F2FS_CP_PACKS
 -

1651 
NR_CURSEG_TYPE
 - 
	`__ı_·ylßd
(
sbi
)) *

1652 
F2FS_ORPHANS_PER_BLOCK
;

1653 
	}
}

1655 
__š™
 
	$f2fs_ü—‹_checkpošt_ÿches
()

1657 
šo_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_ino_entry",

1658 (
šo_’Œy
));

1659 ià(!
šo_’Œy_¦ab
)

1660  -
ENOMEM
;

1661 
f2fs_šode_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_inode_entry",

1662 (
šode_’Œy
));

1663 ià(!
f2fs_šode_’Œy_¦ab
) {

1664 
	`kmem_ÿche_de¡roy
(
šo_’Œy_¦ab
);

1665  -
ENOMEM
;

1668 
	}
}

1670 
	$f2fs_de¡roy_checkpošt_ÿches
()

1672 
	`kmem_ÿche_de¡roy
(
šo_’Œy_¦ab
);

1673 
	`kmem_ÿche_de¡roy
(
f2fs_šode_’Œy_¦ab
);

1674 
	}
}

	@data.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/f2fs_fs.h
>

10 
	~<lšux/bufãr_h—d.h
>

11 
	~<lšux/m·ge.h
>

12 
	~<lšux/wr™eback.h
>

13 
	~<lšux/backšg-dev.h
>

14 
	~<lšux/·gevec.h
>

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/bio.h
>

17 
	~<lšux/sw­.h
>

18 
	~<lšux/´eãtch.h
>

19 
	~<lšux/uio.h
>

20 
	~<lšux/ş—nÿche.h
>

21 
	~<lšux/sched/sigÇl.h
>

23 
	~"f2fs.h
"

24 
	~"node.h
"

25 
	~"£gm’t.h
"

26 
	~"Œaû.h
"

27 
	~<Œaû/ev’ts/f2fs.h
>

29 
	#NUM_PREALLOC_POST_READ_CTXS
 128

	)

31 
kmem_ÿche
 *
	gbio_po¡_»ad_ùx_ÿche
;

32 
mempoŞ_t
 *
	gbio_po¡_»ad_ùx_poŞ
;

34 
boŞ
 
	$__is_ı_gu¬ª‹ed
(
·ge
 *page)

36 
add»ss_¥aû
 *
m­pšg
 = 
·ge
->mapping;

37 
šode
 *inode;

38 
f2fs_sb_šfo
 *
sbi
;

40 ià(!
m­pšg
)

41  
çl£
;

43 
šode
 = 
m­pšg
->
ho¡
;

44 
sbi
 = 
	`F2FS_I_SB
(
šode
);

46 ià(
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
) ||

47 
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

48 
	`S_ISDIR
(
šode
->
i_mode
) ||

49 (
	`S_ISREG
(
šode
->
i_mode
) &&

50 (
	`f2fs_is_©omic_fe
(
šode
è|| 
	`IS_NOQUOTA
(inode))) ||

51 
	`is_cŞd_d©a
(
·ge
))

52  
Œue
;

53  
çl£
;

54 
	}
}

56 
couÁ_ty³
 
	$__»ad_io_ty³
(
·ge
 *page)

58 
add»ss_¥aû
 *
m­pšg
 = 
	`·ge_fe_m­pšg
(
·ge
);

60 ià(
m­pšg
) {

61 
šode
 *šodğ
m­pšg
->
ho¡
;

62 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

64 ià(
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
))

65  
F2FS_RD_META
;

67 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
))

68  
F2FS_RD_NODE
;

70  
F2FS_RD_DATA
;

71 
	}
}

74 
	ebio_po¡_»ad_¡•
 {

75 
	mSTEP_INITIAL
 = 0,

76 
	mSTEP_DECRYPT
,

77 
	mSTEP_VERITY
,

80 
	sbio_po¡_»ad_ùx
 {

81 
bio
 *
	mbio
;

82 
wÜk_¡ruù
 
	mwÜk
;

83 
	mcur_¡•
;

84 
	m’abËd_¡•s
;

87 
	$__»ad_’d_io
(
bio
 *bio)

89 
·ge
 *page;

90 
bio_vec
 *
bv
;

91 
bvec_™”_®l
 
™”_®l
;

93 
	`bio_fÜ_—ch_£gm’t_®l
(
bv
, 
bio
, 
™”_®l
) {

94 
·ge
 = 
bv
->
bv_·ge
;

97 ià(
bio
->
bi_¡©us
 || 
	`PageE¼Ü
(
·ge
)) {

98 
	`CË¬PageU±od©e
(
·ge
);

100 
	`CË¬PageE¼Ü
(
·ge
);

102 
	`S‘PageU±od©e
(
·ge
);

104 
	`dec_·ge_couÁ
(
	`F2FS_P_SB
(
·ge
), 
	`__»ad_io_ty³
(page));

105 
	`uÆock_·ge
(
·ge
);

107 ià(
bio
->
bi_´iv©e
)

108 
	`mempoŞ_ä“
(
bio
->
bi_´iv©e
, 
bio_po¡_»ad_ùx_poŞ
);

109 
	`bio_put
(
bio
);

110 
	}
}

112 
bio_po¡_»ad_´oûssšg
(
bio_po¡_»ad_ùx
 *
ùx
);

114 
	$deüy±_wÜk
(
wÜk_¡ruù
 *
wÜk
)

116 
bio_po¡_»ad_ùx
 *
ùx
 =

117 
	`cÚš”_of
(
wÜk
, 
bio_po¡_»ad_ùx
, work);

119 
	`fsüy±_deüy±_bio
(
ùx
->
bio
);

121 
	`bio_po¡_»ad_´oûssšg
(
ùx
);

122 
	}
}

124 
	$v”™y_wÜk
(
wÜk_¡ruù
 *
wÜk
)

126 
bio_po¡_»ad_ùx
 *
ùx
 =

127 
	`cÚš”_of
(
wÜk
, 
bio_po¡_»ad_ùx
, work);

129 
	`fsv”™y_v”ify_bio
(
ùx
->
bio
);

131 
	`bio_po¡_»ad_´oûssšg
(
ùx
);

132 
	}
}

134 
	$bio_po¡_»ad_´oûssšg
(
bio_po¡_»ad_ùx
 *
ùx
)

141 ++
ùx
->
cur_¡•
) {

142 
STEP_DECRYPT
:

143 ià(
ùx
->
’abËd_¡•s
 & (1 << 
STEP_DECRYPT
)) {

144 
	`INIT_WORK
(&
ùx
->
wÜk
, 
deüy±_wÜk
);

145 
	`fsüy±_’queue_deüy±_wÜk
(&
ùx
->
wÜk
);

148 
ùx
->
cur_¡•
++;

150 
STEP_VERITY
:

151 ià(
ùx
->
’abËd_¡•s
 & (1 << 
STEP_VERITY
)) {

152 
	`INIT_WORK
(&
ùx
->
wÜk
, 
v”™y_wÜk
);

153 
	`fsv”™y_’queue_v”ify_wÜk
(&
ùx
->
wÜk
);

156 
ùx
->
cur_¡•
++;

159 
	`__»ad_’d_io
(
ùx
->
bio
);

161 
	}
}

163 
boŞ
 
	$f2fs_bio_po¡_»ad_»quœed
(
bio
 *bio)

165  
bio
->
bi_´iv©e
 && !bio->
bi_¡©us
;

166 
	}
}

168 
	$f2fs_»ad_’d_io
(
bio
 *bio)

170 ià(
	`time_to_šjeù
(
	`F2FS_P_SB
(
	`bio_fœ¡_·ge_®l
(
bio
)),

171 
FAULT_READ_IO
)) {

172 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_READ_IO
);

173 
bio
->
bi_¡©us
 = 
BLK_STS_IOERR
;

176 ià(
	`f2fs_bio_po¡_»ad_»quœed
(
bio
)) {

177 
bio_po¡_»ad_ùx
 *
ùx
 = 
bio
->
bi_´iv©e
;

179 
ùx
->
cur_¡•
 = 
STEP_INITIAL
;

180 
	`bio_po¡_»ad_´oûssšg
(
ùx
);

184 
	`__»ad_’d_io
(
bio
);

185 
	}
}

187 
	$f2fs_wr™e_’d_io
(
bio
 *bio)

189 
f2fs_sb_šfo
 *
sbi
 = 
bio
->
bi_´iv©e
;

190 
bio_vec
 *
bvec
;

191 
bvec_™”_®l
 
™”_®l
;

193 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_WRITE_IO
)) {

194 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_WRITE_IO
);

195 
bio
->
bi_¡©us
 = 
BLK_STS_IOERR
;

198 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
™”_®l
) {

199 
·ge
 *·gğ
bvec
->
bv_·ge
;

200 
couÁ_ty³
 
ty³
 = 
	`WB_DATA_TYPE
(
·ge
);

202 ià(
	`IS_DUMMY_WRITTEN_PAGE
(
·ge
)) {

203 
	`£t_·ge_´iv©e
(
·ge
, ()
NULL
);

204 
	`CË¬PagePriv©e
(
·ge
);

205 
	`uÆock_·ge
(
·ge
);

206 
	`mempoŞ_ä“
(
·ge
, 
sbi
->
wr™e_io_dummy
);

208 ià(
	`uÆik–y
(
bio
->
bi_¡©us
))

209 
	`f2fs_¡İ_checkpošt
(
sbi
, 
Œue
);

213 
	`fsüy±_fš®ize_bounû_·ge
(&
·ge
);

215 ià(
	`uÆik–y
(
bio
->
bi_¡©us
)) {

216 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, -
EIO
);

217 ià(
ty³
 =ğ
F2FS_WB_CP_DATA
)

218 
	`f2fs_¡İ_checkpošt
(
sbi
, 
Œue
);

221 
	`f2fs_bug_Ú
(
sbi
, 
·ge
->
m­pšg
 =ğ
	`NODE_MAPPING
(sbi) &&

222 
·ge
->
šdex
 !ğ
	`nid_of_node
(page));

224 
	`dec_·ge_couÁ
(
sbi
, 
ty³
);

225 ià(
	`f2fs_š_w¬m_node_li¡
(
sbi
, 
·ge
))

226 
	`f2fs_d–_fsync_node_’Œy
(
sbi
, 
·ge
);

227 
	`ş—r_cŞd_d©a
(
·ge
);

228 
	`’d_·ge_wr™eback
(
·ge
);

230 ià(!
	`g‘_·ges
(
sbi
, 
F2FS_WB_CP_DATA
) &&

231 
	`wq_has_¦“³r
(&
sbi
->
ı_wa™
))

232 
	`wake_up
(&
sbi
->
ı_wa™
);

234 
	`bio_put
(
bio
);

235 
	}
}

240 
block_deviû
 *
	$f2fs_rg‘_deviû
(
f2fs_sb_šfo
 *
sbi
,

241 
block_t
 
blk_addr
, 
bio
 *bio)

243 
block_deviû
 *
bdev
 = 
sbi
->
sb
->
s_bdev
;

244 
i
;

246 ià(
	`f2fs_is_muÉi_deviû
(
sbi
)) {

247 
i
 = 0; i < 
sbi
->
s_ndevs
; i++) {

248 ià(
	`FDEV
(
i
).
¡¬t_blk
 <ğ
blk_addr
 &&

249 
	`FDEV
(
i
).
’d_blk
 >ğ
blk_addr
) {

250 
blk_addr
 -ğ
	`FDEV
(
i
).
¡¬t_blk
;

251 
bdev
 = 
	`FDEV
(
i
).bdev;

256 ià(
bio
) {

257 
	`bio_£t_dev
(
bio
, 
bdev
);

258 
bio
->
bi_™”
.
bi_£ùÜ
 = 
	`SECTOR_FROM_BLOCK
(
blk_addr
);

260  
bdev
;

261 
	}
}

263 
	$f2fs_rg‘_deviû_šdex
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

265 
i
;

267 ià(!
	`f2fs_is_muÉi_deviû
(
sbi
))

270 
i
 = 0; i < 
sbi
->
s_ndevs
; i++)

271 ià(
	`FDEV
(
i
).
¡¬t_blk
 <ğ
blkaddr
 && FDEV(i).
’d_blk
 >= blkaddr)

272  
i
;

274 
	}
}

276 
boŞ
 
	$__§me_bdev
(
f2fs_sb_šfo
 *
sbi
,

277 
block_t
 
blk_addr
, 
bio
 *bio)

279 
block_deviû
 *
b
 = 
	`f2fs_rg‘_deviû
(
sbi
, 
blk_addr
, 
NULL
);

280  
bio
->
bi_disk
 =ğ
b
->
bd_disk
 && bio->
bi_·¹no
 =ğb->
bd_·¹no
;

281 
	}
}

286 
bio
 *
	$__bio_®loc
(
f2fs_io_šfo
 *
fio
, 
Åages
)

288 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

289 
bio
 *bio;

291 
bio
 = 
	`f2fs_bio_®loc
(
sbi
, 
Åages
, 
Œue
);

293 
	`f2fs_rg‘_deviû
(
sbi
, 
fio
->
Ãw_blkaddr
, 
bio
);

294 ià(
	`is_»ad_io
(
fio
->
İ
)) {

295 
bio
->
bi_’d_io
 = 
f2fs_»ad_’d_io
;

296 
bio
->
bi_´iv©e
 = 
NULL
;

298 
bio
->
bi_’d_io
 = 
f2fs_wr™e_’d_io
;

299 
bio
->
bi_´iv©e
 = 
sbi
;

300 
bio
->
bi_wr™e_hšt
 = 
	`f2fs_io_ty³_to_rw_hšt
(
sbi
,

301 
fio
->
ty³
, fio->
‹mp
);

303 ià(
fio
->
io_wbc
)

304 
	`wbc_š™_bio
(
fio
->
io_wbc
, 
bio
);

306  
bio
;

307 
	}
}

309 
šlše
 
	$__subm™_bio
(
f2fs_sb_šfo
 *
sbi
,

310 
bio
 *bio, 
·ge_ty³
 
ty³
)

312 ià(!
	`is_»ad_io
(
	`bio_İ
(
bio
))) {

313 
¡¬t
;

315 ià(
ty³
 !ğ
DATA
 &&y³ !ğ
NODE
)

316 
subm™_io
;

318 ià(
	`‹¡_İt
(
sbi
, 
LFS
è&& 
cu¼’t
->
¶ug
)

319 
	`blk_fšish_¶ug
(
cu¼’t
->
¶ug
);

321 ià(
	`F2FS_IO_ALIGNED
(
sbi
))

322 
subm™_io
;

324 
¡¬t
 = 
bio
->
bi_™”
.
bi_size
 >> 
F2FS_BLKSIZE_BITS
;

325 
¡¬t
 %ğ
	`F2FS_IO_SIZE
(
sbi
);

327 ià(
¡¬t
 == 0)

328 
subm™_io
;

331 ; 
¡¬t
 < 
	`F2FS_IO_SIZE
(
sbi
); start++) {

332 
·ge
 *page =

333 
	`mempoŞ_®loc
(
sbi
->
wr™e_io_dummy
,

334 
GFP_NOIO
 | 
__GFP_NOFAIL
);

335 
	`f2fs_bug_Ú
(
sbi
, !
·ge
);

337 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

338 
	`S‘PagePriv©e
(
·ge
);

339 
	`£t_·ge_´iv©e
(
·ge
, ()
DUMMY_WRITTEN_PAGE
);

340 
	`lock_·ge
(
·ge
);

341 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0) < PAGE_SIZE)

342 
	`f2fs_bug_Ú
(
sbi
, 1);

348 ià(
ty³
 =ğ
NODE
)

349 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_CP
);

351 
subm™_io
:

352 ià(
	`is_»ad_io
(
	`bio_İ
(
bio
)))

353 
	`Œaû_f2fs_subm™_»ad_bio
(
sbi
->
sb
, 
ty³
, 
bio
);

355 
	`Œaû_f2fs_subm™_wr™e_bio
(
sbi
->
sb
, 
ty³
, 
bio
);

356 
	`subm™_bio
(
bio
);

357 
	}
}

359 
	$__subm™_m”ged_bio
(
f2fs_bio_šfo
 *
io
)

361 
f2fs_io_šfo
 *
fio
 = &
io
->fio;

363 ià(!
io
->
bio
)

366 
	`bio_£t_İ_©Œs
(
io
->
bio
, 
fio
->
İ
, fio->
İ_æags
);

368 ià(
	`is_»ad_io
(
fio
->
İ
))

369 
	`Œaû_f2fs_´•¬e_»ad_bio
(
io
->
sbi
->
sb
, 
fio
->
ty³
, io->
bio
);

371 
	`Œaû_f2fs_´•¬e_wr™e_bio
(
io
->
sbi
->
sb
, 
fio
->
ty³
, io->
bio
);

373 
	`__subm™_bio
(
io
->
sbi
, io->
bio
, 
fio
->
ty³
);

374 
io
->
bio
 = 
NULL
;

375 
	}
}

377 
boŞ
 
	$__has_m”ged_·ge
(
bio
 *bio, 
šode
 *inode,

378 
·ge
 *·ge, 
nid_t
 
šo
)

380 
bio_vec
 *
bvec
;

381 
·ge
 *
rg‘
;

382 
bvec_™”_®l
 
™”_®l
;

384 ià(!
bio
)

385  
çl£
;

387 ià(!
šode
 && !
·ge
 && !
šo
)

388  
Œue
;

390 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
™”_®l
) {

392 
rg‘
 = 
bvec
->
bv_·ge
;

393 ià(
	`fsüy±_is_bounû_·ge
(
rg‘
))

394 
rg‘
 = 
	`fsüy±_·geÿche_·ge
(target);

396 ià(
šode
 && inod=ğ
rg‘
->
m­pšg
->
ho¡
)

397  
Œue
;

398 ià(
·ge
 &&…ag=ğ
rg‘
)

399  
Œue
;

400 ià(
šo
 && inØ=ğ
	`šo_of_node
(
rg‘
))

401  
Œue
;

404  
çl£
;

405 
	}
}

407 
	$__f2fs_subm™_m”ged_wr™e
(
f2fs_sb_šfo
 *
sbi
,

408 
·ge_ty³
 
ty³
, 
‹mp_ty³
 
‹mp
)

410 
·ge_ty³
 
bty³
 = 
	`PAGE_TYPE_OF_BIO
(
ty³
);

411 
f2fs_bio_šfo
 *
io
 = 
sbi
->
wr™e_io
[
bty³
] + 
‹mp
;

413 
	`down_wr™e
(&
io
->
io_rw£m
);

416 ià(
ty³
 >ğ
META_FLUSH
) {

417 
io
->
fio
.
ty³
 = 
META_FLUSH
;

418 
io
->
fio
.
İ
 = 
REQ_OP_WRITE
;

419 
io
->
fio
.
İ_æags
 = 
REQ_META
 | 
REQ_PRIO
 | 
REQ_SYNC
;

420 ià(!
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

421 
io
->
fio
.
İ_æags
 |ğ
REQ_PREFLUSH
 | 
REQ_FUA
;

423 
	`__subm™_m”ged_bio
(
io
);

424 
	`up_wr™e
(&
io
->
io_rw£m
);

425 
	}
}

427 
	$__subm™_m”ged_wr™e_cÚd
(
f2fs_sb_šfo
 *
sbi
,

428 
šode
 *šode, 
·ge
 *page,

429 
nid_t
 
šo
, 
·ge_ty³
 
ty³
, 
boŞ
 
fÜû
)

431 
‹mp_ty³
 
‹mp
;

432 
boŞ
 
»t
 = 
Œue
;

434 
‹mp
 = 
HOT
;em°< 
NR_TEMP_TYPE
;emp++) {

435 ià(!
fÜû
) {

436 
·ge_ty³
 
bty³
 = 
	`PAGE_TYPE_OF_BIO
(
ty³
);

437 
f2fs_bio_šfo
 *
io
 = 
sbi
->
wr™e_io
[
bty³
] + 
‹mp
;

439 
	`down_»ad
(&
io
->
io_rw£m
);

440 
»t
 = 
	`__has_m”ged_·ge
(
io
->
bio
, 
šode
, 
·ge
, 
šo
);

441 
	`up_»ad
(&
io
->
io_rw£m
);

443 ià(
»t
)

444 
	`__f2fs_subm™_m”ged_wr™e
(
sbi
, 
ty³
, 
‹mp
);

447 ià(
ty³
 >ğ
META
)

450 
	}
}

452 
	$f2fs_subm™_m”ged_wr™e
(
f2fs_sb_šfo
 *
sbi
, 
·ge_ty³
 
ty³
)

454 
	`__subm™_m”ged_wr™e_cÚd
(
sbi
, 
NULL
, NULL, 0, 
ty³
, 
Œue
);

455 
	}
}

457 
	$f2fs_subm™_m”ged_wr™e_cÚd
(
f2fs_sb_šfo
 *
sbi
,

458 
šode
 *šode, 
·ge
 *page,

459 
nid_t
 
šo
, 
·ge_ty³
 
ty³
)

461 
	`__subm™_m”ged_wr™e_cÚd
(
sbi
, 
šode
, 
·ge
, 
šo
, 
ty³
, 
çl£
);

462 
	}
}

464 
	$f2fs_æush_m”ged_wr™es
(
f2fs_sb_šfo
 *
sbi
)

466 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
DATA
);

467 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
NODE
);

468 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
META
);

469 
	}
}

475 
	$f2fs_subm™_·ge_bio
(
f2fs_io_šfo
 *
fio
)

477 
bio
 *bio;

478 
·ge
 *·gğ
fio
->
’üy±ed_·ge
 ?

479 
fio
->
’üy±ed_·ge
 : fio->
·ge
;

481 ià(!
	`f2fs_is_v®id_blkaddr
(
fio
->
sbi
, fio->
Ãw_blkaddr
,

482 
fio
->
is_pÜ
 ? 
META_POR
 : (
	`__is_m‘a_io
(fio) ?

483 
META_GENERIC
 : 
DATA_GENERIC_ENHANCE
)))

484  -
EFSCORRUPTED
;

486 
	`Œaû_f2fs_subm™_·ge_bio
(
·ge
, 
fio
);

487 
	`f2fs_Œaû_ios
(
fio
, 0);

490 
bio
 = 
	`__bio_®loc
(
fio
, 1);

492 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0) < PAGE_SIZE) {

493 
	`bio_put
(
bio
);

494  -
EFAULT
;

497 ià(
fio
->
io_wbc
 && !
	`is_»ad_io
(fio->
İ
))

498 
	`wbc_accouÁ_cgroup_owÃr
(
fio
->
io_wbc
, 
·ge
, 
PAGE_SIZE
);

500 
	`bio_£t_İ_©Œs
(
bio
, 
fio
->
İ
, fio->
İ_æags
);

502 
	`šc_·ge_couÁ
(
fio
->
sbi
, 
	`is_»ad_io
(fio->
İ
) ?

503 
	`__»ad_io_ty³
(
·ge
): 
	`WB_DATA_TYPE
(
fio
->page));

505 
	`__subm™_bio
(
fio
->
sbi
, 
bio
, fio->
ty³
);

507 
	}
}

509 
boŞ
 
	$·ge_is_m”g—bË
(
f2fs_sb_šfo
 *
sbi
, 
bio
 *bio,

510 
block_t
 
Ï¡_blkaddr
, block_ˆ
cur_blkaddr
)

512 ià(
Ï¡_blkaddr
 + 1 !ğ
cur_blkaddr
)

513  
çl£
;

514  
	`__§me_bdev
(
sbi
, 
cur_blkaddr
, 
bio
);

515 
	}
}

517 
boŞ
 
	$io_ty³_is_m”g—bË
(
f2fs_bio_šfo
 *
io
,

518 
f2fs_io_šfo
 *
fio
)

520 ià(
io
->
fio
.
İ
 != fio->op)

521  
çl£
;

522  
io
->
fio
.
İ_æags
 == fio->op_flags;

523 
	}
}

525 
boŞ
 
	$io_is_m”g—bË
(
f2fs_sb_šfo
 *
sbi
, 
bio
 *bio,

526 
f2fs_bio_šfo
 *
io
,

527 
f2fs_io_šfo
 *
fio
,

528 
block_t
 
Ï¡_blkaddr
,

529 
block_t
 
cur_blkaddr
)

531 ià(
	`F2FS_IO_ALIGNED
(
sbi
è&& (
fio
->
ty³
 =ğ
DATA
 || fio->ty³ =ğ
NODE
)) {

532 
fËd_blocks
 =

533 
	`F2FS_BYTES_TO_BLK
(
bio
->
bi_™”
.
bi_size
);

534 
io_size
 = 
	`F2FS_IO_SIZE
(
sbi
);

535 
Ëá_vecs
 = 
bio
->
bi_max_vecs
 - bio->
bi_vút
;

538 ià(!(
fËd_blocks
 % 
io_size
è&& 
Ëá_vecs
 < io_size)

539  
çl£
;

541 ià(!
	`·ge_is_m”g—bË
(
sbi
, 
bio
, 
Ï¡_blkaddr
, 
cur_blkaddr
))

542  
çl£
;

543  
	`io_ty³_is_m”g—bË
(
io
, 
fio
);

544 
	}
}

546 
	$f2fs_m”ge_·ge_bio
(
f2fs_io_šfo
 *
fio
)

548 
bio
 *biØğ*
fio
->bio;

549 
·ge
 *·gğ
fio
->
’üy±ed_·ge
 ?

550 
fio
->
’üy±ed_·ge
 : fio->
·ge
;

552 ià(!
	`f2fs_is_v®id_blkaddr
(
fio
->
sbi
, fio->
Ãw_blkaddr
,

553 
	`__is_m‘a_io
(
fio
è? 
META_GENERIC
 : 
DATA_GENERIC
))

554  -
EFSCORRUPTED
;

556 
	`Œaû_f2fs_subm™_·ge_bio
(
·ge
, 
fio
);

557 
	`f2fs_Œaû_ios
(
fio
, 0);

559 ià(
bio
 && !
	`·ge_is_m”g—bË
(
fio
->
sbi
, bio, *fio->
Ï¡_block
,

560 
fio
->
Ãw_blkaddr
)) {

561 
	`__subm™_bio
(
fio
->
sbi
, 
bio
, fio->
ty³
);

562 
bio
 = 
NULL
;

564 
®loc_Ãw
:

565 ià(!
bio
) {

566 
bio
 = 
	`__bio_®loc
(
fio
, 
BIO_MAX_PAGES
);

567 
	`bio_£t_İ_©Œs
(
bio
, 
fio
->
İ
, fio->
İ_æags
);

570 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0) < PAGE_SIZE) {

571 
	`__subm™_bio
(
fio
->
sbi
, 
bio
, fio->
ty³
);

572 
bio
 = 
NULL
;

573 
®loc_Ãw
;

576 ià(
fio
->
io_wbc
)

577 
	`wbc_accouÁ_cgroup_owÃr
(
fio
->
io_wbc
, 
·ge
, 
PAGE_SIZE
);

579 
	`šc_·ge_couÁ
(
fio
->
sbi
, 
	`WB_DATA_TYPE
(
·ge
));

581 *
fio
->
Ï¡_block
 = fio->
Ãw_blkaddr
;

582 *
fio
->
bio
 = bio;

585 
	}
}

587 
	$f2fs_subm™_u_bio
(
f2fs_sb_šfo
 *
sbi
, 
bio
 **bio,

588 
·ge
 *page)

590 ià(!
bio
)

593 ià(!
	`__has_m”ged_·ge
(*
bio
, 
NULL
, 
·ge
, 0))

596 
	`__subm™_bio
(
sbi
, *
bio
, 
DATA
);

597 *
bio
 = 
NULL
;

598 
	}
}

600 
	$f2fs_subm™_·ge_wr™e
(
f2fs_io_šfo
 *
fio
)

602 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

603 
·ge_ty³
 
bty³
 = 
	`PAGE_TYPE_OF_BIO
(
fio
->
ty³
);

604 
f2fs_bio_šfo
 *
io
 = 
sbi
->
wr™e_io
[
bty³
] + 
fio
->
‹mp
;

605 
·ge
 *
bio_·ge
;

607 
	`f2fs_bug_Ú
(
sbi
, 
	`is_»ad_io
(
fio
->
İ
));

609 
	`down_wr™e
(&
io
->
io_rw£m
);

610 
Ãxt
:

611 ià(
fio
->
š_li¡
) {

612 
	`¥š_lock
(&
io
->
io_lock
);

613 ià(
	`li¡_em±y
(&
io
->
io_li¡
)) {

614 
	`¥š_uÆock
(&
io
->
io_lock
);

615 
out
;

617 
fio
 = 
	`li¡_fœ¡_’Œy
(&
io
->
io_li¡
,

618 
f2fs_io_šfo
, 
li¡
);

619 
	`li¡_d–
(&
fio
->
li¡
);

620 
	`¥š_uÆock
(&
io
->
io_lock
);

623 
	`v”ify_fio_blkaddr
(
fio
);

625 
bio_·ge
 = 
fio
->
’üy±ed_·ge
 ? fio->’üy±ed_·g: fio->
·ge
;

628 
fio
->
subm™‹d
 = 
Œue
;

630 
	`šc_·ge_couÁ
(
sbi
, 
	`WB_DATA_TYPE
(
bio_·ge
));

632 ià(
io
->
bio
 && !
	`io_is_m”g—bË
(
sbi
, io->bio, io, 
fio
,

633 
io
->
Ï¡_block_š_bio
, 
fio
->
Ãw_blkaddr
))

634 
	`__subm™_m”ged_bio
(
io
);

635 
®loc_Ãw
:

636 ià(
io
->
bio
 =ğ
NULL
) {

637 ià(
	`F2FS_IO_ALIGNED
(
sbi
) &&

638 (
fio
->
ty³
 =ğ
DATA
 || fio->ty³ =ğ
NODE
) &&

639 
fio
->
Ãw_blkaddr
 & 
	`F2FS_IO_SIZE_MASK
(
sbi
)) {

640 
	`dec_·ge_couÁ
(
sbi
, 
	`WB_DATA_TYPE
(
bio_·ge
));

641 
fio
->
»Œy
 = 
Œue
;

642 
sk
;

644 
io
->
bio
 = 
	`__bio_®loc
(
fio
, 
BIO_MAX_PAGES
);

645 
io
->
fio
 = *fio;

648 ià(
	`bio_add_·ge
(
io
->
bio
, 
bio_·ge
, 
PAGE_SIZE
, 0) < PAGE_SIZE) {

649 
	`__subm™_m”ged_bio
(
io
);

650 
®loc_Ãw
;

653 ià(
fio
->
io_wbc
)

654 
	`wbc_accouÁ_cgroup_owÃr
(
fio
->
io_wbc
, 
bio_·ge
, 
PAGE_SIZE
);

656 
io
->
Ï¡_block_š_bio
 = 
fio
->
Ãw_blkaddr
;

657 
	`f2fs_Œaû_ios
(
fio
, 0);

659 
	`Œaû_f2fs_subm™_·ge_wr™e
(
fio
->
·ge
, fio);

660 
sk
:

661 ià(
fio
->
š_li¡
)

662 
Ãxt
;

663 
out
:

664 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_SHUTDOWN
) ||

665 !
	`f2fs_is_checkpošt_»ady
(
sbi
))

666 
	`__subm™_m”ged_bio
(
io
);

667 
	`up_wr™e
(&
io
->
io_rw£m
);

668 
	}
}

670 
šlše
 
boŞ
 
	$f2fs_Ãed_v”™y
(cÚ¡ 
šode
 *šode, 
pgoff_t
 
idx
)

672  
	`fsv”™y_aùive
(
šode
) &&

673 
idx
 < 
	`DIV_ROUND_UP
(
šode
->
i_size
, 
PAGE_SIZE
);

674 
	}
}

676 
bio
 *
	$f2fs_g¿b_»ad_bio
(
šode
 *šode, 
block_t
 
blkaddr
,

677 
Ä_·ges
, 
İ_æag
,

678 
pgoff_t
 
fœ¡_idx
)

680 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

681 
bio
 *bio;

682 
bio_po¡_»ad_ùx
 *
ùx
;

683 
po¡_»ad_¡•s
 = 0;

685 
bio
 = 
	`f2fs_bio_®loc
(
sbi
, 
	`mš_t
(, 
Ä_·ges
, 
BIO_MAX_PAGES
), 
çl£
);

686 ià(!
bio
)

687  
	`ERR_PTR
(-
ENOMEM
);

688 
	`f2fs_rg‘_deviû
(
sbi
, 
blkaddr
, 
bio
);

689 
bio
->
bi_’d_io
 = 
f2fs_»ad_’d_io
;

690 
	`bio_£t_İ_©Œs
(
bio
, 
REQ_OP_READ
, 
İ_æag
);

692 ià(
	`f2fs_’üy±ed_fe
(
šode
))

693 
po¡_»ad_¡•s
 |ğ1 << 
STEP_DECRYPT
;

695 ià(
	`f2fs_Ãed_v”™y
(
šode
, 
fœ¡_idx
))

696 
po¡_»ad_¡•s
 |ğ1 << 
STEP_VERITY
;

698 ià(
po¡_»ad_¡•s
) {

699 
ùx
 = 
	`mempoŞ_®loc
(
bio_po¡_»ad_ùx_poŞ
, 
GFP_NOFS
);

700 ià(!
ùx
) {

701 
	`bio_put
(
bio
);

702  
	`ERR_PTR
(-
ENOMEM
);

704 
ùx
->
bio
 = bio;

705 
ùx
->
’abËd_¡•s
 = 
po¡_»ad_¡•s
;

706 
bio
->
bi_´iv©e
 = 
ùx
;

709  
bio
;

710 
	}
}

713 
	$f2fs_subm™_·ge_»ad
(
šode
 *šode, 
·ge
 *page,

714 
block_t
 
blkaddr
)

716 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

717 
bio
 *bio;

719 
bio
 = 
	`f2fs_g¿b_»ad_bio
(
šode
, 
blkaddr
, 1, 0, 
·ge
->
šdex
);

720 ià(
	`IS_ERR
(
bio
))

721  
	`PTR_ERR
(
bio
);

724 
	`f2fs_wa™_Ú_block_wr™eback
(
šode
, 
blkaddr
);

726 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0) < PAGE_SIZE) {

727 
	`bio_put
(
bio
);

728  -
EFAULT
;

730 
	`CË¬PageE¼Ü
(
·ge
);

731 
	`šc_·ge_couÁ
(
sbi
, 
F2FS_RD_DATA
);

732 
	`__subm™_bio
(
sbi
, 
bio
, 
DATA
);

734 
	}
}

736 
	$__£t_d©a_blkaddr
(
dnode_of_d©a
 *
dn
)

738 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
dn
->
node_·ge
);

739 
__Ë32
 *
addr_¬¿y
;

740 
ba£
 = 0;

742 ià(
	`IS_INODE
(
dn
->
node_·ge
è&& 
	`f2fs_has_exŒa_©Œ
(dn->
šode
))

743 
ba£
 = 
	`g‘_exŒa_isize
(
dn
->
šode
);

746 
addr_¬¿y
 = 
	`blkaddr_š_node
(
º
);

747 
addr_¬¿y
[
ba£
 + 
dn
->
ofs_š_node
] = 
	`ıu_to_Ë32
(dn->
d©a_blkaddr
);

748 
	}
}

756 
	$f2fs_£t_d©a_blkaddr
(
dnode_of_d©a
 *
dn
)

758 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
->
node_·ge
, 
NODE
, 
Œue
,rue);

759 
	`__£t_d©a_blkaddr
(
dn
);

760 ià(
	`£t_·ge_dœty
(
dn
->
node_·ge
))

761 
dn
->
node_chªged
 = 
Œue
;

762 
	}
}

764 
	$f2fs_upd©e_d©a_blkaddr
(
dnode_of_d©a
 *
dn
, 
block_t
 
blkaddr
)

766 
dn
->
d©a_blkaddr
 = 
blkaddr
;

767 
	`f2fs_£t_d©a_blkaddr
(
dn
);

768 
	`f2fs_upd©e_ex‹Á_ÿche
(
dn
);

769 
	}
}

772 
	$f2fs_»£rve_Ãw_blocks
(
dnode_of_d©a
 *
dn
, 
blkút_t
 
couÁ
)

774 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

775 
”r
;

777 ià(!
couÁ
)

780 ià(
	`uÆik–y
(
	`is_šode_æag_£t
(
dn
->
šode
, 
FI_NO_ALLOC
)))

781  -
EPERM
;

782 ià(
	`uÆik–y
((
”r
 = 
	`šc_v®id_block_couÁ
(
sbi
, 
dn
->
šode
, &
couÁ
))))

783  
”r
;

785 
	`Œaû_f2fs_»£rve_Ãw_blocks
(
dn
->
šode
, dn->
nid
,

786 
dn
->
ofs_š_node
, 
couÁ
);

788 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
->
node_·ge
, 
NODE
, 
Œue
,rue);

790 ; 
couÁ
 > 0; 
dn
->
ofs_š_node
++) {

791 
block_t
 
blkaddr
 = 
	`d©ablock_addr
(
dn
->
šode
,

792 
dn
->
node_·ge
, dn->
ofs_š_node
);

793 ià(
blkaddr
 =ğ
NULL_ADDR
) {

794 
dn
->
d©a_blkaddr
 = 
NEW_ADDR
;

795 
	`__£t_d©a_blkaddr
(
dn
);

796 
couÁ
--;

800 ià(
	`£t_·ge_dœty
(
dn
->
node_·ge
))

801 
dn
->
node_chªged
 = 
Œue
;

803 
	}
}

806 
	$f2fs_»£rve_Ãw_block
(
dnode_of_d©a
 *
dn
)

808 
ofs_š_node
 = 
dn
->ofs_in_node;

809 
»t
;

811 
»t
 = 
	`f2fs_»£rve_Ãw_blocks
(
dn
, 1);

812 
dn
->
ofs_š_node
 = ofs_in_node;

813  
»t
;

814 
	}
}

816 
	$f2fs_»£rve_block
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
)

818 
boŞ
 
Ãed_put
 = 
dn
->
šode_·ge
 ? 
çl£
 : 
Œue
;

819 
”r
;

821 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(
dn
, 
šdex
, 
ALLOC_NODE
);

822 ià(
”r
)

823  
”r
;

825 ià(
dn
->
d©a_blkaddr
 =ğ
NULL_ADDR
)

826 
”r
 = 
	`f2fs_»£rve_Ãw_block
(
dn
);

827 ià(
”r
 || 
Ãed_put
)

828 
	`f2fs_put_dnode
(
dn
);

829  
”r
;

830 
	}
}

832 
	$f2fs_g‘_block
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
)

834 
ex‹Á_šfo
 
ei
 = {0,0,0};

835 
šode
 *šodğ
dn
->inode;

837 ià(
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
šdex
, &
ei
)) {

838 
dn
->
d©a_blkaddr
 = 
ei
.
blk
 + 
šdex
 -ƒi.
fofs
;

842  
	`f2fs_»£rve_block
(
dn
, 
šdex
);

843 
	}
}

845 
·ge
 *
	$f2fs_g‘_»ad_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
,

846 
İ_æags
, 
boŞ
 
fÜ_wr™e
)

848 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

849 
dnode_of_d©a
 
dn
;

850 
·ge
 *page;

851 
ex‹Á_šfo
 
ei
 = {0,0,0};

852 
”r
;

854 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
m­pšg
, 
šdex
, 
fÜ_wr™e
);

855 ià(!
·ge
)

856  
	`ERR_PTR
(-
ENOMEM
);

858 ià(
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
šdex
, &
ei
)) {

859 
dn
.
d©a_blkaddr
 = 
ei
.
blk
 + 
šdex
 -ƒi.
fofs
;

860 ià(!
	`f2fs_is_v®id_blkaddr
(
	`F2FS_I_SB
(
šode
), 
dn
.
d©a_blkaddr
,

861 
DATA_GENERIC_ENHANCE_READ
)) {

862 
”r
 = -
EFSCORRUPTED
;

863 
put_”r
;

865 
gÙ_™
;

868 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

869 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
šdex
, 
LOOKUP_NODE
);

870 ià(
”r
)

871 
put_”r
;

872 
	`f2fs_put_dnode
(&
dn
);

874 ià(
	`uÆik–y
(
dn
.
d©a_blkaddr
 =ğ
NULL_ADDR
)) {

875 
”r
 = -
ENOENT
;

876 
put_”r
;

878 ià(
dn
.
d©a_blkaddr
 !ğ
NEW_ADDR
 &&

879 !
	`f2fs_is_v®id_blkaddr
(
	`F2FS_I_SB
(
šode
),

880 
dn
.
d©a_blkaddr
,

881 
DATA_GENERIC_ENHANCE
)) {

882 
”r
 = -
EFSCORRUPTED
;

883 
put_”r
;

885 
gÙ_™
:

886 ià(
	`PageU±od©e
(
·ge
)) {

887 
	`uÆock_·ge
(
·ge
);

888  
·ge
;

898 ià(
dn
.
d©a_blkaddr
 =ğ
NEW_ADDR
) {

899 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

900 ià(!
	`PageU±od©e
(
·ge
))

901 
	`S‘PageU±od©e
(
·ge
);

902 
	`uÆock_·ge
(
·ge
);

903  
·ge
;

906 
”r
 = 
	`f2fs_subm™_·ge_»ad
(
šode
, 
·ge
, 
dn
.
d©a_blkaddr
);

907 ià(
”r
)

908 
put_”r
;

909  
·ge
;

911 
put_”r
:

912 
	`f2fs_put_·ge
(
·ge
, 1);

913  
	`ERR_PTR
(
”r
);

914 
	}
}

916 
·ge
 *
	$f2fs_fšd_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
)

918 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

919 
·ge
 *page;

921 
·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
šdex
);

922 ià(
·ge
 && 
	`PageU±od©e
(page))

923  
·ge
;

924 
	`f2fs_put_·ge
(
·ge
, 0);

926 
·ge
 = 
	`f2fs_g‘_»ad_d©a_·ge
(
šode
, 
šdex
, 0, 
çl£
);

927 ià(
	`IS_ERR
(
·ge
))

928  
·ge
;

930 ià(
	`PageU±od©e
(
·ge
))

931  
·ge
;

933 
	`wa™_Ú_·ge_locked
(
·ge
);

934 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

935 
	`f2fs_put_·ge
(
·ge
, 0);

936  
	`ERR_PTR
(-
EIO
);

938  
·ge
;

939 
	}
}

946 
·ge
 *
	$f2fs_g‘_lock_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
,

947 
boŞ
 
fÜ_wr™e
)

949 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

950 
·ge
 *page;

951 
»³©
:

952 
·ge
 = 
	`f2fs_g‘_»ad_d©a_·ge
(
šode
, 
šdex
, 0, 
fÜ_wr™e
);

953 ià(
	`IS_ERR
(
·ge
))

954  
·ge
;

957 
	`lock_·ge
(
·ge
);

958 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

959 
	`f2fs_put_·ge
(
·ge
, 1);

960 
»³©
;

962 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

963 
	`f2fs_put_·ge
(
·ge
, 1);

964  
	`ERR_PTR
(-
EIO
);

966  
·ge
;

967 
	}
}

978 
·ge
 *
	$f2fs_g‘_Ãw_d©a_·ge
(
šode
 *inode,

979 
·ge
 *
age
, 
pgoff_t
 
šdex
, 
boŞ
 
Ãw_i_size
)

981 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

982 
·ge
 *page;

983 
dnode_of_d©a
 
dn
;

984 
”r
;

986 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
m­pšg
, 
šdex
, 
Œue
);

987 ià(!
·ge
) {

992 
	`f2fs_put_·ge
(
age
, 1);

993  
	`ERR_PTR
(-
ENOMEM
);

996 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
age
, 
NULL
, 0);

997 
”r
 = 
	`f2fs_»£rve_block
(&
dn
, 
šdex
);

998 ià(
”r
) {

999 
	`f2fs_put_·ge
(
·ge
, 1);

1000  
	`ERR_PTR
(
”r
);

1002 ià(!
age
)

1003 
	`f2fs_put_dnode
(&
dn
);

1005 ià(
	`PageU±od©e
(
·ge
))

1006 
gÙ_™
;

1008 ià(
dn
.
d©a_blkaddr
 =ğ
NEW_ADDR
) {

1009 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

1010 ià(!
	`PageU±od©e
(
·ge
))

1011 
	`S‘PageU±od©e
(
·ge
);

1013 
	`f2fs_put_·ge
(
·ge
, 1);

1016 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
age
);

1017 
·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
šode
, 
šdex
, 
Œue
);

1018 ià(
	`IS_ERR
(
·ge
))

1019  
·ge
;

1021 
gÙ_™
:

1022 ià(
Ãw_i_size
 && 
	`i_size_»ad
(
šode
) <

1023 ((
loff_t
)(
šdex
 + 1è<< 
PAGE_SHIFT
))

1024 
	`f2fs_i_size_wr™e
(
šode
, ((
loff_t
)(
šdex
 + 1è<< 
PAGE_SHIFT
));

1025  
·ge
;

1026 
	}
}

1028 
	$__®loÿ‹_d©a_block
(
dnode_of_d©a
 *
dn
, 
£g_ty³
)

1030 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

1031 
f2fs_summ¬y
 
sum
;

1032 
node_šfo
 
ni
;

1033 
block_t
 
Şd_blkaddr
;

1034 
blkút_t
 
couÁ
 = 1;

1035 
”r
;

1037 ià(
	`uÆik–y
(
	`is_šode_æag_£t
(
dn
->
šode
, 
FI_NO_ALLOC
)))

1038  -
EPERM
;

1040 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
ni
);

1041 ià(
”r
)

1042  
”r
;

1044 
dn
->
d©a_blkaddr
 = 
	`d©ablock_addr
(dn->
šode
,

1045 
dn
->
node_·ge
, dn->
ofs_š_node
);

1046 ià(
dn
->
d©a_blkaddr
 !ğ
NULL_ADDR
)

1047 
®loc
;

1049 ià(
	`uÆik–y
((
”r
 = 
	`šc_v®id_block_couÁ
(
sbi
, 
dn
->
šode
, &
couÁ
))))

1050  
”r
;

1052 
®loc
:

1053 
	`£t_summ¬y
(&
sum
, 
dn
->
nid
, dn->
ofs_š_node
, 
ni
.
v”siÚ
);

1054 
Şd_blkaddr
 = 
dn
->
d©a_blkaddr
;

1055 
	`f2fs_®loÿ‹_d©a_block
(
sbi
, 
NULL
, 
Şd_blkaddr
, &
dn
->
d©a_blkaddr
,

1056 &
sum
, 
£g_ty³
, 
NULL
, 
çl£
);

1057 ià(
	`GET_SEGNO
(
sbi
, 
Şd_blkaddr
è!ğ
NULL_SEGNO
)

1058 
	`šv®id©e_m­pšg_·ges
(
	`META_MAPPING
(
sbi
),

1059 
Şd_blkaddr
, old_blkaddr);

1060 
	`f2fs_upd©e_d©a_blkaddr
(
dn
, dn->
d©a_blkaddr
);

1067 
	}
}

1069 
	$f2fs_´—Îoÿ‹_blocks
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

1071 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

1072 
f2fs_m­_blocks
 
m­
;

1073 
æag
;

1074 
”r
 = 0;

1075 
boŞ
 
dœeù_io
 = 
iocb
->
ki_æags
 & 
IOCB_DIRECT
;

1078 ià(
dœeù_io
) {

1079 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1080 ià(
”r
)

1081  
”r
;

1084 ià(
dœeù_io
 && 
	`®low_ouÏû_dio
(
šode
, 
iocb
, 
äom
))

1087 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NO_PREALLOC
))

1090 
m­
.
m_lblk
 = 
	`F2FS_BLK_ALIGN
(
iocb
->
ki_pos
);

1091 
m­
.
m_Ën
 = 
	`F2FS_BYTES_TO_BLK
(
iocb
->
ki_pos
 + 
	`iov_™”_couÁ
(
äom
));

1092 ià(
m­
.
m_Ën
 > m­.
m_lblk
)

1093 
m­
.
m_Ën
 -ğm­.
m_lblk
;

1095 
m­
.
m_Ën
 = 0;

1097 
m­
.
m_Ãxt_pgofs
 = 
NULL
;

1098 
m­
.
m_Ãxt_ex‹Á
 = 
NULL
;

1099 
m­
.
m_£g_ty³
 = 
NO_CHECK_TYPE
;

1100 
m­
.
m_may_ü—‹
 = 
Œue
;

1102 ià(
dœeù_io
) {

1103 
m­
.
m_£g_ty³
 = 
	`f2fs_rw_hšt_to_£g_ty³
(
iocb
->
ki_hšt
);

1104 
æag
 = 
	`f2fs_fÜû_bufã»d_io
(
šode
, 
iocb
, 
äom
) ?

1105 
F2FS_GET_BLOCK_PRE_AIO
 :

1106 
F2FS_GET_BLOCK_PRE_DIO
;

1107 
m­_blocks
;

1109 ià(
iocb
->
ki_pos
 + 
	`iov_™”_couÁ
(
äom
è> 
	`MAX_INLINE_DATA
(
šode
)) {

1110 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1111 ià(
”r
)

1112  
”r
;

1114 ià(
	`f2fs_has_šlše_d©a
(
šode
))

1115  
”r
;

1117 
æag
 = 
F2FS_GET_BLOCK_PRE_AIO
;

1119 
m­_blocks
:

1120 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 1, 
æag
);

1121 ià(
m­
.
m_Ën
 > 0 && 
”r
 =ğ-
ENOSPC
) {

1122 ià(!
dœeù_io
)

1123 
	`£t_šode_æag
(
šode
, 
FI_NO_PREALLOC
);

1124 
”r
 = 0;

1126  
”r
;

1127 
	}
}

1129 
	$__do_m­_lock
(
f2fs_sb_šfo
 *
sbi
, 
æag
, 
boŞ
 
lock
)

1131 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRE_AIO
) {

1132 ià(
lock
)

1133 
	`down_»ad
(&
sbi
->
node_chªge
);

1135 
	`up_»ad
(&
sbi
->
node_chªge
);

1137 ià(
lock
)

1138 
	`f2fs_lock_İ
(
sbi
);

1140 
	`f2fs_uÆock_İ
(
sbi
);

1142 
	}
}

1153 
	$f2fs_m­_blocks
(
šode
 *šode, 
f2fs_m­_blocks
 *
m­
,

1154 
ü—‹
, 
æag
)

1156 
maxblocks
 = 
m­
->
m_Ën
;

1157 
dnode_of_d©a
 
dn
;

1158 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1159 
mode
 = 
m­
->
m_may_ü—‹
 ? 
ALLOC_NODE
 : 
LOOKUP_NODE
;

1160 
pgoff_t
 
pgofs
, 
’d_off£t
, 
’d
;

1161 
”r
 = 0, 
ofs
 = 1;

1162 
ofs_š_node
, 
Ï¡_ofs_š_node
;

1163 
blkút_t
 
´—Îoc
;

1164 
ex‹Á_šfo
 
ei
 = {0,0,0};

1165 
block_t
 
blkaddr
;

1166 
¡¬t_pgofs
;

1168 ià(!
maxblocks
)

1171 
m­
->
m_Ën
 = 0;

1172 
m­
->
m_æags
 = 0;

1175 
pgofs
 = (
pgoff_t
)
m­
->
m_lblk
;

1176 
’d
 = 
pgofs
 + 
maxblocks
;

1178 ià(!
ü—‹
 && 
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
pgofs
, &
ei
)) {

1179 ià(
	`‹¡_İt
(
sbi
, 
LFS
è&& 
æag
 =ğ
F2FS_GET_BLOCK_DIO
 &&

1180 
m­
->
m_may_ü—‹
)

1181 
Ãxt_dnode
;

1183 
m­
->
m_pblk
 = 
ei
.
blk
 + 
pgofs
 -ƒi.
fofs
;

1184 
m­
->
m_Ën
 = 
	`mš
((
pgoff_t
)
maxblocks
, 
ei
.
fofs
 +ƒi.
Ën
 - 
pgofs
);

1185 
m­
->
m_æags
 = 
F2FS_MAP_MAPPED
;

1186 ià(
m­
->
m_Ãxt_ex‹Á
)

1187 *
m­
->
m_Ãxt_ex‹Á
 = 
pgofs
 + m­->
m_Ën
;

1190 ià(
æag
 =ğ
F2FS_GET_BLOCK_DIO
)

1191 
	`f2fs_wa™_Ú_block_wr™eback_¿nge
(
šode
,

1192 
m­
->
m_pblk
, m­->
m_Ën
);

1193 
out
;

1196 
Ãxt_dnode
:

1197 ià(
m­
->
m_may_ü—‹
)

1198 
	`__do_m­_lock
(
sbi
, 
æag
, 
Œue
);

1201 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1202 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
pgofs
, 
mode
);

1203 ià(
”r
) {

1204 ià(
æag
 =ğ
F2FS_GET_BLOCK_BMAP
)

1205 
m­
->
m_pblk
 = 0;

1206 ià(
”r
 =ğ-
ENOENT
) {

1207 
”r
 = 0;

1208 ià(
m­
->
m_Ãxt_pgofs
)

1209 *
m­
->
m_Ãxt_pgofs
 =

1210 
	`f2fs_g‘_Ãxt_·ge_off£t
(&
dn
, 
pgofs
);

1211 ià(
m­
->
m_Ãxt_ex‹Á
)

1212 *
m­
->
m_Ãxt_ex‹Á
 =

1213 
	`f2fs_g‘_Ãxt_·ge_off£t
(&
dn
, 
pgofs
);

1215 
uÆock_out
;

1218 
¡¬t_pgofs
 = 
pgofs
;

1219 
´—Îoc
 = 0;

1220 
Ï¡_ofs_š_node
 = 
ofs_š_node
 = 
dn
.ofs_in_node;

1221 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
);

1223 
Ãxt_block
:

1224 
blkaddr
 = 
	`d©ablock_addr
(
dn
.
šode
, dn.
node_·ge
, dn.
ofs_š_node
);

1226 ià(
	`__is_v®id_d©a_blkaddr
(
blkaddr
) &&

1227 !
	`f2fs_is_v®id_blkaddr
(
sbi
, 
blkaddr
, 
DATA_GENERIC_ENHANCE
)) {

1228 
”r
 = -
EFSCORRUPTED
;

1229 
sync_out
;

1232 ià(
	`__is_v®id_d©a_blkaddr
(
blkaddr
)) {

1234 ià(
	`‹¡_İt
(
sbi
, 
LFS
è&& 
æag
 =ğ
F2FS_GET_BLOCK_DIO
 &&

1235 
m­
->
m_may_ü—‹
) {

1236 
”r
 = 
	`__®loÿ‹_d©a_block
(&
dn
, 
m­
->
m_£g_ty³
);

1237 ià(
”r
)

1238 
sync_out
;

1239 
blkaddr
 = 
dn
.
d©a_blkaddr
;

1240 
	`£t_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

1243 ià(
ü—‹
) {

1244 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1245 
”r
 = -
EIO
;

1246 
sync_out
;

1248 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRE_AIO
) {

1249 ià(
blkaddr
 =ğ
NULL_ADDR
) {

1250 
´—Îoc
++;

1251 
Ï¡_ofs_š_node
 = 
dn
.
ofs_š_node
;

1254 
	`WARN_ON
(
æag
 !ğ
F2FS_GET_BLOCK_PRE_DIO
 &&

1255 
æag
 !ğ
F2FS_GET_BLOCK_DIO
);

1256 
”r
 = 
	`__®loÿ‹_d©a_block
(&
dn
,

1257 
m­
->
m_£g_ty³
);

1258 ià(!
”r
)

1259 
	`£t_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

1261 ià(
”r
)

1262 
sync_out
;

1263 
m­
->
m_æags
 |ğ
F2FS_MAP_NEW
;

1264 
blkaddr
 = 
dn
.
d©a_blkaddr
;

1266 ià(
æag
 =ğ
F2FS_GET_BLOCK_BMAP
) {

1267 
m­
->
m_pblk
 = 0;

1268 
sync_out
;

1270 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRECACHE
)

1271 
sync_out
;

1272 ià(
æag
 =ğ
F2FS_GET_BLOCK_FIEMAP
 &&

1273 
blkaddr
 =ğ
NULL_ADDR
) {

1274 ià(
m­
->
m_Ãxt_pgofs
)

1275 *
m­
->
m_Ãxt_pgofs
 = 
pgofs
 + 1;

1276 
sync_out
;

1278 ià(
æag
 !ğ
F2FS_GET_BLOCK_FIEMAP
) {

1280 ià(
m­
->
m_Ãxt_pgofs
)

1281 *
m­
->
m_Ãxt_pgofs
 = 
pgofs
 + 1;

1282 
sync_out
;

1287 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRE_AIO
)

1288 
sk
;

1290 ià(
m­
->
m_Ën
 == 0) {

1292 ià(
blkaddr
 =ğ
NEW_ADDR
)

1293 
m­
->
m_æags
 |ğ
F2FS_MAP_UNWRITTEN
;

1294 
m­
->
m_æags
 |ğ
F2FS_MAP_MAPPED
;

1296 
m­
->
m_pblk
 = 
blkaddr
;

1297 
m­
->
m_Ën
 = 1;

1298 } ià((
m­
->
m_pblk
 !ğ
NEW_ADDR
 &&

1299 
blkaddr
 =ğ(
m­
->
m_pblk
 + 
ofs
)) ||

1300 (
m­
->
m_pblk
 =ğ
NEW_ADDR
 && 
blkaddr
 == NEW_ADDR) ||

1301 
æag
 =ğ
F2FS_GET_BLOCK_PRE_DIO
) {

1302 
ofs
++;

1303 
m­
->
m_Ën
++;

1305 
sync_out
;

1308 
sk
:

1309 
dn
.
ofs_š_node
++;

1310 
pgofs
++;

1313 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRE_AIO
 &&

1314 (
pgofs
 =ğ
’d
 || 
dn
.
ofs_š_node
 =ğ
’d_off£t
)) {

1316 
dn
.
ofs_š_node
 = ofs_in_node;

1317 
”r
 = 
	`f2fs_»£rve_Ãw_blocks
(&
dn
, 
´—Îoc
);

1318 ià(
”r
)

1319 
sync_out
;

1321 
m­
->
m_Ën
 +ğ
dn
.
ofs_š_node
 - ofs_in_node;

1322 ià(
´—Îoc
 && 
dn
.
ofs_š_node
 !ğ
Ï¡_ofs_š_node
 + 1) {

1323 
”r
 = -
ENOSPC
;

1324 
sync_out
;

1326 
dn
.
ofs_š_node
 = 
’d_off£t
;

1329 ià(
pgofs
 >ğ
’d
)

1330 
sync_out
;

1331 ià(
dn
.
ofs_š_node
 < 
’d_off£t
)

1332 
Ãxt_block
;

1334 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRECACHE
) {

1335 ià(
m­
->
m_æags
 & 
F2FS_MAP_MAPPED
) {

1336 
ofs
 = 
¡¬t_pgofs
 - 
m­
->
m_lblk
;

1338 
	`f2fs_upd©e_ex‹Á_ÿche_¿nge
(&
dn
,

1339 
¡¬t_pgofs
, 
m­
->
m_pblk
 + 
ofs
,

1340 
m­
->
m_Ën
 - 
ofs
);

1344 
	`f2fs_put_dnode
(&
dn
);

1346 ià(
m­
->
m_may_ü—‹
) {

1347 
	`__do_m­_lock
(
sbi
, 
æag
, 
çl£
);

1348 
	`f2fs_b®ªû_fs
(
sbi
, 
dn
.
node_chªged
);

1350 
Ãxt_dnode
;

1352 
sync_out
:

1355 ià(
æag
 =ğ
F2FS_GET_BLOCK_DIO
 && 
m­
->
m_æags
 & 
F2FS_MAP_MAPPED
)

1356 
	`f2fs_wa™_Ú_block_wr™eback_¿nge
(
šode
,

1357 
m­
->
m_pblk
, m­->
m_Ën
);

1359 ià(
æag
 =ğ
F2FS_GET_BLOCK_PRECACHE
) {

1360 ià(
m­
->
m_æags
 & 
F2FS_MAP_MAPPED
) {

1361 
ofs
 = 
¡¬t_pgofs
 - 
m­
->
m_lblk
;

1363 
	`f2fs_upd©e_ex‹Á_ÿche_¿nge
(&
dn
,

1364 
¡¬t_pgofs
, 
m­
->
m_pblk
 + 
ofs
,

1365 
m­
->
m_Ën
 - 
ofs
);

1367 ià(
m­
->
m_Ãxt_ex‹Á
)

1368 *
m­
->
m_Ãxt_ex‹Á
 = 
pgofs
 + 1;

1370 
	`f2fs_put_dnode
(&
dn
);

1371 
uÆock_out
:

1372 ià(
m­
->
m_may_ü—‹
) {

1373 
	`__do_m­_lock
(
sbi
, 
æag
, 
çl£
);

1374 
	`f2fs_b®ªû_fs
(
sbi
, 
dn
.
node_chªged
);

1376 
out
:

1377 
	`Œaû_f2fs_m­_blocks
(
šode
, 
m­
, 
”r
);

1378  
”r
;

1379 
	}
}

1381 
boŞ
 
	$f2fs_ov”wr™e_io
(
šode
 *šode, 
loff_t
 
pos
, 
size_t
 
Ën
)

1383 
f2fs_m­_blocks
 
m­
;

1384 
block_t
 
Ï¡_lblk
;

1385 
”r
;

1387 ià(
pos
 + 
Ën
 > 
	`i_size_»ad
(
šode
))

1388  
çl£
;

1390 
m­
.
m_lblk
 = 
	`F2FS_BYTES_TO_BLK
(
pos
);

1391 
m­
.
m_Ãxt_pgofs
 = 
NULL
;

1392 
m­
.
m_Ãxt_ex‹Á
 = 
NULL
;

1393 
m­
.
m_£g_ty³
 = 
NO_CHECK_TYPE
;

1394 
m­
.
m_may_ü—‹
 = 
çl£
;

1395 
Ï¡_lblk
 = 
	`F2FS_BLK_ALIGN
(
pos
 + 
Ën
);

1397 
m­
.
m_lblk
 < 
Ï¡_lblk
) {

1398 
m­
.
m_Ën
 = 
Ï¡_lblk
 - m­.
m_lblk
;

1399 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 0, 
F2FS_GET_BLOCK_DEFAULT
);

1400 ià(
”r
 || 
m­
.
m_Ën
 == 0)

1401  
çl£
;

1402 
m­
.
m_lblk
 +ğm­.
m_Ën
;

1404  
Œue
;

1405 
	}
}

1407 
	$__g‘_d©a_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1408 
bufãr_h—d
 *
bh
, 
ü—‹
, 
æag
,

1409 
pgoff_t
 *
Ãxt_pgofs
, 
£g_ty³
, 
boŞ
 
may_wr™e
)

1411 
f2fs_m­_blocks
 
m­
;

1412 
”r
;

1414 
m­
.
m_lblk
 = 
iblock
;

1415 
m­
.
m_Ën
 = 
bh
->
b_size
 >> 
šode
->
i_blkb™s
;

1416 
m­
.
m_Ãxt_pgofs
 = 
Ãxt_pgofs
;

1417 
m­
.
m_Ãxt_ex‹Á
 = 
NULL
;

1418 
m­
.
m_£g_ty³
 = 
£g_ty³
;

1419 
m­
.
m_may_ü—‹
 = 
may_wr™e
;

1421 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 
ü—‹
, 
æag
);

1422 ià(!
”r
) {

1423 
	`m­_bh
(
bh
, 
šode
->
i_sb
, 
m­
.
m_pblk
);

1424 
bh
->
b_¡©e
 = (bh->b_¡©& ~
F2FS_MAP_FLAGS
è| 
m­
.
m_æags
;

1425 
bh
->
b_size
 = (
u64
)
m­
.
m_Ën
 << 
šode
->
i_blkb™s
;

1427  
”r
;

1428 
	}
}

1430 
	$g‘_d©a_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1431 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
, 
æag
,

1432 
pgoff_t
 *
Ãxt_pgofs
)

1434  
	`__g‘_d©a_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
ü—‹
,

1435 
æag
, 
Ãxt_pgofs
,

1436 
NO_CHECK_TYPE
, 
ü—‹
);

1437 
	}
}

1439 
	$g‘_d©a_block_dio_wr™e
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1440 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

1442  
	`__g‘_d©a_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
ü—‹
,

1443 
F2FS_GET_BLOCK_DIO
, 
NULL
,

1444 
	`f2fs_rw_hšt_to_£g_ty³
(
šode
->
i_wr™e_hšt
),

1445 
	`IS_SWAPFILE
(
šode
è? 
çl£
 : 
Œue
);

1446 
	}
}

1448 
	$g‘_d©a_block_dio
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1449 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

1451  
	`__g‘_d©a_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
ü—‹
,

1452 
F2FS_GET_BLOCK_DIO
, 
NULL
,

1453 
	`f2fs_rw_hšt_to_£g_ty³
(
šode
->
i_wr™e_hšt
),

1454 
çl£
);

1455 
	}
}

1457 
	$g‘_d©a_block_bm­
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1458 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

1461 ià(
	`uÆik–y
(
iblock
 >ğ
	`F2FS_I_SB
(
šode
)->
max_fe_blocks
))

1462  -
EFBIG
;

1464  
	`__g‘_d©a_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
ü—‹
,

1465 
F2FS_GET_BLOCK_BMAP
, 
NULL
,

1466 
NO_CHECK_TYPE
, 
ü—‹
);

1467 
	}
}

1469 
šlše
 
£ùÜ_t
 
	$logiÿl_to_blk
(
šode
 *šode, 
loff_t
 
off£t
)

1471  (
off£t
 >> 
šode
->
i_blkb™s
);

1472 
	}
}

1474 
šlše
 
loff_t
 
	$blk_to_logiÿl
(
šode
 *šode, 
£ùÜ_t
 
blk
)

1476  (
blk
 << 
šode
->
i_blkb™s
);

1477 
	}
}

1479 
	$f2fs_x©Œ_f›m­
(
šode
 *inode,

1480 
f›m­_ex‹Á_šfo
 *
f›šfo
)

1482 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1483 
·ge
 *page;

1484 
node_šfo
 
ni
;

1485 
__u64
 
phys
 = 0, 
Ën
;

1486 
__u32
 
æags
;

1487 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

1488 
”r
 = 0;

1490 ià(
	`f2fs_has_šlše_x©Œ
(
šode
)) {

1491 
off£t
;

1493 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
),

1494 
šode
->
i_šo
, 
çl£
);

1495 ià(!
·ge
)

1496  -
ENOMEM
;

1498 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
šode
->
i_šo
, &
ni
);

1499 ià(
”r
) {

1500 
	`f2fs_put_·ge
(
·ge
, 1);

1501  
”r
;

1504 
phys
 = (
__u64
)
	`blk_to_logiÿl
(
šode
, 
ni
.
blk_addr
);

1505 
off£t
 = 
	`off£tof
(
f2fs_šode
, 
i_addr
) +

1506 (
__Ë32
è* (
DEF_ADDRS_PER_INODE
 -

1507 
	`g‘_šlše_x©Œ_addrs
(
šode
));

1509 
phys
 +ğ
off£t
;

1510 
Ën
 = 
	`šlše_x©Œ_size
(
šode
);

1512 
	`f2fs_put_·ge
(
·ge
, 1);

1514 
æags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
;

1516 ià(!
xnid
)

1517 
æags
 |ğ
FIEMAP_EXTENT_LAST
;

1519 
”r
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 0, 
phys
, 
Ën
, 
æags
);

1520 ià(
”r
 ||ƒrr == 1)

1521  
”r
;

1524 ià(
xnid
) {

1525 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
xnid
, 
çl£
);

1526 ià(!
·ge
)

1527  -
ENOMEM
;

1529 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
xnid
, &
ni
);

1530 ià(
”r
) {

1531 
	`f2fs_put_·ge
(
·ge
, 1);

1532  
”r
;

1535 
phys
 = (
__u64
)
	`blk_to_logiÿl
(
šode
, 
ni
.
blk_addr
);

1536 
Ën
 = 
šode
->
i_sb
->
s_blocksize
;

1538 
	`f2fs_put_·ge
(
·ge
, 1);

1540 
æags
 = 
FIEMAP_EXTENT_LAST
;

1543 ià(
phys
)

1544 
”r
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 0, 
phys
, 
Ën
, 
æags
);

1546  (
”r
 < 0 ?ƒrr : 0);

1547 
	}
}

1549 
	$f2fs_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

1550 
u64
 
¡¬t
, u64 
Ën
)

1552 
bufãr_h—d
 
m­_bh
;

1553 
£ùÜ_t
 
¡¬t_blk
, 
Ï¡_blk
;

1554 
pgoff_t
 
Ãxt_pgofs
;

1555 
u64
 
logiÿl
 = 0, 
phys
 = 0, 
size
 = 0;

1556 
u32
 
æags
 = 0;

1557 
»t
 = 0;

1559 ià(
f›šfo
->
fi_æags
 & 
FIEMAP_FLAG_CACHE
) {

1560 
»t
 = 
	`f2fs_´eÿche_ex‹Ás
(
šode
);

1561 ià(
»t
)

1562  
»t
;

1565 
»t
 = 
	`f›m­_check_æags
(
f›šfo
, 
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
);

1566 ià(
»t
)

1567  
»t
;

1569 
	`šode_lock
(
šode
);

1571 ià(
f›šfo
->
fi_æags
 & 
FIEMAP_FLAG_XATTR
) {

1572 
»t
 = 
	`f2fs_x©Œ_f›m­
(
šode
, 
f›šfo
);

1573 
out
;

1576 ià(
	`f2fs_has_šlše_d©a
(
šode
è|| 
	`f2fs_has_šlše_d’Œy
(inode)) {

1577 
»t
 = 
	`f2fs_šlše_d©a_f›m­
(
šode
, 
f›šfo
, 
¡¬t
, 
Ën
);

1578 ià(
»t
 !ğ-
EAGAIN
)

1579 
out
;

1582 ià(
	`logiÿl_to_blk
(
šode
, 
Ën
) == 0)

1583 
Ën
 = 
	`blk_to_logiÿl
(
šode
, 1);

1585 
¡¬t_blk
 = 
	`logiÿl_to_blk
(
šode
, 
¡¬t
);

1586 
Ï¡_blk
 = 
	`logiÿl_to_blk
(
šode
, 
¡¬t
 + 
Ën
 - 1);

1588 
Ãxt
:

1589 
	`mem£t
(&
m­_bh
, 0, (
bufãr_h—d
));

1590 
m­_bh
.
b_size
 = 
Ën
;

1592 
»t
 = 
	`g‘_d©a_block
(
šode
, 
¡¬t_blk
, &
m­_bh
, 0,

1593 
F2FS_GET_BLOCK_FIEMAP
, &
Ãxt_pgofs
);

1594 ià(
»t
)

1595 
out
;

1598 ià(!
	`bufãr_m­³d
(&
m­_bh
)) {

1599 
¡¬t_blk
 = 
Ãxt_pgofs
;

1601 ià(
	`blk_to_logiÿl
(
šode
, 
¡¬t_blk
) < blk_to_logical(inode,

1602 
	`F2FS_I_SB
(
šode
)->
max_fe_blocks
))

1603 
´•_Ãxt
;

1605 
æags
 |ğ
FIEMAP_EXTENT_LAST
;

1608 ià(
size
) {

1609 ià(
	`IS_ENCRYPTED
(
šode
))

1610 
æags
 |ğ
FIEMAP_EXTENT_DATA_ENCRYPTED
;

1612 
»t
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 
logiÿl
,

1613 
phys
, 
size
, 
æags
);

1616 ià(
¡¬t_blk
 > 
Ï¡_blk
 || 
»t
)

1617 
out
;

1619 
logiÿl
 = 
	`blk_to_logiÿl
(
šode
, 
¡¬t_blk
);

1620 
phys
 = 
	`blk_to_logiÿl
(
šode
, 
m­_bh
.
b_blockÄ
);

1621 
size
 = 
m­_bh
.
b_size
;

1622 
æags
 = 0;

1623 ià(
	`bufãr_unwr™‹n
(&
m­_bh
))

1624 
æags
 = 
FIEMAP_EXTENT_UNWRITTEN
;

1626 
¡¬t_blk
 +ğ
	`logiÿl_to_blk
(
šode
, 
size
);

1628 
´•_Ãxt
:

1629 
	`cÚd_»sched
();

1630 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

1631 
»t
 = -
EINTR
;

1633 
Ãxt
;

1634 
out
:

1635 ià(
»t
 == 1)

1636 
»t
 = 0;

1638 
	`šode_uÆock
(
šode
);

1639  
»t
;

1640 
	}
}

1642 
šlše
 
loff_t
 
	$f2fs_»ad·ge_lim™
(
šode
 *inode)

1644 ià(
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

1645 (
	`IS_VERITY
(
šode
è|| 
	`f2fs_v”™y_š_´og»ss
(inode)))

1646  
šode
->
i_sb
->
s_maxby‹s
;

1648  
	`i_size_»ad
(
šode
);

1649 
	}
}

1651 
	$f2fs_»ad_sšgË_·ge
(
šode
 *šode, 
·ge
 *page,

1652 
Ä_·ges
,

1653 
f2fs_m­_blocks
 *
m­
,

1654 
bio
 **
bio_»t
,

1655 
£ùÜ_t
 *
Ï¡_block_š_bio
,

1656 
boŞ
 
is_»adah—d
)

1658 
bio
 *biØğ*
bio_»t
;

1659 cÚ¡ 
blkb™s
 = 
šode
->
i_blkb™s
;

1660 cÚ¡ 
blocksize
 = 1 << 
blkb™s
;

1661 
£ùÜ_t
 
block_š_fe
;

1662 
£ùÜ_t
 
Ï¡_block
;

1663 
£ùÜ_t
 
Ï¡_block_š_fe
;

1664 
£ùÜ_t
 
block_Ä
;

1665 
»t
 = 0;

1667 
block_š_fe
 = (
£ùÜ_t
)
	`·ge_šdex
(
·ge
);

1668 
Ï¡_block
 = 
block_š_fe
 + 
Ä_·ges
;

1669 
Ï¡_block_š_fe
 = (
	`f2fs_»ad·ge_lim™
(
šode
è+ 
blocksize
 - 1) >>

1670 
blkb™s
;

1671 ià(
Ï¡_block
 > 
Ï¡_block_š_fe
)

1672 
Ï¡_block
 = 
Ï¡_block_š_fe
;

1675 ià(
block_š_fe
 >ğ
Ï¡_block
)

1676 
z”o_out
;

1680 ià((
m­
->
m_æags
 & 
F2FS_MAP_MAPPED
) &&

1681 
block_š_fe
 > 
m­
->
m_lblk
 &&

1682 
block_š_fe
 < (
m­
->
m_lblk
 + m­->
m_Ën
))

1683 
gÙ_™
;

1689 
m­
->
m_lblk
 = 
block_š_fe
;

1690 
m­
->
m_Ën
 = 
Ï¡_block
 - 
block_š_fe
;

1692 
»t
 = 
	`f2fs_m­_blocks
(
šode
, 
m­
, 0, 
F2FS_GET_BLOCK_DEFAULT
);

1693 ià(
»t
)

1694 
out
;

1695 
gÙ_™
:

1696 ià((
m­
->
m_æags
 & 
F2FS_MAP_MAPPED
)) {

1697 
block_Ä
 = 
m­
->
m_pblk
 + 
block_š_fe
 - m­->
m_lblk
;

1698 
	`S‘PageM­³dToDisk
(
·ge
);

1700 ià(!
	`PageU±od©e
(
·ge
è&& (!
	`PageSw­Cache
(page) &&

1701 !
	`ş—nÿche_g‘_·ge
(
·ge
))) {

1702 
	`S‘PageU±od©e
(
·ge
);

1703 
cÚfu£d
;

1706 ià(!
	`f2fs_is_v®id_blkaddr
(
	`F2FS_I_SB
(
šode
), 
block_Ä
,

1707 
DATA_GENERIC_ENHANCE_READ
)) {

1708 
»t
 = -
EFSCORRUPTED
;

1709 
out
;

1712 
z”o_out
:

1713 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

1714 ià(
	`f2fs_Ãed_v”™y
(
šode
, 
·ge
->
šdex
) &&

1715 !
	`fsv”™y_v”ify_·ge
(
·ge
)) {

1716 
»t
 = -
EIO
;

1717 
out
;

1719 ià(!
	`PageU±od©e
(
·ge
))

1720 
	`S‘PageU±od©e
(
·ge
);

1721 
	`uÆock_·ge
(
·ge
);

1722 
out
;

1729 ià(
bio
 && !
	`·ge_is_m”g—bË
(
	`F2FS_I_SB
(
šode
), bio,

1730 *
Ï¡_block_š_bio
, 
block_Ä
)) {

1731 
subm™_ªd_»®loc
:

1732 
	`__subm™_bio
(
	`F2FS_I_SB
(
šode
), 
bio
, 
DATA
);

1733 
bio
 = 
NULL
;

1735 ià(
bio
 =ğ
NULL
) {

1736 
bio
 = 
	`f2fs_g¿b_»ad_bio
(
šode
, 
block_Ä
, 
Ä_·ges
,

1737 
is_»adah—d
 ? 
REQ_RAHEAD
 : 0, 
·ge
->
šdex
);

1738 ià(
	`IS_ERR
(
bio
)) {

1739 
»t
 = 
	`PTR_ERR
(
bio
);

1740 
bio
 = 
NULL
;

1741 
out
;

1749 
	`f2fs_wa™_Ú_block_wr™eback
(
šode
, 
block_Ä
);

1751 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
blocksize
, 0) < blocksize)

1752 
subm™_ªd_»®loc
;

1754 
	`šc_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_RD_DATA
);

1755 
	`CË¬PageE¼Ü
(
·ge
);

1756 *
Ï¡_block_š_bio
 = 
block_Ä
;

1757 
out
;

1758 
cÚfu£d
:

1759 ià(
bio
) {

1760 
	`__subm™_bio
(
	`F2FS_I_SB
(
šode
), 
bio
, 
DATA
);

1761 
bio
 = 
NULL
;

1763 
	`uÆock_·ge
(
·ge
);

1764 
out
:

1765 *
bio_»t
 = 
bio
;

1766  
»t
;

1767 
	}
}

1778 
	$f2fs_m·ge_»ad·ges
(
add»ss_¥aû
 *
m­pšg
,

1779 
li¡_h—d
 *
·ges
, 
·ge
 *page,

1780 
Ä_·ges
, 
boŞ
 
is_»adah—d
)

1782 
bio
 *biØğ
NULL
;

1783 
£ùÜ_t
 
Ï¡_block_š_bio
 = 0;

1784 
šode
 *šodğ
m­pšg
->
ho¡
;

1785 
f2fs_m­_blocks
 
m­
;

1786 
»t
 = 0;

1788 
m­
.
m_pblk
 = 0;

1789 
m­
.
m_lblk
 = 0;

1790 
m­
.
m_Ën
 = 0;

1791 
m­
.
m_æags
 = 0;

1792 
m­
.
m_Ãxt_pgofs
 = 
NULL
;

1793 
m­
.
m_Ãxt_ex‹Á
 = 
NULL
;

1794 
m­
.
m_£g_ty³
 = 
NO_CHECK_TYPE
;

1795 
m­
.
m_may_ü—‹
 = 
çl£
;

1797 ; 
Ä_·ges
;‚r_pages--) {

1798 ià(
·ges
) {

1799 
·ge
 = 
	`li¡_Ï¡_’Œy
(
·ges
, ·ge, 
Ìu
);

1801 
	`´eãtchw
(&
·ge
->
æags
);

1802 
	`li¡_d–
(&
·ge
->
Ìu
);

1803 ià(
	`add_to_·ge_ÿche_Ìu
(
·ge
, 
m­pšg
,

1804 
	`·ge_šdex
(
·ge
),

1805 
	`»adah—d_gå_mask
(
m­pšg
)))

1806 
Ãxt_·ge
;

1809 
»t
 = 
	`f2fs_»ad_sšgË_·ge
(
šode
, 
·ge
, 
Ä_·ges
, &
m­
, &
bio
,

1810 &
Ï¡_block_š_bio
, 
is_»adah—d
);

1811 ià(
»t
) {

1812 
	`S‘PageE¼Ü
(
·ge
);

1813 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

1814 
	`uÆock_·ge
(
·ge
);

1816 
Ãxt_·ge
:

1817 ià(
·ges
)

1818 
	`put_·ge
(
·ge
);

1820 
	`BUG_ON
(
·ges
 && !
	`li¡_em±y
(pages));

1821 ià(
bio
)

1822 
	`__subm™_bio
(
	`F2FS_I_SB
(
šode
), 
bio
, 
DATA
);

1823  
·ges
 ? 0 : 
»t
;

1824 
	}
}

1826 
	$f2fs_»ad_d©a_·ge
(
fe
 *fe, 
·ge
 *page)

1828 
šode
 *šodğ
	`·ge_fe_m­pšg
(
·ge
)->
ho¡
;

1829 
»t
 = -
EAGAIN
;

1831 
	`Œaû_f2fs_»ad·ge
(
·ge
, 
DATA
);

1834 ià(
	`f2fs_has_šlše_d©a
(
šode
))

1835 
»t
 = 
	`f2fs_»ad_šlše_d©a
(
šode
, 
·ge
);

1836 ià(
»t
 =ğ-
EAGAIN
)

1837 
»t
 = 
	`f2fs_m·ge_»ad·ges
(
	`·ge_fe_m­pšg
(
·ge
),

1838 
NULL
, 
·ge
, 1, 
çl£
);

1839  
»t
;

1840 
	}
}

1842 
	$f2fs_»ad_d©a_·ges
(
fe
 *file,

1843 
add»ss_¥aû
 *
m­pšg
,

1844 
li¡_h—d
 *
·ges
, 
Ä_·ges
)

1846 
šode
 *šodğ
m­pšg
->
ho¡
;

1847 
·ge
 *·gğ
	`li¡_Ï¡_’Œy
(
·ges
, ·ge, 
Ìu
);

1849 
	`Œaû_f2fs_»ad·ges
(
šode
, 
·ge
, 
Ä_·ges
);

1852 ià(
	`f2fs_has_šlše_d©a
(
šode
))

1855  
	`f2fs_m·ge_»ad·ges
(
m­pšg
, 
·ges
, 
NULL
, 
Ä_·ges
, 
Œue
);

1856 
	}
}

1858 
	$’üy±_Úe_·ge
(
f2fs_io_šfo
 *
fio
)

1860 
šode
 *šodğ
fio
->
·ge
->
m­pšg
->
ho¡
;

1861 
·ge
 *
m·ge
;

1862 
gå_t
 
gå_æags
 = 
GFP_NOFS
;

1864 ià(!
	`f2fs_’üy±ed_fe
(
šode
))

1868 
	`f2fs_wa™_Ú_block_wr™eback
(
šode
, 
fio
->
Şd_blkaddr
);

1870 
»Œy_’üy±
:

1871 
fio
->
’üy±ed_·ge
 = 
	`fsüy±_’üy±_·geÿche_blocks
(fio->
·ge
,

1872 
PAGE_SIZE
, 0,

1873 
gå_æags
);

1874 ià(
	`IS_ERR
(
fio
->
’üy±ed_·ge
)) {

1876 ià(
	`PTR_ERR
(
fio
->
’üy±ed_·ge
è=ğ-
ENOMEM
) {

1877 
	`f2fs_æush_m”ged_wr™es
(
fio
->
sbi
);

1878 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

1879 
gå_æags
 |ğ
__GFP_NOFAIL
;

1880 
»Œy_’üy±
;

1882  
	`PTR_ERR
(
fio
->
’üy±ed_·ge
);

1885 
m·ge
 = 
	`fšd_lock_·ge
(
	`META_MAPPING
(
fio
->
sbi
), fio->
Şd_blkaddr
);

1886 ià(
m·ge
) {

1887 ià(
	`PageU±od©e
(
m·ge
))

1888 
	`memıy
(
	`·ge_add»ss
(
m·ge
),

1889 
	`·ge_add»ss
(
fio
->
’üy±ed_·ge
), 
PAGE_SIZE
);

1890 
	`f2fs_put_·ge
(
m·ge
, 1);

1893 
	}
}

1895 
šlše
 
boŞ
 
	$check_š¶aû_upd©e_pŞicy
(
šode
 *inode,

1896 
f2fs_io_šfo
 *
fio
)

1898 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1899 
pŞicy
 = 
	`SM_I
(
sbi
)->
u_pŞicy
;

1901 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_FORCE
))

1902  
Œue
;

1903 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_SSR
è&& 
	`f2fs_Ãed_SSR
(
sbi
))

1904  
Œue
;

1905 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_UTIL
) &&

1906 
	`utiz©iÚ
(
sbi
è> 
	`SM_I
(sbi)->
mš_u_ut
)

1907  
Œue
;

1908 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_SSR_UTIL
è&& 
	`f2fs_Ãed_SSR
(
sbi
) &&

1909 
	`utiz©iÚ
(
sbi
è> 
	`SM_I
(sbi)->
mš_u_ut
)

1910  
Œue
;

1915 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_ASYNC
) &&

1916 
fio
 && fio->
İ
 =ğ
REQ_OP_WRITE
 &&

1917 !(
fio
->
İ_æags
 & 
REQ_SYNC
) &&

1918 !
	`IS_ENCRYPTED
(
šode
))

1919  
Œue
;

1922 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_FSYNC
) &&

1923 
	`is_šode_æag_£t
(
šode
, 
FI_NEED_IPU
))

1924  
Œue
;

1926 ià(
	`uÆik–y
(
fio
 && 
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
) &&

1927 !
	`f2fs_is_checkpoš‹d_d©a
(
sbi
, 
fio
->
Şd_blkaddr
)))

1928  
Œue
;

1930  
çl£
;

1931 
	}
}

1933 
boŞ
 
	$f2fs_should_upd©e_š¶aû
(
šode
 *šode, 
f2fs_io_šfo
 *
fio
)

1935 ià(
	`f2fs_is_pšÃd_fe
(
šode
))

1936  
Œue
;

1939 ià(
	`fe_is_cŞd
(
šode
))

1940  
Œue
;

1942  
	`check_š¶aû_upd©e_pŞicy
(
šode
, 
fio
);

1943 
	}
}

1945 
boŞ
 
	$f2fs_should_upd©e_ouÏû
(
šode
 *šode, 
f2fs_io_šfo
 *
fio
)

1947 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1949 ià(
	`‹¡_İt
(
sbi
, 
LFS
))

1950  
Œue
;

1951 ià(
	`S_ISDIR
(
šode
->
i_mode
))

1952  
Œue
;

1953 ià(
	`IS_NOQUOTA
(
šode
))

1954  
Œue
;

1955 ià(
	`f2fs_is_©omic_fe
(
šode
))

1956  
Œue
;

1957 ià(
fio
) {

1958 ià(
	`is_cŞd_d©a
(
fio
->
·ge
))

1959  
Œue
;

1960 ià(
	`IS_ATOMIC_WRITTEN_PAGE
(
fio
->
·ge
))

1961  
Œue
;

1962 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
) &&

1963 
	`f2fs_is_checkpoš‹d_d©a
(
sbi
, 
fio
->
Şd_blkaddr
)))

1964  
Œue
;

1966  
çl£
;

1967 
	}
}

1969 
šlše
 
boŞ
 
	$Ãed_š¶aû_upd©e
(
f2fs_io_šfo
 *
fio
)

1971 
šode
 *šodğ
fio
->
·ge
->
m­pšg
->
ho¡
;

1973 ià(
	`f2fs_should_upd©e_ouÏû
(
šode
, 
fio
))

1974  
çl£
;

1976  
	`f2fs_should_upd©e_š¶aû
(
šode
, 
fio
);

1977 
	}
}

1979 
	$f2fs_do_wr™e_d©a_·ge
(
f2fs_io_šfo
 *
fio
)

1981 
·ge
 *·gğ
fio
->page;

1982 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1983 
dnode_of_d©a
 
dn
;

1984 
ex‹Á_šfo
 
ei
 = {0,0,0};

1985 
node_šfo
 
ni
;

1986 
boŞ
 
u_fÜû
 = 
çl£
;

1987 
”r
 = 0;

1989 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1990 ià(
	`Ãed_š¶aû_upd©e
(
fio
) &&

1991 
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
·ge
->
šdex
, &
ei
)) {

1992 
fio
->
Şd_blkaddr
 = 
ei
.
blk
 + 
·ge
->
šdex
 -ƒi.
fofs
;

1994 ià(!
	`f2fs_is_v®id_blkaddr
(
fio
->
sbi
, fio->
Şd_blkaddr
,

1995 
DATA_GENERIC_ENHANCE
))

1996  -
EFSCORRUPTED
;

1998 
u_fÜû
 = 
Œue
;

1999 
fio
->
Ãed_lock
 = 
LOCK_DONE
;

2000 
gÙ_™
;

2004 ià(
fio
->
Ãed_lock
 =ğ
LOCK_REQ
 && !
	`f2fs_Œylock_İ
(fio->
sbi
))

2005  -
EAGAIN
;

2007 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
·ge
->
šdex
, 
LOOKUP_NODE
);

2008 ià(
”r
)

2009 
out
;

2011 
fio
->
Şd_blkaddr
 = 
dn
.
d©a_blkaddr
;

2014 ià(
fio
->
Şd_blkaddr
 =ğ
NULL_ADDR
) {

2015 
	`CË¬PageU±od©e
(
·ge
);

2016 
	`ş—r_cŞd_d©a
(
·ge
);

2017 
out_wr™•age
;

2019 
gÙ_™
:

2020 ià(
	`__is_v®id_d©a_blkaddr
(
fio
->
Şd_blkaddr
) &&

2021 !
	`f2fs_is_v®id_blkaddr
(
fio
->
sbi
, fio->
Şd_blkaddr
,

2022 
DATA_GENERIC_ENHANCE
)) {

2023 
”r
 = -
EFSCORRUPTED
;

2024 
out_wr™•age
;

2030 ià(
u_fÜû
 ||

2031 (
	`__is_v®id_d©a_blkaddr
(
fio
->
Şd_blkaddr
) &&

2032 
	`Ãed_š¶aû_upd©e
(
fio
))) {

2033 
”r
 = 
	`’üy±_Úe_·ge
(
fio
);

2034 ià(
”r
)

2035 
out_wr™•age
;

2037 
	`£t_·ge_wr™eback
(
·ge
);

2038 
	`CË¬PageE¼Ü
(
·ge
);

2039 
	`f2fs_put_dnode
(&
dn
);

2040 ià(
fio
->
Ãed_lock
 =ğ
LOCK_REQ
)

2041 
	`f2fs_uÆock_İ
(
fio
->
sbi
);

2042 
”r
 = 
	`f2fs_š¶aû_wr™e_d©a
(
fio
);

2043 ià(
”r
) {

2044 ià(
	`f2fs_’üy±ed_fe
(
šode
))

2045 
	`fsüy±_fš®ize_bounû_·ge
(&
fio
->
’üy±ed_·ge
);

2046 ià(
	`PageWr™eback
(
·ge
))

2047 
	`’d_·ge_wr™eback
(
·ge
);

2049 
	`£t_šode_æag
(
šode
, 
FI_UPDATE_WRITE
);

2051 
	`Œaû_f2fs_do_wr™e_d©a_·ge
(
fio
->
·ge
, 
IPU
);

2052  
”r
;

2055 ià(
fio
->
Ãed_lock
 =ğ
LOCK_RETRY
) {

2056 ià(!
	`f2fs_Œylock_İ
(
fio
->
sbi
)) {

2057 
”r
 = -
EAGAIN
;

2058 
out_wr™•age
;

2060 
fio
->
Ãed_lock
 = 
LOCK_REQ
;

2063 
”r
 = 
	`f2fs_g‘_node_šfo
(
fio
->
sbi
, 
dn
.
nid
, &
ni
);

2064 ià(
”r
)

2065 
out_wr™•age
;

2067 
fio
->
v”siÚ
 = 
ni
.version;

2069 
”r
 = 
	`’üy±_Úe_·ge
(
fio
);

2070 ià(
”r
)

2071 
out_wr™•age
;

2073 
	`£t_·ge_wr™eback
(
·ge
);

2074 
	`CË¬PageE¼Ü
(
·ge
);

2077 
	`f2fs_ouÏû_wr™e_d©a
(&
dn
, 
fio
);

2078 
	`Œaû_f2fs_do_wr™e_d©a_·ge
(
·ge
, 
OPU
);

2079 
	`£t_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

2080 ià(
·ge
->
šdex
 == 0)

2081 
	`£t_šode_æag
(
šode
, 
FI_FIRST_BLOCK_WRITTEN
);

2082 
out_wr™•age
:

2083 
	`f2fs_put_dnode
(&
dn
);

2084 
out
:

2085 ià(
fio
->
Ãed_lock
 =ğ
LOCK_REQ
)

2086 
	`f2fs_uÆock_İ
(
fio
->
sbi
);

2087  
”r
;

2088 
	}
}

2090 
	$__wr™e_d©a_·ge
(
·ge
 *·ge, 
boŞ
 *
subm™‹d
,

2091 
bio
 **bio,

2092 
£ùÜ_t
 *
Ï¡_block
,

2093 
wr™eback_cÚŒŞ
 *
wbc
,

2094 
io¡©_ty³
 
io_ty³
)

2096 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

2097 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2098 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

2099 cÚ¡ 
pgoff_t
 
’d_šdex
 = ((è
i_size
)

2100 >> 
PAGE_SHIFT
;

2101 
loff_t
 
psize
 = (loff_t)(
·ge
->
šdex
 + 1è<< 
PAGE_SHIFT
;

2102 
off£t
 = 0;

2103 
boŞ
 
Ãed_b®ªû_fs
 = 
çl£
;

2104 
”r
 = 0;

2105 
f2fs_io_šfo
 
fio
 = {

2106 .
sbi
 = sbi,

2107 .
šo
 = 
šode
->
i_šo
,

2108 .
ty³
 = 
DATA
,

2109 .
İ
 = 
REQ_OP_WRITE
,

2110 .
İ_æags
 = 
	`wbc_to_wr™e_æags
(
wbc
),

2111 .
Şd_blkaddr
 = 
NULL_ADDR
,

2112 .
·ge
 =…age,

2113 .
’üy±ed_·ge
 = 
NULL
,

2114 .
subm™‹d
 = 
çl£
,

2115 .
Ãed_lock
 = 
LOCK_RETRY
,

2116 .
io_ty³
 = io_type,

2117 .
io_wbc
 = 
wbc
,

2118 .
bio
 = bio,

2119 .
Ï¡_block
 =†ast_block,

2122 
	`Œaû_f2fs_wr™•age
(
·ge
, 
DATA
);

2125 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

2126 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, -
EIO
);

2131 ià(
	`S_ISDIR
(
šode
->
i_mode
))

2132 
»dœty_out
;

2133 
out
;

2136 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

2137 
»dœty_out
;

2139 ià(
·ge
->
šdex
 < 
’d_šdex
 || 
	`f2fs_v”™y_š_´og»ss
(
šode
))

2140 
wr™e
;

2146 
off£t
 = 
i_size
 & (
PAGE_SIZE
 - 1);

2147 ià((
·ge
->
šdex
 >ğ
’d_šdex
 + 1è|| !
off£t
)

2148 
out
;

2150 
	`z”o_u£r_£gm’t
(
·ge
, 
off£t
, 
PAGE_SIZE
);

2151 
wr™e
:

2152 ià(
	`f2fs_is_drİ_ÿche
(
šode
))

2153 
out
;

2155 ià(
	`f2fs_is_vŞ©e_fe
(
šode
è&& (!
·ge
->
šdex
 ||

2156 (!
wbc
->
fÜ_»şaim
 &&

2157 
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
BASE_CHECK
))))

2158 
»dœty_out
;

2161 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

2162 
fio
.
Ãed_lock
 = 
LOCK_DONE
;

2163 
”r
 = 
	`f2fs_do_wr™e_d©a_·ge
(&
fio
);

2164 
dÚe
;

2167 ià(!
wbc
->
fÜ_»şaim
)

2168 
Ãed_b®ªû_fs
 = 
Œue
;

2169 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0))

2170 
»dœty_out
;

2172 
	`£t_šode_æag
(
šode
, 
FI_HOT_DATA
);

2174 
”r
 = -
EAGAIN
;

2175 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

2176 
”r
 = 
	`f2fs_wr™e_šlše_d©a
(
šode
, 
·ge
);

2177 ià(!
”r
)

2178 
out
;

2181 ià(
”r
 =ğ-
EAGAIN
) {

2182 
”r
 = 
	`f2fs_do_wr™e_d©a_·ge
(&
fio
);

2183 ià(
”r
 =ğ-
EAGAIN
) {

2184 
fio
.
Ãed_lock
 = 
LOCK_REQ
;

2185 
”r
 = 
	`f2fs_do_wr™e_d©a_·ge
(&
fio
);

2189 ià(
”r
) {

2190 
	`fe_£t_k“p_isize
(
šode
);

2192 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

2193 ià(
	`F2FS_I
(
šode
)->
Ï¡_disk_size
 < 
psize
)

2194 
	`F2FS_I
(
šode
)->
Ï¡_disk_size
 = 
psize
;

2195 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

2198 
dÚe
:

2199 ià(
”r
 &&ƒ¼ !ğ-
ENOENT
)

2200 
»dœty_out
;

2202 
out
:

2203 
	`šode_dec_dœty_·ges
(
šode
);

2204 ià(
”r
) {

2205 
	`CË¬PageU±od©e
(
·ge
);

2206 
	`ş—r_cŞd_d©a
(
·ge
);

2209 ià(
wbc
->
fÜ_»şaim
) {

2210 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
NULL
, 
·ge
, 0, 
DATA
);

2211 
	`ş—r_šode_æag
(
šode
, 
FI_HOT_DATA
);

2212 
	`f2fs_»move_dœty_šode
(
šode
);

2213 
subm™‹d
 = 
NULL
;

2216 
	`uÆock_·ge
(
·ge
);

2217 ià(!
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`IS_NOQUOTA
(inode) &&

2218 !
	`F2FS_I
(
šode
)->
ı_sk
) {

2219 
	`f2fs_subm™_u_bio
(
sbi
, 
bio
, 
·ge
);

2220 
	`f2fs_b®ªû_fs
(
sbi
, 
Ãed_b®ªû_fs
);

2223 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

2224 
	`f2fs_subm™_u_bio
(
sbi
, 
bio
, 
·ge
);

2225 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
DATA
);

2226 
subm™‹d
 = 
NULL
;

2229 ià(
subm™‹d
)

2230 *
subm™‹d
 = 
fio
.submitted;

2234 
»dœty_out
:

2235 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

2242 ià(!
”r
 || 
wbc
->
fÜ_»şaim
)

2243  
AOP_WRITEPAGE_ACTIVATE
;

2244 
	`uÆock_·ge
(
·ge
);

2245  
”r
;

2246 
	}
}

2248 
	$f2fs_wr™e_d©a_·ge
(
·ge
 *page,

2249 
wr™eback_cÚŒŞ
 *
wbc
)

2251  
	`__wr™e_d©a_·ge
(
·ge
, 
NULL
, NULL, NULL, 
wbc
, 
FS_DATA_IO
);

2252 
	}
}

2259 
	$f2fs_wr™e_ÿche_·ges
(
add»ss_¥aû
 *
m­pšg
,

2260 
wr™eback_cÚŒŞ
 *
wbc
,

2261 
io¡©_ty³
 
io_ty³
)

2263 
»t
 = 0;

2264 
dÚe
 = 0;

2265 
·gevec
 
pvec
;

2266 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_M_SB
(
m­pšg
);

2267 
bio
 *biØğ
NULL
;

2268 
£ùÜ_t
 
Ï¡_block
;

2269 
Ä_·ges
;

2270 
pgoff_t
 
	`unš™Ÿlized_v¬
(
wr™eback_šdex
);

2271 
pgoff_t
 
šdex
;

2272 
pgoff_t
 
’d
;

2273 
pgoff_t
 
dÚe_šdex
;

2274 
cyşed
;

2275 
¿nge_whŞe
 = 0;

2276 
xa_m¬k_t
 
g
;

2277 
nwr™‹n
 = 0;

2279 
	`·gevec_š™
(&
pvec
);

2281 ià(
	`g‘_dœty_·ges
(
m­pšg
->
ho¡
) <=

2282 
	`SM_I
(
	`F2FS_M_SB
(
m­pšg
))->
mš_hÙ_blocks
)

2283 
	`£t_šode_æag
(
m­pšg
->
ho¡
, 
FI_HOT_DATA
);

2285 
	`ş—r_šode_æag
(
m­pšg
->
ho¡
, 
FI_HOT_DATA
);

2287 ià(
wbc
->
¿nge_cyşic
) {

2288 
wr™eback_šdex
 = 
m­pšg
->writeback_index;

2289 
šdex
 = 
wr™eback_šdex
;

2290 ià(
šdex
 == 0)

2291 
cyşed
 = 1;

2293 
cyşed
 = 0;

2294 
’d
 = -1;

2296 
šdex
 = 
wbc
->
¿nge_¡¬t
 >> 
PAGE_SHIFT
;

2297 
’d
 = 
wbc
->
¿nge_’d
 >> 
PAGE_SHIFT
;

2298 ià(
wbc
->
¿nge_¡¬t
 =ğ0 && wbc->
¿nge_’d
 =ğ
LLONG_MAX
)

2299 
¿nge_whŞe
 = 1;

2300 
cyşed
 = 1;

2302 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 || wbc->
gged_wr™•ages
)

2303 
g
 = 
PAGECACHE_TAG_TOWRITE
;

2305 
g
 = 
PAGECACHE_TAG_DIRTY
;

2306 
»Œy
:

2307 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 || wbc->
gged_wr™•ages
)

2308 
	`g_·ges_fÜ_wr™eback
(
m­pšg
, 
šdex
, 
’d
);

2309 
dÚe_šdex
 = 
šdex
;

2310 !
dÚe
 && (
šdex
 <ğ
’d
)) {

2311 
i
;

2313 
Ä_·ges
 = 
	`·gevec_lookup_¿nge_g
(&
pvec
, 
m­pšg
, &
šdex
, 
’d
,

2314 
g
);

2315 ià(
Ä_·ges
 == 0)

2318 
i
 = 0; i < 
Ä_·ges
; i++) {

2319 
·ge
 *·gğ
pvec
.
·ges
[
i
];

2320 
boŞ
 
subm™‹d
 = 
çl£
;

2323 ià(
	`©omic_»ad
(&
sbi
->
wb_sync_»q
[
DATA
]) &&

2324 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
) {

2325 
dÚe
 = 1;

2329 
dÚe_šdex
 = 
·ge
->
šdex
;

2330 
»Œy_wr™e
:

2331 
	`lock_·ge
(
·ge
);

2333 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

2334 
cÚtšue_uÆock
:

2335 
	`uÆock_·ge
(
·ge
);

2339 ià(!
	`PageDœty
(
·ge
)) {

2341 
cÚtšue_uÆock
;

2344 ià(
	`PageWr™eback
(
·ge
)) {

2345 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_NONE
) {

2346 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
,

2347 
DATA
, 
Œue
,rue);

2348 
	`f2fs_subm™_u_bio
(
sbi
, &
bio
, 
·ge
);

2350 
cÚtšue_uÆock
;

2354 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

2355 
cÚtšue_uÆock
;

2357 
»t
 = 
	`__wr™e_d©a_·ge
(
·ge
, &
subm™‹d
, &
bio
,

2358 &
Ï¡_block
, 
wbc
, 
io_ty³
);

2359 ià(
	`uÆik–y
(
»t
)) {

2364 ià(
»t
 =ğ
AOP_WRITEPAGE_ACTIVATE
) {

2365 
	`uÆock_·ge
(
·ge
);

2366 
»t
 = 0;

2368 } ià(
»t
 =ğ-
EAGAIN
) {

2369 
»t
 = 0;

2370 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
) {

2371 
	`cÚd_»sched
();

2372 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
,

2373 
HZ
/50);

2374 
»Œy_wr™e
;

2378 
dÚe_šdex
 = 
·ge
->
šdex
 + 1;

2379 
dÚe
 = 1;

2381 } ià(
subm™‹d
) {

2382 
nwr™‹n
++;

2385 ià(--
wbc
->
Ä_to_wr™e
 <= 0 &&

2386 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
) {

2387 
dÚe
 = 1;

2391 
	`·gevec_»Ëa£
(&
pvec
);

2392 
	`cÚd_»sched
();

2395 ià(!
cyşed
 && !
dÚe
) {

2396 
cyşed
 = 1;

2397 
šdex
 = 0;

2398 
’d
 = 
wr™eback_šdex
 - 1;

2399 
»Œy
;

2401 ià(
wbc
->
¿nge_cyşic
 || (
¿nge_whŞe
 && wbc->
Ä_to_wr™e
 > 0))

2402 
m­pšg
->
wr™eback_šdex
 = 
dÚe_šdex
;

2404 ià(
nwr™‹n
)

2405 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
	`F2FS_M_SB
(
m­pšg
), m­pšg->
ho¡
,

2406 
NULL
, 0, 
DATA
);

2408 ià(
bio
)

2409 
	`__subm™_bio
(
sbi
, 
bio
, 
DATA
);

2411  
»t
;

2412 
	}
}

2414 
šlše
 
boŞ
 
	$__should_£rŸlize_io
(
šode
 *inode,

2415 
wr™eback_cÚŒŞ
 *
wbc
)

2417 ià(!
	`S_ISREG
(
šode
->
i_mode
))

2418  
çl£
;

2419 ià(
	`IS_NOQUOTA
(
šode
))

2420  
çl£
;

2422 ià(
	`F2FS_I
(
šode
)->
ı_sk
)

2423  
çl£
;

2424 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_ALL
)

2425  
Œue
;

2426 ià(
	`g‘_dœty_·ges
(
šode
è>ğ
	`SM_I
(
	`F2FS_I_SB
(šode))->
mš_£q_blocks
)

2427  
Œue
;

2428  
çl£
;

2429 
	}
}

2431 
	$__f2fs_wr™e_d©a_·ges
(
add»ss_¥aû
 *
m­pšg
,

2432 
wr™eback_cÚŒŞ
 *
wbc
,

2433 
io¡©_ty³
 
io_ty³
)

2435 
šode
 *šodğ
m­pšg
->
ho¡
;

2436 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2437 
blk_¶ug
 
¶ug
;

2438 
»t
;

2439 
boŞ
 
locked
 = 
çl£
;

2442 ià(!
m­pšg
->
a_İs
->
wr™•age
)

2446 ià(!
	`g‘_dœty_·ges
(
šode
è&& 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
)

2450 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

2451 
sk_wr™e
;

2453 ià((
	`S_ISDIR
(
šode
->
i_mode
è|| 
	`IS_NOQUOTA
(inode)) &&

2454 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
 &&

2455 
	`g‘_dœty_·ges
(
šode
è< 
	`Ä_·ges_to_sk
(
sbi
, 
DATA
) &&

2456 
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
DIRTY_DENTS
))

2457 
sk_wr™e
;

2460 ià(
	`is_šode_æag_£t
(
šode
, 
FI_DO_DEFRAG
))

2461 
sk_wr™e
;

2463 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
DATA
);

2466 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

2467 
	`©omic_šc
(&
sbi
->
wb_sync_»q
[
DATA
]);

2468 ià(
	`©omic_»ad
(&
sbi
->
wb_sync_»q
[
DATA
]))

2469 
sk_wr™e
;

2471 ià(
	`__should_£rŸlize_io
(
šode
, 
wbc
)) {

2472 
	`mu‹x_lock
(&
sbi
->
wr™•ages
);

2473 
locked
 = 
Œue
;

2476 
	`blk_¡¬t_¶ug
(&
¶ug
);

2477 
»t
 = 
	`f2fs_wr™e_ÿche_·ges
(
m­pšg
, 
wbc
, 
io_ty³
);

2478 
	`blk_fšish_¶ug
(&
¶ug
);

2480 ià(
locked
)

2481 
	`mu‹x_uÆock
(&
sbi
->
wr™•ages
);

2483 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

2484 
	`©omic_dec
(&
sbi
->
wb_sync_»q
[
DATA
]);

2490 
	`f2fs_»move_dœty_šode
(
šode
);

2491  
»t
;

2493 
sk_wr™e
:

2494 
wbc
->
·ges_sk³d
 +ğ
	`g‘_dœty_·ges
(
šode
);

2495 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
DATA
);

2497 
	}
}

2499 
	$f2fs_wr™e_d©a_·ges
(
add»ss_¥aû
 *
m­pšg
,

2500 
wr™eback_cÚŒŞ
 *
wbc
)

2502 
šode
 *šodğ
m­pšg
->
ho¡
;

2504  
	`__f2fs_wr™e_d©a_·ges
(
m­pšg
, 
wbc
,

2505 
	`F2FS_I
(
šode
)->
ı_sk
 =ğ
cu¼’t
 ?

2506 
FS_CP_DATA_IO
 : 
FS_DATA_IO
);

2507 
	}
}

2509 
	$f2fs_wr™e_çed
(
add»ss_¥aû
 *
m­pšg
, 
loff_t
 
to
)

2511 
šode
 *šodğ
m­pšg
->
ho¡
;

2512 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

2515 ià(
to
 > 
i_size
 && !
	`f2fs_v”™y_š_´og»ss
(
šode
)) {

2516 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

2517 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

2519 
	`Œunÿ‹_·geÿche
(
šode
, 
i_size
);

2520 ià(!
	`IS_NOQUOTA
(
šode
))

2521 
	`f2fs_Œunÿ‹_blocks
(
šode
, 
i_size
, 
Œue
);

2523 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

2524 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

2526 
	}
}

2528 
	$´•¬e_wr™e_begš
(
f2fs_sb_šfo
 *
sbi
,

2529 
·ge
 *·ge, 
loff_t
 
pos
, 
Ën
,

2530 
block_t
 *
blk_addr
, 
boŞ
 *
node_chªged
)

2532 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

2533 
pgoff_t
 
šdex
 = 
·ge
->index;

2534 
dnode_of_d©a
 
dn
;

2535 
·ge
 *
age
;

2536 
boŞ
 
locked
 = 
çl£
;

2537 
ex‹Á_šfo
 
ei
 = {0,0,0};

2538 
”r
 = 0;

2539 
æag
;

2545 ià(!
	`f2fs_has_šlše_d©a
(
šode
è&& 
Ën
 =ğ
PAGE_SIZE
 &&

2546 !
	`is_šode_æag_£t
(
šode
, 
FI_NO_PREALLOC
) &&

2547 !
	`f2fs_v”™y_š_´og»ss
(
šode
))

2551 ià(
	`f2fs_has_šlše_d©a
(
šode
è&& 
pos
 + 
Ën
 > 
	`MAX_INLINE_DATA
(inode))

2552 
æag
 = 
F2FS_GET_BLOCK_DEFAULT
;

2554 
æag
 = 
F2FS_GET_BLOCK_PRE_AIO
;

2556 ià(
	`f2fs_has_šlše_d©a
(
šode
) ||

2557 (
pos
 & 
PAGE_MASK
è>ğ
	`i_size_»ad
(
šode
)) {

2558 
	`__do_m­_lock
(
sbi
, 
æag
, 
Œue
);

2559 
locked
 = 
Œue
;

2561 
»¡¬t
:

2563 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

2564 ià(
	`IS_ERR
(
age
)) {

2565 
”r
 = 
	`PTR_ERR
(
age
);

2566 
uÆock_out
;

2569 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
age
, ipage, 0);

2571 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

2572 ià(
pos
 + 
Ën
 <ğ
	`MAX_INLINE_DATA
(
šode
)) {

2573 
	`f2fs_do_»ad_šlše_d©a
(
·ge
, 
age
);

2574 
	`£t_šode_æag
(
šode
, 
FI_DATA_EXIST
);

2575 ià(
šode
->
i_Æšk
)

2576 
	`£t_šlše_node
(
age
);

2578 
”r
 = 
	`f2fs_cÚv”t_šlše_·ge
(&
dn
, 
·ge
);

2579 ià(
”r
)

2580 
out
;

2581 ià(
dn
.
d©a_blkaddr
 =ğ
NULL_ADDR
)

2582 
”r
 = 
	`f2fs_g‘_block
(&
dn
, 
šdex
);

2584 } ià(
locked
) {

2585 
”r
 = 
	`f2fs_g‘_block
(&
dn
, 
šdex
);

2587 ià(
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
šdex
, &
ei
)) {

2588 
dn
.
d©a_blkaddr
 = 
ei
.
blk
 + 
šdex
 -ƒi.
fofs
;

2591 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
šdex
, 
LOOKUP_NODE
);

2592 ià(
”r
 || 
dn
.
d©a_blkaddr
 =ğ
NULL_ADDR
) {

2593 
	`f2fs_put_dnode
(&
dn
);

2594 
	`__do_m­_lock
(
sbi
, 
F2FS_GET_BLOCK_PRE_AIO
,

2595 
Œue
);

2596 
	`WARN_ON
(
æag
 !ğ
F2FS_GET_BLOCK_PRE_AIO
);

2597 
locked
 = 
Œue
;

2598 
»¡¬t
;

2604 *
blk_addr
 = 
dn
.
d©a_blkaddr
;

2605 *
node_chªged
 = 
dn
.node_changed;

2606 
out
:

2607 
	`f2fs_put_dnode
(&
dn
);

2608 
uÆock_out
:

2609 ià(
locked
)

2610 
	`__do_m­_lock
(
sbi
, 
æag
, 
çl£
);

2611  
”r
;

2612 
	}
}

2614 
	$f2fs_wr™e_begš
(
fe
 *fe, 
add»ss_¥aû
 *
m­pšg
,

2615 
loff_t
 
pos
, 
Ën
, 
æags
,

2616 
·ge
 **
·g•
, **
fsd©a
)

2618 
šode
 *šodğ
m­pšg
->
ho¡
;

2619 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2620 
·ge
 *·gğ
NULL
;

2621 
pgoff_t
 
šdex
 = ((è
pos
è>> 
PAGE_SHIFT
;

2622 
boŞ
 
Ãed_b®ªû
 = 
çl£
, 
drİ_©omic
 = false;

2623 
block_t
 
blkaddr
 = 
NULL_ADDR
;

2624 
”r
 = 0;

2626 
	`Œaû_f2fs_wr™e_begš
(
šode
, 
pos
, 
Ën
, 
æags
);

2628 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
)) {

2629 
”r
 = -
ENOSPC
;

2630 
ç
;

2633 ià((
	`f2fs_is_©omic_fe
(
šode
) &&

2634 !
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
INMEM_PAGES
)) ||

2635 
	`is_šode_æag_£t
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
)) {

2636 
”r
 = -
ENOMEM
;

2637 
drİ_©omic
 = 
Œue
;

2638 
ç
;

2646 ià(
šdex
 != 0) {

2647 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

2648 ià(
”r
)

2649 
ç
;

2651 
»³©
:

2656 
·ge
 = 
	`f2fs_·geÿche_g‘_·ge
(
m­pšg
, 
šdex
,

2657 
FGP_LOCK
 | 
FGP_WRITE
 | 
FGP_CREAT
, 
GFP_NOFS
);

2658 ià(!
·ge
) {

2659 
”r
 = -
ENOMEM
;

2660 
ç
;

2663 *
·g•
 = 
·ge
;

2665 
”r
 = 
	`´•¬e_wr™e_begš
(
sbi
, 
·ge
, 
pos
, 
Ën
,

2666 &
blkaddr
, &
Ãed_b®ªû
);

2667 ià(
”r
)

2668 
ç
;

2670 ià(
Ãed_b®ªû
 && !
	`IS_NOQUOTA
(
šode
) &&

2671 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0)) {

2672 
	`uÆock_·ge
(
·ge
);

2673 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

2674 
	`lock_·ge
(
·ge
);

2675 ià(
·ge
->
m­pšg
 != mapping) {

2677 
	`f2fs_put_·ge
(
·ge
, 1);

2678 
»³©
;

2682 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
çl£
, 
Œue
);

2684 ià(
Ën
 =ğ
PAGE_SIZE
 || 
	`PageU±od©e
(
·ge
))

2687 ià(!(
pos
 & (
PAGE_SIZE
 - 1)è&& (po + 
Ën
è>ğ
	`i_size_»ad
(
šode
) &&

2688 !
	`f2fs_v”™y_š_´og»ss
(
šode
)) {

2689 
	`z”o_u£r_£gm’t
(
·ge
, 
Ën
, 
PAGE_SIZE
);

2693 ià(
blkaddr
 =ğ
NEW_ADDR
) {

2694 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

2695 
	`S‘PageU±od©e
(
·ge
);

2697 ià(!
	`f2fs_is_v®id_blkaddr
(
sbi
, 
blkaddr
,

2698 
DATA_GENERIC_ENHANCE_READ
)) {

2699 
”r
 = -
EFSCORRUPTED
;

2700 
ç
;

2702 
”r
 = 
	`f2fs_subm™_·ge_»ad
(
šode
, 
·ge
, 
blkaddr
);

2703 ià(
”r
)

2704 
ç
;

2706 
	`lock_·ge
(
·ge
);

2707 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

2708 
	`f2fs_put_·ge
(
·ge
, 1);

2709 
»³©
;

2711 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

2712 
”r
 = -
EIO
;

2713 
ç
;

2718 
ç
:

2719 
	`f2fs_put_·ge
(
·ge
, 1);

2720 
	`f2fs_wr™e_çed
(
m­pšg
, 
pos
 + 
Ën
);

2721 ià(
drİ_©omic
)

2722 
	`f2fs_drİ_šmem_·ges_®l
(
sbi
, 
çl£
);

2723  
”r
;

2724 
	}
}

2726 
	$f2fs_wr™e_’d
(
fe
 *file,

2727 
add»ss_¥aû
 *
m­pšg
,

2728 
loff_t
 
pos
, 
Ën
, 
cİ›d
,

2729 
·ge
 *·ge, *
fsd©a
)

2731 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

2733 
	`Œaû_f2fs_wr™e_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
);

2740 ià(!
	`PageU±od©e
(
·ge
)) {

2741 ià(
	`uÆik–y
(
cİ›d
 !ğ
Ën
))

2742 
cİ›d
 = 0;

2744 
	`S‘PageU±od©e
(
·ge
);

2746 ià(!
cİ›d
)

2747 
uÆock_out
;

2749 
	`£t_·ge_dœty
(
·ge
);

2751 ià(
pos
 + 
cİ›d
 > 
	`i_size_»ad
(
šode
) &&

2752 !
	`f2fs_v”™y_š_´og»ss
(
šode
))

2753 
	`f2fs_i_size_wr™e
(
šode
, 
pos
 + 
cİ›d
);

2754 
uÆock_out
:

2755 
	`f2fs_put_·ge
(
·ge
, 1);

2756 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

2757  
cİ›d
;

2758 
	}
}

2760 
	$check_dœeù_IO
(
šode
 *šode, 
iov_™”
 *
™”
,

2761 
loff_t
 
off£t
)

2763 
i_blkb™s
 = 
	`READ_ONCE
(
šode
->i_blkbits);

2764 
blkb™s
 = 
i_blkb™s
;

2765 
blocksize_mask
 = (1 << 
blkb™s
) - 1;

2766 
®ign
 = 
off£t
 | 
	`iov_™”_®ignm’t
(
™”
);

2767 
block_deviû
 *
bdev
 = 
šode
->
i_sb
->
s_bdev
;

2769 ià(
®ign
 & 
blocksize_mask
) {

2770 ià(
bdev
)

2771 
blkb™s
 = 
	`blksize_b™s
(
	`bdev_logiÿl_block_size
(
bdev
));

2772 
blocksize_mask
 = (1 << 
blkb™s
) - 1;

2773 ià(
®ign
 & 
blocksize_mask
)

2774  -
EINVAL
;

2778 
	}
}

2780 
	$f2fs_dio_’d_io
(
bio
 *bio)

2782 
f2fs_´iv©e_dio
 *
dio
 = 
bio
->
bi_´iv©e
;

2784 
	`dec_·ge_couÁ
(
	`F2FS_I_SB
(
dio
->
šode
),

2785 
dio
->
wr™e
 ? 
F2FS_DIO_WRITE
 : 
F2FS_DIO_READ
);

2787 
bio
->
bi_´iv©e
 = 
dio
->
Üig_´iv©e
;

2788 
bio
->
bi_’d_io
 = 
dio
->
Üig_’d_io
;

2790 
	`kvä“
(
dio
);

2792 
	`bio_’dio
(
bio
);

2793 
	}
}

2795 
	$f2fs_dio_subm™_bio
(
bio
 *bio, 
šode
 *inode,

2796 
loff_t
 
fe_off£t
)

2798 
f2fs_´iv©e_dio
 *
dio
;

2799 
boŞ
 
wr™e
 = (
	`bio_İ
(
bio
è=ğ
REQ_OP_WRITE
);

2801 
dio
 = 
	`f2fs_kz®loc
(
	`F2FS_I_SB
(
šode
),

2802 (
f2fs_´iv©e_dio
), 
GFP_NOFS
);

2803 ià(!
dio
)

2804 
out
;

2806 
dio
->
šode
 = inode;

2807 
dio
->
Üig_’d_io
 = 
bio
->
bi_’d_io
;

2808 
dio
->
Üig_´iv©e
 = 
bio
->
bi_´iv©e
;

2809 
dio
->
wr™e
 = write;

2811 
bio
->
bi_’d_io
 = 
f2fs_dio_’d_io
;

2812 
bio
->
bi_´iv©e
 = 
dio
;

2814 
	`šc_·ge_couÁ
(
	`F2FS_I_SB
(
šode
),

2815 
wr™e
 ? 
F2FS_DIO_WRITE
 : 
F2FS_DIO_READ
);

2817 
	`subm™_bio
(
bio
);

2819 
out
:

2820 
bio
->
bi_¡©us
 = 
BLK_STS_IOERR
;

2821 
	`bio_’dio
(
bio
);

2822 
	}
}

2824 
ssize_t
 
	$f2fs_dœeù_IO
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

2826 
add»ss_¥aû
 *
m­pšg
 = 
iocb
->
ki_fp
->
f_m­pšg
;

2827 
šode
 *šodğ
m­pšg
->
ho¡
;

2828 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2829 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

2830 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

2831 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

2832 
rw
 = 
	`iov_™”_rw
(
™”
);

2833 
”r
;

2834 
rw_hšt
 
hšt
 = 
iocb
->
ki_hšt
;

2835 
whšt_mode
 = 
	`F2FS_OPTION
(
sbi
).whint_mode;

2836 
boŞ
 
do_İu
;

2838 
”r
 = 
	`check_dœeù_IO
(
šode
, 
™”
, 
off£t
);

2839 ià(
”r
)

2840  
”r
 < 0 ?ƒrr : 0;

2842 ià(
	`f2fs_fÜû_bufã»d_io
(
šode
, 
iocb
, 
™”
))

2845 
do_İu
 = 
	`®low_ouÏû_dio
(
šode
, 
iocb
, 
™”
);

2847 
	`Œaû_f2fs_dœeù_IO_’‹r
(
šode
, 
off£t
, 
couÁ
, 
rw
);

2849 ià(
rw
 =ğ
WRITE
 && 
whšt_mode
 =ğ
WHINT_MODE_OFF
)

2850 
iocb
->
ki_hšt
 = 
WRITE_LIFE_NOT_SET
;

2852 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) {

2853 ià(!
	`down_»ad_Œylock
(&
fi
->
i_gc_rw£m
[
rw
])) {

2854 
iocb
->
ki_hšt
 = 
hšt
;

2855 
”r
 = -
EAGAIN
;

2856 
out
;

2858 ià(
do_İu
 && !
	`down_»ad_Œylock
(&
fi
->
i_gc_rw£m
[
READ
])) {

2859 
	`up_»ad
(&
fi
->
i_gc_rw£m
[
rw
]);

2860 
iocb
->
ki_hšt
 = 
hšt
;

2861 
”r
 = -
EAGAIN
;

2862 
out
;

2865 
	`down_»ad
(&
fi
->
i_gc_rw£m
[
rw
]);

2866 ià(
do_İu
)

2867 
	`down_»ad
(&
fi
->
i_gc_rw£m
[
READ
]);

2870 
”r
 = 
	`__blockdev_dœeù_IO
(
iocb
, 
šode
, inode->
i_sb
->
s_bdev
,

2871 
™”
, 
rw
 =ğ
WRITE
 ? 
g‘_d©a_block_dio_wr™e
 :

2872 
g‘_d©a_block_dio
, 
NULL
, 
f2fs_dio_subm™_bio
,

2873 
DIO_LOCKING
 | 
DIO_SKIP_HOLES
);

2875 ià(
do_İu
)

2876 
	`up_»ad
(&
fi
->
i_gc_rw£m
[
READ
]);

2878 
	`up_»ad
(&
fi
->
i_gc_rw£m
[
rw
]);

2880 ià(
rw
 =ğ
WRITE
) {

2881 ià(
whšt_mode
 =ğ
WHINT_MODE_OFF
)

2882 
iocb
->
ki_hšt
 = 
hšt
;

2883 ià(
”r
 > 0) {

2884 
	`f2fs_upd©e_io¡©
(
	`F2FS_I_SB
(
šode
), 
APP_DIRECT_IO
,

2885 
”r
);

2886 ià(!
do_İu
)

2887 
	`£t_šode_æag
(
šode
, 
FI_UPDATE_WRITE
);

2888 } ià(
”r
 < 0) {

2889 
	`f2fs_wr™e_çed
(
m­pšg
, 
off£t
 + 
couÁ
);

2893 
out
:

2894 
	`Œaû_f2fs_dœeù_IO_ex™
(
šode
, 
off£t
, 
couÁ
, 
rw
, 
”r
);

2896  
”r
;

2897 
	}
}

2899 
	$f2fs_šv®id©e_·ge
(
·ge
 *·ge, 
off£t
,

2900 
Ëngth
)

2902 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

2903 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2905 ià(
šode
->
i_šo
 >ğ
	`F2FS_ROOT_INO
(
sbi
) &&

2906 (
off£t
 % 
PAGE_SIZE
 || 
Ëngth
 != PAGE_SIZE))

2909 ià(
	`PageDœty
(
·ge
)) {

2910 ià(
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
)) {

2911 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_META
);

2912 } ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
)) {

2913 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_NODES
);

2915 
	`šode_dec_dœty_·ges
(
šode
);

2916 
	`f2fs_»move_dœty_šode
(
šode
);

2920 
	`ş—r_cŞd_d©a
(
·ge
);

2922 ià(
	`IS_ATOMIC_WRITTEN_PAGE
(
·ge
))

2923  
	`f2fs_drİ_šmem_·ge
(
šode
, 
·ge
);

2925 
	`f2fs_ş—r_·ge_´iv©e
(
·ge
);

2926 
	}
}

2928 
	$f2fs_»Ëa£_·ge
(
·ge
 *·ge, 
gå_t
 
wa™
)

2931 ià(
	`PageDœty
(
·ge
))

2935 ià(
	`IS_ATOMIC_WRITTEN_PAGE
(
·ge
))

2938 
	`ş—r_cŞd_d©a
(
·ge
);

2939 
	`f2fs_ş—r_·ge_´iv©e
(
·ge
);

2941 
	}
}

2943 
	$f2fs_£t_d©a_·ge_dœty
(
·ge
 *page)

2945 
šode
 *šodğ
	`·ge_fe_m­pšg
(
·ge
)->
ho¡
;

2947 
	`Œaû_f2fs_£t_·ge_dœty
(
·ge
, 
DATA
);

2949 ià(!
	`PageU±od©e
(
·ge
))

2950 
	`S‘PageU±od©e
(
·ge
);

2951 ià(
	`PageSw­Cache
(
·ge
))

2952  
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

2954 ià(
	`f2fs_is_©omic_fe
(
šode
è&& !
	`f2fs_is_comm™_©omic_wr™e
(inode)) {

2955 ià(!
	`IS_ATOMIC_WRITTEN_PAGE
(
·ge
)) {

2956 
	`f2fs_»gi¡”_šmem_·ge
(
šode
, 
·ge
);

2966 ià(!
	`PageDœty
(
·ge
)) {

2967 
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

2968 
	`f2fs_upd©e_dœty_·ge
(
šode
, 
·ge
);

2972 
	}
}

2974 
£ùÜ_t
 
	$f2fs_bm­
(
add»ss_¥aû
 *
m­pšg
, 
£ùÜ_t
 
block
)

2976 
šode
 *šodğ
m­pšg
->
ho¡
;

2978 ià(
	`f2fs_has_šlše_d©a
(
šode
))

2982 ià(
	`m­pšg_gged
(
m­pšg
, 
PAGECACHE_TAG_DIRTY
))

2983 
	`fem­_wr™e_ªd_wa™
(
m­pšg
);

2985  
	`g’”ic_block_bm­
(
m­pšg
, 
block
, 
g‘_d©a_block_bm­
);

2986 
	}
}

2988 #ifdeà
CONFIG_MIGRATION


2989 
	~<lšux/mig¿‹.h
>

2991 
	$f2fs_mig¿‹_·ge
(
add»ss_¥aû
 *
m­pšg
,

2992 
·ge
 *
Ãw·ge
, ·g*·ge, 
mig¿‹_mode
 
mode
)

2994 
rc
, 
exŒa_couÁ
;

2995 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
m­pšg
->
ho¡
);

2996 
boŞ
 
©omic_wr™‹n
 = 
	`IS_ATOMIC_WRITTEN_PAGE
(
·ge
);

2998 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

3001 ià(
©omic_wr™‹n
) {

3002 ià(
mode
 !ğ
MIGRATE_SYNC
)

3003  -
EBUSY
;

3004 ià(!
	`mu‹x_Œylock
(&
fi
->
šmem_lock
))

3005  -
EAGAIN
;

3009 
exŒa_couÁ
 = 
©omic_wr™‹n
 ? 1 : 0;

3010 
rc
 = 
	`mig¿‹_·ge_move_m­pšg
(
m­pšg
, 
Ãw·ge
,

3011 
·ge
, 
exŒa_couÁ
);

3012 ià(
rc
 !ğ
MIGRATEPAGE_SUCCESS
) {

3013 ià(
©omic_wr™‹n
)

3014 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

3015  
rc
;

3018 ià(
©omic_wr™‹n
) {

3019 
šmem_·ges
 *
cur
;

3020 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
fi
->
šmem_·ges
, 
li¡
)

3021 ià(
cur
->
·ge
 ==…age) {

3022 
cur
->
·ge
 = 
Ãw·ge
;

3025 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

3026 
	`put_·ge
(
·ge
);

3027 
	`g‘_·ge
(
Ãw·ge
);

3030 ià(
	`PagePriv©e
(
·ge
)) {

3031 
	`f2fs_£t_·ge_´iv©e
(
Ãw·ge
, 
	`·ge_´iv©e
(
·ge
));

3032 
	`f2fs_ş—r_·ge_´iv©e
(
·ge
);

3035 ià(
mode
 !ğ
MIGRATE_SYNC_NO_COPY
)

3036 
	`mig¿‹_·ge_cİy
(
Ãw·ge
, 
·ge
);

3038 
	`mig¿‹_·ge_¡©es
(
Ãw·ge
, 
·ge
);

3040  
MIGRATEPAGE_SUCCESS
;

3041 
	}
}

3044 #ifdeà
CONFIG_SWAP


3046 
	$check_sw­_aùiv©e
(
fe
 *
sw­_fe
, 
max
)

3048 
add»ss_¥aû
 *
m­pšg
 = 
sw­_fe
->
f_m­pšg
;

3049 
šode
 *šodğ
m­pšg
->
ho¡
;

3050 
blocks_³r_·ge
;

3051 
·ge_no
;

3052 
blkb™s
;

3053 
£ùÜ_t
 
´obe_block
;

3054 
£ùÜ_t
 
Ï¡_block
;

3055 
£ùÜ_t
 
lowe¡_block
 = -1;

3056 
£ùÜ_t
 
highe¡_block
 = 0;

3058 
blkb™s
 = 
šode
->
i_blkb™s
;

3059 
blocks_³r_·ge
 = 
PAGE_SIZE
 >> 
blkb™s
;

3065 
´obe_block
 = 0;

3066 
·ge_no
 = 0;

3067 
Ï¡_block
 = 
	`i_size_»ad
(
šode
è>> 
blkb™s
;

3068 (
´obe_block
 + 
blocks_³r_·ge
è<ğ
Ï¡_block
 && 
·ge_no
 < 
max
) {

3069 
block_š_·ge
;

3070 
£ùÜ_t
 
fœ¡_block
;

3072 
	`cÚd_»sched
();

3074 
fœ¡_block
 = 
	`bm­
(
šode
, 
´obe_block
);

3075 ià(
fœ¡_block
 == 0)

3076 
bad_bm­
;

3081 ià(
fœ¡_block
 & (
blocks_³r_·ge
 - 1)) {

3082 
´obe_block
++;

3083 
»´obe
;

3086 
block_š_·ge
 = 1; block_š_·g< 
blocks_³r_·ge
;

3087 
block_š_·ge
++) {

3088 
£ùÜ_t
 
block
;

3090 
block
 = 
	`bm­
(
šode
, 
´obe_block
 + 
block_š_·ge
);

3091 ià(
block
 == 0)

3092 
bad_bm­
;

3093 ià(
block
 !ğ
fœ¡_block
 + 
block_š_·ge
) {

3095 
´obe_block
++;

3096 
»´obe
;

3100 
fœ¡_block
 >>ğ(
PAGE_SHIFT
 - 
blkb™s
);

3101 ià(
·ge_no
) {

3102 ià(
fœ¡_block
 < 
lowe¡_block
)

3103 
lowe¡_block
 = 
fœ¡_block
;

3104 ià(
fœ¡_block
 > 
highe¡_block
)

3105 
highe¡_block
 = 
fœ¡_block
;

3108 
·ge_no
++;

3109 
´obe_block
 +ğ
blocks_³r_·ge
;

3110 
»´obe
:

3115 
bad_bm­
:

3116 
	`´_”r
("swapon: swapfile has holes\n");

3117  -
EINVAL
;

3118 
	}
}

3120 
	$f2fs_sw­_aùiv©e
(
sw­_šfo_¡ruù
 *
sis
, 
fe
 *file,

3121 
£ùÜ_t
 *
¥ª
)

3123 
šode
 *šodğ
	`fe_šode
(
fe
);

3124 
»t
;

3126 ià(!
	`S_ISREG
(
šode
->
i_mode
))

3127  -
EINVAL
;

3129 ià(
	`f2fs_»adÚly
(
	`F2FS_I_SB
(
šode
)->
sb
))

3130  -
EROFS
;

3132 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

3133 ià(
»t
)

3134  
»t
;

3136 
»t
 = 
	`check_sw­_aùiv©e
(
fe
, 
sis
->
max
);

3137 ià(
»t
)

3138  
»t
;

3140 
	`£t_šode_æag
(
šode
, 
FI_PIN_FILE
);

3141 
	`f2fs_´eÿche_ex‹Ás
(
šode
);

3142 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

3144 
	}
}

3146 
	$f2fs_sw­_d—ùiv©e
(
fe
 *file)

3148 
šode
 *šodğ
	`fe_šode
(
fe
);

3150 
	`ş—r_šode_æag
(
šode
, 
FI_PIN_FILE
);

3151 
	}
}

3153 
	$f2fs_sw­_aùiv©e
(
sw­_šfo_¡ruù
 *
sis
, 
fe
 *file,

3154 
£ùÜ_t
 *
¥ª
)

3156  -
EOPNOTSUPP
;

3157 
	}
}

3159 
	$f2fs_sw­_d—ùiv©e
(
fe
 *file)

3161 
	}
}

3164 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gf2fs_dblock_aİs
 = {

3165 .
»ad·ge
 = 
f2fs_»ad_d©a_·ge
,

3166 .
	g»ad·ges
 = 
f2fs_»ad_d©a_·ges
,

3167 .
	gwr™•age
 = 
f2fs_wr™e_d©a_·ge
,

3168 .
	gwr™•ages
 = 
f2fs_wr™e_d©a_·ges
,

3169 .
	gwr™e_begš
 = 
f2fs_wr™e_begš
,

3170 .
	gwr™e_’d
 = 
f2fs_wr™e_’d
,

3171 .
	g£t_·ge_dœty
 = 
f2fs_£t_d©a_·ge_dœty
,

3172 .
	gšv®id©•age
 = 
f2fs_šv®id©e_·ge
,

3173 .
	g»Ëa£·ge
 = 
f2fs_»Ëa£_·ge
,

3174 .
	gdœeù_IO
 = 
f2fs_dœeù_IO
,

3175 .
	gbm­
 = 
f2fs_bm­
,

3176 .
	gsw­_aùiv©e
 = 
f2fs_sw­_aùiv©e
,

3177 .
	gsw­_d—ùiv©e
 = 
f2fs_sw­_d—ùiv©e
,

3178 #ifdeà
CONFIG_MIGRATION


3179 .
	gmig¿‹·ge
 = 
f2fs_mig¿‹_·ge
,

3183 
	$f2fs_ş—r_·ge_ÿche_dœty_g
(
·ge
 *page)

3185 
add»ss_¥aû
 *
m­pšg
 = 
	`·ge_m­pšg
(
·ge
);

3186 
æags
;

3188 
	`xa_lock_œq§ve
(&
m­pšg
->
i_·ges
, 
æags
);

3189 
	`__xa_ş—r_m¬k
(&
m­pšg
->
i_·ges
, 
	`·ge_šdex
(
·ge
),

3190 
PAGECACHE_TAG_DIRTY
);

3191 
	`xa_uÆock_œq»¡Üe
(&
m­pšg
->
i_·ges
, 
æags
);

3192 
	}
}

3194 
__š™
 
	$f2fs_š™_po¡_»ad_´oûssšg
()

3196 
bio_po¡_»ad_ùx_ÿche
 =

3197 
	`kmem_ÿche_ü—‹
("f2fs_bio_post_read_ctx",

3198 (
bio_po¡_»ad_ùx
), 0, 0, 
NULL
);

3199 ià(!
bio_po¡_»ad_ùx_ÿche
)

3200 
ç
;

3201 
bio_po¡_»ad_ùx_poŞ
 =

3202 
	`mempoŞ_ü—‹_¦ab_poŞ
(
NUM_PREALLOC_POST_READ_CTXS
,

3203 
bio_po¡_»ad_ùx_ÿche
);

3204 ià(!
bio_po¡_»ad_ùx_poŞ
)

3205 
ç_ä“_ÿche
;

3208 
ç_ä“_ÿche
:

3209 
	`kmem_ÿche_de¡roy
(
bio_po¡_»ad_ùx_ÿche
);

3210 
ç
:

3211  -
ENOMEM
;

3212 
	}
}

3214 
__ex™
 
	$f2fs_de¡roy_po¡_»ad_´oûssšg
()

3216 
	`mempoŞ_de¡roy
(
bio_po¡_»ad_ùx_poŞ
);

3217 
	`kmem_ÿche_de¡roy
(
bio_po¡_»ad_ùx_ÿche
);

3218 
	}
}

	@debug.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/backšg-dev.h
>

13 
	~<lšux/f2fs_fs.h
>

14 
	~<lšux/blkdev.h
>

15 
	~<lšux/debugfs.h
>

16 
	~<lšux/£q_fe.h
>

18 
	~"f2fs.h
"

19 
	~"node.h
"

20 
	~"£gm’t.h
"

21 
	~"gc.h
"

23 
LIST_HEAD
(
f2fs_¡©_li¡
);

24 
d’Œy
 *
	gf2fs_debugfs_roÙ
;

25 
DEFINE_MUTEX
(
f2fs_¡©_mu‹x
);

27 
	$upd©e_g’”®_¡©us
(
f2fs_sb_šfo
 *
sbi
)

29 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

30 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

31 
i
;

34 
si
->
maš_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_maš
);

35 
si
->
maš_¬—_£ùiÚs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£ùiÚ_couÁ
);

36 
si
->
maš_¬—_zÚes
 = si->
maš_¬—_£ùiÚs
 /

37 
	`Ë32_to_ıu
(
¿w_su³r
->
£cs_³r_zÚe
);

40 
si
->
h™_Ïrge¡
 = 
	`©omic64_»ad
(&
sbi
->
»ad_h™_Ïrge¡
);

41 
si
->
h™_ÿched
 = 
	`©omic64_»ad
(&
sbi
->
»ad_h™_ÿched
);

42 
si
->
h™_rbŒ“
 = 
	`©omic64_»ad
(&
sbi
->
»ad_h™_rbŒ“
);

43 
si
->
h™_tÙ®
 = si->
h™_Ïrge¡
 + si->
h™_ÿched
 + si->
h™_rbŒ“
;

44 
si
->
tÙ®_ext
 = 
	`©omic64_»ad
(&
sbi
->
tÙ®_h™_ext
);

45 
si
->
ext_Œ“
 = 
	`©omic_»ad
(&
sbi
->
tÙ®_ext_Œ“
);

46 
si
->
zomb›_Œ“
 = 
	`©omic_»ad
(&
sbi
->
tÙ®_zomb›_Œ“
);

47 
si
->
ext_node
 = 
	`©omic_»ad
(&
sbi
->
tÙ®_ext_node
);

48 
si
->
ndœty_node
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
);

49 
si
->
ndœty_d’t
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
);

50 
si
->
ndœty_m‘a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
);

51 
si
->
ndœty_d©a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DATA
);

52 
si
->
ndœty_qd©a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_QDATA
);

53 
si
->
ndœty_im‘a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
);

54 
si
->
ndœty_dœs
 = 
sbi
->
ndœty_šode
[
DIR_INODE
];

55 
si
->
ndœty_fes
 = 
sbi
->
ndœty_šode
[
FILE_INODE
];

56 
si
->
nquÙa_fes
 = 
sbi
->nquota_files;

57 
si
->
ndœty_®l
 = 
sbi
->
ndœty_šode
[
DIRTY_META
];

58 
si
->
šmem_·ges
 = 
	`g‘_·ges
(
sbi
, 
F2FS_INMEM_PAGES
);

59 
si
->
aw_út
 = 
	`©omic_»ad
(&
sbi
->aw_cnt);

60 
si
->
vw_út
 = 
	`©omic_»ad
(&
sbi
->vw_cnt);

61 
si
->
max_aw_út
 = 
	`©omic_»ad
(&
sbi
->max_aw_cnt);

62 
si
->
max_vw_út
 = 
	`©omic_»ad
(&
sbi
->max_vw_cnt);

63 
si
->
Ä_dio_»ad
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIO_READ
);

64 
si
->
Ä_dio_wr™e
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIO_WRITE
);

65 
si
->
Ä_wb_ı_d©a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_WB_CP_DATA
);

66 
si
->
Ä_wb_d©a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_WB_DATA
);

67 
si
->
Ä_rd_d©a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_RD_DATA
);

68 
si
->
Ä_rd_node
 = 
	`g‘_·ges
(
sbi
, 
F2FS_RD_NODE
);

69 
si
->
Ä_rd_m‘a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_RD_META
);

70 ià(
	`SM_I
(
sbi
)->
fcc_šfo
) {

71 
si
->
Ä_æushed
 =

72 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
fcc_šfo
->
issued_æush
);

73 
si
->
Ä_æushšg
 =

74 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
fcc_šfo
->
queued_æush
);

75 
si
->
æush_li¡_em±y
 =

76 
	`Îi¡_em±y
(&
	`SM_I
(
sbi
)->
fcc_šfo
->
issue_li¡
);

78 ià(
	`SM_I
(
sbi
)->
dcc_šfo
) {

79 
si
->
Ä_disÿrded
 =

80 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
issued_disÿrd
);

81 
si
->
Ä_disÿrdšg
 =

82 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
queued_disÿrd
);

83 
si
->
Ä_disÿrd_cmd
 =

84 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
disÿrd_cmd_út
);

85 
si
->
undisÿrd_blks
 = 
	`SM_I
(
sbi
)->
dcc_šfo
->undiscard_blks;

87 
si
->
tÙ®_couÁ
 = ()
sbi
->
u£r_block_couÁ
 / sbi->
blocks_³r_£g
;

88 
si
->
rsvd_£gs
 = 
	`»£rved_£gm’ts
(
sbi
);

89 
si
->
ov”p_£gs
 = 
	`ov”´ovisiÚ_£gm’ts
(
sbi
);

90 
si
->
v®id_couÁ
 = 
	`v®id_u£r_blocks
(
sbi
);

91 
si
->
disÿrd_blks
 = 
	`disÿrd_blocks
(
sbi
);

92 
si
->
v®id_node_couÁ
 = 
	`v®id_node_couÁ
(
sbi
);

93 
si
->
v®id_šode_couÁ
 = 
	`v®id_šode_couÁ
(
sbi
);

94 
si
->
šlše_x©Œ
 = 
	`©omic_»ad
(&
sbi
->inline_xattr);

95 
si
->
šlše_šode
 = 
	`©omic_»ad
(&
sbi
->inline_inode);

96 
si
->
šlše_dœ
 = 
	`©omic_»ad
(&
sbi
->inline_dir);

97 
si
->
­³nd
 = 
sbi
->
im
[
APPEND_INO
].
šo_num
;

98 
si
->
upd©e
 = 
sbi
->
im
[
UPDATE_INO
].
šo_num
;

99 
si
->
Üphªs
 = 
sbi
->
im
[
ORPHAN_INO
].
šo_num
;

100 
si
->
utiz©iÚ
 = 
	`utiz©iÚ
(
sbi
);

102 
si
->
ä“_£gs
 = 
	`ä“_£gm’ts
(
sbi
);

103 
si
->
ä“_£cs
 = 
	`ä“_£ùiÚs
(
sbi
);

104 
si
->
´eä“_couÁ
 = 
	`´eä“_£gm’ts
(
sbi
);

105 
si
->
dœty_couÁ
 = 
	`dœty_£gm’ts
(
sbi
);

106 ià(
sbi
->
node_šode
)

107 
si
->
node_·ges
 = 
	`NODE_MAPPING
(
sbi
)->
Ä·ges
;

108 ià(
sbi
->
m‘a_šode
)

109 
si
->
m‘a_·ges
 = 
	`META_MAPPING
(
sbi
)->
Ä·ges
;

110 
si
->
Çts
 = 
	`NM_I
(
sbi
)->
Çt_út
;

111 
si
->
dœty_Çts
 = 
	`NM_I
(
sbi
)->
dœty_Çt_út
;

112 
si
->
s™s
 = 
	`MAIN_SEGS
(
sbi
);

113 
si
->
dœty_s™s
 = 
	`SIT_I
(
sbi
)->
dœty_£Ár›s
;

114 
si
->
ä“_nids
 = 
	`NM_I
(
sbi
)->
nid_út
[
FREE_NID
];

115 
si
->
ava_nids
 = 
	`NM_I
(
sbi
)->
avaabË_nids
;

116 
si
->
®loc_nids
 = 
	`NM_I
(
sbi
)->
nid_út
[
PREALLOC_NID
];

117 
si
->
bg_gc
 = 
sbi
->bg_gc;

118 
si
->
io_sk_bggc
 = 
sbi
->io_skip_bggc;

119 
si
->
Ùh”_sk_bggc
 = 
sbi
->other_skip_bggc;

120 
si
->
sk³d_©omic_fes
[
BG_GC
] = 
sbi
->skipped_atomic_files[BG_GC];

121 
si
->
sk³d_©omic_fes
[
FG_GC
] = 
sbi
->skipped_atomic_files[FG_GC];

122 
si
->
ut_ä“
 = ()(
	`ä“_u£r_blocks
(
sbi
è>> sbi->
log_blocks_³r_£g
)

123 * 100 / ()(
sbi
->
u£r_block_couÁ
 >> sbi->
log_blocks_³r_£g
)

125 
si
->
ut_v®id
 = ()(
	`wr™‹n_block_couÁ
(
sbi
) >>

126 
sbi
->
log_blocks_³r_£g
)

127 * 100 / ()(
sbi
->
u£r_block_couÁ
 >> sbi->
log_blocks_³r_£g
)

129 
si
->
ut_šv®id
 = 50 - si->
ut_ä“
 - si->
ut_v®id
;

130 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_NODE
; i++) {

131 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

132 
si
->
cur£g
[
i
] = cur£g->
£gno
;

133 
si
->
cur£c
[
i
] = 
	`GET_SEC_FROM_SEG
(
sbi
, 
cur£g
->
£gno
);

134 
si
->
curzÚe
[
i
] = 
	`GET_ZONE_FROM_SEC
(
sbi
, si->
cur£c
[i]);

137 
i
 = 
META_CP
; i < 
META_MAX
; i++)

138 
si
->
m‘a_couÁ
[
i
] = 
	`©omic_»ad
(&
sbi
->meta_count[i]);

140 
i
 = 0; i < 2; i++) {

141 
si
->
£gm’t_couÁ
[
i
] = 
sbi
->segment_count[i];

142 
si
->
block_couÁ
[
i
] = 
sbi
->block_count[i];

145 
si
->
š¶aû_couÁ
 = 
	`©omic_»ad
(&
sbi
->inplace_count);

146 
	}
}

151 
	$upd©e_s™_šfo
(
f2fs_sb_šfo
 *
sbi
)

153 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

154 
blks_³r_£c
, 
hblks_³r_£c
, 
tÙ®_vblocks
;

155 
bimod®
, 
di¡
;

156 
£gno
, 
vblocks
;

157 
ndœty
 = 0;

159 
bimod®
 = 0;

160 
tÙ®_vblocks
 = 0;

161 
blks_³r_£c
 = 
	`BLKS_PER_SEC
(
sbi
);

162 
hblks_³r_£c
 = 
blks_³r_£c
 / 2;

163 
£gno
 = 0; segnØ< 
	`MAIN_SEGS
(
sbi
); segnØ+ğsbi->
£gs_³r_£c
) {

164 
vblocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
Œue
);

165 
di¡
 = 
	`abs
(
vblocks
 - 
hblks_³r_£c
);

166 
bimod®
 +ğ
di¡
 * dist;

168 ià(
vblocks
 > 0 && vblock < 
blks_³r_£c
) {

169 
tÙ®_vblocks
 +ğ
vblocks
;

170 
ndœty
++;

173 
di¡
 = 
	`div_u64
(
	`MAIN_SECS
(
sbi
è* 
hblks_³r_£c
 * hblks_per_sec, 100);

174 
si
->
bimod®
 = 
	`div64_u64
(bimod®, 
di¡
);

175 ià(
si
->
dœty_couÁ
)

176 
si
->
avg_vblocks
 = 
	`div_u64
(
tÙ®_vblocks
, 
ndœty
);

178 
si
->
avg_vblocks
 = 0;

179 
	}
}

184 
	$upd©e_mem_šfo
(
f2fs_sb_šfo
 *
sbi
)

186 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

187 
i
;

189 ià(
si
->
ba£_mem
)

190 
g‘_ÿche
;

193 
si
->
ba£_mem
 = (
f2fs_¡©_šfo
);

196 
si
->
ba£_mem
 +ğ(
f2fs_sb_šfo
è+ 
sbi
->
sb
->
s_blocksize
;

197 
si
->
ba£_mem
 +ğ2 * (
f2fs_šode_šfo
);

198 
si
->
ba£_mem
 +ğ(*
sbi
->
ck±
);

201 
si
->
ba£_mem
 +ğ(
f2fs_sm_šfo
);

204 
si
->
ba£_mem
 +ğ(
s™_šfo
);

205 
si
->
ba£_mem
 +ğ
	`MAIN_SEGS
(
sbi
è* (
£g_’Œy
);

206 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

207 
si
->
ba£_mem
 +ğ2 * 
SIT_VBLOCK_MAP_SIZE
 * 
	`MAIN_SEGS
(
sbi
);

208 
si
->
ba£_mem
 +ğ
SIT_VBLOCK_MAP_SIZE
 * 
	`MAIN_SEGS
(
sbi
);

209 
si
->
ba£_mem
 +ğ
SIT_VBLOCK_MAP_SIZE
;

210 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
))

211 
si
->
ba£_mem
 +ğ
	`MAIN_SECS
(
sbi
è* (
£c_’Œy
);

212 
si
->
ba£_mem
 +ğ
	`__b™m­_size
(
sbi
, 
SIT_BITMAP
);

215 
si
->
ba£_mem
 +ğ(
ä“_£gm­_šfo
);

216 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

217 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

220 
si
->
ba£_mem
 +ğ(
cur£g_šfo
è* 
NR_CURSEG_TYPE
;

221 
si
->
ba£_mem
 +ğ
PAGE_SIZE
 * 
NR_CURSEG_TYPE
;

224 
si
->
ba£_mem
 +ğ(
dœty_£gli¡_šfo
);

225 
si
->
ba£_mem
 +ğ
NR_DIRTY_TYPE
 * 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

226 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

229 
si
->
ba£_mem
 +ğ(
f2fs_nm_šfo
);

230 
si
->
ba£_mem
 +ğ
	`__b™m­_size
(
sbi
, 
NAT_BITMAP
);

231 
si
->
ba£_mem
 +ğ(
	`NM_I
(
sbi
)->
Çt_b™s_blocks
 << 
F2FS_BLKSIZE_BITS
);

232 
si
->
ba£_mem
 +ğ
	`NM_I
(
sbi
)->
Çt_blocks
 *

233 
	`f2fs_b™m­_size
(
NAT_ENTRY_PER_BLOCK
);

234 
si
->
ba£_mem
 +ğ
	`NM_I
(
sbi
)->
Çt_blocks
 / 8;

235 
si
->
ba£_mem
 +ğ
	`NM_I
(
sbi
)->
Çt_blocks
 * ();

237 
g‘_ÿche
:

238 
si
->
ÿche_mem
 = 0;

241 ià(
sbi
->
gc_th»ad
)

242 
si
->
ÿche_mem
 +ğ(
f2fs_gc_kth»ad
);

245 ià(
	`SM_I
(
sbi
)->
fcc_šfo
)

246 
si
->
ÿche_mem
 +ğ(
æush_cmd_cÚŒŞ
);

247 ià(
	`SM_I
(
sbi
)->
dcc_šfo
) {

248 
si
->
ÿche_mem
 +ğ(
disÿrd_cmd_cÚŒŞ
);

249 
si
->
ÿche_mem
 +ğ(
disÿrd_cmd
) *

250 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
disÿrd_cmd_út
);

254 
si
->
ÿche_mem
 +ğ(
	`NM_I
(
sbi
)->
nid_út
[
FREE_NID
] +

255 
	`NM_I
(
sbi
)->
nid_út
[
PREALLOC_NID
]) *

256 (
ä“_nid
);

257 
si
->
ÿche_mem
 +ğ
	`NM_I
(
sbi
)->
Çt_út
 * (
Çt_’Œy
);

258 
si
->
ÿche_mem
 +ğ
	`NM_I
(
sbi
)->
dœty_Çt_út
 *

259 (
Çt_’Œy_£t
);

260 
si
->
ÿche_mem
 +ğsi->
šmem_·ges
 * (inmem_pages);

261 
i
 = 0; i < 
MAX_INO_ENTRY
; i++)

262 
si
->
ÿche_mem
 +ğ
sbi
->
im
[
i
].
šo_num
 * (
šo_’Œy
);

263 
si
->
ÿche_mem
 +ğ
	`©omic_»ad
(&
sbi
->
tÙ®_ext_Œ“
) *

264 (
ex‹Á_Œ“
);

265 
si
->
ÿche_mem
 +ğ
	`©omic_»ad
(&
sbi
->
tÙ®_ext_node
) *

266 (
ex‹Á_node
);

268 
si
->
·ge_mem
 = 0;

269 ià(
sbi
->
node_šode
) {

270 
Åages
 = 
	`NODE_MAPPING
(
sbi
)->
Ä·ges
;

271 
si
->
·ge_mem
 +ğ()
Åages
 << 
PAGE_SHIFT
;

273 ià(
sbi
->
m‘a_šode
) {

274 
Åages
 = 
	`META_MAPPING
(
sbi
)->
Ä·ges
;

275 
si
->
·ge_mem
 +ğ()
Åages
 << 
PAGE_SHIFT
;

277 
	}
}

279 
	$¡©_show
(
£q_fe
 *
s
, *
v
)

281 
f2fs_¡©_šfo
 *
si
;

282 
i
 = 0;

283 
j
;

285 
	`mu‹x_lock
(&
f2fs_¡©_mu‹x
);

286 
	`li¡_fÜ_—ch_’Œy
(
si
, &
f2fs_¡©_li¡
, 
¡©_li¡
) {

287 
	`upd©e_g’”®_¡©us
(
si
->
sbi
);

289 
	`£q_´štf
(
s
, "\n=====[…artition info(%pg). #%d, %s, CP: %s]=====\n",

290 
si
->
sbi
->
sb
->
s_bdev
, 
i
++,

291 
	`f2fs_»adÚly
(
si
->
sbi
->
sb
) ? "RO": "RW",

292 
	`is_£t_ck±_æags
(
si
->
sbi
, 
CP_DISABLED_FLAG
) ?

293 "Di§bËd": (
	`f2fs_ı_”rÜ
(
si
->
sbi
) ? "Error": "Good"));

294 
	`£q_´štf
(
s
, "[SB: 1] [CP: 2] [SIT: %d] [NAT: %d] ",

295 
si
->
s™_¬—_£gs
, si->
Çt_¬—_£gs
);

296 
	`£q_´štf
(
s
, "[SSA: %d] [MAIN: %d",

297 
si
->
s§_¬—_£gs
, si->
maš_¬—_£gs
);

298 
	`£q_´štf
(
s
, "(OverProv:%d Resv:%d)]\n\n",

299 
si
->
ov”p_£gs
, si->
rsvd_£gs
);

300 ià(
	`‹¡_İt
(
si
->
sbi
, 
DISCARD
))

301 
	`£q_´štf
(
s
, "Utilization: %u%% (%u valid blocks, %u discard blocks)\n",

302 
si
->
utiz©iÚ
, si->
v®id_couÁ
, si->
disÿrd_blks
);

304 
	`£q_´štf
(
s
, "Utilization: %u%% (%u valid blocks)\n",

305 
si
->
utiz©iÚ
, si->
v®id_couÁ
);

307 
	`£q_´štf
(
s
, " - Node: %u (Inode: %u, ",

308 
si
->
v®id_node_couÁ
, si->
v®id_šode_couÁ
);

309 
	`£q_´štf
(
s
, "Other: %u)\n - Data: %u\n",

310 
si
->
v®id_node_couÁ
 - si->
v®id_šode_couÁ
,

311 
si
->
v®id_couÁ
 - si->
v®id_node_couÁ
);

312 
	`£q_´štf
(
s
, " - Inline_xattr Inode: %u\n",

313 
si
->
šlše_x©Œ
);

314 
	`£q_´štf
(
s
, " - Inline_data Inode: %u\n",

315 
si
->
šlše_šode
);

316 
	`£q_´štf
(
s
, " - Inline_dentry Inode: %u\n",

317 
si
->
šlše_dœ
);

318 
	`£q_´štf
(
s
, " - Orphan/Append/Update Inode: %u, %u, %u\n",

319 
si
->
Üphªs
, si->
­³nd
, si->
upd©e
);

320 
	`£q_´štf
(
s
, "\nMain‡rea: %d segs, %d secs %d zones\n",

321 
si
->
maš_¬—_£gs
, si->
maš_¬—_£ùiÚs
,

322 
si
->
maš_¬—_zÚes
);

323 
	`£q_´štf
(
s
, " - COLD data: %d, %d, %d\n",

324 
si
->
cur£g
[
CURSEG_COLD_DATA
],

325 
si
->
cur£c
[
CURSEG_COLD_DATA
],

326 
si
->
curzÚe
[
CURSEG_COLD_DATA
]);

327 
	`£q_´štf
(
s
, " - WARM data: %d, %d, %d\n",

328 
si
->
cur£g
[
CURSEG_WARM_DATA
],

329 
si
->
cur£c
[
CURSEG_WARM_DATA
],

330 
si
->
curzÚe
[
CURSEG_WARM_DATA
]);

331 
	`£q_´štf
(
s
, " - HOT data: %d, %d, %d\n",

332 
si
->
cur£g
[
CURSEG_HOT_DATA
],

333 
si
->
cur£c
[
CURSEG_HOT_DATA
],

334 
si
->
curzÚe
[
CURSEG_HOT_DATA
]);

335 
	`£q_´štf
(
s
, " - Dir dnode: %d, %d, %d\n",

336 
si
->
cur£g
[
CURSEG_HOT_NODE
],

337 
si
->
cur£c
[
CURSEG_HOT_NODE
],

338 
si
->
curzÚe
[
CURSEG_HOT_NODE
]);

339 
	`£q_´štf
(
s
, " - File dnode: %d, %d, %d\n",

340 
si
->
cur£g
[
CURSEG_WARM_NODE
],

341 
si
->
cur£c
[
CURSEG_WARM_NODE
],

342 
si
->
curzÚe
[
CURSEG_WARM_NODE
]);

343 
	`£q_´štf
(
s
, " - Indir‚odes: %d, %d, %d\n",

344 
si
->
cur£g
[
CURSEG_COLD_NODE
],

345 
si
->
cur£c
[
CURSEG_COLD_NODE
],

346 
si
->
curzÚe
[
CURSEG_COLD_NODE
]);

347 
	`£q_´štf
(
s
, "\n - Valid: %d\n - Dirty: %d\n",

348 
si
->
maš_¬—_£gs
 - si->
dœty_couÁ
 -

349 
si
->
´eä“_couÁ
 - si->
ä“_£gs
,

350 
si
->
dœty_couÁ
);

351 
	`£q_´štf
(
s
, " - Prefree: %d\n - Free: %d (%d)\n\n",

352 
si
->
´eä“_couÁ
, si->
ä“_£gs
, si->
ä“_£cs
);

353 
	`£q_´štf
(
s
, "CP calls: %d (BG: %d)\n",

354 
si
->
ı_couÁ
, si->
bg_ı_couÁ
);

355 
	`£q_´štf
(
s
, " - c°block : %u\n", 
si
->
m‘a_couÁ
[
META_CP
]);

356 
	`£q_´štf
(
s
, " - sit blocks : %u\n",

357 
si
->
m‘a_couÁ
[
META_SIT
]);

358 
	`£q_´štf
(
s
, " -‚at blocks : %u\n",

359 
si
->
m‘a_couÁ
[
META_NAT
]);

360 
	`£q_´štf
(
s
, " - ssa blocks : %u\n",

361 
si
->
m‘a_couÁ
[
META_SSA
]);

362 
	`£q_´štf
(
s
, "GC calls: %d (BG: %d)\n",

363 
si
->
ÿÎ_couÁ
, si->
bg_gc
);

364 
	`£q_´štf
(
s
, " - data segments : %d (%d)\n",

365 
si
->
d©a_£gs
, si->
bg_d©a_£gs
);

366 
	`£q_´štf
(
s
, " -‚ode segments : %d (%d)\n",

367 
si
->
node_£gs
, si->
bg_node_£gs
);

368 
	`£q_´štf
(
s
, "TryØmov%d block (BG: %d)\n", 
si
->
tÙ_blks
,

369 
si
->
bg_d©a_blks
 + si->
bg_node_blks
);

370 
	`£q_´štf
(
s
, " - d©¨block : %d (%d)\n", 
si
->
d©a_blks
,

371 
si
->
bg_d©a_blks
);

372 
	`£q_´štf
(
s
, " -‚odblock : %d (%d)\n", 
si
->
node_blks
,

373 
si
->
bg_node_blks
);

374 
	`£q_´štf
(
s
, "Skipped :‡tomic write %llu (%llu)\n",

375 
si
->
sk³d_©omic_fes
[
BG_GC
] +

376 
si
->
sk³d_©omic_fes
[
FG_GC
],

377 
si
->
sk³d_©omic_fes
[
BG_GC
]);

378 
	`£q_´štf
(
s
, "BG skip : IO: %u, Other: %u\n",

379 
si
->
io_sk_bggc
, si->
Ùh”_sk_bggc
);

380 
	`£q_puts
(
s
, "\nExtent Cache:\n");

381 
	`£q_´štf
(
s
, " - Hit Count: L1-1:%llu L1-2:%llu L2:%llu\n",

382 
si
->
h™_Ïrge¡
, si->
h™_ÿched
,

383 
si
->
h™_rbŒ“
);

384 
	`£q_´štf
(
s
, " - Hit Ratio: %llu%% (%llu / %llu)\n",

385 !
si
->
tÙ®_ext
 ? 0 :

386 
	`div64_u64
(
si
->
h™_tÙ®
 * 100, si->
tÙ®_ext
),

387 
si
->
h™_tÙ®
, si->
tÙ®_ext
);

388 
	`£q_´štf
(
s
, " - Inner Struct Count:ree: %d(%d),‚ode: %d\n",

389 
si
->
ext_Œ“
, si->
zomb›_Œ“
, si->
ext_node
);

390 
	`£q_puts
(
s
, "\nBalancing F2FS Async:\n");

391 
	`£q_´štf
(
s
, " - DIO (R: %4d, W: %4d)\n",

392 
si
->
Ä_dio_»ad
, si->
Ä_dio_wr™e
);

393 
	`£q_´štf
(
s
, " - IO_R (Data: %4d, Node: %4d, Meta: %4d\n",

394 
si
->
Ä_rd_d©a
, si->
Ä_rd_node
, si->
Ä_rd_m‘a
);

395 
	`£q_´štf
(
s
, " - IO_W (CP: %4d, Data: %4d, Flush: (%4d %4d %4d), "

397 
si
->
Ä_wb_ı_d©a
, si->
Ä_wb_d©a
,

398 
si
->
Ä_æushšg
, si->
Ä_æushed
,

399 
si
->
æush_li¡_em±y
,

400 
si
->
Ä_disÿrdšg
, si->
Ä_disÿrded
,

401 
si
->
Ä_disÿrd_cmd
, si->
undisÿrd_blks
);

402 
	`£q_´štf
(
s
, " - inmem: %4d,‡tomic IO: %4d (Max. %4d), "

404 
si
->
šmem_·ges
, si->
aw_út
, si->
max_aw_út
,

405 
si
->
vw_út
, si->
max_vw_út
);

406 
	`£q_´štf
(
s
, " -‚odes: %4d in %4d\n",

407 
si
->
ndœty_node
, si->
node_·ges
);

408 
	`£q_´štf
(
s
, " - dents: %4d in dirs:%4d (%4d)\n",

409 
si
->
ndœty_d’t
, si->
ndœty_dœs
, si->
ndœty_®l
);

410 
	`£q_´štf
(
s
, " - datas: %4d in files:%4d\n",

411 
si
->
ndœty_d©a
, si->
ndœty_fes
);

412 
	`£q_´štf
(
s
, " - quota datas: %4d in quota files:%4d\n",

413 
si
->
ndœty_qd©a
, si->
nquÙa_fes
);

414 
	`£q_´štf
(
s
, " - meta: %4d in %4d\n",

415 
si
->
ndœty_m‘a
, si->
m‘a_·ges
);

416 
	`£q_´štf
(
s
, " - imeta: %4d\n",

417 
si
->
ndœty_im‘a
);

418 
	`£q_´štf
(
s
, " - NATs: %9d/%9d\n - SITs: %9d/%9d\n",

419 
si
->
dœty_Çts
, si->
Çts
, si->
dœty_s™s
, si->
s™s
);

420 
	`£q_´štf
(
s
, " - free_nids: %9d/%9d\n -‡lloc_nids: %9d\n",

421 
si
->
ä“_nids
, si->
ava_nids
, si->
®loc_nids
);

422 
	`£q_puts
(
s
, "\nDistribution of User Blocks:");

423 
	`£q_puts
(
s
, " [ valid | invalid | free ]\n");

424 
	`£q_puts
(
s
, " [");

426 
j
 = 0; j < 
si
->
ut_v®id
; j++)

427 
	`£q_putc
(
s
, '-');

428 
	`£q_putc
(
s
, '|');

430 
j
 = 0; j < 
si
->
ut_šv®id
; j++)

431 
	`£q_putc
(
s
, '-');

432 
	`£q_putc
(
s
, '|');

434 
j
 = 0; j < 
si
->
ut_ä“
; j++)

435 
	`£q_putc
(
s
, '-');

436 
	`£q_puts
(
s
, "]\n\n");

437 
	`£q_´štf
(
s
, "IPU: %u blocks\n", 
si
->
š¶aû_couÁ
);

438 
	`£q_´štf
(
s
, "SSR: %u blocks in %u segments\n",

439 
si
->
block_couÁ
[
SSR
], si->
£gm’t_couÁ
[SSR]);

440 
	`£q_´štf
(
s
, "LFS: %u blocks in %u segments\n",

441 
si
->
block_couÁ
[
LFS
], si->
£gm’t_couÁ
[LFS]);

444 
	`upd©e_s™_šfo
(
si
->
sbi
);

445 
	`£q_´štf
(
s
, "\nBDF: %u,‡vg. vblocks: %u\n",

446 
si
->
bimod®
, si->
avg_vblocks
);

449 
	`upd©e_mem_šfo
(
si
->
sbi
);

450 
	`£q_´štf
(
s
, "\nMemory: %llu KB\n",

451 (
si
->
ba£_mem
 + si->
ÿche_mem
 + si->
·ge_mem
) >> 10);

452 
	`£q_´štf
(
s
, " - static: %llu KB\n",

453 
si
->
ba£_mem
 >> 10);

454 
	`£q_´štf
(
s
, " - cached: %llu KB\n",

455 
si
->
ÿche_mem
 >> 10);

456 
	`£q_´štf
(
s
, " -…aged : %llu KB\n",

457 
si
->
·ge_mem
 >> 10);

459 
	`mu‹x_uÆock
(&
f2fs_¡©_mu‹x
);

461 
	}
}

463 
DEFINE_SHOW_ATTRIBUTE
(
¡©
);

465 
	$f2fs_bud_¡©s
(
f2fs_sb_šfo
 *
sbi
)

467 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

468 
f2fs_¡©_šfo
 *
si
;

469 
i
;

471 
si
 = 
	`f2fs_kz®loc
(
sbi
, (
f2fs_¡©_šfo
), 
GFP_KERNEL
);

472 ià(!
si
)

473  -
ENOMEM
;

475 
si
->
®l_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ
);

476 
si
->
s™_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s™
);

477 
si
->
Çt_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_Çt
);

478 
si
->
s§_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s§
);

479 
si
->
maš_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_maš
);

480 
si
->
maš_¬—_£ùiÚs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£ùiÚ_couÁ
);

481 
si
->
maš_¬—_zÚes
 = si->
maš_¬—_£ùiÚs
 /

482 
	`Ë32_to_ıu
(
¿w_su³r
->
£cs_³r_zÚe
);

483 
si
->
sbi
 = sbi;

484 
sbi
->
¡©_šfo
 = 
si
;

486 
	`©omic64_£t
(&
sbi
->
tÙ®_h™_ext
, 0);

487 
	`©omic64_£t
(&
sbi
->
»ad_h™_rbŒ“
, 0);

488 
	`©omic64_£t
(&
sbi
->
»ad_h™_Ïrge¡
, 0);

489 
	`©omic64_£t
(&
sbi
->
»ad_h™_ÿched
, 0);

491 
	`©omic_£t
(&
sbi
->
šlše_x©Œ
, 0);

492 
	`©omic_£t
(&
sbi
->
šlše_šode
, 0);

493 
	`©omic_£t
(&
sbi
->
šlše_dœ
, 0);

494 
	`©omic_£t
(&
sbi
->
š¶aû_couÁ
, 0);

495 
i
 = 
META_CP
; i < 
META_MAX
; i++)

496 
	`©omic_£t
(&
sbi
->
m‘a_couÁ
[
i
], 0);

498 
	`©omic_£t
(&
sbi
->
aw_út
, 0);

499 
	`©omic_£t
(&
sbi
->
vw_út
, 0);

500 
	`©omic_£t
(&
sbi
->
max_aw_út
, 0);

501 
	`©omic_£t
(&
sbi
->
max_vw_út
, 0);

503 
	`mu‹x_lock
(&
f2fs_¡©_mu‹x
);

504 
	`li¡_add_
(&
si
->
¡©_li¡
, &
f2fs_¡©_li¡
);

505 
	`mu‹x_uÆock
(&
f2fs_¡©_mu‹x
);

508 
	}
}

510 
	$f2fs_de¡roy_¡©s
(
f2fs_sb_šfo
 *
sbi
)

512 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

514 
	`mu‹x_lock
(&
f2fs_¡©_mu‹x
);

515 
	`li¡_d–
(&
si
->
¡©_li¡
);

516 
	`mu‹x_uÆock
(&
f2fs_¡©_mu‹x
);

518 
	`kvä“
(
si
);

519 
	}
}

521 
__š™
 
	$f2fs_ü—‹_roÙ_¡©s
()

523 
f2fs_debugfs_roÙ
 = 
	`debugfs_ü—‹_dœ
("f2fs", 
NULL
);

525 
	`debugfs_ü—‹_fe
("¡©us", 
S_IRUGO
, 
f2fs_debugfs_roÙ
, 
NULL
,

526 &
¡©_fİs
);

527 
	}
}

529 
	$f2fs_de¡roy_roÙ_¡©s
()

531 
	`debugfs_»move_»cursive
(
f2fs_debugfs_roÙ
);

532 
f2fs_debugfs_roÙ
 = 
NULL
;

533 
	}
}

	@dir.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/f2fs_fs.h
>

10 
	~<lšux/sched/sigÇl.h
>

11 
	~<lšux/unicode.h
>

12 
	~"f2fs.h
"

13 
	~"node.h
"

14 
	~"aş.h
"

15 
	~"x©Œ.h
"

16 
	~<Œaû/ev’ts/f2fs.h
>

18 
	$dœ_blocks
(
šode
 *inode)

20  ((è(
	`i_size_»ad
(
šode
è+ 
PAGE_SIZE
 - 1))

21 >> 
PAGE_SHIFT
;

22 
	}
}

24 
	$dœ_buck‘s
(
Ëv–
, 
dœ_Ëv–
)

26 ià(
Ëv–
 + 
dœ_Ëv–
 < 
MAX_DIR_HASH_DEPTH
 / 2)

27  1 << (
Ëv–
 + 
dœ_Ëv–
);

29  
MAX_DIR_BUCKETS
;

30 
	}
}

32 
	$buck‘_blocks
(
Ëv–
)

34 ià(
Ëv–
 < 
MAX_DIR_HASH_DEPTH
 / 2)

38 
	}
}

40 
	gf2fs_f‘y³_bË
[
F2FS_FT_MAX
] = {

41 [
F2FS_FT_UNKNOWN
] = 
DT_UNKNOWN
,

42 [
F2FS_FT_REG_FILE
] = 
DT_REG
,

43 [
F2FS_FT_DIR
] = 
DT_DIR
,

44 [
F2FS_FT_CHRDEV
] = 
DT_CHR
,

45 [
F2FS_FT_BLKDEV
] = 
DT_BLK
,

46 [
F2FS_FT_FIFO
] = 
DT_FIFO
,

47 [
F2FS_FT_SOCK
] = 
DT_SOCK
,

48 [
F2FS_FT_SYMLINK
] = 
DT_LNK
,

51 
	gf2fs_ty³_by_mode
[
S_IFMT
 >> 
S_SHIFT
] = {

52 [
S_IFREG
 >> 
S_SHIFT
] = 
F2FS_FT_REG_FILE
,

53 [
S_IFDIR
 >> 
S_SHIFT
] = 
F2FS_FT_DIR
,

54 [
S_IFCHR
 >> 
S_SHIFT
] = 
F2FS_FT_CHRDEV
,

55 [
S_IFBLK
 >> 
S_SHIFT
] = 
F2FS_FT_BLKDEV
,

56 [
S_IFIFO
 >> 
S_SHIFT
] = 
F2FS_FT_FIFO
,

57 [
S_IFSOCK
 >> 
S_SHIFT
] = 
F2FS_FT_SOCK
,

58 [
S_IFLNK
 >> 
S_SHIFT
] = 
F2FS_FT_SYMLINK
,

61 
	$£t_de_ty³
(
f2fs_dœ_’Œy
 *
de
, 
umode_t
 
mode
)

63 
de
->
fe_ty³
 = 
f2fs_ty³_by_mode
[(
mode
 & 
S_IFMT
è>> 
S_SHIFT
];

64 
	}
}

66 
	$f2fs_g‘_de_ty³
(
f2fs_dœ_’Œy
 *
de
)

68 ià(
de
->
fe_ty³
 < 
F2FS_FT_MAX
)

69  
f2fs_f‘y³_bË
[
de
->
fe_ty³
];

70  
DT_UNKNOWN
;

71 
	}
}

73 
	$dœ_block_šdex
(
Ëv–
,

74 
dœ_Ëv–
, 
idx
)

76 
i
;

77 
bidx
 = 0;

79 
i
 = 0; i < 
Ëv–
; i++)

80 
bidx
 +ğ
	`dœ_buck‘s
(
i
, 
dœ_Ëv–
è* 
	`buck‘_blocks
(i);

81 
bidx
 +ğ
idx
 * 
	`buck‘_blocks
(
Ëv–
);

82  
bidx
;

83 
	}
}

85 
f2fs_dœ_’Œy
 *
	$fšd_š_block
(
šode
 *
dœ
,

86 
·ge
 *
d’Œy_·ge
,

87 
fsüy±_Çme
 *
âame
,

88 
f2fs_hash_t
 
Çmehash
,

89 *
max_¦Ùs
,

90 
·ge
 **
»s_·ge
)

92 
f2fs_d’Œy_block
 *
d’Œy_blk
;

93 
f2fs_dœ_’Œy
 *
de
;

94 
f2fs_d’Œy_±r
 
d
;

96 
d’Œy_blk
 = (
f2fs_d’Œy_block
 *)
	`·ge_add»ss
(
d’Œy_·ge
);

98 
	`make_d’Œy_±r_block
(
dœ
, &
d
, 
d’Œy_blk
);

99 
de
 = 
	`f2fs_fšd_rg‘_d’Œy
(
âame
, 
Çmehash
, 
max_¦Ùs
, &
d
);

100 ià(
de
)

101 *
»s_·ge
 = 
d’Œy_·ge
;

103  
de
;

104 
	}
}

106 #ifdeà
CONFIG_UNICODE


114 
	$f2fs_ci_com·»
(cÚ¡ 
šode
 *
·»Á
, cÚ¡ 
q¡r
 *
Çme
,

115 cÚ¡ 
q¡r
 *
’Œy
, 
boŞ
 
quick
)

117 cÚ¡ 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
·»Á
->
i_sb
);

118 cÚ¡ 
unicode_m­
 *
um
 = 
sbi
->
s_’codšg
;

119 
»t
;

121 ià(
quick
)

122 
»t
 = 
	`utf8_¡ºÿ£cmp_fŞded
(
um
, 
Çme
, 
’Œy
);

124 
»t
 = 
	`utf8_¡ºÿ£cmp
(
um
, 
Çme
, 
’Œy
);

126 ià(
»t
 < 0) {

130 ià(
	`f2fs_has_¡riù_mode
(
sbi
))

131  -
EINVAL
;

133 ià(
Çme
->
Ën
 !ğ
’Œy
->len)

136  !!
	`memcmp
(
Çme
->Çme, 
’Œy
->Çme,‚ame->
Ën
);

139  
»t
;

140 
	}
}

142 
	$f2fs_âame_£tup_ci_f’ame
(
šode
 *
dœ
,

143 cÚ¡ 
q¡r
 *
šame
,

144 
fsüy±_¡r
 *
cf_Çme
)

146 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

148 ià(!
	`IS_CASEFOLDED
(
dœ
)) {

149 
cf_Çme
->
Çme
 = 
NULL
;

153 
cf_Çme
->
Çme
 = 
	`f2fs_km®loc
(
sbi
, 
F2FS_NAME_LEN
, 
GFP_NOFS
);

154 ià(!
cf_Çme
->
Çme
)

157 
cf_Çme
->
Ën
 = 
	`utf8_ÿ£fŞd
(
sbi
->
s_’codšg
,

158 
šame
, 
cf_Çme
->
Çme
,

159 
F2FS_NAME_LEN
);

160 ià(()
cf_Çme
->
Ën
 <= 0) {

161 
	`kvä“
(
cf_Çme
->
Çme
);

162 
cf_Çme
->
Çme
 = 
NULL
;

164 
	}
}

167 
šlše
 
boŞ
 
	$f2fs_m©ch_Çme
(
f2fs_d’Œy_±r
 *
d
,

168 
f2fs_dœ_’Œy
 *
de
,

169 
fsüy±_Çme
 *
âame
,

170 
fsüy±_¡r
 *
cf_¡r
,

171 
b™_pos
,

172 
f2fs_hash_t
 
Çmehash
)

174 #ifdeà
CONFIG_UNICODE


175 
šode
 *
·»Á
 = 
d
->inode;

176 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
·»Á
);

177 
q¡r
 
’Œy
;

180 ià(
de
->
hash_code
 !ğ
Çmehash
)

181  
çl£
;

183 #ifdeà
CONFIG_UNICODE


184 
’Œy
.
Çme
 = 
d
->
f’ame
[
b™_pos
];

185 
’Œy
.
Ën
 = 
de
->
Çme_Ën
;

187 ià(
sbi
->
s_’codšg
 && 
	`IS_CASEFOLDED
(
·»Á
)) {

188 ià(
cf_¡r
->
Çme
) {

189 
q¡r
 
cf
 = {.
Çme
 = 
cf_¡r
->name,

190 .
Ën
 = 
cf_¡r
->len};

191  !
	`f2fs_ci_com·»
(
·»Á
, &
cf
, &
’Œy
, 
Œue
);

193  !
	`f2fs_ci_com·»
(
·»Á
, 
âame
->
u¤_âame
, &
’Œy
,

194 
çl£
);

197 ià(
	`fsüy±_m©ch_Çme
(
âame
, 
d
->
f’ame
[
b™_pos
],

198 
	`Ë16_to_ıu
(
de
->
Çme_Ën
)))

199  
Œue
;

200  
çl£
;

201 
	}
}

203 
f2fs_dœ_’Œy
 *
	$f2fs_fšd_rg‘_d’Œy
(
fsüy±_Çme
 *
âame
,

204 
f2fs_hash_t
 
Çmehash
, *
max_¦Ùs
,

205 
f2fs_d’Œy_±r
 *
d
)

207 
f2fs_dœ_’Œy
 *
de
;

208 
fsüy±_¡r
 
cf_¡r
 = { .
Çme
 = 
NULL
, .
Ën
 = 0 };

209 
b™_pos
 = 0;

210 
max_Ën
 = 0;

212 #ifdeà
CONFIG_UNICODE


213 
	`f2fs_âame_£tup_ci_f’ame
(
d
->
šode
, 
âame
->
u¤_âame
, &
cf_¡r
);

216 ià(
max_¦Ùs
)

217 *
max_¦Ùs
 = 0;

218 
b™_pos
 < 
d
->
max
) {

219 ià(!
	`‹¡_b™_Ë
(
b™_pos
, 
d
->
b™m­
)) {

220 
b™_pos
++;

221 
max_Ën
++;

225 
de
 = &
d
->
d’Œy
[
b™_pos
];

227 ià(
	`uÆik–y
(!
de
->
Çme_Ën
)) {

228 
b™_pos
++;

232 ià(
	`f2fs_m©ch_Çme
(
d
, 
de
, 
âame
, &
cf_¡r
, 
b™_pos
, 
Çmehash
))

233 
found
;

235 ià(
max_¦Ùs
 && 
max_Ën
 > *max_slots)

236 *
max_¦Ùs
 = 
max_Ën
;

237 
max_Ën
 = 0;

239 
b™_pos
 +ğ
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
de
->
Çme_Ën
));

242 
de
 = 
NULL
;

243 
found
:

244 ià(
max_¦Ùs
 && 
max_Ën
 > *max_slots)

245 *
max_¦Ùs
 = 
max_Ën
;

247 #ifdeà
CONFIG_UNICODE


248 
	`kvä“
(
cf_¡r
.
Çme
);

250  
de
;

251 
	}
}

253 
f2fs_dœ_’Œy
 *
	$fšd_š_Ëv–
(
šode
 *
dœ
,

254 
Ëv–
,

255 
fsüy±_Çme
 *
âame
,

256 
·ge
 **
»s_·ge
)

258 
q¡r
 
Çme
 = 
	`FSTR_TO_QSTR
(&
âame
->
disk_Çme
);

259 
s
 = 
	`GET_DENTRY_SLOTS
(
Çme
.
Ën
);

260 
nbuck‘
, 
nblock
;

261 
bidx
, 
’d_block
;

262 
·ge
 *
d’Œy_·ge
;

263 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

264 
boŞ
 
room
 = 
çl£
;

265 
max_¦Ùs
;

266 
f2fs_hash_t
 
Çmehash
 = 
	`f2fs_d’Œy_hash
(
dœ
, &
Çme
, 
âame
);

268 
nbuck‘
 = 
	`dœ_buck‘s
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
);

269 
nblock
 = 
	`buck‘_blocks
(
Ëv–
);

271 
bidx
 = 
	`dœ_block_šdex
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
,

272 
	`Ë32_to_ıu
(
Çmehash
è% 
nbuck‘
);

273 
’d_block
 = 
bidx
 + 
nblock
;

275 ; 
bidx
 < 
’d_block
; bidx++) {

277 
d’Œy_·ge
 = 
	`f2fs_fšd_d©a_·ge
(
dœ
, 
bidx
);

278 ià(
	`IS_ERR
(
d’Œy_·ge
)) {

279 ià(
	`PTR_ERR
(
d’Œy_·ge
è=ğ-
ENOENT
) {

280 
room
 = 
Œue
;

283 *
»s_·ge
 = 
d’Œy_·ge
;

288 
de
 = 
	`fšd_š_block
(
dœ
, 
d’Œy_·ge
, 
âame
, 
Çmehash
,

289 &
max_¦Ùs
, 
»s_·ge
);

290 ià(
de
)

293 ià(
max_¦Ùs
 >ğ
s
)

294 
room
 = 
Œue
;

295 
	`f2fs_put_·ge
(
d’Œy_·ge
, 0);

298 ià(!
de
 && 
room
 && 
	`F2FS_I
(
dœ
)->
chash
 !ğ
Çmehash
) {

299 
	`F2FS_I
(
dœ
)->
chash
 = 
Çmehash
;

300 
	`F2FS_I
(
dœ
)->
şev–
 = 
Ëv–
;

303  
de
;

304 
	}
}

306 
f2fs_dœ_’Œy
 *
	$__f2fs_fšd_’Œy
(
šode
 *
dœ
,

307 
fsüy±_Çme
 *
âame
, 
·ge
 **
»s_·ge
)

309 
Åages
 = 
	`dœ_blocks
(
dœ
);

310 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

311 
max_d•th
;

312 
Ëv–
;

314 ià(
	`f2fs_has_šlše_d’Œy
(
dœ
)) {

315 *
»s_·ge
 = 
NULL
;

316 
de
 = 
	`f2fs_fšd_š_šlše_dœ
(
dœ
, 
âame
, 
»s_·ge
);

317 
out
;

320 ià(
Åages
 == 0) {

321 *
»s_·ge
 = 
NULL
;

322 
out
;

325 
max_d•th
 = 
	`F2FS_I
(
dœ
)->
i_cu¼’t_d•th
;

326 ià(
	`uÆik–y
(
max_d•th
 > 
MAX_DIR_HASH_DEPTH
)) {

327 
	`f2fs_w¬n
(
	`F2FS_I_SB
(
dœ
), "Corrupted max_depth of %lu: %u",

328 
dœ
->
i_šo
, 
max_d•th
);

329 
max_d•th
 = 
MAX_DIR_HASH_DEPTH
;

330 
	`f2fs_i_d•th_wr™e
(
dœ
, 
max_d•th
);

333 
Ëv–
 = 0;†ev– < 
max_d•th
;†evel++) {

334 *
»s_·ge
 = 
NULL
;

335 
de
 = 
	`fšd_š_Ëv–
(
dœ
, 
Ëv–
, 
âame
, 
»s_·ge
);

336 ià(
de
 || 
	`IS_ERR
(*
»s_·ge
))

339 
out
:

341 ià(!
de
)

342 
	`F2FS_I
(
dœ
)->
sk
 = 
cu¼’t
;

343  
de
;

344 
	}
}

352 
f2fs_dœ_’Œy
 *
	$f2fs_fšd_’Œy
(
šode
 *
dœ
,

353 cÚ¡ 
q¡r
 *
chd
, 
·ge
 **
»s_·ge
)

355 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

356 
fsüy±_Çme
 
âame
;

357 
”r
;

359 #ifdeà
CONFIG_UNICODE


360 ià(
	`f2fs_has_¡riù_mode
(
	`F2FS_I_SB
(
dœ
)è&& 
	`IS_CASEFOLDED
(dir) &&

361 
	`utf8_v®id©e
(
	`F2FS_I_SB
(
dœ
)->
s_’codšg
, 
chd
)) {

362 *
»s_·ge
 = 
	`ERR_PTR
(-
EINVAL
);

363  
NULL
;

367 
”r
 = 
	`fsüy±_£tup_f’ame
(
dœ
, 
chd
, 1, &
âame
);

368 ià(
”r
) {

369 ià(
”r
 =ğ-
ENOENT
)

370 *
»s_·ge
 = 
NULL
;

372 *
»s_·ge
 = 
	`ERR_PTR
(
”r
);

373  
NULL
;

376 
de
 = 
	`__f2fs_fšd_’Œy
(
dœ
, &
âame
, 
»s_·ge
);

378 
	`fsüy±_ä“_f’ame
(&
âame
);

379  
de
;

380 
	}
}

382 
f2fs_dœ_’Œy
 *
	$f2fs_·»Á_dœ
(
šode
 *
dœ
, 
·ge
 **
p
)

384 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

386  
	`f2fs_fšd_’Œy
(
dœ
, &
dÙdÙ
, 
p
);

387 
	}
}

389 
šo_t
 
	$f2fs_šode_by_Çme
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *qstr,

390 
·ge
 **page)

392 
šo_t
 
»s
 = 0;

393 
f2fs_dœ_’Œy
 *
de
;

395 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, 
q¡r
, 
·ge
);

396 ià(
de
) {

397 
»s
 = 
	`Ë32_to_ıu
(
de
->
šo
);

398 
	`f2fs_put_·ge
(*
·ge
, 0);

401  
»s
;

402 
	}
}

404 
	$f2fs_£t_lšk
(
šode
 *
dœ
, 
f2fs_dœ_’Œy
 *
de
,

405 
·ge
 *·ge, 
šode
 *inode)

407 
·ge_ty³
 
ty³
 = 
	`f2fs_has_šlše_d’Œy
(
dœ
è? 
NODE
 : 
DATA
;

408 
	`lock_·ge
(
·ge
);

409 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
ty³
, 
Œue
,rue);

410 
de
->
šo
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

411 
	`£t_de_ty³
(
de
, 
šode
->
i_mode
);

412 
	`£t_·ge_dœty
(
·ge
);

414 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
	`cu¼’t_time
(dir);

415 
	`f2fs_m¬k_šode_dœty_sync
(
dœ
, 
çl£
);

416 
	`f2fs_put_·ge
(
·ge
, 1);

417 
	}
}

419 
	$š™_d’t_šode
(cÚ¡ 
q¡r
 *
Çme
, 
·ge
 *
age
)

421 
f2fs_šode
 *
ri
;

423 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
,rue);

426 
ri
 = 
	`F2FS_INODE
(
age
);

427 
ri
->
i_Çm–’
 = 
	`ıu_to_Ë32
(
Çme
->
Ën
);

428 
	`memıy
(
ri
->
i_Çme
, 
Çme
->Çme,‚ame->
Ën
);

429 
	`£t_·ge_dœty
(
age
);

430 
	}
}

432 
	$f2fs_do_make_em±y_dœ
(
šode
 *šode, šod*
·»Á
,

433 
f2fs_d’Œy_±r
 *
d
)

435 
q¡r
 
dÙ
 = 
	`QSTR_INIT
(".", 1);

436 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

439 
	`f2fs_upd©e_d’Œy
(
šode
->
i_šo
, inode->
i_mode
, 
d
, &
dÙ
, 0, 0);

442 
	`f2fs_upd©e_d’Œy
(
·»Á
->
i_šo
,…¬’t->
i_mode
, 
d
, &
dÙdÙ
, 0, 1);

443 
	}
}

445 
	$make_em±y_dœ
(
šode
 *inode,

446 
šode
 *
·»Á
, 
·ge
 *page)

448 
·ge
 *
d’Œy_·ge
;

449 
f2fs_d’Œy_block
 *
d’Œy_blk
;

450 
f2fs_d’Œy_±r
 
d
;

452 ià(
	`f2fs_has_šlše_d’Œy
(
šode
))

453  
	`f2fs_make_em±y_šlše_dœ
(
šode
, 
·»Á
, 
·ge
);

455 
d’Œy_·ge
 = 
	`f2fs_g‘_Ãw_d©a_·ge
(
šode
, 
·ge
, 0, 
Œue
);

456 ià(
	`IS_ERR
(
d’Œy_·ge
))

457  
	`PTR_ERR
(
d’Œy_·ge
);

459 
d’Œy_blk
 = 
	`·ge_add»ss
(
d’Œy_·ge
);

461 
	`make_d’Œy_±r_block
(
NULL
, &
d
, 
d’Œy_blk
);

462 
	`f2fs_do_make_em±y_dœ
(
šode
, 
·»Á
, &
d
);

464 
	`£t_·ge_dœty
(
d’Œy_·ge
);

465 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

467 
	}
}

469 
·ge
 *
	$f2fs_š™_šode_m‘ad©a
(
šode
 *šode, šod*
dœ
,

470 cÚ¡ 
q¡r
 *
Ãw_Çme
, cÚ¡ q¡¸*
Üig_Çme
,

471 
·ge
 *
d·ge
)

473 
·ge
 *page;

474 
dummy_’üy±
 = 
	`DUMMY_ENCRYPTION_ENABLED
(
	`F2FS_I_SB
(
dœ
));

475 
”r
;

477 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NEW_INODE
)) {

478 
·ge
 = 
	`f2fs_Ãw_šode_·ge
(
šode
);

479 ià(
	`IS_ERR
(
·ge
))

480  
·ge
;

482 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

484 
	`g‘_·ge
(
·ge
);

485 
”r
 = 
	`make_em±y_dœ
(
šode
, 
dœ
, 
·ge
);

486 ià(
”r
) {

487 
	`lock_·ge
(
·ge
);

488 
put_”rÜ
;

490 
	`put_·ge
(
·ge
);

493 
”r
 = 
	`f2fs_š™_aş
(
šode
, 
dœ
, 
·ge
, 
d·ge
);

494 ià(
”r
)

495 
put_”rÜ
;

497 
”r
 = 
	`f2fs_š™_£cur™y
(
šode
, 
dœ
, 
Üig_Çme
, 
·ge
);

498 ià(
”r
)

499 
put_”rÜ
;

501 ià((
	`IS_ENCRYPTED
(
dœ
è|| 
dummy_’üy±
) &&

502 
	`f2fs_may_’üy±
(
šode
)) {

503 
”r
 = 
	`fsüy±_šh”™_cÚ‹xt
(
dœ
, 
šode
, 
·ge
, 
çl£
);

504 ià(
”r
)

505 
put_”rÜ
;

508 
·ge
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
dœ
), 
šode
->
i_šo
);

509 ià(
	`IS_ERR
(
·ge
))

510  
·ge
;

513 ià(
Ãw_Çme
) {

514 
	`š™_d’t_šode
(
Ãw_Çme
, 
·ge
);

515 ià(
	`IS_ENCRYPTED
(
dœ
))

516 
	`fe_£t_’c_Çme
(
šode
);

523 ià(
	`is_šode_æag_£t
(
šode
, 
FI_INC_LINK
)) {

524 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

525 
	`fe_lo¡_pšo
(
šode
);

530 ià(
šode
->
i_Æšk
 == 0)

531 
	`f2fs_»move_Üphª_šode
(
	`F2FS_I_SB
(
dœ
), 
šode
->
i_šo
);

532 
	`f2fs_i_lšks_wr™e
(
šode
, 
Œue
);

534  
·ge
;

536 
put_”rÜ
:

537 
	`ş—r_Æšk
(
šode
);

538 
	`f2fs_upd©e_šode
(
šode
, 
·ge
);

539 
	`f2fs_put_·ge
(
·ge
, 1);

540  
	`ERR_PTR
(
”r
);

541 
	}
}

543 
	$f2fs_upd©e_·»Á_m‘ad©a
(
šode
 *
dœ
, inode *inode,

544 
cu¼’t_d•th
)

546 ià(
šode
 && 
	`is_šode_æag_£t
(šode, 
FI_NEW_INODE
)) {

547 ià(
	`S_ISDIR
(
šode
->
i_mode
))

548 
	`f2fs_i_lšks_wr™e
(
dœ
, 
Œue
);

549 
	`ş—r_šode_æag
(
šode
, 
FI_NEW_INODE
);

551 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
	`cu¼’t_time
(dir);

552 
	`f2fs_m¬k_šode_dœty_sync
(
dœ
, 
çl£
);

554 ià(
	`F2FS_I
(
dœ
)->
i_cu¼’t_d•th
 !ğ
cu¼’t_d•th
)

555 
	`f2fs_i_d•th_wr™e
(
dœ
, 
cu¼’t_d•th
);

557 ià(
šode
 && 
	`is_šode_æag_£t
(šode, 
FI_INC_LINK
))

558 
	`ş—r_šode_æag
(
šode
, 
FI_INC_LINK
);

559 
	}
}

561 
	$f2fs_room_fÜ_f’ame
(cÚ¡ *
b™m­
, 
¦Ùs
, 
max_¦Ùs
)

563 
b™_¡¬t
 = 0;

564 
z”o_¡¬t
, 
z”o_’d
;

565 
Ãxt
:

566 
z”o_¡¬t
 = 
	`fšd_Ãxt_z”o_b™_Ë
(
b™m­
, 
max_¦Ùs
, 
b™_¡¬t
);

567 ià(
z”o_¡¬t
 >ğ
max_¦Ùs
)

568  
max_¦Ùs
;

570 
z”o_’d
 = 
	`fšd_Ãxt_b™_Ë
(
b™m­
, 
max_¦Ùs
, 
z”o_¡¬t
);

571 ià(
z”o_’d
 - 
z”o_¡¬t
 >ğ
¦Ùs
)

572  
z”o_¡¬t
;

574 
b™_¡¬t
 = 
z”o_’d
 + 1;

576 ià(
z”o_’d
 + 1 >ğ
max_¦Ùs
)

577  
max_¦Ùs
;

578 
Ãxt
;

579 
	}
}

581 
	$f2fs_upd©e_d’Œy
(
nid_t
 
šo
, 
umode_t
 
mode
, 
f2fs_d’Œy_±r
 *
d
,

582 cÚ¡ 
q¡r
 *
Çme
, 
f2fs_hash_t
 
Çme_hash
,

583 
b™_pos
)

585 
f2fs_dœ_’Œy
 *
de
;

586 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
Çme
->
Ën
);

587 
i
;

589 
de
 = &
d
->
d’Œy
[
b™_pos
];

590 
de
->
hash_code
 = 
Çme_hash
;

591 
de
->
Çme_Ën
 = 
	`ıu_to_Ë16
(
Çme
->
Ën
);

592 
	`memıy
(
d
->
f’ame
[
b™_pos
], 
Çme
->Çme,‚ame->
Ën
);

593 
de
->
šo
 = 
	`ıu_to_Ë32
(ino);

594 
	`£t_de_ty³
(
de
, 
mode
);

595 
i
 = 0; i < 
¦Ùs
; i++) {

596 
	`__£t_b™_Ë
(
b™_pos
 + 
i
, (*)
d
->
b™m­
);

598 ià(
i
)

599 (
de
 + 
i
)->
Çme_Ën
 = 0;

601 
	}
}

603 
	$f2fs_add_»guÏr_’Œy
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Ãw_Çme
,

604 cÚ¡ 
q¡r
 *
Üig_Çme
,

605 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
)

607 
b™_pos
;

608 
Ëv–
;

609 
cu¼’t_d•th
;

610 
bidx
, 
block
;

611 
f2fs_hash_t
 
d’Œy_hash
;

612 
nbuck‘
, 
nblock
;

613 
·ge
 *
d’Œy_·ge
 = 
NULL
;

614 
f2fs_d’Œy_block
 *
d’Œy_blk
 = 
NULL
;

615 
f2fs_d’Œy_±r
 
d
;

616 
·ge
 *·gğ
NULL
;

617 
¦Ùs
, 
”r
 = 0;

619 
Ëv–
 = 0;

620 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
Ãw_Çme
->
Ën
);

621 
d’Œy_hash
 = 
	`f2fs_d’Œy_hash
(
dœ
, 
Ãw_Çme
, 
NULL
);

623 
cu¼’t_d•th
 = 
	`F2FS_I
(
dœ
)->
i_cu¼’t_d•th
;

624 ià(
	`F2FS_I
(
dœ
)->
chash
 =ğ
d’Œy_hash
) {

625 
Ëv–
 = 
	`F2FS_I
(
dœ
)->
şev–
;

626 
	`F2FS_I
(
dœ
)->
chash
 = 0;

629 
¡¬t
:

630 ià(
	`time_to_šjeù
(
	`F2FS_I_SB
(
dœ
), 
FAULT_DIR_DEPTH
)) {

631 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_DIR_DEPTH
);

632  -
ENOSPC
;

635 ià(
	`uÆik–y
(
cu¼’t_d•th
 =ğ
MAX_DIR_HASH_DEPTH
))

636  -
ENOSPC
;

639 ià(
Ëv–
 =ğ
cu¼’t_d•th
)

640 ++
cu¼’t_d•th
;

642 
nbuck‘
 = 
	`dœ_buck‘s
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
);

643 
nblock
 = 
	`buck‘_blocks
(
Ëv–
);

645 
bidx
 = 
	`dœ_block_šdex
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
,

646 (
	`Ë32_to_ıu
(
d’Œy_hash
è% 
nbuck‘
));

648 
block
 = 
bidx
; block <ğ(bidx + 
nblock
 - 1); block++) {

649 
d’Œy_·ge
 = 
	`f2fs_g‘_Ãw_d©a_·ge
(
dœ
, 
NULL
, 
block
, 
Œue
);

650 ià(
	`IS_ERR
(
d’Œy_·ge
))

651  
	`PTR_ERR
(
d’Œy_·ge
);

653 
d’Œy_blk
 = 
	`·ge_add»ss
(
d’Œy_·ge
);

654 
b™_pos
 = 
	`f2fs_room_fÜ_f’ame
(&
d’Œy_blk
->
d’Œy_b™m­
,

655 
¦Ùs
, 
NR_DENTRY_IN_BLOCK
);

656 ià(
b™_pos
 < 
NR_DENTRY_IN_BLOCK
)

657 
add_d’Œy
;

659 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

663 ++
Ëv–
;

664 
¡¬t
;

665 
add_d’Œy
:

666 
	`f2fs_wa™_Ú_·ge_wr™eback
(
d’Œy_·ge
, 
DATA
, 
Œue
,rue);

668 ià(
šode
) {

669 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

670 
·ge
 = 
	`f2fs_š™_šode_m‘ad©a
(
šode
, 
dœ
, 
Ãw_Çme
,

671 
Üig_Çme
, 
NULL
);

672 ià(
	`IS_ERR
(
·ge
)) {

673 
”r
 = 
	`PTR_ERR
(
·ge
);

674 
ç
;

678 
	`make_d’Œy_±r_block
(
NULL
, &
d
, 
d’Œy_blk
);

679 
	`f2fs_upd©e_d’Œy
(
šo
, 
mode
, &
d
, 
Ãw_Çme
, 
d’Œy_hash
, 
b™_pos
);

681 
	`£t_·ge_dœty
(
d’Œy_·ge
);

683 ià(
šode
) {

684 
	`f2fs_i_pšo_wr™e
(
šode
, 
dœ
->
i_šo
);

687 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NEW_INODE
))

688 
	`f2fs_upd©e_šode
(
šode
, 
·ge
);

690 
	`f2fs_put_·ge
(
·ge
, 1);

693 
	`f2fs_upd©e_·»Á_m‘ad©a
(
dœ
, 
šode
, 
cu¼’t_d•th
);

694 
ç
:

695 ià(
šode
)

696 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

698 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

700  
”r
;

701 
	}
}

703 
	$f2fs_add_d’Œy
(
šode
 *
dœ
, 
fsüy±_Çme
 *
âame
,

704 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
)

706 
q¡r
 
Ãw_Çme
;

707 
”r
 = -
EAGAIN
;

709 
Ãw_Çme
.
Çme
 = 
	`âame_Çme
(
âame
);

710 
Ãw_Çme
.
Ën
 = 
	`âame_Ën
(
âame
);

712 ià(
	`f2fs_has_šlše_d’Œy
(
dœ
))

713 
”r
 = 
	`f2fs_add_šlše_’Œy
(
dœ
, &
Ãw_Çme
, 
âame
->
u¤_âame
,

714 
šode
, 
šo
, 
mode
);

715 ià(
”r
 =ğ-
EAGAIN
)

716 
”r
 = 
	`f2fs_add_»guÏr_’Œy
(
dœ
, &
Ãw_Çme
, 
âame
->
u¤_âame
,

717 
šode
, 
šo
, 
mode
);

719 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
dœ
), 
REQ_TIME
);

720  
”r
;

721 
	}
}

727 
	$f2fs_do_add_lšk
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Çme
,

728 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
)

730 
fsüy±_Çme
 
âame
;

731 
·ge
 *·gğ
NULL
;

732 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

733 
”r
;

735 
”r
 = 
	`fsüy±_£tup_f’ame
(
dœ
, 
Çme
, 0, &
âame
);

736 ià(
”r
)

737  
”r
;

746 ià(
cu¼’t
 !ğ
	`F2FS_I
(
dœ
)->
sk
) {

747 
de
 = 
	`__f2fs_fšd_’Œy
(
dœ
, &
âame
, &
·ge
);

748 
	`F2FS_I
(
dœ
)->
sk
 = 
NULL
;

750 ià(
de
) {

751 
	`f2fs_put_·ge
(
·ge
, 0);

752 
”r
 = -
EEXIST
;

753 } ià(
	`IS_ERR
(
·ge
)) {

754 
”r
 = 
	`PTR_ERR
(
·ge
);

756 
”r
 = 
	`f2fs_add_d’Œy
(
dœ
, &
âame
, 
šode
, 
šo
, 
mode
);

758 
	`fsüy±_ä“_f’ame
(&
âame
);

759  
”r
;

760 
	}
}

762 
	$f2fs_do_tmpfe
(
šode
 *šode, šod*
dœ
)

764 
·ge
 *page;

765 
”r
 = 0;

767 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

768 
·ge
 = 
	`f2fs_š™_šode_m‘ad©a
(
šode
, 
dœ
, 
NULL
, NULL, NULL);

769 ià(
	`IS_ERR
(
·ge
)) {

770 
”r
 = 
	`PTR_ERR
(
·ge
);

771 
ç
;

773 
	`f2fs_put_·ge
(
·ge
, 1);

775 
	`ş—r_šode_æag
(
šode
, 
FI_NEW_INODE
);

776 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

777 
ç
:

778 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

779  
”r
;

780 
	}
}

782 
	$f2fs_drİ_Æšk
(
šode
 *
dœ
, inode *inode)

784 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

786 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

788 ià(
	`S_ISDIR
(
šode
->
i_mode
))

789 
	`f2fs_i_lšks_wr™e
(
dœ
, 
çl£
);

790 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

792 
	`f2fs_i_lšks_wr™e
(
šode
, 
çl£
);

793 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

794 
	`f2fs_i_lšks_wr™e
(
šode
, 
çl£
);

795 
	`f2fs_i_size_wr™e
(
šode
, 0);

797 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

799 ià(
šode
->
i_Æšk
 == 0)

800 
	`f2fs_add_Üphª_šode
(
šode
);

802 
	`f2fs_»Ëa£_Üphª_šode
(
sbi
);

803 
	}
}

809 
	$f2fs_d–‘e_’Œy
(
f2fs_dœ_’Œy
 *
d’Œy
, 
·ge
 *page,

810 
šode
 *
dœ
, inode *inode)

812 
f2fs_d’Œy_block
 *
d’Œy_blk
;

813 
b™_pos
;

814 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
d’Œy
->
Çme_Ën
));

815 
i
;

817 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
dœ
), 
REQ_TIME
);

819 ià(
	`F2FS_OPTION
(
	`F2FS_I_SB
(
dœ
)).
fsync_mode
 =ğ
FSYNC_MODE_STRICT
)

820 
	`f2fs_add_šo_’Œy
(
	`F2FS_I_SB
(
dœ
), dœ->
i_šo
, 
TRANS_DIR_INO
);

822 ià(
	`f2fs_has_šlše_d’Œy
(
dœ
))

823  
	`f2fs_d–‘e_šlše_’Œy
(
d’Œy
, 
·ge
, 
dœ
, 
šode
);

825 
	`lock_·ge
(
·ge
);

826 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
,rue);

828 
d’Œy_blk
 = 
	`·ge_add»ss
(
·ge
);

829 
b™_pos
 = 
d’Œy
 - 
d’Œy_blk
->dentry;

830 
i
 = 0; i < 
¦Ùs
; i++)

831 
	`__ş—r_b™_Ë
(
b™_pos
 + 
i
, &
d’Œy_blk
->
d’Œy_b™m­
);

834 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(&
d’Œy_blk
->
d’Œy_b™m­
,

835 
NR_DENTRY_IN_BLOCK
,

837 
	`£t_·ge_dœty
(
·ge
);

839 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
	`cu¼’t_time
(dir);

840 
	`f2fs_m¬k_šode_dœty_sync
(
dœ
, 
çl£
);

842 ià(
šode
)

843 
	`f2fs_drİ_Æšk
(
dœ
, 
šode
);

845 ià(
b™_pos
 =ğ
NR_DENTRY_IN_BLOCK
 &&

846 !
	`f2fs_Œunÿ‹_hŞe
(
dœ
, 
·ge
->
šdex
,…age->index + 1)) {

847 
	`f2fs_ş—r_·ge_ÿche_dœty_g
(
·ge
);

848 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

849 
	`f2fs_ş—r_·ge_´iv©e
(
·ge
);

850 
	`CË¬PageU±od©e
(
·ge
);

851 
	`ş—r_cŞd_d©a
(
·ge
);

852 
	`šode_dec_dœty_·ges
(
dœ
);

853 
	`f2fs_»move_dœty_šode
(
dœ
);

855 
	`f2fs_put_·ge
(
·ge
, 1);

856 
	}
}

858 
boŞ
 
	$f2fs_em±y_dœ
(
šode
 *
dœ
)

860 
bidx
;

861 
·ge
 *
d’Œy_·ge
;

862 
b™_pos
;

863 
f2fs_d’Œy_block
 *
d’Œy_blk
;

864 
nblock
 = 
	`dœ_blocks
(
dœ
);

866 ià(
	`f2fs_has_šlše_d’Œy
(
dœ
))

867  
	`f2fs_em±y_šlše_dœ
(
dœ
);

869 
bidx
 = 0; bidx < 
nblock
; bidx++) {

870 
d’Œy_·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
dœ
, 
bidx
, 
çl£
);

871 ià(
	`IS_ERR
(
d’Œy_·ge
)) {

872 ià(
	`PTR_ERR
(
d’Œy_·ge
è=ğ-
ENOENT
)

875  
çl£
;

878 
d’Œy_blk
 = 
	`·ge_add»ss
(
d’Œy_·ge
);

879 ià(
bidx
 == 0)

880 
b™_pos
 = 2;

882 
b™_pos
 = 0;

883 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(&
d’Œy_blk
->
d’Œy_b™m­
,

884 
NR_DENTRY_IN_BLOCK
,

885 
b™_pos
);

887 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

889 ià(
b™_pos
 < 
NR_DENTRY_IN_BLOCK
)

890  
çl£
;

892  
Œue
;

893 
	}
}

895 
	$f2fs_fl_d’Œ›s
(
dœ_cÚ‹xt
 *
ùx
, 
f2fs_d’Œy_±r
 *
d
,

896 
¡¬t_pos
, 
fsüy±_¡r
 *
f¡r
)

898 
d_ty³
 = 
DT_UNKNOWN
;

899 
b™_pos
;

900 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

901 
fsüy±_¡r
 
de_Çme
 = 
	`FSTR_INIT
(
NULL
, 0);

902 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
d
->
šode
);

903 
blk_¶ug
 
¶ug
;

904 
boŞ
 
»addœ_¿
 = 
sbi
->readdir_ra == 1;

905 
”r
 = 0;

907 
b™_pos
 = (()
ùx
->
pos
 % 
d
->
max
);

909 ià(
»addœ_¿
)

910 
	`blk_¡¬t_¶ug
(&
¶ug
);

912 
b™_pos
 < 
d
->
max
) {

913 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(
d
->
b™m­
, d->
max
, bit_pos);

914 ià(
b™_pos
 >ğ
d
->
max
)

917 
de
 = &
d
->
d’Œy
[
b™_pos
];

918 ià(
de
->
Çme_Ën
 == 0) {

919 
b™_pos
++;

920 
ùx
->
pos
 = 
¡¬t_pos
 + 
b™_pos
;

921 
	`´štk_¿‹lim™ed
(

923 
KERN_WARNING
, 
	`Ë32_to_ıu
(
de
->
šo
));

924 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

928 
d_ty³
 = 
	`f2fs_g‘_de_ty³
(
de
);

930 
de_Çme
.
Çme
 = 
d
->
f’ame
[
b™_pos
];

931 
de_Çme
.
Ën
 = 
	`Ë16_to_ıu
(
de
->
Çme_Ën
);

934 
b™_pos
 +ğ
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
de
->
Çme_Ën
));

935 ià(
	`uÆik–y
(
b™_pos
 > 
d
->
max
 ||

936 
	`Ë16_to_ıu
(
de
->
Çme_Ën
è> 
F2FS_NAME_LEN
)) {

937 
	`f2fs_w¬n
(
sbi
, "%s: corrupted‚amelen=%d,„un fscko fix.",

938 
__func__
, 
	`Ë16_to_ıu
(
de
->
Çme_Ën
));

939 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

940 
”r
 = -
EFSCORRUPTED
;

941 
out
;

944 ià(
	`IS_ENCRYPTED
(
d
->
šode
)) {

945 
§ve_Ën
 = 
f¡r
->
Ën
;

947 
”r
 = 
	`fsüy±_âame_disk_to_u¤
(
d
->
šode
,

948 (
u32
)
	`Ë32_to_ıu
(
de
->
hash_code
),

949 0, &
de_Çme
, 
f¡r
);

950 ià(
”r
)

951 
out
;

953 
de_Çme
 = *
f¡r
;

954 
f¡r
->
Ën
 = 
§ve_Ën
;

957 ià(!
	`dœ_em™
(
ùx
, 
de_Çme
.
Çme
, de_Çme.
Ën
,

958 
	`Ë32_to_ıu
(
de
->
šo
), 
d_ty³
)) {

959 
”r
 = 1;

960 
out
;

963 ià(
»addœ_¿
)

964 
	`f2fs_¿_node_·ge
(
sbi
, 
	`Ë32_to_ıu
(
de
->
šo
));

966 
ùx
->
pos
 = 
¡¬t_pos
 + 
b™_pos
;

968 
out
:

969 ià(
»addœ_¿
)

970 
	`blk_fšish_¶ug
(&
¶ug
);

971  
”r
;

972 
	}
}

974 
	$f2fs_»addœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
)

976 
šode
 *šodğ
	`fe_šode
(
fe
);

977 
Åages
 = 
	`dœ_blocks
(
šode
);

978 
f2fs_d’Œy_block
 *
d’Œy_blk
 = 
NULL
;

979 
·ge
 *
d’Œy_·ge
 = 
NULL
;

980 
fe_¿_¡©e
 *
¿
 = &
fe
->
f_¿
;

981 
loff_t
 
¡¬t_pos
 = 
ùx
->
pos
;

982 
n
 = (()
ùx
->
pos
 / 
NR_DENTRY_IN_BLOCK
);

983 
f2fs_d’Œy_±r
 
d
;

984 
fsüy±_¡r
 
f¡r
 = 
	`FSTR_INIT
(
NULL
, 0);

985 
”r
 = 0;

987 ià(
	`IS_ENCRYPTED
(
šode
)) {

988 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
);

989 ià(
”r
 &&ƒ¼ !ğ-
ENOKEY
)

990 
out
;

992 
”r
 = 
	`fsüy±_âame_®loc_bufãr
(
šode
, 
F2FS_NAME_LEN
, &
f¡r
);

993 ià(
”r
 < 0)

994 
out
;

997 ià(
	`f2fs_has_šlše_d’Œy
(
šode
)) {

998 
”r
 = 
	`f2fs_»ad_šlše_dœ
(
fe
, 
ùx
, &
f¡r
);

999 
out_ä“
;

1002 ; 
n
 < 
Åages
;‚++, 
ùx
->
pos
 =‚ * 
NR_DENTRY_IN_BLOCK
) {

1005 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

1006 
”r
 = -
ERESTARTSYS
;

1007 
out_ä“
;

1009 
	`cÚd_»sched
();

1012 ià(
Åages
 - 
n
 > 1 && !
	`¿_has_šdex
(
¿
,‚))

1013 
	`·ge_ÿche_sync_»adah—d
(
šode
->
i_m­pšg
, 
¿
, 
fe
, 
n
,

1014 
	`mš
(
Åages
 - 
n
, (
pgoff_t
)
MAX_DIR_RA_PAGES
));

1016 
d’Œy_·ge
 = 
	`f2fs_fšd_d©a_·ge
(
šode
, 
n
);

1017 ià(
	`IS_ERR
(
d’Œy_·ge
)) {

1018 
”r
 = 
	`PTR_ERR
(
d’Œy_·ge
);

1019 ià(
”r
 =ğ-
ENOENT
) {

1020 
”r
 = 0;

1023 
out_ä“
;

1027 
d’Œy_blk
 = 
	`·ge_add»ss
(
d’Œy_·ge
);

1029 
	`make_d’Œy_±r_block
(
šode
, &
d
, 
d’Œy_blk
);

1031 
”r
 = 
	`f2fs_fl_d’Œ›s
(
ùx
, &
d
,

1032 
n
 * 
NR_DENTRY_IN_BLOCK
, &
f¡r
);

1033 ià(
”r
) {

1034 
	`f2fs_put_·ge
(
d’Œy_·ge
, 0);

1038 
	`f2fs_put_·ge
(
d’Œy_·ge
, 0);

1040 
out_ä“
:

1041 
	`fsüy±_âame_ä“_bufãr
(&
f¡r
);

1042 
out
:

1043 
	`Œaû_f2fs_»addœ
(
šode
, 
¡¬t_pos
, 
ùx
->
pos
, 
”r
);

1044  
”r
 < 0 ?ƒrr : 0;

1045 
	}
}

1047 
	$f2fs_dœ_İ’
(
šode
 *šode, 
fe
 *
fp
)

1049 ià(
	`IS_ENCRYPTED
(
šode
))

1050  
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
è? -
EACCES
 : 0;

1052 
	}
}

1054 cÚ¡ 
fe_İ”©iÚs
 
	gf2fs_dœ_İ”©iÚs
 = {

1055 .
Î£ek
 = 
g’”ic_fe_Î£ek
,

1056 .
	g»ad
 = 
g’”ic_»ad_dœ
,

1057 .
	g™”©e_sh¬ed
 = 
f2fs_»addœ
,

1058 .
	gfsync
 = 
f2fs_sync_fe
,

1059 .
	gİ’
 = 
f2fs_dœ_İ’
,

1060 .
	guÆocked_ioùl
 = 
f2fs_ioùl
,

1061 #ifdeà
CONFIG_COMPAT


1062 .
	gcom·t_ioùl
 = 
f2fs_com·t_ioùl
,

1066 #ifdeà
CONFIG_UNICODE


1067 
	$f2fs_d_com·»
(cÚ¡ 
d’Œy
 *d’Œy, 
Ën
,

1068 cÚ¡ *
¡r
, cÚ¡ 
q¡r
 *
Çme
)

1070 
q¡r
 q¡¸ğ{.
Çme
 = 
¡r
, .
Ën
 =†en };

1071 cÚ¡ 
d’Œy
 *
·»Á
 = 
	`READ_ONCE
(d’Œy->
d_·»Á
);

1072 cÚ¡ 
šode
 *šodğ
	`READ_ONCE
(
·»Á
->
d_šode
);

1074 ià(!
šode
 || !
	`IS_CASEFOLDED
(inode)) {

1075 ià(
Ën
 !ğ
Çme
->len)

1077  
	`memcmp
(
¡r
, 
Çme
->Çme, 
Ën
);

1080  
	`f2fs_ci_com·»
(
šode
, 
Çme
, &
q¡r
, 
çl£
);

1081 
	}
}

1083 
	$f2fs_d_hash
(cÚ¡ 
d’Œy
 *d’Œy, 
q¡r
 *
¡r
)

1085 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
d’Œy
->
d_sb
);

1086 cÚ¡ 
unicode_m­
 *
um
 = 
sbi
->
s_’codšg
;

1087 cÚ¡ 
šode
 *šodğ
	`READ_ONCE
(
d’Œy
->
d_šode
);

1088 *
nÜm
;

1089 
Ën
, 
»t
 = 0;

1091 ià(!
šode
 || !
	`IS_CASEFOLDED
(inode))

1094 
nÜm
 = 
	`f2fs_km®loc
(
sbi
, 
PATH_MAX
, 
GFP_ATOMIC
);

1095 ià(!
nÜm
)

1096  -
ENOMEM
;

1098 
Ën
 = 
	`utf8_ÿ£fŞd
(
um
, 
¡r
, 
nÜm
, 
PATH_MAX
);

1099 ià(
Ën
 < 0) {

1100 ià(
	`f2fs_has_¡riù_mode
(
sbi
))

1101 
»t
 = -
EINVAL
;

1102 
out
;

1104 
¡r
->
hash
 = 
	`fuÎ_Çme_hash
(
d’Œy
, 
nÜm
, 
Ën
);

1105 
out
:

1106 
	`kvä“
(
nÜm
);

1107  
»t
;

1108 
	}
}

1110 cÚ¡ 
d’Œy_İ”©iÚs
 
	gf2fs_d’Œy_İs
 = {

1111 .
d_hash
 = 
f2fs_d_hash
,

1112 .
	gd_com·»
 = 
f2fs_d_com·»
,

	@extent_cache.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

14 
	~"f2fs.h
"

15 
	~"node.h
"

16 
	~<Œaû/ev’ts/f2fs.h
>

18 
rb_’Œy
 *
	$__lookup_rb_Œ“_ç¡
(
rb_’Œy
 *
ÿched_»
,

19 
ofs
)

21 ià(
ÿched_»
) {

22 ià(
ÿched_»
->
ofs
 <= ofs &&

23 
ÿched_»
->
ofs
 + cached_»->
Ën
 > ofs) {

24  
ÿched_»
;

27  
NULL
;

28 
	}
}

30 
rb_’Œy
 *
	$__lookup_rb_Œ“_¦ow
(
rb_roÙ_ÿched
 *
roÙ
,

31 
ofs
)

33 
rb_node
 *
node
 = 
roÙ
->
rb_roÙ
.rb_node;

34 
rb_’Œy
 *
»
;

36 
node
) {

37 
»
 = 
	`rb_’Œy
(
node
, 
rb_’Œy
, 
rb_node
);

39 ià(
ofs
 < 
»
->ofs)

40 
node
 =‚ode->
rb_Ëá
;

41 ià(
ofs
 >ğ
»
->of +„e->
Ën
)

42 
node
 =‚ode->
rb_right
;

44  
»
;

46  
NULL
;

47 
	}
}

49 
rb_’Œy
 *
	$f2fs_lookup_rb_Œ“
(
rb_roÙ_ÿched
 *
roÙ
,

50 
rb_’Œy
 *
ÿched_»
, 
ofs
)

52 
rb_’Œy
 *
»
;

54 
»
 = 
	`__lookup_rb_Œ“_ç¡
(
ÿched_»
, 
ofs
);

55 ià(!
»
)

56  
	`__lookup_rb_Œ“_¦ow
(
roÙ
, 
ofs
);

58  
»
;

59 
	}
}

61 
rb_node
 **
	$f2fs_lookup_rb_Œ“_fÜ_š£¹
(
f2fs_sb_šfo
 *
sbi
,

62 
rb_roÙ_ÿched
 *
roÙ
,

63 
rb_node
 **
·»Á
,

64 
ofs
, 
boŞ
 *
Ëámo¡
)

66 
rb_node
 **
p
 = &
roÙ
->
rb_roÙ
.rb_node;

67 
rb_’Œy
 *
»
;

69 *
p
) {

70 *
·»Á
 = *
p
;

71 
»
 = 
	`rb_’Œy
(*
·»Á
, 
rb_’Œy
, 
rb_node
);

73 ià(
ofs
 < 
»
->ofs) {

74 
p
 = &(*p)->
rb_Ëá
;

75 } ià(
ofs
 >ğ
»
->of +„e->
Ën
) {

76 
p
 = &(*p)->
rb_right
;

77 *
Ëámo¡
 = 
çl£
;

79 
	`f2fs_bug_Ú
(
sbi
, 1);

83  
p
;

84 
	}
}

95 
rb_’Œy
 *
	$f2fs_lookup_rb_Œ“_»t
(
rb_roÙ_ÿched
 *
roÙ
,

96 
rb_’Œy
 *
ÿched_»
,

97 
ofs
,

98 
rb_’Œy
 **
´ev_’Œy
,

99 
rb_’Œy
 **
Ãxt_’Œy
,

100 
rb_node
 ***
š£¹_p
,

101 
rb_node
 **
š£¹_·»Á
,

102 
boŞ
 
fÜû
, boŞ *
Ëámo¡
)

104 
rb_node
 **
²ode
 = &
roÙ
->
rb_roÙ
.rb_node;

105 
rb_node
 *
·»Á
 = 
NULL
, *
tmp_node
;

106 
rb_’Œy
 *
»
 = 
ÿched_»
;

108 *
š£¹_p
 = 
NULL
;

109 *
š£¹_·»Á
 = 
NULL
;

110 *
´ev_’Œy
 = 
NULL
;

111 *
Ãxt_’Œy
 = 
NULL
;

113 ià(
	`RB_EMPTY_ROOT
(&
roÙ
->
rb_roÙ
))

114  
NULL
;

116 ià(
»
) {

117 ià(
»
->
ofs
 <ğof &&„e->of +„e->
Ën
 > ofs)

118 
lookup_ÃighbÜs
;

121 ià(
Ëámo¡
)

122 *
Ëámo¡
 = 
Œue
;

124 *
²ode
) {

125 
·»Á
 = *
²ode
;

126 
»
 = 
	`rb_’Œy
(*
²ode
, 
rb_’Œy
, 
rb_node
);

128 ià(
ofs
 < 
»
->ofs) {

129 
²ode
 = &(*²ode)->
rb_Ëá
;

130 } ià(
ofs
 >ğ
»
->of +„e->
Ën
) {

131 
²ode
 = &(*²ode)->
rb_right
;

132 ià(
Ëámo¡
)

133 *
Ëámo¡
 = 
çl£
;

135 
lookup_ÃighbÜs
;

139 *
š£¹_p
 = 
²ode
;

140 *
š£¹_·»Á
 = 
·»Á
;

142 
»
 = 
	`rb_’Œy
(
·»Á
, 
rb_’Œy
, 
rb_node
);

143 
tmp_node
 = 
·»Á
;

144 ià(
·»Á
 && 
ofs
 > 
»
->ofs)

145 
tmp_node
 = 
	`rb_Ãxt
(
·»Á
);

146 *
Ãxt_’Œy
 = 
	`rb_’Œy_§ã
(
tmp_node
, 
rb_’Œy
, 
rb_node
);

148 
tmp_node
 = 
·»Á
;

149 ià(
·»Á
 && 
ofs
 < 
»
->ofs)

150 
tmp_node
 = 
	`rb_´ev
(
·»Á
);

151 *
´ev_’Œy
 = 
	`rb_’Œy_§ã
(
tmp_node
, 
rb_’Œy
, 
rb_node
);

152  
NULL
;

154 
lookup_ÃighbÜs
:

155 ià(
ofs
 =ğ
»
->of || 
fÜû
) {

157 
tmp_node
 = 
	`rb_´ev
(&
»
->
rb_node
);

158 *
´ev_’Œy
 = 
	`rb_’Œy_§ã
(
tmp_node
, 
rb_’Œy
, 
rb_node
);

160 ià(
ofs
 =ğ
»
->of +„e->
Ën
 - 1 || 
fÜû
) {

162 
tmp_node
 = 
	`rb_Ãxt
(&
»
->
rb_node
);

163 *
Ãxt_’Œy
 = 
	`rb_’Œy_§ã
(
tmp_node
, 
rb_’Œy
, 
rb_node
);

165  
»
;

166 
	}
}

168 
boŞ
 
	$f2fs_check_rb_Œ“_cÚsi¡’û
(
f2fs_sb_šfo
 *
sbi
,

169 
rb_roÙ_ÿched
 *
roÙ
)

171 #ifdeà
CONFIG_F2FS_CHECK_FS


172 
rb_node
 *
cur
 = 
	`rb_fœ¡_ÿched
(
roÙ
), *
Ãxt
;

173 
rb_’Œy
 *
cur_»
, *
Ãxt_»
;

175 ià(!
cur
)

176  
Œue
;

178 
cur
) {

179 
Ãxt
 = 
	`rb_Ãxt
(
cur
);

180 ià(!
Ãxt
)

181  
Œue
;

183 
cur_»
 = 
	`rb_’Œy
(
cur
, 
rb_’Œy
, 
rb_node
);

184 
Ãxt_»
 = 
	`rb_’Œy
(
Ãxt
, 
rb_’Œy
, 
rb_node
);

186 ià(
cur_»
->
ofs
 + cur_»->
Ën
 > 
Ãxt_»
->ofs) {

187 
	`f2fs_šfo
(
sbi
, "inconsistent„btree, cur(%u, %u)‚ext(%u, %u)",

188 
cur_»
->
ofs
, cur_»->
Ën
,

189 
Ãxt_»
->
ofs
,‚ext_»->
Ën
);

190  
çl£
;

193 
cur
 = 
Ãxt
;

196  
Œue
;

197 
	}
}

199 
kmem_ÿche
 *
	gex‹Á_Œ“_¦ab
;

200 
kmem_ÿche
 *
	gex‹Á_node_¦ab
;

202 
ex‹Á_node
 *
	$__©ch_ex‹Á_node
(
f2fs_sb_šfo
 *
sbi
,

203 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_šfo
 *
ei
,

204 
rb_node
 *
·»Á
, rb_nod**
p
,

205 
boŞ
 
Ëámo¡
)

207 
ex‹Á_node
 *
’
;

209 
’
 = 
	`kmem_ÿche_®loc
(
ex‹Á_node_¦ab
, 
GFP_ATOMIC
);

210 ià(!
’
)

211  
NULL
;

213 
’
->
ei
 = *ei;

214 
	`INIT_LIST_HEAD
(&
’
->
li¡
);

215 
’
->
‘
 =ƒt;

217 
	`rb_lšk_node
(&
’
->
rb_node
, 
·»Á
, 
p
);

218 
	`rb_š£¹_cŞÜ_ÿched
(&
’
->
rb_node
, &
‘
->
roÙ
, 
Ëámo¡
);

219 
	`©omic_šc
(&
‘
->
node_út
);

220 
	`©omic_šc
(&
sbi
->
tÙ®_ext_node
);

221  
’
;

222 
	}
}

224 
	$__d‘ach_ex‹Á_node
(
f2fs_sb_šfo
 *
sbi
,

225 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_node
 *
’
)

227 
	`rb_”a£_ÿched
(&
’
->
rb_node
, &
‘
->
roÙ
);

228 
	`©omic_dec
(&
‘
->
node_út
);

229 
	`©omic_dec
(&
sbi
->
tÙ®_ext_node
);

231 ià(
‘
->
ÿched_’
 =ğ
’
)

232 
‘
->
ÿched_’
 = 
NULL
;

233 
	`kmem_ÿche_ä“
(
ex‹Á_node_¦ab
, 
’
);

234 
	}
}

242 
	$__»Ëa£_ex‹Á_node
(
f2fs_sb_šfo
 *
sbi
,

243 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_node
 *
’
)

245 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

246 
	`f2fs_bug_Ú
(
sbi
, 
	`li¡_em±y
(&
’
->
li¡
));

247 
	`li¡_d–_š™
(&
’
->
li¡
);

248 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

250 
	`__d‘ach_ex‹Á_node
(
sbi
, 
‘
, 
’
);

251 
	}
}

253 
ex‹Á_Œ“
 *
	$__g¿b_ex‹Á_Œ“
(
šode
 *inode)

255 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

256 
ex‹Á_Œ“
 *
‘
;

257 
nid_t
 
šo
 = 
šode
->
i_šo
;

259 
	`mu‹x_lock
(&
sbi
->
ex‹Á_Œ“_lock
);

260 
‘
 = 
	`¿dix_Œ“_lookup
(&
sbi
->
ex‹Á_Œ“_roÙ
, 
šo
);

261 ià(!
‘
) {

262 
‘
 = 
	`f2fs_kmem_ÿche_®loc
(
ex‹Á_Œ“_¦ab
, 
GFP_NOFS
);

263 
	`f2fs_¿dix_Œ“_š£¹
(&
sbi
->
ex‹Á_Œ“_roÙ
, 
šo
, 
‘
);

264 
	`mem£t
(
‘
, 0, (
ex‹Á_Œ“
));

265 
‘
->
šo
 = ino;

266 
‘
->
roÙ
 = 
RB_ROOT_CACHED
;

267 
‘
->
ÿched_’
 = 
NULL
;

268 
	`rwlock_š™
(&
‘
->
lock
);

269 
	`INIT_LIST_HEAD
(&
‘
->
li¡
);

270 
	`©omic_£t
(&
‘
->
node_út
, 0);

271 
	`©omic_šc
(&
sbi
->
tÙ®_ext_Œ“
);

273 
	`©omic_dec
(&
sbi
->
tÙ®_zomb›_Œ“
);

274 
	`li¡_d–_š™
(&
‘
->
li¡
);

276 
	`mu‹x_uÆock
(&
sbi
->
ex‹Á_Œ“_lock
);

279 
	`F2FS_I
(
šode
)->
ex‹Á_Œ“
 = 
‘
;

281  
‘
;

282 
	}
}

284 
ex‹Á_node
 *
	$__š™_ex‹Á_Œ“
(
f2fs_sb_šfo
 *
sbi
,

285 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_šfo
 *
ei
)

287 
rb_node
 **
p
 = &
‘
->
roÙ
.
rb_roÙ
.rb_node;

288 
ex‹Á_node
 *
’
;

290 
’
 = 
	`__©ch_ex‹Á_node
(
sbi
, 
‘
, 
ei
, 
NULL
, 
p
, 
Œue
);

291 ià(!
’
)

292  
NULL
;

294 
‘
->
Ïrge¡
 = 
’
->
ei
;

295 
‘
->
ÿched_’
 = 
’
;

296  
’
;

297 
	}
}

299 
	$__ä“_ex‹Á_Œ“
(
f2fs_sb_šfo
 *
sbi
,

300 
ex‹Á_Œ“
 *
‘
)

302 
rb_node
 *
node
, *
Ãxt
;

303 
ex‹Á_node
 *
’
;

304 
couÁ
 = 
	`©omic_»ad
(&
‘
->
node_út
);

306 
node
 = 
	`rb_fœ¡_ÿched
(&
‘
->
roÙ
);

307 
node
) {

308 
Ãxt
 = 
	`rb_Ãxt
(
node
);

309 
’
 = 
	`rb_’Œy
(
node
, 
ex‹Á_node
, 
rb_node
);

310 
	`__»Ëa£_ex‹Á_node
(
sbi
, 
‘
, 
’
);

311 
node
 = 
Ãxt
;

314  
couÁ
 - 
	`©omic_»ad
(&
‘
->
node_út
);

315 
	}
}

317 
	$__drİ_Ïrge¡_ex‹Á
(
ex‹Á_Œ“
 *
‘
,

318 
pgoff_t
 
fofs
, 
Ën
)

320 ià(
fofs
 < 
‘
->
Ïrge¡
.fof +ƒt->Ïrge¡.
Ën
 &&

321 
fofs
 + 
Ën
 > 
‘
->
Ïrge¡
.fofs) {

322 
‘
->
Ïrge¡
.
Ën
 = 0;

323 
‘
->
Ïrge¡_upd©ed
 = 
Œue
;

325 
	}
}

328 
boŞ
 
	$__f2fs_š™_ex‹Á_Œ“
(
šode
 *šode, 
f2fs_ex‹Á
 *
i_ext
)

330 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

331 
ex‹Á_Œ“
 *
‘
;

332 
ex‹Á_node
 *
’
;

333 
ex‹Á_šfo
 
ei
;

335 ià(!
	`f2fs_may_ex‹Á_Œ“
(
šode
)) {

337 ià(
i_ext
 && i_ext->
Ën
) {

338 
i_ext
->
Ën
 = 0;

339  
Œue
;

341  
çl£
;

344 
‘
 = 
	`__g¿b_ex‹Á_Œ“
(
šode
);

346 ià(!
i_ext
 || !i_ext->
Ën
)

347  
çl£
;

349 
	`g‘_ex‹Á_šfo
(&
ei
, 
i_ext
);

351 
	`wr™e_lock
(&
‘
->
lock
);

352 ià(
	`©omic_»ad
(&
‘
->
node_út
))

353 
out
;

355 
’
 = 
	`__š™_ex‹Á_Œ“
(
sbi
, 
‘
, &
ei
);

356 ià(
’
) {

357 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

358 
	`li¡_add_
(&
’
->
li¡
, &
sbi
->
ex‹Á_li¡
);

359 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

361 
out
:

362 
	`wr™e_uÆock
(&
‘
->
lock
);

363  
çl£
;

364 
	}
}

366 
boŞ
 
	$f2fs_š™_ex‹Á_Œ“
(
šode
 *šode, 
f2fs_ex‹Á
 *
i_ext
)

368 
boŞ
 
»t
 = 
	`__f2fs_š™_ex‹Á_Œ“
(
šode
, 
i_ext
);

370 ià(!
	`F2FS_I
(
šode
)->
ex‹Á_Œ“
)

371 
	`£t_šode_æag
(
šode
, 
FI_NO_EXTENT
);

373  
»t
;

374 
	}
}

376 
boŞ
 
	$f2fs_lookup_ex‹Á_Œ“
(
šode
 *šode, 
pgoff_t
 
pgofs
,

377 
ex‹Á_šfo
 *
ei
)

379 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

380 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

381 
ex‹Á_node
 *
’
;

382 
boŞ
 
»t
 = 
çl£
;

384 
	`f2fs_bug_Ú
(
sbi
, !
‘
);

386 
	`Œaû_f2fs_lookup_ex‹Á_Œ“_¡¬t
(
šode
, 
pgofs
);

388 
	`»ad_lock
(&
‘
->
lock
);

390 ià(
‘
->
Ïrge¡
.
fofs
 <ğ
pgofs
 &&

391 
‘
->
Ïrge¡
.
fofs
 +ƒt->Ïrge¡.
Ën
 > 
pgofs
) {

392 *
ei
 = 
‘
->
Ïrge¡
;

393 
»t
 = 
Œue
;

394 
	`¡©_šc_Ïrge¡_node_h™
(
sbi
);

395 
out
;

398 
’
 = (
ex‹Á_node
 *)
	`f2fs_lookup_rb_Œ“
(&
‘
->
roÙ
,

399 (
rb_’Œy
 *)
‘
->
ÿched_’
, 
pgofs
);

400 ià(!
’
)

401 
out
;

403 ià(
’
 =ğ
‘
->
ÿched_’
)

404 
	`¡©_šc_ÿched_node_h™
(
sbi
);

406 
	`¡©_šc_rbŒ“_node_h™
(
sbi
);

408 *
ei
 = 
’
->ei;

409 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

410 ià(!
	`li¡_em±y
(&
’
->
li¡
)) {

411 
	`li¡_move_
(&
’
->
li¡
, &
sbi
->
ex‹Á_li¡
);

412 
‘
->
ÿched_’
 = 
’
;

414 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

415 
»t
 = 
Œue
;

416 
out
:

417 
	`¡©_šc_tÙ®_h™
(
sbi
);

418 
	`»ad_uÆock
(&
‘
->
lock
);

420 
	`Œaû_f2fs_lookup_ex‹Á_Œ“_’d
(
šode
, 
pgofs
, 
ei
);

421  
»t
;

422 
	}
}

424 
ex‹Á_node
 *
	$__Œy_m”ge_ex‹Á_node
(
f2fs_sb_šfo
 *
sbi
,

425 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_šfo
 *
ei
,

426 
ex‹Á_node
 *
´ev_ex
,

427 
ex‹Á_node
 *
Ãxt_ex
)

429 
ex‹Á_node
 *
’
 = 
NULL
;

431 ià(
´ev_ex
 && 
	`__is_back_m”g—bË
(
ei
, &prev_ex->ei)) {

432 
´ev_ex
->
ei
.
Ën
 +=ƒi->len;

433 
ei
 = &
´ev_ex
->ei;

434 
’
 = 
´ev_ex
;

437 ià(
Ãxt_ex
 && 
	`__is_äÚt_m”g—bË
(
ei
, &next_ex->ei)) {

438 
Ãxt_ex
->
ei
.
fofs
 =ƒi->fofs;

439 
Ãxt_ex
->
ei
.
blk
 =ƒi->blk;

440 
Ãxt_ex
->
ei
.
Ën
 +=ƒi->len;

441 ià(
’
)

442 
	`__»Ëa£_ex‹Á_node
(
sbi
, 
‘
, 
´ev_ex
);

444 
’
 = 
Ãxt_ex
;

447 ià(!
’
)

448  
NULL
;

450 
	`__Œy_upd©e_Ïrge¡_ex‹Á
(
‘
, 
’
);

452 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

453 ià(!
	`li¡_em±y
(&
’
->
li¡
)) {

454 
	`li¡_move_
(&
’
->
li¡
, &
sbi
->
ex‹Á_li¡
);

455 
‘
->
ÿched_’
 = 
’
;

457 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

458  
’
;

459 
	}
}

461 
ex‹Á_node
 *
	$__š£¹_ex‹Á_Œ“
(
f2fs_sb_šfo
 *
sbi
,

462 
ex‹Á_Œ“
 *
‘
, 
ex‹Á_šfo
 *
ei
,

463 
rb_node
 **
š£¹_p
,

464 
rb_node
 *
š£¹_·»Á
,

465 
boŞ
 
Ëámo¡
)

467 
rb_node
 **
p
;

468 
rb_node
 *
·»Á
 = 
NULL
;

469 
ex‹Á_node
 *
’
 = 
NULL
;

471 ià(
š£¹_p
 && 
š£¹_·»Á
) {

472 
·»Á
 = 
š£¹_·»Á
;

473 
p
 = 
š£¹_p
;

474 
do_š£¹
;

477 
Ëámo¡
 = 
Œue
;

479 
p
 = 
	`f2fs_lookup_rb_Œ“_fÜ_š£¹
(
sbi
, &
‘
->
roÙ
, &
·»Á
,

480 
ei
->
fofs
, &
Ëámo¡
);

481 
do_š£¹
:

482 
’
 = 
	`__©ch_ex‹Á_node
(
sbi
, 
‘
, 
ei
, 
·»Á
, 
p
, 
Ëámo¡
);

483 ià(!
’
)

484  
NULL
;

486 
	`__Œy_upd©e_Ïrge¡_ex‹Á
(
‘
, 
’
);

489 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

490 
	`li¡_add_
(&
’
->
li¡
, &
sbi
->
ex‹Á_li¡
);

491 
‘
->
ÿched_’
 = 
’
;

492 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

493  
’
;

494 
	}
}

496 
	$f2fs_upd©e_ex‹Á_Œ“_¿nge
(
šode
 *inode,

497 
pgoff_t
 
fofs
, 
block_t
 
blkaddr
, 
Ën
)

499 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

500 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

501 
ex‹Á_node
 *
’
 = 
NULL
, *
’1
 = NULL;

502 
ex‹Á_node
 *
´ev_’
 = 
NULL
, *
Ãxt_’
 = NULL;

503 
ex‹Á_šfo
 
ei
, 
dei
, 
´ev
;

504 
rb_node
 **
š£¹_p
 = 
NULL
, *
š£¹_·»Á
 = NULL;

505 
’d
 = 
fofs
 + 
Ën
;

506 
pos
 = ()
fofs
;

507 
boŞ
 
upd©ed
 = 
çl£
;

508 
boŞ
 
Ëámo¡
 = 
çl£
;

510 ià(!
‘
)

513 
	`Œaû_f2fs_upd©e_ex‹Á_Œ“_¿nge
(
šode
, 
fofs
, 
blkaddr
, 
Ën
);

515 
	`wr™e_lock
(&
‘
->
lock
);

517 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NO_EXTENT
)) {

518 
	`wr™e_uÆock
(&
‘
->
lock
);

522 
´ev
 = 
‘
->
Ïrge¡
;

523 
dei
.
Ën
 = 0;

529 
	`__drİ_Ïrge¡_ex‹Á
(
‘
, 
fofs
, 
Ën
);

532 
’
 = (
ex‹Á_node
 *)
	`f2fs_lookup_rb_Œ“_»t
(&
‘
->
roÙ
,

533 (
rb_’Œy
 *)
‘
->
ÿched_’
, 
fofs
,

534 (
rb_’Œy
 **)&
´ev_’
,

535 (
rb_’Œy
 **)&
Ãxt_’
,

536 &
š£¹_p
, &
š£¹_·»Á
, 
çl£
,

537 &
Ëámo¡
);

538 ià(!
’
)

539 
’
 = 
Ãxt_’
;

542 
’
 &&ƒn->
ei
.
fofs
 < 
’d
) {

543 
Üg_’d
;

544 
·¹s
 = 0;

546 
Ãxt_’
 = 
’1
 = 
NULL
;

548 
dei
 = 
’
->
ei
;

549 
Üg_’d
 = 
dei
.
fofs
 + dei.
Ën
;

550 
	`f2fs_bug_Ú
(
sbi
, 
pos
 >ğ
Üg_’d
);

552 ià(
pos
 > 
dei
.
fofs
 &&…o - dei.fof >ğ
F2FS_MIN_EXTENT_LEN
) {

553 
’
->
ei
.
Ën
 = 
pos
 -ƒn->ei.
fofs
;

554 
´ev_’
 = 
’
;

555 
·¹s
 = 1;

558 ià(
’d
 < 
Üg_’d
 && org_’d -ƒnd >ğ
F2FS_MIN_EXTENT_LEN
) {

559 ià(
·¹s
) {

560 
	`£t_ex‹Á_šfo
(&
ei
, 
’d
,

561 
’d
 - 
dei
.
fofs
 + dei.
blk
,

562 
Üg_’d
 - 
’d
);

563 
’1
 = 
	`__š£¹_ex‹Á_Œ“
(
sbi
, 
‘
, &
ei
,

564 
NULL
, NULL, 
Œue
);

565 
Ãxt_’
 = 
’1
;

567 
’
->
ei
.
fofs
 = 
’d
;

568 
’
->
ei
.
blk
 +ğ
’d
 - 
dei
.
fofs
;

569 
’
->
ei
.
Ën
 -ğ
’d
 - 
dei
.
fofs
;

570 
Ãxt_’
 = 
’
;

572 
·¹s
++;

575 ià(!
Ãxt_’
) {

576 
rb_node
 *
node
 = 
	`rb_Ãxt
(&
’
->rb_node);

578 
Ãxt_’
 = 
	`rb_’Œy_§ã
(
node
, 
ex‹Á_node
,

579 
rb_node
);

582 ià(
·¹s
)

583 
	`__Œy_upd©e_Ïrge¡_ex‹Á
(
‘
, 
’
);

585 
	`__»Ëa£_ex‹Á_node
(
sbi
, 
‘
, 
’
);

592 ià(
·¹s
 != 1) {

593 
š£¹_p
 = 
NULL
;

594 
š£¹_·»Á
 = 
NULL
;

596 
’
 = 
Ãxt_’
;

600 ià(
blkaddr
) {

602 
	`£t_ex‹Á_šfo
(&
ei
, 
fofs
, 
blkaddr
, 
Ën
);

603 ià(!
	`__Œy_m”ge_ex‹Á_node
(
sbi
, 
‘
, &
ei
, 
´ev_’
, 
Ãxt_’
))

604 
	`__š£¹_ex‹Á_Œ“
(
sbi
, 
‘
, &
ei
,

605 
š£¹_p
, 
š£¹_·»Á
, 
Ëámo¡
);

608 ià(
dei
.
Ën
 >= 1 &&

609 
´ev
.
Ën
 < 
F2FS_MIN_EXTENT_LEN
 &&

610 
‘
->
Ïrge¡
.
Ën
 < 
F2FS_MIN_EXTENT_LEN
) {

611 
‘
->
Ïrge¡
.
Ën
 = 0;

612 
‘
->
Ïrge¡_upd©ed
 = 
Œue
;

613 
	`£t_šode_æag
(
šode
, 
FI_NO_EXTENT
);

617 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NO_EXTENT
))

618 
	`__ä“_ex‹Á_Œ“
(
sbi
, 
‘
);

620 ià(
‘
->
Ïrge¡_upd©ed
) {

621 
‘
->
Ïrge¡_upd©ed
 = 
çl£
;

622 
upd©ed
 = 
Œue
;

625 
	`wr™e_uÆock
(&
‘
->
lock
);

627 ià(
upd©ed
)

628 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

629 
	}
}

631 
	$f2fs_shršk_ex‹Á_Œ“
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
)

633 
ex‹Á_Œ“
 *
‘
, *
Ãxt
;

634 
ex‹Á_node
 *
’
;

635 
node_út
 = 0, 
Œ“_út
 = 0;

636 
»mašed
;

638 ià(!
	`‹¡_İt
(
sbi
, 
EXTENT_CACHE
))

641 ià(!
	`©omic_»ad
(&
sbi
->
tÙ®_zomb›_Œ“
))

642 
ä“_node
;

644 ià(!
	`mu‹x_Œylock
(&
sbi
->
ex‹Á_Œ“_lock
))

645 
out
;

648 
	`li¡_fÜ_—ch_’Œy_§ã
(
‘
, 
Ãxt
, &
sbi
->
zomb›_li¡
, 
li¡
) {

649 ià(
	`©omic_»ad
(&
‘
->
node_út
)) {

650 
	`wr™e_lock
(&
‘
->
lock
);

651 
node_út
 +ğ
	`__ä“_ex‹Á_Œ“
(
sbi
, 
‘
);

652 
	`wr™e_uÆock
(&
‘
->
lock
);

654 
	`f2fs_bug_Ú
(
sbi
, 
	`©omic_»ad
(&
‘
->
node_út
));

655 
	`li¡_d–_š™
(&
‘
->
li¡
);

656 
	`¿dix_Œ“_d–‘e
(&
sbi
->
ex‹Á_Œ“_roÙ
, 
‘
->
šo
);

657 
	`kmem_ÿche_ä“
(
ex‹Á_Œ“_¦ab
, 
‘
);

658 
	`©omic_dec
(&
sbi
->
tÙ®_ext_Œ“
);

659 
	`©omic_dec
(&
sbi
->
tÙ®_zomb›_Œ“
);

660 
Œ“_út
++;

662 ià(
node_út
 + 
Œ“_út
 >ğ
Ä_shršk
)

663 
uÆock_out
;

664 
	`cÚd_»sched
();

666 
	`mu‹x_uÆock
(&
sbi
->
ex‹Á_Œ“_lock
);

668 
ä“_node
:

670 ià(!
	`mu‹x_Œylock
(&
sbi
->
ex‹Á_Œ“_lock
))

671 
out
;

673 
»mašed
 = 
Ä_shršk
 - (
node_út
 + 
Œ“_út
);

675 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

676 ; 
»mašed
 > 0;„emained--) {

677 ià(
	`li¡_em±y
(&
sbi
->
ex‹Á_li¡
))

679 
’
 = 
	`li¡_fœ¡_’Œy
(&
sbi
->
ex‹Á_li¡
,

680 
ex‹Á_node
, 
li¡
);

681 
‘
 = 
’
->et;

682 ià(!
	`wr™e_Œylock
(&
‘
->
lock
)) {

684 
	`li¡_move_
(&
’
->
li¡
, &
sbi
->
ex‹Á_li¡
);

688 
	`li¡_d–_š™
(&
’
->
li¡
);

689 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

691 
	`__d‘ach_ex‹Á_node
(
sbi
, 
‘
, 
’
);

693 
	`wr™e_uÆock
(&
‘
->
lock
);

694 
node_út
++;

695 
	`¥š_lock
(&
sbi
->
ex‹Á_lock
);

697 
	`¥š_uÆock
(&
sbi
->
ex‹Á_lock
);

699 
uÆock_out
:

700 
	`mu‹x_uÆock
(&
sbi
->
ex‹Á_Œ“_lock
);

701 
out
:

702 
	`Œaû_f2fs_shršk_ex‹Á_Œ“
(
sbi
, 
node_út
, 
Œ“_út
);

704  
node_út
 + 
Œ“_út
;

705 
	}
}

707 
	$f2fs_de¡roy_ex‹Á_node
(
šode
 *inode)

709 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

710 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

711 
node_út
 = 0;

713 ià(!
‘
 || !
	`©omic_»ad
(&‘->
node_út
))

716 
	`wr™e_lock
(&
‘
->
lock
);

717 
node_út
 = 
	`__ä“_ex‹Á_Œ“
(
sbi
, 
‘
);

718 
	`wr™e_uÆock
(&
‘
->
lock
);

720  
node_út
;

721 
	}
}

723 
	$f2fs_drİ_ex‹Á_Œ“
(
šode
 *inode)

725 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

726 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

727 
boŞ
 
upd©ed
 = 
çl£
;

729 ià(!
	`f2fs_may_ex‹Á_Œ“
(
šode
))

732 
	`£t_šode_æag
(
šode
, 
FI_NO_EXTENT
);

734 
	`wr™e_lock
(&
‘
->
lock
);

735 
	`__ä“_ex‹Á_Œ“
(
sbi
, 
‘
);

736 ià(
‘
->
Ïrge¡
.
Ën
) {

737 
‘
->
Ïrge¡
.
Ën
 = 0;

738 
upd©ed
 = 
Œue
;

740 
	`wr™e_uÆock
(&
‘
->
lock
);

741 ià(
upd©ed
)

742 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

743 
	}
}

745 
	$f2fs_de¡roy_ex‹Á_Œ“
(
šode
 *inode)

747 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

748 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

749 
node_út
 = 0;

751 ià(!
‘
)

754 ià(
šode
->
i_Æšk
 && !
	`is_bad_šode
(inode) &&

755 
	`©omic_»ad
(&
‘
->
node_út
)) {

756 
	`mu‹x_lock
(&
sbi
->
ex‹Á_Œ“_lock
);

757 
	`li¡_add_
(&
‘
->
li¡
, &
sbi
->
zomb›_li¡
);

758 
	`©omic_šc
(&
sbi
->
tÙ®_zomb›_Œ“
);

759 
	`mu‹x_uÆock
(&
sbi
->
ex‹Á_Œ“_lock
);

764 
node_út
 = 
	`f2fs_de¡roy_ex‹Á_node
(
šode
);

767 
	`mu‹x_lock
(&
sbi
->
ex‹Á_Œ“_lock
);

768 
	`f2fs_bug_Ú
(
sbi
, 
	`©omic_»ad
(&
‘
->
node_út
));

769 
	`¿dix_Œ“_d–‘e
(&
sbi
->
ex‹Á_Œ“_roÙ
, 
šode
->
i_šo
);

770 
	`kmem_ÿche_ä“
(
ex‹Á_Œ“_¦ab
, 
‘
);

771 
	`©omic_dec
(&
sbi
->
tÙ®_ext_Œ“
);

772 
	`mu‹x_uÆock
(&
sbi
->
ex‹Á_Œ“_lock
);

774 
	`F2FS_I
(
šode
)->
ex‹Á_Œ“
 = 
NULL
;

776 
	`Œaû_f2fs_de¡roy_ex‹Á_Œ“
(
šode
, 
node_út
);

777 
	}
}

779 
boŞ
 
	$f2fs_lookup_ex‹Á_ÿche
(
šode
 *šode, 
pgoff_t
 
pgofs
,

780 
ex‹Á_šfo
 *
ei
)

782 ià(!
	`f2fs_may_ex‹Á_Œ“
(
šode
))

783  
çl£
;

785  
	`f2fs_lookup_ex‹Á_Œ“
(
šode
, 
pgofs
, 
ei
);

786 
	}
}

788 
	$f2fs_upd©e_ex‹Á_ÿche
(
dnode_of_d©a
 *
dn
)

790 
pgoff_t
 
fofs
;

791 
block_t
 
blkaddr
;

793 ià(!
	`f2fs_may_ex‹Á_Œ“
(
dn
->
šode
))

796 ià(
dn
->
d©a_blkaddr
 =ğ
NEW_ADDR
)

797 
blkaddr
 = 
NULL_ADDR
;

799 
blkaddr
 = 
dn
->
d©a_blkaddr
;

801 
fofs
 = 
	`f2fs_¡¬t_bidx_of_node
(
	`ofs_of_node
(
dn
->
node_·ge
), dn->
šode
) +

802 
dn
->
ofs_š_node
;

803 
	`f2fs_upd©e_ex‹Á_Œ“_¿nge
(
dn
->
šode
, 
fofs
, 
blkaddr
, 1);

804 
	}
}

806 
	$f2fs_upd©e_ex‹Á_ÿche_¿nge
(
dnode_of_d©a
 *
dn
,

807 
pgoff_t
 
fofs
, 
block_t
 
blkaddr
, 
Ën
)

810 ià(!
	`f2fs_may_ex‹Á_Œ“
(
dn
->
šode
))

813 
	`f2fs_upd©e_ex‹Á_Œ“_¿nge
(
dn
->
šode
, 
fofs
, 
blkaddr
, 
Ën
);

814 
	}
}

816 
	$f2fs_š™_ex‹Á_ÿche_šfo
(
f2fs_sb_šfo
 *
sbi
)

818 
	`INIT_RADIX_TREE
(&
sbi
->
ex‹Á_Œ“_roÙ
, 
GFP_NOIO
);

819 
	`mu‹x_š™
(&
sbi
->
ex‹Á_Œ“_lock
);

820 
	`INIT_LIST_HEAD
(&
sbi
->
ex‹Á_li¡
);

821 
	`¥š_lock_š™
(&
sbi
->
ex‹Á_lock
);

822 
	`©omic_£t
(&
sbi
->
tÙ®_ext_Œ“
, 0);

823 
	`INIT_LIST_HEAD
(&
sbi
->
zomb›_li¡
);

824 
	`©omic_£t
(&
sbi
->
tÙ®_zomb›_Œ“
, 0);

825 
	`©omic_£t
(&
sbi
->
tÙ®_ext_node
, 0);

826 
	}
}

828 
__š™
 
	$f2fs_ü—‹_ex‹Á_ÿche
()

830 
ex‹Á_Œ“_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_extent_tree",

831 (
ex‹Á_Œ“
));

832 ià(!
ex‹Á_Œ“_¦ab
)

833  -
ENOMEM
;

834 
ex‹Á_node_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_extent_node",

835 (
ex‹Á_node
));

836 ià(!
ex‹Á_node_¦ab
) {

837 
	`kmem_ÿche_de¡roy
(
ex‹Á_Œ“_¦ab
);

838  -
ENOMEM
;

841 
	}
}

843 
	$f2fs_de¡roy_ex‹Á_ÿche
()

845 
	`kmem_ÿche_de¡roy
(
ex‹Á_node_¦ab
);

846 
	`kmem_ÿche_de¡roy
(
ex‹Á_Œ“_¦ab
);

847 
	}
}

	@f2fs.h

8 #iâdeà
_LINUX_F2FS_H


9 
	#_LINUX_F2FS_H


	)

11 
	~<lšux/uio.h
>

12 
	~<lšux/ty³s.h
>

13 
	~<lšux/·ge-æags.h
>

14 
	~<lšux/bufãr_h—d.h
>

15 
	~<lšux/¦ab.h
>

16 
	~<lšux/üc32.h
>

17 
	~<lšux/magic.h
>

18 
	~<lšux/kobjeù.h
>

19 
	~<lšux/sched.h
>

20 
	~<lšux/üed.h
>

21 
	~<lšux/vm®loc.h
>

22 
	~<lšux/bio.h
>

23 
	~<lšux/blkdev.h
>

24 
	~<lšux/quÙaİs.h
>

25 
	~<üy±o/hash.h
>

27 
	~<lšux/fsüy±.h
>

28 
	~<lšux/fsv”™y.h
>

30 #ifdeà
CONFIG_F2FS_CHECK_FS


31 
	#f2fs_bug_Ú
(
sbi
, 
cÚd™iÚ
è
	`BUG_ON
(cÚd™iÚ)

	)

33 
	#f2fs_bug_Ú
(
sbi
, 
cÚd™iÚ
) \

35 ià(
	`uÆik–y
(
cÚd™iÚ
)) { \

36 
	`WARN_ON
(1); \

37 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
); \

39 } 0)

	)

43 
	mFAULT_KMALLOC
,

44 
	mFAULT_KVMALLOC
,

45 
	mFAULT_PAGE_ALLOC
,

46 
	mFAULT_PAGE_GET
,

47 
	mFAULT_ALLOC_BIO
,

48 
	mFAULT_ALLOC_NID
,

49 
	mFAULT_ORPHAN
,

50 
	mFAULT_BLOCK
,

51 
	mFAULT_DIR_DEPTH
,

52 
	mFAULT_EVICT_INODE
,

53 
	mFAULT_TRUNCATE
,

54 
	mFAULT_READ_IO
,

55 
	mFAULT_CHECKPOINT
,

56 
	mFAULT_DISCARD
,

57 
	mFAULT_WRITE_IO
,

58 
	mFAULT_MAX
,

61 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


62 
	#F2FS_ALL_FAULT_TYPE
 ((1 << 
FAULT_MAX
è- 1)

	)

64 
	sf2fs_çuÉ_šfo
 {

65 
©omic_t
 
	mšjeù_İs
;

66 
	mšjeù_¿‹
;

67 
	mšjeù_ty³
;

70 cÚ¡ *
f2fs_çuÉ_Çme
[
FAULT_MAX
];

71 
	#IS_FAULT_SET
(
fi
, 
ty³
è((fi)->
šjeù_ty³
 & (1 << (ty³)))

	)

77 
	#F2FS_MOUNT_BG_GC
 0x00000001

	)

78 
	#F2FS_MOUNT_DISABLE_ROLL_FORWARD
 0x00000002

	)

79 
	#F2FS_MOUNT_DISCARD
 0x00000004

	)

80 
	#F2FS_MOUNT_NOHEAP
 0x00000008

	)

81 
	#F2FS_MOUNT_XATTR_USER
 0x00000010

	)

82 
	#F2FS_MOUNT_POSIX_ACL
 0x00000020

	)

83 
	#F2FS_MOUNT_DISABLE_EXT_IDENTIFY
 0x00000040

	)

84 
	#F2FS_MOUNT_INLINE_XATTR
 0x00000080

	)

85 
	#F2FS_MOUNT_INLINE_DATA
 0x00000100

	)

86 
	#F2FS_MOUNT_INLINE_DENTRY
 0x00000200

	)

87 
	#F2FS_MOUNT_FLUSH_MERGE
 0x00000400

	)

88 
	#F2FS_MOUNT_NOBARRIER
 0x00000800

	)

89 
	#F2FS_MOUNT_FASTBOOT
 0x00001000

	)

90 
	#F2FS_MOUNT_EXTENT_CACHE
 0x00002000

	)

91 
	#F2FS_MOUNT_FORCE_FG_GC
 0x00004000

	)

92 
	#F2FS_MOUNT_DATA_FLUSH
 0x00008000

	)

93 
	#F2FS_MOUNT_FAULT_INJECTION
 0x00010000

	)

94 
	#F2FS_MOUNT_ADAPTIVE
 0x00020000

	)

95 
	#F2FS_MOUNT_LFS
 0x00040000

	)

96 
	#F2FS_MOUNT_USRQUOTA
 0x00080000

	)

97 
	#F2FS_MOUNT_GRPQUOTA
 0x00100000

	)

98 
	#F2FS_MOUNT_PRJQUOTA
 0x00200000

	)

99 
	#F2FS_MOUNT_QUOTA
 0x00400000

	)

100 
	#F2FS_MOUNT_INLINE_XATTR_SIZE
 0x00800000

	)

101 
	#F2FS_MOUNT_RESERVE_ROOT
 0x01000000

	)

102 
	#F2FS_MOUNT_DISABLE_CHECKPOINT
 0x02000000

	)

104 
	#F2FS_OPTION
(
sbi
è((sbi)->
mouÁ_İt
)

	)

105 
	#ş—r_İt
(
sbi
, 
İtiÚ
è(
	`F2FS_OPTION
(sbi).
İt
 &ğ~
F2FS_MOUNT_
##İtiÚ)

	)

106 
	#£t_İt
(
sbi
, 
İtiÚ
è(
	`F2FS_OPTION
(sbi).
İt
 |ğ
F2FS_MOUNT_
##İtiÚ)

	)

107 
	#‹¡_İt
(
sbi
, 
İtiÚ
è(
	`F2FS_OPTION
(sbi).
İt
 & 
F2FS_MOUNT_
##İtiÚ)

	)

109 
	#v”_aá”
(
a
, 
b
è(
	`ty³check
(,‡) && \

110 
	`ty³check
(, 
b
) && \

111 (()((
a
è- (
b
)è> 0))

	)

113 
u32
 
	tblock_t
;

117 
u32
 
	tnid_t
;

119 
	sf2fs_mouÁ_šfo
 {

120 
	mİt
;

121 
	mwr™e_io_size_b™s
;

122 
block_t
 
	mroÙ_»£rved_blocks
;

123 
kuid_t
 
	ms_»suid
;

124 
kgid_t
 
	ms_»sgid
;

125 
	maùive_logs
;

126 
	mšlše_x©Œ_size
;

127 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


128 
f2fs_çuÉ_šfo
 
	mçuÉ_šfo
;

130 #ifdeà
CONFIG_QUOTA


132 *
	ms_qf_Çmes
[
MAXQUOTAS
];

133 
	ms_jquÙa_fmt
;

136 
	mwhšt_mode
;

137 
	m®loc_mode
;

138 
	mfsync_mode
;

139 
boŞ
 
	m‹¡_dummy_’üy±iÚ
;

140 
block_t
 
	munu§bË_ÿp
;

145 
	#F2FS_FEATURE_ENCRYPT
 0x0001

	)

146 
	#F2FS_FEATURE_BLKZONED
 0x0002

	)

147 
	#F2FS_FEATURE_ATOMIC_WRITE
 0x0004

	)

148 
	#F2FS_FEATURE_EXTRA_ATTR
 0x0008

	)

149 
	#F2FS_FEATURE_PRJQUOTA
 0x0010

	)

150 
	#F2FS_FEATURE_INODE_CHKSUM
 0x0020

	)

151 
	#F2FS_FEATURE_FLEXIBLE_INLINE_XATTR
 0x0040

	)

152 
	#F2FS_FEATURE_QUOTA_INO
 0x0080

	)

153 
	#F2FS_FEATURE_INODE_CRTIME
 0x0100

	)

154 
	#F2FS_FEATURE_LOST_FOUND
 0x0200

	)

155 
	#F2FS_FEATURE_VERITY
 0x0400

	)

156 
	#F2FS_FEATURE_SB_CHKSUM
 0x0800

	)

157 
	#F2FS_FEATURE_CASEFOLD
 0x1000

	)

159 
	#__F2FS_HAS_FEATURE
(
¿w_su³r
, 
mask
) \

160 ((
¿w_su³r
->
ã©u»
 & 
	`ıu_to_Ë32
(
mask
)è!ğ0)

	)

161 
	#F2FS_HAS_FEATURE
(
sbi
, 
mask
è
	`__F2FS_HAS_FEATURE
(sbi->
¿w_su³r
, mask)

	)

162 
	#F2FS_SET_FEATURE
(
sbi
, 
mask
) \

163 (
sbi
->
¿w_su³r
->
ã©u»
 |ğ
	`ıu_to_Ë32
(
mask
))

	)

164 
	#F2FS_CLEAR_FEATURE
(
sbi
, 
mask
) \

165 (
sbi
->
¿w_su³r
->
ã©u»
 &ğ~
	`ıu_to_Ë32
(
mask
))

	)

170 
	#F2FS_DEF_RESUID
 0

	)

171 
	#F2FS_DEF_RESGID
 0

	)

177 
	mNAT_BITMAP
,

178 
	mSIT_BITMAP


181 
	#CP_UMOUNT
 0x00000001

	)

182 
	#CP_FASTBOOT
 0x00000002

	)

183 
	#CP_SYNC
 0x00000004

	)

184 
	#CP_RECOVERY
 0x00000008

	)

185 
	#CP_DISCARD
 0x00000010

	)

186 
	#CP_TRIMMED
 0x00000020

	)

187 
	#CP_PAUSE
 0x00000040

	)

189 
	#MAX_DISCARD_BLOCKS
(
sbi
è
	`BLKS_PER_SEC
(sbi)

	)

190 
	#DEF_MAX_DISCARD_REQUEST
 8

	)

191 
	#DEF_MIN_DISCARD_ISSUE_TIME
 50

	)

192 
	#DEF_MID_DISCARD_ISSUE_TIME
 500

	)

193 
	#DEF_MAX_DISCARD_ISSUE_TIME
 60000

	)

194 
	#DEF_DISCARD_URGENT_UTIL
 80

	)

195 
	#DEF_CP_INTERVAL
 60

	)

196 
	#DEF_IDLE_INTERVAL
 5

	)

197 
	#DEF_DISABLE_INTERVAL
 5

	)

198 
	#DEF_DISABLE_QUICK_INTERVAL
 1

	)

199 
	#DEF_UMOUNT_DISCARD_TIMEOUT
 5

	)

201 
	sı_cÚŒŞ
 {

202 
	m»asÚ
;

203 
__u64
 
	mŒim_¡¬t
;

204 
__u64
 
	mŒim_’d
;

205 
__u64
 
	mŒim_mšËn
;

212 
	mMETA_CP
,

213 
	mMETA_NAT
,

214 
	mMETA_SIT
,

215 
	mMETA_SSA
,

216 
	mMETA_MAX
,

217 
	mMETA_POR
,

218 
	mDATA_GENERIC
,

219 
	mDATA_GENERIC_ENHANCE
,

220 
	mDATA_GENERIC_ENHANCE_READ
,

226 
	mMETA_GENERIC
,

231 
	mORPHAN_INO
,

232 
	mAPPEND_INO
,

233 
	mUPDATE_INO
,

234 
	mTRANS_DIR_INO
,

235 
	mFLUSH_INO
,

236 
	mMAX_INO_ENTRY
,

239 
	sšo_’Œy
 {

240 
li¡_h—d
 
	mli¡
;

241 
nid_t
 
	mšo
;

242 
	mdœty_deviû
;

246 
	sšode_’Œy
 {

247 
li¡_h—d
 
	mli¡
;

248 
šode
 *
	mšode
;

251 
	sfsync_node_’Œy
 {

252 
li¡_h—d
 
	mli¡
;

253 
·ge
 *
	m·ge
;

254 
	m£q_id
;

258 
	sdisÿrd_’Œy
 {

259 
li¡_h—d
 
	mli¡
;

260 
block_t
 
	m¡¬t_blkaddr
;

261 
	mdisÿrd_m­
[
SIT_VBLOCK_MAP_SIZE
];

265 
	#DEFAULT_DISCARD_GRANULARITY
 16

	)

268 
	#MAX_PLIST_NUM
 512

	)

269 
	#¶i¡_idx
(
blk_num
è((blk_numè>ğ
MAX_PLIST_NUM
 ? \

270 (
MAX_PLIST_NUM
 - 1è: ((
blk_num
è- 1))

	)

273 
	mD_PREP
,

274 
	mD_PARTIAL
,

275 
	mD_SUBMIT
,

276 
	mD_DONE
,

279 
	sdisÿrd_šfo
 {

280 
block_t
 
	ml¡¬t
;

281 
block_t
 
	mËn
;

282 
block_t
 
	m¡¬t
;

285 
	sdisÿrd_cmd
 {

286 
rb_node
 
	mrb_node
;

289 
block_t
 
	ml¡¬t
;

290 
block_t
 
	mËn
;

291 
block_t
 
	m¡¬t
;

293 
disÿrd_šfo
 
	mdi
;

296 
li¡_h—d
 
	mli¡
;

297 
com¶‘iÚ
 
	mwa™
;

298 
block_deviû
 *
	mbdev
;

299 
	m»f
;

300 
	m¡©e
;

301 
	mqueued
;

302 
	m”rÜ
;

303 
¥šlock_t
 
	mlock
;

304 
	mbio_»f
;

308 
	mDPOLICY_BG
,

309 
	mDPOLICY_FORCE
,

310 
	mDPOLICY_FSTRIM
,

311 
	mDPOLICY_UMOUNT
,

312 
	mMAX_DPOLICY
,

315 
	sdisÿrd_pŞicy
 {

316 
	mty³
;

317 
	mmš_š‹rv®
;

318 
	mmid_š‹rv®
;

319 
	mmax_š‹rv®
;

320 
	mmax_»que¡s
;

321 
	mio_aw¬e_g¿n
;

322 
boŞ
 
	mio_aw¬e
;

323 
boŞ
 
	msync
;

324 
boŞ
 
	mÜd”ed
;

325 
	mg¿nuÏr™y
;

326 
	mtimeout
;

329 
	sdisÿrd_cmd_cÚŒŞ
 {

330 
sk_¡ruù
 *
	mf2fs_issue_disÿrd
;

331 
li¡_h—d
 
	m’Œy_li¡
;

332 
li¡_h—d
 
	m³nd_li¡
[
MAX_PLIST_NUM
];

333 
li¡_h—d
 
	mwa™_li¡
;

334 
li¡_h—d
 
	mf¡rim_li¡
;

335 
wa™_queue_h—d_t
 
	mdisÿrd_wa™_queue
;

336 
	mdisÿrd_wake
;

337 
mu‹x
 
	mcmd_lock
;

338 
	mÄ_disÿrds
;

339 
	mmax_disÿrds
;

340 
	mdisÿrd_g¿nuÏr™y
;

341 
	mundisÿrd_blks
;

342 
	mÃxt_pos
;

343 
©omic_t
 
	missued_disÿrd
;

344 
©omic_t
 
	mqueued_disÿrd
;

345 
©omic_t
 
	mdisÿrd_cmd_út
;

346 
rb_roÙ_ÿched
 
	mroÙ
;

347 
boŞ
 
	mrbŒ“_check
;

351 
	sfsync_šode_’Œy
 {

352 
li¡_h—d
 
	mli¡
;

353 
šode
 *
	mšode
;

354 
block_t
 
	mblkaddr
;

355 
block_t
 
	mÏ¡_d’Œy
;

358 
	#Çts_š_cursum
(
jÆ
è(
	`Ë16_to_ıu
((jÆ)->
n_Çts
))

	)

359 
	#s™s_š_cursum
(
jÆ
è(
	`Ë16_to_ıu
((jÆ)->
n_s™s
))

	)

361 
	#Çt_š_jouº®
(
jÆ
, 
i
è((jÆ)->
Çt_j
.
’Œ›s
[i].
Ã
)

	)

362 
	#nid_š_jouº®
(
jÆ
, 
i
è((jÆ)->
Çt_j
.
’Œ›s
[i].
nid
)

	)

363 
	#s™_š_jouº®
(
jÆ
, 
i
è((jÆ)->
s™_j
.
’Œ›s
[i].
£
)

	)

364 
	#£gno_š_jouº®
(
jÆ
, 
i
è((jÆ)->
s™_j
.
’Œ›s
[i].
£gno
)

	)

366 
	#MAX_NAT_JENTRIES
(
jÆ
è(
NAT_JOURNAL_ENTRIES
 - 
	`Çts_š_cursum
(jÆ))

	)

367 
	#MAX_SIT_JENTRIES
(
jÆ
è(
SIT_JOURNAL_ENTRIES
 - 
	`s™s_š_cursum
(jÆ))

	)

369 
šlše
 
	$upd©e_Çts_š_cursum
(
f2fs_jouº®
 *
jouº®
, 
i
)

371 
befÜe
 = 
	`Çts_š_cursum
(
jouº®
);

373 
jouº®
->
n_Çts
 = 
	`ıu_to_Ë16
(
befÜe
 + 
i
);

374  
befÜe
;

375 
	}
}

377 
šlše
 
	$upd©e_s™s_š_cursum
(
f2fs_jouº®
 *
jouº®
, 
i
)

379 
befÜe
 = 
	`s™s_š_cursum
(
jouº®
);

381 
jouº®
->
n_s™s
 = 
	`ıu_to_Ë16
(
befÜe
 + 
i
);

382  
befÜe
;

383 
	}
}

385 
šlše
 
boŞ
 
	$__has_cursum_¥aû
(
f2fs_jouº®
 *
jouº®
,

386 
size
, 
ty³
)

388 ià(
ty³
 =ğ
NAT_JOURNAL
)

389  
size
 <ğ
	`MAX_NAT_JENTRIES
(
jouº®
);

390  
size
 <ğ
	`MAX_SIT_JENTRIES
(
jouº®
);

391 
	}
}

396 
	#F2FS_IOC_GETFLAGS
 
FS_IOC_GETFLAGS


	)

397 
	#F2FS_IOC_SETFLAGS
 
FS_IOC_SETFLAGS


	)

398 
	#F2FS_IOC_GETVERSION
 
FS_IOC_GETVERSION


	)

400 
	#F2FS_IOCTL_MAGIC
 0xf5

	)

401 
	#F2FS_IOC_START_ATOMIC_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 1)

	)

402 
	#F2FS_IOC_COMMIT_ATOMIC_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 2)

	)

403 
	#F2FS_IOC_START_VOLATILE_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 3)

	)

404 
	#F2FS_IOC_RELEASE_VOLATILE_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 4)

	)

405 
	#F2FS_IOC_ABORT_VOLATILE_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 5)

	)

406 
	#F2FS_IOC_GARBAGE_COLLECT
 
	`_IOW
(
F2FS_IOCTL_MAGIC
, 6, 
__u32
)

	)

407 
	#F2FS_IOC_WRITE_CHECKPOINT
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 7)

	)

408 
	#F2FS_IOC_DEFRAGMENT
 
	`_IOWR
(
F2FS_IOCTL_MAGIC
, 8, \

409 
f2fs_deäagm’t
)

	)

410 
	#F2FS_IOC_MOVE_RANGE
 
	`_IOWR
(
F2FS_IOCTL_MAGIC
, 9, \

411 
f2fs_move_¿nge
)

	)

412 
	#F2FS_IOC_FLUSH_DEVICE
 
	`_IOW
(
F2FS_IOCTL_MAGIC
, 10, \

413 
f2fs_æush_deviû
)

	)

414 
	#F2FS_IOC_GARBAGE_COLLECT_RANGE
 
	`_IOW
(
F2FS_IOCTL_MAGIC
, 11, \

415 
f2fs_gc_¿nge
)

	)

416 
	#F2FS_IOC_GET_FEATURES
 
	`_IOR
(
F2FS_IOCTL_MAGIC
, 12, 
__u32
)

	)

417 
	#F2FS_IOC_SET_PIN_FILE
 
	`_IOW
(
F2FS_IOCTL_MAGIC
, 13, 
__u32
)

	)

418 
	#F2FS_IOC_GET_PIN_FILE
 
	`_IOR
(
F2FS_IOCTL_MAGIC
, 14, 
__u32
)

	)

419 
	#F2FS_IOC_PRECACHE_EXTENTS
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 15)

	)

420 
	#F2FS_IOC_RESIZE_FS
 
	`_IOW
(
F2FS_IOCTL_MAGIC
, 16, 
__u64
)

	)

422 
	#F2FS_IOC_GET_VOLUME_NAME
 
FS_IOC_GETFSLABEL


	)

423 
	#F2FS_IOC_SET_VOLUME_NAME
 
FS_IOC_SETFSLABEL


	)

425 
	#F2FS_IOC_SET_ENCRYPTION_POLICY
 
FS_IOC_SET_ENCRYPTION_POLICY


	)

426 
	#F2FS_IOC_GET_ENCRYPTION_POLICY
 
FS_IOC_GET_ENCRYPTION_POLICY


	)

427 
	#F2FS_IOC_GET_ENCRYPTION_PWSALT
 
FS_IOC_GET_ENCRYPTION_PWSALT


	)

433 
	#F2FS_IOC_SHUTDOWN
 
	`_IOR
('X', 125, 
__u32
è

	)

434 
	#F2FS_GOING_DOWN_FULLSYNC
 0x0

	)

435 
	#F2FS_GOING_DOWN_METASYNC
 0x1

	)

436 
	#F2FS_GOING_DOWN_NOSYNC
 0x2

	)

437 
	#F2FS_GOING_DOWN_METAFLUSH
 0x3

	)

438 
	#F2FS_GOING_DOWN_NEED_FSCK
 0x4

	)

440 #ià
defšed
(
__KERNEL__
è&& defšed(
CONFIG_COMPAT
)

444 
	#F2FS_IOC32_GETFLAGS
 
FS_IOC32_GETFLAGS


	)

445 
	#F2FS_IOC32_SETFLAGS
 
FS_IOC32_SETFLAGS


	)

446 
	#F2FS_IOC32_GETVERSION
 
FS_IOC32_GETVERSION


	)

449 
	#F2FS_IOC_FSGETXATTR
 
FS_IOC_FSGETXATTR


	)

450 
	#F2FS_IOC_FSSETXATTR
 
FS_IOC_FSSETXATTR


	)

452 
	sf2fs_gc_¿nge
 {

453 
u32
 
	msync
;

454 
u64
 
	m¡¬t
;

455 
u64
 
	mËn
;

458 
	sf2fs_deäagm’t
 {

459 
u64
 
	m¡¬t
;

460 
u64
 
	mËn
;

463 
	sf2fs_move_¿nge
 {

464 
u32
 
	md¡_fd
;

465 
u64
 
	mpos_š
;

466 
u64
 
	mpos_out
;

467 
u64
 
	mËn
;

470 
	sf2fs_æush_deviû
 {

471 
u32
 
	mdev_num
;

472 
u32
 
	m£gm’ts
;

476 
	#DEF_INLINE_RESERVED_SIZE
 1

	)

477 
šlše
 
g‘_exŒa_isize
(
šode
 *inode);

478 
šlše
 
g‘_šlše_x©Œ_addrs
(
šode
 *inode);

479 
	#MAX_INLINE_DATA
(
šode
è((
__Ë32
) * \

480 (
	`CUR_ADDRS_PER_INODE
(
šode
) - \

481 
	`g‘_šlše_x©Œ_addrs
(
šode
) - \

482 
DEF_INLINE_RESERVED_SIZE
))

	)

485 
	#NR_INLINE_DENTRY
(
šode
è(
	`MAX_INLINE_DATA
(šodeè* 
BITS_PER_BYTE
 / \

486 ((
SIZE_OF_DIR_ENTRY
 + 
F2FS_SLOT_LEN
) * \

487 
BITS_PER_BYTE
 + 1))

	)

488 
	#INLINE_DENTRY_BITMAP_SIZE
(
šode
) \

489 
	`DIV_ROUND_UP
(
	`NR_INLINE_DENTRY
(
šode
), 
BITS_PER_BYTE
)

	)

490 
	#INLINE_RESERVED_SIZE
(
šode
è(
	`MAX_INLINE_DATA
(inode) - \

491 ((
SIZE_OF_DIR_ENTRY
 + 
F2FS_SLOT_LEN
) * \

492 
	`NR_INLINE_DENTRY
(
šode
) + \

493 
	`INLINE_DENTRY_BITMAP_SIZE
(
šode
)))

	)

499 
	sf2fs_d’Œy_±r
 {

500 
šode
 *
	mšode
;

501 *
	mb™m­
;

502 
f2fs_dœ_’Œy
 *
	md’Œy
;

503 
__u8
 (*
f’ame
)[
F2FS_SLOT_LEN
];

504 
	mmax
;

505 
	mÄ_b™m­
;

508 
šlše
 
	$make_d’Œy_±r_block
(
šode
 *inode,

509 
f2fs_d’Œy_±r
 *
d
, 
f2fs_d’Œy_block
 *
t
)

511 
d
->
šode
 = inode;

512 
d
->
max
 = 
NR_DENTRY_IN_BLOCK
;

513 
d
->
Ä_b™m­
 = 
SIZE_OF_DENTRY_BITMAP
;

514 
d
->
b™m­
 = 
t
->
d’Œy_b™m­
;

515 
d
->
d’Œy
 = 
t
->dentry;

516 
d
->
f’ame
 = 
t
->filename;

517 
	}
}

519 
šlše
 
	$make_d’Œy_±r_šlše
(
šode
 *inode,

520 
f2fs_d’Œy_±r
 *
d
, *
t
)

522 
’Œy_út
 = 
	`NR_INLINE_DENTRY
(
šode
);

523 
b™m­_size
 = 
	`INLINE_DENTRY_BITMAP_SIZE
(
šode
);

524 
»£rved_size
 = 
	`INLINE_RESERVED_SIZE
(
šode
);

526 
d
->
šode
 = inode;

527 
d
->
max
 = 
’Œy_út
;

528 
d
->
Ä_b™m­
 = 
b™m­_size
;

529 
d
->
b™m­
 = 
t
;

530 
d
->
d’Œy
 = 
t
 + 
b™m­_size
 + 
»£rved_size
;

531 
d
->
f’ame
 = 
t
 + 
b™m­_size
 + 
»£rved_size
 +

532 
SIZE_OF_DIR_ENTRY
 * 
’Œy_út
;

533 
	}
}

540 
	#XATTR_NODE_OFFSET
 (((()-1è<< 
OFFSET_BIT_SHIFT
) \

541 >> 
OFFSET_BIT_SHIFT
)

	)

543 
	mALLOC_NODE
,

544 
	mLOOKUP_NODE
,

545 
	mLOOKUP_NODE_RA
,

551 
	#DEFAULT_RETRY_IO_COUNT
 8

	)

554 
	#DEFAULT_RETRY_QUOTA_FLUSH_COUNT
 8

	)

556 
	#F2FS_LINK_MAX
 0xfffffffà

	)

558 
	#MAX_DIR_RA_PAGES
 4

	)

561 
	#F2FS_MIN_EXTENT_LEN
 64

	)

564 
	#EXTENT_CACHE_SHRINK_NUMBER
 128

	)

566 
	srb_’Œy
 {

567 
rb_node
 
	mrb_node
;

568 
	mofs
;

569 
	mËn
;

572 
	sex‹Á_šfo
 {

573 
	mfofs
;

574 
	mËn
;

575 
u32
 
	mblk
;

578 
	sex‹Á_node
 {

579 
rb_node
 
	mrb_node
;

580 
ex‹Á_šfo
 
	mei
;

581 
li¡_h—d
 
	mli¡
;

582 
ex‹Á_Œ“
 *
	m‘
;

585 
	sex‹Á_Œ“
 {

586 
nid_t
 
	mšo
;

587 
rb_roÙ_ÿched
 
	mroÙ
;

588 
ex‹Á_node
 *
	mÿched_’
;

589 
ex‹Á_šfo
 
	mÏrge¡
;

590 
li¡_h—d
 
	mli¡
;

591 
rwlock_t
 
	mlock
;

592 
©omic_t
 
	mnode_út
;

593 
boŞ
 
	mÏrge¡_upd©ed
;

601 
	#F2FS_MAP_NEW
 (1 << 
BH_New
)

	)

602 
	#F2FS_MAP_MAPPED
 (1 << 
BH_M­³d
)

	)

603 
	#F2FS_MAP_UNWRITTEN
 (1 << 
BH_Unwr™‹n
)

	)

604 
	#F2FS_MAP_FLAGS
 (
F2FS_MAP_NEW
 | 
F2FS_MAP_MAPPED
 |\

605 
F2FS_MAP_UNWRITTEN
)

	)

607 
	sf2fs_m­_blocks
 {

608 
block_t
 
	mm_pblk
;

609 
block_t
 
	mm_lblk
;

610 
	mm_Ën
;

611 
	mm_æags
;

612 
pgoff_t
 *
	mm_Ãxt_pgofs
;

613 
pgoff_t
 *
	mm_Ãxt_ex‹Á
;

614 
	mm_£g_ty³
;

615 
boŞ
 
	mm_may_ü—‹
;

620 
	mF2FS_GET_BLOCK_DEFAULT
,

621 
	mF2FS_GET_BLOCK_FIEMAP
,

622 
	mF2FS_GET_BLOCK_BMAP
,

623 
	mF2FS_GET_BLOCK_DIO
,

624 
	mF2FS_GET_BLOCK_PRE_DIO
,

625 
	mF2FS_GET_BLOCK_PRE_AIO
,

626 
	mF2FS_GET_BLOCK_PRECACHE
,

632 
	#FADVISE_COLD_BIT
 0x01

	)

633 
	#FADVISE_LOST_PINO_BIT
 0x02

	)

634 
	#FADVISE_ENCRYPT_BIT
 0x04

	)

635 
	#FADVISE_ENC_NAME_BIT
 0x08

	)

636 
	#FADVISE_KEEP_SIZE_BIT
 0x10

	)

637 
	#FADVISE_HOT_BIT
 0x20

	)

638 
	#FADVISE_VERITY_BIT
 0x40

	)

640 
	#FADVISE_MODIFIABLE_BITS
 (
FADVISE_COLD_BIT
 | 
FADVISE_HOT_BIT
)

	)

642 
	#fe_is_cŞd
(
šode
è
	`is_fe
(šode, 
FADVISE_COLD_BIT
)

	)

643 
	#fe_wrÚg_pšo
(
šode
è
	`is_fe
(šode, 
FADVISE_LOST_PINO_BIT
)

	)

644 
	#fe_£t_cŞd
(
šode
è
	`£t_fe
(šode, 
FADVISE_COLD_BIT
)

	)

645 
	#fe_lo¡_pšo
(
šode
è
	`£t_fe
(šode, 
FADVISE_LOST_PINO_BIT
)

	)

646 
	#fe_ş—r_cŞd
(
šode
è
	`ş—r_fe
(šode, 
FADVISE_COLD_BIT
)

	)

647 
	#fe_gÙ_pšo
(
šode
è
	`ş—r_fe
(šode, 
FADVISE_LOST_PINO_BIT
)

	)

648 
	#fe_is_’üy±
(
šode
è
	`is_fe
(šode, 
FADVISE_ENCRYPT_BIT
)

	)

649 
	#fe_£t_’üy±
(
šode
è
	`£t_fe
(šode, 
FADVISE_ENCRYPT_BIT
)

	)

650 
	#fe_ş—r_’üy±
(
šode
è
	`ş—r_fe
(šode, 
FADVISE_ENCRYPT_BIT
)

	)

651 
	#fe_’c_Çme
(
šode
è
	`is_fe
(šode, 
FADVISE_ENC_NAME_BIT
)

	)

652 
	#fe_£t_’c_Çme
(
šode
è
	`£t_fe
(šode, 
FADVISE_ENC_NAME_BIT
)

	)

653 
	#fe_k“p_isize
(
šode
è
	`is_fe
(šode, 
FADVISE_KEEP_SIZE_BIT
)

	)

654 
	#fe_£t_k“p_isize
(
šode
è
	`£t_fe
(šode, 
FADVISE_KEEP_SIZE_BIT
)

	)

655 
	#fe_is_hÙ
(
šode
è
	`is_fe
(šode, 
FADVISE_HOT_BIT
)

	)

656 
	#fe_£t_hÙ
(
šode
è
	`£t_fe
(šode, 
FADVISE_HOT_BIT
)

	)

657 
	#fe_ş—r_hÙ
(
šode
è
	`ş—r_fe
(šode, 
FADVISE_HOT_BIT
)

	)

658 
	#fe_is_v”™y
(
šode
è
	`is_fe
(šode, 
FADVISE_VERITY_BIT
)

	)

659 
	#fe_£t_v”™y
(
šode
è
	`£t_fe
(šode, 
FADVISE_VERITY_BIT
)

	)

661 
	#DEF_DIR_LEVEL
 0

	)

664 
	mGC_FAILURE_PIN
,

665 
	mGC_FAILURE_ATOMIC
,

666 
	mMAX_GC_FAILURE


669 
	sf2fs_šode_šfo
 {

670 
šode
 
	mvfs_šode
;

671 
	mi_æags
;

672 
	mi_advi£
;

673 
	mi_dœ_Ëv–
;

674 
	mi_cu¼’t_d•th
;

676 
	mi_gc_çu»s
[
MAX_GC_FAILURE
];

677 
	mi_pšo
;

678 
umode_t
 
	mi_aş_mode
;

681 
	mæags
;

682 
rw_£m­hÜe
 
	mi_£m
;

683 
©omic_t
 
	mdœty_·ges
;

684 
f2fs_hash_t
 
	mchash
;

685 
	mşev–
;

686 
sk_¡ruù
 *
	msk
;

687 
sk_¡ruù
 *
	mı_sk
;

688 
nid_t
 
	mi_x©Œ_nid
;

689 
loff_t
 
	mÏ¡_disk_size
;

691 #ifdeà
CONFIG_QUOTA


692 
dquÙ
 *
	mi_dquÙ
[
MAXQUOTAS
];

695 
qsize_t
 
	mi_»£rved_quÙa
;

697 
li¡_h—d
 
	mdœty_li¡
;

698 
li¡_h—d
 
	mgdœty_li¡
;

699 
li¡_h—d
 
	mšmem_i¡
;

700 
li¡_h—d
 
	mšmem_·ges
;

701 
sk_¡ruù
 *
	mšmem_sk
;

702 
mu‹x
 
	mšmem_lock
;

703 
ex‹Á_Œ“
 *
	mex‹Á_Œ“
;

706 
rw_£m­hÜe
 
	mi_gc_rw£m
[2];

707 
rw_£m­hÜe
 
	mi_mm­_£m
;

708 
rw_£m­hÜe
 
	mi_x©Œ_£m
;

710 
	mi_exŒa_isize
;

711 
k´ojid_t
 
	mi_´ojid
;

712 
	mi_šlše_x©Œ_size
;

713 
time¥ec64
 
	mi_ütime
;

714 
time¥ec64
 
	mi_disk_time
[4];

717 
šlše
 
	$g‘_ex‹Á_šfo
(
ex‹Á_šfo
 *
ext
,

718 
f2fs_ex‹Á
 *
i_ext
)

720 
ext
->
fofs
 = 
	`Ë32_to_ıu
(
i_ext
->fofs);

721 
ext
->
blk
 = 
	`Ë32_to_ıu
(
i_ext
->blk);

722 
ext
->
Ën
 = 
	`Ë32_to_ıu
(
i_ext
->len);

723 
	}
}

725 
šlše
 
	$£t_¿w_ex‹Á
(
ex‹Á_šfo
 *
ext
,

726 
f2fs_ex‹Á
 *
i_ext
)

728 
i_ext
->
fofs
 = 
	`ıu_to_Ë32
(
ext
->fofs);

729 
i_ext
->
blk
 = 
	`ıu_to_Ë32
(
ext
->blk);

730 
i_ext
->
Ën
 = 
	`ıu_to_Ë32
(
ext
->len);

731 
	}
}

733 
šlše
 
	$£t_ex‹Á_šfo
(
ex‹Á_šfo
 *
ei
, 
fofs
,

734 
u32
 
blk
, 
Ën
)

736 
ei
->
fofs
 = fofs;

737 
ei
->
blk
 = blk;

738 
ei
->
Ën
 =†en;

739 
	}
}

741 
šlše
 
boŞ
 
	$__is_disÿrd_m”g—bË
(
disÿrd_šfo
 *
back
,

742 
disÿrd_šfo
 *
äÚt
, 
max_Ën
)

744  (
back
->
l¡¬t
 + back->
Ën
 =ğ
äÚt
->lstart) &&

745 (
back
->
Ën
 + 
äÚt
->ËÀ<ğ
max_Ën
);

746 
	}
}

748 
šlše
 
boŞ
 
	$__is_disÿrd_back_m”g—bË
(
disÿrd_šfo
 *
cur
,

749 
disÿrd_šfo
 *
back
, 
max_Ën
)

751  
	`__is_disÿrd_m”g—bË
(
back
, 
cur
, 
max_Ën
);

752 
	}
}

754 
šlše
 
boŞ
 
	$__is_disÿrd_äÚt_m”g—bË
(
disÿrd_šfo
 *
cur
,

755 
disÿrd_šfo
 *
äÚt
, 
max_Ën
)

757  
	`__is_disÿrd_m”g—bË
(
cur
, 
äÚt
, 
max_Ën
);

758 
	}
}

760 
šlše
 
boŞ
 
	$__is_ex‹Á_m”g—bË
(
ex‹Á_šfo
 *
back
,

761 
ex‹Á_šfo
 *
äÚt
)

763  (
back
->
fofs
 + back->
Ën
 =ğ
äÚt
->fofs &&

764 
back
->
blk
 + back->
Ën
 =ğ
äÚt
->blk);

765 
	}
}

767 
šlše
 
boŞ
 
	$__is_back_m”g—bË
(
ex‹Á_šfo
 *
cur
,

768 
ex‹Á_šfo
 *
back
)

770  
	`__is_ex‹Á_m”g—bË
(
back
, 
cur
);

771 
	}
}

773 
šlše
 
boŞ
 
	$__is_äÚt_m”g—bË
(
ex‹Á_šfo
 *
cur
,

774 
ex‹Á_šfo
 *
äÚt
)

776  
	`__is_ex‹Á_m”g—bË
(
cur
, 
äÚt
);

777 
	}
}

779 
f2fs_m¬k_šode_dœty_sync
(
šode
 *šode, 
boŞ
 
sync
);

780 
šlše
 
	$__Œy_upd©e_Ïrge¡_ex‹Á
(
ex‹Á_Œ“
 *
‘
,

781 
ex‹Á_node
 *
’
)

783 ià(
’
->
ei
.
Ën
 > 
‘
->
Ïrge¡
.len) {

784 
‘
->
Ïrge¡
 = 
’
->
ei
;

785 
‘
->
Ïrge¡_upd©ed
 = 
Œue
;

787 
	}
}

792 
	enid_¡©e
 {

793 
	mFREE_NID
,

794 
	mPREALLOC_NID
,

795 
	mMAX_NID_STATE
,

798 
	sf2fs_nm_šfo
 {

799 
block_t
 
	mÇt_blkaddr
;

800 
nid_t
 
	mmax_nid
;

801 
nid_t
 
	mavaabË_nids
;

802 
nid_t
 
	mÃxt_sÿn_nid
;

803 
	m¿m_th»sh
;

804 
	m¿_nid_·ges
;

805 
	mdœty_Çts_¿tio
;

808 
¿dix_Œ“_roÙ
 
	mÇt_roÙ
;

809 
¿dix_Œ“_roÙ
 
	mÇt_£t_roÙ
;

810 
rw_£m­hÜe
 
	mÇt_Œ“_lock
;

811 
li¡_h—d
 
	mÇt_’Œ›s
;

812 
¥šlock_t
 
	mÇt_li¡_lock
;

813 
	mÇt_út
;

814 
	mdœty_Çt_út
;

815 
	mÇt_blocks
;

818 
¿dix_Œ“_roÙ
 
	mä“_nid_roÙ
;

819 
li¡_h—d
 
	mä“_nid_li¡
;

820 
	mnid_út
[
MAX_NID_STATE
];

821 
¥šlock_t
 
	mnid_li¡_lock
;

822 
mu‹x
 
	mbud_lock
;

823 **
	mä“_nid_b™m­
;

824 *
	mÇt_block_b™m­
;

825 *
	mä“_nid_couÁ
;

828 *
	mÇt_b™m­
;

830 
	mÇt_b™s_blocks
;

831 *
	mÇt_b™s
;

832 *
	mfuÎ_Çt_b™s
;

833 *
	mem±y_Çt_b™s
;

834 #ifdeà
CONFIG_F2FS_CHECK_FS


835 *
	mÇt_b™m­_mœ
;

837 
	mb™m­_size
;

845 
	sdnode_of_d©a
 {

846 
šode
 *
	mšode
;

847 
·ge
 *
	mšode_·ge
;

848 
·ge
 *
	mnode_·ge
;

849 
nid_t
 
	mnid
;

850 
	mofs_š_node
;

851 
boŞ
 
	mšode_·ge_locked
;

852 
boŞ
 
	mnode_chªged
;

853 
	mcur_Ëv–
;

854 
	mmax_Ëv–
;

855 
block_t
 
	md©a_blkaddr
;

858 
šlše
 
	$£t_Ãw_dnode
(
dnode_of_d©a
 *
dn
, 
šode
 *inode,

859 
·ge
 *
age
, ·g*
Åage
, 
nid_t
 
nid
)

861 
	`mem£t
(
dn
, 0, (*dn));

862 
dn
->
šode
 = inode;

863 
dn
->
šode_·ge
 = 
age
;

864 
dn
->
node_·ge
 = 
Åage
;

865 
dn
->
nid
 =‚id;

866 
	}
}

881 
	#NR_CURSEG_DATA_TYPE
 (3)

	)

882 
	#NR_CURSEG_NODE_TYPE
 (3)

	)

883 
	#NR_CURSEG_TYPE
 (
NR_CURSEG_DATA_TYPE
 + 
NR_CURSEG_NODE_TYPE
)

	)

886 
	mCURSEG_HOT_DATA
 = 0,

887 
	mCURSEG_WARM_DATA
,

888 
	mCURSEG_COLD_DATA
,

889 
	mCURSEG_HOT_NODE
,

890 
	mCURSEG_WARM_NODE
,

891 
	mCURSEG_COLD_NODE
,

892 
	mNO_CHECK_TYPE
,

895 
	sæush_cmd
 {

896 
com¶‘iÚ
 
	mwa™
;

897 
Îi¡_node
 
	mÎnode
;

898 
nid_t
 
	mšo
;

899 
	m»t
;

902 
	sæush_cmd_cÚŒŞ
 {

903 
sk_¡ruù
 *
	mf2fs_issue_æush
;

904 
wa™_queue_h—d_t
 
	mæush_wa™_queue
;

905 
©omic_t
 
	missued_æush
;

906 
©omic_t
 
	mqueued_æush
;

907 
Îi¡_h—d
 
	missue_li¡
;

908 
Îi¡_node
 *
	mdi¥©ch_li¡
;

911 
	sf2fs_sm_šfo
 {

912 
s™_šfo
 *
	ms™_šfo
;

913 
ä“_£gm­_šfo
 *
	mä“_šfo
;

914 
dœty_£gli¡_šfo
 *
	mdœty_šfo
;

915 
cur£g_šfo
 *
	mcur£g_¬¿y
;

917 
rw_£m­hÜe
 
	mcur£g_lock
;

919 
block_t
 
	m£g0_blkaddr
;

920 
block_t
 
	mmaš_blkaddr
;

921 
block_t
 
	ms§_blkaddr
;

923 
	m£gm’t_couÁ
;

924 
	mmaš_£gm’ts
;

925 
	m»£rved_£gm’ts
;

926 
	movp_£gm’ts
;

929 
	m»c_´eä“_£gm’ts
;

932 
	mŒim_£ùiÚs
;

934 
li¡_h—d
 
	ms™_’Œy_£t
;

936 
	mu_pŞicy
;

937 
	mmš_u_ut
;

938 
	mmš_fsync_blocks
;

939 
	mmš_£q_blocks
;

940 
	mmš_hÙ_blocks
;

941 
	mmš_s¤_£ùiÚs
;

944 
æush_cmd_cÚŒŞ
 *
	mfcc_šfo
;

947 
disÿrd_cmd_cÚŒŞ
 *
	mdcc_šfo
;

959 
	#WB_DATA_TYPE
(
p
è(
	`__is_ı_gu¬ª‹ed
Õè? 
F2FS_WB_CP_DATA
 : 
F2FS_WB_DATA
)

	)

960 
	ecouÁ_ty³
 {

961 
	mF2FS_DIRTY_DENTS
,

962 
	mF2FS_DIRTY_DATA
,

963 
	mF2FS_DIRTY_QDATA
,

964 
	mF2FS_DIRTY_NODES
,

965 
	mF2FS_DIRTY_META
,

966 
	mF2FS_INMEM_PAGES
,

967 
	mF2FS_DIRTY_IMETA
,

968 
	mF2FS_WB_CP_DATA
,

969 
	mF2FS_WB_DATA
,

970 
	mF2FS_RD_DATA
,

971 
	mF2FS_RD_NODE
,

972 
	mF2FS_RD_META
,

973 
	mF2FS_DIO_WRITE
,

974 
	mF2FS_DIO_READ
,

975 
	mNR_COUNT_TYPE
,

989 
	#PAGE_TYPE_OF_BIO
(
ty³
è(Ñy³è> 
META
 ? META : (ty³))

	)

990 
	e·ge_ty³
 {

991 
	mDATA
,

992 
	mNODE
,

993 
	mMETA
,

994 
	mNR_PAGE_TYPE
,

995 
	mMETA_FLUSH
,

996 
	mINMEM
,

997 
	mINMEM_DROP
,

998 
	mINMEM_INVALIDATE
,

999 
	mINMEM_REVOKE
,

1000 
	mIPU
,

1001 
	mOPU
,

1004 
	e‹mp_ty³
 {

1005 
	mHOT
 = 0,

1006 
	mWARM
,

1007 
	mCOLD
,

1008 
	mNR_TEMP_TYPE
,

1011 
	eÃed_lock_ty³
 {

1012 
	mLOCK_REQ
 = 0,

1013 
	mLOCK_DONE
,

1014 
	mLOCK_RETRY
,

1017 
	eı_»asÚ_ty³
 {

1018 
	mCP_NO_NEEDED
,

1019 
	mCP_NON_REGULAR
,

1020 
	mCP_HARDLINK
,

1021 
	mCP_SB_NEED_CP
,

1022 
	mCP_WRONG_PINO
,

1023 
	mCP_NO_SPC_ROLL
,

1024 
	mCP_NODE_NEED_CP
,

1025 
	mCP_FASTBOOT_MODE
,

1026 
	mCP_SPEC_LOG_NUM
,

1027 
	mCP_RECOVER_DIR
,

1030 
	eio¡©_ty³
 {

1031 
	mAPP_DIRECT_IO
,

1032 
	mAPP_BUFFERED_IO
,

1033 
	mAPP_WRITE_IO
,

1034 
	mAPP_MAPPED_IO
,

1035 
	mFS_DATA_IO
,

1036 
	mFS_NODE_IO
,

1037 
	mFS_META_IO
,

1038 
	mFS_GC_DATA_IO
,

1039 
	mFS_GC_NODE_IO
,

1040 
	mFS_CP_DATA_IO
,

1041 
	mFS_CP_NODE_IO
,

1042 
	mFS_CP_META_IO
,

1043 
	mFS_DISCARD
,

1044 
	mNR_IO_TYPE
,

1047 
	sf2fs_io_šfo
 {

1048 
f2fs_sb_šfo
 *
	msbi
;

1049 
nid_t
 
	mšo
;

1050 
·ge_ty³
 
	mty³
;

1051 
‹mp_ty³
 
	m‹mp
;

1052 
	mİ
;

1053 
	mİ_æags
;

1054 
block_t
 
	mÃw_blkaddr
;

1055 
block_t
 
	mŞd_blkaddr
;

1056 
·ge
 *
	m·ge
;

1057 
·ge
 *
	m’üy±ed_·ge
;

1058 
li¡_h—d
 
	mli¡
;

1059 
boŞ
 
	msubm™‹d
;

1060 
	mÃed_lock
;

1061 
boŞ
 
	mš_li¡
;

1062 
boŞ
 
	mis_pÜ
;

1063 
boŞ
 
	m»Œy
;

1064 
io¡©_ty³
 
	mio_ty³
;

1065 
wr™eback_cÚŒŞ
 *
	mio_wbc
;

1066 
bio
 **
	mbio
;

1067 
£ùÜ_t
 *
	mÏ¡_block
;

1068 
	mv”siÚ
;

1071 
	#is_»ad_io
(
rw
è(Ôwè=ğ
READ
)

	)

1072 
	sf2fs_bio_šfo
 {

1073 
f2fs_sb_šfo
 *
	msbi
;

1074 
bio
 *
	mbio
;

1075 
£ùÜ_t
 
	mÏ¡_block_š_bio
;

1076 
f2fs_io_šfo
 
	mfio
;

1077 
rw_£m­hÜe
 
	mio_rw£m
;

1078 
¥šlock_t
 
	mio_lock
;

1079 
li¡_h—d
 
	mio_li¡
;

1082 
	#FDEV
(
i
è(
sbi
->
devs
[i])

	)

1083 
	#RDEV
(
i
è(
¿w_su³r
->
devs
[i])

	)

1084 
	sf2fs_dev_šfo
 {

1085 
block_deviû
 *
	mbdev
;

1086 
	m·th
[
MAX_PATH_LEN
];

1087 
	mtÙ®_£gm’ts
;

1088 
block_t
 
	m¡¬t_blk
;

1089 
block_t
 
	m’d_blk
;

1090 #ifdeà
CONFIG_BLK_DEV_ZONED


1091 
	mÄ_blkz
;

1092 *
	mblkz_£q
;

1096 
	ešode_ty³
 {

1097 
	mDIR_INODE
,

1098 
	mFILE_INODE
,

1099 
	mDIRTY_META
,

1100 
	mATOMIC_FILE
,

1101 
	mNR_INODE_TYPE
,

1105 
	sšode_mªagem’t
 {

1106 
¿dix_Œ“_roÙ
 
	mšo_roÙ
;

1107 
¥šlock_t
 
	mšo_lock
;

1108 
li¡_h—d
 
	mšo_li¡
;

1109 
	mšo_num
;

1114 
	mSBI_IS_DIRTY
,

1115 
	mSBI_IS_CLOSE
,

1116 
	mSBI_NEED_FSCK
,

1117 
	mSBI_POR_DOING
,

1118 
	mSBI_NEED_SB_WRITE
,

1119 
	mSBI_NEED_CP
,

1120 
	mSBI_IS_SHUTDOWN
,

1121 
	mSBI_IS_RECOVERED
,

1122 
	mSBI_CP_DISABLED
,

1123 
	mSBI_CP_DISABLED_QUICK
,

1124 
	mSBI_QUOTA_NEED_FLUSH
,

1125 
	mSBI_QUOTA_SKIP_FLUSH
,

1126 
	mSBI_QUOTA_NEED_REPAIR
,

1127 
	mSBI_IS_RESIZEFS
,

1131 
	mCP_TIME
,

1132 
	mREQ_TIME
,

1133 
	mDISCARD_TIME
,

1134 
	mGC_TIME
,

1135 
	mDISABLE_TIME
,

1136 
	mUMOUNT_DISCARD_TIMEOUT
,

1137 
	mMAX_TIME
,

1141 
	mGC_NORMAL
,

1142 
	mGC_IDLE_CB
,

1143 
	mGC_IDLE_GREEDY
,

1144 
	mGC_URGENT
,

1148 
	mWHINT_MODE_OFF
,

1149 
	mWHINT_MODE_USER
,

1150 
	mWHINT_MODE_FS
,

1154 
	mALLOC_MODE_DEFAULT
,

1155 
	mALLOC_MODE_REUSE
,

1158 
	efsync_mode
 {

1159 
	mFSYNC_MODE_POSIX
,

1160 
	mFSYNC_MODE_STRICT
,

1161 
	mFSYNC_MODE_NOBARRIER
,

1164 #ifdeà
CONFIG_FS_ENCRYPTION


1165 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
) \

1166 (
	`uÆik–y
(
	`F2FS_OPTION
(
sbi
).
‹¡_dummy_’üy±iÚ
))

	)

1168 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
è(0)

	)

1171 
	sf2fs_sb_šfo
 {

1172 
su³r_block
 *
	msb
;

1173 
´oc_dœ_’Œy
 *
	ms_´oc
;

1174 
f2fs_su³r_block
 *
	m¿w_su³r
;

1175 
rw_£m­hÜe
 
	msb_lock
;

1176 
	mv®id_su³r_block
;

1177 
	ms_æag
;

1178 
mu‹x
 
	mwr™•ages
;

1179 #ifdeà
CONFIG_UNICODE


1180 
unicode_m­
 *
	ms_’codšg
;

1181 
__u16
 
	ms_’codšg_æags
;

1184 #ifdeà
CONFIG_BLK_DEV_ZONED


1185 
	mblocks_³r_blkz
;

1186 
	mlog_blocks_³r_blkz
;

1190 
f2fs_nm_šfo
 *
	mnm_šfo
;

1191 
šode
 *
	mnode_šode
;

1194 
f2fs_sm_šfo
 *
	msm_šfo
;

1197 
f2fs_bio_šfo
 *
	mwr™e_io
[
NR_PAGE_TYPE
];

1199 
rw_£m­hÜe
 
	mio_Üd”_lock
;

1200 
mempoŞ_t
 *
	mwr™e_io_dummy
;

1203 
f2fs_checkpošt
 *
	mck±
;

1204 
	mcur_ı_·ck
;

1205 
¥šlock_t
 
	mı_lock
;

1206 
šode
 *
	mm‘a_šode
;

1207 
mu‹x
 
	mı_mu‹x
;

1208 
rw_£m­hÜe
 
	mı_rw£m
;

1209 
rw_£m­hÜe
 
	mnode_wr™e
;

1210 
rw_£m­hÜe
 
	mnode_chªge
;

1211 
wa™_queue_h—d_t
 
	mı_wa™
;

1212 
	mÏ¡_time
[
MAX_TIME
];

1213 
	mš‹rv®_time
[
MAX_TIME
];

1215 
šode_mªagem’t
 
	mim
[
MAX_INO_ENTRY
];

1217 
¥šlock_t
 
	mfsync_node_lock
;

1218 
li¡_h—d
 
	mfsync_node_li¡
;

1219 
	mfsync_£g_id
;

1220 
	mfsync_node_num
;

1223 
	mmax_Üphªs
;

1226 
li¡_h—d
 
	mšode_li¡
[
NR_INODE_TYPE
];

1227 
¥šlock_t
 
	mšode_lock
[
NR_INODE_TYPE
];

1228 
mu‹x
 
	mæush_lock
;

1231 
¿dix_Œ“_roÙ
 
	mex‹Á_Œ“_roÙ
;

1232 
mu‹x
 
	mex‹Á_Œ“_lock
;

1233 
li¡_h—d
 
	mex‹Á_li¡
;

1234 
¥šlock_t
 
	mex‹Á_lock
;

1235 
©omic_t
 
	mtÙ®_ext_Œ“
;

1236 
li¡_h—d
 
	mzomb›_li¡
;

1237 
©omic_t
 
	mtÙ®_zomb›_Œ“
;

1238 
©omic_t
 
	mtÙ®_ext_node
;

1241 
	mlog_£ùÜs_³r_block
;

1242 
	mlog_blocksize
;

1243 
	mblocksize
;

1244 
	mroÙ_šo_num
;

1245 
	mnode_šo_num
;

1246 
	mm‘a_šo_num
;

1247 
	mlog_blocks_³r_£g
;

1248 
	mblocks_³r_£g
;

1249 
	m£gs_³r_£c
;

1250 
	m£cs_³r_zÚe
;

1251 
	mtÙ®_£ùiÚs
;

1252 
mu‹x
 
	m»size_mu‹x
;

1253 
	mtÙ®_node_couÁ
;

1254 
	mtÙ®_v®id_node_couÁ
;

1255 
loff_t
 
	mmax_fe_blocks
;

1256 
	mdœ_Ëv–
;

1257 
	m»addœ_¿
;

1259 
block_t
 
	mu£r_block_couÁ
;

1260 
block_t
 
	mtÙ®_v®id_block_couÁ
;

1261 
block_t
 
	mdisÿrd_blks
;

1262 
block_t
 
	mÏ¡_v®id_block_couÁ
;

1263 
block_t
 
	m»£rved_blocks
;

1264 
block_t
 
	mcu¼’t_»£rved_blocks
;

1267 
block_t
 
	munu§bË_block_couÁ
;

1269 
	mnquÙa_fes
;

1270 
rw_£m­hÜe
 
	mquÙa_£m
;

1273 
©omic_t
 
	mÄ_·ges
[
NR_COUNT_TYPE
];

1275 
³rıu_couÁ”
 
	m®loc_v®id_block_couÁ
;

1278 
©omic_t
 
	mwb_sync_»q
[
META
];

1281 
³rıu_couÁ”
 
	mtÙ®_v®id_šode_couÁ
;

1283 
f2fs_mouÁ_šfo
 
	mmouÁ_İt
;

1286 
mu‹x
 
	mgc_mu‹x
;

1287 
f2fs_gc_kth»ad
 *
	mgc_th»ad
;

1288 
	mcur_viùim_£c
;

1289 
	mgc_mode
;

1290 
	mÃxt_viùim_£g
[2];

1292 
	m©omic_fes
;

1293 
	msk³d_©omic_fes
[2];

1294 
	msk³d_gc_rw£m
;

1297 
u64
 
	mgc_pš_fe_th»shŞd
;

1300 
	mmax_viùim_£¬ch
;

1302 
	mmig¿tiÚ_g¿nuÏr™y
;

1308 #ifdeà
CONFIG_F2FS_STAT_FS


1309 
f2fs_¡©_šfo
 *
	m¡©_šfo
;

1310 
©omic_t
 
	mm‘a_couÁ
[
META_MAX
];

1311 
	m£gm’t_couÁ
[2];

1312 
	mblock_couÁ
[2];

1313 
©omic_t
 
	mš¶aû_couÁ
;

1314 
©omic64_t
 
	mtÙ®_h™_ext
;

1315 
©omic64_t
 
	m»ad_h™_rbŒ“
;

1316 
©omic64_t
 
	m»ad_h™_Ïrge¡
;

1317 
©omic64_t
 
	m»ad_h™_ÿched
;

1318 
©omic_t
 
	mšlše_x©Œ
;

1319 
©omic_t
 
	mšlše_šode
;

1320 
©omic_t
 
	mšlše_dœ
;

1321 
©omic_t
 
	maw_út
;

1322 
©omic_t
 
	mvw_út
;

1323 
©omic_t
 
	mmax_aw_út
;

1324 
©omic_t
 
	mmax_vw_út
;

1325 
	mbg_gc
;

1326 
	mio_sk_bggc
;

1327 
	mÙh”_sk_bggc
;

1328 
	mndœty_šode
[
NR_INODE_TYPE
];

1330 
¥šlock_t
 
	m¡©_lock
;

1333 
¥šlock_t
 
	mio¡©_lock
;

1334 
	mwr™e_io¡©
[
NR_IO_TYPE
];

1335 
boŞ
 
	mio¡©_’abË
;

1338 
kobjeù
 
	ms_kobj
;

1339 
com¶‘iÚ
 
	ms_kobj_uÄegi¡”
;

1342 
li¡_h—d
 
	ms_li¡
;

1343 
	ms_ndevs
;

1344 
f2fs_dev_šfo
 *
	mdevs
;

1345 
	mdœty_deviû
;

1346 
¥šlock_t
 
	mdev_lock
;

1347 
mu‹x
 
	mumouÁ_mu‹x
;

1348 
	mshršk”_run_no
;

1351 
u64
 
	m£ùÜs_wr™‹n_¡¬t
;

1352 
u64
 
	mkby‹s_wr™‹n
;

1355 
üy±o_shash
 *
	ms_chksum_driv”
;

1358 
__u32
 
	ms_chksum_£ed
;

1361 
	sf2fs_´iv©e_dio
 {

1362 
šode
 *
	mšode
;

1363 *
	mÜig_´iv©e
;

1364 
bio_’d_io_t
 *
	mÜig_’d_io
;

1365 
boŞ
 
	mwr™e
;

1368 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


1369 
	#f2fs_show_šjeùiÚ_šfo
(
ty³
) \

1370 
	`´štk_¿‹lim™ed
("%sF2FS-fs : inject %s in %s of %pS\n", \

1371 
KERN_INFO
, 
f2fs_çuÉ_Çme
[
ty³
], \

1372 
__func__
, 
	`__butš_»tuº_add»ss
(0))

	)

1373 
šlše
 
boŞ
 
	$time_to_šjeù
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1375 
f2fs_çuÉ_šfo
 *
ffi
 = &
	`F2FS_OPTION
(
sbi
).
çuÉ_šfo
;

1377 ià(!
ffi
->
šjeù_¿‹
)

1378  
çl£
;

1380 ià(!
	`IS_FAULT_SET
(
ffi
, 
ty³
))

1381  
çl£
;

1383 
	`©omic_šc
(&
ffi
->
šjeù_İs
);

1384 ià(
	`©omic_»ad
(&
ffi
->
šjeù_İs
è>ğffi->
šjeù_¿‹
) {

1385 
	`©omic_£t
(&
ffi
->
šjeù_İs
, 0);

1386  
Œue
;

1388  
çl£
;

1389 
	}
}

1391 
	#f2fs_show_šjeùiÚ_šfo
(
ty³
èdØ{ } 0)

	)

1392 
šlše
 
boŞ
 
	$time_to_šjeù
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1394  
çl£
;

1395 
	}
}

1404 
šlše
 
boŞ
 
	$f2fs_is_muÉi_deviû
(
f2fs_sb_šfo
 *
sbi
)

1406  
sbi
->
s_ndevs
 > 1;

1407 
	}
}

1412 
	#BD_PART_WRITTEN
(
s
) \

1413 (((
u64
)
	`·¹_¡©_»ad
((
s
)->
sb
->
s_bdev
->
bd_·¹
, 
£ùÜs
[
STAT_WRITE
]) - \

1414 (
s
)->
£ùÜs_wr™‹n_¡¬t
è>> 1)

	)

1416 
šlše
 
	$f2fs_upd©e_time
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1418 
now
 = 
jiff›s
;

1420 
sbi
->
Ï¡_time
[
ty³
] = 
now
;

1423 ià(
ty³
 =ğ
REQ_TIME
) {

1424 
sbi
->
Ï¡_time
[
DISCARD_TIME
] = 
now
;

1425 
sbi
->
Ï¡_time
[
GC_TIME
] = 
now
;

1427 
	}
}

1429 
šlše
 
boŞ
 
	$f2fs_time_ov”
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1431 
š‹rv®
 = 
sbi
->
š‹rv®_time
[
ty³
] * 
HZ
;

1433  
	`time_aá”
(
jiff›s
, 
sbi
->
Ï¡_time
[
ty³
] + 
š‹rv®
);

1434 
	}
}

1436 
šlše
 
	$f2fs_time_to_wa™
(
f2fs_sb_šfo
 *
sbi
,

1437 
ty³
)

1439 
š‹rv®
 = 
sbi
->
š‹rv®_time
[
ty³
] * 
HZ
;

1440 
wa™_ms
 = 0;

1441 
d–
;

1443 
d–
 = (
sbi
->
Ï¡_time
[
ty³
] + 
š‹rv®
è- 
jiff›s
;

1444 ià(
d–
 > 0)

1445 
wa™_ms
 = 
	`jiff›s_to_m£cs
(
d–
);

1447  
wa™_ms
;

1448 
	}
}

1453 
šlše
 
u32
 
	$__f2fs_üc32
(
f2fs_sb_šfo
 *
sbi
, 
u32
 
üc
,

1454 cÚ¡ *
add»ss
, 
Ëngth
)

1457 
shash_desc
 
shash
;

1458 
ùx
[4];

1459 } 
desc
;

1460 
”r
;

1462 
	`BUG_ON
(
	`üy±o_shash_descsize
(
sbi
->
s_chksum_driv”
è!ğ(
desc
.
ùx
));

1464 
desc
.
shash
.
tfm
 = 
sbi
->
s_chksum_driv”
;

1465 *(
u32
 *)
desc
.
ùx
 = 
üc
;

1467 
”r
 = 
	`üy±o_shash_upd©e
(&
desc
.
shash
, 
add»ss
, 
Ëngth
);

1468 
	`BUG_ON
(
”r
);

1470  *(
u32
 *)
desc
.
ùx
;

1471 
	}
}

1473 
šlše
 
u32
 
	$f2fs_üc32
(
f2fs_sb_šfo
 *
sbi
, cÚ¡ *
add»ss
,

1474 
Ëngth
)

1476  
	`__f2fs_üc32
(
sbi
, 
F2FS_SUPER_MAGIC
, 
add»ss
, 
Ëngth
);

1477 
	}
}

1479 
šlše
 
boŞ
 
	$f2fs_üc_v®id
(
f2fs_sb_šfo
 *
sbi
, 
__u32
 
blk_üc
,

1480 *
buf
, 
size_t
 
buf_size
)

1482  
	`f2fs_üc32
(
sbi
, 
buf
, 
buf_size
è=ğ
blk_üc
;

1483 
	}
}

1485 
šlše
 
u32
 
	$f2fs_chksum
(
f2fs_sb_šfo
 *
sbi
, 
u32
 
üc
,

1486 cÚ¡ *
add»ss
, 
Ëngth
)

1488  
	`__f2fs_üc32
(
sbi
, 
üc
, 
add»ss
, 
Ëngth
);

1489 
	}
}

1491 
šlše
 
f2fs_šode_šfo
 *
	$F2FS_I
(
šode
 *inode)

1493  
	`cÚš”_of
(
šode
, 
f2fs_šode_šfo
, 
vfs_šode
);

1494 
	}
}

1496 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_SB
(
su³r_block
 *
sb
)

1498  
sb
->
s_fs_šfo
;

1499 
	}
}

1501 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_I_SB
(
šode
 *inode)

1503  
	`F2FS_SB
(
šode
->
i_sb
);

1504 
	}
}

1506 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_M_SB
(
add»ss_¥aû
 *
m­pšg
)

1508  
	`F2FS_I_SB
(
m­pšg
->
ho¡
);

1509 
	}
}

1511 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_P_SB
(
·ge
 *page)

1513  
	`F2FS_M_SB
(
	`·ge_fe_m­pšg
(
·ge
));

1514 
	}
}

1516 
šlše
 
f2fs_su³r_block
 *
	$F2FS_RAW_SUPER
(
f2fs_sb_šfo
 *
sbi
)

1518  (
f2fs_su³r_block
 *)(
sbi
->
¿w_su³r
);

1519 
	}
}

1521 
šlše
 
f2fs_checkpošt
 *
	$F2FS_CKPT
(
f2fs_sb_šfo
 *
sbi
)

1523  (
f2fs_checkpošt
 *)(
sbi
->
ck±
);

1524 
	}
}

1526 
šlše
 
f2fs_node
 *
	$F2FS_NODE
(
·ge
 *page)

1528  (
f2fs_node
 *)
	`·ge_add»ss
(
·ge
);

1529 
	}
}

1531 
šlše
 
f2fs_šode
 *
	$F2FS_INODE
(
·ge
 *page)

1533  &((
f2fs_node
 *)
	`·ge_add»ss
(
·ge
))->
i
;

1534 
	}
}

1536 
šlše
 
f2fs_nm_šfo
 *
	$NM_I
(
f2fs_sb_šfo
 *
sbi
)

1538  (
f2fs_nm_šfo
 *)(
sbi
->
nm_šfo
);

1539 
	}
}

1541 
šlše
 
f2fs_sm_šfo
 *
	$SM_I
(
f2fs_sb_šfo
 *
sbi
)

1543  (
f2fs_sm_šfo
 *)(
sbi
->
sm_šfo
);

1544 
	}
}

1546 
šlše
 
s™_šfo
 *
	$SIT_I
(
f2fs_sb_šfo
 *
sbi
)

1548  (
s™_šfo
 *)(
	`SM_I
(
sbi
)->sit_info);

1549 
	}
}

1551 
šlše
 
ä“_£gm­_šfo
 *
	$FREE_I
(
f2fs_sb_šfo
 *
sbi
)

1553  (
ä“_£gm­_šfo
 *)(
	`SM_I
(
sbi
)->
ä“_šfo
);

1554 
	}
}

1556 
šlše
 
dœty_£gli¡_šfo
 *
	$DIRTY_I
(
f2fs_sb_šfo
 *
sbi
)

1558  (
dœty_£gli¡_šfo
 *)(
	`SM_I
(
sbi
)->
dœty_šfo
);

1559 
	}
}

1561 
šlše
 
add»ss_¥aû
 *
	$META_MAPPING
(
f2fs_sb_šfo
 *
sbi
)

1563  
sbi
->
m‘a_šode
->
i_m­pšg
;

1564 
	}
}

1566 
šlše
 
add»ss_¥aû
 *
	$NODE_MAPPING
(
f2fs_sb_šfo
 *
sbi
)

1568  
sbi
->
node_šode
->
i_m­pšg
;

1569 
	}
}

1571 
šlše
 
boŞ
 
	$is_sbi_æag_£t
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1573  
	`‹¡_b™
(
ty³
, &
sbi
->
s_æag
);

1574 
	}
}

1576 
šlše
 
	$£t_sbi_æag
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1578 
	`£t_b™
(
ty³
, &
sbi
->
s_æag
);

1579 
	}
}

1581 
šlše
 
	$ş—r_sbi_æag
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1583 
	`ş—r_b™
(
ty³
, &
sbi
->
s_æag
);

1584 
	}
}

1586 
šlše
 
	$cur_ı_v”siÚ
(
f2fs_checkpošt
 *
ı
)

1588  
	`Ë64_to_ıu
(
ı
->
checkpošt_v”
);

1589 
	}
}

1591 
šlše
 
	$f2fs_qf_šo
(
su³r_block
 *
sb
, 
ty³
)

1593 ià(
ty³
 < 
F2FS_MAX_QUOTAS
)

1594  
	`Ë32_to_ıu
(
	`F2FS_SB
(
sb
)->
¿w_su³r
->
qf_šo
[
ty³
]);

1596 
	}
}

1598 
šlše
 
__u64
 
	$cur_ı_üc
(
f2fs_checkpošt
 *
ı
)

1600 
size_t
 
üc_off£t
 = 
	`Ë32_to_ıu
(
ı
->
checksum_off£t
);

1601  
	`Ë32_to_ıu
(*((
__Ë32
 *)((*)
ı
 + 
üc_off£t
)));

1602 
	}
}

1604 
šlše
 
boŞ
 
	$__is_£t_ck±_æags
(
f2fs_checkpošt
 *
ı
, 
f
)

1606 
ck±_æags
 = 
	`Ë32_to_ıu
(
ı
->ckpt_flags);

1608  
ck±_æags
 & 
f
;

1609 
	}
}

1611 
šlše
 
boŞ
 
	$is_£t_ck±_æags
(
f2fs_sb_šfo
 *
sbi
, 
f
)

1613  
	`__is_£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
f
);

1614 
	}
}

1616 
šlše
 
	$__£t_ck±_æags
(
f2fs_checkpošt
 *
ı
, 
f
)

1618 
ck±_æags
;

1620 
ck±_æags
 = 
	`Ë32_to_ıu
(
ı
->ckpt_flags);

1621 
ck±_æags
 |ğ
f
;

1622 
ı
->
ck±_æags
 = 
	`ıu_to_Ë32
(ckpt_flags);

1623 
	}
}

1625 
šlše
 
	$£t_ck±_æags
(
f2fs_sb_šfo
 *
sbi
, 
f
)

1627 
æags
;

1629 
	`¥š_lock_œq§ve
(&
sbi
->
ı_lock
, 
æags
);

1630 
	`__£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
f
);

1631 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
ı_lock
, 
æags
);

1632 
	}
}

1634 
šlše
 
	$__ş—r_ck±_æags
(
f2fs_checkpošt
 *
ı
, 
f
)

1636 
ck±_æags
;

1638 
ck±_æags
 = 
	`Ë32_to_ıu
(
ı
->ckpt_flags);

1639 
ck±_æags
 &ğ(~
f
);

1640 
ı
->
ck±_æags
 = 
	`ıu_to_Ë32
(ckpt_flags);

1641 
	}
}

1643 
šlše
 
	$ş—r_ck±_æags
(
f2fs_sb_šfo
 *
sbi
, 
f
)

1645 
æags
;

1647 
	`¥š_lock_œq§ve
(&
sbi
->
ı_lock
, 
æags
);

1648 
	`__ş—r_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
f
);

1649 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
ı_lock
, 
æags
);

1650 
	}
}

1652 
šlše
 
	$di§bË_Çt_b™s
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
lock
)

1654 
æags
;

1655 *
Çt_b™s
;

1663 ià(
lock
)

1664 
	`¥š_lock_œq§ve
(&
sbi
->
ı_lock
, 
æags
);

1665 
	`__ş—r_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
CP_NAT_BITS_FLAG
);

1666 
Çt_b™s
 = 
	`NM_I
(
sbi
)->nat_bits;

1667 
	`NM_I
(
sbi
)->
Çt_b™s
 = 
NULL
;

1668 ià(
lock
)

1669 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
ı_lock
, 
æags
);

1671 
	`kvä“
(
Çt_b™s
);

1672 
	}
}

1674 
šlše
 
boŞ
 
	$’abËd_Çt_b™s
(
f2fs_sb_šfo
 *
sbi
,

1675 
ı_cÚŒŞ
 *
ıc
)

1677 
boŞ
 
£t
 = 
	`is_£t_ck±_æags
(
sbi
, 
CP_NAT_BITS_FLAG
);

1679  (
ıc
è? (ıc->
»asÚ
 & 
CP_UMOUNT
è&& 
£t
 : set;

1680 
	}
}

1682 
šlše
 
	$f2fs_lock_İ
(
f2fs_sb_šfo
 *
sbi
)

1684 
	`down_»ad
(&
sbi
->
ı_rw£m
);

1685 
	}
}

1687 
šlše
 
	$f2fs_Œylock_İ
(
f2fs_sb_šfo
 *
sbi
)

1689  
	`down_»ad_Œylock
(&
sbi
->
ı_rw£m
);

1690 
	}
}

1692 
šlše
 
	$f2fs_uÆock_İ
(
f2fs_sb_šfo
 *
sbi
)

1694 
	`up_»ad
(&
sbi
->
ı_rw£m
);

1695 
	}
}

1697 
šlše
 
	$f2fs_lock_®l
(
f2fs_sb_šfo
 *
sbi
)

1699 
	`down_wr™e
(&
sbi
->
ı_rw£m
);

1700 
	}
}

1702 
šlše
 
	$f2fs_uÆock_®l
(
f2fs_sb_šfo
 *
sbi
)

1704 
	`up_wr™e
(&
sbi
->
ı_rw£m
);

1705 
	}
}

1707 
šlše
 
	$__g‘_ı_»asÚ
(
f2fs_sb_šfo
 *
sbi
)

1709 
»asÚ
 = 
CP_SYNC
;

1711 ià(
	`‹¡_İt
(
sbi
, 
FASTBOOT
))

1712 
»asÚ
 = 
CP_FASTBOOT
;

1713 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_CLOSE
))

1714 
»asÚ
 = 
CP_UMOUNT
;

1715  
»asÚ
;

1716 
	}
}

1718 
šlše
 
boŞ
 
	$__»maš_node_summ¬›s
(
»asÚ
)

1720  (
»asÚ
 & (
CP_UMOUNT
 | 
CP_FASTBOOT
));

1721 
	}
}

1723 
šlše
 
boŞ
 
	$__exi¡_node_summ¬›s
(
f2fs_sb_šfo
 *
sbi
)

1725  (
	`is_£t_ck±_æags
(
sbi
, 
CP_UMOUNT_FLAG
) ||

1726 
	`is_£t_ck±_æags
(
sbi
, 
CP_FASTBOOT_FLAG
));

1727 
	}
}

1732 
šlše
 
	$F2FS_HAS_BLOCKS
(
šode
 *inode)

1734 
block_t
 
x©Œ_block
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
 ? 1 : 0;

1736  (
šode
->
i_blocks
 >> 
F2FS_LOG_SECTORS_PER_BLOCK
è> 
x©Œ_block
;

1737 
	}
}

1739 
šlše
 
boŞ
 
	$f2fs_has_x©Œ_block
(
ofs
)

1741  
ofs
 =ğ
XATTR_NODE_OFFSET
;

1742 
	}
}

1744 
šlše
 
boŞ
 
	$__®low_»£rved_blocks
(
f2fs_sb_šfo
 *
sbi
,

1745 
šode
 *šode, 
boŞ
 
ÿp
)

1747 ià(!
šode
)

1748  
Œue
;

1749 ià(!
	`‹¡_İt
(
sbi
, 
RESERVE_ROOT
))

1750  
çl£
;

1751 ià(
	`IS_NOQUOTA
(
šode
))

1752  
Œue
;

1753 ià(
	`uid_eq
(
	`F2FS_OPTION
(
sbi
).
s_»suid
, 
	`cu¼’t_fsuid
()))

1754  
Œue
;

1755 ià(!
	`gid_eq
(
	`F2FS_OPTION
(
sbi
).
s_»sgid
, 
GLOBAL_ROOT_GID
) &&

1756 
	`š_group_p
(
	`F2FS_OPTION
(
sbi
).
s_»sgid
))

1757  
Œue
;

1758 ià(
ÿp
 && 
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

1759  
Œue
;

1760  
çl£
;

1761 
	}
}

1763 
šlše
 
f2fs_i_blocks_wr™e
(
šode
 *, 
block_t
, 
boŞ
, bool);

1764 
šlše
 
	$šc_v®id_block_couÁ
(
f2fs_sb_šfo
 *
sbi
,

1765 
šode
 *šode, 
blkút_t
 *
couÁ
)

1767 
blkút_t
 
diff
 = 0, 
»Ëa£
 = 0;

1768 
block_t
 
ava_u£r_block_couÁ
;

1769 
»t
;

1771 
»t
 = 
	`dquÙ_»£rve_block
(
šode
, *
couÁ
);

1772 ià(
»t
)

1773  
»t
;

1775 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_BLOCK
)) {

1776 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_BLOCK
);

1777 
»Ëa£
 = *
couÁ
;

1778 
»Ëa£_quÙa
;

1785 
	`³rıu_couÁ”_add
(&
sbi
->
®loc_v®id_block_couÁ
, (*
couÁ
));

1787 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1788 
sbi
->
tÙ®_v®id_block_couÁ
 +ğ(
block_t
)(*
couÁ
);

1789 
ava_u£r_block_couÁ
 = 
sbi
->
u£r_block_couÁ
 -

1790 
sbi
->
cu¼’t_»£rved_blocks
;

1792 ià(!
	`__®low_»£rved_blocks
(
sbi
, 
šode
, 
Œue
))

1793 
ava_u£r_block_couÁ
 -ğ
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
;

1794 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
))) {

1795 ià(
ava_u£r_block_couÁ
 > 
sbi
->
unu§bË_block_couÁ
)

1796 
ava_u£r_block_couÁ
 -ğ
sbi
->
unu§bË_block_couÁ
;

1798 
ava_u£r_block_couÁ
 = 0;

1800 ià(
	`uÆik–y
(
sbi
->
tÙ®_v®id_block_couÁ
 > 
ava_u£r_block_couÁ
)) {

1801 
diff
 = 
sbi
->
tÙ®_v®id_block_couÁ
 - 
ava_u£r_block_couÁ
;

1802 ià(
diff
 > *
couÁ
)

1803 
diff
 = *
couÁ
;

1804 *
couÁ
 -ğ
diff
;

1805 
»Ëa£
 = 
diff
;

1806 
sbi
->
tÙ®_v®id_block_couÁ
 -ğ
diff
;

1807 ià(!*
couÁ
) {

1808 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1809 
’o¥c
;

1812 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1814 ià(
	`uÆik–y
(
»Ëa£
)) {

1815 
	`³rıu_couÁ”_sub
(&
sbi
->
®loc_v®id_block_couÁ
, 
»Ëa£
);

1816 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 
»Ëa£
);

1818 
	`f2fs_i_blocks_wr™e
(
šode
, *
couÁ
, 
Œue
,rue);

1821 
’o¥c
:

1822 
	`³rıu_couÁ”_sub
(&
sbi
->
®loc_v®id_block_couÁ
, 
»Ëa£
);

1823 
»Ëa£_quÙa
:

1824 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 
»Ëa£
);

1825  -
ENOSPC
;

1826 
	}
}

1828 
	$__´štf
(2, 3)

1829 
	`f2fs_´štk
(
f2fs_sb_šfo
 *
sbi
, cÚ¡ *
fmt
, ...);

1831 
	#f2fs_”r
(
sbi
, 
fmt
, ...) \

1832 
	`f2fs_´štk
(
sbi
, 
KERN_ERR
 
fmt
, ##
__VA_ARGS__
)

	)

1833 
	#f2fs_w¬n
(
sbi
, 
fmt
, ...) \

1834 
	`f2fs_´štk
(
sbi
, 
KERN_WARNING
 
fmt
, ##
__VA_ARGS__
)

	)

1835 
	#f2fs_nÙiû
(
sbi
, 
fmt
, ...) \

1836 
	`f2fs_´štk
(
sbi
, 
KERN_NOTICE
 
fmt
, ##
__VA_ARGS__
)

	)

1837 
	#f2fs_šfo
(
sbi
, 
fmt
, ...) \

1838 
	`f2fs_´štk
(
sbi
, 
KERN_INFO
 
fmt
, ##
__VA_ARGS__
)

	)

1839 
	#f2fs_debug
(
sbi
, 
fmt
, ...) \

1840 
	`f2fs_´štk
(
sbi
, 
KERN_DEBUG
 
fmt
, ##
__VA_ARGS__
)

	)

1842 
šlše
 
	$dec_v®id_block_couÁ
(
f2fs_sb_šfo
 *
sbi
,

1843 
šode
 *inode,

1844 
block_t
 
couÁ
)

1846 
blkút_t
 
£ùÜs
 = 
couÁ
 << 
F2FS_LOG_SECTORS_PER_BLOCK
;

1848 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1849 
	`f2fs_bug_Ú
(
sbi
, sbi->
tÙ®_v®id_block_couÁ
 < (
block_t
è
couÁ
);

1850 
sbi
->
tÙ®_v®id_block_couÁ
 -ğ(
block_t
)
couÁ
;

1851 ià(
sbi
->
»£rved_blocks
 &&

1852 
sbi
->
cu¼’t_»£rved_blocks
 < sbi->
»£rved_blocks
)

1853 
sbi
->
cu¼’t_»£rved_blocks
 = 
	`mš
(sbi->
»£rved_blocks
,

1854 
sbi
->
cu¼’t_»£rved_blocks
 + 
couÁ
);

1855 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1856 ià(
	`uÆik–y
(
šode
->
i_blocks
 < 
£ùÜs
)) {

1857 
	`f2fs_w¬n
(
sbi
, "Inconsistent i_blocks, ino:%lu, iblocks:%llu, sectors:%llu",

1858 
šode
->
i_šo
,

1859 ()
šode
->
i_blocks
,

1860 ()
£ùÜs
);

1861 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

1864 
	`f2fs_i_blocks_wr™e
(
šode
, 
couÁ
, 
çl£
, 
Œue
);

1865 
	}
}

1867 
šlše
 
	$šc_·ge_couÁ
(
f2fs_sb_šfo
 *
sbi
, 
couÁ_ty³
)

1869 
	`©omic_šc
(&
sbi
->
Ä_·ges
[
couÁ_ty³
]);

1871 ià(
couÁ_ty³
 =ğ
F2FS_DIRTY_DENTS
 ||

1872 
couÁ_ty³
 =ğ
F2FS_DIRTY_NODES
 ||

1873 
couÁ_ty³
 =ğ
F2FS_DIRTY_META
 ||

1874 
couÁ_ty³
 =ğ
F2FS_DIRTY_QDATA
 ||

1875 
couÁ_ty³
 =ğ
F2FS_DIRTY_IMETA
)

1876 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

1877 
	}
}

1879 
šlše
 
	$šode_šc_dœty_·ges
(
šode
 *inode)

1881 
	`©omic_šc
(&
	`F2FS_I
(
šode
)->
dœty_·ges
);

1882 
	`šc_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
	`S_ISDIR
(šode->
i_mode
) ?

1883 
F2FS_DIRTY_DENTS
 : 
F2FS_DIRTY_DATA
);

1884 ià(
	`IS_NOQUOTA
(
šode
))

1885 
	`šc_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_DIRTY_QDATA
);

1886 
	}
}

1888 
šlše
 
	$dec_·ge_couÁ
(
f2fs_sb_šfo
 *
sbi
, 
couÁ_ty³
)

1890 
	`©omic_dec
(&
sbi
->
Ä_·ges
[
couÁ_ty³
]);

1891 
	}
}

1893 
šlše
 
	$šode_dec_dœty_·ges
(
šode
 *inode)

1895 ià(!
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`S_ISREG
(inode->i_mode) &&

1896 !
	`S_ISLNK
(
šode
->
i_mode
))

1899 
	`©omic_dec
(&
	`F2FS_I
(
šode
)->
dœty_·ges
);

1900 
	`dec_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
	`S_ISDIR
(šode->
i_mode
) ?

1901 
F2FS_DIRTY_DENTS
 : 
F2FS_DIRTY_DATA
);

1902 ià(
	`IS_NOQUOTA
(
šode
))

1903 
	`dec_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_DIRTY_QDATA
);

1904 
	}
}

1906 
šlše
 
s64
 
	$g‘_·ges
(
f2fs_sb_šfo
 *
sbi
, 
couÁ_ty³
)

1908  
	`©omic_»ad
(&
sbi
->
Ä_·ges
[
couÁ_ty³
]);

1909 
	}
}

1911 
šlše
 
	$g‘_dœty_·ges
(
šode
 *inode)

1913  
	`©omic_»ad
(&
	`F2FS_I
(
šode
)->
dœty_·ges
);

1914 
	}
}

1916 
šlše
 
	$g‘_blockty³_£cs
(
f2fs_sb_šfo
 *
sbi
, 
block_ty³
)

1918 
·ges_³r_£c
 = 
sbi
->
£gs_³r_£c
 * sbi->
blocks_³r_£g
;

1919 
£gs
 = (
	`g‘_·ges
(
sbi
, 
block_ty³
è+ 
·ges_³r_£c
 - 1) >>

1920 
sbi
->
log_blocks_³r_£g
;

1922  
£gs
 / 
sbi
->
£gs_³r_£c
;

1923 
	}
}

1925 
šlše
 
block_t
 
	$v®id_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

1927  
sbi
->
tÙ®_v®id_block_couÁ
;

1928 
	}
}

1930 
šlše
 
block_t
 
	$disÿrd_blocks
(
f2fs_sb_šfo
 *
sbi
)

1932  
sbi
->
disÿrd_blks
;

1933 
	}
}

1935 
šlše
 
	$__b™m­_size
(
f2fs_sb_šfo
 *
sbi
, 
æag
)

1937 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1940 ià(
æag
 =ğ
NAT_BITMAP
)

1941  
	`Ë32_to_ıu
(
ck±
->
Çt_v”_b™m­_by‹size
);

1942 ià(
æag
 =ğ
SIT_BITMAP
)

1943  
	`Ë32_to_ıu
(
ck±
->
s™_v”_b™m­_by‹size
);

1946 
	}
}

1948 
šlše
 
block_t
 
	$__ı_·ylßd
(
f2fs_sb_šfo
 *
sbi
)

1950  
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_·ylßd
);

1951 
	}
}

1953 
šlše
 *
	$__b™m­_±r
(
f2fs_sb_šfo
 *
sbi
, 
æag
)

1955 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1956 
off£t
;

1958 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_LARGE_NAT_BITMAP_FLAG
)) {

1959 
off£t
 = (
æag
 =ğ
SIT_BITMAP
) ?

1960 
	`Ë32_to_ıu
(
ck±
->
Çt_v”_b™m­_by‹size
) : 0;

1965  &
ck±
->
s™_Çt_v”siÚ_b™m­
 + 
off£t
 + (
__Ë32
);

1968 ià(
	`__ı_·ylßd
(
sbi
) > 0) {

1969 ià(
æag
 =ğ
NAT_BITMAP
)

1970  &
ck±
->
s™_Çt_v”siÚ_b™m­
;

1972  (*)
ck±
 + 
F2FS_BLKSIZE
;

1974 
off£t
 = (
æag
 =ğ
NAT_BITMAP
) ?

1975 
	`Ë32_to_ıu
(
ck±
->
s™_v”_b™m­_by‹size
) : 0;

1976  &
ck±
->
s™_Çt_v”siÚ_b™m­
 + 
off£t
;

1978 
	}
}

1980 
šlše
 
block_t
 
	$__¡¬t_ı_addr
(
f2fs_sb_šfo
 *
sbi
)

1982 
block_t
 
¡¬t_addr
 = 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_blkaddr
);

1984 ià(
sbi
->
cur_ı_·ck
 == 2)

1985 
¡¬t_addr
 +ğ
sbi
->
blocks_³r_£g
;

1986  
¡¬t_addr
;

1987 
	}
}

1989 
šlše
 
block_t
 
	$__¡¬t_ı_Ãxt_addr
(
f2fs_sb_šfo
 *
sbi
)

1991 
block_t
 
¡¬t_addr
 = 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_blkaddr
);

1993 ià(
sbi
->
cur_ı_·ck
 == 1)

1994 
¡¬t_addr
 +ğ
sbi
->
blocks_³r_£g
;

1995  
¡¬t_addr
;

1996 
	}
}

1998 
šlše
 
	$__£t_ı_Ãxt_·ck
(
f2fs_sb_šfo
 *
sbi
)

2000 
sbi
->
cur_ı_·ck
 = (sbi->cur_cp_pack == 1) ? 2 : 1;

2001 
	}
}

2003 
šlše
 
block_t
 
	$__¡¬t_sum_addr
(
f2fs_sb_šfo
 *
sbi
)

2005  
	`Ë32_to_ıu
(
	`F2FS_CKPT
(
sbi
)->
ı_·ck_¡¬t_sum
);

2006 
	}
}

2008 
šlše
 
	$šc_v®id_node_couÁ
(
f2fs_sb_šfo
 *
sbi
,

2009 
šode
 *šode, 
boŞ
 
is_šode
)

2011 
block_t
 
v®id_block_couÁ
;

2012 
v®id_node_couÁ
, 
u£r_block_couÁ
;

2013 
”r
;

2015 ià(
is_šode
) {

2016 ià(
šode
) {

2017 
”r
 = 
	`dquÙ_®loc_šode
(
šode
);

2018 ià(
”r
)

2019  
”r
;

2022 
”r
 = 
	`dquÙ_»£rve_block
(
šode
, 1);

2023 ià(
”r
)

2024  
”r
;

2027 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_BLOCK
)) {

2028 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_BLOCK
);

2029 
’o¥c
;

2032 
	`¥š_lock
(&
sbi
->
¡©_lock
);

2034 
v®id_block_couÁ
 = 
sbi
->
tÙ®_v®id_block_couÁ
 +

2035 
sbi
->
cu¼’t_»£rved_blocks
 + 1;

2037 ià(!
	`__®low_»£rved_blocks
(
sbi
, 
šode
, 
çl£
))

2038 
v®id_block_couÁ
 +ğ
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
;

2039 
u£r_block_couÁ
 = 
sbi
->user_block_count;

2040 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)))

2041 
u£r_block_couÁ
 -ğ
sbi
->
unu§bË_block_couÁ
;

2043 ià(
	`uÆik–y
(
v®id_block_couÁ
 > 
u£r_block_couÁ
)) {

2044 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

2045 
’o¥c
;

2048 
v®id_node_couÁ
 = 
sbi
->
tÙ®_v®id_node_couÁ
 + 1;

2049 ià(
	`uÆik–y
(
v®id_node_couÁ
 > 
sbi
->
tÙ®_node_couÁ
)) {

2050 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

2051 
’o¥c
;

2054 
sbi
->
tÙ®_v®id_node_couÁ
++;

2055 
sbi
->
tÙ®_v®id_block_couÁ
++;

2056 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

2058 ià(
šode
) {

2059 ià(
is_šode
)

2060 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2062 
	`f2fs_i_blocks_wr™e
(
šode
, 1, 
Œue
,rue);

2065 
	`³rıu_couÁ”_šc
(&
sbi
->
®loc_v®id_block_couÁ
);

2068 
’o¥c
:

2069 ià(
is_šode
) {

2070 ià(
šode
)

2071 
	`dquÙ_ä“_šode
(
šode
);

2073 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 1);

2075  -
ENOSPC
;

2076 
	}
}

2078 
šlše
 
	$dec_v®id_node_couÁ
(
f2fs_sb_šfo
 *
sbi
,

2079 
šode
 *šode, 
boŞ
 
is_šode
)

2081 
	`¥š_lock
(&
sbi
->
¡©_lock
);

2083 
	`f2fs_bug_Ú
(
sbi
, !sbi->
tÙ®_v®id_block_couÁ
);

2084 
	`f2fs_bug_Ú
(
sbi
, !sbi->
tÙ®_v®id_node_couÁ
);

2086 
sbi
->
tÙ®_v®id_node_couÁ
--;

2087 
sbi
->
tÙ®_v®id_block_couÁ
--;

2088 ià(
sbi
->
»£rved_blocks
 &&

2089 
sbi
->
cu¼’t_»£rved_blocks
 < sbi->
»£rved_blocks
)

2090 
sbi
->
cu¼’t_»£rved_blocks
++;

2092 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

2094 ià(
is_šode
) {

2095 
	`dquÙ_ä“_šode
(
šode
);

2097 ià(
	`uÆik–y
(
šode
->
i_blocks
 == 0)) {

2098 
	`f2fs_w¬n
(
sbi
, "Inconsistent i_blocks, ino:%lu, iblocks:%llu",

2099 
šode
->
i_šo
,

2100 ()
šode
->
i_blocks
);

2101 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

2104 
	`f2fs_i_blocks_wr™e
(
šode
, 1, 
çl£
, 
Œue
);

2106 
	}
}

2108 
šlše
 
	$v®id_node_couÁ
(
f2fs_sb_šfo
 *
sbi
)

2110  
sbi
->
tÙ®_v®id_node_couÁ
;

2111 
	}
}

2113 
šlše
 
	$šc_v®id_šode_couÁ
(
f2fs_sb_šfo
 *
sbi
)

2115 
	`³rıu_couÁ”_šc
(&
sbi
->
tÙ®_v®id_šode_couÁ
);

2116 
	}
}

2118 
šlše
 
	$dec_v®id_šode_couÁ
(
f2fs_sb_šfo
 *
sbi
)

2120 
	`³rıu_couÁ”_dec
(&
sbi
->
tÙ®_v®id_šode_couÁ
);

2121 
	}
}

2123 
šlše
 
s64
 
	$v®id_šode_couÁ
(
f2fs_sb_šfo
 *
sbi
)

2125  
	`³rıu_couÁ”_sum_pos™ive
(&
sbi
->
tÙ®_v®id_šode_couÁ
);

2126 
	}
}

2128 
šlše
 
·ge
 *
	$f2fs_g¿b_ÿche_·ge
(
add»ss_¥aû
 *
m­pšg
,

2129 
pgoff_t
 
šdex
, 
boŞ
 
fÜ_wr™e
)

2131 
·ge
 *page;

2133 ià(
	`IS_ENABLED
(
CONFIG_F2FS_FAULT_INJECTION
)) {

2134 ià(!
fÜ_wr™e
)

2135 
·ge
 = 
	`fšd_g‘_·ge_æags
(
m­pšg
, 
šdex
,

2136 
FGP_LOCK
 | 
FGP_ACCESSED
);

2138 
·ge
 = 
	`fšd_lock_·ge
(
m­pšg
, 
šdex
);

2139 ià(
·ge
)

2140  
·ge
;

2142 ià(
	`time_to_šjeù
(
	`F2FS_M_SB
(
m­pšg
), 
FAULT_PAGE_ALLOC
)) {

2143 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_PAGE_ALLOC
);

2144  
NULL
;

2148 ià(!
fÜ_wr™e
)

2149  
	`g¿b_ÿche_·ge
(
m­pšg
, 
šdex
);

2150  
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 
šdex
, 
AOP_FLAG_NOFS
);

2151 
	}
}

2153 
šlše
 
·ge
 *
	$f2fs_·geÿche_g‘_·ge
(

2154 
add»ss_¥aû
 *
m­pšg
, 
pgoff_t
 
šdex
,

2155 
fgp_æags
, 
gå_t
 
gå_mask
)

2157 ià(
	`time_to_šjeù
(
	`F2FS_M_SB
(
m­pšg
), 
FAULT_PAGE_GET
)) {

2158 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_PAGE_GET
);

2159  
NULL
;

2162  
	`·geÿche_g‘_·ge
(
m­pšg
, 
šdex
, 
fgp_æags
, 
gå_mask
);

2163 
	}
}

2165 
šlše
 
	$f2fs_cİy_·ge
(
·ge
 *
¤c
, ·g*
d¡
)

2167 *
¤c_kaddr
 = 
	`km­
(
¤c
);

2168 *
d¡_kaddr
 = 
	`km­
(
d¡
);

2170 
	`memıy
(
d¡_kaddr
, 
¤c_kaddr
, 
PAGE_SIZE
);

2171 
	`kunm­
(
d¡
);

2172 
	`kunm­
(
¤c
);

2173 
	}
}

2175 
šlše
 
	$f2fs_put_·ge
(
·ge
 *·ge, 
uÆock
)

2177 ià(!
·ge
)

2180 ià(
uÆock
) {

2181 
	`f2fs_bug_Ú
(
	`F2FS_P_SB
(
·ge
), !
	`PageLocked
(page));

2182 
	`uÆock_·ge
(
·ge
);

2184 
	`put_·ge
(
·ge
);

2185 
	}
}

2187 
šlše
 
	$f2fs_put_dnode
(
dnode_of_d©a
 *
dn
)

2189 ià(
dn
->
node_·ge
)

2190 
	`f2fs_put_·ge
(
dn
->
node_·ge
, 1);

2191 ià(
dn
->
šode_·ge
 && dn->
node_·ge
 != dn->inode_page)

2192 
	`f2fs_put_·ge
(
dn
->
šode_·ge
, 0);

2193 
dn
->
node_·ge
 = 
NULL
;

2194 
dn
->
šode_·ge
 = 
NULL
;

2195 
	}
}

2197 
šlše
 
kmem_ÿche
 *
	$f2fs_kmem_ÿche_ü—‹
(cÚ¡ *
Çme
,

2198 
size_t
 
size
)

2200  
	`kmem_ÿche_ü—‹
(
Çme
, 
size
, 0, 
SLAB_RECLAIM_ACCOUNT
, 
NULL
);

2201 
	}
}

2203 
šlše
 *
	$f2fs_kmem_ÿche_®loc
(
kmem_ÿche
 *
ÿch•
,

2204 
gå_t
 
æags
)

2206 *
’Œy
;

2208 
’Œy
 = 
	`kmem_ÿche_®loc
(
ÿch•
, 
æags
);

2209 ià(!
’Œy
)

2210 
’Œy
 = 
	`kmem_ÿche_®loc
(
ÿch•
, 
æags
 | 
__GFP_NOFAIL
);

2211  
’Œy
;

2212 
	}
}

2214 
šlše
 
bio
 *
	$f2fs_bio_®loc
(
f2fs_sb_šfo
 *
sbi
,

2215 
Åages
, 
boŞ
 
no_ç
)

2217 
bio
 *bio;

2219 ià(
no_ç
) {

2221 
bio
 = 
	`bio_®loc
(
GFP_NOIO
, 
Åages
);

2222 ià(!
bio
)

2223 
bio
 = 
	`bio_®loc
(
GFP_NOIO
 | 
__GFP_NOFAIL
, 
Åages
);

2224  
bio
;

2226 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_ALLOC_BIO
)) {

2227 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_ALLOC_BIO
);

2228  
NULL
;

2231  
	`bio_®loc
(
GFP_KERNEL
, 
Åages
);

2232 
	}
}

2234 
šlše
 
boŞ
 
	$is_idË
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2236 ià(
sbi
->
gc_mode
 =ğ
GC_URGENT
)

2237  
Œue
;

2239 ià(
	`g‘_·ges
(
sbi
, 
F2FS_RD_DATA
è|| g‘_·ges(sbi, 
F2FS_RD_NODE
) ||

2240 
	`g‘_·ges
(
sbi
, 
F2FS_RD_META
è|| g‘_·ges(sbi, 
F2FS_WB_DATA
) ||

2241 
	`g‘_·ges
(
sbi
, 
F2FS_WB_CP_DATA
) ||

2242 
	`g‘_·ges
(
sbi
, 
F2FS_DIO_READ
) ||

2243 
	`g‘_·ges
(
sbi
, 
F2FS_DIO_WRITE
))

2244  
çl£
;

2246 ià(
ty³
 !ğ
DISCARD_TIME
 && 
	`SM_I
(
sbi
è&& SM_I(sbi)->
dcc_šfo
 &&

2247 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
queued_disÿrd
))

2248  
çl£
;

2250 ià(
	`SM_I
(
sbi
è&& SM_I(sbi)->
fcc_šfo
 &&

2251 
	`©omic_»ad
(&
	`SM_I
(
sbi
)->
fcc_šfo
->
queued_æush
))

2252  
çl£
;

2254  
	`f2fs_time_ov”
(
sbi
, 
ty³
);

2255 
	}
}

2257 
šlše
 
	$f2fs_¿dix_Œ“_š£¹
(
¿dix_Œ“_roÙ
 *
roÙ
,

2258 
šdex
, *
™em
)

2260 
	`¿dix_Œ“_š£¹
(
roÙ
, 
šdex
, 
™em
))

2261 
	`cÚd_»sched
();

2262 
	}
}

2264 
	#RAW_IS_INODE
(
p
è(Õ)->
foÙ”
.
nid
 =ğÕ)->foÙ”.
šo
)

	)

2266 
šlše
 
boŞ
 
	$IS_INODE
(
·ge
 *page)

2268 
f2fs_node
 *
p
 = 
	`F2FS_NODE
(
·ge
);

2270  
	`RAW_IS_INODE
(
p
);

2271 
	}
}

2273 
šlše
 
	$off£t_š_addr
(
f2fs_šode
 *
i
)

2275  (
i
->
i_šlše
 & 
F2FS_EXTRA_ATTR
) ?

2276 (
	`Ë16_to_ıu
(
i
->
i_exŒa_isize
è/ (
__Ë32
)) : 0;

2277 
	}
}

2279 
šlše
 
__Ë32
 *
	$blkaddr_š_node
(
f2fs_node
 *
node
)

2281  
	`RAW_IS_INODE
(
node
è?‚ode->
i
.
i_addr
 :‚ode->
dn
.
addr
;

2282 
	}
}

2284 
šlše
 
f2fs_has_exŒa_©Œ
(
šode
 *inode);

2285 
šlše
 
block_t
 
	$d©ablock_addr
(
šode
 *inode,

2286 
·ge
 *
node_·ge
, 
off£t
)

2288 
f2fs_node
 *
¿w_node
;

2289 
__Ë32
 *
addr_¬¿y
;

2290 
ba£
 = 0;

2291 
boŞ
 
is_šode
 = 
	`IS_INODE
(
node_·ge
);

2293 
¿w_node
 = 
	`F2FS_NODE
(
node_·ge
);

2296 ià(
is_šode
) {

2297 ià(!
šode
)

2298 
ba£
 = 
	`off£t_š_addr
(&
¿w_node
->
i
);

2299 ià(
	`f2fs_has_exŒa_©Œ
(
šode
))

2300 
ba£
 = 
	`g‘_exŒa_isize
(
šode
);

2303 
addr_¬¿y
 = 
	`blkaddr_š_node
(
¿w_node
);

2304  
	`Ë32_to_ıu
(
addr_¬¿y
[
ba£
 + 
off£t
]);

2305 
	}
}

2307 
šlše
 
	$f2fs_‹¡_b™
(
Ä
, *
addr
)

2309 
mask
;

2311 
addr
 +ğ(
Ä
 >> 3);

2312 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2313  
mask
 & *
addr
;

2314 
	}
}

2316 
šlše
 
	$f2fs_£t_b™
(
Ä
, *
addr
)

2318 
mask
;

2320 
addr
 +ğ(
Ä
 >> 3);

2321 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2322 *
addr
 |ğ
mask
;

2323 
	}
}

2325 
šlše
 
	$f2fs_ş—r_b™
(
Ä
, *
addr
)

2327 
mask
;

2329 
addr
 +ğ(
Ä
 >> 3);

2330 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2331 *
addr
 &ğ~
mask
;

2332 
	}
}

2334 
šlše
 
	$f2fs_‹¡_ªd_£t_b™
(
Ä
, *
addr
)

2336 
mask
;

2337 
»t
;

2339 
addr
 +ğ(
Ä
 >> 3);

2340 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2341 
»t
 = 
mask
 & *
addr
;

2342 *
addr
 |ğ
mask
;

2343  
»t
;

2344 
	}
}

2346 
šlše
 
	$f2fs_‹¡_ªd_ş—r_b™
(
Ä
, *
addr
)

2348 
mask
;

2349 
»t
;

2351 
addr
 +ğ(
Ä
 >> 3);

2352 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2353 
»t
 = 
mask
 & *
addr
;

2354 *
addr
 &ğ~
mask
;

2355  
»t
;

2356 
	}
}

2358 
šlše
 
	$f2fs_chªge_b™
(
Ä
, *
addr
)

2360 
mask
;

2362 
addr
 +ğ(
Ä
 >> 3);

2363 
mask
 = 1 << (7 - (
Ä
 & 0x07));

2364 *
addr
 ^ğ
mask
;

2365 
	}
}

2370 
	#F2FS_SYNC_FL
 0x00000008

	)

2371 
	#F2FS_IMMUTABLE_FL
 0x00000010

	)

2372 
	#F2FS_APPEND_FL
 0x00000020

	)

2373 
	#F2FS_NODUMP_FL
 0x00000040

	)

2374 
	#F2FS_NOATIME_FL
 0x00000080

	)

2375 
	#F2FS_INDEX_FL
 0x00001000

	)

2376 
	#F2FS_DIRSYNC_FL
 0x00010000

	)

2377 
	#F2FS_PROJINHERIT_FL
 0x20000000

	)

2378 
	#F2FS_CASEFOLD_FL
 0x40000000

	)

2381 
	#F2FS_FL_INHERITED
 (
F2FS_SYNC_FL
 | 
F2FS_NODUMP_FL
 | 
F2FS_NOATIME_FL
 | \

2382 
F2FS_DIRSYNC_FL
 | 
F2FS_PROJINHERIT_FL
 | \

2383 
F2FS_CASEFOLD_FL
)

	)

2386 
	#F2FS_REG_FLMASK
 (~(
F2FS_DIRSYNC_FL
 | 
F2FS_PROJINHERIT_FL
 | \

2387 
F2FS_CASEFOLD_FL
))

	)

2390 
	#F2FS_OTHER_FLMASK
 (
F2FS_NODUMP_FL
 | 
F2FS_NOATIME_FL
)

	)

2392 
šlše
 
__u32
 
	$f2fs_mask_æags
(
umode_t
 
mode
, 
__u32
 
æags
)

2394 ià(
	`S_ISDIR
(
mode
))

2395  
æags
;

2396 ià(
	`S_ISREG
(
mode
))

2397  
æags
 & 
F2FS_REG_FLMASK
;

2399  
æags
 & 
F2FS_OTHER_FLMASK
;

2400 
	}
}

2404 
	mFI_NEW_INODE
,

2405 
	mFI_DIRTY_INODE
,

2406 
	mFI_AUTO_RECOVER
,

2407 
	mFI_DIRTY_DIR
,

2408 
	mFI_INC_LINK
,

2409 
	mFI_ACL_MODE
,

2410 
	mFI_NO_ALLOC
,

2411 
	mFI_FREE_NID
,

2412 
	mFI_NO_EXTENT
,

2413 
	mFI_INLINE_XATTR
,

2414 
	mFI_INLINE_DATA
,

2415 
	mFI_INLINE_DENTRY
,

2416 
	mFI_APPEND_WRITE
,

2417 
	mFI_UPDATE_WRITE
,

2418 
	mFI_NEED_IPU
,

2419 
	mFI_ATOMIC_FILE
,

2420 
	mFI_ATOMIC_COMMIT
,

2421 
	mFI_VOLATILE_FILE
,

2422 
	mFI_FIRST_BLOCK_WRITTEN
,

2423 
	mFI_DROP_CACHE
,

2424 
	mFI_DATA_EXIST
,

2425 
	mFI_INLINE_DOTS
,

2426 
	mFI_DO_DEFRAG
,

2427 
	mFI_DIRTY_FILE
,

2428 
	mFI_NO_PREALLOC
,

2429 
	mFI_HOT_DATA
,

2430 
	mFI_EXTRA_ATTR
,

2431 
	mFI_PROJ_INHERIT
,

2432 
	mFI_PIN_FILE
,

2433 
	mFI_ATOMIC_REVOKE_REQUEST
,

2434 
	mFI_VERITY_IN_PROGRESS
,

2437 
šlše
 
	$__m¬k_šode_dœty_æag
(
šode
 *inode,

2438 
æag
, 
boŞ
 
£t
)

2440 
æag
) {

2441 
FI_INLINE_XATTR
:

2442 
FI_INLINE_DATA
:

2443 
FI_INLINE_DENTRY
:

2444 
FI_NEW_INODE
:

2445 ià(
£t
)

2448 
FI_DATA_EXIST
:

2449 
FI_INLINE_DOTS
:

2450 
FI_PIN_FILE
:

2451 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2453 
	}
}

2455 
šlše
 
	$£t_šode_æag
(
šode
 *šode, 
æag
)

2457 ià(!
	`‹¡_b™
(
æag
, &
	`F2FS_I
(
šode
)->
æags
))

2458 
	`£t_b™
(
æag
, &
	`F2FS_I
(
šode
)->
æags
);

2459 
	`__m¬k_šode_dœty_æag
(
šode
, 
æag
, 
Œue
);

2460 
	}
}

2462 
šlše
 
	$is_šode_æag_£t
(
šode
 *šode, 
æag
)

2464  
	`‹¡_b™
(
æag
, &
	`F2FS_I
(
šode
)->
æags
);

2465 
	}
}

2467 
šlše
 
	$ş—r_šode_æag
(
šode
 *šode, 
æag
)

2469 ià(
	`‹¡_b™
(
æag
, &
	`F2FS_I
(
šode
)->
æags
))

2470 
	`ş—r_b™
(
æag
, &
	`F2FS_I
(
šode
)->
æags
);

2471 
	`__m¬k_šode_dœty_æag
(
šode
, 
æag
, 
çl£
);

2472 
	}
}

2474 
šlše
 
boŞ
 
	$f2fs_v”™y_š_´og»ss
(
šode
 *inode)

2476  
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

2477 
	`is_šode_æag_£t
(
šode
, 
FI_VERITY_IN_PROGRESS
);

2478 
	}
}

2480 
šlše
 
	$£t_aş_šode
(
šode
 *šode, 
umode_t
 
mode
)

2482 
	`F2FS_I
(
šode
)->
i_aş_mode
 = 
mode
;

2483 
	`£t_šode_æag
(
šode
, 
FI_ACL_MODE
);

2484 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

2485 
	}
}

2487 
šlše
 
	$f2fs_i_lšks_wr™e
(
šode
 *šode, 
boŞ
 
šc
)

2489 ià(
šc
)

2490 
	`šc_Æšk
(
šode
);

2492 
	`drİ_Æšk
(
šode
);

2493 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2494 
	}
}

2496 
šlše
 
	$f2fs_i_blocks_wr™e
(
šode
 *inode,

2497 
block_t
 
diff
, 
boŞ
 
add
, boŞ 
şaim
)

2499 
boŞ
 
ş—n
 = !
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
);

2500 
boŞ
 
»cov”
 = 
	`is_šode_æag_£t
(
šode
, 
FI_AUTO_RECOVER
);

2503 ià(
add
) {

2504 ià(
şaim
)

2505 
	`dquÙ_şaim_block
(
šode
, 
diff
);

2507 
	`dquÙ_®loc_block_noç
(
šode
, 
diff
);

2509 
	`dquÙ_ä“_block
(
šode
, 
diff
);

2512 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2513 ià(
ş—n
 || 
»cov”
)

2514 
	`£t_šode_æag
(
šode
, 
FI_AUTO_RECOVER
);

2515 
	}
}

2517 
šlše
 
	$f2fs_i_size_wr™e
(
šode
 *šode, 
loff_t
 
i_size
)

2519 
boŞ
 
ş—n
 = !
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
);

2520 
boŞ
 
»cov”
 = 
	`is_šode_æag_£t
(
šode
, 
FI_AUTO_RECOVER
);

2522 ià(
	`i_size_»ad
(
šode
è=ğ
i_size
)

2525 
	`i_size_wr™e
(
šode
, 
i_size
);

2526 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2527 ià(
ş—n
 || 
»cov”
)

2528 
	`£t_šode_æag
(
šode
, 
FI_AUTO_RECOVER
);

2529 
	}
}

2531 
šlše
 
	$f2fs_i_d•th_wr™e
(
šode
 *šode, 
d•th
)

2533 
	`F2FS_I
(
šode
)->
i_cu¼’t_d•th
 = 
d•th
;

2534 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2535 
	}
}

2537 
šlše
 
	$f2fs_i_gc_çu»s_wr™e
(
šode
 *inode,

2538 
couÁ
)

2540 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_PIN
] = 
couÁ
;

2541 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2542 
	}
}

2544 
šlše
 
	$f2fs_i_xnid_wr™e
(
šode
 *šode, 
nid_t
 
xnid
)

2546 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
 = 
xnid
;

2547 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2548 
	}
}

2550 
šlše
 
	$f2fs_i_pšo_wr™e
(
šode
 *šode, 
nid_t
 
pšo
)

2552 
	`F2FS_I
(
šode
)->
i_pšo
 = 
pšo
;

2553 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2554 
	}
}

2556 
šlše
 
	$g‘_šlše_šfo
(
šode
 *šode, 
f2fs_šode
 *
ri
)

2558 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

2560 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_XATTR
)

2561 
	`£t_b™
(
FI_INLINE_XATTR
, &
fi
->
æags
);

2562 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_DATA
)

2563 
	`£t_b™
(
FI_INLINE_DATA
, &
fi
->
æags
);

2564 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_DENTRY
)

2565 
	`£t_b™
(
FI_INLINE_DENTRY
, &
fi
->
æags
);

2566 ià(
ri
->
i_šlše
 & 
F2FS_DATA_EXIST
)

2567 
	`£t_b™
(
FI_DATA_EXIST
, &
fi
->
æags
);

2568 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_DOTS
)

2569 
	`£t_b™
(
FI_INLINE_DOTS
, &
fi
->
æags
);

2570 ià(
ri
->
i_šlše
 & 
F2FS_EXTRA_ATTR
)

2571 
	`£t_b™
(
FI_EXTRA_ATTR
, &
fi
->
æags
);

2572 ià(
ri
->
i_šlše
 & 
F2FS_PIN_FILE
)

2573 
	`£t_b™
(
FI_PIN_FILE
, &
fi
->
æags
);

2574 
	}
}

2576 
šlše
 
	$£t_¿w_šlše
(
šode
 *šode, 
f2fs_šode
 *
ri
)

2578 
ri
->
i_šlše
 = 0;

2580 ià(
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_XATTR
))

2581 
ri
->
i_šlše
 |ğ
F2FS_INLINE_XATTR
;

2582 ià(
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DATA
))

2583 
ri
->
i_šlše
 |ğ
F2FS_INLINE_DATA
;

2584 ià(
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DENTRY
))

2585 
ri
->
i_šlše
 |ğ
F2FS_INLINE_DENTRY
;

2586 ià(
	`is_šode_æag_£t
(
šode
, 
FI_DATA_EXIST
))

2587 
ri
->
i_šlše
 |ğ
F2FS_DATA_EXIST
;

2588 ià(
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DOTS
))

2589 
ri
->
i_šlše
 |ğ
F2FS_INLINE_DOTS
;

2590 ià(
	`is_šode_æag_£t
(
šode
, 
FI_EXTRA_ATTR
))

2591 
ri
->
i_šlše
 |ğ
F2FS_EXTRA_ATTR
;

2592 ià(
	`is_šode_æag_£t
(
šode
, 
FI_PIN_FILE
))

2593 
ri
->
i_šlše
 |ğ
F2FS_PIN_FILE
;

2594 
	}
}

2596 
šlše
 
	$f2fs_has_exŒa_©Œ
(
šode
 *inode)

2598  
	`is_šode_æag_£t
(
šode
, 
FI_EXTRA_ATTR
);

2599 
	}
}

2601 
šlše
 
	$f2fs_has_šlše_x©Œ
(
šode
 *inode)

2603  
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_XATTR
);

2604 
	}
}

2606 
šlše
 
	$addrs_³r_šode
(
šode
 *inode)

2608 
addrs
 = 
	`CUR_ADDRS_PER_INODE
(
šode
) -

2609 
	`g‘_šlše_x©Œ_addrs
(
šode
);

2610  
	`ALIGN_DOWN
(
addrs
, 1);

2611 
	}
}

2613 
šlše
 
	$addrs_³r_block
(
šode
 *inode)

2615  
	`ALIGN_DOWN
(
DEF_ADDRS_PER_BLOCK
, 1);

2616 
	}
}

2618 
šlše
 *
	$šlše_x©Œ_addr
(
šode
 *šode, 
·ge
 *page)

2620 
f2fs_šode
 *
ri
 = 
	`F2FS_INODE
(
·ge
);

2622  (*)&(
ri
->
i_addr
[
DEF_ADDRS_PER_INODE
 -

2623 
	`g‘_šlše_x©Œ_addrs
(
šode
)]);

2624 
	}
}

2626 
šlše
 
	$šlše_x©Œ_size
(
šode
 *inode)

2628 ià(
	`f2fs_has_šlše_x©Œ
(
šode
))

2629  
	`g‘_šlše_x©Œ_addrs
(
šode
è* (
__Ë32
);

2631 
	}
}

2633 
šlše
 
	$f2fs_has_šlše_d©a
(
šode
 *inode)

2635  
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DATA
);

2636 
	}
}

2638 
šlše
 
	$f2fs_exi¡_d©a
(
šode
 *inode)

2640  
	`is_šode_æag_£t
(
šode
, 
FI_DATA_EXIST
);

2641 
	}
}

2643 
šlše
 
	$f2fs_has_šlše_dÙs
(
šode
 *inode)

2645  
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DOTS
);

2646 
	}
}

2648 
šlše
 
boŞ
 
	$f2fs_is_pšÃd_fe
(
šode
 *inode)

2650  
	`is_šode_æag_£t
(
šode
, 
FI_PIN_FILE
);

2651 
	}
}

2653 
šlše
 
boŞ
 
	$f2fs_is_©omic_fe
(
šode
 *inode)

2655  
	`is_šode_æag_£t
(
šode
, 
FI_ATOMIC_FILE
);

2656 
	}
}

2658 
šlše
 
boŞ
 
	$f2fs_is_comm™_©omic_wr™e
(
šode
 *inode)

2660  
	`is_šode_æag_£t
(
šode
, 
FI_ATOMIC_COMMIT
);

2661 
	}
}

2663 
šlše
 
boŞ
 
	$f2fs_is_vŞ©e_fe
(
šode
 *inode)

2665  
	`is_šode_æag_£t
(
šode
, 
FI_VOLATILE_FILE
);

2666 
	}
}

2668 
šlše
 
boŞ
 
	$f2fs_is_fœ¡_block_wr™‹n
(
šode
 *inode)

2670  
	`is_šode_æag_£t
(
šode
, 
FI_FIRST_BLOCK_WRITTEN
);

2671 
	}
}

2673 
šlše
 
boŞ
 
	$f2fs_is_drİ_ÿche
(
šode
 *inode)

2675  
	`is_šode_æag_£t
(
šode
, 
FI_DROP_CACHE
);

2676 
	}
}

2678 
šlše
 *
	$šlše_d©a_addr
(
šode
 *šode, 
·ge
 *page)

2680 
f2fs_šode
 *
ri
 = 
	`F2FS_INODE
(
·ge
);

2681 
exŒa_size
 = 
	`g‘_exŒa_isize
(
šode
);

2683  (*)&(
ri
->
i_addr
[
exŒa_size
 + 
DEF_INLINE_RESERVED_SIZE
]);

2684 
	}
}

2686 
šlše
 
	$f2fs_has_šlše_d’Œy
(
šode
 *inode)

2688  
	`is_šode_æag_£t
(
šode
, 
FI_INLINE_DENTRY
);

2689 
	}
}

2691 
šlše
 
	$is_fe
(
šode
 *šode, 
ty³
)

2693  
	`F2FS_I
(
šode
)->
i_advi£
 & 
ty³
;

2694 
	}
}

2696 
šlše
 
	$£t_fe
(
šode
 *šode, 
ty³
)

2698 
	`F2FS_I
(
šode
)->
i_advi£
 |ğ
ty³
;

2699 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2700 
	}
}

2702 
šlše
 
	$ş—r_fe
(
šode
 *šode, 
ty³
)

2704 
	`F2FS_I
(
šode
)->
i_advi£
 &ğ~
ty³
;

2705 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2706 
	}
}

2708 
šlše
 
boŞ
 
	$f2fs_is_time_cÚsi¡’t
(
šode
 *inode)

2710 ià(!
	`time¥ec64_equ®
(
	`F2FS_I
(
šode
)->
i_disk_time
, &šode->
i_©ime
))

2711  
çl£
;

2712 ià(!
	`time¥ec64_equ®
(
	`F2FS_I
(
šode
)->
i_disk_time
 + 1, &šode->
i_ùime
))

2713  
çl£
;

2714 ià(!
	`time¥ec64_equ®
(
	`F2FS_I
(
šode
)->
i_disk_time
 + 2, &šode->
i_mtime
))

2715  
çl£
;

2716 ià(!
	`time¥ec64_equ®
(
	`F2FS_I
(
šode
)->
i_disk_time
 + 3,

2717 &
	`F2FS_I
(
šode
)->
i_ütime
))

2718  
çl£
;

2719  
Œue
;

2720 
	}
}

2722 
šlše
 
boŞ
 
	$f2fs_sk_šode_upd©e
(
šode
 *šode, 
dsync
)

2724 
boŞ
 
»t
;

2726 ià(
dsync
) {

2727 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2729 
	`¥š_lock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

2730 
»t
 = 
	`li¡_em±y
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
);

2731 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

2732  
»t
;

2734 ià(!
	`is_šode_æag_£t
(
šode
, 
FI_AUTO_RECOVER
) ||

2735 
	`fe_k“p_isize
(
šode
) ||

2736 
	`i_size_»ad
(
šode
è& ~
PAGE_MASK
)

2737  
çl£
;

2739 ià(!
	`f2fs_is_time_cÚsi¡’t
(
šode
))

2740  
çl£
;

2742 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_£m
);

2743 
»t
 = 
	`F2FS_I
(
šode
)->
Ï¡_disk_size
 =ğ
	`i_size_»ad
(inode);

2744 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_£m
);

2746  
»t
;

2747 
	}
}

2749 
šlše
 
boŞ
 
	$f2fs_»adÚly
(
su³r_block
 *
sb
)

2751  
	`sb_rdÚly
(
sb
);

2752 
	}
}

2754 
šlše
 
boŞ
 
	$f2fs_ı_”rÜ
(
f2fs_sb_šfo
 *
sbi
)

2756  
	`is_£t_ck±_æags
(
sbi
, 
CP_ERROR_FLAG
);

2757 
	}
}

2759 
šlše
 
boŞ
 
	$is_dÙ_dÙdÙ
(cÚ¡ 
q¡r
 *
¡r
)

2761 ià(
¡r
->
Ën
 =ğ1 && sŒ->
Çme
[0] == '.')

2762  
Œue
;

2764 ià(
¡r
->
Ën
 =ğ2 && sŒ->
Çme
[0] == '.' && str->name[1] == '.')

2765  
Œue
;

2767  
çl£
;

2768 
	}
}

2770 
šlše
 
boŞ
 
	$f2fs_may_ex‹Á_Œ“
(
šode
 *inode)

2772 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2774 ià(!
	`‹¡_İt
(
sbi
, 
EXTENT_CACHE
) ||

2775 
	`is_šode_æag_£t
(
šode
, 
FI_NO_EXTENT
))

2776  
çl£
;

2782 ià(
	`li¡_em±y
(&
sbi
->
s_li¡
))

2783  
çl£
;

2785  
	`S_ISREG
(
šode
->
i_mode
);

2786 
	}
}

2788 
šlše
 *
	$f2fs_km®loc
(
f2fs_sb_šfo
 *
sbi
,

2789 
size_t
 
size
, 
gå_t
 
æags
)

2791 *
»t
;

2793 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_KMALLOC
)) {

2794 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_KMALLOC
);

2795  
NULL
;

2798 
»t
 = 
	`km®loc
(
size
, 
æags
);

2799 ià(
»t
)

2800  
»t
;

2802  
	`kvm®loc
(
size
, 
æags
);

2803 
	}
}

2805 
šlše
 *
	$f2fs_kz®loc
(
f2fs_sb_šfo
 *
sbi
,

2806 
size_t
 
size
, 
gå_t
 
æags
)

2808  
	`f2fs_km®loc
(
sbi
, 
size
, 
æags
 | 
__GFP_ZERO
);

2809 
	}
}

2811 
šlše
 *
	$f2fs_kvm®loc
(
f2fs_sb_šfo
 *
sbi
,

2812 
size_t
 
size
, 
gå_t
 
æags
)

2814 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_KVMALLOC
)) {

2815 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_KVMALLOC
);

2816  
NULL
;

2819  
	`kvm®loc
(
size
, 
æags
);

2820 
	}
}

2822 
šlše
 *
	$f2fs_kvz®loc
(
f2fs_sb_šfo
 *
sbi
,

2823 
size_t
 
size
, 
gå_t
 
æags
)

2825  
	`f2fs_kvm®loc
(
sbi
, 
size
, 
æags
 | 
__GFP_ZERO
);

2826 
	}
}

2828 
šlše
 
	$g‘_exŒa_isize
(
šode
 *inode)

2830  
	`F2FS_I
(
šode
)->
i_exŒa_isize
 / (
__Ë32
);

2831 
	}
}

2833 
šlše
 
	$g‘_šlše_x©Œ_addrs
(
šode
 *inode)

2835  
	`F2FS_I
(
šode
)->
i_šlše_x©Œ_size
;

2836 
	}
}

2838 
	#f2fs_g‘_šode_mode
(
i
) \

2839 ((
	`is_šode_æag_£t
(
i
, 
FI_ACL_MODE
)) ? \

2840 (
	`F2FS_I
(
i
)->
i_aş_mode
è: ((i)->
i_mode
))

	)

2842 
	#F2FS_TOTAL_EXTRA_ATTR_SIZE
 \

2843 (
	`off£tof
(
f2fs_šode
, 
i_exŒa_’d
) - \

2844 
	`off£tof
(
f2fs_šode
, 
i_exŒa_isize
)) \

2845 

	)

2846 
	#F2FS_OLD_ATTRIBUTE_SIZE
 (
	`off£tof
(
f2fs_šode
, 
i_addr
))

	)

2847 
	#F2FS_FITS_IN_INODE
(
f2fs_šode
, 
exŒa_isize
, 
f›ld
) \

2848 ((
	`off£tof
(
	`ty³of
(*(
f2fs_šode
)), 
f›ld
) + \

2849 ((
f2fs_šode
)->
f›ld
)) \

2850 <ğ(
F2FS_OLD_ATTRIBUTE_SIZE
 + (
exŒa_isize
))) \

2851 

	)

2852 
šlše
 
	$f2fs_»£t_io¡©
(
f2fs_sb_šfo
 *
sbi
)

2854 
i
;

2856 
	`¥š_lock
(&
sbi
->
io¡©_lock
);

2857 
i
 = 0; i < 
NR_IO_TYPE
; i++)

2858 
sbi
->
wr™e_io¡©
[
i
] = 0;

2859 
	`¥š_uÆock
(&
sbi
->
io¡©_lock
);

2860 
	}
}

2862 
šlše
 
	$f2fs_upd©e_io¡©
(
f2fs_sb_šfo
 *
sbi
,

2863 
io¡©_ty³
 
ty³
, 
io_by‹s
)

2865 ià(!
sbi
->
io¡©_’abË
)

2867 
	`¥š_lock
(&
sbi
->
io¡©_lock
);

2868 
sbi
->
wr™e_io¡©
[
ty³
] +ğ
io_by‹s
;

2870 ià(
ty³
 =ğ
APP_WRITE_IO
 ||y³ =ğ
APP_DIRECT_IO
)

2871 
sbi
->
wr™e_io¡©
[
APP_BUFFERED_IO
] =

2872 
sbi
->
wr™e_io¡©
[
APP_WRITE_IO
] -

2873 
sbi
->
wr™e_io¡©
[
APP_DIRECT_IO
];

2874 
	`¥š_uÆock
(&
sbi
->
io¡©_lock
);

2875 
	}
}

2877 
	#__is_Ïrge_£ùiÚ
(
sbi
è((sbi)->
£gs_³r_£c
 > 1)

	)

2879 
	#__is_m‘a_io
(
fio
è(
	`PAGE_TYPE_OF_BIO
((fio)->
ty³
è=ğ
META
)

	)

2881 
boŞ
 
f2fs_is_v®id_blkaddr
(
f2fs_sb_šfo
 *
sbi
,

2882 
block_t
 
blkaddr
, 
ty³
);

2883 
šlše
 
	$v”ify_blkaddr
(
f2fs_sb_šfo
 *
sbi
,

2884 
block_t
 
blkaddr
, 
ty³
)

2886 ià(!
	`f2fs_is_v®id_blkaddr
(
sbi
, 
blkaddr
, 
ty³
)) {

2887 
	`f2fs_”r
(
sbi
, "invalid blkaddr: %u,ype: %d,„un fscko fix.",

2888 
blkaddr
, 
ty³
);

2889 
	`f2fs_bug_Ú
(
sbi
, 1);

2891 
	}
}

2893 
šlše
 
boŞ
 
	$__is_v®id_d©a_blkaddr
(
block_t
 
blkaddr
)

2895 ià(
blkaddr
 =ğ
NEW_ADDR
 || blkadd¸=ğ
NULL_ADDR
)

2896  
çl£
;

2897  
Œue
;

2898 
	}
}

2900 
šlše
 
	$f2fs_£t_·ge_´iv©e
(
·ge
 *page,

2901 
d©a
)

2903 ià(
	`PagePriv©e
(
·ge
))

2906 
	`g‘_·ge
(
·ge
);

2907 
	`S‘PagePriv©e
(
·ge
);

2908 
	`£t_·ge_´iv©e
(
·ge
, 
d©a
);

2909 
	}
}

2911 
šlše
 
	$f2fs_ş—r_·ge_´iv©e
(
·ge
 *page)

2913 ià(!
	`PagePriv©e
(
·ge
))

2916 
	`£t_·ge_´iv©e
(
·ge
, 0);

2917 
	`CË¬PagePriv©e
(
·ge
);

2918 
	`f2fs_put_·ge
(
·ge
, 0);

2919 
	}
}

2924 
f2fs_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
);

2925 
f2fs_Œunÿ‹_d©a_blocks
(
dnode_of_d©a
 *
dn
);

2926 
f2fs_Œunÿ‹_blocks
(
šode
 *šode, 
u64
 
äom
, 
boŞ
 
lock
);

2927 
f2fs_Œunÿ‹
(
šode
 *inode);

2928 
f2fs_g‘©Œ
(cÚ¡ 
·th
 *·th, 
k¡©
 *
¡©
,

2929 
u32
 
»que¡_mask
, 
æags
);

2930 
f2fs_£‰r
(
d’Œy
 *d’Œy, 
Ÿ‰r
 *
©Œ
);

2931 
f2fs_Œunÿ‹_hŞe
(
šode
 *šode, 
pgoff_t
 
pg_¡¬t
,…goff_ˆ
pg_’d
);

2932 
f2fs_Œunÿ‹_d©a_blocks_¿nge
(
dnode_of_d©a
 *
dn
, 
couÁ
);

2933 
f2fs_´eÿche_ex‹Ás
(
šode
 *inode);

2934 
f2fs_ioùl
(
fe
 *
fp
, 
cmd
, 
¬g
);

2935 
f2fs_com·t_ioùl
(
fe
 *fe, 
cmd
, 
¬g
);

2936 
f2fs_Œªsãr_´ojeù_quÙa
(
šode
 *šode, 
k´ojid_t
 
k´ojid
);

2937 
f2fs_pš_fe_cÚŒŞ
(
šode
 *šode, 
boŞ
 
šc
);

2942 
f2fs_£t_šode_æags
(
šode
 *inode);

2943 
boŞ
 
f2fs_šode_chksum_v”ify
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page);

2944 
f2fs_šode_chksum_£t
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page);

2945 
šode
 *
f2fs_ig‘
(
su³r_block
 *
sb
, 
šo
);

2946 
šode
 *
f2fs_ig‘_»Œy
(
su³r_block
 *
sb
, 
šo
);

2947 
f2fs_Œy_to_ä“_Çts
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
);

2948 
f2fs_upd©e_šode
(
šode
 *šode, 
·ge
 *
node_·ge
);

2949 
f2fs_upd©e_šode_·ge
(
šode
 *inode);

2950 
f2fs_wr™e_šode
(
šode
 *šode, 
wr™eback_cÚŒŞ
 *
wbc
);

2951 
f2fs_eviù_šode
(
šode
 *inode);

2952 
f2fs_hªdË_çed_šode
(
šode
 *inode);

2957 
f2fs_upd©e_ex‹nsiÚ_li¡
(
f2fs_sb_šfo
 *
sbi
, cÚ¡ *
Çme
,

2958 
boŞ
 
hÙ
, boŞ 
£t
);

2959 
d’Œy
 *
f2fs_g‘_·»Á
(d’Œy *
chd
);

2961 
f2fs_ci_com·»
(cÚ¡ 
šode
 *
·»Á
,

2962 cÚ¡ 
q¡r
 *
Çme
,

2963 cÚ¡ 
q¡r
 *
’Œy
,

2964 
boŞ
 
quick
);

2969 
f2fs_g‘_de_ty³
(
f2fs_dœ_’Œy
 *
de
);

2970 
f2fs_dœ_’Œy
 *
f2fs_fšd_rg‘_d’Œy
(
fsüy±_Çme
 *
âame
,

2971 
f2fs_hash_t
 
Çmehash
, *
max_¦Ùs
,

2972 
f2fs_d’Œy_±r
 *
d
);

2973 
f2fs_fl_d’Œ›s
(
dœ_cÚ‹xt
 *
ùx
, 
f2fs_d’Œy_±r
 *
d
,

2974 
¡¬t_pos
, 
fsüy±_¡r
 *
f¡r
);

2975 
f2fs_do_make_em±y_dœ
(
šode
 *šode, šod*
·»Á
,

2976 
f2fs_d’Œy_±r
 *
d
);

2977 
·ge
 *
f2fs_š™_šode_m‘ad©a
(
šode
 *šode, šod*
dœ
,

2978 cÚ¡ 
q¡r
 *
Ãw_Çme
,

2979 cÚ¡ 
q¡r
 *
Üig_Çme
, 
·ge
 *
d·ge
);

2980 
f2fs_upd©e_·»Á_m‘ad©a
(
šode
 *
dœ
, inode *inode,

2981 
cu¼’t_d•th
);

2982 
f2fs_room_fÜ_f’ame
(cÚ¡ *
b™m­
, 
¦Ùs
, 
max_¦Ùs
);

2983 
f2fs_drİ_Æšk
(
šode
 *
dœ
, inode *inode);

2984 
f2fs_dœ_’Œy
 *
__f2fs_fšd_’Œy
(
šode
 *
dœ
,

2985 
fsüy±_Çme
 *
âame
, 
·ge
 **
»s_·ge
);

2986 
f2fs_dœ_’Œy
 *
f2fs_fšd_’Œy
(
šode
 *
dœ
,

2987 cÚ¡ 
q¡r
 *
chd
, 
·ge
 **
»s_·ge
);

2988 
f2fs_dœ_’Œy
 *
f2fs_·»Á_dœ
(
šode
 *
dœ
, 
·ge
 **
p
);

2989 
šo_t
 
f2fs_šode_by_Çme
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *qstr,

2990 
·ge
 **page);

2991 
f2fs_£t_lšk
(
šode
 *
dœ
, 
f2fs_dœ_’Œy
 *
de
,

2992 
·ge
 *·ge, 
šode
 *inode);

2993 
f2fs_upd©e_d’Œy
(
nid_t
 
šo
, 
umode_t
 
mode
, 
f2fs_d’Œy_±r
 *
d
,

2994 cÚ¡ 
q¡r
 *
Çme
, 
f2fs_hash_t
 
Çme_hash
,

2995 
b™_pos
);

2996 
f2fs_add_»guÏr_’Œy
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Ãw_Çme
,

2997 cÚ¡ 
q¡r
 *
Üig_Çme
,

2998 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
);

2999 
f2fs_add_d’Œy
(
šode
 *
dœ
, 
fsüy±_Çme
 *
âame
,

3000 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
);

3001 
f2fs_do_add_lšk
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Çme
,

3002 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
);

3003 
f2fs_d–‘e_’Œy
(
f2fs_dœ_’Œy
 *
d’Œy
, 
·ge
 *page,

3004 
šode
 *
dœ
, inode *inode);

3005 
f2fs_do_tmpfe
(
šode
 *šode, šod*
dœ
);

3006 
boŞ
 
f2fs_em±y_dœ
(
šode
 *
dœ
);

3008 
šlše
 
	$f2fs_add_lšk
(
d’Œy
 *d’Œy, 
šode
 *inode)

3010  
	`f2fs_do_add_lšk
(
	`d_šode
(
d’Œy
->
d_·»Á
), &d’Œy->
d_Çme
,

3011 
šode
, inode->
i_šo
, inode->
i_mode
);

3012 
	}
}

3017 
f2fs_šode_dœt›d
(
šode
 *šode, 
boŞ
 
sync
);

3018 
f2fs_šode_synûd
(
šode
 *inode);

3019 
f2fs_’abË_quÙa_fes
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
rdÚly
);

3020 
f2fs_quÙa_sync
(
su³r_block
 *
sb
, 
ty³
);

3021 
f2fs_quÙa_off_umouÁ
(
su³r_block
 *
sb
);

3022 
f2fs_comm™_su³r
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
»cov”
);

3023 
f2fs_sync_fs
(
su³r_block
 *
sb
, 
sync
);

3024 
f2fs_§n™y_check_ck±
(
f2fs_sb_šfo
 *
sbi
);

3029 
f2fs_hash_t
 
f2fs_d’Œy_hash
(cÚ¡ 
šode
 *
dœ
,

3030 cÚ¡ 
q¡r
 *
Çme_šfo
, 
fsüy±_Çme
 *
âame
);

3035 
	gdnode_of_d©a
;

3036 
	gnode_šfo
;

3038 
f2fs_check_nid_¿nge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

3039 
boŞ
 
f2fs_avaabË_ä“_memÜy
(
f2fs_sb_šfo
 *
sbi
, 
ty³
);

3040 
boŞ
 
f2fs_š_w¬m_node_li¡
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page);

3041 
f2fs_š™_fsync_node_šfo
(
f2fs_sb_šfo
 *
sbi
);

3042 
f2fs_d–_fsync_node_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page);

3043 
f2fs_»£t_fsync_node_šfo
(
f2fs_sb_šfo
 *
sbi
);

3044 
f2fs_Ãed_d’Œy_m¬k
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

3045 
boŞ
 
f2fs_is_checkpoš‹d_node
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

3046 
boŞ
 
f2fs_Ãed_šode_block_upd©e
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
);

3047 
f2fs_g‘_node_šfo
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
,

3048 
node_šfo
 *
ni
);

3049 
pgoff_t
 
f2fs_g‘_Ãxt_·ge_off£t
(
dnode_of_d©a
 *
dn
,…goff_ˆ
pgofs
);

3050 
f2fs_g‘_dnode_of_d©a
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
, 
mode
);

3051 
f2fs_Œunÿ‹_šode_blocks
(
šode
 *šode, 
pgoff_t
 
äom
);

3052 
f2fs_Œunÿ‹_x©Œ_node
(
šode
 *inode);

3053 
f2fs_wa™_Ú_node_·ges_wr™eback
(
f2fs_sb_šfo
 *
sbi
,

3054 
£q_id
);

3055 
f2fs_»move_šode_·ge
(
šode
 *inode);

3056 
·ge
 *
f2fs_Ãw_šode_·ge
(
šode
 *inode);

3057 
·ge
 *
f2fs_Ãw_node_·ge
(
dnode_of_d©a
 *
dn
, 
ofs
);

3058 
f2fs_¿_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

3059 
·ge
 *
f2fs_g‘_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
nid
);

3060 
·ge
 *
f2fs_g‘_node_·ge_¿
(·g*
·»Á
, 
¡¬t
);

3061 
f2fs_move_node_·ge
(
·ge
 *
node_·ge
, 
gc_ty³
);

3062 
f2fs_fsync_node_·ges
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

3063 
wr™eback_cÚŒŞ
 *
wbc
, 
boŞ
 
©omic
,

3064 *
£q_id
);

3065 
f2fs_sync_node_·ges
(
f2fs_sb_šfo
 *
sbi
,

3066 
wr™eback_cÚŒŞ
 *
wbc
,

3067 
boŞ
 
do_b®ªû
, 
io¡©_ty³
 
io_ty³
);

3068 
f2fs_bud_ä“_nids
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
sync
, boŞ 
mouÁ
);

3069 
boŞ
 
f2fs_®loc_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 *
nid
);

3070 
f2fs_®loc_nid_dÚe
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

3071 
f2fs_®loc_nid_çed
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
);

3072 
f2fs_Œy_to_ä“_nids
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
);

3073 
f2fs_»cov”_šlše_x©Œ
(
šode
 *šode, 
·ge
 *page);

3074 
f2fs_»cov”_x©Œ_d©a
(
šode
 *šode, 
·ge
 *page);

3075 
f2fs_»cov”_šode_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page);

3076 
f2fs_»¡Üe_node_summ¬y
(
f2fs_sb_šfo
 *
sbi
,

3077 
£gno
, 
f2fs_summ¬y_block
 *
sum
);

3078 
f2fs_æush_Çt_’Œ›s
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
);

3079 
f2fs_bud_node_mªag”
(
f2fs_sb_šfo
 *
sbi
);

3080 
f2fs_de¡roy_node_mªag”
(
f2fs_sb_šfo
 *
sbi
);

3081 
__š™
 
f2fs_ü—‹_node_mªag”_ÿches
();

3082 
f2fs_de¡roy_node_mªag”_ÿches
();

3087 
boŞ
 
f2fs_Ãed_SSR
(
f2fs_sb_šfo
 *
sbi
);

3088 
f2fs_»gi¡”_šmem_·ge
(
šode
 *šode, 
·ge
 *page);

3089 
f2fs_drİ_šmem_·ges_®l
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
gc_çu»
);

3090 
f2fs_drİ_šmem_·ges
(
šode
 *inode);

3091 
f2fs_drİ_šmem_·ge
(
šode
 *šode, 
·ge
 *page);

3092 
f2fs_comm™_šmem_·ges
(
šode
 *inode);

3093 
f2fs_b®ªû_fs
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
Ãed
);

3094 
f2fs_b®ªû_fs_bg
(
f2fs_sb_šfo
 *
sbi
);

3095 
f2fs_issue_æush
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
);

3096 
f2fs_ü—‹_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
);

3097 
f2fs_æush_deviû_ÿche
(
f2fs_sb_šfo
 *
sbi
);

3098 
f2fs_de¡roy_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
ä“
);

3099 
f2fs_šv®id©e_blocks
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
addr
);

3100 
boŞ
 
f2fs_is_checkpoš‹d_d©a
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
);

3101 
f2fs_drİ_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
);

3102 
f2fs_¡İ_disÿrd_th»ad
(
f2fs_sb_šfo
 *
sbi
);

3103 
boŞ
 
f2fs_issue_disÿrd_timeout
(
f2fs_sb_šfo
 *
sbi
);

3104 
f2fs_ş—r_´eä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
,

3105 
ı_cÚŒŞ
 *
ıc
);

3106 
f2fs_dœty_to_´eä“
(
f2fs_sb_šfo
 *
sbi
);

3107 
block_t
 
f2fs_g‘_unu§bË_blocks
(
f2fs_sb_šfo
 *
sbi
);

3108 
f2fs_di§bË_ı_agaš
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
unu§bË
);

3109 
f2fs_»Ëa£_disÿrd_addrs
(
f2fs_sb_šfo
 *
sbi
);

3110 
f2fs_Åages_fÜ_summ¬y_æush
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
fÜ_¿
);

3111 
®loÿ‹_£gm’t_fÜ_»size
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

3112 
¡¬t
, 
’d
);

3113 
f2fs_®loÿ‹_Ãw_£gm’ts
(
f2fs_sb_šfo
 *
sbi
);

3114 
f2fs_Œim_fs
(
f2fs_sb_šfo
 *
sbi
, 
f¡rim_¿nge
 *
¿nge
);

3115 
boŞ
 
f2fs_exi¡_Œim_ÿndid©es
(
f2fs_sb_šfo
 *
sbi
,

3116 
ı_cÚŒŞ
 *
ıc
);

3117 
·ge
 *
f2fs_g‘_sum_·ge
(
f2fs_sb_šfo
 *
sbi
, 
£gno
);

3118 
f2fs_upd©e_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, *
¤c
,

3119 
block_t
 
blk_addr
);

3120 
f2fs_do_wr™e_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

3121 
io¡©_ty³
 
io_ty³
);

3122 
f2fs_do_wr™e_node_·ge
(
nid
, 
f2fs_io_šfo
 *
fio
);

3123 
f2fs_ouÏû_wr™e_d©a
(
dnode_of_d©a
 *
dn
,

3124 
f2fs_io_šfo
 *
fio
);

3125 
f2fs_š¶aû_wr™e_d©a
(
f2fs_io_šfo
 *
fio
);

3126 
f2fs_do_»¶aû_block
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

3127 
block_t
 
Şd_blkaddr
, block_ˆ
Ãw_blkaddr
,

3128 
boŞ
 
»cov”_cur£g
, boŞ 
»cov”_Ãwaddr
);

3129 
f2fs_»¶aû_block
(
f2fs_sb_šfo
 *
sbi
, 
dnode_of_d©a
 *
dn
,

3130 
block_t
 
Şd_addr
, block_ˆ
Ãw_addr
,

3131 
v”siÚ
, 
boŞ
 
»cov”_cur£g
,

3132 
boŞ
 
»cov”_Ãwaddr
);

3133 
f2fs_®loÿ‹_d©a_block
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

3134 
block_t
 
Şd_blkaddr
, block_ˆ*
Ãw_blkaddr
,

3135 
f2fs_summ¬y
 *
sum
, 
ty³
,

3136 
f2fs_io_šfo
 *
fio
, 
boŞ
 
add_li¡
);

3137 
f2fs_wa™_Ú_·ge_wr™eback
(
·ge
 *page,

3138 
·ge_ty³
 
ty³
, 
boŞ
 
Üd”ed
, boŞ 
locked
);

3139 
f2fs_wa™_Ú_block_wr™eback
(
šode
 *šode, 
block_t
 
blkaddr
);

3140 
f2fs_wa™_Ú_block_wr™eback_¿nge
(
šode
 *šode, 
block_t
 
blkaddr
,

3141 
block_t
 
Ën
);

3142 
f2fs_wr™e_d©a_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
);

3143 
f2fs_wr™e_node_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
);

3144 
f2fs_lookup_jouº®_š_cursum
(
f2fs_jouº®
 *
jouº®
, 
ty³
,

3145 
v®
, 
®loc
);

3146 
f2fs_æush_s™_’Œ›s
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
);

3147 
f2fs_bud_£gm’t_mªag”
(
f2fs_sb_šfo
 *
sbi
);

3148 
f2fs_de¡roy_£gm’t_mªag”
(
f2fs_sb_šfo
 *
sbi
);

3149 
__š™
 
f2fs_ü—‹_£gm’t_mªag”_ÿches
();

3150 
f2fs_de¡roy_£gm’t_mªag”_ÿches
();

3151 
f2fs_rw_hšt_to_£g_ty³
(
rw_hšt
 
hšt
);

3152 
rw_hšt
 
f2fs_io_ty³_to_rw_hšt
(
f2fs_sb_šfo
 *
sbi
,

3153 
·ge_ty³
 
ty³
, 
‹mp_ty³
 
‹mp
);

3158 
f2fs_¡İ_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
’d_io
);

3159 
·ge
 *
f2fs_g¿b_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
);

3160 
·ge
 *
f2fs_g‘_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
);

3161 
·ge
 *
f2fs_g‘_m‘a_·ge_noç
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
);

3162 
·ge
 *
f2fs_g‘_tmp_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
);

3163 
boŞ
 
f2fs_is_v®id_blkaddr
(
f2fs_sb_šfo
 *
sbi
,

3164 
block_t
 
blkaddr
, 
ty³
);

3165 
f2fs_¿_m‘a_·ges
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t
, 
Ä·ges
,

3166 
ty³
, 
boŞ
 
sync
);

3167 
f2fs_¿_m‘a_·ges_cÚd
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
);

3168 
f2fs_sync_m‘a_·ges
(
f2fs_sb_šfo
 *
sbi
, 
·ge_ty³
 
ty³
,

3169 
Ä_to_wr™e
, 
io¡©_ty³
 
io_ty³
);

3170 
f2fs_add_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
);

3171 
f2fs_»move_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
);

3172 
f2fs_»Ëa£_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
®l
);

3173 
boŞ
 
f2fs_exi¡_wr™‹n_d©a
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
mode
);

3174 
f2fs_£t_dœty_deviû
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

3175 
devidx
, 
ty³
);

3176 
boŞ
 
f2fs_is_dœty_deviû
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

3177 
devidx
, 
ty³
);

3178 
f2fs_sync_šode_m‘a
(
f2fs_sb_šfo
 *
sbi
);

3179 
f2fs_acquœe_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
);

3180 
f2fs_»Ëa£_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
);

3181 
f2fs_add_Üphª_šode
(
šode
 *inode);

3182 
f2fs_»move_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
);

3183 
f2fs_»cov”_Üphª_šodes
(
f2fs_sb_šfo
 *
sbi
);

3184 
f2fs_g‘_v®id_checkpošt
(
f2fs_sb_šfo
 *
sbi
);

3185 
f2fs_upd©e_dœty_·ge
(
šode
 *šode, 
·ge
 *page);

3186 
f2fs_»move_dœty_šode
(
šode
 *inode);

3187 
f2fs_sync_dœty_šodes
(
f2fs_sb_šfo
 *
sbi
, 
šode_ty³
 
ty³
);

3188 
f2fs_wa™_Ú_®l_·ges_wr™eback
(
f2fs_sb_šfo
 *
sbi
);

3189 
f2fs_wr™e_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
);

3190 
f2fs_š™_šo_’Œy_šfo
(
f2fs_sb_šfo
 *
sbi
);

3191 
__š™
 
f2fs_ü—‹_checkpošt_ÿches
();

3192 
f2fs_de¡roy_checkpošt_ÿches
();

3197 
f2fs_š™_po¡_»ad_´oûssšg
();

3198 
f2fs_de¡roy_po¡_»ad_´oûssšg
();

3199 
f2fs_subm™_m”ged_wr™e
(
f2fs_sb_šfo
 *
sbi
, 
·ge_ty³
 
ty³
);

3200 
f2fs_subm™_m”ged_wr™e_cÚd
(
f2fs_sb_šfo
 *
sbi
,

3201 
šode
 *šode, 
·ge
 *page,

3202 
nid_t
 
šo
, 
·ge_ty³
 
ty³
);

3203 
f2fs_æush_m”ged_wr™es
(
f2fs_sb_šfo
 *
sbi
);

3204 
f2fs_subm™_·ge_bio
(
f2fs_io_šfo
 *
fio
);

3205 
f2fs_m”ge_·ge_bio
(
f2fs_io_šfo
 *
fio
);

3206 
f2fs_subm™_·ge_wr™e
(
f2fs_io_šfo
 *
fio
);

3207 
block_deviû
 *
f2fs_rg‘_deviû
(
f2fs_sb_šfo
 *
sbi
,

3208 
block_t
 
blk_addr
, 
bio
 *bio);

3209 
f2fs_rg‘_deviû_šdex
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
);

3210 
f2fs_£t_d©a_blkaddr
(
dnode_of_d©a
 *
dn
);

3211 
f2fs_upd©e_d©a_blkaddr
(
dnode_of_d©a
 *
dn
, 
block_t
 
blkaddr
);

3212 
f2fs_»£rve_Ãw_blocks
(
dnode_of_d©a
 *
dn
, 
blkút_t
 
couÁ
);

3213 
f2fs_»£rve_Ãw_block
(
dnode_of_d©a
 *
dn
);

3214 
f2fs_g‘_block
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
);

3215 
f2fs_´—Îoÿ‹_blocks
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
);

3216 
f2fs_»£rve_block
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
);

3217 
·ge
 *
f2fs_g‘_»ad_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
,

3218 
İ_æags
, 
boŞ
 
fÜ_wr™e
);

3219 
·ge
 *
f2fs_fšd_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
);

3220 
·ge
 *
f2fs_g‘_lock_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
,

3221 
boŞ
 
fÜ_wr™e
);

3222 
·ge
 *
f2fs_g‘_Ãw_d©a_·ge
(
šode
 *inode,

3223 
·ge
 *
age
, 
pgoff_t
 
šdex
, 
boŞ
 
Ãw_i_size
);

3224 
f2fs_do_wr™e_d©a_·ge
(
f2fs_io_šfo
 *
fio
);

3225 
__do_m­_lock
(
f2fs_sb_šfo
 *
sbi
, 
æag
, 
boŞ
 
lock
);

3226 
f2fs_m­_blocks
(
šode
 *šode, f2fs_m­_block *
m­
,

3227 
ü—‹
, 
æag
);

3228 
f2fs_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

3229 
u64
 
¡¬t
, u64 
Ën
);

3230 
boŞ
 
f2fs_should_upd©e_š¶aû
(
šode
 *šode, 
f2fs_io_šfo
 *
fio
);

3231 
boŞ
 
f2fs_should_upd©e_ouÏû
(
šode
 *šode, 
f2fs_io_šfo
 *
fio
);

3232 
f2fs_šv®id©e_·ge
(
·ge
 *·ge, 
off£t
,

3233 
Ëngth
);

3234 
f2fs_»Ëa£_·ge
(
·ge
 *·ge, 
gå_t
 
wa™
);

3235 #ifdeà
CONFIG_MIGRATION


3236 
f2fs_mig¿‹_·ge
(
add»ss_¥aû
 *
m­pšg
, 
·ge
 *
Ãw·ge
,

3237 
·ge
 *·ge, 
mig¿‹_mode
 
mode
);

3239 
boŞ
 
f2fs_ov”wr™e_io
(
šode
 *šode, 
loff_t
 
pos
, 
size_t
 
Ën
);

3240 
f2fs_ş—r_·ge_ÿche_dœty_g
(
·ge
 *page);

3245 
f2fs_¡¬t_gc_th»ad
(
f2fs_sb_šfo
 *
sbi
);

3246 
f2fs_¡İ_gc_th»ad
(
f2fs_sb_šfo
 *
sbi
);

3247 
block_t
 
f2fs_¡¬t_bidx_of_node
(
node_ofs
, 
šode
 *inode);

3248 
f2fs_gc
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
sync
, boŞ 
background
,

3249 
£gno
);

3250 
f2fs_bud_gc_mªag”
(
f2fs_sb_šfo
 *
sbi
);

3251 
f2fs_»size_fs
(
f2fs_sb_šfo
 *
sbi
, 
__u64
 
block_couÁ
);

3256 
f2fs_»cov”_fsync_d©a
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
check_Úly
);

3257 
boŞ
 
f2fs_¥aû_fÜ_rŞl_fÜw¬d
(
f2fs_sb_šfo
 *
sbi
);

3262 #ifdeà
CONFIG_F2FS_STAT_FS


3263 
	sf2fs_¡©_šfo
 {

3264 
li¡_h—d
 
	m¡©_li¡
;

3265 
f2fs_sb_šfo
 *
	msbi
;

3266 
	m®l_¬—_£gs
, 
	ms™_¬—_£gs
, 
	mÇt_¬—_£gs
, 
	ms§_¬—_£gs
;

3267 
	mmaš_¬—_£gs
, 
	mmaš_¬—_£ùiÚs
, 
	mmaš_¬—_zÚes
;

3268 
	mh™_Ïrge¡
, 
	mh™_ÿched
, 
	mh™_rbŒ“
;

3269 
	mh™_tÙ®
, 
	mtÙ®_ext
;

3270 
	mext_Œ“
, 
	mzomb›_Œ“
, 
	mext_node
;

3271 
	mndœty_node
, 
	mndœty_d’t
, 
	mndœty_m‘a
, 
	mndœty_im‘a
;

3272 
	mndœty_d©a
, 
	mndœty_qd©a
;

3273 
	mšmem_·ges
;

3274 
	mndœty_dœs
, 
	mndœty_fes
, 
	mnquÙa_fes
, 
	mndœty_®l
;

3275 
	mÇts
, 
	mdœty_Çts
, 
	ms™s
, 
	mdœty_s™s
;

3276 
	mä“_nids
, 
	mava_nids
, 
	m®loc_nids
;

3277 
	mtÙ®_couÁ
, 
	mutiz©iÚ
;

3278 
	mbg_gc
, 
	mÄ_wb_ı_d©a
, 
	mÄ_wb_d©a
;

3279 
	mÄ_rd_d©a
, 
	mÄ_rd_node
, 
	mÄ_rd_m‘a
;

3280 
	mÄ_dio_»ad
, 
	mÄ_dio_wr™e
;

3281 
	mio_sk_bggc
, 
	mÙh”_sk_bggc
;

3282 
	mÄ_æushšg
, 
	mÄ_æushed
, 
	mæush_li¡_em±y
;

3283 
	mÄ_disÿrdšg
, 
	mÄ_disÿrded
;

3284 
	mÄ_disÿrd_cmd
;

3285 
	mundisÿrd_blks
;

3286 
	mšlše_x©Œ
, 
	mšlše_šode
, 
	mšlše_dœ
, 
	m­³nd
, 
	mupd©e
, 
	mÜphªs
;

3287 
	maw_út
, 
	mmax_aw_út
, 
	mvw_út
, 
	mmax_vw_út
;

3288 
	mv®id_couÁ
, 
	mv®id_node_couÁ
, 
	mv®id_šode_couÁ
, 
	mdisÿrd_blks
;

3289 
	mbimod®
, 
	mavg_vblocks
;

3290 
	mut_ä“
, 
	mut_v®id
, 
	mut_šv®id
;

3291 
	mrsvd_£gs
, 
	mov”p_£gs
;

3292 
	mdœty_couÁ
, 
	mnode_·ges
, 
	mm‘a_·ges
;

3293 
	m´eä“_couÁ
, 
	mÿÎ_couÁ
, 
	mı_couÁ
, 
	mbg_ı_couÁ
;

3294 
	mtÙ_£gs
, 
	mnode_£gs
, 
	md©a_£gs
, 
	mä“_£gs
, 
	mä“_£cs
;

3295 
	mbg_node_£gs
, 
	mbg_d©a_£gs
;

3296 
	mtÙ_blks
, 
	md©a_blks
, 
	mnode_blks
;

3297 
	mbg_d©a_blks
, 
	mbg_node_blks
;

3298 
	msk³d_©omic_fes
[2];

3299 
	mcur£g
[
NR_CURSEG_TYPE
];

3300 
	mcur£c
[
NR_CURSEG_TYPE
];

3301 
	mcurzÚe
[
NR_CURSEG_TYPE
];

3303 
	mm‘a_couÁ
[
META_MAX
];

3304 
	m£gm’t_couÁ
[2];

3305 
	mblock_couÁ
[2];

3306 
	mš¶aû_couÁ
;

3307 
	mba£_mem
, 
	mÿche_mem
, 
	m·ge_mem
;

3310 
šlše
 
f2fs_¡©_šfo
 *
	$F2FS_STAT
(
f2fs_sb_šfo
 *
sbi
)

3312  (
f2fs_¡©_šfo
 *)
sbi
->
¡©_šfo
;

3313 
	}
}

3315 
	#¡©_šc_ı_couÁ
(
si
è((si)->
ı_couÁ
++)

	)

3316 
	#¡©_šc_bg_ı_couÁ
(
si
è((si)->
bg_ı_couÁ
++)

	)

3317 
	#¡©_šc_ÿÎ_couÁ
(
si
è((si)->
ÿÎ_couÁ
++)

	)

3318 
	#¡©_šc_bggc_couÁ
(
sbi
è((sbi)->
bg_gc
++)

	)

3319 
	#¡©_io_sk_bggc_couÁ
(
sbi
è((sbi)->
io_sk_bggc
++)

	)

3320 
	#¡©_Ùh”_sk_bggc_couÁ
(
sbi
è((sbi)->
Ùh”_sk_bggc
++)

	)

3321 
	#¡©_šc_dœty_šode
(
sbi
, 
ty³
è((sbi)->
ndœty_šode
[ty³]++)

	)

3322 
	#¡©_dec_dœty_šode
(
sbi
, 
ty³
è((sbi)->
ndœty_šode
[ty³]--)

	)

3323 
	#¡©_šc_tÙ®_h™
(
sbi
è(
	`©omic64_šc
(&(sbi)->
tÙ®_h™_ext
))

	)

3324 
	#¡©_šc_rbŒ“_node_h™
(
sbi
è(
	`©omic64_šc
(&(sbi)->
»ad_h™_rbŒ“
))

	)

3325 
	#¡©_šc_Ïrge¡_node_h™
(
sbi
è(
	`©omic64_šc
(&(sbi)->
»ad_h™_Ïrge¡
))

	)

3326 
	#¡©_šc_ÿched_node_h™
(
sbi
è(
	`©omic64_šc
(&(sbi)->
»ad_h™_ÿched
))

	)

3327 
	#¡©_šc_šlše_x©Œ
(
šode
) \

3329 ià(
	`f2fs_has_šlše_x©Œ
(
šode
)) \

3330 (
	`©omic_šc
(&
	`F2FS_I_SB
(
šode
)->
šlše_x©Œ
)); \

3331 } 0)

	)

3332 
	#¡©_dec_šlše_x©Œ
(
šode
) \

3334 ià(
	`f2fs_has_šlše_x©Œ
(
šode
)) \

3335 (
	`©omic_dec
(&
	`F2FS_I_SB
(
šode
)->
šlše_x©Œ
)); \

3336 } 0)

	)

3337 
	#¡©_šc_šlše_šode
(
šode
) \

3339 ià(
	`f2fs_has_šlše_d©a
(
šode
)) \

3340 (
	`©omic_šc
(&
	`F2FS_I_SB
(
šode
)->
šlše_šode
)); \

3341 } 0)

	)

3342 
	#¡©_dec_šlše_šode
(
šode
) \

3344 ià(
	`f2fs_has_šlše_d©a
(
šode
)) \

3345 (
	`©omic_dec
(&
	`F2FS_I_SB
(
šode
)->
šlše_šode
)); \

3346 } 0)

	)

3347 
	#¡©_šc_šlše_dœ
(
šode
) \

3349 ià(
	`f2fs_has_šlše_d’Œy
(
šode
)) \

3350 (
	`©omic_šc
(&
	`F2FS_I_SB
(
šode
)->
šlše_dœ
)); \

3351 } 0)

	)

3352 
	#¡©_dec_šlše_dœ
(
šode
) \

3354 ià(
	`f2fs_has_šlše_d’Œy
(
šode
)) \

3355 (
	`©omic_dec
(&
	`F2FS_I_SB
(
šode
)->
šlše_dœ
)); \

3356 } 0)

	)

3357 
	#¡©_šc_m‘a_couÁ
(
sbi
, 
blkaddr
) \

3359 ià(
blkaddr
 < 
	`SIT_I
(
sbi
)->
s™_ba£_addr
) \

3360 
	`©omic_šc
(&(
sbi
)->
m‘a_couÁ
[
META_CP
]); \

3361 ià(
blkaddr
 < 
	`NM_I
(
sbi
)->
Çt_blkaddr
) \

3362 
	`©omic_šc
(&(
sbi
)->
m‘a_couÁ
[
META_SIT
]); \

3363 ià(
blkaddr
 < 
	`SM_I
(
sbi
)->
s§_blkaddr
) \

3364 
	`©omic_šc
(&(
sbi
)->
m‘a_couÁ
[
META_NAT
]); \

3365 ià(
blkaddr
 < 
	`SM_I
(
sbi
)->
maš_blkaddr
) \

3366 
	`©omic_šc
(&(
sbi
)->
m‘a_couÁ
[
META_SSA
]); \

3367 } 0)

	)

3368 
	#¡©_šc_£g_ty³
(
sbi
, 
cur£g
) \

3369 ((
sbi
)->
£gm’t_couÁ
[(
cur£g
)->
®loc_ty³
]++)

	)

3370 
	#¡©_šc_block_couÁ
(
sbi
, 
cur£g
) \

3371 ((
sbi
)->
block_couÁ
[(
cur£g
)->
®loc_ty³
]++)

	)

3372 
	#¡©_šc_š¶aû_blocks
(
sbi
) \

3373 (
	`©omic_šc
(&(
sbi
)->
š¶aû_couÁ
))

	)

3374 
	#¡©_šc_©omic_wr™e
(
šode
) \

3375 (
	`©omic_šc
(&
	`F2FS_I_SB
(
šode
)->
aw_út
))

	)

3376 
	#¡©_dec_©omic_wr™e
(
šode
) \

3377 (
	`©omic_dec
(&
	`F2FS_I_SB
(
šode
)->
aw_út
))

	)

3378 
	#¡©_upd©e_max_©omic_wr™e
(
šode
) \

3380 
cur
 = 
	`©omic_»ad
(&
	`F2FS_I_SB
(
šode
)->
aw_út
); \

3381 
max
 = 
	`©omic_»ad
(&
	`F2FS_I_SB
(
šode
)->
max_aw_út
); \

3382 ià(
cur
 > 
max
) \

3383 
	`©omic_£t
(&
	`F2FS_I_SB
(
šode
)->
max_aw_út
, 
cur
); \

3384 } 0)

	)

3385 
	#¡©_šc_vŞ©e_wr™e
(
šode
) \

3386 (
	`©omic_šc
(&
	`F2FS_I_SB
(
šode
)->
vw_út
))

	)

3387 
	#¡©_dec_vŞ©e_wr™e
(
šode
) \

3388 (
	`©omic_dec
(&
	`F2FS_I_SB
(
šode
)->
vw_út
))

	)

3389 
	#¡©_upd©e_max_vŞ©e_wr™e
(
šode
) \

3391 
cur
 = 
	`©omic_»ad
(&
	`F2FS_I_SB
(
šode
)->
vw_út
); \

3392 
max
 = 
	`©omic_»ad
(&
	`F2FS_I_SB
(
šode
)->
max_vw_út
); \

3393 ià(
cur
 > 
max
) \

3394 
	`©omic_£t
(&
	`F2FS_I_SB
(
šode
)->
max_vw_út
, 
cur
); \

3395 } 0)

	)

3396 
	#¡©_šc_£g_couÁ
(
sbi
, 
ty³
, 
gc_ty³
) \

3398 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
); \

3399 
si
->
tÙ_£gs
++; \

3400 ià((
ty³
è=ğ
SUM_TYPE_DATA
) { \

3401 
si
->
d©a_£gs
++; \

3402 
si
->
bg_d©a_£gs
 +ğ(
gc_ty³
 =ğ
BG_GC
) ? 1 : 0; \

3404 
si
->
node_£gs
++; \

3405 
si
->
bg_node_£gs
 +ğ(
gc_ty³
 =ğ
BG_GC
) ? 1 : 0; \

3407 } 0)

	)

3409 
	#¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
) \

3410 ((
si
)->
tÙ_blks
 +ğ(
blks
))

	)

3412 
	#¡©_šc_d©a_blk_couÁ
(
sbi
, 
blks
, 
gc_ty³
) \

3414 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
); \

3415 
	`¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
); \

3416 
si
->
d©a_blks
 +ğ(
blks
); \

3417 
si
->
bg_d©a_blks
 +ğ((
gc_ty³
è=ğ
BG_GC
è? (
blks
) : 0; \

3418 } 0)

	)

3420 
	#¡©_šc_node_blk_couÁ
(
sbi
, 
blks
, 
gc_ty³
) \

3422 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
); \

3423 
	`¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
); \

3424 
si
->
node_blks
 +ğ(
blks
); \

3425 
si
->
bg_node_blks
 +ğ((
gc_ty³
è=ğ
BG_GC
è? (
blks
) : 0; \

3426 } 0)

	)

3428 
f2fs_bud_¡©s
(
f2fs_sb_šfo
 *
sbi
);

3429 
f2fs_de¡roy_¡©s
(
f2fs_sb_šfo
 *
sbi
);

3430 
__š™
 
f2fs_ü—‹_roÙ_¡©s
();

3431 
f2fs_de¡roy_roÙ_¡©s
();

3433 
	#¡©_šc_ı_couÁ
(
si
èdØ{ } 0)

	)

3434 
	#¡©_šc_bg_ı_couÁ
(
si
èdØ{ } 0)

	)

3435 
	#¡©_šc_ÿÎ_couÁ
(
si
èdØ{ } 0)

	)

3436 
	#¡©_šc_bggc_couÁ
(
si
èdØ{ } 0)

	)

3437 
	#¡©_io_sk_bggc_couÁ
(
sbi
èdØ{ } 0)

	)

3438 
	#¡©_Ùh”_sk_bggc_couÁ
(
sbi
èdØ{ } 0)

	)

3439 
	#¡©_šc_dœty_šode
(
sbi
, 
ty³
èdØ{ } 0)

	)

3440 
	#¡©_dec_dœty_šode
(
sbi
, 
ty³
èdØ{ } 0)

	)

3441 
	#¡©_šc_tÙ®_h™
(
sb
èdØ{ } 0)

	)

3442 
	#¡©_šc_rbŒ“_node_h™
(
sb
èdØ{ } 0)

	)

3443 
	#¡©_šc_Ïrge¡_node_h™
(
sbi
èdØ{ } 0)

	)

3444 
	#¡©_šc_ÿched_node_h™
(
sbi
èdØ{ } 0)

	)

3445 
	#¡©_šc_šlše_x©Œ
(
šode
èdØ{ } 0)

	)

3446 
	#¡©_dec_šlše_x©Œ
(
šode
èdØ{ } 0)

	)

3447 
	#¡©_šc_šlše_šode
(
šode
èdØ{ } 0)

	)

3448 
	#¡©_dec_šlše_šode
(
šode
èdØ{ } 0)

	)

3449 
	#¡©_šc_šlše_dœ
(
šode
èdØ{ } 0)

	)

3450 
	#¡©_dec_šlše_dœ
(
šode
èdØ{ } 0)

	)

3451 
	#¡©_šc_©omic_wr™e
(
šode
èdØ{ } 0)

	)

3452 
	#¡©_dec_©omic_wr™e
(
šode
èdØ{ } 0)

	)

3453 
	#¡©_upd©e_max_©omic_wr™e
(
šode
èdØ{ } 0)

	)

3454 
	#¡©_šc_vŞ©e_wr™e
(
šode
èdØ{ } 0)

	)

3455 
	#¡©_dec_vŞ©e_wr™e
(
šode
èdØ{ } 0)

	)

3456 
	#¡©_upd©e_max_vŞ©e_wr™e
(
šode
èdØ{ } 0)

	)

3457 
	#¡©_šc_m‘a_couÁ
(
sbi
, 
blkaddr
èdØ{ } 0)

	)

3458 
	#¡©_šc_£g_ty³
(
sbi
, 
cur£g
èdØ{ } 0)

	)

3459 
	#¡©_šc_block_couÁ
(
sbi
, 
cur£g
èdØ{ } 0)

	)

3460 
	#¡©_šc_š¶aû_blocks
(
sbi
èdØ{ } 0)

	)

3461 
	#¡©_šc_£g_couÁ
(
sbi
, 
ty³
, 
gc_ty³
èdØ{ } 0)

	)

3462 
	#¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
èdØ{ } 0)

	)

3463 
	#¡©_šc_d©a_blk_couÁ
(
sbi
, 
blks
, 
gc_ty³
èdØ{ } 0)

	)

3464 
	#¡©_šc_node_blk_couÁ
(
sbi
, 
blks
, 
gc_ty³
èdØ{ } 0)

	)

3466 
šlše
 
	$f2fs_bud_¡©s
(
f2fs_sb_šfo
 *
sbi
è{  0; 
	}
}

3467 
šlše
 
	$f2fs_de¡roy_¡©s
(
f2fs_sb_šfo
 *
sbi
è{ 
	}
}

3468 
šlše
 
__š™
 
	$f2fs_ü—‹_roÙ_¡©s
(è{ 
	}
}

3469 
šlše
 
	$f2fs_de¡roy_roÙ_¡©s
(è{ 
	}
}

3472 cÚ¡ 
fe_İ”©iÚs
 
f2fs_dœ_İ”©iÚs
;

3473 #ifdeà
CONFIG_UNICODE


3474 cÚ¡ 
d’Œy_İ”©iÚs
 
f2fs_d’Œy_İs
;

3476 cÚ¡ 
fe_İ”©iÚs
 
f2fs_fe_İ”©iÚs
;

3477 cÚ¡ 
šode_İ”©iÚs
 
f2fs_fe_šode_İ”©iÚs
;

3478 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
f2fs_dblock_aİs
;

3479 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
f2fs_node_aİs
;

3480 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
f2fs_m‘a_aİs
;

3481 cÚ¡ 
šode_İ”©iÚs
 
f2fs_dœ_šode_İ”©iÚs
;

3482 cÚ¡ 
šode_İ”©iÚs
 
f2fs_symlšk_šode_İ”©iÚs
;

3483 cÚ¡ 
šode_İ”©iÚs
 
f2fs_’üy±ed_symlšk_šode_İ”©iÚs
;

3484 cÚ¡ 
šode_İ”©iÚs
 
f2fs_¥ecŸl_šode_İ”©iÚs
;

3485 
kmem_ÿche
 *
f2fs_šode_’Œy_¦ab
;

3490 
boŞ
 
f2fs_may_šlše_d©a
(
šode
 *inode);

3491 
boŞ
 
f2fs_may_šlše_d’Œy
(
šode
 *inode);

3492 
f2fs_do_»ad_šlše_d©a
(
·ge
 *·ge, ·g*
age
);

3493 
f2fs_Œunÿ‹_šlše_šode
(
šode
 *inode,

3494 
·ge
 *
age
, 
u64
 
äom
);

3495 
f2fs_»ad_šlše_d©a
(
šode
 *šode, 
·ge
 *page);

3496 
f2fs_cÚv”t_šlše_·ge
(
dnode_of_d©a
 *
dn
, 
·ge
 *page);

3497 
f2fs_cÚv”t_šlše_šode
(
šode
 *inode);

3498 
f2fs_wr™e_šlše_d©a
(
šode
 *šode, 
·ge
 *page);

3499 
boŞ
 
f2fs_»cov”_šlše_d©a
(
šode
 *šode, 
·ge
 *
Åage
);

3500 
f2fs_dœ_’Œy
 *
f2fs_fšd_š_šlše_dœ
(
šode
 *
dœ
,

3501 
fsüy±_Çme
 *
âame
, 
·ge
 **
»s_·ge
);

3502 
f2fs_make_em±y_šlše_dœ
(
šode
 *šode, šod*
·»Á
,

3503 
·ge
 *
age
);

3504 
f2fs_add_šlše_’Œy
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Ãw_Çme
,

3505 cÚ¡ 
q¡r
 *
Üig_Çme
,

3506 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
);

3507 
f2fs_d–‘e_šlše_’Œy
(
f2fs_dœ_’Œy
 *
d’Œy
,

3508 
·ge
 *·ge, 
šode
 *
dœ
,

3509 
šode
 *inode);

3510 
boŞ
 
f2fs_em±y_šlše_dœ
(
šode
 *
dœ
);

3511 
f2fs_»ad_šlše_dœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
,

3512 
fsüy±_¡r
 *
f¡r
);

3513 
f2fs_šlše_d©a_f›m­
(
šode
 *inode,

3514 
f›m­_ex‹Á_šfo
 *
f›šfo
,

3515 
__u64
 
¡¬t
, __u64 
Ën
);

3520 
f2fs_shršk_couÁ
(
shršk”
 *
shršk
,

3521 
shršk_cÚŒŞ
 *
sc
);

3522 
f2fs_shršk_sÿn
(
shršk”
 *
shršk
,

3523 
shršk_cÚŒŞ
 *
sc
);

3524 
f2fs_još_shršk”
(
f2fs_sb_šfo
 *
sbi
);

3525 
f2fs_Ëave_shršk”
(
f2fs_sb_šfo
 *
sbi
);

3530 
rb_’Œy
 *
f2fs_lookup_rb_Œ“
(
rb_roÙ_ÿched
 *
roÙ
,

3531 
rb_’Œy
 *
ÿched_»
, 
ofs
);

3532 
rb_node
 **
f2fs_lookup_rb_Œ“_fÜ_š£¹
(
f2fs_sb_šfo
 *
sbi
,

3533 
rb_roÙ_ÿched
 *
roÙ
,

3534 
rb_node
 **
·»Á
,

3535 
ofs
, 
boŞ
 *
Ëámo¡
);

3536 
rb_’Œy
 *
f2fs_lookup_rb_Œ“_»t
(
rb_roÙ_ÿched
 *
roÙ
,

3537 
rb_’Œy
 *
ÿched_»
, 
ofs
,

3538 
rb_’Œy
 **
´ev_’Œy
, rb_’Œy **
Ãxt_’Œy
,

3539 
rb_node
 ***
š£¹_p
, rb_nod**
š£¹_·»Á
,

3540 
boŞ
 
fÜû
, boŞ *
Ëámo¡
);

3541 
boŞ
 
f2fs_check_rb_Œ“_cÚsi¡’û
(
f2fs_sb_šfo
 *
sbi
,

3542 
rb_roÙ_ÿched
 *
roÙ
);

3543 
f2fs_shršk_ex‹Á_Œ“
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
);

3544 
boŞ
 
f2fs_š™_ex‹Á_Œ“
(
šode
 *šode, 
f2fs_ex‹Á
 *
i_ext
);

3545 
f2fs_drİ_ex‹Á_Œ“
(
šode
 *inode);

3546 
f2fs_de¡roy_ex‹Á_node
(
šode
 *inode);

3547 
f2fs_de¡roy_ex‹Á_Œ“
(
šode
 *inode);

3548 
boŞ
 
f2fs_lookup_ex‹Á_ÿche
(
šode
 *šode, 
pgoff_t
 
pgofs
,

3549 
ex‹Á_šfo
 *
ei
);

3550 
f2fs_upd©e_ex‹Á_ÿche
(
dnode_of_d©a
 *
dn
);

3551 
f2fs_upd©e_ex‹Á_ÿche_¿nge
(
dnode_of_d©a
 *
dn
,

3552 
pgoff_t
 
fofs
, 
block_t
 
blkaddr
, 
Ën
);

3553 
f2fs_š™_ex‹Á_ÿche_šfo
(
f2fs_sb_šfo
 *
sbi
);

3554 
__š™
 
f2fs_ü—‹_ex‹Á_ÿche
();

3555 
f2fs_de¡roy_ex‹Á_ÿche
();

3560 
__š™
 
f2fs_š™_sysfs
();

3561 
f2fs_ex™_sysfs
();

3562 
f2fs_»gi¡”_sysfs
(
f2fs_sb_šfo
 *
sbi
);

3563 
f2fs_uÄegi¡”_sysfs
(
f2fs_sb_šfo
 *
sbi
);

3566 cÚ¡ 
fsv”™y_İ”©iÚs
 
f2fs_v”™yİs
;

3571 
šlše
 
boŞ
 
	$f2fs_’üy±ed_fe
(
šode
 *inode)

3573  
	`IS_ENCRYPTED
(
šode
è&& 
	`S_ISREG
(šode->
i_mode
);

3574 
	}
}

3576 
šlše
 
	$f2fs_£t_’üy±ed_šode
(
šode
 *inode)

3578 #ifdeà
CONFIG_FS_ENCRYPTION


3579 
	`fe_£t_’üy±
(
šode
);

3580 
	`f2fs_£t_šode_æags
(
šode
);

3582 
	}
}

3588 
šlše
 
boŞ
 
	$f2fs_po¡_»ad_»quœed
(
šode
 *inode)

3590  
	`f2fs_’üy±ed_fe
(
šode
è|| 
	`fsv”™y_aùive
(inode);

3591 
	}
}

3593 
	#F2FS_FEATURE_FUNCS
(
Çme
, 
æagÇme
) \

3594 
šlše
 
f2fs_sb_has_
##
	`Çme
(
f2fs_sb_šfo
 *
sbi
) \

3596  
	`F2FS_HAS_FEATURE
(
sbi
, 
F2FS_FEATURE_
##
æagÇme
); \

3597 }

	)

3599 
F2FS_FEATURE_FUNCS
(
’üy±
, 
ENCRYPT
);

3600 
F2FS_FEATURE_FUNCS
(
blkzÚed
, 
BLKZONED
);

3601 
F2FS_FEATURE_FUNCS
(
exŒa_©Œ
, 
EXTRA_ATTR
);

3602 
F2FS_FEATURE_FUNCS
(
´ojeù_quÙa
, 
PRJQUOTA
);

3603 
F2FS_FEATURE_FUNCS
(
šode_chksum
, 
INODE_CHKSUM
);

3604 
F2FS_FEATURE_FUNCS
(
æexibË_šlše_x©Œ
, 
FLEXIBLE_INLINE_XATTR
);

3605 
F2FS_FEATURE_FUNCS
(
quÙa_šo
, 
QUOTA_INO
);

3606 
F2FS_FEATURE_FUNCS
(
šode_ütime
, 
INODE_CRTIME
);

3607 
F2FS_FEATURE_FUNCS
(
lo¡_found
, 
LOST_FOUND
);

3608 
F2FS_FEATURE_FUNCS
(
v”™y
, 
VERITY
);

3609 
F2FS_FEATURE_FUNCS
(
sb_chksum
, 
SB_CHKSUM
);

3610 
F2FS_FEATURE_FUNCS
(
ÿ£fŞd
, 
CASEFOLD
);

3612 #ifdeà
CONFIG_BLK_DEV_ZONED


3613 
šlše
 
boŞ
 
	$f2fs_blkz_is_£q
(
f2fs_sb_šfo
 *
sbi
, 
devi
,

3614 
block_t
 
blkaddr
)

3616 
zno
 = 
blkaddr
 >> 
sbi
->
log_blocks_³r_blkz
;

3618  
	`‹¡_b™
(
zno
, 
	`FDEV
(
devi
).
blkz_£q
);

3619 
	}
}

3622 
šlše
 
boŞ
 
	$f2fs_hw_should_disÿrd
(
f2fs_sb_šfo
 *
sbi
)

3624  
	`f2fs_sb_has_blkzÚed
(
sbi
);

3625 
	}
}

3627 
šlše
 
boŞ
 
	$f2fs_bdev_suµÜt_disÿrd
(
block_deviû
 *
bdev
)

3629  
	`blk_queue_disÿrd
(
	`bdev_g‘_queue
(
bdev
)) ||

3630 
	`bdev_is_zÚed
(
bdev
);

3631 
	}
}

3633 
šlše
 
boŞ
 
	$f2fs_hw_suµÜt_disÿrd
(
f2fs_sb_šfo
 *
sbi
)

3635 
i
;

3637 ià(!
	`f2fs_is_muÉi_deviû
(
sbi
))

3638  
	`f2fs_bdev_suµÜt_disÿrd
(
sbi
->
sb
->
s_bdev
);

3640 
i
 = 0; i < 
sbi
->
s_ndevs
; i++)

3641 ià(
	`f2fs_bdev_suµÜt_disÿrd
(
	`FDEV
(
i
).
bdev
))

3642  
Œue
;

3643  
çl£
;

3644 
	}
}

3646 
šlše
 
boŞ
 
	$f2fs_»®time_disÿrd_’abË
(
f2fs_sb_šfo
 *
sbi
)

3648  (
	`‹¡_İt
(
sbi
, 
DISCARD
è&& 
	`f2fs_hw_suµÜt_disÿrd
(sbi)) ||

3649 
	`f2fs_hw_should_disÿrd
(
sbi
);

3650 
	}
}

3652 
šlše
 
boŞ
 
	$f2fs_hw_is_»adÚly
(
f2fs_sb_šfo
 *
sbi
)

3654 
i
;

3656 ià(!
	`f2fs_is_muÉi_deviû
(
sbi
))

3657  
	`bdev_»ad_Úly
(
sbi
->
sb
->
s_bdev
);

3659 
i
 = 0; i < 
sbi
->
s_ndevs
; i++)

3660 ià(
	`bdev_»ad_Úly
(
	`FDEV
(
i
).
bdev
))

3661  
Œue
;

3662  
çl£
;

3663 
	}
}

3666 
šlše
 
	$£t_İt_mode
(
f2fs_sb_šfo
 *
sbi
, 
mt
)

3668 
	`ş—r_İt
(
sbi
, 
ADAPTIVE
);

3669 
	`ş—r_İt
(
sbi
, 
LFS
);

3671 
mt
) {

3672 
F2FS_MOUNT_ADAPTIVE
:

3673 
	`£t_İt
(
sbi
, 
ADAPTIVE
);

3675 
F2FS_MOUNT_LFS
:

3676 
	`£t_İt
(
sbi
, 
LFS
);

3679 
	}
}

3681 
šlše
 
boŞ
 
	$f2fs_may_’üy±
(
šode
 *inode)

3683 #ifdeà
CONFIG_FS_ENCRYPTION


3684 
umode_t
 
mode
 = 
šode
->
i_mode
;

3686  (
	`S_ISREG
(
mode
è|| 
	`S_ISDIR
(modeè|| 
	`S_ISLNK
(mode));

3688  
çl£
;

3690 
	}
}

3692 
šlše
 
	$block_uÇligÃd_IO
(
šode
 *inode,

3693 
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

3695 
i_blkb™s
 = 
	`READ_ONCE
(
šode
->i_blkbits);

3696 
blocksize_mask
 = (1 << 
i_blkb™s
) - 1;

3697 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3698 
®ign
 = 
off£t
 | 
	`iov_™”_®ignm’t
(
™”
);

3700  
®ign
 & 
blocksize_mask
;

3701 
	}
}

3703 
šlše
 
	$®low_ouÏû_dio
(
šode
 *inode,

3704 
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

3706 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

3707 
rw
 = 
	`iov_™”_rw
(
™”
);

3709  (
	`‹¡_İt
(
sbi
, 
LFS
è&& (
rw
 =ğ
WRITE
) &&

3710 !
	`block_uÇligÃd_IO
(
šode
, 
iocb
, 
™”
));

3711 
	}
}

3713 
šlše
 
boŞ
 
	$f2fs_fÜû_bufã»d_io
(
šode
 *inode,

3714 
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

3716 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

3717 
rw
 = 
	`iov_™”_rw
(
™”
);

3719 ià(
	`f2fs_po¡_»ad_»quœed
(
šode
))

3720  
Œue
;

3721 ià(
	`f2fs_is_muÉi_deviû
(
sbi
))

3722  
Œue
;

3727 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
))

3728  
Œue
;

3729 ià(
	`‹¡_İt
(
sbi
, 
LFS
è&& (
rw
 =ğ
WRITE
)) {

3730 ià(
	`block_uÇligÃd_IO
(
šode
, 
iocb
, 
™”
))

3731  
Œue
;

3732 ià(
	`F2FS_IO_ALIGNED
(
sbi
))

3733  
Œue
;

3735 ià(
	`is_sbi_æag_£t
(
	`F2FS_I_SB
(
šode
), 
SBI_CP_DISABLED
) &&

3736 !
	`IS_SWAPFILE
(
šode
))

3737  
Œue
;

3739  
çl£
;

3740 
	}
}

3742 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


3743 
f2fs_bud_çuÉ_©Œ
(
f2fs_sb_šfo
 *
sbi
, 
¿‹
,

3744 
ty³
);

3746 
	#f2fs_bud_çuÉ_©Œ
(
sbi
, 
¿‹
, 
ty³
èdØ{ } 0)

	)

3749 
šlše
 
boŞ
 
	$is_jouº®Ëd_quÙa
(
f2fs_sb_šfo
 *
sbi
)

3751 #ifdeà
CONFIG_QUOTA


3752 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
))

3753  
Œue
;

3754 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
USRQUOTA
] ||

3755 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
GRPQUOTA
] ||

3756 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
PRJQUOTA
])

3757  
Œue
;

3759  
çl£
;

3760 
	}
}

3762 
	#EFSBADCRC
 
EBADMSG


	)

3763 
	#EFSCORRUPTED
 
EUCLEAN


	)

	@f2fs.mod.c

1 
	~<lšux/bud-§É.h
>

2 
	~<lšux/moduË.h
>

3 
	~<lšux/v”magic.h
>

4 
	~<lšux/comp”.h
>

6 
	gBUILD_SALT
;

8 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

9 
MODULE_INFO
(
Çme
, 
KBUILD_MODNAME
);

11 
__visibË
 
moduË
 
__this_moduË


12 
__£ùiÚ
(.
gnu
.
lškÚû
.
this_moduË
) = {

13 .
Çme
 = 
KBUILD_MODNAME
,

14 .
	gš™
 = 
š™_moduË
,

15 #ifdeà
CONFIG_MODULE_UNLOAD


16 .
	gex™
 = 
ş—nup_moduË
,

18 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

21 
MODULE_INFO
(
šŒ“
, "Y");

23 #ifdeà
CONFIG_RETPOLINE


24 
MODULE_INFO
(
»Şše
, "Y");

27 
MODULE_INFO
(
d•’ds
, "");

30 
MODULE_INFO
(
¤cv”siÚ
, "A4402246DA945E28D66EAA0");

	@file.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/f2fs_fs.h
>

10 
	~<lšux/¡©.h
>

11 
	~<lšux/bufãr_h—d.h
>

12 
	~<lšux/wr™eback.h
>

13 
	~<lšux/blkdev.h
>

14 
	~<lšux/çÎoc.h
>

15 
	~<lšux/ty³s.h
>

16 
	~<lšux/com·t.h
>

17 
	~<lšux/uacûss.h
>

18 
	~<lšux/mouÁ.h
>

19 
	~<lšux/·gevec.h
>

20 
	~<lšux/uio.h
>

21 
	~<lšux/uuid.h
>

22 
	~<lšux/fe.h
>

23 
	~<lšux/Æs.h
>

25 
	~"f2fs.h
"

26 
	~"node.h
"

27 
	~"£gm’t.h
"

28 
	~"x©Œ.h
"

29 
	~"aş.h
"

30 
	~"gc.h
"

31 
	~"Œaû.h
"

32 
	~<Œaû/ev’ts/f2fs.h
>

34 
vm_çuÉ_t
 
	$f2fs_fem­_çuÉ
(
vm_çuÉ
 *
vmf
)

36 
šode
 *šodğ
	`fe_šode
(
vmf
->
vma
->
vm_fe
);

37 
vm_çuÉ_t
 
»t
;

39 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

40 
»t
 = 
	`fem­_çuÉ
(
vmf
);

41 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

43 
	`Œaû_f2fs_fem­_çuÉ
(
šode
, 
vmf
->
pgoff
, ()
»t
);

45  
»t
;

46 
	}
}

48 
vm_çuÉ_t
 
	$f2fs_vm_·ge_mkwr™e
(
vm_çuÉ
 *
vmf
)

50 
·ge
 *·gğ
vmf
->page;

51 
šode
 *šodğ
	`fe_šode
(
vmf
->
vma
->
vm_fe
);

52 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

53 
dnode_of_d©a
 
dn
 = { .
node_chªged
 = 
çl£
 };

54 
”r
;

56 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

57 
”r
 = -
EIO
;

58 
”r
;

61 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
)) {

62 
”r
 = -
ENOSPC
;

63 
”r
;

66 
	`sb_¡¬t_·geçuÉ
(
šode
->
i_sb
);

68 
	`f2fs_bug_Ú
(
sbi
, 
	`f2fs_has_šlše_d©a
(
šode
));

70 
	`fe_upd©e_time
(
vmf
->
vma
->
vm_fe
);

71 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

72 
	`lock_·ge
(
·ge
);

73 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
 ||

74 
	`·ge_off£t
(
·ge
è> 
	`i_size_»ad
(
šode
) ||

75 !
	`PageU±od©e
(
·ge
))) {

76 
	`uÆock_·ge
(
·ge
);

77 
”r
 = -
EFAULT
;

78 
out_£m
;

82 
	`__do_m­_lock
(
sbi
, 
F2FS_GET_BLOCK_PRE_AIO
, 
Œue
);

83 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

84 
”r
 = 
	`f2fs_g‘_block
(&
dn
, 
·ge
->
šdex
);

85 
	`f2fs_put_dnode
(&
dn
);

86 
	`__do_m­_lock
(
sbi
, 
F2FS_GET_BLOCK_PRE_AIO
, 
çl£
);

87 ià(
”r
) {

88 
	`uÆock_·ge
(
·ge
);

89 
out_£m
;

93 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
çl£
, 
Œue
);

96 
	`f2fs_wa™_Ú_block_wr™eback
(
šode
, 
dn
.
d©a_blkaddr
);

101 ià(
	`PageM­³dToDisk
(
·ge
))

102 
out_£m
;

105 ià(((
loff_t
)(
·ge
->
šdex
 + 1è<< 
PAGE_SHIFT
) >

106 
	`i_size_»ad
(
šode
)) {

107 
loff_t
 
off£t
;

109 
off£t
 = 
	`i_size_»ad
(
šode
è& ~
PAGE_MASK
;

110 
	`z”o_u£r_£gm’t
(
·ge
, 
off£t
, 
PAGE_SIZE
);

112 
	`£t_·ge_dœty
(
·ge
);

113 ià(!
	`PageU±od©e
(
·ge
))

114 
	`S‘PageU±od©e
(
·ge
);

116 
	`f2fs_upd©e_io¡©
(
sbi
, 
APP_MAPPED_IO
, 
F2FS_BLKSIZE
);

117 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

119 
	`Œaû_f2fs_vm_·ge_mkwr™e
(
·ge
, 
DATA
);

120 
out_£m
:

121 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

123 
	`f2fs_b®ªû_fs
(
sbi
, 
dn
.
node_chªged
);

125 
	`sb_’d_·geçuÉ
(
šode
->
i_sb
);

126 
”r
:

127  
	`block_·ge_mkwr™e_»tuº
(
”r
);

128 
	}
}

130 cÚ¡ 
vm_İ”©iÚs_¡ruù
 
	gf2fs_fe_vm_İs
 = {

131 .
çuÉ
 = 
f2fs_fem­_çuÉ
,

132 .
	gm­_·ges
 = 
fem­_m­_·ges
,

133 .
	g·ge_mkwr™e
 = 
f2fs_vm_·ge_mkwr™e
,

136 
	$g‘_·»Á_šo
(
šode
 *šode, 
nid_t
 *
pšo
)

138 
d’Œy
 *dentry;

140 
šode
 = 
	`ig¿b
(inode);

141 
d’Œy
 = 
	`d_fšd_ªy_®Ÿs
(
šode
);

142 
	`ut
(
šode
);

143 ià(!
d’Œy
)

146 *
pšo
 = 
	`·»Á_šo
(
d’Œy
);

147 
	`dput
(
d’Œy
);

149 
	}
}

151 
šlše
 
ı_»asÚ_ty³
 
	$Ãed_do_checkpošt
(
šode
 *inode)

153 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

154 
ı_»asÚ_ty³
 
ı_»asÚ
 = 
CP_NO_NEEDED
;

156 ià(!
	`S_ISREG
(
šode
->
i_mode
))

157 
ı_»asÚ
 = 
CP_NON_REGULAR
;

158 ià(
šode
->
i_Æšk
 != 1)

159 
ı_»asÚ
 = 
CP_HARDLINK
;

160 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_CP
))

161 
ı_»asÚ
 = 
CP_SB_NEED_CP
;

162 ià(
	`fe_wrÚg_pšo
(
šode
))

163 
ı_»asÚ
 = 
CP_WRONG_PINO
;

164 ià(!
	`f2fs_¥aû_fÜ_rŞl_fÜw¬d
(
sbi
))

165 
ı_»asÚ
 = 
CP_NO_SPC_ROLL
;

166 ià(!
	`f2fs_is_checkpoš‹d_node
(
sbi
, 
	`F2FS_I
(
šode
)->
i_pšo
))

167 
ı_»asÚ
 = 
CP_NODE_NEED_CP
;

168 ià(
	`‹¡_İt
(
sbi
, 
FASTBOOT
))

169 
ı_»asÚ
 = 
CP_FASTBOOT_MODE
;

170 ià(
	`F2FS_OPTION
(
sbi
).
aùive_logs
 == 2)

171 
ı_»asÚ
 = 
CP_SPEC_LOG_NUM
;

172 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_STRICT
 &&

173 
	`f2fs_Ãed_d’Œy_m¬k
(
sbi
, 
šode
->
i_šo
) &&

174 
	`f2fs_exi¡_wr™‹n_d©a
(
sbi
, 
	`F2FS_I
(
šode
)->
i_pšo
,

175 
TRANS_DIR_INO
))

176 
ı_»asÚ
 = 
CP_RECOVER_DIR
;

178  
ı_»asÚ
;

179 
	}
}

181 
boŞ
 
	$Ãed_šode_·ge_upd©e
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

183 
·ge
 *
i
 = 
	`fšd_g‘_·ge
(
	`NODE_MAPPING
(
sbi
), 
šo
);

184 
boŞ
 
»t
 = 
çl£
;

186 ià((
i
 && 
	`PageDœty
(i)è|| 
	`f2fs_Ãed_šode_block_upd©e
(
sbi
, 
šo
))

187 
»t
 = 
Œue
;

188 
	`f2fs_put_·ge
(
i
, 0);

189  
»t
;

190 
	}
}

192 
	$Œy_to_fix_pšo
(
šode
 *inode)

194 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

195 
nid_t
 
pšo
;

197 
	`down_wr™e
(&
fi
->
i_£m
);

198 ià(
	`fe_wrÚg_pšo
(
šode
è&& inode->
i_Æšk
 == 1 &&

199 
	`g‘_·»Á_šo
(
šode
, &
pšo
)) {

200 
	`f2fs_i_pšo_wr™e
(
šode
, 
pšo
);

201 
	`fe_gÙ_pšo
(
šode
);

203 
	`up_wr™e
(&
fi
->
i_£m
);

204 
	}
}

206 
	$f2fs_do_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
,

207 
d©async
, 
boŞ
 
©omic
)

209 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

210 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

211 
nid_t
 
šo
 = 
šode
->
i_šo
;

212 
»t
 = 0;

213 
ı_»asÚ_ty³
 
ı_»asÚ
 = 0;

214 
wr™eback_cÚŒŞ
 
wbc
 = {

215 .
sync_mode
 = 
WB_SYNC_ALL
,

216 .
Ä_to_wr™e
 = 
LONG_MAX
,

217 .
fÜ_»şaim
 = 0,

219 
£q_id
 = 0;

221 ià(
	`uÆik–y
(
	`f2fs_»adÚly
(
šode
->
i_sb
) ||

222 
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)))

225 
	`Œaû_f2fs_sync_fe_’‹r
(
šode
);

227 ià(
	`S_ISDIR
(
šode
->
i_mode
))

228 
go_wr™e
;

231 ià(
d©async
 || 
	`g‘_dœty_·ges
(
šode
è<ğ
	`SM_I
(
sbi
)->
mš_fsync_blocks
)

232 
	`£t_šode_æag
(
šode
, 
FI_NEED_IPU
);

233 
»t
 = 
	`fe_wr™e_ªd_wa™_¿nge
(
fe
, 
¡¬t
, 
’d
);

234 
	`ş—r_šode_æag
(
šode
, 
FI_NEED_IPU
);

236 ià(
»t
) {

237 
	`Œaû_f2fs_sync_fe_ex™
(
šode
, 
ı_»asÚ
, 
d©async
, 
»t
);

238  
»t
;

242 ià(!
	`f2fs_sk_šode_upd©e
(
šode
, 
d©async
)) {

243 
	`f2fs_wr™e_šode
(
šode
, 
NULL
);

244 
go_wr™e
;

250 ià(!
	`is_šode_æag_£t
(
šode
, 
FI_APPEND_WRITE
) &&

251 !
	`f2fs_exi¡_wr™‹n_d©a
(
sbi
, 
šo
, 
APPEND_INO
)) {

254 ià(
	`Ãed_šode_·ge_upd©e
(
sbi
, 
šo
))

255 
go_wr™e
;

257 ià(
	`is_šode_æag_£t
(
šode
, 
FI_UPDATE_WRITE
) ||

258 
	`f2fs_exi¡_wr™‹n_d©a
(
sbi
, 
šo
, 
UPDATE_INO
))

259 
æush_out
;

260 
out
;

262 
go_wr™e
:

267 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_£m
);

268 
ı_»asÚ
 = 
	`Ãed_do_checkpošt
(
šode
);

269 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_£m
);

271 ià(
ı_»asÚ
) {

273 
»t
 = 
	`f2fs_sync_fs
(
šode
->
i_sb
, 1);

279 
	`Œy_to_fix_pšo
(
šode
);

280 
	`ş—r_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

281 
	`ş—r_šode_æag
(
šode
, 
FI_UPDATE_WRITE
);

282 
out
;

284 
sync_nodes
:

285 
	`©omic_šc
(&
sbi
->
wb_sync_»q
[
NODE
]);

286 
»t
 = 
	`f2fs_fsync_node_·ges
(
sbi
, 
šode
, &
wbc
, 
©omic
, &
£q_id
);

287 
	`©omic_dec
(&
sbi
->
wb_sync_»q
[
NODE
]);

288 ià(
»t
)

289 
out
;

292 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

293 
»t
 = -
EIO
;

294 
out
;

297 ià(
	`f2fs_Ãed_šode_block_upd©e
(
sbi
, 
šo
)) {

298 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

299 
	`f2fs_wr™e_šode
(
šode
, 
NULL
);

300 
sync_nodes
;

311 ià(!
©omic
) {

312 
»t
 = 
	`f2fs_wa™_Ú_node_·ges_wr™eback
(
sbi
, 
£q_id
);

313 ià(
»t
)

314 
out
;

318 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šo
, 
APPEND_INO
);

319 
	`ş—r_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

320 
æush_out
:

321 ià(!
©omic
 && 
	`F2FS_OPTION
(
sbi
).
fsync_mode
 !ğ
FSYNC_MODE_NOBARRIER
)

322 
»t
 = 
	`f2fs_issue_æush
(
sbi
, 
šode
->
i_šo
);

323 ià(!
»t
) {

324 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šo
, 
UPDATE_INO
);

325 
	`ş—r_šode_æag
(
šode
, 
FI_UPDATE_WRITE
);

326 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šo
, 
FLUSH_INO
);

328 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

329 
out
:

330 
	`Œaû_f2fs_sync_fe_ex™
(
šode
, 
ı_»asÚ
, 
d©async
, 
»t
);

331 
	`f2fs_Œaû_ios
(
NULL
, 1);

332  
»t
;

333 
	}
}

335 
	$f2fs_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
)

337 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
	`fe_šode
(
fe
)))))

338  -
EIO
;

339  
	`f2fs_do_sync_fe
(
fe
, 
¡¬t
, 
’d
, 
d©async
, 
çl£
);

340 
	}
}

342 
pgoff_t
 
	$__g‘_fœ¡_dœty_šdex
(
add»ss_¥aû
 *
m­pšg
,

343 
pgoff_t
 
pgofs
, 
wh’û
)

345 
·ge
 *page;

346 
Ä_·ges
;

348 ià(
wh’û
 !ğ
SEEK_DATA
)

352 
Ä_·ges
 = 
	`fšd_g‘_·ges_g
(
m­pšg
, &
pgofs
, 
PAGECACHE_TAG_DIRTY
,

353 1, &
·ge
);

354 ià(!
Ä_·ges
)

355  
ULONG_MAX
;

356 
pgofs
 = 
·ge
->
šdex
;

357 
	`put_·ge
(
·ge
);

358  
pgofs
;

359 
	}
}

361 
boŞ
 
	$__found_off£t
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
,

362 
pgoff_t
 
dœty
,…goff_ˆ
pgofs
, 
wh’û
)

364 
wh’û
) {

365 
SEEK_DATA
:

366 ià((
blkaddr
 =ğ
NEW_ADDR
 && 
dœty
 =ğ
pgofs
) ||

367 
	`__is_v®id_d©a_blkaddr
(
blkaddr
))

368  
Œue
;

370 
SEEK_HOLE
:

371 ià(
blkaddr
 =ğ
NULL_ADDR
)

372  
Œue
;

375  
çl£
;

376 
	}
}

378 
loff_t
 
	$f2fs_£ek_block
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

380 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

381 
loff_t
 
maxby‹s
 = 
šode
->
i_sb
->
s_maxby‹s
;

382 
dnode_of_d©a
 
dn
;

383 
pgoff_t
 
pgofs
, 
’d_off£t
, 
dœty
;

384 
loff_t
 
d©a_ofs
 = 
off£t
;

385 
loff_t
 
isize
;

386 
”r
 = 0;

388 
	`šode_lock
(
šode
);

390 
isize
 = 
	`i_size_»ad
(
šode
);

391 ià(
off£t
 >ğ
isize
)

392 
ç
;

395 ià(
	`f2fs_has_šlše_d©a
(
šode
è|| 
	`f2fs_has_šlše_d’Œy
(inode)) {

396 ià(
wh’û
 =ğ
SEEK_HOLE
)

397 
d©a_ofs
 = 
isize
;

398 
found
;

401 
pgofs
 = (
pgoff_t
)(
off£t
 >> 
PAGE_SHIFT
);

403 
dœty
 = 
	`__g‘_fœ¡_dœty_šdex
(
šode
->
i_m­pšg
, 
pgofs
, 
wh’û
);

405 ; 
d©a_ofs
 < 
isize
; d©a_of ğ(
loff_t
)
pgofs
 << 
PAGE_SHIFT
) {

406 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

407 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
pgofs
, 
LOOKUP_NODE
);

408 ià(
”r
 &&ƒ¼ !ğ-
ENOENT
) {

409 
ç
;

410 } ià(
”r
 =ğ-
ENOENT
) {

412 ià(
wh’û
 =ğ
SEEK_DATA
) {

413 
pgofs
 = 
	`f2fs_g‘_Ãxt_·ge_off£t
(&
dn
,…gofs);

416 
found
;

420 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
);

423 ; 
dn
.
ofs_š_node
 < 
’d_off£t
;

424 
dn
.
ofs_š_node
++, 
pgofs
++,

425 
d©a_ofs
 = (
loff_t
)
pgofs
 << 
PAGE_SHIFT
) {

426 
block_t
 
blkaddr
;

428 
blkaddr
 = 
	`d©ablock_addr
(
dn
.
šode
,

429 
dn
.
node_·ge
, dn.
ofs_š_node
);

431 ià(
	`__is_v®id_d©a_blkaddr
(
blkaddr
) &&

432 !
	`f2fs_is_v®id_blkaddr
(
	`F2FS_I_SB
(
šode
),

433 
blkaddr
, 
DATA_GENERIC_ENHANCE
)) {

434 
	`f2fs_put_dnode
(&
dn
);

435 
ç
;

438 ià(
	`__found_off£t
(
	`F2FS_I_SB
(
šode
), 
blkaddr
, 
dœty
,

439 
pgofs
, 
wh’û
)) {

440 
	`f2fs_put_dnode
(&
dn
);

441 
found
;

444 
	`f2fs_put_dnode
(&
dn
);

447 ià(
wh’û
 =ğ
SEEK_DATA
)

448 
ç
;

449 
found
:

450 ià(
wh’û
 =ğ
SEEK_HOLE
 && 
d©a_ofs
 > 
isize
)

451 
d©a_ofs
 = 
isize
;

452 
	`šode_uÆock
(
šode
);

453  
	`vfs_£os
(
fe
, 
d©a_ofs
, 
maxby‹s
);

454 
ç
:

455 
	`šode_uÆock
(
šode
);

456  -
ENXIO
;

457 
	}
}

459 
loff_t
 
	$f2fs_Î£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

461 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

462 
loff_t
 
maxby‹s
 = 
šode
->
i_sb
->
s_maxby‹s
;

464 
wh’û
) {

465 
SEEK_SET
:

466 
SEEK_CUR
:

467 
SEEK_END
:

468  
	`g’”ic_fe_Î£ek_size
(
fe
, 
off£t
, 
wh’û
,

469 
maxby‹s
, 
	`i_size_»ad
(
šode
));

470 
SEEK_DATA
:

471 
SEEK_HOLE
:

472 ià(
off£t
 < 0)

473  -
ENXIO
;

474  
	`f2fs_£ek_block
(
fe
, 
off£t
, 
wh’û
);

477  -
EINVAL
;

478 
	}
}

480 
	$f2fs_fe_mm­
(
fe
 *fe, 
vm_¬—_¡ruù
 *
vma
)

482 
šode
 *šodğ
	`fe_šode
(
fe
);

483 
”r
;

485 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

486  -
EIO
;

489 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

490 ià(
”r
)

491  
”r
;

493 
	`fe_acûs£d
(
fe
);

494 
vma
->
vm_İs
 = &
f2fs_fe_vm_İs
;

496 
	}
}

498 
	$f2fs_fe_İ’
(
šode
 *šode, 
fe
 *
fp
)

500 
”r
 = 
	`fsüy±_fe_İ’
(
šode
, 
fp
);

502 ià(
”r
)

503  
”r
;

505 
”r
 = 
	`fsv”™y_fe_İ’
(
šode
, 
fp
);

506 ià(
”r
)

507  
”r
;

509 
fp
->
f_mode
 |ğ
FMODE_NOWAIT
;

511  
	`dquÙ_fe_İ’
(
šode
, 
fp
);

512 
	}
}

514 
	$f2fs_Œunÿ‹_d©a_blocks_¿nge
(
dnode_of_d©a
 *
dn
, 
couÁ
)

516 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

517 
f2fs_node
 *
¿w_node
;

518 
Ä_ä“
 = 0, 
ofs
 = 
dn
->
ofs_š_node
, 
Ën
 = 
couÁ
;

519 
__Ë32
 *
addr
;

520 
ba£
 = 0;

522 ià(
	`IS_INODE
(
dn
->
node_·ge
è&& 
	`f2fs_has_exŒa_©Œ
(dn->
šode
))

523 
ba£
 = 
	`g‘_exŒa_isize
(
dn
->
šode
);

525 
¿w_node
 = 
	`F2FS_NODE
(
dn
->
node_·ge
);

526 
addr
 = 
	`blkaddr_š_node
(
¿w_node
è+ 
ba£
 + 
ofs
;

528 ; 
couÁ
 > 0; couÁ--, 
addr
++, 
dn
->
ofs_š_node
++) {

529 
block_t
 
blkaddr
 = 
	`Ë32_to_ıu
(*
addr
);

531 ià(
blkaddr
 =ğ
NULL_ADDR
)

534 
dn
->
d©a_blkaddr
 = 
NULL_ADDR
;

535 
	`f2fs_£t_d©a_blkaddr
(
dn
);

537 ià(
	`__is_v®id_d©a_blkaddr
(
blkaddr
) &&

538 !
	`f2fs_is_v®id_blkaddr
(
sbi
, 
blkaddr
,

539 
DATA_GENERIC_ENHANCE
))

542 
	`f2fs_šv®id©e_blocks
(
sbi
, 
blkaddr
);

543 ià(
dn
->
ofs_š_node
 =ğ0 && 
	`IS_INODE
(dn->
node_·ge
))

544 
	`ş—r_šode_æag
(
dn
->
šode
, 
FI_FIRST_BLOCK_WRITTEN
);

545 
Ä_ä“
++;

548 ià(
Ä_ä“
) {

549 
pgoff_t
 
fofs
;

554 
fofs
 = 
	`f2fs_¡¬t_bidx_of_node
(
	`ofs_of_node
(
dn
->
node_·ge
),

555 
dn
->
šode
è+ 
ofs
;

556 
	`f2fs_upd©e_ex‹Á_ÿche_¿nge
(
dn
, 
fofs
, 0, 
Ën
);

557 
	`dec_v®id_block_couÁ
(
sbi
, 
dn
->
šode
, 
Ä_ä“
);

559 
dn
->
ofs_š_node
 = 
ofs
;

561 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

562 
	`Œaû_f2fs_Œunÿ‹_d©a_blocks_¿nge
(
dn
->
šode
, dn->
nid
,

563 
dn
->
ofs_š_node
, 
Ä_ä“
);

564 
	}
}

566 
	$f2fs_Œunÿ‹_d©a_blocks
(
dnode_of_d©a
 *
dn
)

568 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(
dn
, 
	`ADDRS_PER_BLOCK
(dn->
šode
));

569 
	}
}

571 
	$Œunÿ‹_·¹Ÿl_d©a_·ge
(
šode
 *šode, 
u64
 
äom
,

572 
boŞ
 
ÿche_Úly
)

574 
loff_t
 
off£t
 = 
äom
 & (
PAGE_SIZE
 - 1);

575 
pgoff_t
 
šdex
 = 
äom
 >> 
PAGE_SHIFT
;

576 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

577 
·ge
 *page;

579 ià(!
off£t
 && !
ÿche_Úly
)

582 ià(
ÿche_Úly
) {

583 
·ge
 = 
	`fšd_lock_·ge
(
m­pšg
, 
šdex
);

584 ià(
·ge
 && 
	`PageU±od©e
(page))

585 
Œunÿ‹_out
;

586 
	`f2fs_put_·ge
(
·ge
, 1);

590 
·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
šode
, 
šdex
, 
Œue
);

591 ià(
	`IS_ERR
(
·ge
))

592  
	`PTR_ERR
(
·ge
è=ğ-
ENOENT
 ? 0 : PTR_ERR(page);

593 
Œunÿ‹_out
:

594 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
,rue);

595 
	`z”o_u£r
(
·ge
, 
off£t
, 
PAGE_SIZE
 - offset);

598 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
ÿche_Úly
 && 
	`IS_ENCRYPTED
(inode));

599 ià(!
ÿche_Úly
)

600 
	`£t_·ge_dœty
(
·ge
);

601 
	`f2fs_put_·ge
(
·ge
, 1);

603 
	}
}

605 
	$f2fs_Œunÿ‹_blocks
(
šode
 *šode, 
u64
 
äom
, 
boŞ
 
lock
)

607 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

608 
dnode_of_d©a
 
dn
;

609 
pgoff_t
 
ä“_äom
;

610 
couÁ
 = 0, 
”r
 = 0;

611 
·ge
 *
age
;

612 
boŞ
 
Œunÿ‹_·ge
 = 
çl£
;

614 
	`Œaû_f2fs_Œunÿ‹_blocks_’‹r
(
šode
, 
äom
);

616 
ä“_äom
 = (
pgoff_t
)
	`F2FS_BLK_ALIGN
(
äom
);

618 ià(
ä“_äom
 >ğ
sbi
->
max_fe_blocks
)

619 
ä“_·¹Ÿl
;

621 ià(
lock
)

622 
	`f2fs_lock_İ
(
sbi
);

624 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

625 ià(
	`IS_ERR
(
age
)) {

626 
”r
 = 
	`PTR_ERR
(
age
);

627 
out
;

630 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

631 
	`f2fs_Œunÿ‹_šlše_šode
(
šode
, 
age
, 
äom
);

632 
	`f2fs_put_·ge
(
age
, 1);

633 
Œunÿ‹_·ge
 = 
Œue
;

634 
out
;

637 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
age
, 
NULL
, 0);

638 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
ä“_äom
, 
LOOKUP_NODE_RA
);

639 ià(
”r
) {

640 ià(
”r
 =ğ-
ENOENT
)

641 
ä“_Ãxt
;

642 
out
;

645 
couÁ
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
);

647 
couÁ
 -ğ
dn
.
ofs_š_node
;

648 
	`f2fs_bug_Ú
(
sbi
, 
couÁ
 < 0);

650 ià(
dn
.
ofs_š_node
 || 
	`IS_INODE
(dn.
node_·ge
)) {

651 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 
couÁ
);

652 
ä“_äom
 +ğ
couÁ
;

655 
	`f2fs_put_dnode
(&
dn
);

656 
ä“_Ãxt
:

657 
”r
 = 
	`f2fs_Œunÿ‹_šode_blocks
(
šode
, 
ä“_äom
);

658 
out
:

659 ià(
lock
)

660 
	`f2fs_uÆock_İ
(
sbi
);

661 
ä“_·¹Ÿl
:

663 ià(!
”r
)

664 
”r
 = 
	`Œunÿ‹_·¹Ÿl_d©a_·ge
(
šode
, 
äom
, 
Œunÿ‹_·ge
);

666 
	`Œaû_f2fs_Œunÿ‹_blocks_ex™
(
šode
, 
”r
);

667  
”r
;

668 
	}
}

670 
	$f2fs_Œunÿ‹
(
šode
 *inode)

672 
”r
;

674 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

675  -
EIO
;

677 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

678 
	`S_ISLNK
(
šode
->
i_mode
)))

681 
	`Œaû_f2fs_Œunÿ‹
(
šode
);

683 ià(
	`time_to_šjeù
(
	`F2FS_I_SB
(
šode
), 
FAULT_TRUNCATE
)) {

684 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_TRUNCATE
);

685  -
EIO
;

689 ià(!
	`f2fs_may_šlše_d©a
(
šode
)) {

690 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

691 ià(
”r
)

692  
”r
;

695 
”r
 = 
	`f2fs_Œunÿ‹_blocks
(
šode
, 
	`i_size_»ad
(šode), 
Œue
);

696 ià(
”r
)

697  
”r
;

699 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

700 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

702 
	}
}

704 
	$f2fs_g‘©Œ
(cÚ¡ 
·th
 *·th, 
k¡©
 *
¡©
,

705 
u32
 
»que¡_mask
, 
qu”y_æags
)

707 
šode
 *šodğ
	`d_šode
(
·th
->
d’Œy
);

708 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

709 
f2fs_šode
 *
ri
;

710 
æags
;

712 ià(
	`f2fs_has_exŒa_©Œ
(
šode
) &&

713 
	`f2fs_sb_has_šode_ütime
(
	`F2FS_I_SB
(
šode
)) &&

714 
	`F2FS_FITS_IN_INODE
(
ri
, 
fi
->
i_exŒa_isize
, 
i_ütime
)) {

715 
¡©
->
»suÉ_mask
 |ğ
STATX_BTIME
;

716 
¡©
->
btime
.
tv_£c
 = 
fi
->
i_ütime
.tv_sec;

717 
¡©
->
btime
.
tv_n£c
 = 
fi
->
i_ütime
.tv_nsec;

720 
æags
 = 
fi
->
i_æags
;

721 ià(
æags
 & 
F2FS_APPEND_FL
)

722 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_APPEND
;

723 ià(
	`IS_ENCRYPTED
(
šode
))

724 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_ENCRYPTED
;

725 ià(
æags
 & 
F2FS_IMMUTABLE_FL
)

726 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_IMMUTABLE
;

727 ià(
æags
 & 
F2FS_NODUMP_FL
)

728 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_NODUMP
;

730 
¡©
->
©Œibu‹s_mask
 |ğ(
STATX_ATTR_APPEND
 |

731 
STATX_ATTR_ENCRYPTED
 |

732 
STATX_ATTR_IMMUTABLE
 |

733 
STATX_ATTR_NODUMP
);

735 
	`g’”ic_fÏ‰r
(
šode
, 
¡©
);

738 ià((
	`S_ISREG
(
šode
->
i_mode
è&& 
	`f2fs_has_šlše_d©a
(inode)) ||

739 
	`f2fs_has_šlše_d’Œy
(
šode
))

740 
¡©
->
blocks
 +ğ(¡©->
size
 + 511) >> 9;

743 
	}
}

745 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


746 
	$__£‰r_cİy
(
šode
 *šode, cÚ¡ 
Ÿ‰r
 *
©Œ
)

748 
Ÿ_v®id
 = 
©Œ
->ia_valid;

750 ià(
Ÿ_v®id
 & 
ATTR_UID
)

751 
šode
->
i_uid
 = 
©Œ
->
Ÿ_uid
;

752 ià(
Ÿ_v®id
 & 
ATTR_GID
)

753 
šode
->
i_gid
 = 
©Œ
->
Ÿ_gid
;

754 ià(
Ÿ_v®id
 & 
ATTR_ATIME
)

755 
šode
->
i_©ime
 = 
©Œ
->
Ÿ_©ime
;

756 ià(
Ÿ_v®id
 & 
ATTR_MTIME
)

757 
šode
->
i_mtime
 = 
©Œ
->
Ÿ_mtime
;

758 ià(
Ÿ_v®id
 & 
ATTR_CTIME
)

759 
šode
->
i_ùime
 = 
©Œ
->
Ÿ_ùime
;

760 ià(
Ÿ_v®id
 & 
ATTR_MODE
) {

761 
umode_t
 
mode
 = 
©Œ
->
Ÿ_mode
;

763 ià(!
	`š_group_p
(
šode
->
i_gid
è&& !
	`ÿ·bË
(
CAP_FSETID
))

764 
mode
 &ğ~
S_ISGID
;

765 
	`£t_aş_šode
(
šode
, 
mode
);

767 
	}
}

769 
	#__£‰r_cİy
 
£‰r_cİy


	)

772 
	$f2fs_£‰r
(
d’Œy
 *d’Œy, 
Ÿ‰r
 *
©Œ
)

774 
šode
 *šodğ
	`d_šode
(
d’Œy
);

775 
”r
;

777 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

778  -
EIO
;

780 
”r
 = 
	`£‰r_´•¬e
(
d’Œy
, 
©Œ
);

781 ià(
”r
)

782  
”r
;

784 
”r
 = 
	`fsüy±_´•¬e_£‰r
(
d’Œy
, 
©Œ
);

785 ià(
”r
)

786  
”r
;

788 
”r
 = 
	`fsv”™y_´•¬e_£‰r
(
d’Œy
, 
©Œ
);

789 ià(
”r
)

790  
”r
;

792 ià(
	`is_quÙa_modifiÿtiÚ
(
šode
, 
©Œ
)) {

793 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

794 ià(
”r
)

795  
”r
;

797 ià((
©Œ
->
Ÿ_v®id
 & 
ATTR_UID
 &&

798 !
	`uid_eq
(
©Œ
->
Ÿ_uid
, 
šode
->
i_uid
)) ||

799 (
©Œ
->
Ÿ_v®id
 & 
ATTR_GID
 &&

800 !
	`gid_eq
(
©Œ
->
Ÿ_gid
, 
šode
->
i_gid
))) {

801 
	`f2fs_lock_İ
(
	`F2FS_I_SB
(
šode
));

802 
”r
 = 
	`dquÙ_Œªsãr
(
šode
, 
©Œ
);

803 ià(
”r
) {

804 
	`£t_sbi_æag
(
	`F2FS_I_SB
(
šode
),

805 
SBI_QUOTA_NEED_REPAIR
);

806 
	`f2fs_uÆock_İ
(
	`F2FS_I_SB
(
šode
));

807  
”r
;

813 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_UID
)

814 
šode
->
i_uid
 = 
©Œ
->
Ÿ_uid
;

815 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_GID
)

816 
šode
->
i_gid
 = 
©Œ
->
Ÿ_gid
;

817 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

818 
	`f2fs_uÆock_İ
(
	`F2FS_I_SB
(
šode
));

821 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_SIZE
) {

822 
loff_t
 
Şd_size
 = 
	`i_size_»ad
(
šode
);

824 ià(
©Œ
->
Ÿ_size
 > 
	`MAX_INLINE_DATA
(
šode
)) {

829 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

830 ià(
”r
)

831  
”r
;

834 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

835 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

837 
	`Œunÿ‹_£tsize
(
šode
, 
©Œ
->
Ÿ_size
);

839 ià(
©Œ
->
Ÿ_size
 <ğ
Şd_size
)

840 
”r
 = 
	`f2fs_Œunÿ‹
(
šode
);

845 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

846 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

847 ià(
”r
)

848  
”r
;

850 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

851 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

852 
	`F2FS_I
(
šode
)->
Ï¡_disk_size
 = 
	`i_size_»ad
(inode);

853 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

856 
	`__£‰r_cİy
(
šode
, 
©Œ
);

858 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_MODE
) {

859 
”r
 = 
	`posix_aş_chmod
(
šode
, 
	`f2fs_g‘_šode_mode
(inode));

860 ià(
”r
 || 
	`is_šode_æag_£t
(
šode
, 
FI_ACL_MODE
)) {

861 
šode
->
i_mode
 = 
	`F2FS_I
(šode)->
i_aş_mode
;

862 
	`ş—r_šode_æag
(
šode
, 
FI_ACL_MODE
);

867 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

870 
	`f2fs_b®ªû_fs
(
	`F2FS_I_SB
(
šode
), 
Œue
);

872  
”r
;

873 
	}
}

875 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_fe_šode_İ”©iÚs
 = {

876 .
g‘©Œ
 = 
f2fs_g‘©Œ
,

877 .
	g£‰r
 = 
f2fs_£‰r
,

878 .
	gg‘_aş
 = 
f2fs_g‘_aş
,

879 .
	g£t_aş
 = 
f2fs_£t_aş
,

880 #ifdeà
CONFIG_F2FS_FS_XATTR


881 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

883 .
	gf›m­
 = 
f2fs_f›m­
,

886 
	$fl_z”o
(
šode
 *šode, 
pgoff_t
 
šdex
,

887 
loff_t
 
¡¬t
,†off_ˆ
Ën
)

889 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

890 
·ge
 *page;

892 ià(!
Ën
)

895 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

897 
	`f2fs_lock_İ
(
sbi
);

898 
·ge
 = 
	`f2fs_g‘_Ãw_d©a_·ge
(
šode
, 
NULL
, 
šdex
, 
çl£
);

899 
	`f2fs_uÆock_İ
(
sbi
);

901 ià(
	`IS_ERR
(
·ge
))

902  
	`PTR_ERR
(
·ge
);

904 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
,rue);

905 
	`z”o_u£r
(
·ge
, 
¡¬t
, 
Ën
);

906 
	`£t_·ge_dœty
(
·ge
);

907 
	`f2fs_put_·ge
(
·ge
, 1);

909 
	}
}

911 
	$f2fs_Œunÿ‹_hŞe
(
šode
 *šode, 
pgoff_t
 
pg_¡¬t
,…goff_ˆ
pg_’d
)

913 
”r
;

915 
pg_¡¬t
 < 
pg_’d
) {

916 
dnode_of_d©a
 
dn
;

917 
pgoff_t
 
’d_off£t
, 
couÁ
;

919 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

920 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
pg_¡¬t
, 
LOOKUP_NODE
);

921 ià(
”r
) {

922 ià(
”r
 =ğ-
ENOENT
) {

923 
pg_¡¬t
 = 
	`f2fs_g‘_Ãxt_·ge_off£t
(&
dn
,

924 
pg_¡¬t
);

927  
”r
;

930 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
);

931 
couÁ
 = 
	`mš
(
’d_off£t
 - 
dn
.
ofs_š_node
, 
pg_’d
 - 
pg_¡¬t
);

933 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
couÁ
 =ğ0 || couÁ > 
’d_off£t
);

935 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 
couÁ
);

936 
	`f2fs_put_dnode
(&
dn
);

938 
pg_¡¬t
 +ğ
couÁ
;

941 
	}
}

943 
	$punch_hŞe
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

945 
pgoff_t
 
pg_¡¬t
, 
pg_’d
;

946 
loff_t
 
off_¡¬t
, 
off_’d
;

947 
»t
;

949 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

950 ià(
»t
)

951  
»t
;

953 
pg_¡¬t
 = ((è
off£t
è>> 
PAGE_SHIFT
;

954 
pg_’d
 = ((è
off£t
 + 
Ën
è>> 
PAGE_SHIFT
;

956 
off_¡¬t
 = 
off£t
 & (
PAGE_SIZE
 - 1);

957 
off_’d
 = (
off£t
 + 
Ën
è& (
PAGE_SIZE
 - 1);

959 ià(
pg_¡¬t
 =ğ
pg_’d
) {

960 
»t
 = 
	`fl_z”o
(
šode
, 
pg_¡¬t
, 
off_¡¬t
,

961 
off_’d
 - 
off_¡¬t
);

962 ià(
»t
)

963  
»t
;

965 ià(
off_¡¬t
) {

966 
»t
 = 
	`fl_z”o
(
šode
, 
pg_¡¬t
++, 
off_¡¬t
,

967 
PAGE_SIZE
 - 
off_¡¬t
);

968 ià(
»t
)

969  
»t
;

971 ià(
off_’d
) {

972 
»t
 = 
	`fl_z”o
(
šode
, 
pg_’d
, 0, 
off_’d
);

973 ià(
»t
)

974  
»t
;

977 ià(
pg_¡¬t
 < 
pg_’d
) {

978 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

979 
loff_t
 
blk_¡¬t
, 
blk_’d
;

980 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

982 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

984 
blk_¡¬t
 = (
loff_t
)
pg_¡¬t
 << 
PAGE_SHIFT
;

985 
blk_’d
 = (
loff_t
)
pg_’d
 << 
PAGE_SHIFT
;

987 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

988 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

990 
	`Œunÿ‹_šode_·ges_¿nge
(
m­pšg
, 
blk_¡¬t
,

991 
blk_’d
 - 1);

993 
	`f2fs_lock_İ
(
sbi
);

994 
»t
 = 
	`f2fs_Œunÿ‹_hŞe
(
šode
, 
pg_¡¬t
, 
pg_’d
);

995 
	`f2fs_uÆock_İ
(
sbi
);

997 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

998 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1002  
»t
;

1003 
	}
}

1005 
	$__»ad_out_blkaddrs
(
šode
 *šode, 
block_t
 *
blkaddr
,

1006 *
do_»¶aû
, 
pgoff_t
 
off
,…goff_ˆ
Ën
)

1008 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1009 
dnode_of_d©a
 
dn
;

1010 
»t
, 
dÚe
, 
i
;

1012 
Ãxt_dnode
:

1013 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1014 
»t
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
off
, 
LOOKUP_NODE_RA
);

1015 ià(
»t
 &&„‘ !ğ-
ENOENT
) {

1016  
»t
;

1017 } ià(
»t
 =ğ-
ENOENT
) {

1018 ià(
dn
.
max_Ëv–
 == 0)

1019  -
ENOENT
;

1020 
dÚe
 = 
	`mš
((
pgoff_t
)
	`ADDRS_PER_BLOCK
(
šode
è- 
dn
.
ofs_š_node
,

1021 
Ën
);

1022 
blkaddr
 +ğ
dÚe
;

1023 
do_»¶aû
 +ğ
dÚe
;

1024 
Ãxt
;

1027 
dÚe
 = 
	`mš
((
pgoff_t
)
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
) -

1028 
dn
.
ofs_š_node
, 
Ën
);

1029 
i
 = 0; i < 
dÚe
; i++, 
blkaddr
++, 
do_»¶aû
++, 
dn
.
ofs_š_node
++) {

1030 *
blkaddr
 = 
	`d©ablock_addr
(
dn
.
šode
,

1031 
dn
.
node_·ge
, dn.
ofs_š_node
);

1033 ià(
	`__is_v®id_d©a_blkaddr
(*
blkaddr
) &&

1034 !
	`f2fs_is_v®id_blkaddr
(
sbi
, *
blkaddr
,

1035 
DATA_GENERIC_ENHANCE
)) {

1036 
	`f2fs_put_dnode
(&
dn
);

1037  -
EFSCORRUPTED
;

1040 ià(!
	`f2fs_is_checkpoš‹d_d©a
(
sbi
, *
blkaddr
)) {

1042 ià(
	`‹¡_İt
(
sbi
, 
LFS
)) {

1043 
	`f2fs_put_dnode
(&
dn
);

1044  -
EOPNOTSUPP
;

1048 
	`f2fs_upd©e_d©a_blkaddr
(&
dn
, 
NULL_ADDR
);

1049 *
do_»¶aû
 = 1;

1052 
	`f2fs_put_dnode
(&
dn
);

1053 
Ãxt
:

1054 
Ën
 -ğ
dÚe
;

1055 
off
 +ğ
dÚe
;

1056 ià(
Ën
)

1057 
Ãxt_dnode
;

1059 
	}
}

1061 
	$__rŞl_back_blkaddrs
(
šode
 *šode, 
block_t
 *
blkaddr
,

1062 *
do_»¶aû
, 
pgoff_t
 
off
, 
Ën
)

1064 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1065 
dnode_of_d©a
 
dn
;

1066 
»t
, 
i
;

1068 
i
 = 0; i < 
Ën
; i++, 
do_»¶aû
++, 
blkaddr
++) {

1069 ià(*
do_»¶aû
 == 0)

1072 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1073 
»t
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
off
 + 
i
, 
LOOKUP_NODE_RA
);

1074 ià(
»t
) {

1075 
	`dec_v®id_block_couÁ
(
sbi
, 
šode
, 1);

1076 
	`f2fs_šv®id©e_blocks
(
sbi
, *
blkaddr
);

1078 
	`f2fs_upd©e_d©a_blkaddr
(&
dn
, *
blkaddr
);

1080 
	`f2fs_put_dnode
(&
dn
);

1083 
	}
}

1085 
	$__şÚe_blkaddrs
(
šode
 *
¤c_šode
, šod*
d¡_šode
,

1086 
block_t
 *
blkaddr
, *
do_»¶aû
,

1087 
pgoff_t
 
¤c
,…goff_ˆ
d¡
,…goff_ˆ
Ën
, 
boŞ
 
fuÎ
)

1089 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
¤c_šode
);

1090 
pgoff_t
 
i
 = 0;

1091 
»t
;

1093 
i
 < 
Ën
) {

1094 ià(
blkaddr
[
i
] =ğ
NULL_ADDR
 && !
fuÎ
) {

1095 
i
++;

1099 ià(
do_»¶aû
[
i
] || 
blkaddr
[i] =ğ
NULL_ADDR
) {

1100 
dnode_of_d©a
 
dn
;

1101 
node_šfo
 
ni
;

1102 
size_t
 
Ãw_size
;

1103 
pgoff_t
 
’
;

1105 
	`£t_Ãw_dnode
(&
dn
, 
d¡_šode
, 
NULL
, NULL, 0);

1106 
»t
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
d¡
 + 
i
, 
ALLOC_NODE
);

1107 ià(
»t
)

1108  
»t
;

1110 
»t
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
.
nid
, &
ni
);

1111 ià(
»t
) {

1112 
	`f2fs_put_dnode
(&
dn
);

1113  
»t
;

1116 
’
 = 
	`mš
((
pgoff_t
)

1117 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
d¡_šode
) -

1118 
dn
.
ofs_š_node
, 
Ën
 - 
i
);

1120 
dn
.
d©a_blkaddr
 = 
	`d©ablock_addr
(dn.
šode
,

1121 
dn
.
node_·ge
, dn.
ofs_š_node
);

1122 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

1124 ià(
do_»¶aû
[
i
]) {

1125 
	`f2fs_i_blocks_wr™e
(
¤c_šode
,

1126 1, 
çl£
, false);

1127 
	`f2fs_i_blocks_wr™e
(
d¡_šode
,

1128 1, 
Œue
, 
çl£
);

1129 
	`f2fs_»¶aû_block
(
sbi
, &
dn
, dn.
d©a_blkaddr
,

1130 
blkaddr
[
i
], 
ni
.
v”siÚ
, 
Œue
, 
çl£
);

1132 
do_»¶aû
[
i
] = 0;

1134 
dn
.
ofs_š_node
++;

1135 
i
++;

1136 
Ãw_size
 = (
loff_t
)(
d¡
 + 
i
è<< 
PAGE_SHIFT
;

1137 ià(
d¡_šode
->
i_size
 < 
Ãw_size
)

1138 
	`f2fs_i_size_wr™e
(
d¡_šode
, 
Ãw_size
);

1139 } --
’
 && (
do_»¶aû
[
i
] || 
blkaddr
[i] =ğ
NULL_ADDR
));

1141 
	`f2fs_put_dnode
(&
dn
);

1143 
·ge
 *
p¤c
, *
pd¡
;

1145 
p¤c
 = 
	`f2fs_g‘_lock_d©a_·ge
(
¤c_šode
,

1146 
¤c
 + 
i
, 
Œue
);

1147 ià(
	`IS_ERR
(
p¤c
))

1148  
	`PTR_ERR
(
p¤c
);

1149 
pd¡
 = 
	`f2fs_g‘_Ãw_d©a_·ge
(
d¡_šode
, 
NULL
, 
d¡
 + 
i
,

1150 
Œue
);

1151 ià(
	`IS_ERR
(
pd¡
)) {

1152 
	`f2fs_put_·ge
(
p¤c
, 1);

1153  
	`PTR_ERR
(
pd¡
);

1155 
	`f2fs_cİy_·ge
(
p¤c
, 
pd¡
);

1156 
	`£t_·ge_dœty
(
pd¡
);

1157 
	`f2fs_put_·ge
(
pd¡
, 1);

1158 
	`f2fs_put_·ge
(
p¤c
, 1);

1160 
»t
 = 
	`f2fs_Œunÿ‹_hŞe
(
¤c_šode
,

1161 
¤c
 + 
i
, src + i + 1);

1162 ià(
»t
)

1163  
»t
;

1164 
i
++;

1168 
	}
}

1170 
	$__exchªge_d©a_block
(
šode
 *
¤c_šode
,

1171 
šode
 *
d¡_šode
, 
pgoff_t
 
¤c
,…goff_ˆ
d¡
,

1172 
pgoff_t
 
Ën
, 
boŞ
 
fuÎ
)

1174 
block_t
 *
¤c_blkaddr
;

1175 *
do_»¶aû
;

1176 
pgoff_t
 
Ş’
;

1177 
»t
;

1179 
Ën
) {

1180 
Ş’
 = 
	`mš
((
pgoff_t
)4 * 
	`ADDRS_PER_BLOCK
(
¤c_šode
), 
Ën
);

1182 
¤c_blkaddr
 = 
	`f2fs_kvz®loc
(
	`F2FS_I_SB
(
¤c_šode
),

1183 
	`¬¿y_size
(
Ş’
, (
block_t
)),

1184 
GFP_KERNEL
);

1185 ià(!
¤c_blkaddr
)

1186  -
ENOMEM
;

1188 
do_»¶aû
 = 
	`f2fs_kvz®loc
(
	`F2FS_I_SB
(
¤c_šode
),

1189 
	`¬¿y_size
(
Ş’
, ()),

1190 
GFP_KERNEL
);

1191 ià(!
do_»¶aû
) {

1192 
	`kvä“
(
¤c_blkaddr
);

1193  -
ENOMEM
;

1196 
»t
 = 
	`__»ad_out_blkaddrs
(
¤c_šode
, 
¤c_blkaddr
,

1197 
do_»¶aû
, 
¤c
, 
Ş’
);

1198 ià(
»t
)

1199 
rŞl_back
;

1201 
»t
 = 
	`__şÚe_blkaddrs
(
¤c_šode
, 
d¡_šode
, 
¤c_blkaddr
,

1202 
do_»¶aû
, 
¤c
, 
d¡
, 
Ş’
, 
fuÎ
);

1203 ià(
»t
)

1204 
rŞl_back
;

1206 
¤c
 +ğ
Ş’
;

1207 
d¡
 +ğ
Ş’
;

1208 
Ën
 -ğ
Ş’
;

1210 
	`kvä“
(
¤c_blkaddr
);

1211 
	`kvä“
(
do_»¶aû
);

1215 
rŞl_back
:

1216 
	`__rŞl_back_blkaddrs
(
¤c_šode
, 
¤c_blkaddr
, 
do_»¶aû
, 
¤c
, 
Ş’
);

1217 
	`kvä“
(
¤c_blkaddr
);

1218 
	`kvä“
(
do_»¶aû
);

1219  
»t
;

1220 
	}
}

1222 
	$f2fs_do_cŞÏp£
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

1224 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1225 
pgoff_t
 
Ä·ges
 = 
	`DIV_ROUND_UP
(
	`i_size_»ad
(
šode
), 
PAGE_SIZE
);

1226 
pgoff_t
 
¡¬t
 = 
off£t
 >> 
PAGE_SHIFT
;

1227 
pgoff_t
 
’d
 = (
off£t
 + 
Ën
è>> 
PAGE_SHIFT
;

1228 
»t
;

1230 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

1233 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1234 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1236 
	`f2fs_lock_İ
(
sbi
);

1237 
	`f2fs_drİ_ex‹Á_Œ“
(
šode
);

1238 
	`Œunÿ‹_·geÿche
(
šode
, 
off£t
);

1239 
»t
 = 
	`__exchªge_d©a_block
(
šode
, inode, 
’d
, 
¡¬t
, 
Ä·ges
 -ƒnd, 
Œue
);

1240 
	`f2fs_uÆock_İ
(
sbi
);

1242 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1243 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1244  
»t
;

1245 
	}
}

1247 
	$f2fs_cŞÏp£_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

1249 
loff_t
 
Ãw_size
;

1250 
»t
;

1252 ià(
off£t
 + 
Ën
 >ğ
	`i_size_»ad
(
šode
))

1253  -
EINVAL
;

1256 ià(
off£t
 & (
F2FS_BLKSIZE
 - 1è|| 
Ën
 & (F2FS_BLKSIZE - 1))

1257  -
EINVAL
;

1259 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1260 ià(
»t
)

1261  
»t
;

1264 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
, 
LLONG_MAX
);

1265 ià(
»t
)

1266  
»t
;

1268 
»t
 = 
	`f2fs_do_cŞÏp£
(
šode
, 
off£t
, 
Ën
);

1269 ià(
»t
)

1270  
»t
;

1273 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1274 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
, 
LLONG_MAX
);

1275 
	`Œunÿ‹_·geÿche
(
šode
, 
off£t
);

1277 
Ãw_size
 = 
	`i_size_»ad
(
šode
è- 
Ën
;

1278 
	`Œunÿ‹_·geÿche
(
šode
, 
Ãw_size
);

1280 
»t
 = 
	`f2fs_Œunÿ‹_blocks
(
šode
, 
Ãw_size
, 
Œue
);

1281 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1282 ià(!
»t
)

1283 
	`f2fs_i_size_wr™e
(
šode
, 
Ãw_size
);

1284  
»t
;

1285 
	}
}

1287 
	$f2fs_do_z”o_¿nge
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
¡¬t
,

1288 
pgoff_t
 
’d
)

1290 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

1291 
pgoff_t
 
šdex
 = 
¡¬t
;

1292 
ofs_š_node
 = 
dn
->ofs_in_node;

1293 
blkút_t
 
couÁ
 = 0;

1294 
»t
;

1296 ; 
šdex
 < 
’d
; index++, 
dn
->
ofs_š_node
++) {

1297 ià(
	`d©ablock_addr
(
dn
->
šode
, dn->
node_·ge
,

1298 
dn
->
ofs_š_node
è=ğ
NULL_ADDR
)

1299 
couÁ
++;

1302 
dn
->
ofs_š_node
 = ofs_in_node;

1303 
»t
 = 
	`f2fs_»£rve_Ãw_blocks
(
dn
, 
couÁ
);

1304 ià(
»t
)

1305  
»t
;

1307 
dn
->
ofs_š_node
 = ofs_in_node;

1308 
šdex
 = 
¡¬t
; index < 
’d
; index++, 
dn
->
ofs_š_node
++) {

1309 
dn
->
d©a_blkaddr
 = 
	`d©ablock_addr
(dn->
šode
,

1310 
dn
->
node_·ge
, dn->
ofs_š_node
);

1315 ià(
dn
->
d©a_blkaddr
 =ğ
NULL_ADDR
) {

1316 
»t
 = -
ENOSPC
;

1319 ià(
dn
->
d©a_blkaddr
 !ğ
NEW_ADDR
) {

1320 
	`f2fs_šv®id©e_blocks
(
sbi
, 
dn
->
d©a_blkaddr
);

1321 
dn
->
d©a_blkaddr
 = 
NEW_ADDR
;

1322 
	`f2fs_£t_d©a_blkaddr
(
dn
);

1326 
	`f2fs_upd©e_ex‹Á_ÿche_¿nge
(
dn
, 
¡¬t
, 0, 
šdex
 - start);

1328  
»t
;

1329 
	}
}

1331 
	$f2fs_z”o_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
,

1332 
mode
)

1334 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1335 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

1336 
pgoff_t
 
šdex
, 
pg_¡¬t
, 
pg_’d
;

1337 
loff_t
 
Ãw_size
 = 
	`i_size_»ad
(
šode
);

1338 
loff_t
 
off_¡¬t
, 
off_’d
;

1339 
»t
 = 0;

1341 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, (
Ën
 + 
off£t
));

1342 ià(
»t
)

1343  
»t
;

1345 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1346 ià(
»t
)

1347  
»t
;

1349 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
m­pšg
, 
off£t
, off£ˆ+ 
Ën
 - 1);

1350 ià(
»t
)

1351  
»t
;

1353 
pg_¡¬t
 = ((è
off£t
è>> 
PAGE_SHIFT
;

1354 
pg_’d
 = ((è
off£t
 + 
Ën
è>> 
PAGE_SHIFT
;

1356 
off_¡¬t
 = 
off£t
 & (
PAGE_SIZE
 - 1);

1357 
off_’d
 = (
off£t
 + 
Ën
è& (
PAGE_SIZE
 - 1);

1359 ià(
pg_¡¬t
 =ğ
pg_’d
) {

1360 
»t
 = 
	`fl_z”o
(
šode
, 
pg_¡¬t
, 
off_¡¬t
,

1361 
off_’d
 - 
off_¡¬t
);

1362 ià(
»t
)

1363  
»t
;

1365 
Ãw_size
 = 
	`max_t
(
loff_t
,‚ew_size, 
off£t
 + 
Ën
);

1367 ià(
off_¡¬t
) {

1368 
»t
 = 
	`fl_z”o
(
šode
, 
pg_¡¬t
++, 
off_¡¬t
,

1369 
PAGE_SIZE
 - 
off_¡¬t
);

1370 ià(
»t
)

1371  
»t
;

1373 
Ãw_size
 = 
	`max_t
(
loff_t
,‚ew_size,

1374 (
loff_t
)
pg_¡¬t
 << 
PAGE_SHIFT
);

1377 
šdex
 = 
pg_¡¬t
; index < 
pg_’d
;) {

1378 
dnode_of_d©a
 
dn
;

1379 
’d_off£t
;

1380 
pgoff_t
 
’d
;

1382 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1383 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1385 
	`Œunÿ‹_·geÿche_¿nge
(
šode
,

1386 (
loff_t
)
šdex
 << 
PAGE_SHIFT
,

1387 ((
loff_t
)
pg_’d
 << 
PAGE_SHIFT
) - 1);

1389 
	`f2fs_lock_İ
(
sbi
);

1391 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1392 
»t
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
šdex
, 
ALLOC_NODE
);

1393 ià(
»t
) {

1394 
	`f2fs_uÆock_İ
(
sbi
);

1395 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1396 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1397 
out
;

1400 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
šode
);

1401 
’d
 = 
	`mš
(
pg_’d
, 
’d_off£t
 - 
dn
.
ofs_š_node
 + 
šdex
);

1403 
»t
 = 
	`f2fs_do_z”o_¿nge
(&
dn
, 
šdex
, 
’d
);

1404 
	`f2fs_put_dnode
(&
dn
);

1406 
	`f2fs_uÆock_İ
(
sbi
);

1407 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1408 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1410 
	`f2fs_b®ªû_fs
(
sbi
, 
dn
.
node_chªged
);

1412 ià(
»t
)

1413 
out
;

1415 
šdex
 = 
’d
;

1416 
Ãw_size
 = 
	`max_t
(
loff_t
,‚ew_size,

1417 (
loff_t
)
šdex
 << 
PAGE_SHIFT
);

1420 ià(
off_’d
) {

1421 
»t
 = 
	`fl_z”o
(
šode
, 
pg_’d
, 0, 
off_’d
);

1422 ià(
»t
)

1423 
out
;

1425 
Ãw_size
 = 
	`max_t
(
loff_t
,‚ew_size, 
off£t
 + 
Ën
);

1429 
out
:

1430 ià(
Ãw_size
 > 
	`i_size_»ad
(
šode
)) {

1431 ià(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

1432 
	`fe_£t_k“p_isize
(
šode
);

1434 
	`f2fs_i_size_wr™e
(
šode
, 
Ãw_size
);

1436  
»t
;

1437 
	}
}

1439 
	$f2fs_š£¹_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

1441 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1442 
pgoff_t
 
Ä
, 
pg_¡¬t
, 
pg_’d
, 
d–
, 
idx
;

1443 
loff_t
 
Ãw_size
;

1444 
»t
 = 0;

1446 
Ãw_size
 = 
	`i_size_»ad
(
šode
è+ 
Ën
;

1447 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, 
Ãw_size
);

1448 ià(
»t
)

1449  
»t
;

1451 ià(
off£t
 >ğ
	`i_size_»ad
(
šode
))

1452  -
EINVAL
;

1455 ià(
off£t
 & (
F2FS_BLKSIZE
 - 1è|| 
Ën
 & (F2FS_BLKSIZE - 1))

1456  -
EINVAL
;

1458 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1459 ià(
»t
)

1460  
»t
;

1462 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

1464 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1465 
»t
 = 
	`f2fs_Œunÿ‹_blocks
(
šode
, 
	`i_size_»ad
(šode), 
Œue
);

1466 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1467 ià(
»t
)

1468  
»t
;

1471 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
, 
LLONG_MAX
);

1472 ià(
»t
)

1473  
»t
;

1475 
pg_¡¬t
 = 
off£t
 >> 
PAGE_SHIFT
;

1476 
pg_’d
 = (
off£t
 + 
Ën
è>> 
PAGE_SHIFT
;

1477 
d–
 = 
pg_’d
 - 
pg_¡¬t
;

1478 
idx
 = 
	`DIV_ROUND_UP
(
	`i_size_»ad
(
šode
), 
PAGE_SIZE
);

1481 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1482 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1483 
	`Œunÿ‹_·geÿche
(
šode
, 
off£t
);

1485 !
»t
 && 
idx
 > 
pg_¡¬t
) {

1486 
Ä
 = 
idx
 - 
pg_¡¬t
;

1487 ià(
Ä
 > 
d–
)

1488 
Ä
 = 
d–
;

1489 
idx
 -ğ
Ä
;

1491 
	`f2fs_lock_İ
(
sbi
);

1492 
	`f2fs_drİ_ex‹Á_Œ“
(
šode
);

1494 
»t
 = 
	`__exchªge_d©a_block
(
šode
, inode, 
idx
,

1495 
idx
 + 
d–
, 
Ä
, 
çl£
);

1496 
	`f2fs_uÆock_İ
(
sbi
);

1498 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1499 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1502 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1503 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
, 
LLONG_MAX
);

1504 
	`Œunÿ‹_·geÿche
(
šode
, 
off£t
);

1505 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_mm­_£m
);

1507 ià(!
»t
)

1508 
	`f2fs_i_size_wr™e
(
šode
, 
Ãw_size
);

1509  
»t
;

1510 
	}
}

1512 
	$ex·nd_šode_d©a
(
šode
 *šode, 
loff_t
 
off£t
,

1513 
loff_t
 
Ën
, 
mode
)

1515 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1516 
f2fs_m­_blocks
 
m­
 = { .
m_Ãxt_pgofs
 = 
NULL
,

1517 .
m_Ãxt_ex‹Á
 = 
NULL
, .
m_£g_ty³
 = 
NO_CHECK_TYPE
,

1518 .
m_may_ü—‹
 = 
Œue
 };

1519 
pgoff_t
 
pg_’d
;

1520 
loff_t
 
Ãw_size
 = 
	`i_size_»ad
(
šode
);

1521 
loff_t
 
off_’d
;

1522 
”r
;

1524 
”r
 = 
	`šode_Ãwsize_ok
(
šode
, (
Ën
 + 
off£t
));

1525 ià(
”r
)

1526  
”r
;

1528 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1529 ià(
”r
)

1530  
”r
;

1532 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

1534 
pg_’d
 = (()
off£t
 + 
Ën
è>> 
PAGE_SHIFT
;

1535 
off_’d
 = (
off£t
 + 
Ën
è& (
PAGE_SIZE
 - 1);

1537 
m­
.
m_lblk
 = (()
off£t
è>> 
PAGE_SHIFT
;

1538 
m­
.
m_Ën
 = 
pg_’d
 - m­.
m_lblk
;

1539 ià(
off_’d
)

1540 
m­
.
m_Ën
++;

1542 ià(
	`f2fs_is_pšÃd_fe
(
šode
))

1543 
m­
.
m_£g_ty³
 = 
CURSEG_COLD_DATA
;

1545 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 1, (
	`f2fs_is_pšÃd_fe
(inode) ?

1546 
F2FS_GET_BLOCK_PRE_DIO
 :

1547 
F2FS_GET_BLOCK_PRE_AIO
));

1548 ià(
”r
) {

1549 
pgoff_t
 
Ï¡_off
;

1551 ià(!
m­
.
m_Ën
)

1552  
”r
;

1554 
Ï¡_off
 = 
m­
.
m_lblk
 + m­.
m_Ën
 - 1;

1557 
Ãw_size
 = (
Ï¡_off
 =ğ
pg_’d
è? 
off£t
 + 
Ën
 :

1558 (
loff_t
)(
Ï¡_off
 + 1è<< 
PAGE_SHIFT
;

1560 
Ãw_size
 = ((
loff_t
)
pg_’d
 << 
PAGE_SHIFT
è+ 
off_’d
;

1563 ià(
Ãw_size
 > 
	`i_size_»ad
(
šode
)) {

1564 ià(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

1565 
	`fe_£t_k“p_isize
(
šode
);

1567 
	`f2fs_i_size_wr™e
(
šode
, 
Ãw_size
);

1570  
”r
;

1571 
	}
}

1573 
	$f2fs_çÎoÿ‹
(
fe
 *fe, 
mode
,

1574 
loff_t
 
off£t
,†off_ˆ
Ën
)

1576 
šode
 *šodğ
	`fe_šode
(
fe
);

1577 
»t
 = 0;

1579 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
))))

1580  -
EIO
;

1581 ià(!
	`f2fs_is_checkpošt_»ady
(
	`F2FS_I_SB
(
šode
)))

1582  -
ENOSPC
;

1585 ià(!
	`S_ISREG
(
šode
->
i_mode
))

1586  -
EINVAL
;

1588 ià(
	`IS_ENCRYPTED
(
šode
) &&

1589 (
mode
 & (
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_INSERT_RANGE
)))

1590  -
EOPNOTSUPP
;

1592 ià(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

1593 
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_ZERO_RANGE
 |

1594 
FALLOC_FL_INSERT_RANGE
))

1595  -
EOPNOTSUPP
;

1597 
	`šode_lock
(
šode
);

1599 ià(
mode
 & 
FALLOC_FL_PUNCH_HOLE
) {

1600 ià(
off£t
 >ğ
šode
->
i_size
)

1601 
out
;

1603 
»t
 = 
	`punch_hŞe
(
šode
, 
off£t
, 
Ën
);

1604 } ià(
mode
 & 
FALLOC_FL_COLLAPSE_RANGE
) {

1605 
»t
 = 
	`f2fs_cŞÏp£_¿nge
(
šode
, 
off£t
, 
Ën
);

1606 } ià(
mode
 & 
FALLOC_FL_ZERO_RANGE
) {

1607 
»t
 = 
	`f2fs_z”o_¿nge
(
šode
, 
off£t
, 
Ën
, 
mode
);

1608 } ià(
mode
 & 
FALLOC_FL_INSERT_RANGE
) {

1609 
»t
 = 
	`f2fs_š£¹_¿nge
(
šode
, 
off£t
, 
Ën
);

1611 
»t
 = 
	`ex·nd_šode_d©a
(
šode
, 
off£t
, 
Ën
, 
mode
);

1614 ià(!
»t
) {

1615 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

1616 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

1617 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

1620 
out
:

1621 
	`šode_uÆock
(
šode
);

1623 
	`Œaû_f2fs_çÎoÿ‹
(
šode
, 
mode
, 
off£t
, 
Ën
, 
»t
);

1624  
»t
;

1625 
	}
}

1627 
	$f2fs_»Ëa£_fe
(
šode
 *šode, 
fe
 *
fp
)

1633 ià(!(
fp
->
f_mode
 & 
FMODE_WRITE
) ||

1634 
	`©omic_»ad
(&
šode
->
i_wr™ecouÁ
) != 1)

1638 ià(
	`f2fs_is_©omic_fe
(
šode
))

1639 
	`f2fs_drİ_šmem_·ges
(
šode
);

1640 ià(
	`f2fs_is_vŞ©e_fe
(
šode
)) {

1641 
	`£t_šode_æag
(
šode
, 
FI_DROP_CACHE
);

1642 
	`fem­_fd©awr™e
(
šode
->
i_m­pšg
);

1643 
	`ş—r_šode_æag
(
šode
, 
FI_DROP_CACHE
);

1644 
	`ş—r_šode_æag
(
šode
, 
FI_VOLATILE_FILE
);

1645 
	`¡©_dec_vŞ©e_wr™e
(
šode
);

1648 
	}
}

1650 
	$f2fs_fe_æush
(
fe
 *fe, 
æ_owÃr_t
 
id
)

1652 
šode
 *šodğ
	`fe_šode
(
fe
);

1660 ià(
	`f2fs_is_©omic_fe
(
šode
) &&

1661 
	`F2FS_I
(
šode
)->
šmem_sk
 =ğ
cu¼’t
)

1662 
	`f2fs_drİ_šmem_·ges
(
šode
);

1664 
	}
}

1666 
	$f2fs_£tæags_commÚ
(
šode
 *šode, 
u32
 
iæags
, u32 
mask
)

1668 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

1671 ià(
	`IS_NOQUOTA
(
šode
))

1672  -
EPERM
;

1674 ià((
iæags
 ^ 
fi
->
i_æags
è& 
F2FS_CASEFOLD_FL
) {

1675 ià(!
	`f2fs_sb_has_ÿ£fŞd
(
	`F2FS_I_SB
(
šode
)))

1676  -
EOPNOTSUPP
;

1677 ià(!
	`f2fs_em±y_dœ
(
šode
))

1678  -
ENOTEMPTY
;

1681 
fi
->
i_æags
 = 
iæags
 | (fi->i_æag & ~
mask
);

1683 ià(
fi
->
i_æags
 & 
F2FS_PROJINHERIT_FL
)

1684 
	`£t_šode_æag
(
šode
, 
FI_PROJ_INHERIT
);

1686 
	`ş—r_šode_æag
(
šode
, 
FI_PROJ_INHERIT
);

1688 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

1689 
	`f2fs_£t_šode_æags
(
šode
);

1690 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

1692 
	}
}

1704 
u32
 
	miæag
;

1705 
u32
 
	mfsæag
;

1706 } 
	gf2fs_fsæags_m­
[] = {

1707 { 
F2FS_SYNC_FL
, 
FS_SYNC_FL
 },

1708 { 
F2FS_IMMUTABLE_FL
, 
FS_IMMUTABLE_FL
 },

1709 { 
F2FS_APPEND_FL
, 
FS_APPEND_FL
 },

1710 { 
F2FS_NODUMP_FL
, 
FS_NODUMP_FL
 },

1711 { 
F2FS_NOATIME_FL
, 
FS_NOATIME_FL
 },

1712 { 
F2FS_INDEX_FL
, 
FS_INDEX_FL
 },

1713 { 
F2FS_DIRSYNC_FL
, 
FS_DIRSYNC_FL
 },

1714 { 
F2FS_PROJINHERIT_FL
, 
FS_PROJINHERIT_FL
 },

1715 { 
F2FS_CASEFOLD_FL
, 
FS_CASEFOLD_FL
 },

1718 
	#F2FS_GETTABLE_FS_FL
 ( \

1719 
FS_SYNC_FL
 | \

1720 
FS_IMMUTABLE_FL
 | \

1721 
FS_APPEND_FL
 | \

1722 
FS_NODUMP_FL
 | \

1723 
FS_NOATIME_FL
 | \

1724 
FS_INDEX_FL
 | \

1725 
FS_DIRSYNC_FL
 | \

1726 
FS_PROJINHERIT_FL
 | \

1727 
FS_ENCRYPT_FL
 | \

1728 
FS_INLINE_DATA_FL
 | \

1729 
FS_NOCOW_FL
 | \

1730 
FS_VERITY_FL
 | \

1731 
FS_CASEFOLD_FL
)

	)

1733 
	#F2FS_SETTABLE_FS_FL
 ( \

1734 
FS_SYNC_FL
 | \

1735 
FS_IMMUTABLE_FL
 | \

1736 
FS_APPEND_FL
 | \

1737 
FS_NODUMP_FL
 | \

1738 
FS_NOATIME_FL
 | \

1739 
FS_DIRSYNC_FL
 | \

1740 
FS_PROJINHERIT_FL
 | \

1741 
FS_CASEFOLD_FL
)

	)

1744 
šlše
 
u32
 
	$f2fs_iæags_to_fsæags
(
u32
 
iæags
)

1746 
u32
 
fsæags
 = 0;

1747 
i
;

1749 
i
 = 0; i < 
	`ARRAY_SIZE
(
f2fs_fsæags_m­
); i++)

1750 ià(
iæags
 & 
f2fs_fsæags_m­
[
i
].
iæag
)

1751 
fsæags
 |ğ
f2fs_fsæags_m­
[
i
].
fsæag
;

1753  
fsæags
;

1754 
	}
}

1757 
šlše
 
u32
 
	$f2fs_fsæags_to_iæags
(
u32
 
fsæags
)

1759 
u32
 
iæags
 = 0;

1760 
i
;

1762 
i
 = 0; i < 
	`ARRAY_SIZE
(
f2fs_fsæags_m­
); i++)

1763 ià(
fsæags
 & 
f2fs_fsæags_m­
[
i
].
fsæag
)

1764 
iæags
 |ğ
f2fs_fsæags_m­
[
i
].
iæag
;

1766  
iæags
;

1767 
	}
}

1769 
	$f2fs_ioc_g‘æags
(
fe
 *
fp
, 
¬g
)

1771 
šode
 *šodğ
	`fe_šode
(
fp
);

1772 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

1773 
u32
 
fsæags
 = 
	`f2fs_iæags_to_fsæags
(
fi
->
i_æags
);

1775 ià(
	`IS_ENCRYPTED
(
šode
))

1776 
fsæags
 |ğ
FS_ENCRYPT_FL
;

1777 ià(
	`IS_VERITY
(
šode
))

1778 
fsæags
 |ğ
FS_VERITY_FL
;

1779 ià(
	`f2fs_has_šlše_d©a
(
šode
è|| 
	`f2fs_has_šlše_d’Œy
(inode))

1780 
fsæags
 |ğ
FS_INLINE_DATA_FL
;

1781 ià(
	`is_šode_æag_£t
(
šode
, 
FI_PIN_FILE
))

1782 
fsæags
 |ğ
FS_NOCOW_FL
;

1784 
fsæags
 &ğ
F2FS_GETTABLE_FS_FL
;

1786  
	`put_u£r
(
fsæags
, (
__u£r
 *)
¬g
);

1787 
	}
}

1789 
	$f2fs_ioc_£tæags
(
fe
 *
fp
, 
¬g
)

1791 
šode
 *šodğ
	`fe_šode
(
fp
);

1792 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

1793 
u32
 
fsæags
, 
Şd_fsæags
;

1794 
u32
 
iæags
;

1795 
»t
;

1797 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1798  -
EACCES
;

1800 ià(
	`g‘_u£r
(
fsæags
, (
__u£r
 *)
¬g
))

1801  -
EFAULT
;

1803 ià(
fsæags
 & ~
F2FS_GETTABLE_FS_FL
)

1804  -
EOPNOTSUPP
;

1805 
fsæags
 &ğ
F2FS_SETTABLE_FS_FL
;

1807 
iæags
 = 
	`f2fs_fsæags_to_iæags
(
fsæags
);

1808 ià(
	`f2fs_mask_æags
(
šode
->
i_mode
, 
iæags
) != iflags)

1809  -
EOPNOTSUPP
;

1811 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1812 ià(
»t
)

1813  
»t
;

1815 
	`šode_lock
(
šode
);

1817 
Şd_fsæags
 = 
	`f2fs_iæags_to_fsæags
(
fi
->
i_æags
);

1818 
»t
 = 
	`vfs_ioc_£tæags_´•¬e
(
šode
, 
Şd_fsæags
, 
fsæags
);

1819 ià(
»t
)

1820 
out
;

1822 
»t
 = 
	`f2fs_£tæags_commÚ
(
šode
, 
iæags
,

1823 
	`f2fs_fsæags_to_iæags
(
F2FS_SETTABLE_FS_FL
));

1824 
out
:

1825 
	`šode_uÆock
(
šode
);

1826 
	`mÁ_drİ_wr™e_fe
(
fp
);

1827  
»t
;

1828 
	}
}

1830 
	$f2fs_ioc_g‘v”siÚ
(
fe
 *
fp
, 
¬g
)

1832 
šode
 *šodğ
	`fe_šode
(
fp
);

1834  
	`put_u£r
(
šode
->
i_g’”©iÚ
, (
__u£r
 *)
¬g
);

1835 
	}
}

1837 
	$f2fs_ioc_¡¬t_©omic_wr™e
(
fe
 *
fp
)

1839 
šode
 *šodğ
	`fe_šode
(
fp
);

1840 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

1841 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1842 
»t
;

1844 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1845  -
EACCES
;

1847 ià(!
	`S_ISREG
(
šode
->
i_mode
))

1848  -
EINVAL
;

1850 ià(
fp
->
f_æags
 & 
O_DIRECT
)

1851  -
EINVAL
;

1853 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1854 ià(
»t
)

1855  
»t
;

1857 
	`šode_lock
(
šode
);

1859 ià(
	`f2fs_is_©omic_fe
(
šode
)) {

1860 ià(
	`is_šode_æag_£t
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
))

1861 
»t
 = -
EINVAL
;

1862 
out
;

1865 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1866 ià(
»t
)

1867 
out
;

1869 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1875 ià(
	`g‘_dœty_·ges
(
šode
))

1876 
	`f2fs_w¬n
(
	`F2FS_I_SB
(
šode
), "Unexpected flush for‡tomic writes: ino=%lu,‚pages=%u",

1877 
šode
->
i_šo
, 
	`g‘_dœty_·ges
(inode));

1878 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 0, 
LLONG_MAX
);

1879 ià(
»t
) {

1880 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1881 
out
;

1884 
	`¥š_lock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

1885 ià(
	`li¡_em±y
(&
fi
->
šmem_i¡
))

1886 
	`li¡_add_
(&
fi
->
šmem_i¡
, &
sbi
->
šode_li¡
[
ATOMIC_FILE
]);

1887 
sbi
->
©omic_fes
++;

1888 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

1891 
	`£t_šode_æag
(
šode
, 
FI_ATOMIC_FILE
);

1892 
	`ş—r_šode_æag
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
);

1893 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1895 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

1896 
	`F2FS_I
(
šode
)->
šmem_sk
 = 
cu¼’t
;

1897 
	`¡©_šc_©omic_wr™e
(
šode
);

1898 
	`¡©_upd©e_max_©omic_wr™e
(
šode
);

1899 
out
:

1900 
	`šode_uÆock
(
šode
);

1901 
	`mÁ_drİ_wr™e_fe
(
fp
);

1902  
»t
;

1903 
	}
}

1905 
	$f2fs_ioc_comm™_©omic_wr™e
(
fe
 *
fp
)

1907 
šode
 *šodğ
	`fe_šode
(
fp
);

1908 
»t
;

1910 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1911  -
EACCES
;

1913 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1914 ià(
»t
)

1915  
»t
;

1917 
	`f2fs_b®ªû_fs
(
	`F2FS_I_SB
(
šode
), 
Œue
);

1919 
	`šode_lock
(
šode
);

1921 ià(
	`f2fs_is_vŞ©e_fe
(
šode
)) {

1922 
»t
 = -
EINVAL
;

1923 
”r_out
;

1926 ià(
	`f2fs_is_©omic_fe
(
šode
)) {

1927 
»t
 = 
	`f2fs_comm™_šmem_·ges
(
šode
);

1928 ià(
»t
)

1929 
”r_out
;

1931 
»t
 = 
	`f2fs_do_sync_fe
(
fp
, 0, 
LLONG_MAX
, 0, 
Œue
);

1932 ià(!
»t
)

1933 
	`f2fs_drİ_šmem_·ges
(
šode
);

1935 
»t
 = 
	`f2fs_do_sync_fe
(
fp
, 0, 
LLONG_MAX
, 1, 
çl£
);

1937 
”r_out
:

1938 ià(
	`is_šode_æag_£t
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
)) {

1939 
	`ş—r_šode_æag
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
);

1940 
»t
 = -
EINVAL
;

1942 
	`šode_uÆock
(
šode
);

1943 
	`mÁ_drİ_wr™e_fe
(
fp
);

1944  
»t
;

1945 
	}
}

1947 
	$f2fs_ioc_¡¬t_vŞ©e_wr™e
(
fe
 *
fp
)

1949 
šode
 *šodğ
	`fe_šode
(
fp
);

1950 
»t
;

1952 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1953  -
EACCES
;

1955 ià(!
	`S_ISREG
(
šode
->
i_mode
))

1956  -
EINVAL
;

1958 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1959 ià(
»t
)

1960  
»t
;

1962 
	`šode_lock
(
šode
);

1964 ià(
	`f2fs_is_vŞ©e_fe
(
šode
))

1965 
out
;

1967 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

1968 ià(
»t
)

1969 
out
;

1971 
	`¡©_šc_vŞ©e_wr™e
(
šode
);

1972 
	`¡©_upd©e_max_vŞ©e_wr™e
(
šode
);

1974 
	`£t_šode_æag
(
šode
, 
FI_VOLATILE_FILE
);

1975 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

1976 
out
:

1977 
	`šode_uÆock
(
šode
);

1978 
	`mÁ_drİ_wr™e_fe
(
fp
);

1979  
»t
;

1980 
	}
}

1982 
	$f2fs_ioc_»Ëa£_vŞ©e_wr™e
(
fe
 *
fp
)

1984 
šode
 *šodğ
	`fe_šode
(
fp
);

1985 
»t
;

1987 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1988  -
EACCES
;

1990 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1991 ià(
»t
)

1992  
»t
;

1994 
	`šode_lock
(
šode
);

1996 ià(!
	`f2fs_is_vŞ©e_fe
(
šode
))

1997 
out
;

1999 ià(!
	`f2fs_is_fœ¡_block_wr™‹n
(
šode
)) {

2000 
»t
 = 
	`Œunÿ‹_·¹Ÿl_d©a_·ge
(
šode
, 0, 
Œue
);

2001 
out
;

2004 
»t
 = 
	`punch_hŞe
(
šode
, 0, 
F2FS_BLKSIZE
);

2005 
out
:

2006 
	`šode_uÆock
(
šode
);

2007 
	`mÁ_drİ_wr™e_fe
(
fp
);

2008  
»t
;

2009 
	}
}

2011 
	$f2fs_ioc_abÜt_vŞ©e_wr™e
(
fe
 *
fp
)

2013 
šode
 *šodğ
	`fe_šode
(
fp
);

2014 
»t
;

2016 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

2017  -
EACCES
;

2019 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2020 ià(
»t
)

2021  
»t
;

2023 
	`šode_lock
(
šode
);

2025 ià(
	`f2fs_is_©omic_fe
(
šode
))

2026 
	`f2fs_drİ_šmem_·ges
(
šode
);

2027 ià(
	`f2fs_is_vŞ©e_fe
(
šode
)) {

2028 
	`ş—r_šode_æag
(
šode
, 
FI_VOLATILE_FILE
);

2029 
	`¡©_dec_vŞ©e_wr™e
(
šode
);

2030 
»t
 = 
	`f2fs_do_sync_fe
(
fp
, 0, 
LLONG_MAX
, 0, 
Œue
);

2033 
	`ş—r_šode_æag
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
);

2035 
	`šode_uÆock
(
šode
);

2037 
	`mÁ_drİ_wr™e_fe
(
fp
);

2038 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

2039  
»t
;

2040 
	}
}

2042 
	$f2fs_ioc_shutdown
(
fe
 *
fp
, 
¬g
)

2044 
šode
 *šodğ
	`fe_šode
(
fp
);

2045 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2046 
su³r_block
 *
sb
 = 
sbi
->sb;

2047 
__u32
 
š
;

2048 
»t
 = 0;

2050 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2051  -
EPERM
;

2053 ià(
	`g‘_u£r
(
š
, (
__u32
 
__u£r
 *)
¬g
))

2054  -
EFAULT
;

2056 ià(
š
 !ğ
F2FS_GOING_DOWN_FULLSYNC
) {

2057 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2058 ià(
»t
)

2059  
»t
;

2062 
š
) {

2063 
F2FS_GOING_DOWN_FULLSYNC
:

2064 
sb
 = 
	`ä“ze_bdev
(sb->
s_bdev
);

2065 ià(
	`IS_ERR
(
sb
)) {

2066 
»t
 = 
	`PTR_ERR
(
sb
);

2067 
out
;

2069 ià(
sb
) {

2070 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

2071 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_SHUTDOWN
);

2072 
	`thaw_bdev
(
sb
->
s_bdev
, sb);

2075 
F2FS_GOING_DOWN_METASYNC
:

2077 
»t
 = 
	`f2fs_sync_fs
(
sb
, 1);

2078 ià(
»t
)

2079 
out
;

2080 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

2081 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_SHUTDOWN
);

2083 
F2FS_GOING_DOWN_NOSYNC
:

2084 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

2085 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_SHUTDOWN
);

2087 
F2FS_GOING_DOWN_METAFLUSH
:

2088 
	`f2fs_sync_m‘a_·ges
(
sbi
, 
META
, 
LONG_MAX
, 
FS_META_IO
);

2089 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

2090 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_SHUTDOWN
);

2092 
F2FS_GOING_DOWN_NEED_FSCK
:

2093 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

2094 
	`£t_sbi_æag
(
sbi
, 
SBI_CP_DISABLED_QUICK
);

2095 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

2097 
»t
 = 
	`f2fs_sync_fs
(
sb
, 1);

2098 
out
;

2100 
»t
 = -
EINVAL
;

2101 
out
;

2104 
	`f2fs_¡İ_gc_th»ad
(
sbi
);

2105 
	`f2fs_¡İ_disÿrd_th»ad
(
sbi
);

2107 
	`f2fs_drİ_disÿrd_cmd
(
sbi
);

2108 
	`ş—r_İt
(
sbi
, 
DISCARD
);

2110 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

2111 
out
:

2112 ià(
š
 !ğ
F2FS_GOING_DOWN_FULLSYNC
)

2113 
	`mÁ_drİ_wr™e_fe
(
fp
);

2115 
	`Œaû_f2fs_shutdown
(
sbi
, 
š
, 
»t
);

2117  
»t
;

2118 
	}
}

2120 
	$f2fs_ioc_f™rim
(
fe
 *
fp
, 
¬g
)

2122 
šode
 *šodğ
	`fe_šode
(
fp
);

2123 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

2124 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
sb
->
s_bdev
);

2125 
f¡rim_¿nge
 
¿nge
;

2126 
»t
;

2128 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2129  -
EPERM
;

2131 ià(!
	`f2fs_hw_suµÜt_disÿrd
(
	`F2FS_SB
(
sb
)))

2132  -
EOPNOTSUPP
;

2134 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f¡rim_¿nge
 
__u£r
 *)
¬g
,

2135 (
¿nge
)))

2136  -
EFAULT
;

2138 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2139 ià(
»t
)

2140  
»t
;

2142 
¿nge
.
mšËn
 = 
	`max
(()range.minlen,

2143 
q
->
lim™s
.
disÿrd_g¿nuÏr™y
);

2144 
»t
 = 
	`f2fs_Œim_fs
(
	`F2FS_SB
(
sb
), &
¿nge
);

2145 
	`mÁ_drİ_wr™e_fe
(
fp
);

2146 ià(
»t
 < 0)

2147  
»t
;

2149 ià(
	`cİy_to_u£r
((
f¡rim_¿nge
 
__u£r
 *)
¬g
, &
¿nge
,

2150 (
¿nge
)))

2151  -
EFAULT
;

2152 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

2154 
	}
}

2156 
boŞ
 
	$uuid_is_nÚz”o
(
__u8
 
u
[16])

2158 
i
;

2160 
i
 = 0; i < 16; i++)

2161 ià(
u
[
i
])

2162  
Œue
;

2163  
çl£
;

2164 
	}
}

2166 
	$f2fs_ioc_£t_’üy±iÚ_pŞicy
(
fe
 *
fp
, 
¬g
)

2168 
šode
 *šodğ
	`fe_šode
(
fp
);

2170 ià(!
	`f2fs_sb_has_’üy±
(
	`F2FS_I_SB
(
šode
)))

2171  -
EOPNOTSUPP
;

2173 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

2175  
	`fsüy±_ioùl_£t_pŞicy
(
fp
, (cÚ¡ 
__u£r
 *)
¬g
);

2176 
	}
}

2178 
	$f2fs_ioc_g‘_’üy±iÚ_pŞicy
(
fe
 *
fp
, 
¬g
)

2180 ià(!
	`f2fs_sb_has_’üy±
(
	`F2FS_I_SB
(
	`fe_šode
(
fp
))))

2181  -
EOPNOTSUPP
;

2182  
	`fsüy±_ioùl_g‘_pŞicy
(
fp
, (
__u£r
 *)
¬g
);

2183 
	}
}

2185 
	$f2fs_ioc_g‘_’üy±iÚ_pw§É
(
fe
 *
fp
, 
¬g
)

2187 
šode
 *šodğ
	`fe_šode
(
fp
);

2188 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2189 
”r
;

2191 ià(!
	`f2fs_sb_has_’üy±
(
sbi
))

2192  -
EOPNOTSUPP
;

2194 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2195 ià(
”r
)

2196  
”r
;

2198 
	`down_wr™e
(&
sbi
->
sb_lock
);

2200 ià(
	`uuid_is_nÚz”o
(
sbi
->
¿w_su³r
->
’üy±_pw_§É
))

2201 
gÙ_™
;

2204 
	`g’”©e_¿ndom_uuid
(
sbi
->
¿w_su³r
->
’üy±_pw_§É
);

2206 
”r
 = 
	`f2fs_comm™_su³r
(
sbi
, 
çl£
);

2207 ià(
”r
) {

2209 
	`mem£t
(
sbi
->
¿w_su³r
->
’üy±_pw_§É
, 0, 16);

2210 
out_”r
;

2212 
gÙ_™
:

2213 ià(
	`cİy_to_u£r
((
__u8
 
__u£r
 *)
¬g
, 
sbi
->
¿w_su³r
->
’üy±_pw_§É
,

2215 
”r
 = -
EFAULT
;

2216 
out_”r
:

2217 
	`up_wr™e
(&
sbi
->
sb_lock
);

2218 
	`mÁ_drİ_wr™e_fe
(
fp
);

2219  
”r
;

2220 
	}
}

2222 
	$f2fs_ioc_g‘_’üy±iÚ_pŞicy_ex
(
fe
 *
fp
,

2223 
¬g
)

2225 ià(!
	`f2fs_sb_has_’üy±
(
	`F2FS_I_SB
(
	`fe_šode
(
fp
))))

2226  -
EOPNOTSUPP
;

2228  
	`fsüy±_ioùl_g‘_pŞicy_ex
(
fp
, (
__u£r
 *)
¬g
);

2229 
	}
}

2231 
	$f2fs_ioc_add_’üy±iÚ_key
(
fe
 *
fp
, 
¬g
)

2233 ià(!
	`f2fs_sb_has_’üy±
(
	`F2FS_I_SB
(
	`fe_šode
(
fp
))))

2234  -
EOPNOTSUPP
;

2236  
	`fsüy±_ioùl_add_key
(
fp
, (
__u£r
 *)
¬g
);

2237 
	}
}

2239 
	$f2fs_ioc_»move_’üy±iÚ_key
(
fe
 *
fp
, 
¬g
)

2241 ià(!
	`f2fs_sb_has_’üy±
(
	`F2FS_I_SB
(
	`fe_šode
(
fp
))))

2242  -
EOPNOTSUPP
;

2244  
	`fsüy±_ioùl_»move_key
(
fp
, (
__u£r
 *)
¬g
);

2245 
	}
}

2247 
	$f2fs_ioc_»move_’üy±iÚ_key_®l_u£rs
(
fe
 *
fp
,

2248 
¬g
)

2250 ià(!
	`f2fs_sb_has_’üy±
(
	`F2FS_I_SB
(
	`fe_šode
(
fp
))))

2251  -
EOPNOTSUPP
;

2253  
	`fsüy±_ioùl_»move_key_®l_u£rs
(
fp
, (
__u£r
 *)
¬g
);

2254 
	}
}

2256 
	$f2fs_ioc_g‘_’üy±iÚ_key_¡©us
(
fe
 *
fp
,

2257 
¬g
)

2259 ià(!
	`f2fs_sb_has_’üy±
(
	`F2FS_I_SB
(
	`fe_šode
(
fp
))))

2260  -
EOPNOTSUPP
;

2262  
	`fsüy±_ioùl_g‘_key_¡©us
(
fp
, (
__u£r
 *)
¬g
);

2263 
	}
}

2265 
	$f2fs_ioc_gc
(
fe
 *
fp
, 
¬g
)

2267 
šode
 *šodğ
	`fe_šode
(
fp
);

2268 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2269 
__u32
 
sync
;

2270 
»t
;

2272 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2273  -
EPERM
;

2275 ià(
	`g‘_u£r
(
sync
, (
__u32
 
__u£r
 *)
¬g
))

2276  -
EFAULT
;

2278 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

2279  -
EROFS
;

2281 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2282 ià(
»t
)

2283  
»t
;

2285 ià(!
sync
) {

2286 ià(!
	`mu‹x_Œylock
(&
sbi
->
gc_mu‹x
)) {

2287 
»t
 = -
EBUSY
;

2288 
out
;

2291 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

2294 
»t
 = 
	`f2fs_gc
(
sbi
, 
sync
, 
Œue
, 
NULL_SEGNO
);

2295 
out
:

2296 
	`mÁ_drİ_wr™e_fe
(
fp
);

2297  
»t
;

2298 
	}
}

2300 
	$f2fs_ioc_gc_¿nge
(
fe
 *
fp
, 
¬g
)

2302 
šode
 *šodğ
	`fe_šode
(
fp
);

2303 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2304 
f2fs_gc_¿nge
 
¿nge
;

2305 
u64
 
’d
;

2306 
»t
;

2308 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2309  -
EPERM
;

2311 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f2fs_gc_¿nge
 
__u£r
 *)
¬g
,

2312 (
¿nge
)))

2313  -
EFAULT
;

2315 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

2316  -
EROFS
;

2318 
’d
 = 
¿nge
.
¡¬t
 +„ªge.
Ën
;

2319 ià(
’d
 < 
¿nge
.
¡¬t
 ||„ªge.¡¬ˆ< 
	`MAIN_BLKADDR
(
sbi
) ||

2320 
’d
 >ğ
	`MAX_BLKADDR
(
sbi
))

2321  -
EINVAL
;

2323 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2324 ià(
»t
)

2325  
»t
;

2327 
do_mÜe
:

2328 ià(!
¿nge
.
sync
) {

2329 ià(!
	`mu‹x_Œylock
(&
sbi
->
gc_mu‹x
)) {

2330 
»t
 = -
EBUSY
;

2331 
out
;

2334 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

2337 
»t
 = 
	`f2fs_gc
(
sbi
, 
¿nge
.
sync
, 
Œue
, 
	`GET_SEGNO
(sbi,„ªge.
¡¬t
));

2338 
¿nge
.
¡¬t
 +ğ
	`BLKS_PER_SEC
(
sbi
);

2339 ià(
¿nge
.
¡¬t
 <ğ
’d
)

2340 
do_mÜe
;

2341 
out
:

2342 
	`mÁ_drİ_wr™e_fe
(
fp
);

2343  
»t
;

2344 
	}
}

2346 
	$f2fs_ioc_wr™e_checkpošt
(
fe
 *
fp
, 
¬g
)

2348 
šode
 *šodğ
	`fe_šode
(
fp
);

2349 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2350 
»t
;

2352 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2353  -
EPERM
;

2355 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

2356  -
EROFS
;

2358 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
))) {

2359 
	`f2fs_šfo
(
sbi
, "Skipping Checkpoint. Checkpoints currently disabled.");

2360  -
EINVAL
;

2363 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2364 ià(
»t
)

2365  
»t
;

2367 
»t
 = 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

2369 
	`mÁ_drİ_wr™e_fe
(
fp
);

2370  
»t
;

2371 
	}
}

2373 
	$f2fs_deäagm’t_¿nge
(
f2fs_sb_šfo
 *
sbi
,

2374 
fe
 *
fp
,

2375 
f2fs_deäagm’t
 *
¿nge
)

2377 
šode
 *šodğ
	`fe_šode
(
fp
);

2378 
f2fs_m­_blocks
 
m­
 = { .
m_Ãxt_ex‹Á
 = 
NULL
,

2379 .
m_£g_ty³
 = 
NO_CHECK_TYPE
 ,

2380 .
m_may_ü—‹
 = 
çl£
 };

2381 
ex‹Á_šfo
 
ei
 = {0, 0, 0};

2382 
pgoff_t
 
pg_¡¬t
, 
pg_’d
, 
Ãxt_pgofs
;

2383 
blk_³r_£g
 = 
sbi
->
blocks_³r_£g
;

2384 
tÙ®
 = 0, 
£c_num
;

2385 
block_t
 
blk_’d
 = 0;

2386 
boŞ
 
äagm’‹d
 = 
çl£
;

2387 
”r
;

2390 ià(
	`f2fs_should_upd©e_š¶aû
(
šode
, 
NULL
))

2391  -
EINVAL
;

2393 
pg_¡¬t
 = 
¿nge
->
¡¬t
 >> 
PAGE_SHIFT
;

2394 
pg_’d
 = (
¿nge
->
¡¬t
 +„ªge->
Ën
è>> 
PAGE_SHIFT
;

2396 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

2398 
	`šode_lock
(
šode
);

2401 
”r
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
¿nge
->
¡¬t
,

2402 
¿nge
->
¡¬t
 +„ªge->
Ën
 - 1);

2403 ià(
”r
)

2404 
out
;

2410 ià(
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
pg_¡¬t
, &
ei
)) {

2411 ià(
ei
.
fofs
 +ƒi.
Ën
 >ğ
pg_’d
)

2412 
out
;

2415 
m­
.
m_lblk
 = 
pg_¡¬t
;

2416 
m­
.
m_Ãxt_pgofs
 = &
Ãxt_pgofs
;

2423 
m­
.
m_lblk
 < 
pg_’d
) {

2424 
m­
.
m_Ën
 = 
pg_’d
 - m­.
m_lblk
;

2425 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 0, 
F2FS_GET_BLOCK_DEFAULT
);

2426 ià(
”r
)

2427 
out
;

2429 ià(!(
m­
.
m_æags
 & 
F2FS_MAP_FLAGS
)) {

2430 
m­
.
m_lblk
 = 
Ãxt_pgofs
;

2434 ià(
blk_’d
 && blk_’d !ğ
m­
.
m_pblk
)

2435 
äagm’‹d
 = 
Œue
;

2438 
tÙ®
 +ğ
m­
.
m_Ën
;

2440 
blk_’d
 = 
m­
.
m_pblk
 + m­.
m_Ën
;

2442 
m­
.
m_lblk
 +ğm­.
m_Ën
;

2445 ià(!
äagm’‹d
) {

2446 
tÙ®
 = 0;

2447 
out
;

2450 
£c_num
 = 
	`DIV_ROUND_UP
(
tÙ®
, 
	`BLKS_PER_SEC
(
sbi
));

2457 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 
£c_num
)) {

2458 
”r
 = -
EAGAIN
;

2459 
out
;

2462 
m­
.
m_lblk
 = 
pg_¡¬t
;

2463 
m­
.
m_Ën
 = 
pg_’d
 - 
pg_¡¬t
;

2464 
tÙ®
 = 0;

2466 
m­
.
m_lblk
 < 
pg_’d
) {

2467 
pgoff_t
 
idx
;

2468 
út
 = 0;

2470 
do_m­
:

2471 
m­
.
m_Ën
 = 
pg_’d
 - m­.
m_lblk
;

2472 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 0, 
F2FS_GET_BLOCK_DEFAULT
);

2473 ià(
”r
)

2474 
ş—r_out
;

2476 ià(!(
m­
.
m_æags
 & 
F2FS_MAP_FLAGS
)) {

2477 
m­
.
m_lblk
 = 
Ãxt_pgofs
;

2478 
check
;

2481 
	`£t_šode_æag
(
šode
, 
FI_DO_DEFRAG
);

2483 
idx
 = 
m­
.
m_lblk
;

2484 
idx
 < 
m­
.
m_lblk
 + m­.
m_Ën
 && 
út
 < 
blk_³r_£g
) {

2485 
·ge
 *page;

2487 
·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
šode
, 
idx
, 
Œue
);

2488 ià(
	`IS_ERR
(
·ge
)) {

2489 
”r
 = 
	`PTR_ERR
(
·ge
);

2490 
ş—r_out
;

2493 
	`£t_·ge_dœty
(
·ge
);

2494 
	`f2fs_put_·ge
(
·ge
, 1);

2496 
idx
++;

2497 
út
++;

2498 
tÙ®
++;

2501 
m­
.
m_lblk
 = 
idx
;

2502 
check
:

2503 ià(
m­
.
m_lblk
 < 
pg_’d
 && 
út
 < 
blk_³r_£g
)

2504 
do_m­
;

2506 
	`ş—r_šode_æag
(
šode
, 
FI_DO_DEFRAG
);

2508 
”r
 = 
	`fem­_fd©awr™e
(
šode
->
i_m­pšg
);

2509 ià(
”r
)

2510 
out
;

2512 
ş—r_out
:

2513 
	`ş—r_šode_æag
(
šode
, 
FI_DO_DEFRAG
);

2514 
out
:

2515 
	`šode_uÆock
(
šode
);

2516 ià(!
”r
)

2517 
¿nge
->
Ën
 = (
u64
)
tÙ®
 << 
PAGE_SHIFT
;

2518  
”r
;

2519 
	}
}

2521 
	$f2fs_ioc_deäagm’t
(
fe
 *
fp
, 
¬g
)

2523 
šode
 *šodğ
	`fe_šode
(
fp
);

2524 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2525 
f2fs_deäagm’t
 
¿nge
;

2526 
”r
;

2528 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2529  -
EPERM
;

2531 ià(!
	`S_ISREG
(
šode
->
i_mode
è|| 
	`f2fs_is_©omic_fe
(inode))

2532  -
EINVAL
;

2534 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

2535  -
EROFS
;

2537 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f2fs_deäagm’t
 
__u£r
 *)
¬g
,

2538 (
¿nge
)))

2539  -
EFAULT
;

2542 ià(
¿nge
.
¡¬t
 & (
F2FS_BLKSIZE
 - 1è||„ªge.
Ën
 & (F2FS_BLKSIZE - 1))

2543  -
EINVAL
;

2545 ià(
	`uÆik–y
((
¿nge
.
¡¬t
 +„ªge.
Ën
è>> 
PAGE_SHIFT
 >

2546 
sbi
->
max_fe_blocks
))

2547  -
EINVAL
;

2549 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2550 ià(
”r
)

2551  
”r
;

2553 
”r
 = 
	`f2fs_deäagm’t_¿nge
(
sbi
, 
fp
, &
¿nge
);

2554 
	`mÁ_drİ_wr™e_fe
(
fp
);

2556 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

2557 ià(
”r
 < 0)

2558  
”r
;

2560 ià(
	`cİy_to_u£r
((
f2fs_deäagm’t
 
__u£r
 *)
¬g
, &
¿nge
,

2561 (
¿nge
)))

2562  -
EFAULT
;

2565 
	}
}

2567 
	$f2fs_move_fe_¿nge
(
fe
 *
fe_š
, 
loff_t
 
pos_š
,

2568 
fe
 *
fe_out
, 
loff_t
 
pos_out
, 
size_t
 
Ën
)

2570 
šode
 *
¤c
 = 
	`fe_šode
(
fe_š
);

2571 
šode
 *
d¡
 = 
	`fe_šode
(
fe_out
);

2572 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
¤c
);

2573 
size_t
 
Ş’
 = 
Ën
, 
d¡_max_i_size
 = 0;

2574 
size_t
 
d¡_osize
;

2575 
»t
;

2577 ià(
fe_š
->
f_·th
.
mÁ
 !ğ
fe_out
->f_path.mnt ||

2578 
¤c
->
i_sb
 !ğ
d¡
->i_sb)

2579  -
EXDEV
;

2581 ià(
	`uÆik–y
(
	`f2fs_»adÚly
(
¤c
->
i_sb
)))

2582  -
EROFS
;

2584 ià(!
	`S_ISREG
(
¤c
->
i_mode
è|| !S_ISREG(
d¡
->i_mode))

2585  -
EINVAL
;

2587 ià(
	`IS_ENCRYPTED
(
¤c
è|| IS_ENCRYPTED(
d¡
))

2588  -
EOPNOTSUPP
;

2590 ià(
¤c
 =ğ
d¡
) {

2591 ià(
pos_š
 =ğ
pos_out
)

2593 ià(
pos_out
 > 
pos_š
 &&…os_ouˆ<…os_š + 
Ën
)

2594  -
EINVAL
;

2597 
	`šode_lock
(
¤c
);

2598 ià(
¤c
 !ğ
d¡
) {

2599 
»t
 = -
EBUSY
;

2600 ià(!
	`šode_Œylock
(
d¡
))

2601 
out
;

2604 
»t
 = -
EINVAL
;

2605 ià(
pos_š
 + 
Ën
 > 
¤c
->
i_size
 ||…os_in +†en <…os_in)

2606 
out_uÆock
;

2607 ià(
Ën
 == 0)

2608 
Ş’
 = 
Ën
 = 
¤c
->
i_size
 - 
pos_š
;

2609 ià(
pos_š
 + 
Ën
 =ğ
¤c
->
i_size
)

2610 
Ën
 = 
	`ALIGN
(
¤c
->
i_size
, 
F2FS_BLKSIZE
è- 
pos_š
;

2611 ià(
Ën
 == 0) {

2612 
»t
 = 0;

2613 
out_uÆock
;

2616 
d¡_osize
 = 
d¡
->
i_size
;

2617 ià(
pos_out
 + 
Ş’
 > 
d¡
->
i_size
)

2618 
d¡_max_i_size
 = 
pos_out
 + 
Ş’
;

2621 ià(!
	`IS_ALIGNED
(
pos_š
, 
F2FS_BLKSIZE
) ||

2622 !
	`IS_ALIGNED
(
pos_š
 + 
Ën
, 
F2FS_BLKSIZE
) ||

2623 !
	`IS_ALIGNED
(
pos_out
, 
F2FS_BLKSIZE
))

2624 
out_uÆock
;

2626 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
¤c
);

2627 ià(
»t
)

2628 
out_uÆock
;

2630 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
d¡
);

2631 ià(
»t
)

2632 
out_uÆock
;

2635 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
¤c
->
i_m­pšg
,

2636 
pos_š
,…os_š + 
Ën
);

2637 ià(
»t
)

2638 
out_uÆock
;

2640 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
d¡
->
i_m­pšg
,

2641 
pos_out
,…os_ouˆ+ 
Ën
);

2642 ià(
»t
)

2643 
out_uÆock
;

2645 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

2647 
	`down_wr™e
(&
	`F2FS_I
(
¤c
)->
i_gc_rw£m
[
WRITE
]);

2648 ià(
¤c
 !ğ
d¡
) {

2649 
»t
 = -
EBUSY
;

2650 ià(!
	`down_wr™e_Œylock
(&
	`F2FS_I
(
d¡
)->
i_gc_rw£m
[
WRITE
]))

2651 
out_¤c
;

2654 
	`f2fs_lock_İ
(
sbi
);

2655 
»t
 = 
	`__exchªge_d©a_block
(
¤c
, 
d¡
, 
pos_š
 >> 
F2FS_BLKSIZE_BITS
,

2656 
pos_out
 >> 
F2FS_BLKSIZE_BITS
,

2657 
Ën
 >> 
F2FS_BLKSIZE_BITS
, 
çl£
);

2659 ià(!
»t
) {

2660 ià(
d¡_max_i_size
)

2661 
	`f2fs_i_size_wr™e
(
d¡
, 
d¡_max_i_size
);

2662 ià(
d¡_osize
 !ğ
d¡
->
i_size
)

2663 
	`f2fs_i_size_wr™e
(
d¡
, 
d¡_osize
);

2665 
	`f2fs_uÆock_İ
(
sbi
);

2667 ià(
¤c
 !ğ
d¡
)

2668 
	`up_wr™e
(&
	`F2FS_I
(
d¡
)->
i_gc_rw£m
[
WRITE
]);

2669 
out_¤c
:

2670 
	`up_wr™e
(&
	`F2FS_I
(
¤c
)->
i_gc_rw£m
[
WRITE
]);

2671 
out_uÆock
:

2672 ià(
¤c
 !ğ
d¡
)

2673 
	`šode_uÆock
(
d¡
);

2674 
out
:

2675 
	`šode_uÆock
(
¤c
);

2676  
»t
;

2677 
	}
}

2679 
	$f2fs_ioc_move_¿nge
(
fe
 *
fp
, 
¬g
)

2681 
f2fs_move_¿nge
 
¿nge
;

2682 
fd
 
d¡
;

2683 
”r
;

2685 ià(!(
fp
->
f_mode
 & 
FMODE_READ
) ||

2686 !(
fp
->
f_mode
 & 
FMODE_WRITE
))

2687  -
EBADF
;

2689 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f2fs_move_¿nge
 
__u£r
 *)
¬g
,

2690 (
¿nge
)))

2691  -
EFAULT
;

2693 
d¡
 = 
	`fdg‘
(
¿nge
.
d¡_fd
);

2694 ià(!
d¡
.
fe
)

2695  -
EBADF
;

2697 ià(!(
d¡
.
fe
->
f_mode
 & 
FMODE_WRITE
)) {

2698 
”r
 = -
EBADF
;

2699 
”r_out
;

2702 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2703 ià(
”r
)

2704 
”r_out
;

2706 
”r
 = 
	`f2fs_move_fe_¿nge
(
fp
, 
¿nge
.
pos_š
, 
d¡
.
fe
,

2707 
¿nge
.
pos_out
,„ªge.
Ën
);

2709 
	`mÁ_drİ_wr™e_fe
(
fp
);

2710 ià(
”r
)

2711 
”r_out
;

2713 ià(
	`cİy_to_u£r
((
f2fs_move_¿nge
 
__u£r
 *)
¬g
,

2714 &
¿nge
, (range)))

2715 
”r
 = -
EFAULT
;

2716 
”r_out
:

2717 
	`fdput
(
d¡
);

2718  
”r
;

2719 
	}
}

2721 
	$f2fs_ioc_æush_deviû
(
fe
 *
fp
, 
¬g
)

2723 
šode
 *šodğ
	`fe_šode
(
fp
);

2724 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2725 
s™_šfo
 *
sm
 = 
	`SIT_I
(
sbi
);

2726 
¡¬t_£gno
 = 0, 
’d_£gno
 = 0;

2727 
dev_¡¬t_£gno
 = 0, 
dev_’d_£gno
 = 0;

2728 
f2fs_æush_deviû
 
¿nge
;

2729 
»t
;

2731 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2732  -
EPERM
;

2734 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

2735  -
EROFS
;

2737 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)))

2738  -
EINVAL
;

2740 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f2fs_æush_deviû
 
__u£r
 *)
¬g
,

2741 (
¿nge
)))

2742  -
EFAULT
;

2744 ià(!
	`f2fs_is_muÉi_deviû
(
sbi
è|| sbi->
s_ndevs
 - 1 <ğ
¿nge
.
dev_num
 ||

2745 
	`__is_Ïrge_£ùiÚ
(
sbi
)) {

2746 
	`f2fs_w¬n
(
sbi
, "Can't flush %u in %d for segs_per_sec %u != 1",

2747 
¿nge
.
dev_num
, 
sbi
->
s_ndevs
, sbi->
£gs_³r_£c
);

2748  -
EINVAL
;

2751 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2752 ià(
»t
)

2753  
»t
;

2755 ià(
¿nge
.
dev_num
 != 0)

2756 
dev_¡¬t_£gno
 = 
	`GET_SEGNO
(
sbi
, 
	`FDEV
(
¿nge
.
dev_num
).
¡¬t_blk
);

2757 
dev_’d_£gno
 = 
	`GET_SEGNO
(
sbi
, 
	`FDEV
(
¿nge
.
dev_num
).
’d_blk
);

2759 
¡¬t_£gno
 = 
sm
->
Ï¡_viùim
[
FLUSH_DEVICE
];

2760 ià(
¡¬t_£gno
 < 
dev_¡¬t_£gno
 || s¹_£gnØ>ğ
dev_’d_£gno
)

2761 
¡¬t_£gno
 = 
dev_¡¬t_£gno
;

2762 
’d_£gno
 = 
	`mš
(
¡¬t_£gno
 + 
¿nge
.
£gm’ts
, 
dev_’d_£gno
);

2764 
¡¬t_£gno
 < 
’d_£gno
) {

2765 ià(!
	`mu‹x_Œylock
(&
sbi
->
gc_mu‹x
)) {

2766 
»t
 = -
EBUSY
;

2767 
out
;

2769 
sm
->
Ï¡_viùim
[
GC_CB
] = 
’d_£gno
 + 1;

2770 
sm
->
Ï¡_viùim
[
GC_GREEDY
] = 
’d_£gno
 + 1;

2771 
sm
->
Ï¡_viùim
[
ALLOC_NEXT
] = 
’d_£gno
 + 1;

2772 
»t
 = 
	`f2fs_gc
(
sbi
, 
Œue
,rue, 
¡¬t_£gno
);

2773 ià(
»t
 =ğ-
EAGAIN
)

2774 
»t
 = 0;

2775 ià(
»t
 < 0)

2777 
¡¬t_£gno
++;

2779 
out
:

2780 
	`mÁ_drİ_wr™e_fe
(
fp
);

2781  
»t
;

2782 
	}
}

2784 
	$f2fs_ioc_g‘_ã©u»s
(
fe
 *
fp
, 
¬g
)

2786 
šode
 *šodğ
	`fe_šode
(
fp
);

2787 
u32
 
sb_ã©u»
 = 
	`Ë32_to_ıu
(
	`F2FS_I_SB
(
šode
)->
¿w_su³r
->
ã©u»
);

2790 
sb_ã©u»
 |ğ
F2FS_FEATURE_ATOMIC_WRITE
;

2792  
	`put_u£r
(
sb_ã©u»
, (
u32
 
__u£r
 *)
¬g
);

2793 
	}
}

2795 #ifdeà
CONFIG_QUOTA


2796 
	$f2fs_Œªsãr_´ojeù_quÙa
(
šode
 *šode, 
k´ojid_t
 
k´ojid
)

2798 
dquÙ
 *
Œªsãr_to
[
MAXQUOTAS
] = {};

2799 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2800 
su³r_block
 *
sb
 = 
sbi
->sb;

2801 
”r
 = 0;

2803 
Œªsãr_to
[
PRJQUOTA
] = 
	`dqg‘
(
sb
, 
	`make_kqid_´ojid
(
k´ojid
));

2804 ià(!
	`IS_ERR
(
Œªsãr_to
[
PRJQUOTA
])) {

2805 
”r
 = 
	`__dquÙ_Œªsãr
(
šode
, 
Œªsãr_to
);

2806 ià(
”r
)

2807 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
);

2808 
	`dqput
(
Œªsãr_to
[
PRJQUOTA
]);

2810  
”r
;

2811 
	}
}

2813 
	$f2fs_ioc_£rojeù
(
fe
 *
fp
, 
__u32
 
´ojid
)

2815 
šode
 *šodğ
	`fe_šode
(
fp
);

2816 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

2817 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2818 
·ge
 *
age
;

2819 
k´ojid_t
 
k´ojid
;

2820 
”r
;

2822 ià(!
	`f2fs_sb_has_´ojeù_quÙa
(
sbi
)) {

2823 ià(
´ojid
 !ğ
F2FS_DEF_PROJID
)

2824  -
EOPNOTSUPP
;

2829 ià(!
	`f2fs_has_exŒa_©Œ
(
šode
))

2830  -
EOPNOTSUPP
;

2832 
k´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, (
´ojid_t
)
´ojid
);

2834 ià(
	`´ojid_eq
(
k´ojid
, 
	`F2FS_I
(
šode
)->
i_´ojid
))

2837 
”r
 = -
EPERM
;

2839 ià(
	`IS_NOQUOTA
(
šode
))

2840  
”r
;

2842 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

2843 ià(
	`IS_ERR
(
age
))

2844  
	`PTR_ERR
(
age
);

2846 ià(!
	`F2FS_FITS_IN_INODE
(
	`F2FS_INODE
(
age
), 
fi
->
i_exŒa_isize
,

2847 
i_´ojid
)) {

2848 
”r
 = -
EOVERFLOW
;

2849 
	`f2fs_put_·ge
(
age
, 1);

2850  
”r
;

2852 
	`f2fs_put_·ge
(
age
, 1);

2854 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

2855 ià(
”r
)

2856  
”r
;

2858 
	`f2fs_lock_İ
(
sbi
);

2859 
”r
 = 
	`f2fs_Œªsãr_´ojeù_quÙa
(
šode
, 
k´ojid
);

2860 ià(
”r
)

2861 
out_uÆock
;

2863 
	`F2FS_I
(
šode
)->
i_´ojid
 = 
k´ojid
;

2864 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

2865 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

2866 
out_uÆock
:

2867 
	`f2fs_uÆock_İ
(
sbi
);

2868  
”r
;

2869 
	}
}

2871 
	$f2fs_Œªsãr_´ojeù_quÙa
(
šode
 *šode, 
k´ojid_t
 
k´ojid
)

2874 
	}
}

2876 
	$f2fs_ioc_£rojeù
(
fe
 *
fp
, 
__u32
 
´ojid
)

2878 ià(
´ojid
 !ğ
F2FS_DEF_PROJID
)

2879  -
EOPNOTSUPP
;

2881 
	}
}

2893 
u32
 
	miæag
;

2894 
u32
 
	mxæag
;

2895 } 
	gf2fs_xæags_m­
[] = {

2896 { 
F2FS_SYNC_FL
, 
FS_XFLAG_SYNC
 },

2897 { 
F2FS_IMMUTABLE_FL
, 
FS_XFLAG_IMMUTABLE
 },

2898 { 
F2FS_APPEND_FL
, 
FS_XFLAG_APPEND
 },

2899 { 
F2FS_NODUMP_FL
, 
FS_XFLAG_NODUMP
 },

2900 { 
F2FS_NOATIME_FL
, 
FS_XFLAG_NOATIME
 },

2901 { 
F2FS_PROJINHERIT_FL
, 
FS_XFLAG_PROJINHERIT
 },

2904 
	#F2FS_SUPPORTED_XFLAGS
 ( \

2905 
FS_XFLAG_SYNC
 | \

2906 
FS_XFLAG_IMMUTABLE
 | \

2907 
FS_XFLAG_APPEND
 | \

2908 
FS_XFLAG_NODUMP
 | \

2909 
FS_XFLAG_NOATIME
 | \

2910 
FS_XFLAG_PROJINHERIT
)

	)

2913 
šlše
 
u32
 
	$f2fs_iæags_to_xæags
(
u32
 
iæags
)

2915 
u32
 
xæags
 = 0;

2916 
i
;

2918 
i
 = 0; i < 
	`ARRAY_SIZE
(
f2fs_xæags_m­
); i++)

2919 ià(
iæags
 & 
f2fs_xæags_m­
[
i
].
iæag
)

2920 
xæags
 |ğ
f2fs_xæags_m­
[
i
].
xæag
;

2922  
xæags
;

2923 
	}
}

2926 
šlše
 
u32
 
	$f2fs_xæags_to_iæags
(
u32
 
xæags
)

2928 
u32
 
iæags
 = 0;

2929 
i
;

2931 
i
 = 0; i < 
	`ARRAY_SIZE
(
f2fs_xæags_m­
); i++)

2932 ià(
xæags
 & 
f2fs_xæags_m­
[
i
].
xæag
)

2933 
iæags
 |ğ
f2fs_xæags_m­
[
i
].
iæag
;

2935  
iæags
;

2936 
	}
}

2938 
	$f2fs_fl_fsx©Œ
(
šode
 *šode, 
fsx©Œ
 *
ç
)

2940 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

2942 
	`sim¶e_fl_fsx©Œ
(
ç
, 
	`f2fs_iæags_to_xæags
(
fi
->
i_æags
));

2944 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
	`F2FS_I_SB
(
šode
)))

2945 
ç
->
fsx_´ojid
 = 
	`äom_k´ojid
(&
š™_u£r_ns
, 
fi
->
i_´ojid
);

2946 
	}
}

2948 
	$f2fs_ioc_fsg‘x©Œ
(
fe
 *
fp
, 
¬g
)

2950 
šode
 *šodğ
	`fe_šode
(
fp
);

2951 
fsx©Œ
 
ç
;

2953 
	`f2fs_fl_fsx©Œ
(
šode
, &
ç
);

2955 ià(
	`cİy_to_u£r
((
fsx©Œ
 
__u£r
 *)
¬g
, &
ç
, (fa)))

2956  -
EFAULT
;

2958 
	}
}

2960 
	$f2fs_ioc_fs£tx©Œ
(
fe
 *
fp
, 
¬g
)

2962 
šode
 *šodğ
	`fe_šode
(
fp
);

2963 
fsx©Œ
 
ç
, 
Şd_ç
;

2964 
u32
 
iæags
;

2965 
”r
;

2967 ià(
	`cİy_äom_u£r
(&
ç
, (
fsx©Œ
 
__u£r
 *)
¬g
, (fa)))

2968  -
EFAULT
;

2971 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

2972  -
EACCES
;

2974 ià(
ç
.
fsx_xæags
 & ~
F2FS_SUPPORTED_XFLAGS
)

2975  -
EOPNOTSUPP
;

2977 
iæags
 = 
	`f2fs_xæags_to_iæags
(
ç
.
fsx_xæags
);

2978 ià(
	`f2fs_mask_æags
(
šode
->
i_mode
, 
iæags
) != iflags)

2979  -
EOPNOTSUPP
;

2981 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

2982 ià(
”r
)

2983  
”r
;

2985 
	`šode_lock
(
šode
);

2987 
	`f2fs_fl_fsx©Œ
(
šode
, &
Şd_ç
);

2988 
”r
 = 
	`vfs_ioc_fs£tx©Œ_check
(
šode
, &
Şd_ç
, &
ç
);

2989 ià(
”r
)

2990 
out
;

2992 
”r
 = 
	`f2fs_£tæags_commÚ
(
šode
, 
iæags
,

2993 
	`f2fs_xæags_to_iæags
(
F2FS_SUPPORTED_XFLAGS
));

2994 ià(
”r
)

2995 
out
;

2997 
”r
 = 
	`f2fs_ioc_£rojeù
(
fp
, 
ç
.
fsx_´ojid
);

2998 
out
:

2999 
	`šode_uÆock
(
šode
);

3000 
	`mÁ_drİ_wr™e_fe
(
fp
);

3001  
”r
;

3002 
	}
}

3004 
	$f2fs_pš_fe_cÚŒŞ
(
šode
 *šode, 
boŞ
 
šc
)

3006 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

3007 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

3010 ià(
šc
)

3011 
	`f2fs_i_gc_çu»s_wr™e
(
šode
,

3012 
fi
->
i_gc_çu»s
[
GC_FAILURE_PIN
] + 1);

3014 ià(
fi
->
i_gc_çu»s
[
GC_FAILURE_PIN
] > 
sbi
->
gc_pš_fe_th»shŞd
) {

3015 
	`f2fs_w¬n
(
sbi
, "%s: Enable GC = ino %lx‡fter %x GCrials",

3016 
__func__
, 
šode
->
i_šo
,

3017 
fi
->
i_gc_çu»s
[
GC_FAILURE_PIN
]);

3018 
	`ş—r_šode_æag
(
šode
, 
FI_PIN_FILE
);

3019  -
EAGAIN
;

3022 
	}
}

3024 
	$f2fs_ioc_£t_pš_fe
(
fe
 *
fp
, 
¬g
)

3026 
šode
 *šodğ
	`fe_šode
(
fp
);

3027 
__u32
 
pš
;

3028 
»t
 = 0;

3030 ià(
	`g‘_u£r
(
pš
, (
__u32
 
__u£r
 *)
¬g
))

3031  -
EFAULT
;

3033 ià(!
	`S_ISREG
(
šode
->
i_mode
))

3034  -
EINVAL
;

3036 ià(
	`f2fs_»adÚly
(
	`F2FS_I_SB
(
šode
)->
sb
))

3037  -
EROFS
;

3039 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

3040 ià(
»t
)

3041  
»t
;

3043 
	`šode_lock
(
šode
);

3045 ià(
	`f2fs_should_upd©e_ouÏû
(
šode
, 
NULL
)) {

3046 
»t
 = -
EINVAL
;

3047 
out
;

3050 ià(!
pš
) {

3051 
	`ş—r_šode_æag
(
šode
, 
FI_PIN_FILE
);

3052 
	`f2fs_i_gc_çu»s_wr™e
(
šode
, 0);

3053 
dÚe
;

3056 ià(
	`f2fs_pš_fe_cÚŒŞ
(
šode
, 
çl£
)) {

3057 
»t
 = -
EAGAIN
;

3058 
out
;

3060 
»t
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

3061 ià(
»t
)

3062 
out
;

3064 
	`£t_šode_æag
(
šode
, 
FI_PIN_FILE
);

3065 
»t
 = 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_PIN
];

3066 
dÚe
:

3067 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

3068 
out
:

3069 
	`šode_uÆock
(
šode
);

3070 
	`mÁ_drİ_wr™e_fe
(
fp
);

3071  
»t
;

3072 
	}
}

3074 
	$f2fs_ioc_g‘_pš_fe
(
fe
 *
fp
, 
¬g
)

3076 
šode
 *šodğ
	`fe_šode
(
fp
);

3077 
__u32
 
pš
 = 0;

3079 ià(
	`is_šode_æag_£t
(
šode
, 
FI_PIN_FILE
))

3080 
pš
 = 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_PIN
];

3081  
	`put_u£r
(
pš
, (
u32
 
__u£r
 *)
¬g
);

3082 
	}
}

3084 
	$f2fs_´eÿche_ex‹Ás
(
šode
 *inode)

3086 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

3087 
f2fs_m­_blocks
 
m­
;

3088 
pgoff_t
 
m_Ãxt_ex‹Á
;

3089 
loff_t
 
’d
;

3090 
”r
;

3092 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NO_EXTENT
))

3093  -
EOPNOTSUPP
;

3095 
m­
.
m_lblk
 = 0;

3096 
m­
.
m_Ãxt_pgofs
 = 
NULL
;

3097 
m­
.
m_Ãxt_ex‹Á
 = &m_next_extent;

3098 
m­
.
m_£g_ty³
 = 
NO_CHECK_TYPE
;

3099 
m­
.
m_may_ü—‹
 = 
çl£
;

3100 
’d
 = 
	`F2FS_I_SB
(
šode
)->
max_fe_blocks
;

3102 
m­
.
m_lblk
 < 
’d
) {

3103 
m­
.
m_Ën
 = 
’d
 - m­.
m_lblk
;

3105 
	`down_wr™e
(&
fi
->
i_gc_rw£m
[
WRITE
]);

3106 
”r
 = 
	`f2fs_m­_blocks
(
šode
, &
m­
, 0, 
F2FS_GET_BLOCK_PRECACHE
);

3107 
	`up_wr™e
(&
fi
->
i_gc_rw£m
[
WRITE
]);

3108 ià(
”r
)

3109  
”r
;

3111 
m­
.
m_lblk
 = 
m_Ãxt_ex‹Á
;

3114  
”r
;

3115 
	}
}

3117 
	$f2fs_ioc_´eÿche_ex‹Ás
(
fe
 *
fp
, 
¬g
)

3119  
	`f2fs_´eÿche_ex‹Ás
(
	`fe_šode
(
fp
));

3120 
	}
}

3122 
	$f2fs_ioc_»size_fs
(
fe
 *
fp
, 
¬g
)

3124 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
	`fe_šode
(
fp
));

3125 
__u64
 
block_couÁ
;

3126 
»t
;

3128 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3129  -
EPERM
;

3131 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

3132  -
EROFS
;

3134 ià(
	`cİy_äom_u£r
(&
block_couÁ
, (
__u£r
 *)
¬g
,

3135 (
block_couÁ
)))

3136  -
EFAULT
;

3138 
»t
 = 
	`f2fs_»size_fs
(
sbi
, 
block_couÁ
);

3140  
»t
;

3141 
	}
}

3143 
	$f2fs_ioc_’abË_v”™y
(
fe
 *
fp
, 
¬g
)

3145 
šode
 *šodğ
	`fe_šode
(
fp
);

3147 
	`f2fs_upd©e_time
(
	`F2FS_I_SB
(
šode
), 
REQ_TIME
);

3149 ià(!
	`f2fs_sb_has_v”™y
(
	`F2FS_I_SB
(
šode
))) {

3150 
	`f2fs_w¬n
(
	`F2FS_I_SB
(
šode
),

3152 
šode
->
i_šo
);

3153  -
EOPNOTSUPP
;

3156  
	`fsv”™y_ioùl_’abË
(
fp
, (cÚ¡ 
__u£r
 *)
¬g
);

3157 
	}
}

3159 
	$f2fs_ioc_m—su»_v”™y
(
fe
 *
fp
, 
¬g
)

3161 ià(!
	`f2fs_sb_has_v”™y
(
	`F2FS_I_SB
(
	`fe_šode
(
fp
))))

3162  -
EOPNOTSUPP
;

3164  
	`fsv”™y_ioùl_m—su»
(
fp
, (
__u£r
 *)
¬g
);

3165 
	}
}

3167 
	$f2fs_g‘_vŞume_Çme
(
fe
 *
fp
, 
¬g
)

3169 
šode
 *šodğ
	`fe_šode
(
fp
);

3170 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

3171 *
vbuf
;

3172 
couÁ
;

3173 
”r
 = 0;

3175 
vbuf
 = 
	`f2fs_kz®loc
(
sbi
, 
MAX_VOLUME_NAME
, 
GFP_KERNEL
);

3176 ià(!
vbuf
)

3177  -
ENOMEM
;

3179 
	`down_»ad
(&
sbi
->
sb_lock
);

3180 
couÁ
 = 
	`utf16s_to_utf8s
(
sbi
->
¿w_su³r
->
vŞume_Çme
,

3181 
	`ARRAY_SIZE
(
sbi
->
¿w_su³r
->
vŞume_Çme
),

3182 
UTF16_LITTLE_ENDIAN
, 
vbuf
, 
MAX_VOLUME_NAME
);

3183 
	`up_»ad
(&
sbi
->
sb_lock
);

3185 ià(
	`cİy_to_u£r
((
__u£r
 *)
¬g
, 
vbuf
,

3186 
	`mš
(
FSLABEL_MAX
, 
couÁ
)))

3187 
”r
 = -
EFAULT
;

3189 
	`kvä“
(
vbuf
);

3190  
”r
;

3191 
	}
}

3193 
	$f2fs_£t_vŞume_Çme
(
fe
 *
fp
, 
¬g
)

3195 
šode
 *šodğ
	`fe_šode
(
fp
);

3196 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

3197 *
vbuf
;

3198 
”r
 = 0;

3200 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3201  -
EPERM
;

3203 
vbuf
 = 
	`¡ºdup_u£r
((cÚ¡ 
__u£r
 *)
¬g
, 
FSLABEL_MAX
);

3204 ià(
	`IS_ERR
(
vbuf
))

3205  
	`PTR_ERR
(
vbuf
);

3207 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

3208 ià(
”r
)

3209 
out
;

3211 
	`down_wr™e
(&
sbi
->
sb_lock
);

3213 
	`mem£t
(
sbi
->
¿w_su³r
->
vŞume_Çme
, 0,

3214 (
sbi
->
¿w_su³r
->
vŞume_Çme
));

3215 
	`utf8s_to_utf16s
(
vbuf
, 
	`¡¾’
(vbuf), 
UTF16_LITTLE_ENDIAN
,

3216 
sbi
->
¿w_su³r
->
vŞume_Çme
,

3217 
	`ARRAY_SIZE
(
sbi
->
¿w_su³r
->
vŞume_Çme
));

3219 
”r
 = 
	`f2fs_comm™_su³r
(
sbi
, 
çl£
);

3221 
	`up_wr™e
(&
sbi
->
sb_lock
);

3223 
	`mÁ_drİ_wr™e_fe
(
fp
);

3224 
out
:

3225 
	`kä“
(
vbuf
);

3226  
”r
;

3227 
	}
}

3229 
	$f2fs_ioùl
(
fe
 *
fp
, 
cmd
, 
¬g
)

3231 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
	`fe_šode
(
fp
)))))

3232  -
EIO
;

3233 ià(!
	`f2fs_is_checkpošt_»ady
(
	`F2FS_I_SB
(
	`fe_šode
(
fp
))))

3234  -
ENOSPC
;

3236 
cmd
) {

3237 
F2FS_IOC_GETFLAGS
:

3238  
	`f2fs_ioc_g‘æags
(
fp
, 
¬g
);

3239 
F2FS_IOC_SETFLAGS
:

3240  
	`f2fs_ioc_£tæags
(
fp
, 
¬g
);

3241 
F2FS_IOC_GETVERSION
:

3242  
	`f2fs_ioc_g‘v”siÚ
(
fp
, 
¬g
);

3243 
F2FS_IOC_START_ATOMIC_WRITE
:

3244  
	`f2fs_ioc_¡¬t_©omic_wr™e
(
fp
);

3245 
F2FS_IOC_COMMIT_ATOMIC_WRITE
:

3246  
	`f2fs_ioc_comm™_©omic_wr™e
(
fp
);

3247 
F2FS_IOC_START_VOLATILE_WRITE
:

3248  
	`f2fs_ioc_¡¬t_vŞ©e_wr™e
(
fp
);

3249 
F2FS_IOC_RELEASE_VOLATILE_WRITE
:

3250  
	`f2fs_ioc_»Ëa£_vŞ©e_wr™e
(
fp
);

3251 
F2FS_IOC_ABORT_VOLATILE_WRITE
:

3252  
	`f2fs_ioc_abÜt_vŞ©e_wr™e
(
fp
);

3253 
F2FS_IOC_SHUTDOWN
:

3254  
	`f2fs_ioc_shutdown
(
fp
, 
¬g
);

3255 
FITRIM
:

3256  
	`f2fs_ioc_f™rim
(
fp
, 
¬g
);

3257 
F2FS_IOC_SET_ENCRYPTION_POLICY
:

3258  
	`f2fs_ioc_£t_’üy±iÚ_pŞicy
(
fp
, 
¬g
);

3259 
F2FS_IOC_GET_ENCRYPTION_POLICY
:

3260  
	`f2fs_ioc_g‘_’üy±iÚ_pŞicy
(
fp
, 
¬g
);

3261 
F2FS_IOC_GET_ENCRYPTION_PWSALT
:

3262  
	`f2fs_ioc_g‘_’üy±iÚ_pw§É
(
fp
, 
¬g
);

3263 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

3264  
	`f2fs_ioc_g‘_’üy±iÚ_pŞicy_ex
(
fp
, 
¬g
);

3265 
FS_IOC_ADD_ENCRYPTION_KEY
:

3266  
	`f2fs_ioc_add_’üy±iÚ_key
(
fp
, 
¬g
);

3267 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

3268  
	`f2fs_ioc_»move_’üy±iÚ_key
(
fp
, 
¬g
);

3269 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

3270  
	`f2fs_ioc_»move_’üy±iÚ_key_®l_u£rs
(
fp
, 
¬g
);

3271 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

3272  
	`f2fs_ioc_g‘_’üy±iÚ_key_¡©us
(
fp
, 
¬g
);

3273 
F2FS_IOC_GARBAGE_COLLECT
:

3274  
	`f2fs_ioc_gc
(
fp
, 
¬g
);

3275 
F2FS_IOC_GARBAGE_COLLECT_RANGE
:

3276  
	`f2fs_ioc_gc_¿nge
(
fp
, 
¬g
);

3277 
F2FS_IOC_WRITE_CHECKPOINT
:

3278  
	`f2fs_ioc_wr™e_checkpošt
(
fp
, 
¬g
);

3279 
F2FS_IOC_DEFRAGMENT
:

3280  
	`f2fs_ioc_deäagm’t
(
fp
, 
¬g
);

3281 
F2FS_IOC_MOVE_RANGE
:

3282  
	`f2fs_ioc_move_¿nge
(
fp
, 
¬g
);

3283 
F2FS_IOC_FLUSH_DEVICE
:

3284  
	`f2fs_ioc_æush_deviû
(
fp
, 
¬g
);

3285 
F2FS_IOC_GET_FEATURES
:

3286  
	`f2fs_ioc_g‘_ã©u»s
(
fp
, 
¬g
);

3287 
F2FS_IOC_FSGETXATTR
:

3288  
	`f2fs_ioc_fsg‘x©Œ
(
fp
, 
¬g
);

3289 
F2FS_IOC_FSSETXATTR
:

3290  
	`f2fs_ioc_fs£tx©Œ
(
fp
, 
¬g
);

3291 
F2FS_IOC_GET_PIN_FILE
:

3292  
	`f2fs_ioc_g‘_pš_fe
(
fp
, 
¬g
);

3293 
F2FS_IOC_SET_PIN_FILE
:

3294  
	`f2fs_ioc_£t_pš_fe
(
fp
, 
¬g
);

3295 
F2FS_IOC_PRECACHE_EXTENTS
:

3296  
	`f2fs_ioc_´eÿche_ex‹Ás
(
fp
, 
¬g
);

3297 
F2FS_IOC_RESIZE_FS
:

3298  
	`f2fs_ioc_»size_fs
(
fp
, 
¬g
);

3299 
FS_IOC_ENABLE_VERITY
:

3300  
	`f2fs_ioc_’abË_v”™y
(
fp
, 
¬g
);

3301 
FS_IOC_MEASURE_VERITY
:

3302  
	`f2fs_ioc_m—su»_v”™y
(
fp
, 
¬g
);

3303 
F2FS_IOC_GET_VOLUME_NAME
:

3304  
	`f2fs_g‘_vŞume_Çme
(
fp
, 
¬g
);

3305 
F2FS_IOC_SET_VOLUME_NAME
:

3306  
	`f2fs_£t_vŞume_Çme
(
fp
, 
¬g
);

3308  -
ENOTTY
;

3310 
	}
}

3312 
ssize_t
 
	$f2fs_fe_wr™e_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

3314 
fe
 *fğ
iocb
->
ki_fp
;

3315 
šode
 *šodğ
	`fe_šode
(
fe
);

3316 
ssize_t
 
»t
;

3318 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
)))) {

3319 
»t
 = -
EIO
;

3320 
out
;

3323 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) {

3324 ià(!
	`šode_Œylock
(
šode
)) {

3325 
»t
 = -
EAGAIN
;

3326 
out
;

3329 
	`šode_lock
(
šode
);

3332 
»t
 = 
	`g’”ic_wr™e_checks
(
iocb
, 
äom
);

3333 ià(
»t
 > 0) {

3334 
boŞ
 
´—Îoÿ‹d
 = 
çl£
;

3335 
size_t
 
rg‘_size
 = 0;

3336 
”r
;

3338 ià(
	`iov_™”_çuÉ_š_»adabË
(
äom
, 
	`iov_™”_couÁ
(from)))

3339 
	`£t_šode_æag
(
šode
, 
FI_NO_PREALLOC
);

3341 ià((
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)) {

3342 ià(!
	`f2fs_ov”wr™e_io
(
šode
, 
iocb
->
ki_pos
,

3343 
	`iov_™”_couÁ
(
äom
)) ||

3344 
	`f2fs_has_šlše_d©a
(
šode
) ||

3345 
	`f2fs_fÜû_bufã»d_io
(
šode
, 
iocb
, 
äom
)) {

3346 
	`ş—r_šode_æag
(
šode
, 
FI_NO_PREALLOC
);

3347 
	`šode_uÆock
(
šode
);

3348 
»t
 = -
EAGAIN
;

3349 
out
;

3352 
´—Îoÿ‹d
 = 
Œue
;

3353 
rg‘_size
 = 
iocb
->
ki_pos
 + 
	`iov_™”_couÁ
(
äom
);

3355 
”r
 = 
	`f2fs_´—Îoÿ‹_blocks
(
iocb
, 
äom
);

3356 ià(
”r
) {

3357 
	`ş—r_šode_æag
(
šode
, 
FI_NO_PREALLOC
);

3358 
	`šode_uÆock
(
šode
);

3359 
»t
 = 
”r
;

3360 
out
;

3363 
»t
 = 
	`__g’”ic_fe_wr™e_™”
(
iocb
, 
äom
);

3364 
	`ş—r_šode_æag
(
šode
, 
FI_NO_PREALLOC
);

3367 ià(
´—Îoÿ‹d
 && 
	`i_size_»ad
(
šode
è< 
rg‘_size
)

3368 
	`f2fs_Œunÿ‹
(
šode
);

3370 ià(
»t
 > 0)

3371 
	`f2fs_upd©e_io¡©
(
	`F2FS_I_SB
(
šode
), 
APP_WRITE_IO
, 
»t
);

3373 
	`šode_uÆock
(
šode
);

3374 
out
:

3375 
	`Œaû_f2fs_fe_wr™e_™”
(
šode
, 
iocb
->
ki_pos
,

3376 
	`iov_™”_couÁ
(
äom
), 
»t
);

3377 ià(
»t
 > 0)

3378 
»t
 = 
	`g’”ic_wr™e_sync
(
iocb
,„et);

3379  
»t
;

3380 
	}
}

3382 #ifdeà
CONFIG_COMPAT


3383 
	$f2fs_com·t_ioùl
(
fe
 *fe, 
cmd
, 
¬g
)

3385 
cmd
) {

3386 
F2FS_IOC32_GETFLAGS
:

3387 
cmd
 = 
F2FS_IOC_GETFLAGS
;

3389 
F2FS_IOC32_SETFLAGS
:

3390 
cmd
 = 
F2FS_IOC_SETFLAGS
;

3392 
F2FS_IOC32_GETVERSION
:

3393 
cmd
 = 
F2FS_IOC_GETVERSION
;

3395 
F2FS_IOC_START_ATOMIC_WRITE
:

3396 
F2FS_IOC_COMMIT_ATOMIC_WRITE
:

3397 
F2FS_IOC_START_VOLATILE_WRITE
:

3398 
F2FS_IOC_RELEASE_VOLATILE_WRITE
:

3399 
F2FS_IOC_ABORT_VOLATILE_WRITE
:

3400 
F2FS_IOC_SHUTDOWN
:

3401 
F2FS_IOC_SET_ENCRYPTION_POLICY
:

3402 
F2FS_IOC_GET_ENCRYPTION_PWSALT
:

3403 
F2FS_IOC_GET_ENCRYPTION_POLICY
:

3404 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

3405 
FS_IOC_ADD_ENCRYPTION_KEY
:

3406 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

3407 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

3408 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

3409 
F2FS_IOC_GARBAGE_COLLECT
:

3410 
F2FS_IOC_GARBAGE_COLLECT_RANGE
:

3411 
F2FS_IOC_WRITE_CHECKPOINT
:

3412 
F2FS_IOC_DEFRAGMENT
:

3413 
F2FS_IOC_MOVE_RANGE
:

3414 
F2FS_IOC_FLUSH_DEVICE
:

3415 
F2FS_IOC_GET_FEATURES
:

3416 
F2FS_IOC_FSGETXATTR
:

3417 
F2FS_IOC_FSSETXATTR
:

3418 
F2FS_IOC_GET_PIN_FILE
:

3419 
F2FS_IOC_SET_PIN_FILE
:

3420 
F2FS_IOC_PRECACHE_EXTENTS
:

3421 
F2FS_IOC_RESIZE_FS
:

3422 
FS_IOC_ENABLE_VERITY
:

3423 
FS_IOC_MEASURE_VERITY
:

3424 
F2FS_IOC_GET_VOLUME_NAME
:

3425 
F2FS_IOC_SET_VOLUME_NAME
:

3428  -
ENOIOCTLCMD
;

3430  
	`f2fs_ioùl
(
fe
, 
cmd
, (è
	`com·t_±r
(
¬g
));

3431 
	}
}

3434 cÚ¡ 
fe_İ”©iÚs
 
	gf2fs_fe_İ”©iÚs
 = {

3435 .
Î£ek
 = 
f2fs_Î£ek
,

3436 .
	g»ad_™”
 = 
g’”ic_fe_»ad_™”
,

3437 .
	gwr™e_™”
 = 
f2fs_fe_wr™e_™”
,

3438 .
	gİ’
 = 
f2fs_fe_İ’
,

3439 .
	g»Ëa£
 = 
f2fs_»Ëa£_fe
,

3440 .
	gmm­
 = 
f2fs_fe_mm­
,

3441 .
	gæush
 = 
f2fs_fe_æush
,

3442 .
	gfsync
 = 
f2fs_sync_fe
,

3443 .
	gçÎoÿ‹
 = 
f2fs_çÎoÿ‹
,

3444 .
	guÆocked_ioùl
 = 
f2fs_ioùl
,

3445 #ifdeà
CONFIG_COMPAT


3446 .
	gcom·t_ioùl
 = 
f2fs_com·t_ioùl
,

3448 .
	g¥liû_»ad
 = 
g’”ic_fe_¥liû_»ad
,

3449 .
	g¥liû_wr™e
 = 
™”_fe_¥liû_wr™e
,

	@gc.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/moduË.h
>

10 
	~<lšux/backšg-dev.h
>

11 
	~<lšux/š™.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/kth»ad.h
>

14 
	~<lšux/d–ay.h
>

15 
	~<lšux/ä“z”.h
>

17 
	~"f2fs.h
"

18 
	~"node.h
"

19 
	~"£gm’t.h
"

20 
	~"gc.h
"

21 
	~<Œaû/ev’ts/f2fs.h
>

23 
	$gc_th»ad_func
(*
d©a
)

25 
f2fs_sb_šfo
 *
sbi
 = 
d©a
;

26 
f2fs_gc_kth»ad
 *
gc_th
 = 
sbi
->
gc_th»ad
;

27 
wa™_queue_h—d_t
 *
wq
 = &
sbi
->
gc_th»ad
->
gc_wa™_queue_h—d
;

28 
wa™_ms
;

30 
wa™_ms
 = 
gc_th
->
mš_¦“p_time
;

32 
	`£t_ä“zabË
();

34 
	`wa™_ev’t_š‹¼u±ibË_timeout
(*
wq
,

35 
	`kth»ad_should_¡İ
(è|| 
	`ä“zšg
(
cu¼’t
) ||

36 
gc_th
->
gc_wake
,

37 
	`m£cs_to_jiff›s
(
wa™_ms
));

40 ià(
gc_th
->
gc_wake
)

41 
gc_th
->
gc_wake
 = 0;

43 ià(
	`Œy_to_ä“ze
()) {

44 
	`¡©_Ùh”_sk_bggc_couÁ
(
sbi
);

47 ià(
	`kth»ad_should_¡İ
())

50 ià(
sbi
->
sb
->
s_wr™”s
.
äoz’
 >ğ
SB_FREEZE_WRITE
) {

51 
	`šü—£_¦“p_time
(
gc_th
, &
wa™_ms
);

52 
	`¡©_Ùh”_sk_bggc_couÁ
(
sbi
);

56 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_CHECKPOINT
)) {

57 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_CHECKPOINT
);

58 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

61 ià(!
	`sb_¡¬t_wr™e_Œylock
(
sbi
->
sb
)) {

62 
	`¡©_Ùh”_sk_bggc_couÁ
(
sbi
);

79 ià(
sbi
->
gc_mode
 =ğ
GC_URGENT
) {

80 
wa™_ms
 = 
gc_th
->
urg’t_¦“p_time
;

81 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

82 
do_gc
;

85 ià(!
	`mu‹x_Œylock
(&
sbi
->
gc_mu‹x
)) {

86 
	`¡©_Ùh”_sk_bggc_couÁ
(
sbi
);

87 
Ãxt
;

90 ià(!
	`is_idË
(
sbi
, 
GC_TIME
)) {

91 
	`šü—£_¦“p_time
(
gc_th
, &
wa™_ms
);

92 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

93 
	`¡©_io_sk_bggc_couÁ
(
sbi
);

94 
Ãxt
;

97 ià(
	`has_’ough_šv®id_blocks
(
sbi
))

98 
	`deü—£_¦“p_time
(
gc_th
, &
wa™_ms
);

100 
	`šü—£_¦“p_time
(
gc_th
, &
wa™_ms
);

101 
do_gc
:

102 
	`¡©_šc_bggc_couÁ
(
sbi
);

105 ià(
	`f2fs_gc
(
sbi
, 
	`‹¡_İt
(sbi, 
FORCE_FG_GC
), 
Œue
, 
NULL_SEGNO
))

106 
wa™_ms
 = 
gc_th
->
no_gc_¦“p_time
;

108 
	`Œaû_f2fs_background_gc
(
sbi
->
sb
, 
wa™_ms
,

109 
	`´eä“_£gm’ts
(
sbi
), 
	`ä“_£gm’ts
(sbi));

112 
	`f2fs_b®ªû_fs_bg
(
sbi
);

113 
Ãxt
:

114 
	`sb_’d_wr™e
(
sbi
->
sb
);

116 } !
	`kth»ad_should_¡İ
());

118 
	}
}

120 
	$f2fs_¡¬t_gc_th»ad
(
f2fs_sb_šfo
 *
sbi
)

122 
f2fs_gc_kth»ad
 *
gc_th
;

123 
dev_t
 
dev
 = 
sbi
->
sb
->
s_bdev
->
bd_dev
;

124 
”r
 = 0;

126 
gc_th
 = 
	`f2fs_km®loc
(
sbi
, (
f2fs_gc_kth»ad
), 
GFP_KERNEL
);

127 ià(!
gc_th
) {

128 
”r
 = -
ENOMEM
;

129 
out
;

132 
gc_th
->
urg’t_¦“p_time
 = 
DEF_GC_THREAD_URGENT_SLEEP_TIME
;

133 
gc_th
->
mš_¦“p_time
 = 
DEF_GC_THREAD_MIN_SLEEP_TIME
;

134 
gc_th
->
max_¦“p_time
 = 
DEF_GC_THREAD_MAX_SLEEP_TIME
;

135 
gc_th
->
no_gc_¦“p_time
 = 
DEF_GC_THREAD_NOGC_SLEEP_TIME
;

137 
gc_th
->
gc_wake
= 0;

139 
sbi
->
gc_th»ad
 = 
gc_th
;

140 
	`š™_wa™queue_h—d
(&
sbi
->
gc_th»ad
->
gc_wa™_queue_h—d
);

141 
sbi
->
gc_th»ad
->
f2fs_gc_sk
 = 
	`kth»ad_run
(
gc_th»ad_func
, sbi,

142 "f2fs_gc-%u:%u", 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

143 ià(
	`IS_ERR
(
gc_th
->
f2fs_gc_sk
)) {

144 
”r
 = 
	`PTR_ERR
(
gc_th
->
f2fs_gc_sk
);

145 
	`kvä“
(
gc_th
);

146 
sbi
->
gc_th»ad
 = 
NULL
;

148 
out
:

149  
”r
;

150 
	}
}

152 
	$f2fs_¡İ_gc_th»ad
(
f2fs_sb_šfo
 *
sbi
)

154 
f2fs_gc_kth»ad
 *
gc_th
 = 
sbi
->
gc_th»ad
;

155 ià(!
gc_th
)

157 
	`kth»ad_¡İ
(
gc_th
->
f2fs_gc_sk
);

158 
	`kvä“
(
gc_th
);

159 
sbi
->
gc_th»ad
 = 
NULL
;

160 
	}
}

162 
	$£Ëù_gc_ty³
(
f2fs_sb_šfo
 *
sbi
, 
gc_ty³
)

164 
gc_mode
 = (
gc_ty³
 =ğ
BG_GC
è? 
GC_CB
 : 
GC_GREEDY
;

166 
sbi
->
gc_mode
) {

167 
GC_IDLE_CB
:

168 
gc_mode
 = 
GC_CB
;

170 
GC_IDLE_GREEDY
:

171 
GC_URGENT
:

172 
gc_mode
 = 
GC_GREEDY
;

175  
gc_mode
;

176 
	}
}

178 
	$£Ëù_pŞicy
(
f2fs_sb_šfo
 *
sbi
, 
gc_ty³
,

179 
ty³
, 
viùim_£l_pŞicy
 *
p
)

181 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

183 ià(
p
->
®loc_mode
 =ğ
SSR
) {

184 
p
->
gc_mode
 = 
GC_GREEDY
;

185 
p
->
dœty_£gm­
 = 
dœty_i
->dœty_£gm­[
ty³
];

186 
p
->
max_£¬ch
 = 
dœty_i
->
Ä_dœty
[
ty³
];

187 
p
->
ofs_un™
 = 1;

189 
p
->
gc_mode
 = 
	`£Ëù_gc_ty³
(
sbi
, 
gc_ty³
);

190 
p
->
dœty_£gm­
 = 
dœty_i
->dœty_£gm­[
DIRTY
];

191 
p
->
max_£¬ch
 = 
dœty_i
->
Ä_dœty
[
DIRTY
];

192 
p
->
ofs_un™
 = 
sbi
->
£gs_³r_£c
;

196 ià(
gc_ty³
 !ğ
FG_GC
 &&

197 (
sbi
->
gc_mode
 !ğ
GC_URGENT
) &&

198 
p
->
max_£¬ch
 > 
sbi
->
max_viùim_£¬ch
)

199 
p
->
max_£¬ch
 = 
sbi
->
max_viùim_£¬ch
;

202 ià(
	`‹¡_İt
(
sbi
, 
NOHEAP
) &&

203 (
ty³
 =ğ
CURSEG_HOT_DATA
 || 
	`IS_NODESEG
(type)))

204 
p
->
off£t
 = 0;

206 
p
->
off£t
 = 
	`SIT_I
(
sbi
)->
Ï¡_viùim
[p->
gc_mode
];

207 
	}
}

209 
	$g‘_max_co¡
(
f2fs_sb_šfo
 *
sbi
,

210 
viùim_£l_pŞicy
 *
p
)

213 ià(
p
->
®loc_mode
 =ğ
SSR
)

214  
sbi
->
blocks_³r_£g
;

215 ià(
p
->
gc_mode
 =ğ
GC_GREEDY
)

216  2 * 
sbi
->
blocks_³r_£g
 * 
p
->
ofs_un™
;

217 ià(
p
->
gc_mode
 =ğ
GC_CB
)

218  
UINT_MAX
;

221 
	}
}

223 
	$check_bg_viùims
(
f2fs_sb_šfo
 *
sbi
)

225 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

226 
£úo
;

233 
	`fÜ_—ch_£t_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
, 
	`MAIN_SECS
(
sbi
)) {

234 ià(
	`£c_u§ge_check
(
sbi
, 
£úo
))

236 
	`ş—r_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
);

237  
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

239  
NULL_SEGNO
;

240 
	}
}

242 
	$g‘_cb_co¡
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

244 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

245 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

246 
¡¬t
 = 
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

247 
mtime
 = 0;

248 
vblocks
;

249 
age
 = 0;

250 
u
;

251 
i
;

253 
i
 = 0; i < 
sbi
->
£gs_³r_£c
; i++)

254 
mtime
 +ğ
	`g‘_£g_’Œy
(
sbi
, 
¡¬t
 + 
i
)->mtime;

255 
vblocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
Œue
);

257 
mtime
 = 
	`div_u64
(mtime, 
sbi
->
£gs_³r_£c
);

258 
vblocks
 = 
	`div_u64
(vblocks, 
sbi
->
£gs_³r_£c
);

260 
u
 = (
vblocks
 * 100è>> 
sbi
->
log_blocks_³r_£g
;

263 ià(
mtime
 < 
s™_i
->
mš_mtime
)

264 
s™_i
->
mš_mtime
 = 
mtime
;

265 ià(
mtime
 > 
s™_i
->
max_mtime
)

266 
s™_i
->
max_mtime
 = 
mtime
;

267 ià(
s™_i
->
max_mtime
 !ğs™_i->
mš_mtime
)

268 
age
 = 100 - 
	`div64_u64
(100 * (
mtime
 - 
s™_i
->
mš_mtime
),

269 
s™_i
->
max_mtime
 - s™_i->
mš_mtime
);

271  
UINT_MAX
 - ((100 * (100 - 
u
è* 
age
) / (100 + u));

272 
	}
}

274 
šlše
 
	$g‘_gc_co¡
(
f2fs_sb_šfo
 *
sbi
,

275 
£gno
, 
viùim_£l_pŞicy
 *
p
)

277 ià(
p
->
®loc_mode
 =ğ
SSR
)

278  
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
ck±_v®id_blocks
;

281 ià(
p
->
gc_mode
 =ğ
GC_GREEDY
)

282  
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
Œue
);

284  
	`g‘_cb_co¡
(
sbi
, 
£gno
);

285 
	}
}

287 
	$couÁ_b™s
(cÚ¡ *
addr
,

288 
off£t
, 
Ën
)

290 
’d
 = 
off£t
 + 
Ën
, 
sum
 = 0;

292 
off£t
 < 
’d
) {

293 ià(
	`‹¡_b™
(
off£t
++, 
addr
))

294 ++
sum
;

296  
sum
;

297 
	}
}

307 
	$g‘_viùim_by_deçuÉ
(
f2fs_sb_šfo
 *
sbi
,

308 *
»suÉ
, 
gc_ty³
, 
ty³
, 
®loc_mode
)

310 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

311 
s™_šfo
 *
sm
 = 
	`SIT_I
(
sbi
);

312 
viùim_£l_pŞicy
 
p
;

313 
£úo
, 
Ï¡_viùim
;

314 
Ï¡_£gm’t
;

315 
n£¬ched
 = 0;

317 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

318 
Ï¡_£gm’t
 = 
	`MAIN_SECS
(
sbi
è* sbi->
£gs_³r_£c
;

320 
p
.
®loc_mode
 =‡lloc_mode;

321 
	`£Ëù_pŞicy
(
sbi
, 
gc_ty³
, 
ty³
, &
p
);

323 
p
.
mš_£gno
 = 
NULL_SEGNO
;

324 
p
.
mš_co¡
 = 
	`g‘_max_co¡
(
sbi
, &p);

326 ià(*
»suÉ
 !ğ
NULL_SEGNO
) {

327 ià(
	`g‘_v®id_blocks
(
sbi
, *
»suÉ
, 
çl£
) &&

328 !
	`£c_u§ge_check
(
sbi
, 
	`GET_SEC_FROM_SEG
(sbi, *
»suÉ
)))

329 
p
.
mš_£gno
 = *
»suÉ
;

330 
out
;

333 ià(
p
.
max_£¬ch
 == 0)

334 
out
;

336 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
è&& 
p
.
®loc_mode
 =ğ
LFS
) {

337 ià(
sbi
->
Ãxt_viùim_£g
[
BG_GC
] !ğ
NULL_SEGNO
) {

338 
p
.
mš_£gno
 = 
sbi
->
Ãxt_viùim_£g
[
BG_GC
];

339 *
»suÉ
 = 
p
.
mš_£gno
;

340 
sbi
->
Ãxt_viùim_£g
[
BG_GC
] = 
NULL_SEGNO
;

341 
gÙ_»suÉ
;

343 ià(
gc_ty³
 =ğ
FG_GC
 &&

344 
sbi
->
Ãxt_viùim_£g
[
FG_GC
] !ğ
NULL_SEGNO
) {

345 
p
.
mš_£gno
 = 
sbi
->
Ãxt_viùim_£g
[
FG_GC
];

346 *
»suÉ
 = 
p
.
mš_£gno
;

347 
sbi
->
Ãxt_viùim_£g
[
FG_GC
] = 
NULL_SEGNO
;

348 
gÙ_»suÉ
;

352 
Ï¡_viùim
 = 
sm
->Ï¡_viùim[
p
.
gc_mode
];

353 ià(
p
.
®loc_mode
 =ğ
LFS
 && 
gc_ty³
 =ğ
FG_GC
) {

354 
p
.
mš_£gno
 = 
	`check_bg_viùims
(
sbi
);

355 ià(
p
.
mš_£gno
 !ğ
NULL_SEGNO
)

356 
gÙ_™
;

360 
co¡
;

361 
£gno
;

363 
£gno
 = 
	`fšd_Ãxt_b™
(
p
.
dœty_£gm­
, 
Ï¡_£gm’t
,….
off£t
);

364 ià(
£gno
 >ğ
Ï¡_£gm’t
) {

365 ià(
sm
->
Ï¡_viùim
[
p
.
gc_mode
]) {

366 
Ï¡_£gm’t
 =

367 
sm
->
Ï¡_viùim
[
p
.
gc_mode
];

368 
sm
->
Ï¡_viùim
[
p
.
gc_mode
] = 0;

369 
p
.
off£t
 = 0;

375 
p
.
off£t
 = 
£gno
 +….
ofs_un™
;

376 ià(
p
.
ofs_un™
 > 1) {

377 
p
.
off£t
 -ğ
£gno
 %….
ofs_un™
;

378 
n£¬ched
 +ğ
	`couÁ_b™s
(
p
.
dœty_£gm­
,

379 
p
.
off£t
 -….
ofs_un™
,

380 
p
.
ofs_un™
);

382 
n£¬ched
++;

385 #ifdeà
CONFIG_F2FS_CHECK_FS


391 ià(
	`‹¡_b™
(
£gno
, 
sm
->
šv®id_£gm­
))

392 
Ãxt
;

395 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

397 ià(
	`£c_u§ge_check
(
sbi
, 
£úo
))

398 
Ãxt
;

400 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
) &&

401 
	`g‘_ck±_v®id_blocks
(
sbi
, 
£gno
) &&

402 
p
.
®loc_mode
 !ğ
SSR
))

403 
Ãxt
;

404 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`‹¡_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
))

405 
Ãxt
;

407 
co¡
 = 
	`g‘_gc_co¡
(
sbi
, 
£gno
, &
p
);

409 ià(
p
.
mš_co¡
 > 
co¡
) {

410 
p
.
mš_£gno
 = 
£gno
;

411 
p
.
mš_co¡
 = 
co¡
;

413 
Ãxt
:

414 ià(
n£¬ched
 >ğ
p
.
max_£¬ch
) {

415 ià(!
sm
->
Ï¡_viùim
[
p
.
gc_mode
] && 
£gno
 <=†ast_victim)

416 
sm
->
Ï¡_viùim
[
p
.
gc_mode
] =†ast_victim + 1;

418 
sm
->
Ï¡_viùim
[
p
.
gc_mode
] = 
£gno
 + 1;

419 
sm
->
Ï¡_viùim
[
p
.
gc_mode
] %=

420 (
	`MAIN_SECS
(
sbi
è* sbi->
£gs_³r_£c
);

424 ià(
p
.
mš_£gno
 !ğ
NULL_SEGNO
) {

425 
gÙ_™
:

426 *
»suÉ
 = (
p
.
mš_£gno
 /….
ofs_un™
) *….ofs_unit;

427 
gÙ_»suÉ
:

428 ià(
p
.
®loc_mode
 =ğ
LFS
) {

429 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
p
.
mš_£gno
);

430 ià(
gc_ty³
 =ğ
FG_GC
)

431 
sbi
->
cur_viùim_£c
 = 
£úo
;

433 
	`£t_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
);

437 
out
:

438 ià(
p
.
mš_£gno
 !ğ
NULL_SEGNO
)

439 
	`Œaû_f2fs_g‘_viùim
(
sbi
->
sb
, 
ty³
, 
gc_ty³
, &
p
,

440 
sbi
->
cur_viùim_£c
,

441 
	`´eä“_£gm’ts
(
sbi
), 
	`ä“_£gm’ts
(sbi));

442 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

444  (
p
.
mš_£gno
 =ğ
NULL_SEGNO
) ? 0 : 1;

445 
	}
}

447 cÚ¡ 
viùim_£ËùiÚ
 
	gdeçuÉ_v_İs
 = {

448 .
g‘_viùim
 = 
g‘_viùim_by_deçuÉ
,

451 
šode
 *
	$fšd_gc_šode
(
gc_šode_li¡
 *
gc_li¡
, 
nid_t
 
šo
)

453 
šode_’Œy
 *
›
;

455 
›
 = 
	`¿dix_Œ“_lookup
(&
gc_li¡
->
œoÙ
, 
šo
);

456 ià(
›
)

457  
›
->
šode
;

458  
NULL
;

459 
	}
}

461 
	$add_gc_šode
(
gc_šode_li¡
 *
gc_li¡
, 
šode
 *inode)

463 
šode_’Œy
 *
Ãw_›
;

465 ià(
šode
 =ğ
	`fšd_gc_šode
(
gc_li¡
, inode->
i_šo
)) {

466 
	`ut
(
šode
);

469 
Ãw_›
 = 
	`f2fs_kmem_ÿche_®loc
(
f2fs_šode_’Œy_¦ab
, 
GFP_NOFS
);

470 
Ãw_›
->
šode
 = inode;

472 
	`f2fs_¿dix_Œ“_š£¹
(&
gc_li¡
->
œoÙ
, 
šode
->
i_šo
, 
Ãw_›
);

473 
	`li¡_add_
(&
Ãw_›
->
li¡
, &
gc_li¡
->
i¡
);

474 
	}
}

476 
	$put_gc_šode
(
gc_šode_li¡
 *
gc_li¡
)

478 
šode_’Œy
 *
›
, *
Ãxt_›
;

479 
	`li¡_fÜ_—ch_’Œy_§ã
(
›
, 
Ãxt_›
, &
gc_li¡
->
i¡
, 
li¡
) {

480 
	`¿dix_Œ“_d–‘e
(&
gc_li¡
->
œoÙ
, 
›
->
šode
->
i_šo
);

481 
	`ut
(
›
->
šode
);

482 
	`li¡_d–
(&
›
->
li¡
);

483 
	`kmem_ÿche_ä“
(
f2fs_šode_’Œy_¦ab
, 
›
);

485 
	}
}

487 
	$check_v®id_m­
(
f2fs_sb_šfo
 *
sbi
,

488 
£gno
, 
off£t
)

490 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

491 
£g_’Œy
 *
£Áry
;

492 
»t
;

494 
	`down_»ad
(&
s™_i
->
£Áry_lock
);

495 
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

496 
»t
 = 
	`f2fs_‹¡_b™
(
off£t
, 
£Áry
->
cur_v®id_m­
);

497 
	`up_»ad
(&
s™_i
->
£Áry_lock
);

498  
»t
;

499 
	}
}

506 
	$gc_node_£gm’t
(
f2fs_sb_šfo
 *
sbi
,

507 
f2fs_summ¬y
 *
sum
, 
£gno
, 
gc_ty³
)

509 
f2fs_summ¬y
 *
’Œy
;

510 
block_t
 
¡¬t_addr
;

511 
off
;

512 
pha£
 = 0;

513 
boŞ
 
fggc
 = (
gc_ty³
 =ğ
FG_GC
);

514 
subm™‹d
 = 0;

516 
¡¬t_addr
 = 
	`START_BLOCK
(
sbi
, 
£gno
);

518 
Ãxt_¡•
:

519 
’Œy
 = 
sum
;

521 ià(
fggc
 && 
pha£
 == 2)

522 
	`©omic_šc
(&
sbi
->
wb_sync_»q
[
NODE
]);

524 
off
 = 0; ofà< 
sbi
->
blocks_³r_£g
; off++, 
’Œy
++) {

525 
nid_t
 
nid
 = 
	`Ë32_to_ıu
(
’Œy
->nid);

526 
·ge
 *
node_·ge
;

527 
node_šfo
 
ni
;

528 
”r
;

531 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0))

532  
subm™‹d
;

534 ià(
	`check_v®id_m­
(
sbi
, 
£gno
, 
off
) == 0)

537 ià(
pha£
 == 0) {

538 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`NAT_BLOCK_OFFSET
(
nid
), 1,

539 
META_NAT
, 
Œue
);

543 ià(
pha£
 == 1) {

544 
	`f2fs_¿_node_·ge
(
sbi
, 
nid
);

549 
node_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nid
);

550 ià(
	`IS_ERR
(
node_·ge
))

554 ià(
	`check_v®id_m­
(
sbi
, 
£gno
, 
off
) == 0) {

555 
	`f2fs_put_·ge
(
node_·ge
, 1);

559 ià(
	`f2fs_g‘_node_šfo
(
sbi
, 
nid
, &
ni
)) {

560 
	`f2fs_put_·ge
(
node_·ge
, 1);

564 ià(
ni
.
blk_addr
 !ğ
¡¬t_addr
 + 
off
) {

565 
	`f2fs_put_·ge
(
node_·ge
, 1);

569 
”r
 = 
	`f2fs_move_node_·ge
(
node_·ge
, 
gc_ty³
);

570 ià(!
”r
 && 
gc_ty³
 =ğ
FG_GC
)

571 
subm™‹d
++;

572 
	`¡©_šc_node_blk_couÁ
(
sbi
, 1, 
gc_ty³
);

575 ià(++
pha£
 < 3)

576 
Ãxt_¡•
;

578 ià(
fggc
)

579 
	`©omic_dec
(&
sbi
->
wb_sync_»q
[
NODE
]);

580  
subm™‹d
;

581 
	}
}

590 
block_t
 
	$f2fs_¡¬t_bidx_of_node
(
node_ofs
, 
šode
 *inode)

592 
šdœeù_blks
 = 2 * 
NIDS_PER_BLOCK
 + 4;

593 
bidx
;

595 ià(
node_ofs
 == 0)

598 ià(
node_ofs
 <= 2) {

599 
bidx
 = 
node_ofs
 - 1;

600 } ià(
node_ofs
 <ğ
šdœeù_blks
) {

601 
dec
 = (
node_ofs
 - 4è/ (
NIDS_PER_BLOCK
 + 1);

602 
bidx
 = 
node_ofs
 - 2 - 
dec
;

604 
dec
 = (
node_ofs
 - 
šdœeù_blks
 - 3è/ (
NIDS_PER_BLOCK
 + 1);

605 
bidx
 = 
node_ofs
 - 5 - 
dec
;

607  
bidx
 * 
	`ADDRS_PER_BLOCK
(
šode
è+ 
	`ADDRS_PER_INODE
(inode);

608 
	}
}

610 
boŞ
 
	$is_®ive
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

611 
node_šfo
 *
dni
, 
block_t
 
blkaddr
, *
nofs
)

613 
·ge
 *
node_·ge
;

614 
nid_t
 
nid
;

615 
ofs_š_node
;

616 
block_t
 
sourû_blkaddr
;

618 
nid
 = 
	`Ë32_to_ıu
(
sum
->nid);

619 
ofs_š_node
 = 
	`Ë16_to_ıu
(
sum
->ofs_in_node);

621 
node_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nid
);

622 ià(
	`IS_ERR
(
node_·ge
))

623  
çl£
;

625 ià(
	`f2fs_g‘_node_šfo
(
sbi
, 
nid
, 
dni
)) {

626 
	`f2fs_put_·ge
(
node_·ge
, 1);

627  
çl£
;

630 ià(
sum
->
v”siÚ
 !ğ
dni
->version) {

631 
	`f2fs_w¬n
(
sbi
, "%s: valid data with mismatched‚ode version.",

632 
__func__
);

633 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

636 *
nofs
 = 
	`ofs_of_node
(
node_·ge
);

637 
sourû_blkaddr
 = 
	`d©ablock_addr
(
NULL
, 
node_·ge
, 
ofs_š_node
);

638 
	`f2fs_put_·ge
(
node_·ge
, 1);

640 ià(
sourû_blkaddr
 !ğ
blkaddr
) {

641 #ifdeà
CONFIG_F2FS_CHECK_FS


642 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blkaddr
);

643 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blkaddr
);

645 ià(
	`uÆik–y
(
	`check_v®id_m­
(
sbi
, 
£gno
, 
off£t
))) {

646 ià(!
	`‹¡_ªd_£t_b™
(
£gno
, 
	`SIT_I
(
sbi
)->
šv®id_£gm­
)) {

647 
	`f2fs_”r
(
sbi
, "mismatched blkaddr %u (source_blkaddr %u) in seg %u\n",

648 
blkaddr
, 
sourû_blkaddr
, 
£gno
);

649 
	`f2fs_bug_Ú
(
sbi
, 1);

653  
çl£
;

655  
Œue
;

656 
	}
}

658 
	$¿_d©a_block
(
šode
 *šode, 
pgoff_t
 
šdex
)

660 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

661 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

662 
dnode_of_d©a
 
dn
;

663 
·ge
 *page;

664 
ex‹Á_šfo
 
ei
 = {0, 0, 0};

665 
f2fs_io_šfo
 
fio
 = {

666 .
sbi
 = sbi,

667 .
šo
 = 
šode
->
i_šo
,

668 .
ty³
 = 
DATA
,

669 .
‹mp
 = 
COLD
,

670 .
İ
 = 
REQ_OP_READ
,

671 .
İ_æags
 = 0,

672 .
’üy±ed_·ge
 = 
NULL
,

673 .
š_li¡
 = 
çl£
,

674 .
»Œy
 = 
çl£
,

676 
”r
;

678 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
m­pšg
, 
šdex
, 
Œue
);

679 ià(!
·ge
)

680  -
ENOMEM
;

682 ià(
	`f2fs_lookup_ex‹Á_ÿche
(
šode
, 
šdex
, &
ei
)) {

683 
dn
.
d©a_blkaddr
 = 
ei
.
blk
 + 
šdex
 -ƒi.
fofs
;

684 ià(
	`uÆik–y
(!
	`f2fs_is_v®id_blkaddr
(
sbi
, 
dn
.
d©a_blkaddr
,

685 
DATA_GENERIC_ENHANCE_READ
))) {

686 
”r
 = -
EFSCORRUPTED
;

687 
put_·ge
;

689 
gÙ_™
;

692 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

693 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
šdex
, 
LOOKUP_NODE
);

694 ià(
”r
)

695 
put_·ge
;

696 
	`f2fs_put_dnode
(&
dn
);

698 ià(!
	`__is_v®id_d©a_blkaddr
(
dn
.
d©a_blkaddr
)) {

699 
”r
 = -
ENOENT
;

700 
put_·ge
;

702 ià(
	`uÆik–y
(!
	`f2fs_is_v®id_blkaddr
(
sbi
, 
dn
.
d©a_blkaddr
,

703 
DATA_GENERIC_ENHANCE
))) {

704 
”r
 = -
EFSCORRUPTED
;

705 
put_·ge
;

707 
gÙ_™
:

709 
fio
.
·ge
 =…age;

710 
fio
.
Ãw_blkaddr
 = fio.
Şd_blkaddr
 = 
dn
.
d©a_blkaddr
;

716 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
,rue);

718 
	`f2fs_wa™_Ú_block_wr™eback
(
šode
, 
dn
.
d©a_blkaddr
);

720 
fio
.
’üy±ed_·ge
 = 
	`f2fs_·geÿche_g‘_·ge
(
	`META_MAPPING
(
sbi
),

721 
dn
.
d©a_blkaddr
,

722 
FGP_LOCK
 | 
FGP_CREAT
, 
GFP_NOFS
);

723 ià(!
fio
.
’üy±ed_·ge
) {

724 
”r
 = -
ENOMEM
;

725 
put_·ge
;

728 
”r
 = 
	`f2fs_subm™_·ge_bio
(&
fio
);

729 ià(
”r
)

730 
put_’üy±ed_·ge
;

731 
	`f2fs_put_·ge
(
fio
.
’üy±ed_·ge
, 0);

732 
	`f2fs_put_·ge
(
·ge
, 1);

734 
put_’üy±ed_·ge
:

735 
	`f2fs_put_·ge
(
fio
.
’üy±ed_·ge
, 1);

736 
put_·ge
:

737 
	`f2fs_put_·ge
(
·ge
, 1);

738  
”r
;

739 
	}
}

745 
	$move_d©a_block
(
šode
 *šode, 
block_t
 
bidx
,

746 
gc_ty³
, 
£gno
, 
off
)

748 
f2fs_io_šfo
 
fio
 = {

749 .
sbi
 = 
	`F2FS_I_SB
(
šode
),

750 .
šo
 = 
šode
->
i_šo
,

751 .
ty³
 = 
DATA
,

752 .
‹mp
 = 
COLD
,

753 .
İ
 = 
REQ_OP_READ
,

754 .
İ_æags
 = 0,

755 .
’üy±ed_·ge
 = 
NULL
,

756 .
š_li¡
 = 
çl£
,

757 .
»Œy
 = 
çl£
,

759 
dnode_of_d©a
 
dn
;

760 
f2fs_summ¬y
 
sum
;

761 
node_šfo
 
ni
;

762 
·ge
 *·ge, *
m·ge
;

763 
block_t
 
Ãwaddr
;

764 
”r
 = 0;

765 
boŞ
 
lfs_mode
 = 
	`‹¡_İt
(
fio
.
sbi
, 
LFS
);

768 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
šode
->
i_m­pšg
, 
bidx
, 
çl£
);

769 ià(!
·ge
)

770  -
ENOMEM
;

772 ià(!
	`check_v®id_m­
(
	`F2FS_I_SB
(
šode
), 
£gno
, 
off
)) {

773 
”r
 = -
ENOENT
;

774 
out
;

777 ià(
	`f2fs_is_©omic_fe
(
šode
)) {

778 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_ATOMIC
]++;

779 
	`F2FS_I_SB
(
šode
)->
sk³d_©omic_fes
[
gc_ty³
]++;

780 
”r
 = -
EAGAIN
;

781 
out
;

784 ià(
	`f2fs_is_pšÃd_fe
(
šode
)) {

785 
	`f2fs_pš_fe_cÚŒŞ
(
šode
, 
Œue
);

786 
”r
 = -
EAGAIN
;

787 
out
;

790 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

791 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
bidx
, 
LOOKUP_NODE
);

792 ià(
”r
)

793 
out
;

795 ià(
	`uÆik–y
(
dn
.
d©a_blkaddr
 =ğ
NULL_ADDR
)) {

796 
	`CË¬PageU±od©e
(
·ge
);

797 
”r
 = -
ENOENT
;

798 
put_out
;

805 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
,rue);

807 
	`f2fs_wa™_Ú_block_wr™eback
(
šode
, 
dn
.
d©a_blkaddr
);

809 
”r
 = 
	`f2fs_g‘_node_šfo
(
fio
.
sbi
, 
dn
.
nid
, &
ni
);

810 ià(
”r
)

811 
put_out
;

813 
	`£t_summ¬y
(&
sum
, 
dn
.
nid
, dn.
ofs_š_node
, 
ni
.
v”siÚ
);

816 
fio
.
·ge
 =…age;

817 
fio
.
Ãw_blkaddr
 = fio.
Şd_blkaddr
 = 
dn
.
d©a_blkaddr
;

819 ià(
lfs_mode
)

820 
	`down_wr™e
(&
fio
.
sbi
->
io_Üd”_lock
);

822 
m·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`META_MAPPING
(
fio
.
sbi
),

823 
fio
.
Şd_blkaddr
, 
çl£
);

824 ià(!
m·ge
)

825 
up_out
;

827 
fio
.
’üy±ed_·ge
 = 
m·ge
;

830 ià(!
	`PageU±od©e
(
m·ge
)) {

831 
”r
 = 
	`f2fs_subm™_·ge_bio
(&
fio
);

832 ià(
”r
) {

833 
	`f2fs_put_·ge
(
m·ge
, 1);

834 
up_out
;

836 
	`lock_·ge
(
m·ge
);

837 ià(
	`uÆik–y
(
m·ge
->
m­pšg
 !ğ
	`META_MAPPING
(
fio
.
sbi
) ||

838 !
	`PageU±od©e
(
m·ge
))) {

839 
”r
 = -
EIO
;

840 
	`f2fs_put_·ge
(
m·ge
, 1);

841 
up_out
;

845 
	`f2fs_®loÿ‹_d©a_block
(
fio
.
sbi
, 
NULL
, fio.
Şd_blkaddr
, &
Ãwaddr
,

846 &
sum
, 
CURSEG_COLD_DATA
, 
NULL
, 
çl£
);

848 
fio
.
’üy±ed_·ge
 = 
	`f2fs_·geÿche_g‘_·ge
(
	`META_MAPPING
(fio.
sbi
),

849 
Ãwaddr
, 
FGP_LOCK
 | 
FGP_CREAT
, 
GFP_NOFS
);

850 ià(!
fio
.
’üy±ed_·ge
) {

851 
”r
 = -
ENOMEM
;

852 
	`f2fs_put_·ge
(
m·ge
, 1);

853 
»cov”_block
;

857 
	`f2fs_wa™_Ú_·ge_wr™eback
(
fio
.
’üy±ed_·ge
, 
DATA
, 
Œue
,rue);

858 
	`memıy
(
	`·ge_add»ss
(
fio
.
’üy±ed_·ge
),

859 
	`·ge_add»ss
(
m·ge
), 
PAGE_SIZE
);

860 
	`f2fs_put_·ge
(
m·ge
, 1);

861 
	`šv®id©e_m­pšg_·ges
(
	`META_MAPPING
(
fio
.
sbi
),

862 
fio
.
Şd_blkaddr
, fio.old_blkaddr);

864 
	`£t_·ge_dœty
(
fio
.
’üy±ed_·ge
);

865 ià(
	`ş—r_·ge_dœty_fÜ_io
(
fio
.
’üy±ed_·ge
))

866 
	`dec_·ge_couÁ
(
fio
.
sbi
, 
F2FS_DIRTY_META
);

868 
	`£t_·ge_wr™eback
(
fio
.
’üy±ed_·ge
);

869 
	`CË¬PageE¼Ü
(
·ge
);

872 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
.
node_·ge
, 
NODE
, 
Œue
,rue);

874 
fio
.
İ
 = 
REQ_OP_WRITE
;

875 
fio
.
İ_æags
 = 
REQ_SYNC
;

876 
fio
.
Ãw_blkaddr
 = 
Ãwaddr
;

877 
	`f2fs_subm™_·ge_wr™e
(&
fio
);

878 ià(
fio
.
»Œy
) {

879 
”r
 = -
EAGAIN
;

880 ià(
	`PageWr™eback
(
fio
.
’üy±ed_·ge
))

881 
	`’d_·ge_wr™eback
(
fio
.
’üy±ed_·ge
);

882 
put_·ge_out
;

885 
	`f2fs_upd©e_io¡©
(
fio
.
sbi
, 
FS_GC_DATA_IO
, 
F2FS_BLKSIZE
);

887 
	`f2fs_upd©e_d©a_blkaddr
(&
dn
, 
Ãwaddr
);

888 
	`£t_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

889 ià(
·ge
->
šdex
 == 0)

890 
	`£t_šode_æag
(
šode
, 
FI_FIRST_BLOCK_WRITTEN
);

891 
put_·ge_out
:

892 
	`f2fs_put_·ge
(
fio
.
’üy±ed_·ge
, 1);

893 
»cov”_block
:

894 ià(
”r
)

895 
	`f2fs_do_»¶aû_block
(
fio
.
sbi
, &
sum
, 
Ãwaddr
, fio.
Şd_blkaddr
,

896 
Œue
,rue);

897 
up_out
:

898 ià(
lfs_mode
)

899 
	`up_wr™e
(&
fio
.
sbi
->
io_Üd”_lock
);

900 
put_out
:

901 
	`f2fs_put_dnode
(&
dn
);

902 
out
:

903 
	`f2fs_put_·ge
(
·ge
, 1);

904  
”r
;

905 
	}
}

907 
	$move_d©a_·ge
(
šode
 *šode, 
block_t
 
bidx
, 
gc_ty³
,

908 
£gno
, 
off
)

910 
·ge
 *page;

911 
”r
 = 0;

913 
·ge
 = 
	`f2fs_g‘_lock_d©a_·ge
(
šode
, 
bidx
, 
Œue
);

914 ià(
	`IS_ERR
(
·ge
))

915  
	`PTR_ERR
(
·ge
);

917 ià(!
	`check_v®id_m­
(
	`F2FS_I_SB
(
šode
), 
£gno
, 
off
)) {

918 
”r
 = -
ENOENT
;

919 
out
;

922 ià(
	`f2fs_is_©omic_fe
(
šode
)) {

923 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_ATOMIC
]++;

924 
	`F2FS_I_SB
(
šode
)->
sk³d_©omic_fes
[
gc_ty³
]++;

925 
”r
 = -
EAGAIN
;

926 
out
;

928 ià(
	`f2fs_is_pšÃd_fe
(
šode
)) {

929 ià(
gc_ty³
 =ğ
FG_GC
)

930 
	`f2fs_pš_fe_cÚŒŞ
(
šode
, 
Œue
);

931 
”r
 = -
EAGAIN
;

932 
out
;

935 ià(
gc_ty³
 =ğ
BG_GC
) {

936 ià(
	`PageWr™eback
(
·ge
)) {

937 
”r
 = -
EAGAIN
;

938 
out
;

940 
	`£t_·ge_dœty
(
·ge
);

941 
	`£t_cŞd_d©a
(
·ge
);

943 
f2fs_io_šfo
 
fio
 = {

944 .
sbi
 = 
	`F2FS_I_SB
(
šode
),

945 .
šo
 = 
šode
->
i_šo
,

946 .
ty³
 = 
DATA
,

947 .
‹mp
 = 
COLD
,

948 .
İ
 = 
REQ_OP_WRITE
,

949 .
İ_æags
 = 
REQ_SYNC
,

950 .
Şd_blkaddr
 = 
NULL_ADDR
,

951 .
·ge
 =…age,

952 .
’üy±ed_·ge
 = 
NULL
,

953 .
Ãed_lock
 = 
LOCK_REQ
,

954 .
io_ty³
 = 
FS_GC_DATA_IO
,

956 
boŞ
 
is_dœty
 = 
	`PageDœty
(
·ge
);

958 
»Œy
:

959 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
,rue);

961 
	`£t_·ge_dœty
(
·ge
);

962 ià(
	`ş—r_·ge_dœty_fÜ_io
(
·ge
)) {

963 
	`šode_dec_dœty_·ges
(
šode
);

964 
	`f2fs_»move_dœty_šode
(
šode
);

967 
	`£t_cŞd_d©a
(
·ge
);

969 
”r
 = 
	`f2fs_do_wr™e_d©a_·ge
(&
fio
);

970 ià(
”r
) {

971 
	`ş—r_cŞd_d©a
(
·ge
);

972 ià(
”r
 =ğ-
ENOMEM
) {

973 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

974 
»Œy
;

976 ià(
is_dœty
)

977 
	`£t_·ge_dœty
(
·ge
);

980 
out
:

981 
	`f2fs_put_·ge
(
·ge
, 1);

982  
”r
;

983 
	}
}

992 
	$gc_d©a_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

993 
gc_šode_li¡
 *
gc_li¡
, 
£gno
, 
gc_ty³
)

995 
su³r_block
 *
sb
 = 
sbi
->sb;

996 
f2fs_summ¬y
 *
’Œy
;

997 
block_t
 
¡¬t_addr
;

998 
off
;

999 
pha£
 = 0;

1000 
subm™‹d
 = 0;

1002 
¡¬t_addr
 = 
	`START_BLOCK
(
sbi
, 
£gno
);

1004 
Ãxt_¡•
:

1005 
’Œy
 = 
sum
;

1007 
off
 = 0; ofà< 
sbi
->
blocks_³r_£g
; off++, 
’Œy
++) {

1008 
·ge
 *
d©a_·ge
;

1009 
šode
 *inode;

1010 
node_šfo
 
dni
;

1011 
ofs_š_node
, 
nofs
;

1012 
block_t
 
¡¬t_bidx
;

1013 
nid_t
 
nid
 = 
	`Ë32_to_ıu
(
’Œy
->nid);

1016 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0))

1017  
subm™‹d
;

1019 ià(
	`check_v®id_m­
(
sbi
, 
£gno
, 
off
) == 0)

1022 ià(
pha£
 == 0) {

1023 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`NAT_BLOCK_OFFSET
(
nid
), 1,

1024 
META_NAT
, 
Œue
);

1028 ià(
pha£
 == 1) {

1029 
	`f2fs_¿_node_·ge
(
sbi
, 
nid
);

1034 ià(!
	`is_®ive
(
sbi
, 
’Œy
, &
dni
, 
¡¬t_addr
 + 
off
, &
nofs
))

1037 ià(
pha£
 == 2) {

1038 
	`f2fs_¿_node_·ge
(
sbi
, 
dni
.
šo
);

1042 
ofs_š_node
 = 
	`Ë16_to_ıu
(
’Œy
->ofs_in_node);

1044 ià(
pha£
 == 3) {

1045 
šode
 = 
	`f2fs_ig‘
(
sb
, 
dni
.
šo
);

1046 ià(
	`IS_ERR
(
šode
è|| 
	`is_bad_šode
(inode))

1049 ià(!
	`down_wr™e_Œylock
(

1050 &
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
])) {

1051 
	`ut
(
šode
);

1052 
sbi
->
sk³d_gc_rw£m
++;

1056 
¡¬t_bidx
 = 
	`f2fs_¡¬t_bidx_of_node
(
nofs
, 
šode
) +

1057 
ofs_š_node
;

1059 ià(
	`f2fs_po¡_»ad_»quœed
(
šode
)) {

1060 
”r
 = 
	`¿_d©a_block
(
šode
, 
¡¬t_bidx
);

1062 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1063 ià(
”r
) {

1064 
	`ut
(
šode
);

1067 
	`add_gc_šode
(
gc_li¡
, 
šode
);

1071 
d©a_·ge
 = 
	`f2fs_g‘_»ad_d©a_·ge
(
šode
,

1072 
¡¬t_bidx
, 
REQ_RAHEAD
, 
Œue
);

1073 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_gc_rw£m
[
WRITE
]);

1074 ià(
	`IS_ERR
(
d©a_·ge
)) {

1075 
	`ut
(
šode
);

1079 
	`f2fs_put_·ge
(
d©a_·ge
, 0);

1080 
	`add_gc_šode
(
gc_li¡
, 
šode
);

1085 
šode
 = 
	`fšd_gc_šode
(
gc_li¡
, 
dni
.
šo
);

1086 ià(
šode
) {

1087 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

1088 
boŞ
 
locked
 = 
çl£
;

1089 
”r
;

1091 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

1092 ià(!
	`down_wr™e_Œylock
(&
fi
->
i_gc_rw£m
[
READ
]))

1094 ià(!
	`down_wr™e_Œylock
(

1095 &
fi
->
i_gc_rw£m
[
WRITE
])) {

1096 
sbi
->
sk³d_gc_rw£m
++;

1097 
	`up_wr™e
(&
fi
->
i_gc_rw£m
[
READ
]);

1100 
locked
 = 
Œue
;

1103 
	`šode_dio_wa™
(
šode
);

1106 
¡¬t_bidx
 = 
	`f2fs_¡¬t_bidx_of_node
(
nofs
, 
šode
)

1107 + 
ofs_š_node
;

1108 ià(
	`f2fs_po¡_»ad_»quœed
(
šode
))

1109 
”r
 = 
	`move_d©a_block
(
šode
, 
¡¬t_bidx
,

1110 
gc_ty³
, 
£gno
, 
off
);

1112 
”r
 = 
	`move_d©a_·ge
(
šode
, 
¡¬t_bidx
, 
gc_ty³
,

1113 
£gno
, 
off
);

1115 ià(!
”r
 && (
gc_ty³
 =ğ
FG_GC
 ||

1116 
	`f2fs_po¡_»ad_»quœed
(
šode
)))

1117 
subm™‹d
++;

1119 ià(
locked
) {

1120 
	`up_wr™e
(&
fi
->
i_gc_rw£m
[
WRITE
]);

1121 
	`up_wr™e
(&
fi
->
i_gc_rw£m
[
READ
]);

1124 
	`¡©_šc_d©a_blk_couÁ
(
sbi
, 1, 
gc_ty³
);

1128 ià(++
pha£
 < 5)

1129 
Ãxt_¡•
;

1131  
subm™‹d
;

1132 
	}
}

1134 
	$__g‘_viùim
(
f2fs_sb_šfo
 *
sbi
, *
viùim
,

1135 
gc_ty³
)

1137 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

1138 
»t
;

1140 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

1141 
»t
 = 
	`DIRTY_I
(
sbi
)->
v_İs
->
	`g‘_viùim
(sbi, 
viùim
, 
gc_ty³
,

1142 
NO_CHECK_TYPE
, 
LFS
);

1143 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

1144  
»t
;

1145 
	}
}

1147 
	$do_g¬bage_cŞËù
(
f2fs_sb_šfo
 *
sbi
,

1148 
¡¬t_£gno
,

1149 
gc_šode_li¡
 *
gc_li¡
, 
gc_ty³
)

1151 
·ge
 *
sum_·ge
;

1152 
f2fs_summ¬y_block
 *
sum
;

1153 
blk_¶ug
 
¶ug
;

1154 
£gno
 = 
¡¬t_£gno
;

1155 
’d_£gno
 = 
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
;

1156 
£g_ä“d
 = 0, 
mig¿‹d
 = 0;

1157 
ty³
 = 
	`IS_DATASEG
(
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->type) ?

1158 
SUM_TYPE_DATA
 : 
SUM_TYPE_NODE
;

1159 
subm™‹d
 = 0;

1161 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
))

1162 
’d_£gno
 = 
	`rounddown
Ónd_£gno, 
sbi
->
£gs_³r_£c
);

1165 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
))

1166 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`GET_SUM_BLOCK
(sbi, 
£gno
),

1167 
’d_£gno
 - 
£gno
, 
META_SSA
, 
Œue
);

1170 
£gno
 < 
’d_£gno
) {

1171 
sum_·ge
 = 
	`f2fs_g‘_sum_·ge
(
sbi
, 
£gno
++);

1172 ià(
	`IS_ERR
(
sum_·ge
)) {

1173 
”r
 = 
	`PTR_ERR
(
sum_·ge
);

1175 
’d_£gno
 = 
£gno
 - 1;

1176 
£gno
 = 
¡¬t_£gno
; segnØ< 
’d_£gno
; segno++) {

1177 
sum_·ge
 = 
	`fšd_g‘_·ge
(
	`META_MAPPING
(
sbi
),

1178 
	`GET_SUM_BLOCK
(
sbi
, 
£gno
));

1179 
	`f2fs_put_·ge
(
sum_·ge
, 0);

1180 
	`f2fs_put_·ge
(
sum_·ge
, 0);

1182  
”r
;

1184 
	`uÆock_·ge
(
sum_·ge
);

1187 
	`blk_¡¬t_¶ug
(&
¶ug
);

1189 
£gno
 = 
¡¬t_£gno
; segnØ< 
’d_£gno
; segno++) {

1192 
sum_·ge
 = 
	`fšd_g‘_·ge
(
	`META_MAPPING
(
sbi
),

1193 
	`GET_SUM_BLOCK
(
sbi
, 
£gno
));

1194 
	`f2fs_put_·ge
(
sum_·ge
, 0);

1196 ià(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
çl£
) == 0)

1197 
ä“d
;

1198 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
) &&

1199 
mig¿‹d
 >ğ
sbi
->
mig¿tiÚ_g¿nuÏr™y
)

1200 
sk
;

1201 ià(!
	`PageU±od©e
(
sum_·ge
è|| 
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1202 
sk
;

1204 
sum
 = 
	`·ge_add»ss
(
sum_·ge
);

1205 ià(
ty³
 !ğ
	`GET_SUM_TYPE
((&
sum
->
foÙ”
))) {

1206 
	`f2fs_”r
(
sbi
, "Inconsistent segment (%u)ype [%d, %d] in SSA‡nd SIT",

1207 
£gno
, 
ty³
, 
	`GET_SUM_TYPE
((&
sum
->
foÙ”
)));

1208 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

1209 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

1210 
sk
;

1220 ià(
ty³
 =ğ
SUM_TYPE_NODE
)

1221 
subm™‹d
 +ğ
	`gc_node_£gm’t
(
sbi
, 
sum
->
’Œ›s
, 
£gno
,

1222 
gc_ty³
);

1224 
subm™‹d
 +ğ
	`gc_d©a_£gm’t
(
sbi
, 
sum
->
’Œ›s
, 
gc_li¡
,

1225 
£gno
, 
gc_ty³
);

1227 
	`¡©_šc_£g_couÁ
(
sbi
, 
ty³
, 
gc_ty³
);

1229 
ä“d
:

1230 ià(
gc_ty³
 =ğ
FG_GC
 &&

1231 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
çl£
) == 0)

1232 
£g_ä“d
++;

1233 
mig¿‹d
++;

1235 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
è&& 
£gno
 + 1 < 
’d_£gno
)

1236 
sbi
->
Ãxt_viùim_£g
[
gc_ty³
] = 
£gno
 + 1;

1237 
sk
:

1238 
	`f2fs_put_·ge
(
sum_·ge
, 0);

1241 ià(
subm™‹d
)

1242 
	`f2fs_subm™_m”ged_wr™e
(
sbi
,

1243 (
ty³
 =ğ
SUM_TYPE_NODE
è? 
NODE
 : 
DATA
);

1245 
	`blk_fšish_¶ug
(&
¶ug
);

1247 
	`¡©_šc_ÿÎ_couÁ
(
sbi
->
¡©_šfo
);

1249  
£g_ä“d
;

1250 
	}
}

1252 
	$f2fs_gc
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
sync
,

1253 
boŞ
 
background
, 
£gno
)

1255 
gc_ty³
 = 
sync
 ? 
FG_GC
 : 
BG_GC
;

1256 
£c_ä“d
 = 0, 
£g_ä“d
 = 0, 
tÙ®_ä“d
 = 0;

1257 
»t
 = 0;

1258 
ı_cÚŒŞ
 
ıc
;

1259 
š™_£gno
 = 
£gno
;

1260 
gc_šode_li¡
 
gc_li¡
 = {

1261 .
i¡
 = 
	`LIST_HEAD_INIT
(
gc_li¡
.ilist),

1262 .
œoÙ
 = 
	`RADIX_TREE_INIT
(
gc_li¡
.œoÙ, 
GFP_NOFS
),

1264 
Ï¡_sk³d
 = 
sbi
->
sk³d_©omic_fes
[
FG_GC
];

1265 
fœ¡_sk³d
;

1266 
sk³d_round
 = 0, 
round
 = 0;

1268 
	`Œaû_f2fs_gc_begš
(
sbi
->
sb
, 
sync
, 
background
,

1269 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
),

1270 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
),

1271 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
),

1272 
	`ä“_£ùiÚs
(
sbi
),

1273 
	`ä“_£gm’ts
(
sbi
),

1274 
	`»£rved_£gm’ts
(
sbi
),

1275 
	`´eä“_£gm’ts
(
sbi
));

1277 
ıc
.
»asÚ
 = 
	`__g‘_ı_»asÚ
(
sbi
);

1278 
sbi
->
sk³d_gc_rw£m
 = 0;

1279 
fœ¡_sk³d
 = 
Ï¡_sk³d
;

1280 
gc_mÜe
:

1281 ià(
	`uÆik–y
(!(
sbi
->
sb
->
s_æags
 & 
SB_ACTIVE
))) {

1282 
»t
 = -
EINVAL
;

1283 
¡İ
;

1285 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1286 
»t
 = -
EIO
;

1287 
¡İ
;

1290 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0)) {

1296 ià(
	`´eä“_£gm’ts
(
sbi
) &&

1297 !
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)) {

1298 
»t
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1299 ià(
»t
)

1300 
¡İ
;

1302 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0))

1303 
gc_ty³
 = 
FG_GC
;

1307 ià(
gc_ty³
 =ğ
BG_GC
 && !
background
) {

1308 
»t
 = -
EINVAL
;

1309 
¡İ
;

1311 ià(!
	`__g‘_viùim
(
sbi
, &
£gno
, 
gc_ty³
)) {

1312 
»t
 = -
ENODATA
;

1313 
¡İ
;

1316 
£g_ä“d
 = 
	`do_g¬bage_cŞËù
(
sbi
, 
£gno
, &
gc_li¡
, 
gc_ty³
);

1317 ià(
gc_ty³
 =ğ
FG_GC
 && 
£g_ä“d
 =ğ
sbi
->
£gs_³r_£c
)

1318 
£c_ä“d
++;

1319 
tÙ®_ä“d
 +ğ
£g_ä“d
;

1321 ià(
gc_ty³
 =ğ
FG_GC
) {

1322 ià(
sbi
->
sk³d_©omic_fes
[
FG_GC
] > 
Ï¡_sk³d
 ||

1323 
sbi
->
sk³d_gc_rw£m
)

1324 
sk³d_round
++;

1325 
Ï¡_sk³d
 = 
sbi
->
sk³d_©omic_fes
[
FG_GC
];

1326 
round
++;

1329 ià(
gc_ty³
 =ğ
FG_GC
 && 
£g_ä“d
)

1330 
sbi
->
cur_viùim_£c
 = 
NULL_SEGNO
;

1332 ià(
sync
)

1333 
¡İ
;

1335 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 
£c_ä“d
, 0)) {

1336 ià(
sk³d_round
 <ğ
MAX_SKIP_GC_COUNT
 ||

1337 
sk³d_round
 * 2 < 
round
) {

1338 
£gno
 = 
NULL_SEGNO
;

1339 
gc_mÜe
;

1342 ià(
fœ¡_sk³d
 < 
Ï¡_sk³d
 &&

1343 (
Ï¡_sk³d
 - 
fœ¡_sk³d
) >

1344 
sbi
->
sk³d_gc_rw£m
) {

1345 
	`f2fs_drİ_šmem_·ges_®l
(
sbi
, 
Œue
);

1346 
£gno
 = 
NULL_SEGNO
;

1347 
gc_mÜe
;

1349 ià(
gc_ty³
 =ğ
FG_GC
 && !
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
))

1350 
»t
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1352 
¡İ
:

1353 
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
ALLOC_NEXT
] = 0;

1354 
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
FLUSH_DEVICE
] = 
š™_£gno
;

1356 
	`Œaû_f2fs_gc_’d
(
sbi
->
sb
, 
»t
, 
tÙ®_ä“d
, 
£c_ä“d
,

1357 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
),

1358 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
),

1359 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_IMETA
),

1360 
	`ä“_£ùiÚs
(
sbi
),

1361 
	`ä“_£gm’ts
(
sbi
),

1362 
	`»£rved_£gm’ts
(
sbi
),

1363 
	`´eä“_£gm’ts
(
sbi
));

1365 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

1367 
	`put_gc_šode
(&
gc_li¡
);

1369 ià(
sync
 && !
»t
)

1370 
»t
 = 
£c_ä“d
 ? 0 : -
EAGAIN
;

1371  
»t
;

1372 
	}
}

1374 
	$f2fs_bud_gc_mªag”
(
f2fs_sb_šfo
 *
sbi
)

1376 
	`DIRTY_I
(
sbi
)->
v_İs
 = &
deçuÉ_v_İs
;

1378 
sbi
->
gc_pš_fe_th»shŞd
 = 
DEF_GC_FAILED_PINNED_FILES
;

1381 ià(
	`f2fs_is_muÉi_deviû
(
sbi
è&& !
	`__is_Ïrge_£ùiÚ
(sbi))

1382 
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
ALLOC_NEXT
] =

1383 
	`GET_SEGNO
(
sbi
, 
	`FDEV
(0).
’d_blk
) + 1;

1384 
	}
}

1386 
	$ä“_£gm’t_¿nge
(
f2fs_sb_šfo
 *
sbi
, 
¡¬t
,

1387 
’d
)

1389 
ty³
;

1390 
£gno
, 
Ãxt_šu£
;

1391 
”r
 = 0;

1394 
ty³
 = 
CURSEG_HOT_DATA
;y³ < 
NR_CURSEG_TYPE
;ype++)

1395 
	`®loÿ‹_£gm’t_fÜ_»size
(
sbi
, 
ty³
, 
¡¬t
, 
’d
);

1398 
£gno
 = 
¡¬t
; segnØ<ğ
’d
; segnØ+ğ
sbi
->
£gs_³r_£c
) {

1399 
gc_šode_li¡
 
gc_li¡
 = {

1400 .
i¡
 = 
	`LIST_HEAD_INIT
(
gc_li¡
.ilist),

1401 .
œoÙ
 = 
	`RADIX_TREE_INIT
(
gc_li¡
.œoÙ, 
GFP_NOFS
),

1404 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

1405 
	`do_g¬bage_cŞËù
(
sbi
, 
£gno
, &
gc_li¡
, 
FG_GC
);

1406 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

1407 
	`put_gc_šode
(&
gc_li¡
);

1409 ià(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
Œue
))

1410  -
EAGAIN
;

1413 
”r
 = 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

1414 ià(
”r
)

1415  
”r
;

1417 
Ãxt_šu£
 = 
	`fšd_Ãxt_šu£
(
	`FREE_I
(
sbi
), 
’d
 + 1, 
¡¬t
);

1418 ià(
Ãxt_šu£
 <ğ
’d
) {

1419 
	`f2fs_”r
(
sbi
, "segno %u should be free but still inuse!",

1420 
Ãxt_šu£
);

1421 
	`f2fs_bug_Ú
(
sbi
, 1);

1423  
”r
;

1424 
	}
}

1426 
	$upd©e_sb_m‘ad©a
(
f2fs_sb_šfo
 *
sbi
, 
£cs
)

1428 
f2fs_su³r_block
 *
¿w_sb
 = 
	`F2FS_RAW_SUPER
(
sbi
);

1429 
£ùiÚ_couÁ
 = 
	`Ë32_to_ıu
(
¿w_sb
->section_count);

1430 
£gm’t_couÁ
 = 
	`Ë32_to_ıu
(
¿w_sb
->segment_count);

1431 
£gm’t_couÁ_maš
 = 
	`Ë32_to_ıu
(
¿w_sb
->segment_count_main);

1432 
block_couÁ
 = 
	`Ë64_to_ıu
(
¿w_sb
->block_count);

1433 
£gs
 = 
£cs
 * 
sbi
->
£gs_³r_£c
;

1435 
¿w_sb
->
£ùiÚ_couÁ
 = 
	`ıu_to_Ë32
(£ùiÚ_couÁ + 
£cs
);

1436 
¿w_sb
->
£gm’t_couÁ
 = 
	`ıu_to_Ë32
(£gm’t_couÁ + 
£gs
);

1437 
¿w_sb
->
£gm’t_couÁ_maš
 = 
	`ıu_to_Ë32
(£gm’t_couÁ_maš + 
£gs
);

1438 
¿w_sb
->
block_couÁ
 = 
	`ıu_to_Ë64
(block_count +

1439 ()
£gs
 * 
sbi
->
blocks_³r_£g
);

1440 
	}
}

1442 
	$upd©e_fs_m‘ad©a
(
f2fs_sb_šfo
 *
sbi
, 
£cs
)

1444 
£gs
 = 
£cs
 * 
sbi
->
£gs_³r_£c
;

1445 
u£r_block_couÁ
 =

1446 
	`Ë64_to_ıu
(
	`F2FS_CKPT
(
sbi
)->
u£r_block_couÁ
);

1448 
	`SM_I
(
sbi
)->
£gm’t_couÁ
 = ()SM_I(sbi)->£gm’t_couÁ + 
£gs
;

1449 
	`MAIN_SEGS
(
sbi
èğ()MAIN_SEGS(sbiè+ 
£gs
;

1450 
	`FREE_I
(
sbi
)->
ä“_£ùiÚs
 = ()FREE_I(sbi)->ä“_£ùiÚ + 
£cs
;

1451 
	`FREE_I
(
sbi
)->
ä“_£gm’ts
 = ()FREE_I(sbi)->ä“_£gm’t + 
£gs
;

1452 
	`F2FS_CKPT
(
sbi
)->
u£r_block_couÁ
 = 
	`ıu_to_Ë64
(user_block_count +

1453 ()
£gs
 * 
sbi
->
blocks_³r_£g
);

1454 
	}
}

1456 
	$f2fs_»size_fs
(
f2fs_sb_šfo
 *
sbi
, 
__u64
 
block_couÁ
)

1458 
__u64
 
Şd_block_couÁ
, 
shrunk_blocks
;

1459 
£cs
;

1460 
gc_mode
, 
gc_ty³
;

1461 
”r
 = 0;

1462 
__u32
 
»m
;

1464 
Şd_block_couÁ
 = 
	`Ë64_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
block_couÁ
);

1465 ià(
block_couÁ
 > 
Şd_block_couÁ
)

1466  -
EINVAL
;

1469 
	`div_u64_»m
(
block_couÁ
, 
	`BLKS_PER_SEC
(
sbi
), &
»m
);

1470 ià(
»m
)

1471  -
EINVAL
;

1473 ià(
block_couÁ
 =ğ
Şd_block_couÁ
)

1476 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_FSCK
)) {

1477 
	`f2fs_”r
(
sbi
, "Should„un fscko„epair first.");

1478  -
EFSCORRUPTED
;

1481 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_CHECKPOINT
)) {

1482 
	`f2fs_”r
(
sbi
, "Checkpoint should beƒnabled.");

1483  -
EINVAL
;

1486 
	`ä“ze_bdev
(
sbi
->
sb
->
s_bdev
);

1488 
shrunk_blocks
 = 
Şd_block_couÁ
 - 
block_couÁ
;

1489 
£cs
 = 
	`div_u64
(
shrunk_blocks
, 
	`BLKS_PER_SEC
(
sbi
));

1490 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1491 ià(
shrunk_blocks
 + 
	`v®id_u£r_blocks
(
sbi
) +

1492 
sbi
->
cu¼’t_»£rved_blocks
 + sbi->
unu§bË_block_couÁ
 +

1493 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
 > sbi->
u£r_block_couÁ
)

1494 
”r
 = -
ENOSPC
;

1496 
sbi
->
u£r_block_couÁ
 -ğ
shrunk_blocks
;

1497 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1498 ià(
”r
) {

1499 
	`thaw_bdev
(
sbi
->
sb
->
s_bdev
, sbi->sb);

1500  
”r
;

1503 
	`mu‹x_lock
(&
sbi
->
»size_mu‹x
);

1504 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_RESIZEFS
);

1506 
	`mu‹x_lock
(&
	`DIRTY_I
(
sbi
)->
£gli¡_lock
);

1508 
	`MAIN_SECS
(
sbi
è-ğ
£cs
;

1510 
gc_mode
 = 0; gc_mod< 
MAX_GC_POLICY
; gc_mode++)

1511 ià(
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
gc_mode
] >=

1512 
	`MAIN_SECS
(
sbi
è* sbi->
£gs_³r_£c
)

1513 
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
gc_mode
] = 0;

1515 
gc_ty³
 = 
BG_GC
; gc_ty³ <ğ
FG_GC
; gc_type++)

1516 ià(
sbi
->
Ãxt_viùim_£g
[
gc_ty³
] >=

1517 
	`MAIN_SECS
(
sbi
è* sbi->
£gs_³r_£c
)

1518 
sbi
->
Ãxt_viùim_£g
[
gc_ty³
] = 
NULL_SEGNO
;

1520 
	`mu‹x_uÆock
(&
	`DIRTY_I
(
sbi
)->
£gli¡_lock
);

1522 
”r
 = 
	`ä“_£gm’t_¿nge
(
sbi
, 
	`MAIN_SECS
(sbiè* sbi->
£gs_³r_£c
,

1523 
	`MAIN_SEGS
(
sbi
) - 1);

1524 ià(
”r
)

1525 
out
;

1527 
	`upd©e_sb_m‘ad©a
(
sbi
, -
£cs
);

1529 
”r
 = 
	`f2fs_comm™_su³r
(
sbi
, 
çl£
);

1530 ià(
”r
) {

1531 
	`upd©e_sb_m‘ad©a
(
sbi
, 
£cs
);

1532 
out
;

1535 
	`upd©e_fs_m‘ad©a
(
sbi
, -
£cs
);

1536 
	`ş—r_sbi_æag
(
sbi
, 
SBI_IS_RESIZEFS
);

1537 
”r
 = 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

1538 ià(
”r
) {

1539 
	`upd©e_fs_m‘ad©a
(
sbi
, 
£cs
);

1540 
	`upd©e_sb_m‘ad©a
(
sbi
, 
£cs
);

1541 
	`f2fs_comm™_su³r
(
sbi
, 
çl£
);

1543 
out
:

1544 ià(
”r
) {

1545 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

1546 
	`f2fs_”r
(
sbi
, "resize_fs failed, should„un fscko„epair!");

1548 
	`MAIN_SECS
(
sbi
è+ğ
£cs
;

1549 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1550 
sbi
->
u£r_block_couÁ
 +ğ
shrunk_blocks
;

1551 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1553 
	`ş—r_sbi_æag
(
sbi
, 
SBI_IS_RESIZEFS
);

1554 
	`mu‹x_uÆock
(&
sbi
->
»size_mu‹x
);

1555 
	`thaw_bdev
(
sbi
->
sb
->
s_bdev
, sbi->sb);

1556  
”r
;

1557 
	}
}

	@gc.h

8 
	#GC_THREAD_MIN_WB_PAGES
 1

	)

13 
	#DEF_GC_THREAD_URGENT_SLEEP_TIME
 500

	)

14 
	#DEF_GC_THREAD_MIN_SLEEP_TIME
 30000

	)

15 
	#DEF_GC_THREAD_MAX_SLEEP_TIME
 60000

	)

16 
	#DEF_GC_THREAD_NOGC_SLEEP_TIME
 300000

	)

17 
	#LIMIT_INVALID_BLOCK
 40

	)

18 
	#LIMIT_FREE_BLOCK
 40

	)

20 
	#DEF_GC_FAILED_PINNED_FILES
 2048

	)

23 
	#DEF_MAX_VICTIM_SEARCH
 4096

	)

25 
	sf2fs_gc_kth»ad
 {

26 
sk_¡ruù
 *
	mf2fs_gc_sk
;

27 
wa™_queue_h—d_t
 
	mgc_wa™_queue_h—d
;

30 
	murg’t_¦“p_time
;

31 
	mmš_¦“p_time
;

32 
	mmax_¦“p_time
;

33 
	mno_gc_¦“p_time
;

36 
	mgc_wake
;

39 
	sgc_šode_li¡
 {

40 
li¡_h—d
 
	mi¡
;

41 
¿dix_Œ“_roÙ
 
	mœoÙ
;

47 
šlše
 
block_t
 
	$ä“_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

49 ià(
	`ä“_£gm’ts
(
sbi
è< 
	`ov”´ovisiÚ_£gm’ts
(sbi))

52  (
	`ä“_£gm’ts
(
sbi
è- 
	`ov”´ovisiÚ_£gm’ts
(sbi))

53 << 
sbi
->
log_blocks_³r_£g
;

54 
	}
}

56 
šlše
 
block_t
 
	$lim™_šv®id_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

58  ()(
sbi
->
u£r_block_couÁ
 * 
LIMIT_INVALID_BLOCK
) / 100;

59 
	}
}

61 
šlše
 
block_t
 
	$lim™_ä“_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

63 
block_t
 
»şaimabË_u£r_blocks
 = 
sbi
->
u£r_block_couÁ
 -

64 
	`wr™‹n_block_couÁ
(
sbi
);

65  ()(
»şaimabË_u£r_blocks
 * 
LIMIT_FREE_BLOCK
) / 100;

66 
	}
}

68 
šlše
 
	$šü—£_¦“p_time
(
f2fs_gc_kth»ad
 *
gc_th
,

69 *
wa™
)

71 
mš_time
 = 
gc_th
->
mš_¦“p_time
;

72 
max_time
 = 
gc_th
->
max_¦“p_time
;

74 ià(*
wa™
 =ğ
gc_th
->
no_gc_¦“p_time
)

77 ià(()*
wa™
 + ()
mš_time
 > ()
max_time
)

78 *
wa™
 = 
max_time
;

80 *
wa™
 +ğ
mš_time
;

81 
	}
}

83 
šlše
 
	$deü—£_¦“p_time
(
f2fs_gc_kth»ad
 *
gc_th
,

84 *
wa™
)

86 
mš_time
 = 
gc_th
->
mš_¦“p_time
;

88 ià(*
wa™
 =ğ
gc_th
->
no_gc_¦“p_time
)

89 *
wa™
 = 
gc_th
->
max_¦“p_time
;

91 ià(()*
wa™
 - ()
mš_time
 < ()min_time)

92 *
wa™
 = 
mš_time
;

94 *
wa™
 -ğ
mš_time
;

95 
	}
}

97 
šlše
 
boŞ
 
	$has_’ough_šv®id_blocks
(
f2fs_sb_šfo
 *
sbi
)

99 
block_t
 
šv®id_u£r_blocks
 = 
sbi
->
u£r_block_couÁ
 -

100 
	`wr™‹n_block_couÁ
(
sbi
);

106 ià(
šv®id_u£r_blocks
 > 
	`lim™_šv®id_u£r_blocks
(
sbi
) &&

107 
	`ä“_u£r_blocks
(
sbi
è< 
	`lim™_ä“_u£r_blocks
(sbi))

108  
Œue
;

109  
çl£
;

110 
	}
}

	@hash.c

12 
	~<lšux/ty³s.h
>

13 
	~<lšux/fs.h
>

14 
	~<lšux/f2fs_fs.h
>

15 
	~<lšux/üy±ohash.h
>

16 
	~<lšux/·gem­.h
>

17 
	~<lšux/unicode.h
>

19 
	~"f2fs.h
"

24 
	#DELTA
 0x9E3779B9

	)

26 
	$TEA_ŒªsfÜm
(
buf
[4], cÚ¡ 
š
[])

28 
__u32
 
sum
 = 0;

29 
__u32
 
b0
 = 
buf
[0], 
b1
 = buf[1];

30 
__u32
 
a
 = 
š
[0], 
b
 = in[1], 
c
 = in[2], 
d
 = in[3];

31 
n
 = 16;

34 
sum
 +ğ
DELTA
;

35 
b0
 +ğ((
b1
 << 4)+
a
è^ (b1+
sum
è^ ((b1 >> 5)+
b
);

36 
b1
 +ğ((
b0
 << 4)+
c
è^ (b0+
sum
è^ ((b0 >> 5)+
d
);

37 } --
n
);

39 
buf
[0] +ğ
b0
;

40 
buf
[1] +ğ
b1
;

41 
	}
}

43 
	$¡r2hashbuf
(cÚ¡ *
msg
, 
size_t
 
Ën
,

44 *
buf
, 
num
)

46 
·d
, 
v®
;

47 
i
;

49 
·d
 = (
__u32
)
Ën
 | ((__u32)len << 8);

50 
·d
 |=…ad << 16;

52 
v®
 = 
·d
;

53 ià(
Ën
 > 
num
 * 4)

54 
Ën
 = 
num
 * 4;

55 
i
 = 0; i < 
Ën
; i++) {

56 ià((
i
 % 4) == 0)

57 
v®
 = 
·d
;

58 
v®
 = 
msg
[
i
] + (val << 8);

59 ià((
i
 % 4) == 3) {

60 *
buf
++ = 
v®
;

61 
v®
 = 
·d
;

62 
num
--;

65 ià(--
num
 >= 0)

66 *
buf
++ = 
v®
;

67 --
num
 >= 0)

68 *
buf
++ = 
·d
;

69 
	}
}

71 
f2fs_hash_t
 
	$__f2fs_d’Œy_hash
(cÚ¡ 
q¡r
 *
Çme_šfo
,

72 
fsüy±_Çme
 *
âame
)

74 
__u32
 
hash
;

75 
f2fs_hash_t
 
f2fs_hash
;

76 cÚ¡ *
p
;

77 
__u32
 
š
[8], 
buf
[4];

78 cÚ¡ *
Çme
 = 
Çme_šfo
->name;

79 
size_t
 
Ën
 = 
Çme_šfo
->len;

82 ià(
âame
 && !âame->
disk_Çme
.
Çme
)

83  
	`ıu_to_Ë32
(
âame
->
hash
);

85 ià(
	`is_dÙ_dÙdÙ
(
Çme_šfo
))

89 
buf
[0] = 0x67452301;

90 
buf
[1] = 0xefcdab89;

91 
buf
[2] = 0x98badcfe;

92 
buf
[3] = 0x10325476;

94 
p
 = 
Çme
;

96 
	`¡r2hashbuf
(
p
, 
Ën
, 
š
, 4);

97 
	`TEA_ŒªsfÜm
(
buf
, 
š
);

98 
p
 += 16;

99 ià(
Ën
 <= 16)

101 
Ën
 -= 16;

103 
hash
 = 
buf
[0];

104 
f2fs_hash
 = 
	`ıu_to_Ë32
(
hash
 & ~
F2FS_HASH_COL_BIT
);

105  
f2fs_hash
;

106 
	}
}

108 
f2fs_hash_t
 
	$f2fs_d’Œy_hash
(cÚ¡ 
šode
 *
dœ
,

109 cÚ¡ 
q¡r
 *
Çme_šfo
, 
fsüy±_Çme
 *
âame
)

111 #ifdeà
CONFIG_UNICODE


112 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
dœ
->
i_sb
);

113 cÚ¡ 
unicode_m­
 *
um
 = 
sbi
->
s_’codšg
;

114 
r
, 
dËn
;

115 *
buff
;

116 
q¡r
 
fŞded
;

118 ià(!
Çme_šfo
->
Ën
 || !
	`IS_CASEFOLDED
(
dœ
))

119 
İaque_£q
;

121 
buff
 = 
	`f2fs_kz®loc
(
sbi
, (è* 
PATH_MAX
, 
GFP_KERNEL
);

122 ià(!
buff
)

123  -
ENOMEM
;

125 
dËn
 = 
	`utf8_ÿ£fŞd
(
um
, 
Çme_šfo
, 
buff
, 
PATH_MAX
);

126 ià(
dËn
 < 0) {

127 
	`kvä“
(
buff
);

128 
İaque_£q
;

130 
fŞded
.
Çme
 = 
buff
;

131 
fŞded
.
Ën
 = 
dËn
;

132 
r
 = 
	`__f2fs_d’Œy_hash
(&
fŞded
, 
âame
);

134 
	`kvä“
(
buff
);

135  
r
;

137 
İaque_£q
:

139  
	`__f2fs_d’Œy_hash
(
Çme_šfo
, 
âame
);

140 
	}
}

	@inline.c

9 
	~<lšux/fs.h
>

10 
	~<lšux/f2fs_fs.h
>

12 
	~"f2fs.h
"

13 
	~"node.h
"

15 
boŞ
 
	$f2fs_may_šlše_d©a
(
šode
 *inode)

17 ià(
	`f2fs_is_©omic_fe
(
šode
))

18  
çl£
;

20 ià(!
	`S_ISREG
(
šode
->
i_mode
è&& !
	`S_ISLNK
(inode->i_mode))

21  
çl£
;

23 ià(
	`i_size_»ad
(
šode
è> 
	`MAX_INLINE_DATA
(inode))

24  
çl£
;

26 ià(
	`f2fs_po¡_»ad_»quœed
(
šode
))

27  
çl£
;

29  
Œue
;

30 
	}
}

32 
boŞ
 
	$f2fs_may_šlše_d’Œy
(
šode
 *inode)

34 ià(!
	`‹¡_İt
(
	`F2FS_I_SB
(
šode
), 
INLINE_DENTRY
))

35  
çl£
;

37 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

38  
çl£
;

40  
Œue
;

41 
	}
}

43 
	$f2fs_do_»ad_šlše_d©a
(
·ge
 *·ge, ·g*
age
)

45 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

46 *
¤c_addr
, *
d¡_addr
;

48 ià(
	`PageU±od©e
(
·ge
))

51 
	`f2fs_bug_Ú
(
	`F2FS_P_SB
(
·ge
),…age->
šdex
);

53 
	`z”o_u£r_£gm’t
(
·ge
, 
	`MAX_INLINE_DATA
(
šode
), 
PAGE_SIZE
);

56 
¤c_addr
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

57 
d¡_addr
 = 
	`km­_©omic
(
·ge
);

58 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
	`MAX_INLINE_DATA
(
šode
));

59 
	`æush_dÿche_·ge
(
·ge
);

60 
	`kunm­_©omic
(
d¡_addr
);

61 ià(!
	`PageU±od©e
(
·ge
))

62 
	`S‘PageU±od©e
(
·ge
);

63 
	}
}

65 
	$f2fs_Œunÿ‹_šlše_šode
(
šode
 *inode,

66 
·ge
 *
age
, 
u64
 
äom
)

68 *
addr
;

70 ià(
äom
 >ğ
	`MAX_INLINE_DATA
(
šode
))

73 
addr
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

75 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
,rue);

76 
	`mem£t
(
addr
 + 
äom
, 0, 
	`MAX_INLINE_DATA
(
šode
) - from);

77 
	`£t_·ge_dœty
(
age
);

79 ià(
äom
 == 0)

80 
	`ş—r_šode_æag
(
šode
, 
FI_DATA_EXIST
);

81 
	}
}

83 
	$f2fs_»ad_šlše_d©a
(
šode
 *šode, 
·ge
 *page)

85 
·ge
 *
age
;

87 
age
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

88 ià(
	`IS_ERR
(
age
)) {

89 
	`uÆock_·ge
(
·ge
);

90  
	`PTR_ERR
(
age
);

93 ià(!
	`f2fs_has_šlše_d©a
(
šode
)) {

94 
	`f2fs_put_·ge
(
age
, 1);

95  -
EAGAIN
;

98 ià(
·ge
->
šdex
)

99 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

101 
	`f2fs_do_»ad_šlše_d©a
(
·ge
, 
age
);

103 ià(!
	`PageU±od©e
(
·ge
))

104 
	`S‘PageU±od©e
(
·ge
);

105 
	`f2fs_put_·ge
(
age
, 1);

106 
	`uÆock_·ge
(
·ge
);

108 
	}
}

110 
	$f2fs_cÚv”t_šlše_·ge
(
dnode_of_d©a
 *
dn
, 
·ge
 *page)

112 
f2fs_io_šfo
 
fio
 = {

113 .
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
),

114 .
šo
 = 
dn
->
šode
->
i_šo
,

115 .
ty³
 = 
DATA
,

116 .
İ
 = 
REQ_OP_WRITE
,

117 .
İ_æags
 = 
REQ_SYNC
 | 
REQ_PRIO
,

118 .
·ge
 =…age,

119 .
’üy±ed_·ge
 = 
NULL
,

120 .
io_ty³
 = 
FS_DATA_IO
,

122 
node_šfo
 
ni
;

123 
dœty
, 
”r
;

125 ià(!
	`f2fs_exi¡_d©a
(
dn
->
šode
))

126 
ş—r_out
;

128 
”r
 = 
	`f2fs_»£rve_block
(
dn
, 0);

129 ià(
”r
)

130  
”r
;

132 
”r
 = 
	`f2fs_g‘_node_šfo
(
fio
.
sbi
, 
dn
->
nid
, &
ni
);

133 ià(
”r
) {

134 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(
dn
, 1);

135 
	`f2fs_put_dnode
(
dn
);

136  
”r
;

139 
fio
.
v”siÚ
 = 
ni
.version;

141 ià(
	`uÆik–y
(
dn
->
d©a_blkaddr
 !ğ
NEW_ADDR
)) {

142 
	`f2fs_put_dnode
(
dn
);

143 
	`£t_sbi_æag
(
fio
.
sbi
, 
SBI_NEED_FSCK
);

144 
	`f2fs_w¬n
(
fio
.
sbi
, "%s: corrupted inline inode ino=%lx, i_addr[0]:0x%x,„un fscko fix.",

145 
__func__
, 
dn
->
šode
->
i_šo
, dn->
d©a_blkaddr
);

146  -
EFSCORRUPTED
;

149 
	`f2fs_bug_Ú
(
	`F2FS_P_SB
(
·ge
), 
	`PageWr™eback
(page));

151 
	`f2fs_do_»ad_šlše_d©a
(
·ge
, 
dn
->
šode_·ge
);

152 
	`£t_·ge_dœty
(
·ge
);

155 
dœty
 = 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

158 
	`£t_·ge_wr™eback
(
·ge
);

159 
	`CË¬PageE¼Ü
(
·ge
);

160 
fio
.
Şd_blkaddr
 = 
dn
->
d©a_blkaddr
;

161 
	`£t_šode_æag
(
dn
->
šode
, 
FI_HOT_DATA
);

162 
	`f2fs_ouÏû_wr™e_d©a
(
dn
, &
fio
);

163 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
,rue);

164 ià(
dœty
) {

165 
	`šode_dec_dœty_·ges
(
dn
->
šode
);

166 
	`f2fs_»move_dœty_šode
(
dn
->
šode
);

170 
	`£t_šode_æag
(
dn
->
šode
, 
FI_APPEND_WRITE
);

173 
	`f2fs_Œunÿ‹_šlše_šode
(
dn
->
šode
, dn->
šode_·ge
, 0);

174 
	`ş—r_šlše_node
(
dn
->
šode_·ge
);

175 
ş—r_out
:

176 
	`¡©_dec_šlše_šode
(
dn
->
šode
);

177 
	`ş—r_šode_æag
(
dn
->
šode
, 
FI_INLINE_DATA
);

178 
	`f2fs_put_dnode
(
dn
);

180 
	}
}

182 
	$f2fs_cÚv”t_šlše_šode
(
šode
 *inode)

184 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

185 
dnode_of_d©a
 
dn
;

186 
·ge
 *
age
, *page;

187 
”r
 = 0;

189 ià(!
	`f2fs_has_šlše_d©a
(
šode
))

192 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
šode
->
i_m­pšg
, 0, 
çl£
);

193 ià(!
·ge
)

194  -
ENOMEM
;

196 
	`f2fs_lock_İ
(
sbi
);

198 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

199 ià(
	`IS_ERR
(
age
)) {

200 
”r
 = 
	`PTR_ERR
(
age
);

201 
out
;

204 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
age
, ipage, 0);

206 ià(
	`f2fs_has_šlše_d©a
(
šode
))

207 
”r
 = 
	`f2fs_cÚv”t_šlše_·ge
(&
dn
, 
·ge
);

209 
	`f2fs_put_dnode
(&
dn
);

210 
out
:

211 
	`f2fs_uÆock_İ
(
sbi
);

213 
	`f2fs_put_·ge
(
·ge
, 1);

215 
	`f2fs_b®ªû_fs
(
sbi
, 
dn
.
node_chªged
);

217  
”r
;

218 
	}
}

220 
	$f2fs_wr™e_šlše_d©a
(
šode
 *šode, 
·ge
 *page)

222 *
¤c_addr
, *
d¡_addr
;

223 
dnode_of_d©a
 
dn
;

224 
”r
;

226 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

227 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 0, 
LOOKUP_NODE
);

228 ià(
”r
)

229  
”r
;

231 ià(!
	`f2fs_has_šlše_d©a
(
šode
)) {

232 
	`f2fs_put_dnode
(&
dn
);

233  -
EAGAIN
;

236 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
·ge
->
šdex
);

238 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
.
šode_·ge
, 
NODE
, 
Œue
,rue);

239 
¤c_addr
 = 
	`km­_©omic
(
·ge
);

240 
d¡_addr
 = 
	`šlše_d©a_addr
(
šode
, 
dn
.
šode_·ge
);

241 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
	`MAX_INLINE_DATA
(
šode
));

242 
	`kunm­_©omic
(
¤c_addr
);

243 
	`£t_·ge_dœty
(
dn
.
šode_·ge
);

245 
	`f2fs_ş—r_·ge_ÿche_dœty_g
(
·ge
);

247 
	`£t_šode_æag
(
šode
, 
FI_APPEND_WRITE
);

248 
	`£t_šode_æag
(
šode
, 
FI_DATA_EXIST
);

250 
	`ş—r_šlše_node
(
dn
.
šode_·ge
);

251 
	`f2fs_put_dnode
(&
dn
);

253 
	}
}

255 
boŞ
 
	$f2fs_»cov”_šlše_d©a
(
šode
 *šode, 
·ge
 *
Åage
)

257 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

258 
f2fs_šode
 *
ri
 = 
NULL
;

259 *
¤c_addr
, *
d¡_addr
;

260 
·ge
 *
age
;

270 ià(
	`IS_INODE
(
Åage
))

271 
ri
 = 
	`F2FS_INODE
(
Åage
);

273 ià(
	`f2fs_has_šlše_d©a
(
šode
) &&

274 
ri
 && (ri->
i_šlše
 & 
F2FS_INLINE_DATA
)) {

275 
´oûss_šlše
:

276 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

277 
	`f2fs_bug_Ú
(
sbi
, 
	`IS_ERR
(
age
));

279 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
,rue);

281 
¤c_addr
 = 
	`šlše_d©a_addr
(
šode
, 
Åage
);

282 
d¡_addr
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

283 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
	`MAX_INLINE_DATA
(
šode
));

285 
	`£t_šode_æag
(
šode
, 
FI_INLINE_DATA
);

286 
	`£t_šode_æag
(
šode
, 
FI_DATA_EXIST
);

288 
	`£t_·ge_dœty
(
age
);

289 
	`f2fs_put_·ge
(
age
, 1);

290  
Œue
;

293 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

294 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

295 
	`f2fs_bug_Ú
(
sbi
, 
	`IS_ERR
(
age
));

296 
	`f2fs_Œunÿ‹_šlše_šode
(
šode
, 
age
, 0);

297 
	`ş—r_šode_æag
(
šode
, 
FI_INLINE_DATA
);

298 
	`f2fs_put_·ge
(
age
, 1);

299 } ià(
ri
 && (ri->
i_šlše
 & 
F2FS_INLINE_DATA
)) {

300 ià(
	`f2fs_Œunÿ‹_blocks
(
šode
, 0, 
çl£
))

301  
çl£
;

302 
´oûss_šlše
;

304  
çl£
;

305 
	}
}

307 
f2fs_dœ_’Œy
 *
	$f2fs_fšd_š_šlše_dœ
(
šode
 *
dœ
,

308 
fsüy±_Çme
 *
âame
, 
·ge
 **
»s_·ge
)

310 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
dœ
->
i_sb
);

311 
q¡r
 
Çme
 = 
	`FSTR_TO_QSTR
(&
âame
->
disk_Çme
);

312 
f2fs_dœ_’Œy
 *
de
;

313 
f2fs_d’Œy_±r
 
d
;

314 
·ge
 *
age
;

315 *
šlše_d’Œy
;

316 
f2fs_hash_t
 
Çmehash
;

318 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
dœ
->
i_šo
);

319 ià(
	`IS_ERR
(
age
)) {

320 *
»s_·ge
 = 
age
;

321  
NULL
;

324 
Çmehash
 = 
	`f2fs_d’Œy_hash
(
dœ
, &
Çme
, 
âame
);

326 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
dœ
, 
age
);

328 
	`make_d’Œy_±r_šlše
(
dœ
, &
d
, 
šlše_d’Œy
);

329 
de
 = 
	`f2fs_fšd_rg‘_d’Œy
(
âame
, 
Çmehash
, 
NULL
, &
d
);

330 
	`uÆock_·ge
(
age
);

331 ià(
de
)

332 *
»s_·ge
 = 
age
;

334 
	`f2fs_put_·ge
(
age
, 0);

336  
de
;

337 
	}
}

339 
	$f2fs_make_em±y_šlše_dœ
(
šode
 *šode, šod*
·»Á
,

340 
·ge
 *
age
)

342 
f2fs_d’Œy_±r
 
d
;

343 *
šlše_d’Œy
;

345 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

347 
	`make_d’Œy_±r_šlše
(
šode
, &
d
, 
šlše_d’Œy
);

348 
	`f2fs_do_make_em±y_dœ
(
šode
, 
·»Á
, &
d
);

350 
	`£t_·ge_dœty
(
age
);

353 ià(
	`i_size_»ad
(
šode
è< 
	`MAX_INLINE_DATA
(inode))

354 
	`f2fs_i_size_wr™e
(
šode
, 
	`MAX_INLINE_DATA
(inode));

356 
	}
}

362 
	$f2fs_move_šlše_dœ’ts
(
šode
 *
dœ
, 
·ge
 *
age
,

363 *
šlše_d’Œy
)

365 
·ge
 *page;

366 
dnode_of_d©a
 
dn
;

367 
f2fs_d’Œy_block
 *
d’Œy_blk
;

368 
f2fs_d’Œy_±r
 
¤c
, 
d¡
;

369 
”r
;

371 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
dœ
->
i_m­pšg
, 0, 
çl£
);

372 ià(!
·ge
) {

373 
	`f2fs_put_·ge
(
age
, 1);

374  -
ENOMEM
;

377 
	`£t_Ãw_dnode
(&
dn
, 
dœ
, 
age
, 
NULL
, 0);

378 
”r
 = 
	`f2fs_»£rve_block
(&
dn
, 0);

379 ià(
”r
)

380 
out
;

382 ià(
	`uÆik–y
(
dn
.
d©a_blkaddr
 !ğ
NEW_ADDR
)) {

383 
	`f2fs_put_dnode
(&
dn
);

384 
	`£t_sbi_æag
(
	`F2FS_P_SB
(
·ge
), 
SBI_NEED_FSCK
);

385 
	`f2fs_w¬n
(
	`F2FS_P_SB
(
·ge
), "%s: corrupted inline inode ino=%lx, i_addr[0]:0x%x,„un fscko fix.",

386 
__func__
, 
dœ
->
i_šo
, 
dn
.
d©a_blkaddr
);

387 
”r
 = -
EFSCORRUPTED
;

388 
out
;

391 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
,rue);

393 
d’Œy_blk
 = 
	`·ge_add»ss
(
·ge
);

395 
	`make_d’Œy_±r_šlše
(
dœ
, &
¤c
, 
šlše_d’Œy
);

396 
	`make_d’Œy_±r_block
(
dœ
, &
d¡
, 
d’Œy_blk
);

399 
	`memıy
(
d¡
.
b™m­
, 
¤c
.b™m­, src.
Ä_b™m­
);

400 
	`mem£t
(
d¡
.
b™m­
 + 
¤c
.
Ä_b™m­
, 0, dst.nr_bitmap - src.nr_bitmap);

407 
	`memıy
(
d¡
.
d’Œy
, 
¤c
.d’Œy, 
SIZE_OF_DIR_ENTRY
 * src.
max
);

408 
	`memıy
(
d¡
.
f’ame
, 
¤c
.f’ame, src.
max
 * 
F2FS_SLOT_LEN
);

410 ià(!
	`PageU±od©e
(
·ge
))

411 
	`S‘PageU±od©e
(
·ge
);

412 
	`£t_·ge_dœty
(
·ge
);

415 
	`f2fs_Œunÿ‹_šlše_šode
(
dœ
, 
age
, 0);

417 
	`¡©_dec_šlše_dœ
(
dœ
);

418 
	`ş—r_šode_æag
(
dœ
, 
FI_INLINE_DENTRY
);

424 ià(!
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
	`F2FS_I_SB
(
dœ
)) &&

425 !
	`f2fs_has_šlše_x©Œ
(
dœ
))

426 
	`F2FS_I
(
dœ
)->
i_šlše_x©Œ_size
 = 0;

428 
	`f2fs_i_d•th_wr™e
(
dœ
, 1);

429 ià(
	`i_size_»ad
(
dœ
è< 
PAGE_SIZE
)

430 
	`f2fs_i_size_wr™e
(
dœ
, 
PAGE_SIZE
);

431 
out
:

432 
	`f2fs_put_·ge
(
·ge
, 1);

433  
”r
;

434 
	}
}

436 
	$f2fs_add_šlše_’Œ›s
(
šode
 *
dœ
, *
šlše_d’Œy
)

438 
f2fs_d’Œy_±r
 
d
;

439 
b™_pos
 = 0;

440 
”r
 = 0;

442 
	`make_d’Œy_±r_šlše
(
dœ
, &
d
, 
šlše_d’Œy
);

444 
b™_pos
 < 
d
.
max
) {

445 
f2fs_dœ_’Œy
 *
de
;

446 
q¡r
 
Ãw_Çme
;

447 
nid_t
 
šo
;

448 
umode_t
 
çke_mode
;

450 ià(!
	`‹¡_b™_Ë
(
b™_pos
, 
d
.
b™m­
)) {

451 
b™_pos
++;

455 
de
 = &
d
.
d’Œy
[
b™_pos
];

457 ià(
	`uÆik–y
(!
de
->
Çme_Ën
)) {

458 
b™_pos
++;

462 
Ãw_Çme
.
Çme
 = 
d
.
f’ame
[
b™_pos
];

463 
Ãw_Çme
.
Ën
 = 
	`Ë16_to_ıu
(
de
->
Çme_Ën
);

465 
šo
 = 
	`Ë32_to_ıu
(
de
->ino);

466 
çke_mode
 = 
	`f2fs_g‘_de_ty³
(
de
è<< 
S_SHIFT
;

468 
”r
 = 
	`f2fs_add_»guÏr_’Œy
(
dœ
, &
Ãw_Çme
, 
NULL
, NULL,

469 
šo
, 
çke_mode
);

470 ià(
”r
)

471 
punch_d’Œy_·ges
;

473 
b™_pos
 +ğ
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
de
->
Çme_Ën
));

476 
punch_d’Œy_·ges
:

477 
	`Œunÿ‹_šode_·ges
(&
dœ
->
i_d©a
, 0);

478 
	`f2fs_Œunÿ‹_blocks
(
dœ
, 0, 
çl£
);

479 
	`f2fs_»move_dœty_šode
(
dœ
);

480  
”r
;

481 
	}
}

483 
	$f2fs_move_»hashed_dœ’ts
(
šode
 *
dœ
, 
·ge
 *
age
,

484 *
šlše_d’Œy
)

486 *
backup_d’Œy
;

487 
”r
;

489 
backup_d’Œy
 = 
	`f2fs_km®loc
(
	`F2FS_I_SB
(
dœ
),

490 
	`MAX_INLINE_DATA
(
dœ
), 
GFP_F2FS_ZERO
);

491 ià(!
backup_d’Œy
) {

492 
	`f2fs_put_·ge
(
age
, 1);

493  -
ENOMEM
;

496 
	`memıy
(
backup_d’Œy
, 
šlše_d’Œy
, 
	`MAX_INLINE_DATA
(
dœ
));

497 
	`f2fs_Œunÿ‹_šlše_šode
(
dœ
, 
age
, 0);

499 
	`uÆock_·ge
(
age
);

501 
”r
 = 
	`f2fs_add_šlše_’Œ›s
(
dœ
, 
backup_d’Œy
);

502 ià(
”r
)

503 
»cov”
;

505 
	`lock_·ge
(
age
);

507 
	`¡©_dec_šlše_dœ
(
dœ
);

508 
	`ş—r_šode_æag
(
dœ
, 
FI_INLINE_DENTRY
);

514 ià(!
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
	`F2FS_I_SB
(
dœ
)) &&

515 !
	`f2fs_has_šlše_x©Œ
(
dœ
))

516 
	`F2FS_I
(
dœ
)->
i_šlše_x©Œ_size
 = 0;

518 
	`kvä“
(
backup_d’Œy
);

520 
»cov”
:

521 
	`lock_·ge
(
age
);

522 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
,rue);

523 
	`memıy
(
šlše_d’Œy
, 
backup_d’Œy
, 
	`MAX_INLINE_DATA
(
dœ
));

524 
	`f2fs_i_d•th_wr™e
(
dœ
, 0);

525 
	`f2fs_i_size_wr™e
(
dœ
, 
	`MAX_INLINE_DATA
(dir));

526 
	`£t_·ge_dœty
(
age
);

527 
	`f2fs_put_·ge
(
age
, 1);

529 
	`kvä“
(
backup_d’Œy
);

530  
”r
;

531 
	}
}

533 
	$f2fs_cÚv”t_šlše_dœ
(
šode
 *
dœ
, 
·ge
 *
age
,

534 *
šlše_d’Œy
)

536 ià(!
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
)

537  
	`f2fs_move_šlše_dœ’ts
(
dœ
, 
age
, 
šlše_d’Œy
);

539  
	`f2fs_move_»hashed_dœ’ts
(
dœ
, 
age
, 
šlše_d’Œy
);

540 
	}
}

542 
	$f2fs_add_šlše_’Œy
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Ãw_Çme
,

543 cÚ¡ 
q¡r
 *
Üig_Çme
,

544 
šode
 *šode, 
nid_t
 
šo
, 
umode_t
 
mode
)

546 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

547 
·ge
 *
age
;

548 
b™_pos
;

549 
f2fs_hash_t
 
Çme_hash
;

550 *
šlše_d’Œy
 = 
NULL
;

551 
f2fs_d’Œy_±r
 
d
;

552 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
Ãw_Çme
->
Ën
);

553 
·ge
 *·gğ
NULL
;

554 
”r
 = 0;

556 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
dœ
->
i_šo
);

557 ià(
	`IS_ERR
(
age
))

558  
	`PTR_ERR
(
age
);

560 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
dœ
, 
age
);

561 
	`make_d’Œy_±r_šlše
(
dœ
, &
d
, 
šlše_d’Œy
);

563 
b™_pos
 = 
	`f2fs_room_fÜ_f’ame
(
d
.
b™m­
, 
¦Ùs
, d.
max
);

564 ià(
b™_pos
 >ğ
d
.
max
) {

565 
”r
 = 
	`f2fs_cÚv”t_šlše_dœ
(
dœ
, 
age
, 
šlše_d’Œy
);

566 ià(
”r
)

567  
”r
;

568 
”r
 = -
EAGAIN
;

569 
out
;

572 ià(
šode
) {

573 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

574 
·ge
 = 
	`f2fs_š™_šode_m‘ad©a
(
šode
, 
dœ
, 
Ãw_Çme
,

575 
Üig_Çme
, 
age
);

576 ià(
	`IS_ERR
(
·ge
)) {

577 
”r
 = 
	`PTR_ERR
(
·ge
);

578 
ç
;

582 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
,rue);

584 
Çme_hash
 = 
	`f2fs_d’Œy_hash
(
dœ
, 
Ãw_Çme
, 
NULL
);

585 
	`f2fs_upd©e_d’Œy
(
šo
, 
mode
, &
d
, 
Ãw_Çme
, 
Çme_hash
, 
b™_pos
);

587 
	`£t_·ge_dœty
(
age
);

590 ià(
šode
) {

591 
	`f2fs_i_pšo_wr™e
(
šode
, 
dœ
->
i_šo
);

594 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NEW_INODE
))

595 
	`f2fs_upd©e_šode
(
šode
, 
·ge
);

597 
	`f2fs_put_·ge
(
·ge
, 1);

600 
	`f2fs_upd©e_·»Á_m‘ad©a
(
dœ
, 
šode
, 0);

601 
ç
:

602 ià(
šode
)

603 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

604 
out
:

605 
	`f2fs_put_·ge
(
age
, 1);

606  
”r
;

607 
	}
}

609 
	$f2fs_d–‘e_šlše_’Œy
(
f2fs_dœ_’Œy
 *
d’Œy
, 
·ge
 *page,

610 
šode
 *
dœ
, inode *inode)

612 
f2fs_d’Œy_±r
 
d
;

613 *
šlše_d’Œy
;

614 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
d’Œy
->
Çme_Ën
));

615 
b™_pos
;

616 
i
;

618 
	`lock_·ge
(
·ge
);

619 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
,rue);

621 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
dœ
, 
·ge
);

622 
	`make_d’Œy_±r_šlše
(
dœ
, &
d
, 
šlše_d’Œy
);

624 
b™_pos
 = 
d’Œy
 - 
d
.dentry;

625 
i
 = 0; i < 
¦Ùs
; i++)

626 
	`__ş—r_b™_Ë
(
b™_pos
 + 
i
, 
d
.
b™m­
);

628 
	`£t_·ge_dœty
(
·ge
);

629 
	`f2fs_put_·ge
(
·ge
, 1);

631 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
	`cu¼’t_time
(dir);

632 
	`f2fs_m¬k_šode_dœty_sync
(
dœ
, 
çl£
);

634 ià(
šode
)

635 
	`f2fs_drİ_Æšk
(
dœ
, 
šode
);

636 
	}
}

638 
boŞ
 
	$f2fs_em±y_šlše_dœ
(
šode
 *
dœ
)

640 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

641 
·ge
 *
age
;

642 
b™_pos
 = 2;

643 *
šlše_d’Œy
;

644 
f2fs_d’Œy_±r
 
d
;

646 
age
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
dœ
->
i_šo
);

647 ià(
	`IS_ERR
(
age
))

648  
çl£
;

650 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
dœ
, 
age
);

651 
	`make_d’Œy_±r_šlše
(
dœ
, &
d
, 
šlše_d’Œy
);

653 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(
d
.
b™m­
, d.
max
, bit_pos);

655 
	`f2fs_put_·ge
(
age
, 1);

657 ià(
b™_pos
 < 
d
.
max
)

658  
çl£
;

660  
Œue
;

661 
	}
}

663 
	$f2fs_»ad_šlše_dœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
,

664 
fsüy±_¡r
 *
f¡r
)

666 
šode
 *šodğ
	`fe_šode
(
fe
);

667 
·ge
 *
age
 = 
NULL
;

668 
f2fs_d’Œy_±r
 
d
;

669 *
šlše_d’Œy
 = 
NULL
;

670 
”r
;

672 
	`make_d’Œy_±r_šlše
(
šode
, &
d
, 
šlše_d’Œy
);

674 ià(
ùx
->
pos
 =ğ
d
.
max
)

677 
age
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

678 ià(
	`IS_ERR
(
age
))

679  
	`PTR_ERR
(
age
);

685 
	`uÆock_·ge
(
age
);

687 
šlše_d’Œy
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

689 
	`make_d’Œy_±r_šlše
(
šode
, &
d
, 
šlše_d’Œy
);

691 
”r
 = 
	`f2fs_fl_d’Œ›s
(
ùx
, &
d
, 0, 
f¡r
);

692 ià(!
”r
)

693 
ùx
->
pos
 = 
d
.
max
;

695 
	`f2fs_put_·ge
(
age
, 0);

696  
”r
 < 0 ?ƒrr : 0;

697 
	}
}

699 
	$f2fs_šlše_d©a_f›m­
(
šode
 *inode,

700 
f›m­_ex‹Á_šfo
 *
f›šfo
, 
__u64
 
¡¬t
, __u64 
Ën
)

702 
__u64
 
by‹addr
, 
’
;

703 
__u32
 
æags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
 |

704 
FIEMAP_EXTENT_LAST
;

705 
node_šfo
 
ni
;

706 
·ge
 *
age
;

707 
”r
 = 0;

709 
age
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

710 ià(
	`IS_ERR
(
age
))

711  
	`PTR_ERR
(
age
);

713 ià((
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode)) &&

714 !
	`f2fs_has_šlše_d©a
(
šode
)) {

715 
”r
 = -
EAGAIN
;

716 
out
;

719 ià(
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`f2fs_has_šlše_d’Œy
(inode)) {

720 
”r
 = -
EAGAIN
;

721 
out
;

724 
’
 = 
	`mš_t
(
size_t
, 
	`MAX_INLINE_DATA
(
šode
), 
	`i_size_»ad
(inode));

725 ià(
¡¬t
 >ğ
’
)

726 
out
;

727 ià(
¡¬t
 + 
Ën
 < 
’
)

728 
’
 = 
¡¬t
 + 
Ën
;

729 
’
 -ğ
¡¬t
;

731 
”r
 = 
	`f2fs_g‘_node_šfo
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
, &
ni
);

732 ià(
”r
)

733 
out
;

735 
by‹addr
 = (
__u64
)
ni
.
blk_addr
 << 
šode
->
i_sb
->
s_blocksize_b™s
;

736 
by‹addr
 +ğ(*)
	`šlše_d©a_addr
(
šode
, 
age
) -

737 (*)
	`F2FS_INODE
(
age
);

738 
”r
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 
¡¬t
, 
by‹addr
, 
’
, 
æags
);

739 
out
:

740 
	`f2fs_put_·ge
(
age
, 1);

741  
”r
;

742 
	}
}

	@inode.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/f2fs_fs.h
>

10 
	~<lšux/bufãr_h—d.h
>

11 
	~<lšux/backšg-dev.h
>

12 
	~<lšux/wr™eback.h
>

14 
	~"f2fs.h
"

15 
	~"node.h
"

16 
	~"£gm’t.h
"

17 
	~"x©Œ.h
"

19 
	~<Œaû/ev’ts/f2fs.h
>

21 
	$f2fs_m¬k_šode_dœty_sync
(
šode
 *šode, 
boŞ
 
sync
)

23 ià(
	`is_šode_æag_£t
(
šode
, 
FI_NEW_INODE
))

26 ià(
	`f2fs_šode_dœt›d
(
šode
, 
sync
))

29 
	`m¬k_šode_dœty_sync
(
šode
);

30 
	}
}

32 
	$f2fs_£t_šode_æags
(
šode
 *inode)

34 
æags
 = 
	`F2FS_I
(
šode
)->
i_æags
;

35 
Ãw_æ
 = 0;

37 ià(
æags
 & 
F2FS_SYNC_FL
)

38 
Ãw_æ
 |ğ
S_SYNC
;

39 ià(
æags
 & 
F2FS_APPEND_FL
)

40 
Ãw_æ
 |ğ
S_APPEND
;

41 ià(
æags
 & 
F2FS_IMMUTABLE_FL
)

42 
Ãw_æ
 |ğ
S_IMMUTABLE
;

43 ià(
æags
 & 
F2FS_NOATIME_FL
)

44 
Ãw_æ
 |ğ
S_NOATIME
;

45 ià(
æags
 & 
F2FS_DIRSYNC_FL
)

46 
Ãw_æ
 |ğ
S_DIRSYNC
;

47 ià(
	`fe_is_’üy±
(
šode
))

48 
Ãw_æ
 |ğ
S_ENCRYPTED
;

49 ià(
	`fe_is_v”™y
(
šode
))

50 
Ãw_æ
 |ğ
S_VERITY
;

51 ià(
æags
 & 
F2FS_CASEFOLD_FL
)

52 
Ãw_æ
 |ğ
S_CASEFOLD
;

53 
	`šode_£t_æags
(
šode
, 
Ãw_æ
,

54 
S_SYNC
|
S_APPEND
|
S_IMMUTABLE
|
S_NOATIME
|
S_DIRSYNC
|

55 
S_ENCRYPTED
|
S_VERITY
|
S_CASEFOLD
);

56 
	}
}

58 
	$__g‘_šode_rdev
(
šode
 *šode, 
f2fs_šode
 *
ri
)

60 
exŒa_size
 = 
	`g‘_exŒa_isize
(
šode
);

62 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode) ||

63 
	`S_ISFIFO
(
šode
->
i_mode
è|| 
	`S_ISSOCK
(inode->i_mode)) {

64 ià(
ri
->
i_addr
[
exŒa_size
])

65 
šode
->
i_rdev
 = 
	`Şd_decode_dev
(

66 
	`Ë32_to_ıu
(
ri
->
i_addr
[
exŒa_size
]));

68 
šode
->
i_rdev
 = 
	`Ãw_decode_dev
(

69 
	`Ë32_to_ıu
(
ri
->
i_addr
[
exŒa_size
 + 1]));

71 
	}
}

73 
	$__wr™‹n_fœ¡_block
(
f2fs_sb_šfo
 *
sbi
,

74 
f2fs_šode
 *
ri
)

76 
block_t
 
addr
 = 
	`Ë32_to_ıu
(
ri
->
i_addr
[
	`off£t_š_addr
(ri)]);

78 ià(!
	`__is_v®id_d©a_blkaddr
(
addr
))

80 ià(!
	`f2fs_is_v®id_blkaddr
(
sbi
, 
addr
, 
DATA_GENERIC_ENHANCE
))

81  -
EFSCORRUPTED
;

83 
	}
}

85 
	$__£t_šode_rdev
(
šode
 *šode, 
f2fs_šode
 *
ri
)

87 
exŒa_size
 = 
	`g‘_exŒa_isize
(
šode
);

89 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode)) {

90 ià(
	`Şd_v®id_dev
(
šode
->
i_rdev
)) {

91 
ri
->
i_addr
[
exŒa_size
] =

92 
	`ıu_to_Ë32
(
	`Şd_’code_dev
(
šode
->
i_rdev
));

93 
ri
->
i_addr
[
exŒa_size
 + 1] = 0;

95 
ri
->
i_addr
[
exŒa_size
] = 0;

96 
ri
->
i_addr
[
exŒa_size
 + 1] =

97 
	`ıu_to_Ë32
(
	`Ãw_’code_dev
(
šode
->
i_rdev
));

98 
ri
->
i_addr
[
exŒa_size
 + 2] = 0;

101 
	}
}

103 
	$__»cov”_šlše_¡©us
(
šode
 *šode, 
·ge
 *
age
)

105 *
šlše_d©a
 = 
	`šlše_d©a_addr
(
šode
, 
age
);

106 
__Ë32
 *
¡¬t
 = 
šlše_d©a
;

107 
__Ë32
 *
’d
 = 
¡¬t
 + 
	`MAX_INLINE_DATA
(
šode
) / (__le32);

109 
¡¬t
 < 
’d
) {

110 ià(*
¡¬t
++) {

111 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
,rue);

113 
	`£t_šode_æag
(
šode
, 
FI_DATA_EXIST
);

114 
	`£t_¿w_šlše
(
šode
, 
	`F2FS_INODE
(
age
));

115 
	`£t_·ge_dœty
(
age
);

120 
	}
}

122 
boŞ
 
	$f2fs_’abË_šode_chksum
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

124 
f2fs_šode
 *
ri
 = &
	`F2FS_NODE
(
·ge
)->
i
;

126 ià(!
	`f2fs_sb_has_šode_chksum
(
sbi
))

127  
çl£
;

129 ià(!
	`IS_INODE
(
·ge
è|| !(
ri
->
i_šlše
 & 
F2FS_EXTRA_ATTR
))

130  
çl£
;

132 ià(!
	`F2FS_FITS_IN_INODE
(
ri
, 
	`Ë16_to_ıu
Ôi->
i_exŒa_isize
),

133 
i_šode_checksum
))

134  
çl£
;

136  
Œue
;

137 
	}
}

139 
__u32
 
	$f2fs_šode_chksum
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

141 
f2fs_node
 *
node
 = 
	`F2FS_NODE
(
·ge
);

142 
f2fs_šode
 *
ri
 = &
node
->
i
;

143 
__Ë32
 
šo
 = 
node
->
foÙ”
.ino;

144 
__Ë32
 
g’
 = 
ri
->
i_g’”©iÚ
;

145 
__u32
 
chksum
, 
chksum_£ed
;

146 
__u32
 
dummy_cs
 = 0;

147 
off£t
 = 
	`off£tof
(
f2fs_šode
, 
i_šode_checksum
);

148 
cs_size
 = (
dummy_cs
);

150 
chksum
 = 
	`f2fs_chksum
(
sbi
, sbi->
s_chksum_£ed
, (
__u8
 *)&
šo
,

151 (
šo
));

152 
chksum_£ed
 = 
	`f2fs_chksum
(
sbi
, 
chksum
, (
__u8
 *)&
g’
, (gen));

154 
chksum
 = 
	`f2fs_chksum
(
sbi
, 
chksum_£ed
, (
__u8
 *)
ri
, 
off£t
);

155 
chksum
 = 
	`f2fs_chksum
(
sbi
, chksum, (
__u8
 *)&
dummy_cs
, 
cs_size
);

156 
off£t
 +ğ
cs_size
;

157 
chksum
 = 
	`f2fs_chksum
(
sbi
, chksum, (
__u8
 *)
ri
 + 
off£t
,

158 
F2FS_BLKSIZE
 - 
off£t
);

159  
chksum
;

160 
	}
}

162 
boŞ
 
	$f2fs_šode_chksum_v”ify
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

164 
f2fs_šode
 *
ri
;

165 
__u32
 
´ovided
, 
ÿlcuÏ‹d
;

167 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_SHUTDOWN
)))

168  
Œue
;

170 #ifdeà
CONFIG_F2FS_CHECK_FS


171 ià(!
	`f2fs_’abË_šode_chksum
(
sbi
, 
·ge
))

173 ià(!
	`f2fs_’abË_šode_chksum
(
sbi
, 
·ge
) ||

174 
	`PageDœty
(
·ge
è|| 
	`PageWr™eback
(page))

176  
Œue
;

178 
ri
 = &
	`F2FS_NODE
(
·ge
)->
i
;

179 
´ovided
 = 
	`Ë32_to_ıu
(
ri
->
i_šode_checksum
);

180 
ÿlcuÏ‹d
 = 
	`f2fs_šode_chksum
(
sbi
, 
·ge
);

182 ià(
´ovided
 !ğ
ÿlcuÏ‹d
)

183 
	`f2fs_w¬n
(
sbi
, "checksum invalid,‚id = %lu, ino_of_node = %x, %x vs. %x",

184 
·ge
->
šdex
, 
	`šo_of_node
Õage), 
´ovided
, 
ÿlcuÏ‹d
);

186  
´ovided
 =ğ
ÿlcuÏ‹d
;

187 
	}
}

189 
	$f2fs_šode_chksum_£t
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

191 
f2fs_šode
 *
ri
 = &
	`F2FS_NODE
(
·ge
)->
i
;

193 ià(!
	`f2fs_’abË_šode_chksum
(
sbi
, 
·ge
))

196 
ri
->
i_šode_checksum
 = 
	`ıu_to_Ë32
(
	`f2fs_šode_chksum
(
sbi
, 
·ge
));

197 
	}
}

199 
boŞ
 
	$§n™y_check_šode
(
šode
 *šode, 
·ge
 *
node_·ge
)

201 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

202 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

203 
iblocks
;

205 
iblocks
 = 
	`Ë64_to_ıu
(
	`F2FS_INODE
(
node_·ge
)->
i_blocks
);

206 ià(!
iblocks
) {

207 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

208 
	`f2fs_w¬n
(
sbi
, "%s: corrupted inode i_blocks i_ino=%lx iblocks=%llu,„un fscko fix.",

209 
__func__
, 
šode
->
i_šo
, 
iblocks
);

210  
çl£
;

213 ià(
	`šo_of_node
(
node_·ge
è!ğ
	`nid_of_node
(node_page)) {

214 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

215 
	`f2fs_w¬n
(
sbi
, "%s: corrupted inode footer i_ino=%lx, ino,nid: [%u, %u]„un fscko fix.",

216 
__func__
, 
šode
->
i_šo
,

217 
	`šo_of_node
(
node_·ge
), 
	`nid_of_node
(node_page));

218  
çl£
;

221 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
)

222 && !
	`f2fs_has_exŒa_©Œ
(
šode
)) {

223 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

224 
	`f2fs_w¬n
(
sbi
, "%s: corrupted inode ino=%lx,„un fscko fix.",

225 
__func__
, 
šode
->
i_šo
);

226  
çl£
;

229 ià(
	`f2fs_has_exŒa_©Œ
(
šode
) &&

230 !
	`f2fs_sb_has_exŒa_©Œ
(
sbi
)) {

231 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

232 
	`f2fs_w¬n
(
sbi
, "%s: inode (ino=%lx) is withƒxtra_attr, butƒxtra_attr feature is off",

233 
__func__
, 
šode
->
i_šo
);

234  
çl£
;

237 ià(
fi
->
i_exŒa_isize
 > 
F2FS_TOTAL_EXTRA_ATTR_SIZE
 ||

238 
fi
->
i_exŒa_isize
 % (
__Ë32
)) {

239 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

240 
	`f2fs_w¬n
(
sbi
, "%s: inode (ino=%lx) has corrupted i_extra_isize: %d, max: %zu",

241 
__func__
, 
šode
->
i_šo
, 
fi
->
i_exŒa_isize
,

242 
F2FS_TOTAL_EXTRA_ATTR_SIZE
);

243  
çl£
;

246 ià(
	`f2fs_has_exŒa_©Œ
(
šode
) &&

247 
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
) &&

248 
	`f2fs_has_šlše_x©Œ
(
šode
) &&

249 (!
fi
->
i_šlše_x©Œ_size
 ||

250 
fi
->
i_šlše_x©Œ_size
 > 
MAX_INLINE_XATTR_SIZE
)) {

251 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

252 
	`f2fs_w¬n
(
sbi
, "%s: inode (ino=%lx) has corrupted i_inline_xattr_size: %d, max: %zu",

253 
__func__
, 
šode
->
i_šo
, 
fi
->
i_šlše_x©Œ_size
,

254 
MAX_INLINE_XATTR_SIZE
);

255  
çl£
;

258 ià(
	`F2FS_I
(
šode
)->
ex‹Á_Œ“
) {

259 
ex‹Á_šfo
 *
ei
 = &
	`F2FS_I
(
šode
)->
ex‹Á_Œ“
->
Ïrge¡
;

261 ià(
ei
->
Ën
 &&

262 (!
	`f2fs_is_v®id_blkaddr
(
sbi
, 
ei
->
blk
,

263 
DATA_GENERIC_ENHANCE
) ||

264 !
	`f2fs_is_v®id_blkaddr
(
sbi
, 
ei
->
blk
 +ƒi->
Ën
 - 1,

265 
DATA_GENERIC_ENHANCE
))) {

266 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

267 
	`f2fs_w¬n
(
sbi
, "%s: inode (ino=%lx)ƒxtent info [%u, %u, %u] is incorrect,„un fscko fix",

268 
__func__
, 
šode
->
i_šo
,

269 
ei
->
blk
,ƒi->
fofs
,ƒi->
Ën
);

270  
çl£
;

274 ià(
	`f2fs_has_šlše_d©a
(
šode
) &&

275 (!
	`S_ISREG
(
šode
->
i_mode
è&& !
	`S_ISLNK
(inode->i_mode))) {

276 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

277 
	`f2fs_w¬n
(
sbi
, "%s: inode (ino=%lx, mode=%u) should‚ot have inline_data,„un fscko fix",

278 
__func__
, 
šode
->
i_šo
, inode->
i_mode
);

279  
çl£
;

282 ià(
	`f2fs_has_šlše_d’Œy
(
šode
è&& !
	`S_ISDIR
(šode->
i_mode
)) {

283 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

284 
	`f2fs_w¬n
(
sbi
, "%s: inode (ino=%lx, mode=%u) should‚ot have inline_dentry,„un fscko fix",

285 
__func__
, 
šode
->
i_šo
, inode->
i_mode
);

286  
çl£
;

289  
Œue
;

290 
	}
}

292 
	$do_»ad_šode
(
šode
 *inode)

294 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

295 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

296 
·ge
 *
node_·ge
;

297 
f2fs_šode
 *
ri
;

298 
´ojid_t
 
i_´ojid
;

299 
”r
;

302 ià(
	`f2fs_check_nid_¿nge
(
sbi
, 
šode
->
i_šo
))

303  -
EINVAL
;

305 
node_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

306 ià(
	`IS_ERR
(
node_·ge
))

307  
	`PTR_ERR
(
node_·ge
);

309 
ri
 = 
	`F2FS_INODE
(
node_·ge
);

311 
šode
->
i_mode
 = 
	`Ë16_to_ıu
(
ri
->i_mode);

312 
	`i_uid_wr™e
(
šode
, 
	`Ë32_to_ıu
(
ri
->
i_uid
));

313 
	`i_gid_wr™e
(
šode
, 
	`Ë32_to_ıu
(
ri
->
i_gid
));

314 
	`£t_Æšk
(
šode
, 
	`Ë32_to_ıu
(
ri
->
i_lšks
));

315 
šode
->
i_size
 = 
	`Ë64_to_ıu
(
ri
->i_size);

316 
šode
->
i_blocks
 = 
	`SECTOR_FROM_BLOCK
(
	`Ë64_to_ıu
(
ri
->i_blocks) - 1);

318 
šode
->
i_©ime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_atime);

319 
šode
->
i_ùime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_ctime);

320 
šode
->
i_mtime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_mtime);

321 
šode
->
i_©ime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_©ime_n£c
);

322 
šode
->
i_ùime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_ùime_n£c
);

323 
šode
->
i_mtime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_mtime_n£c
);

324 
šode
->
i_g’”©iÚ
 = 
	`Ë32_to_ıu
(
ri
->i_generation);

325 ià(
	`S_ISDIR
(
šode
->
i_mode
))

326 
fi
->
i_cu¼’t_d•th
 = 
	`Ë32_to_ıu
(
ri
->i_current_depth);

327 ià(
	`S_ISREG
(
šode
->
i_mode
))

328 
fi
->
i_gc_çu»s
[
GC_FAILURE_PIN
] =

329 
	`Ë16_to_ıu
(
ri
->
i_gc_çu»s
);

330 
fi
->
i_x©Œ_nid
 = 
	`Ë32_to_ıu
(
ri
->i_xattr_nid);

331 
fi
->
i_æags
 = 
	`Ë32_to_ıu
(
ri
->i_flags);

332 ià(
	`S_ISREG
(
šode
->
i_mode
))

333 
fi
->
i_æags
 &ğ~
F2FS_PROJINHERIT_FL
;

334 
fi
->
æags
 = 0;

335 
fi
->
i_advi£
 = 
ri
->i_advise;

336 
fi
->
i_pšo
 = 
	`Ë32_to_ıu
(
ri
->i_pino);

337 
fi
->
i_dœ_Ëv–
 = 
ri
->i_dir_level;

339 ià(
	`f2fs_š™_ex‹Á_Œ“
(
šode
, &
ri
->
i_ext
))

340 
	`£t_·ge_dœty
(
node_·ge
);

342 
	`g‘_šlše_šfo
(
šode
, 
ri
);

344 
fi
->
i_exŒa_isize
 = 
	`f2fs_has_exŒa_©Œ
(
šode
) ?

345 
	`Ë16_to_ıu
(
ri
->
i_exŒa_isize
) : 0;

347 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
)) {

348 
fi
->
i_šlše_x©Œ_size
 = 
	`Ë16_to_ıu
(
ri
->i_inline_xattr_size);

349 } ià(
	`f2fs_has_šlše_x©Œ
(
šode
) ||

350 
	`f2fs_has_šlše_d’Œy
(
šode
)) {

351 
fi
->
i_šlše_x©Œ_size
 = 
DEFAULT_INLINE_XATTR_ADDRS
;

360 
fi
->
i_šlše_x©Œ_size
 = 0;

363 ià(!
	`§n™y_check_šode
(
šode
, 
node_·ge
)) {

364 
	`f2fs_put_·ge
(
node_·ge
, 1);

365  -
EFSCORRUPTED
;

369 ià(
	`f2fs_has_šlše_d©a
(
šode
è&& !
	`f2fs_exi¡_d©a
(inode))

370 
	`__»cov”_šlše_¡©us
(
šode
, 
node_·ge
);

373 ià(!
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`is_cŞd_node
(
node_·ge
)) {

374 
	`£t_cŞd_node
(
node_·ge
, 
çl£
);

375 
	`£t_·ge_dœty
(
node_·ge
);

379 
	`__g‘_šode_rdev
(
šode
, 
ri
);

381 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

382 
”r
 = 
	`__wr™‹n_fœ¡_block
(
sbi
, 
ri
);

383 ià(
”r
 < 0) {

384 
	`f2fs_put_·ge
(
node_·ge
, 1);

385  
”r
;

387 ià(!
”r
)

388 
	`£t_šode_æag
(
šode
, 
FI_FIRST_BLOCK_WRITTEN
);

391 ià(!
	`f2fs_Ãed_šode_block_upd©e
(
sbi
, 
šode
->
i_šo
))

392 
fi
->
Ï¡_disk_size
 = 
šode
->
i_size
;

394 ià(
fi
->
i_æags
 & 
F2FS_PROJINHERIT_FL
)

395 
	`£t_šode_æag
(
šode
, 
FI_PROJ_INHERIT
);

397 ià(
	`f2fs_has_exŒa_©Œ
(
šode
è&& 
	`f2fs_sb_has_´ojeù_quÙa
(
sbi
) &&

398 
	`F2FS_FITS_IN_INODE
(
ri
, 
fi
->
i_exŒa_isize
, 
i_´ojid
))

399 
i_´ojid
 = (
´ojid_t
)
	`Ë32_to_ıu
(
ri
->i_projid);

401 
i_´ojid
 = 
F2FS_DEF_PROJID
;

402 
fi
->
i_´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, i_projid);

404 ià(
	`f2fs_has_exŒa_©Œ
(
šode
è&& 
	`f2fs_sb_has_šode_ütime
(
sbi
) &&

405 
	`F2FS_FITS_IN_INODE
(
ri
, 
fi
->
i_exŒa_isize
, 
i_ütime
)) {

406 
fi
->
i_ütime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_crtime);

407 
fi
->
i_ütime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_ütime_n£c
);

410 
	`F2FS_I
(
šode
)->
i_disk_time
[0] = inode->
i_©ime
;

411 
	`F2FS_I
(
šode
)->
i_disk_time
[1] = inode->
i_ùime
;

412 
	`F2FS_I
(
šode
)->
i_disk_time
[2] = inode->
i_mtime
;

413 
	`F2FS_I
(
šode
)->
i_disk_time
[3] = F2FS_I(šode)->
i_ütime
;

414 
	`f2fs_put_·ge
(
node_·ge
, 1);

416 
	`¡©_šc_šlše_x©Œ
(
šode
);

417 
	`¡©_šc_šlše_šode
(
šode
);

418 
	`¡©_šc_šlše_dœ
(
šode
);

421 
	}
}

423 
šode
 *
	$f2fs_ig‘
(
su³r_block
 *
sb
, 
šo
)

425 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

426 
šode
 *inode;

427 
»t
 = 0;

429 
šode
 = 
	`ig‘_locked
(
sb
, 
šo
);

430 ià(!
šode
)

431  
	`ERR_PTR
(-
ENOMEM
);

433 ià(!(
šode
->
i_¡©e
 & 
I_NEW
)) {

434 
	`Œaû_f2fs_ig‘
(
šode
);

435  
šode
;

437 ià(
šo
 =ğ
	`F2FS_NODE_INO
(
sbi
è|| inØ=ğ
	`F2FS_META_INO
(sbi))

438 
make_now
;

440 
»t
 = 
	`do_»ad_šode
(
šode
);

441 ià(
»t
)

442 
bad_šode
;

443 
make_now
:

444 ià(
šo
 =ğ
	`F2FS_NODE_INO
(
sbi
)) {

445 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_node_aİs
;

446 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
, 
GFP_NOFS
);

447 } ià(
šo
 =ğ
	`F2FS_META_INO
(
sbi
)) {

448 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_m‘a_aİs
;

449 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
, 
GFP_NOFS
);

450 } ià(
	`S_ISREG
(
šode
->
i_mode
)) {

451 
šode
->
i_İ
 = &
f2fs_fe_šode_İ”©iÚs
;

452 
šode
->
i_fİ
 = &
f2fs_fe_İ”©iÚs
;

453 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

454 } ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

455 
šode
->
i_İ
 = &
f2fs_dœ_šode_İ”©iÚs
;

456 
šode
->
i_fİ
 = &
f2fs_dœ_İ”©iÚs
;

457 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

458 
	`šode_nohighmem
(
šode
);

459 } ià(
	`S_ISLNK
(
šode
->
i_mode
)) {

460 ià(
	`fe_is_’üy±
(
šode
))

461 
šode
->
i_İ
 = &
f2fs_’üy±ed_symlšk_šode_İ”©iÚs
;

463 
šode
->
i_İ
 = &
f2fs_symlšk_šode_İ”©iÚs
;

464 
	`šode_nohighmem
(
šode
);

465 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

466 } ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode) ||

467 
	`S_ISFIFO
(
šode
->
i_mode
è|| 
	`S_ISSOCK
(inode->i_mode)) {

468 
šode
->
i_İ
 = &
f2fs_¥ecŸl_šode_İ”©iÚs
;

469 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, inode->
i_rdev
);

471 
»t
 = -
EIO
;

472 
bad_šode
;

474 
	`f2fs_£t_šode_æags
(
šode
);

475 
	`uÆock_Ãw_šode
(
šode
);

476 
	`Œaû_f2fs_ig‘
(
šode
);

477  
šode
;

479 
bad_šode
:

480 
	`f2fs_šode_synûd
(
šode
);

481 
	`ig‘_çed
(
šode
);

482 
	`Œaû_f2fs_ig‘_ex™
(
šode
, 
»t
);

483  
	`ERR_PTR
(
»t
);

484 
	}
}

486 
šode
 *
	$f2fs_ig‘_»Œy
(
su³r_block
 *
sb
, 
šo
)

488 
šode
 *inode;

489 
»Œy
:

490 
šode
 = 
	`f2fs_ig‘
(
sb
, 
šo
);

491 ià(
	`IS_ERR
(
šode
)) {

492 ià(
	`PTR_ERR
(
šode
è=ğ-
ENOMEM
) {

493 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

494 
»Œy
;

497  
šode
;

498 
	}
}

500 
	$f2fs_upd©e_šode
(
šode
 *šode, 
·ge
 *
node_·ge
)

502 
f2fs_šode
 *
ri
;

503 
ex‹Á_Œ“
 *
‘
 = 
	`F2FS_I
(
šode
)->extent_tree;

505 
	`f2fs_wa™_Ú_·ge_wr™eback
(
node_·ge
, 
NODE
, 
Œue
,rue);

506 
	`£t_·ge_dœty
(
node_·ge
);

508 
	`f2fs_šode_synûd
(
šode
);

510 
ri
 = 
	`F2FS_INODE
(
node_·ge
);

512 
ri
->
i_mode
 = 
	`ıu_to_Ë16
(
šode
->i_mode);

513 
ri
->
i_advi£
 = 
	`F2FS_I
(
šode
)->i_advise;

514 
ri
->
i_uid
 = 
	`ıu_to_Ë32
(
	`i_uid_»ad
(
šode
));

515 
ri
->
i_gid
 = 
	`ıu_to_Ë32
(
	`i_gid_»ad
(
šode
));

516 
ri
->
i_lšks
 = 
	`ıu_to_Ë32
(
šode
->
i_Æšk
);

517 
ri
->
i_size
 = 
	`ıu_to_Ë64
(
	`i_size_»ad
(
šode
));

518 
ri
->
i_blocks
 = 
	`ıu_to_Ë64
(
	`SECTOR_TO_BLOCK
(
šode
->i_blocks) + 1);

520 ià(
‘
) {

521 
	`»ad_lock
(&
‘
->
lock
);

522 
	`£t_¿w_ex‹Á
(&
‘
->
Ïrge¡
, &
ri
->
i_ext
);

523 
	`»ad_uÆock
(&
‘
->
lock
);

525 
	`mem£t
(&
ri
->
i_ext
, 0, (ri->i_ext));

527 
	`£t_¿w_šlše
(
šode
, 
ri
);

529 
ri
->
i_©ime
 = 
	`ıu_to_Ë64
(
šode
->i_©ime.
tv_£c
);

530 
ri
->
i_ùime
 = 
	`ıu_to_Ë64
(
šode
->i_ùime.
tv_£c
);

531 
ri
->
i_mtime
 = 
	`ıu_to_Ë64
(
šode
->i_mtime.
tv_£c
);

532 
ri
->
i_©ime_n£c
 = 
	`ıu_to_Ë32
(
šode
->
i_©ime
.
tv_n£c
);

533 
ri
->
i_ùime_n£c
 = 
	`ıu_to_Ë32
(
šode
->
i_ùime
.
tv_n£c
);

534 
ri
->
i_mtime_n£c
 = 
	`ıu_to_Ë32
(
šode
->
i_mtime
.
tv_n£c
);

535 ià(
	`S_ISDIR
(
šode
->
i_mode
))

536 
ri
->
i_cu¼’t_d•th
 =

537 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->
i_cu¼’t_d•th
);

538 ià(
	`S_ISREG
(
šode
->
i_mode
))

539 
ri
->
i_gc_çu»s
 =

540 
	`ıu_to_Ë16
(
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_PIN
]);

541 
ri
->
i_x©Œ_nid
 = 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->i_xattr_nid);

542 
ri
->
i_æags
 = 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->i_flags);

543 
ri
->
i_pšo
 = 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->i_pino);

544 
ri
->
i_g’”©iÚ
 = 
	`ıu_to_Ë32
(
šode
->i_generation);

545 
ri
->
i_dœ_Ëv–
 = 
	`F2FS_I
(
šode
)->i_dir_level;

547 ià(
	`f2fs_has_exŒa_©Œ
(
šode
)) {

548 
ri
->
i_exŒa_isize
 = 
	`ıu_to_Ë16
(
	`F2FS_I
(
šode
)->i_extra_isize);

550 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
	`F2FS_I_SB
(
šode
)))

551 
ri
->
i_šlše_x©Œ_size
 =

552 
	`ıu_to_Ë16
(
	`F2FS_I
(
šode
)->
i_šlše_x©Œ_size
);

554 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
	`F2FS_I_SB
(
šode
)) &&

555 
	`F2FS_FITS_IN_INODE
(
ri
, 
	`F2FS_I
(
šode
)->
i_exŒa_isize
,

556 
i_´ojid
)) {

557 
´ojid_t
 
i_´ojid
;

559 
i_´ojid
 = 
	`äom_k´ojid
(&
š™_u£r_ns
,

560 
	`F2FS_I
(
šode
)->
i_´ojid
);

561 
ri
->
i_´ojid
 = 
	`ıu_to_Ë32
(i_projid);

564 ià(
	`f2fs_sb_has_šode_ütime
(
	`F2FS_I_SB
(
šode
)) &&

565 
	`F2FS_FITS_IN_INODE
(
ri
, 
	`F2FS_I
(
šode
)->
i_exŒa_isize
,

566 
i_ütime
)) {

567 
ri
->
i_ütime
 =

568 
	`ıu_to_Ë64
(
	`F2FS_I
(
šode
)->
i_ütime
.
tv_£c
);

569 
ri
->
i_ütime_n£c
 =

570 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->
i_ütime
.
tv_n£c
);

574 
	`__£t_šode_rdev
(
šode
, 
ri
);

577 ià(
šode
->
i_Æšk
 == 0)

578 
	`ş—r_šlše_node
(
node_·ge
);

580 
	`F2FS_I
(
šode
)->
i_disk_time
[0] = inode->
i_©ime
;

581 
	`F2FS_I
(
šode
)->
i_disk_time
[1] = inode->
i_ùime
;

582 
	`F2FS_I
(
šode
)->
i_disk_time
[2] = inode->
i_mtime
;

583 
	`F2FS_I
(
šode
)->
i_disk_time
[3] = F2FS_I(šode)->
i_ütime
;

585 #ifdeà
CONFIG_F2FS_CHECK_FS


586 
	`f2fs_šode_chksum_£t
(
	`F2FS_I_SB
(
šode
), 
node_·ge
);

588 
	}
}

590 
	$f2fs_upd©e_šode_·ge
(
šode
 *inode)

592 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

593 
·ge
 *
node_·ge
;

594 
»Œy
:

595 
node_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

596 ià(
	`IS_ERR
(
node_·ge
)) {

597 
”r
 = 
	`PTR_ERR
(
node_·ge
);

598 ià(
”r
 =ğ-
ENOMEM
) {

599 
	`cÚd_»sched
();

600 
»Œy
;

601 } ià(
”r
 !ğ-
ENOENT
) {

602 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

606 
	`f2fs_upd©e_šode
(
šode
, 
node_·ge
);

607 
	`f2fs_put_·ge
(
node_·ge
, 1);

608 
	}
}

610 
	$f2fs_wr™e_šode
(
šode
 *šode, 
wr™eback_cÚŒŞ
 *
wbc
)

612 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

614 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

615 
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
))

621 ià(
	`f2fs_is_time_cÚsi¡’t
(
šode
) &&

622 !
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
))

625 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
))

626  -
ENOSPC
;

632 
	`f2fs_upd©e_šode_·ge
(
šode
);

633 ià(
wbc
 && wbc->
Ä_to_wr™e
)

634 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

636 
	}
}

641 
	$f2fs_eviù_šode
(
šode
 *inode)

643 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

644 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

645 
”r
 = 0;

648 ià(
	`f2fs_is_©omic_fe
(
šode
))

649 
	`f2fs_drİ_šmem_·ges
(
šode
);

651 
	`Œaû_f2fs_eviù_šode
(
šode
);

652 
	`Œunÿ‹_šode_·ges_fš®
(&
šode
->
i_d©a
);

654 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

655 
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
))

656 
out_ş—r
;

658 
	`f2fs_bug_Ú
(
sbi
, 
	`g‘_dœty_·ges
(
šode
));

659 
	`f2fs_»move_dœty_šode
(
šode
);

661 
	`f2fs_de¡roy_ex‹Á_Œ“
(
šode
);

663 ià(
šode
->
i_Æšk
 || 
	`is_bad_šode
(inode))

664 
no_d–‘e
;

666 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

667 ià(
”r
) {

668 
”r
 = 0;

669 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
);

672 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šode
->
i_šo
, 
APPEND_INO
);

673 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šode
->
i_šo
, 
UPDATE_INO
);

674 
	`f2fs_»move_šo_’Œy
(
sbi
, 
šode
->
i_šo
, 
FLUSH_INO
);

676 
	`sb_¡¬t_štwr™e
(
šode
->
i_sb
);

677 
	`£t_šode_æag
(
šode
, 
FI_NO_ALLOC
);

678 
	`i_size_wr™e
(
šode
, 0);

679 
»Œy
:

680 ià(
	`F2FS_HAS_BLOCKS
(
šode
))

681 
”r
 = 
	`f2fs_Œunÿ‹
(
šode
);

683 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_EVICT_INODE
)) {

684 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_EVICT_INODE
);

685 
”r
 = -
EIO
;

688 ià(!
”r
) {

689 
	`f2fs_lock_İ
(
sbi
);

690 
”r
 = 
	`f2fs_»move_šode_·ge
(
šode
);

691 
	`f2fs_uÆock_İ
(
sbi
);

692 ià(
”r
 =ğ-
ENOENT
)

693 
”r
 = 0;

697 ià(
”r
 =ğ-
ENOMEM
) {

698 
”r
 = 0;

699 
»Œy
;

702 ià(
”r
) {

703 
	`f2fs_upd©e_šode_·ge
(
šode
);

704 ià(
	`dquÙ_š™Ÿlize_Ãeded
(
šode
))

705 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
);

707 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

708 
no_d–‘e
:

709 
	`dquÙ_drİ
(
šode
);

711 
	`¡©_dec_šlše_x©Œ
(
šode
);

712 
	`¡©_dec_šlše_dœ
(
šode
);

713 
	`¡©_dec_šlše_šode
(
šode
);

715 ià(
	`lik–y
(!
	`f2fs_ı_”rÜ
(
sbi
) &&

716 !
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)))

717 
	`f2fs_bug_Ú
(
sbi
, 
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
));

719 
	`f2fs_šode_synûd
(
šode
);

722 ià(
šode
->
i_šo
)

723 
	`šv®id©e_m­pšg_·ges
(
	`NODE_MAPPING
(
sbi
), 
šode
->
i_šo
,

724 
šode
->
i_šo
);

725 ià(
xnid
)

726 
	`šv®id©e_m­pšg_·ges
(
	`NODE_MAPPING
(
sbi
), 
xnid
, xnid);

727 ià(
šode
->
i_Æšk
) {

728 ià(
	`is_šode_æag_£t
(
šode
, 
FI_APPEND_WRITE
))

729 
	`f2fs_add_šo_’Œy
(
sbi
, 
šode
->
i_šo
, 
APPEND_INO
);

730 ià(
	`is_šode_æag_£t
(
šode
, 
FI_UPDATE_WRITE
))

731 
	`f2fs_add_šo_’Œy
(
sbi
, 
šode
->
i_šo
, 
UPDATE_INO
);

733 ià(
	`is_šode_æag_£t
(
šode
, 
FI_FREE_NID
)) {

734 
	`f2fs_®loc_nid_çed
(
sbi
, 
šode
->
i_šo
);

735 
	`ş—r_šode_æag
(
šode
, 
FI_FREE_NID
);

743 
out_ş—r
:

744 
	`fsüy±_put_’üy±iÚ_šfo
(
šode
);

745 
	`fsv”™y_ş—nup_šode
(
šode
);

746 
	`ş—r_šode
(
šode
);

747 
	}
}

750 
	$f2fs_hªdË_çed_šode
(
šode
 *inode)

752 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

753 
node_šfo
 
ni
;

754 
”r
;

760 
	`ş—r_Æšk
(
šode
);

766 
	`f2fs_upd©e_šode_·ge
(
šode
);

767 
	`f2fs_šode_synûd
(
šode
);

770 
	`uÆock_Ãw_šode
(
šode
);

777 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
šode
->
i_šo
, &
ni
);

778 ià(
”r
) {

779 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

780 
	`f2fs_w¬n
(
sbi
, "May†oss orphan inode,„un fscko fix.");

781 
out
;

784 ià(
ni
.
blk_addr
 !ğ
NULL_ADDR
) {

785 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
sbi
);

786 ià(
”r
) {

787 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

788 
	`f2fs_w¬n
(
sbi
, "Too many orphan inodes,„un fscko fix.");

790 
	`f2fs_add_Üphª_šode
(
šode
);

792 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

794 
	`£t_šode_æag
(
šode
, 
FI_FREE_NID
);

797 
out
:

798 
	`f2fs_uÆock_İ
(
sbi
);

801 
	`ut
(
šode
);

802 
	}
}

	@namei.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/f2fs_fs.h
>

10 
	~<lšux/·gem­.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/ùy³.h
>

13 
	~<lšux/¿ndom.h
>

14 
	~<lšux/dÿche.h
>

15 
	~<lšux/Çmei.h
>

16 
	~<lšux/quÙaİs.h
>

18 
	~"f2fs.h
"

19 
	~"node.h
"

20 
	~"£gm’t.h
"

21 
	~"x©Œ.h
"

22 
	~"aş.h
"

23 
	~<Œaû/ev’ts/f2fs.h
>

25 
šode
 *
	$f2fs_Ãw_šode
(
šode
 *
dœ
, 
umode_t
 
mode
)

27 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

28 
nid_t
 
šo
;

29 
šode
 *inode;

30 
boŞ
 
nid_ä“
 = 
çl£
;

31 
x©Œ_size
 = 0;

32 
”r
;

34 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

35 ià(!
šode
)

36  
	`ERR_PTR
(-
ENOMEM
);

38 
	`f2fs_lock_İ
(
sbi
);

39 ià(!
	`f2fs_®loc_nid
(
sbi
, &
šo
)) {

40 
	`f2fs_uÆock_İ
(
sbi
);

41 
”r
 = -
ENOSPC
;

42 
ç
;

44 
	`f2fs_uÆock_İ
(
sbi
);

46 
nid_ä“
 = 
Œue
;

48 
	`šode_š™_owÃr
(
šode
, 
dœ
, 
mode
);

50 
šode
->
i_šo
 = 
šo
;

51 
šode
->
i_blocks
 = 0;

52 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

53 
	`F2FS_I
(
šode
)->
i_ütime
 = inode->
i_mtime
;

54 
šode
->
i_g’”©iÚ
 = 
	`´ªdom_u32
();

56 ià(
	`S_ISDIR
(
šode
->
i_mode
))

57 
	`F2FS_I
(
šode
)->
i_cu¼’t_d•th
 = 1;

59 
”r
 = 
	`š£¹_šode_locked
(
šode
);

60 ià(
”r
) {

61 
”r
 = -
EINVAL
;

62 
ç
;

65 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
sbi
) &&

66 (
	`F2FS_I
(
dœ
)->
i_æags
 & 
F2FS_PROJINHERIT_FL
))

67 
	`F2FS_I
(
šode
)->
i_´ojid
 = F2FS_I(
dœ
)->i_projid;

69 
	`F2FS_I
(
šode
)->
i_´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
,

70 
F2FS_DEF_PROJID
);

72 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

73 ià(
”r
)

74 
ç_drİ
;

76 
	`£t_šode_æag
(
šode
, 
FI_NEW_INODE
);

79 ià((
	`IS_ENCRYPTED
(
dœ
è|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) &&

80 
	`f2fs_may_’üy±
(
šode
))

81 
	`f2fs_£t_’üy±ed_šode
(
šode
);

83 ià(
	`f2fs_sb_has_exŒa_©Œ
(
sbi
)) {

84 
	`£t_šode_æag
(
šode
, 
FI_EXTRA_ATTR
);

85 
	`F2FS_I
(
šode
)->
i_exŒa_isize
 = 
F2FS_TOTAL_EXTRA_ATTR_SIZE
;

88 ià(
	`‹¡_İt
(
sbi
, 
INLINE_XATTR
))

89 
	`£t_šode_æag
(
šode
, 
FI_INLINE_XATTR
);

91 ià(
	`‹¡_İt
(
sbi
, 
INLINE_DATA
è&& 
	`f2fs_may_šlše_d©a
(
šode
))

92 
	`£t_šode_æag
(
šode
, 
FI_INLINE_DATA
);

93 ià(
	`f2fs_may_šlše_d’Œy
(
šode
))

94 
	`£t_šode_æag
(
šode
, 
FI_INLINE_DENTRY
);

96 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
)) {

97 
	`f2fs_bug_Ú
(
sbi
, !
	`f2fs_has_exŒa_©Œ
(
šode
));

98 ià(
	`f2fs_has_šlše_x©Œ
(
šode
))

99 
x©Œ_size
 = 
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
;

101 } ià(
	`f2fs_has_šlše_x©Œ
(
šode
) ||

102 
	`f2fs_has_šlše_d’Œy
(
šode
)) {

103 
x©Œ_size
 = 
DEFAULT_INLINE_XATTR_ADDRS
;

105 
	`F2FS_I
(
šode
)->
i_šlše_x©Œ_size
 = 
x©Œ_size
;

107 
	`f2fs_š™_ex‹Á_Œ“
(
šode
, 
NULL
);

109 
	`¡©_šc_šlše_x©Œ
(
šode
);

110 
	`¡©_šc_šlše_šode
(
šode
);

111 
	`¡©_šc_šlše_dœ
(
šode
);

113 
	`F2FS_I
(
šode
)->
i_æags
 =

114 
	`f2fs_mask_æags
(
mode
, 
	`F2FS_I
(
dœ
)->
i_æags
 & 
F2FS_FL_INHERITED
);

116 ià(
	`S_ISDIR
(
šode
->
i_mode
))

117 
	`F2FS_I
(
šode
)->
i_æags
 |ğ
F2FS_INDEX_FL
;

119 ià(
	`F2FS_I
(
šode
)->
i_æags
 & 
F2FS_PROJINHERIT_FL
)

120 
	`£t_šode_æag
(
šode
, 
FI_PROJ_INHERIT
);

122 
	`f2fs_£t_šode_æags
(
šode
);

124 
	`Œaû_f2fs_Ãw_šode
(
šode
, 0);

125  
šode
;

127 
ç
:

128 
	`Œaû_f2fs_Ãw_šode
(
šode
, 
”r
);

129 
	`make_bad_šode
(
šode
);

130 ià(
nid_ä“
)

131 
	`£t_šode_æag
(
šode
, 
FI_FREE_NID
);

132 
	`ut
(
šode
);

133  
	`ERR_PTR
(
”r
);

134 
ç_drİ
:

135 
	`Œaû_f2fs_Ãw_šode
(
šode
, 
”r
);

136 
	`dquÙ_drİ
(
šode
);

137 
šode
->
i_æags
 |ğ
S_NOQUOTA
;

138 ià(
nid_ä“
)

139 
	`£t_šode_æag
(
šode
, 
FI_FREE_NID
);

140 
	`ş—r_Æšk
(
šode
);

141 
	`uÆock_Ãw_šode
(
šode
);

142 
	`ut
(
šode
);

143  
	`ERR_PTR
(
”r
);

144 
	}
}

146 
šlše
 
	$is_ex‹nsiÚ_exi¡
(cÚ¡ *
s
, cÚ¡ *
sub
)

148 
size_t
 
¦’
 = 
	`¡¾’
(
s
);

149 
size_t
 
subËn
 = 
	`¡¾’
(
sub
);

150 
i
;

156 ià(
¦’
 < 
subËn
 + 2)

159 
i
 = 1; i < 
¦’
 - 
subËn
; i++) {

160 ià(
s
[
i
] != '.')

162 ià(!
	`¡ºÿ£cmp
(
s
 + 
i
 + 1, 
sub
, 
subËn
))

167 
	}
}

172 
šlše
 
	$£t_fe_‹m³¿tu»
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

173 cÚ¡ *
Çme
)

175 
	`__u8
 (*
exi¡
)[
F2FS_EXTENSION_LEN
] = 
sbi
->
¿w_su³r
->
ex‹nsiÚ_li¡
;

176 
i
, 
cŞd_couÁ
, 
hÙ_couÁ
;

178 
	`down_»ad
(&
sbi
->
sb_lock
);

180 
cŞd_couÁ
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
);

181 
hÙ_couÁ
 = 
sbi
->
¿w_su³r
->
hÙ_ext_couÁ
;

183 
i
 = 0; i < 
cŞd_couÁ
 + 
hÙ_couÁ
; i++) {

184 ià(
	`is_ex‹nsiÚ_exi¡
(
Çme
, 
exi¡
[
i
]))

188 
	`up_»ad
(&
sbi
->
sb_lock
);

190 ià(
i
 =ğ
cŞd_couÁ
 + 
hÙ_couÁ
)

193 ià(
i
 < 
cŞd_couÁ
)

194 
	`fe_£t_cŞd
(
šode
);

196 
	`fe_£t_hÙ
(
šode
);

197 
	}
}

199 
	$f2fs_upd©e_ex‹nsiÚ_li¡
(
f2fs_sb_šfo
 *
sbi
, cÚ¡ *
Çme
,

200 
boŞ
 
hÙ
, boŞ 
£t
)

202 
	`__u8
 (*
exi¡
)[
F2FS_EXTENSION_LEN
] = 
sbi
->
¿w_su³r
->
ex‹nsiÚ_li¡
;

203 
cŞd_couÁ
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
);

204 
hÙ_couÁ
 = 
sbi
->
¿w_su³r
->
hÙ_ext_couÁ
;

205 
tÙ®_couÁ
 = 
cŞd_couÁ
 + 
hÙ_couÁ
;

206 
¡¬t
, 
couÁ
;

207 
i
;

209 ià(
£t
) {

210 ià(
tÙ®_couÁ
 =ğ
F2FS_MAX_EXTENSION
)

211  -
EINVAL
;

213 ià(!
hÙ
 && !
cŞd_couÁ
)

214  -
EINVAL
;

215 ià(
hÙ
 && !
hÙ_couÁ
)

216  -
EINVAL
;

219 ià(
hÙ
) {

220 
¡¬t
 = 
cŞd_couÁ
;

221 
couÁ
 = 
tÙ®_couÁ
;

223 
¡¬t
 = 0;

224 
couÁ
 = 
cŞd_couÁ
;

227 
i
 = 
¡¬t
; i < 
couÁ
; i++) {

228 ià(
	`¡rcmp
(
Çme
, 
exi¡
[
i
]))

231 ià(
£t
)

232  -
EINVAL
;

234 
	`memıy
(
exi¡
[
i
],ƒxtlist[i + 1],

235 
F2FS_EXTENSION_LEN
 * (
tÙ®_couÁ
 - 
i
 - 1));

236 
	`mem£t
(
exi¡
[
tÙ®_couÁ
 - 1], 0, 
F2FS_EXTENSION_LEN
);

237 ià(
hÙ
)

238 
sbi
->
¿w_su³r
->
hÙ_ext_couÁ
 = 
hÙ_couÁ
 - 1;

240 
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
 =

241 
	`ıu_to_Ë32
(
cŞd_couÁ
 - 1);

245 ià(!
£t
)

246  -
EINVAL
;

248 ià(
hÙ
) {

249 
	`memıy
(
exi¡
[
couÁ
], 
Çme
, 
	`¡¾’
(name));

250 
sbi
->
¿w_su³r
->
hÙ_ext_couÁ
 = 
hÙ_couÁ
 + 1;

252 
buf
[
F2FS_MAX_EXTENSION
][
F2FS_EXTENSION_LEN
];

254 
	`memıy
(
buf
, &
exi¡
[
cŞd_couÁ
],

255 
F2FS_EXTENSION_LEN
 * 
hÙ_couÁ
);

256 
	`mem£t
(
exi¡
[
cŞd_couÁ
], 0, 
F2FS_EXTENSION_LEN
);

257 
	`memıy
(
exi¡
[
cŞd_couÁ
], 
Çme
, 
	`¡¾’
(name));

258 
	`memıy
(&
exi¡
[
cŞd_couÁ
 + 1], 
buf
,

259 
F2FS_EXTENSION_LEN
 * 
hÙ_couÁ
);

260 
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
 = 
	`ıu_to_Ë32
(
cŞd_couÁ
 + 1);

263 
	}
}

265 
	$f2fs_ü—‹
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
,

266 
boŞ
 
exş
)

268 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

269 
šode
 *inode;

270 
nid_t
 
šo
 = 0;

271 
”r
;

273 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

274  -
EIO
;

275 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
))

276  -
ENOSPC
;

278 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

279 ià(
”r
)

280  
”r
;

282 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
mode
);

283 ià(
	`IS_ERR
(
šode
))

284  
	`PTR_ERR
(
šode
);

286 ià(!
	`‹¡_İt
(
sbi
, 
DISABLE_EXT_IDENTIFY
))

287 
	`£t_fe_‹m³¿tu»
(
sbi
, 
šode
, 
d’Œy
->
d_Çme
.
Çme
);

289 
šode
->
i_İ
 = &
f2fs_fe_šode_İ”©iÚs
;

290 
šode
->
i_fİ
 = &
f2fs_fe_İ”©iÚs
;

291 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

292 
šo
 = 
šode
->
i_šo
;

294 
	`f2fs_lock_İ
(
sbi
);

295 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

296 ià(
”r
)

297 
out
;

298 
	`f2fs_uÆock_İ
(
sbi
);

300 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šo
);

302 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

304 ià(
	`IS_DIRSYNC
(
dœ
))

305 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

307 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

309 
out
:

310 
	`f2fs_hªdË_çed_šode
(
šode
);

311  
”r
;

312 
	}
}

314 
	$f2fs_lšk
(
d’Œy
 *
Şd_d’Œy
, 
šode
 *
dœ
,

315 
d’Œy
 *dentry)

317 
šode
 *šodğ
	`d_šode
(
Şd_d’Œy
);

318 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

319 
”r
;

321 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

322  -
EIO
;

323 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
))

324  -
ENOSPC
;

326 
”r
 = 
	`fsüy±_´•¬e_lšk
(
Şd_d’Œy
, 
dœ
, 
d’Œy
);

327 ià(
”r
)

328  
”r
;

330 ià(
	`is_šode_æag_£t
(
dœ
, 
FI_PROJ_INHERIT
) &&

331 (!
	`´ojid_eq
(
	`F2FS_I
(
dœ
)->
i_´ojid
,

332 
	`F2FS_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)))

333  -
EXDEV
;

335 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

336 ià(
”r
)

337  
”r
;

339 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

341 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

342 
	`ihŞd
(
šode
);

344 
	`£t_šode_æag
(
šode
, 
FI_INC_LINK
);

345 
	`f2fs_lock_İ
(
sbi
);

346 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

347 ià(
”r
)

348 
out
;

349 
	`f2fs_uÆock_İ
(
sbi
);

351 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

353 ià(
	`IS_DIRSYNC
(
dœ
))

354 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

356 
out
:

357 
	`ş—r_šode_æag
(
šode
, 
FI_INC_LINK
);

358 
	`ut
(
šode
);

359 
	`f2fs_uÆock_İ
(
sbi
);

360  
”r
;

361 
	}
}

363 
d’Œy
 *
	$f2fs_g‘_·»Á
(
d’Œy
 *
chd
)

365 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

366 
·ge
 *page;

367 
šo
 = 
	`f2fs_šode_by_Çme
(
	`d_šode
(
chd
), &
dÙdÙ
, &
·ge
);

368 ià(!
šo
) {

369 ià(
	`IS_ERR
(
·ge
))

370  
	`ERR_CAST
(
·ge
);

371  
	`ERR_PTR
(-
ENOENT
);

373  
	`d_obš_®Ÿs
(
	`f2fs_ig‘
(
chd
->
d_sb
, 
šo
));

374 
	}
}

376 
	$__»cov”_dÙ_d’Œ›s
(
šode
 *
dœ
, 
nid_t
 
pšo
)

378 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

379 
q¡r
 
dÙ
 = 
	`QSTR_INIT
(".", 1);

380 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

381 
f2fs_dœ_’Œy
 *
de
;

382 
·ge
 *page;

383 
”r
 = 0;

385 ià(
	`f2fs_»adÚly
(
sbi
->
sb
)) {

386 
	`f2fs_šfo
(
sbi
, "skip„ecovering inline_dots inode (ino:%lu,…ino:%u) in„eadonly mountpoint",

387 
dœ
->
i_šo
, 
pšo
);

391 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

392 ià(
”r
)

393  
”r
;

395 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

397 
	`f2fs_lock_İ
(
sbi
);

399 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, &
dÙ
, &
·ge
);

400 ià(
de
) {

401 
	`f2fs_put_·ge
(
·ge
, 0);

402 } ià(
	`IS_ERR
(
·ge
)) {

403 
”r
 = 
	`PTR_ERR
(
·ge
);

404 
out
;

406 
”r
 = 
	`f2fs_do_add_lšk
(
dœ
, &
dÙ
, 
NULL
, dœ->
i_šo
, 
S_IFDIR
);

407 ià(
”r
)

408 
out
;

411 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, &
dÙdÙ
, &
·ge
);

412 ià(
de
)

413 
	`f2fs_put_·ge
(
·ge
, 0);

414 ià(
	`IS_ERR
(
·ge
))

415 
”r
 = 
	`PTR_ERR
(
·ge
);

417 
”r
 = 
	`f2fs_do_add_lšk
(
dœ
, &
dÙdÙ
, 
NULL
, 
pšo
, 
S_IFDIR
);

418 
out
:

419 ià(!
”r
)

420 
	`ş—r_šode_æag
(
dœ
, 
FI_INLINE_DOTS
);

422 
	`f2fs_uÆock_İ
(
sbi
);

423  
”r
;

424 
	}
}

426 
d’Œy
 *
	$f2fs_lookup
(
šode
 *
dœ
, 
d’Œy
 *dentry,

427 
æags
)

429 
šode
 *šodğ
NULL
;

430 
f2fs_dœ_’Œy
 *
de
;

431 
·ge
 *page;

432 
d’Œy
 *
Ãw
;

433 
nid_t
 
šo
 = -1;

434 
”r
 = 0;

435 
roÙ_šo
 = 
	`F2FS_ROOT_INO
(
	`F2FS_I_SB
(
dœ
));

436 
fsüy±_Çme
 
âame
;

438 
	`Œaû_f2fs_lookup_¡¬t
(
dœ
, 
d’Œy
, 
æags
);

440 ià(
d’Œy
->
d_Çme
.
Ën
 > 
F2FS_NAME_LEN
) {

441 
”r
 = -
ENAMETOOLONG
;

442 
out
;

445 
”r
 = 
	`fsüy±_´•¬e_lookup
(
dœ
, 
d’Œy
, &
âame
);

446 ià(
”r
 =ğ-
ENOENT
)

447 
out_¥liû
;

448 ià(
”r
)

449 
out
;

450 
de
 = 
	`__f2fs_fšd_’Œy
(
dœ
, &
âame
, &
·ge
);

451 
	`fsüy±_ä“_f’ame
(&
âame
);

453 ià(!
de
) {

454 ià(
	`IS_ERR
(
·ge
)) {

455 
”r
 = 
	`PTR_ERR
(
·ge
);

456 
out
;

458 
out_¥liû
;

461 
šo
 = 
	`Ë32_to_ıu
(
de
->ino);

462 
	`f2fs_put_·ge
(
·ge
, 0);

464 
šode
 = 
	`f2fs_ig‘
(
dœ
->
i_sb
, 
šo
);

465 ià(
	`IS_ERR
(
šode
)) {

466 
”r
 = 
	`PTR_ERR
(
šode
);

467 
out
;

470 ià((
dœ
->
i_šo
 =ğ
roÙ_šo
è&& 
	`f2fs_has_šlše_dÙs
(dir)) {

471 
”r
 = 
	`__»cov”_dÙ_d’Œ›s
(
dœ
, 
roÙ_šo
);

472 ià(
”r
)

473 
out_ut
;

476 ià(
	`f2fs_has_šlše_dÙs
(
šode
)) {

477 
”r
 = 
	`__»cov”_dÙ_d’Œ›s
(
šode
, 
dœ
->
i_šo
);

478 ià(
”r
)

479 
out_ut
;

481 ià(
	`IS_ENCRYPTED
(
dœ
) &&

482 (
	`S_ISDIR
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode)) &&

483 !
	`fsüy±_has_³rm™‹d_cÚ‹xt
(
dœ
, 
šode
)) {

484 
	`f2fs_w¬n
(
	`F2FS_I_SB
(
šode
), "Inconsistentƒncryption contexts: %lu/%lu",

485 
dœ
->
i_šo
, 
šode
->i_ino);

486 
”r
 = -
EPERM
;

487 
out_ut
;

489 
out_¥liû
:

490 #ifdeà
CONFIG_UNICODE


491 ià(!
šode
 && 
	`IS_CASEFOLDED
(
dœ
)) {

497 
	`Œaû_f2fs_lookup_’d
(
dœ
, 
d’Œy
, 
šo
, 
”r
);

498  
NULL
;

501 
Ãw
 = 
	`d_¥liû_®Ÿs
(
šode
, 
d’Œy
);

502 
”r
 = 
	`PTR_ERR_OR_ZERO
(
Ãw
);

503 
	`Œaû_f2fs_lookup_’d
(
dœ
, 
d’Œy
, 
šo
, 
”r
);

504  
Ãw
;

505 
out_ut
:

506 
	`ut
(
šode
);

507 
out
:

508 
	`Œaû_f2fs_lookup_’d
(
dœ
, 
d’Œy
, 
šo
, 
”r
);

509  
	`ERR_PTR
(
”r
);

510 
	}
}

512 
	$f2fs_uÆšk
(
šode
 *
dœ
, 
d’Œy
 *dentry)

514 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

515 
šode
 *šodğ
	`d_šode
(
d’Œy
);

516 
f2fs_dœ_’Œy
 *
de
;

517 
·ge
 *page;

518 
”r
 = -
ENOENT
;

520 
	`Œaû_f2fs_uÆšk_’‹r
(
dœ
, 
d’Œy
);

522 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

523  -
EIO
;

525 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

526 ià(
”r
)

527  
”r
;

528 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

529 ià(
”r
)

530  
”r
;

532 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, &
·ge
);

533 ià(!
de
) {

534 ià(
	`IS_ERR
(
·ge
))

535 
”r
 = 
	`PTR_ERR
(
·ge
);

536 
ç
;

539 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

541 
	`f2fs_lock_İ
(
sbi
);

542 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
sbi
);

543 ià(
”r
) {

544 
	`f2fs_uÆock_İ
(
sbi
);

545 
	`f2fs_put_·ge
(
·ge
, 0);

546 
ç
;

548 
	`f2fs_d–‘e_’Œy
(
de
, 
·ge
, 
dœ
, 
šode
);

549 #ifdeà
CONFIG_UNICODE


556 ià(
	`IS_CASEFOLDED
(
dœ
))

557 
	`d_šv®id©e
(
d’Œy
);

559 
	`f2fs_uÆock_İ
(
sbi
);

561 ià(
	`IS_DIRSYNC
(
dœ
))

562 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

563 
ç
:

564 
	`Œaû_f2fs_uÆšk_ex™
(
šode
, 
”r
);

565  
”r
;

566 
	}
}

568 cÚ¡ *
	$f2fs_g‘_lšk
(
d’Œy
 *dentry,

569 
šode
 *inode,

570 
d–ayed_ÿÎ
 *
dÚe
)

572 cÚ¡ *
lšk
 = 
	`·ge_g‘_lšk
(
d’Œy
, 
šode
, 
dÚe
);

573 ià(!
	`IS_ERR
(
lšk
) && !*link) {

575 
	`do_d–ayed_ÿÎ
(
dÚe
);

576 
	`ş—r_d–ayed_ÿÎ
(
dÚe
);

577 
lšk
 = 
	`ERR_PTR
(-
ENOENT
);

579  
lšk
;

580 
	}
}

582 
	$f2fs_symlšk
(
šode
 *
dœ
, 
d’Œy
 *dentry,

583 cÚ¡ *
symÇme
)

585 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

586 
šode
 *inode;

587 
size_t
 
Ën
 = 
	`¡¾’
(
symÇme
);

588 
fsüy±_¡r
 
disk_lšk
;

589 
”r
;

591 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

592  -
EIO
;

593 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
))

594  -
ENOSPC
;

596 
”r
 = 
	`fsüy±_´•¬e_symlšk
(
dœ
, 
symÇme
, 
Ën
, dœ->
i_sb
->
s_blocksize
,

597 &
disk_lšk
);

598 ià(
”r
)

599  
”r
;

601 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

602 ià(
”r
)

603  
”r
;

605 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
S_IFLNK
 | 
S_IRWXUGO
);

606 ià(
	`IS_ERR
(
šode
))

607  
	`PTR_ERR
(
šode
);

609 ià(
	`IS_ENCRYPTED
(
šode
))

610 
šode
->
i_İ
 = &
f2fs_’üy±ed_symlšk_šode_İ”©iÚs
;

612 
šode
->
i_İ
 = &
f2fs_symlšk_šode_İ”©iÚs
;

613 
	`šode_nohighmem
(
šode
);

614 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

616 
	`f2fs_lock_İ
(
sbi
);

617 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

618 ià(
”r
)

619 
out_f2fs_hªdË_çed_šode
;

620 
	`f2fs_uÆock_İ
(
sbi
);

621 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

623 
”r
 = 
	`fsüy±_’üy±_symlšk
(
šode
, 
symÇme
, 
Ën
, &
disk_lšk
);

624 ià(
”r
)

625 
”r_out
;

627 
”r
 = 
	`·ge_symlšk
(
šode
, 
disk_lšk
.
Çme
, disk_lšk.
Ën
);

629 
”r_out
:

630 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

641 ià(!
”r
) {

642 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 0,

643 
disk_lšk
.
Ën
 - 1);

645 ià(
	`IS_DIRSYNC
(
dœ
))

646 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

648 
	`f2fs_uÆšk
(
dœ
, 
d’Œy
);

651 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

652 
out_ä“_’üy±ed_lšk
;

654 
out_f2fs_hªdË_çed_šode
:

655 
	`f2fs_hªdË_çed_šode
(
šode
);

656 
out_ä“_’üy±ed_lšk
:

657 ià(
disk_lšk
.
Çme
 !ğ(*)
symÇme
)

658 
	`kvä“
(
disk_lšk
.
Çme
);

659  
”r
;

660 
	}
}

662 
	$f2fs_mkdœ
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

664 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

665 
šode
 *inode;

666 
”r
;

668 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

669  -
EIO
;

671 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

672 ià(
”r
)

673  
”r
;

675 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
S_IFDIR
 | 
mode
);

676 ià(
	`IS_ERR
(
šode
))

677  
	`PTR_ERR
(
šode
);

679 
šode
->
i_İ
 = &
f2fs_dœ_šode_İ”©iÚs
;

680 
šode
->
i_fİ
 = &
f2fs_dœ_İ”©iÚs
;

681 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

682 
	`šode_nohighmem
(
šode
);

684 
	`£t_šode_æag
(
šode
, 
FI_INC_LINK
);

685 
	`f2fs_lock_İ
(
sbi
);

686 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

687 ià(
”r
)

688 
out_ç
;

689 
	`f2fs_uÆock_İ
(
sbi
);

691 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

693 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

695 ià(
	`IS_DIRSYNC
(
dœ
))

696 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

698 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

701 
out_ç
:

702 
	`ş—r_šode_æag
(
šode
, 
FI_INC_LINK
);

703 
	`f2fs_hªdË_çed_šode
(
šode
);

704  
”r
;

705 
	}
}

707 
	$f2fs_rmdœ
(
šode
 *
dœ
, 
d’Œy
 *dentry)

709 
šode
 *šodğ
	`d_šode
(
d’Œy
);

710 ià(
	`f2fs_em±y_dœ
(
šode
))

711  
	`f2fs_uÆšk
(
dœ
, 
d’Œy
);

712  -
ENOTEMPTY
;

713 
	}
}

715 
	$f2fs_mknod
(
šode
 *
dœ
, 
d’Œy
 *dentry,

716 
umode_t
 
mode
, 
dev_t
 
rdev
)

718 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

719 
šode
 *inode;

720 
”r
 = 0;

722 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

723  -
EIO
;

724 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
))

725  -
ENOSPC
;

727 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

728 ià(
”r
)

729  
”r
;

731 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
mode
);

732 ià(
	`IS_ERR
(
šode
))

733  
	`PTR_ERR
(
šode
);

735 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
rdev
);

736 
šode
->
i_İ
 = &
f2fs_¥ecŸl_šode_İ”©iÚs
;

738 
	`f2fs_lock_İ
(
sbi
);

739 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

740 ià(
”r
)

741 
out
;

742 
	`f2fs_uÆock_İ
(
sbi
);

744 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

746 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

748 ià(
	`IS_DIRSYNC
(
dœ
))

749 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

751 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

753 
out
:

754 
	`f2fs_hªdË_çed_šode
(
šode
);

755  
”r
;

756 
	}
}

758 
	$__f2fs_tmpfe
(
šode
 *
dœ
, 
d’Œy
 *dentry,

759 
umode_t
 
mode
, 
šode
 **
wh™eout
)

761 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

762 
šode
 *inode;

763 
”r
;

765 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

766 ià(
”r
)

767  
”r
;

769 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
mode
);

770 ià(
	`IS_ERR
(
šode
))

771  
	`PTR_ERR
(
šode
);

773 ià(
wh™eout
) {

774 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
WHITEOUT_DEV
);

775 
šode
->
i_İ
 = &
f2fs_¥ecŸl_šode_İ”©iÚs
;

777 
šode
->
i_İ
 = &
f2fs_fe_šode_İ”©iÚs
;

778 
šode
->
i_fİ
 = &
f2fs_fe_İ”©iÚs
;

779 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

782 
	`f2fs_lock_İ
(
sbi
);

783 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
sbi
);

784 ià(
”r
)

785 
out
;

787 
”r
 = 
	`f2fs_do_tmpfe
(
šode
, 
dœ
);

788 ià(
”r
)

789 
»Ëa£_out
;

795 
	`f2fs_add_Üphª_šode
(
šode
);

796 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

798 ià(
wh™eout
) {

799 
	`f2fs_i_lšks_wr™e
(
šode
, 
çl£
);

800 *
wh™eout
 = 
šode
;

802 
	`d_tmpfe
(
d’Œy
, 
šode
);

805 
	`f2fs_uÆock_İ
(
sbi
);

806 
	`uÆock_Ãw_šode
(
šode
);

808 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

811 
»Ëa£_out
:

812 
	`f2fs_»Ëa£_Üphª_šode
(
sbi
);

813 
out
:

814 
	`f2fs_hªdË_çed_šode
(
šode
);

815  
”r
;

816 
	}
}

818 
	$f2fs_tmpfe
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

820 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

822 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

823  -
EIO
;

824 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
))

825  -
ENOSPC
;

827 ià(
	`IS_ENCRYPTED
(
dœ
è|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) {

828 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
dœ
);

829 ià(
”r
)

830  
”r
;

833  
	`__f2fs_tmpfe
(
dœ
, 
d’Œy
, 
mode
, 
NULL
);

834 
	}
}

836 
	$f2fs_ü—‹_wh™eout
(
šode
 *
dœ
, šod**
wh™eout
)

838 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
dœ
))))

839  -
EIO
;

841  
	`__f2fs_tmpfe
(
dœ
, 
NULL
, 
S_IFCHR
 | 
WHITEOUT_MODE
, 
wh™eout
);

842 
	}
}

844 
	$f2fs_»Çme
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

845 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

846 
æags
)

848 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
Şd_dœ
);

849 
šode
 *
Şd_šode
 = 
	`d_šode
(
Şd_d’Œy
);

850 
šode
 *
Ãw_šode
 = 
	`d_šode
(
Ãw_d’Œy
);

851 
šode
 *
wh™eout
 = 
NULL
;

852 
·ge
 *
Şd_dœ_·ge
;

853 
·ge
 *
Şd_·ge
, *
Ãw_·ge
 = 
NULL
;

854 
f2fs_dœ_’Œy
 *
Şd_dœ_’Œy
 = 
NULL
;

855 
f2fs_dœ_’Œy
 *
Şd_’Œy
;

856 
f2fs_dœ_’Œy
 *
Ãw_’Œy
;

857 
boŞ
 
is_Şd_šlše
 = 
	`f2fs_has_šlše_d’Œy
(
Şd_dœ
);

858 
”r
;

860 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

861  -
EIO
;

862 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
))

863  -
ENOSPC
;

865 ià(
	`is_šode_æag_£t
(
Ãw_dœ
, 
FI_PROJ_INHERIT
) &&

866 (!
	`´ojid_eq
(
	`F2FS_I
(
Ãw_dœ
)->
i_´ojid
,

867 
	`F2FS_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)))

868  -
EXDEV
;

870 
”r
 = 
	`dquÙ_š™Ÿlize
(
Şd_dœ
);

871 ià(
”r
)

872 
out
;

874 
”r
 = 
	`dquÙ_š™Ÿlize
(
Ãw_dœ
);

875 ià(
”r
)

876 
out
;

878 ià(
Ãw_šode
) {

879 
”r
 = 
	`dquÙ_š™Ÿlize
(
Ãw_šode
);

880 ià(
”r
)

881 
out
;

884 
”r
 = -
ENOENT
;

885 
Şd_’Œy
 = 
	`f2fs_fšd_’Œy
(
Şd_dœ
, &
Şd_d’Œy
->
d_Çme
, &
Şd_·ge
);

886 ià(!
Şd_’Œy
) {

887 ià(
	`IS_ERR
(
Şd_·ge
))

888 
”r
 = 
	`PTR_ERR
(
Şd_·ge
);

889 
out
;

892 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

893 
Şd_dœ_’Œy
 = 
	`f2fs_·»Á_dœ
(
Şd_šode
, &
Şd_dœ_·ge
);

894 ià(!
Şd_dœ_’Œy
) {

895 ià(
	`IS_ERR
(
Şd_dœ_·ge
))

896 
”r
 = 
	`PTR_ERR
(
Şd_dœ_·ge
);

897 
out_Şd
;

901 ià(
æags
 & 
RENAME_WHITEOUT
) {

902 
”r
 = 
	`f2fs_ü—‹_wh™eout
(
Şd_dœ
, &
wh™eout
);

903 ià(
”r
)

904 
out_dœ
;

907 ià(
Ãw_šode
) {

909 
”r
 = -
ENOTEMPTY
;

910 ià(
Şd_dœ_’Œy
 && !
	`f2fs_em±y_dœ
(
Ãw_šode
))

911 
out_wh™eout
;

913 
”r
 = -
ENOENT
;

914 
Ãw_’Œy
 = 
	`f2fs_fšd_’Œy
(
Ãw_dœ
, &
Ãw_d’Œy
->
d_Çme
,

915 &
Ãw_·ge
);

916 ià(!
Ãw_’Œy
) {

917 ià(
	`IS_ERR
(
Ãw_·ge
))

918 
”r
 = 
	`PTR_ERR
(
Ãw_·ge
);

919 
out_wh™eout
;

922 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

924 
	`f2fs_lock_İ
(
sbi
);

926 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
sbi
);

927 ià(
”r
)

928 
put_out_dœ
;

930 
	`f2fs_£t_lšk
(
Ãw_dœ
, 
Ãw_’Œy
, 
Ãw_·ge
, 
Şd_šode
);

932 
Ãw_šode
->
i_ùime
 = 
	`cu¼’t_time
(new_inode);

933 
	`down_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

934 ià(
Şd_dœ_’Œy
)

935 
	`f2fs_i_lšks_wr™e
(
Ãw_šode
, 
çl£
);

936 
	`f2fs_i_lšks_wr™e
(
Ãw_šode
, 
çl£
);

937 
	`up_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

939 ià(!
Ãw_šode
->
i_Æšk
)

940 
	`f2fs_add_Üphª_šode
(
Ãw_šode
);

942 
	`f2fs_»Ëa£_Üphª_šode
(
sbi
);

944 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

946 
	`f2fs_lock_İ
(
sbi
);

948 
”r
 = 
	`f2fs_add_lšk
(
Ãw_d’Œy
, 
Şd_šode
);

949 ià(
”r
) {

950 
	`f2fs_uÆock_İ
(
sbi
);

951 
out_wh™eout
;

954 ià(
Şd_dœ_’Œy
)

955 
	`f2fs_i_lšks_wr™e
(
Ãw_dœ
, 
Œue
);

964 ià(
is_Şd_šlše
 && !
	`f2fs_has_šlše_d’Œy
(
Şd_dœ
)) {

965 
	`f2fs_put_·ge
(
Şd_·ge
, 0);

966 
Şd_·ge
 = 
NULL
;

968 
Şd_’Œy
 = 
	`f2fs_fšd_’Œy
(
Şd_dœ
,

969 &
Şd_d’Œy
->
d_Çme
, &
Şd_·ge
);

970 ià(!
Şd_’Œy
) {

971 
”r
 = -
ENOENT
;

972 ià(
	`IS_ERR
(
Şd_·ge
))

973 
”r
 = 
	`PTR_ERR
(
Şd_·ge
);

974 
	`f2fs_uÆock_İ
(
sbi
);

975 
out_wh™eout
;

980 
	`down_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

981 ià(!
Şd_dœ_’Œy
 || 
wh™eout
)

982 
	`fe_lo¡_pšo
(
Şd_šode
);

985 
	`f2fs_i_pšo_wr™e
(
Şd_šode
, 
Ãw_dœ
->
i_šo
);

986 
	`up_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

988 
Şd_šode
->
i_ùime
 = 
	`cu¼’t_time
(old_inode);

989 
	`f2fs_m¬k_šode_dœty_sync
(
Şd_šode
, 
çl£
);

991 
	`f2fs_d–‘e_’Œy
(
Şd_’Œy
, 
Şd_·ge
, 
Şd_dœ
, 
NULL
);

993 ià(
wh™eout
) {

994 
wh™eout
->
i_¡©e
 |ğ
I_LINKABLE
;

995 
	`£t_šode_æag
(
wh™eout
, 
FI_INC_LINK
);

996 
”r
 = 
	`f2fs_add_lšk
(
Şd_d’Œy
, 
wh™eout
);

997 ià(
”r
)

998 
put_out_dœ
;

999 
wh™eout
->
i_¡©e
 &ğ~
I_LINKABLE
;

1000 
	`ut
(
wh™eout
);

1003 ià(
Şd_dœ_’Œy
) {

1004 ià(
Şd_dœ
 !ğ
Ãw_dœ
 && !
wh™eout
)

1005 
	`f2fs_£t_lšk
(
Şd_šode
, 
Şd_dœ_’Œy
,

1006 
Şd_dœ_·ge
, 
Ãw_dœ
);

1008 
	`f2fs_put_·ge
(
Şd_dœ_·ge
, 0);

1009 
	`f2fs_i_lšks_wr™e
(
Şd_dœ
, 
çl£
);

1011 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_STRICT
) {

1012 
	`f2fs_add_šo_’Œy
(
sbi
, 
Ãw_dœ
->
i_šo
, 
TRANS_DIR_INO
);

1013 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
))

1014 
	`f2fs_add_šo_’Œy
(
sbi
, 
Şd_šode
->
i_šo
,

1015 
TRANS_DIR_INO
);

1018 
	`f2fs_uÆock_İ
(
sbi
);

1020 ià(
	`IS_DIRSYNC
(
Şd_dœ
è|| IS_DIRSYNC(
Ãw_dœ
))

1021 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

1023 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

1026 
put_out_dœ
:

1027 
	`f2fs_uÆock_İ
(
sbi
);

1028 ià(
Ãw_·ge
)

1029 
	`f2fs_put_·ge
(
Ãw_·ge
, 0);

1030 
out_wh™eout
:

1031 ià(
wh™eout
)

1032 
	`ut
(
wh™eout
);

1033 
out_dœ
:

1034 ià(
Şd_dœ_’Œy
)

1035 
	`f2fs_put_·ge
(
Şd_dœ_·ge
, 0);

1036 
out_Şd
:

1037 
	`f2fs_put_·ge
(
Şd_·ge
, 0);

1038 
out
:

1039  
”r
;

1040 
	}
}

1042 
	$f2fs_üoss_»Çme
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

1043 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
)

1045 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
Şd_dœ
);

1046 
šode
 *
Şd_šode
 = 
	`d_šode
(
Şd_d’Œy
);

1047 
šode
 *
Ãw_šode
 = 
	`d_šode
(
Ãw_d’Œy
);

1048 
·ge
 *
Şd_dœ_·ge
, *
Ãw_dœ_·ge
;

1049 
·ge
 *
Şd_·ge
, *
Ãw_·ge
;

1050 
f2fs_dœ_’Œy
 *
Şd_dœ_’Œy
 = 
NULL
, *
Ãw_dœ_’Œy
 = NULL;

1051 
f2fs_dœ_’Œy
 *
Şd_’Œy
, *
Ãw_’Œy
;

1052 
Şd_Æšk
 = 0, 
Ãw_Æšk
 = 0;

1053 
”r
;

1055 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1056  -
EIO
;

1057 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
))

1058  -
ENOSPC
;

1060 ià((
	`is_šode_æag_£t
(
Ãw_dœ
, 
FI_PROJ_INHERIT
) &&

1061 !
	`´ojid_eq
(
	`F2FS_I
(
Ãw_dœ
)->
i_´ojid
,

1062 
	`F2FS_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)) ||

1063 (
	`is_šode_æag_£t
(
Ãw_dœ
, 
FI_PROJ_INHERIT
) &&

1064 !
	`´ojid_eq
(
	`F2FS_I
(
Şd_dœ
)->
i_´ojid
,

1065 
	`F2FS_I
(
Ãw_d’Œy
->
d_šode
)->
i_´ojid
)))

1066  -
EXDEV
;

1068 
”r
 = 
	`dquÙ_š™Ÿlize
(
Şd_dœ
);

1069 ià(
”r
)

1070 
out
;

1072 
”r
 = 
	`dquÙ_š™Ÿlize
(
Ãw_dœ
);

1073 ià(
”r
)

1074 
out
;

1076 
”r
 = -
ENOENT
;

1077 
Şd_’Œy
 = 
	`f2fs_fšd_’Œy
(
Şd_dœ
, &
Şd_d’Œy
->
d_Çme
, &
Şd_·ge
);

1078 ià(!
Şd_’Œy
) {

1079 ià(
	`IS_ERR
(
Şd_·ge
))

1080 
”r
 = 
	`PTR_ERR
(
Şd_·ge
);

1081 
out
;

1084 
Ãw_’Œy
 = 
	`f2fs_fšd_’Œy
(
Ãw_dœ
, &
Ãw_d’Œy
->
d_Çme
, &
Ãw_·ge
);

1085 ià(!
Ãw_’Œy
) {

1086 ià(
	`IS_ERR
(
Ãw_·ge
))

1087 
”r
 = 
	`PTR_ERR
(
Ãw_·ge
);

1088 
out_Şd
;

1092 ià(
Şd_dœ
 !ğ
Ãw_dœ
) {

1093 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

1094 
Şd_dœ_’Œy
 = 
	`f2fs_·»Á_dœ
(
Şd_šode
,

1095 &
Şd_dœ_·ge
);

1096 ià(!
Şd_dœ_’Œy
) {

1097 ià(
	`IS_ERR
(
Şd_dœ_·ge
))

1098 
”r
 = 
	`PTR_ERR
(
Şd_dœ_·ge
);

1099 
out_Ãw
;

1103 ià(
	`S_ISDIR
(
Ãw_šode
->
i_mode
)) {

1104 
Ãw_dœ_’Œy
 = 
	`f2fs_·»Á_dœ
(
Ãw_šode
,

1105 &
Ãw_dœ_·ge
);

1106 ià(!
Ãw_dœ_’Œy
) {

1107 ià(
	`IS_ERR
(
Ãw_dœ_·ge
))

1108 
”r
 = 
	`PTR_ERR
(
Ãw_dœ_·ge
);

1109 
out_Şd_dœ
;

1119 ià((!
Şd_dœ_’Œy
 || !
Ãw_dœ_’Œy
) &&

1120 
Şd_dœ_’Œy
 !ğ
Ãw_dœ_’Œy
) {

1121 
Şd_Æšk
 = 
Şd_dœ_’Œy
 ? -1 : 1;

1122 
Ãw_Æšk
 = -
Şd_Æšk
;

1123 
”r
 = -
EMLINK
;

1124 ià((
Şd_Æšk
 > 0 && 
Şd_dœ
->
i_Æšk
 >ğ
F2FS_LINK_MAX
) ||

1125 (
Ãw_Æšk
 > 0 && 
Ãw_dœ
->
i_Æšk
 >ğ
F2FS_LINK_MAX
))

1126 
out_Ãw_dœ
;

1129 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

1131 
	`f2fs_lock_İ
(
sbi
);

1134 ià(
Şd_dœ_’Œy
)

1135 
	`f2fs_£t_lšk
(
Şd_šode
, 
Şd_dœ_’Œy
, 
Şd_dœ_·ge
, 
Ãw_dœ
);

1138 ià(
Ãw_dœ_’Œy
)

1139 
	`f2fs_£t_lšk
(
Ãw_šode
, 
Ãw_dœ_’Œy
, 
Ãw_dœ_·ge
, 
Şd_dœ
);

1142 
	`f2fs_£t_lšk
(
Şd_dœ
, 
Şd_’Œy
, 
Şd_·ge
, 
Ãw_šode
);

1144 
	`down_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

1145 ià(!
Şd_dœ_’Œy
)

1146 
	`fe_lo¡_pšo
(
Şd_šode
);

1149 
	`f2fs_i_pšo_wr™e
(
Şd_šode
, 
Ãw_dœ
->
i_šo
);

1150 
	`up_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

1152 
Şd_dœ
->
i_ùime
 = 
	`cu¼’t_time
(old_dir);

1153 ià(
Şd_Æšk
) {

1154 
	`down_wr™e
(&
	`F2FS_I
(
Şd_dœ
)->
i_£m
);

1155 
	`f2fs_i_lšks_wr™e
(
Şd_dœ
, 
Şd_Æšk
 > 0);

1156 
	`up_wr™e
(&
	`F2FS_I
(
Şd_dœ
)->
i_£m
);

1158 
	`f2fs_m¬k_šode_dœty_sync
(
Şd_dœ
, 
çl£
);

1161 
	`f2fs_£t_lšk
(
Ãw_dœ
, 
Ãw_’Œy
, 
Ãw_·ge
, 
Şd_šode
);

1163 
	`down_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

1164 ià(!
Ãw_dœ_’Œy
)

1165 
	`fe_lo¡_pšo
(
Ãw_šode
);

1168 
	`f2fs_i_pšo_wr™e
(
Ãw_šode
, 
Şd_dœ
->
i_šo
);

1169 
	`up_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

1171 
Ãw_dœ
->
i_ùime
 = 
	`cu¼’t_time
(new_dir);

1172 ià(
Ãw_Æšk
) {

1173 
	`down_wr™e
(&
	`F2FS_I
(
Ãw_dœ
)->
i_£m
);

1174 
	`f2fs_i_lšks_wr™e
(
Ãw_dœ
, 
Ãw_Æšk
 > 0);

1175 
	`up_wr™e
(&
	`F2FS_I
(
Ãw_dœ
)->
i_£m
);

1177 
	`f2fs_m¬k_šode_dœty_sync
(
Ãw_dœ
, 
çl£
);

1179 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_STRICT
) {

1180 
	`f2fs_add_šo_’Œy
(
sbi
, 
Şd_dœ
->
i_šo
, 
TRANS_DIR_INO
);

1181 
	`f2fs_add_šo_’Œy
(
sbi
, 
Ãw_dœ
->
i_šo
, 
TRANS_DIR_INO
);

1184 
	`f2fs_uÆock_İ
(
sbi
);

1186 ià(
	`IS_DIRSYNC
(
Şd_dœ
è|| IS_DIRSYNC(
Ãw_dœ
))

1187 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

1189 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

1191 
out_Ãw_dœ
:

1192 ià(
Ãw_dœ_’Œy
) {

1193 
	`f2fs_put_·ge
(
Ãw_dœ_·ge
, 0);

1195 
out_Şd_dœ
:

1196 ià(
Şd_dœ_’Œy
) {

1197 
	`f2fs_put_·ge
(
Şd_dœ_·ge
, 0);

1199 
out_Ãw
:

1200 
	`f2fs_put_·ge
(
Ãw_·ge
, 0);

1201 
out_Şd
:

1202 
	`f2fs_put_·ge
(
Şd_·ge
, 0);

1203 
out
:

1204  
”r
;

1205 
	}
}

1207 
	$f2fs_»Çme2
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

1208 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

1209 
æags
)

1211 
”r
;

1213 ià(
æags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

1214  -
EINVAL
;

1216 
”r
 = 
	`fsüy±_´•¬e_»Çme
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
,

1217 
æags
);

1218 ià(
”r
)

1219  
”r
;

1221 ià(
æags
 & 
RENAME_EXCHANGE
) {

1222  
	`f2fs_üoss_»Çme
(
Şd_dœ
, 
Şd_d’Œy
,

1223 
Ãw_dœ
, 
Ãw_d’Œy
);

1229  
	`f2fs_»Çme
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
, 
æags
);

1230 
	}
}

1232 cÚ¡ *
	$f2fs_’üy±ed_g‘_lšk
(
d’Œy
 *dentry,

1233 
šode
 *inode,

1234 
d–ayed_ÿÎ
 *
dÚe
)

1236 
·ge
 *page;

1237 cÚ¡ *
rg‘
;

1239 ià(!
d’Œy
)

1240  
	`ERR_PTR
(-
ECHILD
);

1242 
·ge
 = 
	`»ad_m­pšg_·ge
(
šode
->
i_m­pšg
, 0, 
NULL
);

1243 ià(
	`IS_ERR
(
·ge
))

1244  
	`ERR_CAST
(
·ge
);

1246 
rg‘
 = 
	`fsüy±_g‘_symlšk
(
šode
, 
	`·ge_add»ss
(
·ge
),

1247 
šode
->
i_sb
->
s_blocksize
, 
dÚe
);

1248 
	`put_·ge
(
·ge
);

1249  
rg‘
;

1250 
	}
}

1252 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_’üy±ed_symlšk_šode_İ”©iÚs
 = {

1253 .
g‘_lšk
 = 
f2fs_’üy±ed_g‘_lšk
,

1254 .
	gg‘©Œ
 = 
f2fs_g‘©Œ
,

1255 .
	g£‰r
 = 
f2fs_£‰r
,

1256 #ifdeà
CONFIG_F2FS_FS_XATTR


1257 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

1261 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_dœ_šode_İ”©iÚs
 = {

1262 .
ü—‹
 = 
f2fs_ü—‹
,

1263 .
	glookup
 = 
f2fs_lookup
,

1264 .
	glšk
 = 
f2fs_lšk
,

1265 .
	guÆšk
 = 
f2fs_uÆšk
,

1266 .
	gsymlšk
 = 
f2fs_symlšk
,

1267 .
	gmkdœ
 = 
f2fs_mkdœ
,

1268 .
	grmdœ
 = 
f2fs_rmdœ
,

1269 .
	gmknod
 = 
f2fs_mknod
,

1270 .
	g»Çme
 = 
f2fs_»Çme2
,

1271 .
	gtmpfe
 = 
f2fs_tmpfe
,

1272 .
	gg‘©Œ
 = 
f2fs_g‘©Œ
,

1273 .
	g£‰r
 = 
f2fs_£‰r
,

1274 .
	gg‘_aş
 = 
f2fs_g‘_aş
,

1275 .
	g£t_aş
 = 
f2fs_£t_aş
,

1276 #ifdeà
CONFIG_F2FS_FS_XATTR


1277 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

1279 .
	gf›m­
 = 
f2fs_f›m­
,

1282 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_symlšk_šode_İ”©iÚs
 = {

1283 .
g‘_lšk
 = 
f2fs_g‘_lšk
,

1284 .
	gg‘©Œ
 = 
f2fs_g‘©Œ
,

1285 .
	g£‰r
 = 
f2fs_£‰r
,

1286 #ifdeà
CONFIG_F2FS_FS_XATTR


1287 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

1291 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_¥ecŸl_šode_İ”©iÚs
 = {

1292 .
g‘©Œ
 = 
f2fs_g‘©Œ
,

1293 .
	g£‰r
 = 
f2fs_£‰r
,

1294 .
	gg‘_aş
 = 
f2fs_g‘_aş
,

1295 .
	g£t_aş
 = 
f2fs_£t_aş
,

1296 #ifdeà
CONFIG_F2FS_FS_XATTR


1297 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

	@node.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/f2fs_fs.h
>

10 
	~<lšux/m·ge.h
>

11 
	~<lšux/backšg-dev.h
>

12 
	~<lšux/blkdev.h
>

13 
	~<lšux/·gevec.h
>

14 
	~<lšux/sw­.h
>

16 
	~"f2fs.h
"

17 
	~"node.h
"

18 
	~"£gm’t.h
"

19 
	~"x©Œ.h
"

20 
	~"Œaû.h
"

21 
	~<Œaû/ev’ts/f2fs.h
>

23 
	#Ú_f2fs_bud_ä“_nids
(
nmi
è
	`mu‹x_is_locked
(&(
nm_i
)->
bud_lock
)

	)

25 
kmem_ÿche
 *
	gÇt_’Œy_¦ab
;

26 
kmem_ÿche
 *
	gä“_nid_¦ab
;

27 
kmem_ÿche
 *
	gÇt_’Œy_£t_¦ab
;

28 
kmem_ÿche
 *
	gfsync_node_’Œy_¦ab
;

33 
	$f2fs_check_nid_¿nge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

35 ià(
	`uÆik–y
(
nid
 < 
	`F2FS_ROOT_INO
(
sbi
è||‚id >ğ
	`NM_I
(sbi)->
max_nid
)) {

36 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

37 
	`f2fs_w¬n
(
sbi
, "%s: out-of-range‚id=%x,„un fscko fix.",

38 
__func__
, 
nid
);

39  -
EFSCORRUPTED
;

42 
	}
}

44 
boŞ
 
	$f2fs_avaabË_ä“_memÜy
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

46 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

47 
sysšfo
 
v®
;

48 
ava_¿m
;

49 
mem_size
 = 0;

50 
boŞ
 
»s
 = 
çl£
;

52 
	`si_memšfo
(&
v®
);

55 
ava_¿m
 = 
v®
.
tÙ®¿m
 - v®.
tÙ®high
;

60 ià(
ty³
 =ğ
FREE_NIDS
) {

61 
mem_size
 = (
nm_i
->
nid_út
[
FREE_NID
] *

62 (
ä“_nid
)è>> 
PAGE_SHIFT
;

63 
»s
 = 
mem_size
 < ((
ava_¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 2);

64 } ià(
ty³
 =ğ
NAT_ENTRIES
) {

65 
mem_size
 = (
nm_i
->
Çt_út
 * (
Çt_’Œy
)) >>

66 
PAGE_SHIFT
;

67 
»s
 = 
mem_size
 < ((
ava_¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 2);

68 ià(
	`exûss_ÿched_Çts
(
sbi
))

69 
»s
 = 
çl£
;

70 } ià(
ty³
 =ğ
DIRTY_DENTS
) {

71 ià(
sbi
->
sb
->
s_bdi
->
wb
.
dœty_exûeded
)

72  
çl£
;

73 
mem_size
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
);

74 
»s
 = 
mem_size
 < ((
ava_¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 1);

75 } ià(
ty³
 =ğ
INO_ENTRIES
) {

76 
i
;

78 
i
 = 0; i < 
MAX_INO_ENTRY
; i++)

79 
mem_size
 +ğ
sbi
->
im
[
i
].
šo_num
 *

80 (
šo_’Œy
);

81 
mem_size
 >>ğ
PAGE_SHIFT
;

82 
»s
 = 
mem_size
 < ((
ava_¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 1);

83 } ià(
ty³
 =ğ
EXTENT_CACHE
) {

84 
mem_size
 = (
	`©omic_»ad
(&
sbi
->
tÙ®_ext_Œ“
) *

85 (
ex‹Á_Œ“
) +

86 
	`©omic_»ad
(&
sbi
->
tÙ®_ext_node
) *

87 (
ex‹Á_node
)è>> 
PAGE_SHIFT
;

88 
»s
 = 
mem_size
 < ((
ava_¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 1);

89 } ià(
ty³
 =ğ
INMEM_PAGES
) {

91 
mem_size
 = 
	`g‘_·ges
(
sbi
, 
F2FS_INMEM_PAGES
);

92 
»s
 = 
mem_size
 < (
v®
.
tÙ®¿m
 / 5);

94 ià(!
sbi
->
sb
->
s_bdi
->
wb
.
dœty_exûeded
)

95  
Œue
;

97  
»s
;

98 
	}
}

100 
	$ş—r_node_·ge_dœty
(
·ge
 *page)

102 ià(
	`PageDœty
(
·ge
)) {

103 
	`f2fs_ş—r_·ge_ÿche_dœty_g
(
·ge
);

104 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

105 
	`dec_·ge_couÁ
(
	`F2FS_P_SB
(
·ge
), 
F2FS_DIRTY_NODES
);

107 
	`CË¬PageU±od©e
(
·ge
);

108 
	}
}

110 
·ge
 *
	$g‘_cu¼’t_Çt_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

112  
	`f2fs_g‘_m‘a_·ge_noç
(
sbi
, 
	`cu¼’t_Çt_addr
(sbi, 
nid
));

113 
	}
}

115 
·ge
 *
	$g‘_Ãxt_Çt_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

117 
·ge
 *
¤c_·ge
;

118 
·ge
 *
d¡_·ge
;

119 
pgoff_t
 
d¡_off
;

120 *
¤c_addr
;

121 *
d¡_addr
;

122 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

124 
d¡_off
 = 
	`Ãxt_Çt_addr
(
sbi
, 
	`cu¼’t_Çt_addr
(sbi, 
nid
));

127 
¤c_·ge
 = 
	`g‘_cu¼’t_Çt_·ge
(
sbi
, 
nid
);

128 ià(
	`IS_ERR
(
¤c_·ge
))

129  
¤c_·ge
;

130 
d¡_·ge
 = 
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
d¡_off
);

131 
	`f2fs_bug_Ú
(
sbi
, 
	`PageDœty
(
¤c_·ge
));

133 
¤c_addr
 = 
	`·ge_add»ss
(
¤c_·ge
);

134 
d¡_addr
 = 
	`·ge_add»ss
(
d¡_·ge
);

135 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
PAGE_SIZE
);

136 
	`£t_·ge_dœty
(
d¡_·ge
);

137 
	`f2fs_put_·ge
(
¤c_·ge
, 1);

139 
	`£t_to_Ãxt_Çt
(
nm_i
, 
nid
);

141  
d¡_·ge
;

142 
	}
}

144 
Çt_’Œy
 *
	$__®loc_Çt_’Œy
(
nid_t
 
nid
, 
boŞ
 
no_ç
)

146 
Çt_’Œy
 *
Ãw
;

148 ià(
no_ç
)

149 
Ãw
 = 
	`f2fs_kmem_ÿche_®loc
(
Çt_’Œy_¦ab
, 
GFP_F2FS_ZERO
);

151 
Ãw
 = 
	`kmem_ÿche_®loc
(
Çt_’Œy_¦ab
, 
GFP_F2FS_ZERO
);

152 ià(
Ãw
) {

153 
	`Çt_£t_nid
(
Ãw
, 
nid
);

154 
	`Çt_»£t_æag
(
Ãw
);

156  
Ãw
;

157 
	}
}

159 
	$__ä“_Çt_’Œy
(
Çt_’Œy
 *
e
)

161 
	`kmem_ÿche_ä“
(
Çt_’Œy_¦ab
, 
e
);

162 
	}
}

165 
Çt_’Œy
 *
	$__š™_Çt_’Œy
(
f2fs_nm_šfo
 *
nm_i
,

166 
Çt_’Œy
 *
Ã
, 
f2fs_Çt_’Œy
 *
¿w_Ã
, 
boŞ
 
no_ç
)

168 ià(
no_ç
)

169 
	`f2fs_¿dix_Œ“_š£¹
(&
nm_i
->
Çt_roÙ
, 
	`Çt_g‘_nid
(
Ã
),‚e);

170 ià(
	`¿dix_Œ“_š£¹
(&
nm_i
->
Çt_roÙ
, 
	`Çt_g‘_nid
(
Ã
),‚e))

171  
NULL
;

173 ià(
¿w_Ã
)

174 
	`node_šfo_äom_¿w_Çt
(&
Ã
->
ni
, 
¿w_Ã
);

176 
	`¥š_lock
(&
nm_i
->
Çt_li¡_lock
);

177 
	`li¡_add_
(&
Ã
->
li¡
, &
nm_i
->
Çt_’Œ›s
);

178 
	`¥š_uÆock
(&
nm_i
->
Çt_li¡_lock
);

180 
nm_i
->
Çt_út
++;

181  
Ã
;

182 
	}
}

184 
Çt_’Œy
 *
	$__lookup_Çt_ÿche
(
f2fs_nm_šfo
 *
nm_i
, 
nid_t
 
n
)

186 
Çt_’Œy
 *
Ã
;

188 
Ã
 = 
	`¿dix_Œ“_lookup
(&
nm_i
->
Çt_roÙ
, 
n
);

191 ià(
Ã
 && !
	`g‘_Çt_æag
Òe, 
IS_DIRTY
)) {

192 
	`¥š_lock
(&
nm_i
->
Çt_li¡_lock
);

193 ià(!
	`li¡_em±y
(&
Ã
->
li¡
))

194 
	`li¡_move_
(&
Ã
->
li¡
, &
nm_i
->
Çt_’Œ›s
);

195 
	`¥š_uÆock
(&
nm_i
->
Çt_li¡_lock
);

198  
Ã
;

199 
	}
}

201 
	$__gªg_lookup_Çt_ÿche
(
f2fs_nm_šfo
 *
nm_i
,

202 
nid_t
 
¡¬t
, 
Ä
, 
Çt_’Œy
 **
•
)

204  
	`¿dix_Œ“_gªg_lookup
(&
nm_i
->
Çt_roÙ
, (**)
•
, 
¡¬t
, 
Ä
);

205 
	}
}

207 
	$__d–_äom_Çt_ÿche
(
f2fs_nm_šfo
 *
nm_i
, 
Çt_’Œy
 *
e
)

209 
	`¿dix_Œ“_d–‘e
(&
nm_i
->
Çt_roÙ
, 
	`Çt_g‘_nid
(
e
));

210 
nm_i
->
Çt_út
--;

211 
	`__ä“_Çt_’Œy
(
e
);

212 
	}
}

214 
Çt_’Œy_£t
 *
	$__g¿b_Çt_’Œy_£t
(
f2fs_nm_šfo
 *
nm_i
,

215 
Çt_’Œy
 *
Ã
)

217 
nid_t
 
£t
 = 
	`NAT_BLOCK_OFFSET
(
Ã
->
ni
.
nid
);

218 
Çt_’Œy_£t
 *
h—d
;

220 
h—d
 = 
	`¿dix_Œ“_lookup
(&
nm_i
->
Çt_£t_roÙ
, 
£t
);

221 ià(!
h—d
) {

222 
h—d
 = 
	`f2fs_kmem_ÿche_®loc
(
Çt_’Œy_£t_¦ab
, 
GFP_NOFS
);

224 
	`INIT_LIST_HEAD
(&
h—d
->
’Œy_li¡
);

225 
	`INIT_LIST_HEAD
(&
h—d
->
£t_li¡
);

226 
h—d
->
£t
 = set;

227 
h—d
->
’Œy_út
 = 0;

228 
	`f2fs_¿dix_Œ“_š£¹
(&
nm_i
->
Çt_£t_roÙ
, 
£t
, 
h—d
);

230  
h—d
;

231 
	}
}

233 
	$__£t_Çt_ÿche_dœty
(
f2fs_nm_šfo
 *
nm_i
,

234 
Çt_’Œy
 *
Ã
)

236 
Çt_’Œy_£t
 *
h—d
;

237 
boŞ
 
Ãw_Ã
 = 
	`Çt_g‘_blkaddr
(
Ã
è=ğ
NEW_ADDR
;

239 ià(!
Ãw_Ã
)

240 
h—d
 = 
	`__g¿b_Çt_’Œy_£t
(
nm_i
, 
Ã
);

247 ià(!
Ãw_Ã
 && (
	`g‘_Çt_æag
(
Ã
, 
IS_PREALLOC
) ||

248 !
	`g‘_Çt_æag
(
Ã
, 
IS_DIRTY
)))

249 
h—d
->
’Œy_út
++;

251 
	`£t_Çt_æag
(
Ã
, 
IS_PREALLOC
, 
Ãw_Ã
);

253 ià(
	`g‘_Çt_æag
(
Ã
, 
IS_DIRTY
))

254 
»äesh_li¡
;

256 
nm_i
->
dœty_Çt_út
++;

257 
	`£t_Çt_æag
(
Ã
, 
IS_DIRTY
, 
Œue
);

258 
»äesh_li¡
:

259 
	`¥š_lock
(&
nm_i
->
Çt_li¡_lock
);

260 ià(
Ãw_Ã
)

261 
	`li¡_d–_š™
(&
Ã
->
li¡
);

263 
	`li¡_move_
(&
Ã
->
li¡
, &
h—d
->
’Œy_li¡
);

264 
	`¥š_uÆock
(&
nm_i
->
Çt_li¡_lock
);

265 
	}
}

267 
	$__ş—r_Çt_ÿche_dœty
(
f2fs_nm_šfo
 *
nm_i
,

268 
Çt_’Œy_£t
 *
£t
, 
Çt_’Œy
 *
Ã
)

270 
	`¥š_lock
(&
nm_i
->
Çt_li¡_lock
);

271 
	`li¡_move_
(&
Ã
->
li¡
, &
nm_i
->
Çt_’Œ›s
);

272 
	`¥š_uÆock
(&
nm_i
->
Çt_li¡_lock
);

274 
	`£t_Çt_æag
(
Ã
, 
IS_DIRTY
, 
çl£
);

275 
£t
->
’Œy_út
--;

276 
nm_i
->
dœty_Çt_út
--;

277 
	}
}

279 
	$__gªg_lookup_Çt_£t
(
f2fs_nm_šfo
 *
nm_i
,

280 
nid_t
 
¡¬t
, 
Ä
, 
Çt_’Œy_£t
 **
•
)

282  
	`¿dix_Œ“_gªg_lookup
(&
nm_i
->
Çt_£t_roÙ
, (**)
•
,

283 
¡¬t
, 
Ä
);

284 
	}
}

286 
boŞ
 
	$f2fs_š_w¬m_node_li¡
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

288  
	`NODE_MAPPING
(
sbi
è=ğ
·ge
->
m­pšg
 &&

289 
	`IS_DNODE
(
·ge
è&& 
	`is_cŞd_node
(page);

290 
	}
}

292 
	$f2fs_š™_fsync_node_šfo
(
f2fs_sb_šfo
 *
sbi
)

294 
	`¥š_lock_š™
(&
sbi
->
fsync_node_lock
);

295 
	`INIT_LIST_HEAD
(&
sbi
->
fsync_node_li¡
);

296 
sbi
->
fsync_£g_id
 = 0;

297 
sbi
->
fsync_node_num
 = 0;

298 
	}
}

300 
	$f2fs_add_fsync_node_’Œy
(
f2fs_sb_šfo
 *
sbi
,

301 
·ge
 *page)

303 
fsync_node_’Œy
 *
â
;

304 
æags
;

305 
£q_id
;

307 
â
 = 
	`f2fs_kmem_ÿche_®loc
(
fsync_node_’Œy_¦ab
, 
GFP_NOFS
);

309 
	`g‘_·ge
(
·ge
);

310 
â
->
·ge
 =…age;

311 
	`INIT_LIST_HEAD
(&
â
->
li¡
);

313 
	`¥š_lock_œq§ve
(&
sbi
->
fsync_node_lock
, 
æags
);

314 
	`li¡_add_
(&
â
->
li¡
, &
sbi
->
fsync_node_li¡
);

315 
â
->
£q_id
 = 
sbi
->
fsync_£g_id
++;

316 
£q_id
 = 
â
->seq_id;

317 
sbi
->
fsync_node_num
++;

318 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
fsync_node_lock
, 
æags
);

320  
£q_id
;

321 
	}
}

323 
	$f2fs_d–_fsync_node_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

325 
fsync_node_’Œy
 *
â
;

326 
æags
;

328 
	`¥š_lock_œq§ve
(&
sbi
->
fsync_node_lock
, 
æags
);

329 
	`li¡_fÜ_—ch_’Œy
(
â
, &
sbi
->
fsync_node_li¡
, 
li¡
) {

330 ià(
â
->
·ge
 ==…age) {

331 
	`li¡_d–
(&
â
->
li¡
);

332 
sbi
->
fsync_node_num
--;

333 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
fsync_node_lock
, 
æags
);

334 
	`kmem_ÿche_ä“
(
fsync_node_’Œy_¦ab
, 
â
);

335 
	`put_·ge
(
·ge
);

339 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
fsync_node_lock
, 
æags
);

340 
	`f2fs_bug_Ú
(
sbi
, 1);

341 
	}
}

343 
	$f2fs_»£t_fsync_node_šfo
(
f2fs_sb_šfo
 *
sbi
)

345 
æags
;

347 
	`¥š_lock_œq§ve
(&
sbi
->
fsync_node_lock
, 
æags
);

348 
sbi
->
fsync_£g_id
 = 0;

349 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
fsync_node_lock
, 
æags
);

350 
	}
}

352 
	$f2fs_Ãed_d’Œy_m¬k
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

354 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

355 
Çt_’Œy
 *
e
;

356 
boŞ
 
Ãed
 = 
çl£
;

358 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

359 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

360 ià(
e
) {

361 ià(!
	`g‘_Çt_æag
(
e
, 
IS_CHECKPOINTED
) &&

362 !
	`g‘_Çt_æag
(
e
, 
HAS_FSYNCED_INODE
))

363 
Ãed
 = 
Œue
;

365 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

366  
Ãed
;

367 
	}
}

369 
boŞ
 
	$f2fs_is_checkpoš‹d_node
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

371 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

372 
Çt_’Œy
 *
e
;

373 
boŞ
 
is_ı
 = 
Œue
;

375 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

376 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

377 ià(
e
 && !
	`g‘_Çt_æag
Ó, 
IS_CHECKPOINTED
))

378 
is_ı
 = 
çl£
;

379 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

380  
is_ı
;

381 
	}
}

383 
boŞ
 
	$f2fs_Ãed_šode_block_upd©e
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

385 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

386 
Çt_’Œy
 *
e
;

387 
boŞ
 
Ãed_upd©e
 = 
Œue
;

389 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

390 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
šo
);

391 ià(
e
 && 
	`g‘_Çt_æag
Ó, 
HAS_LAST_FSYNC
) &&

392 (
	`g‘_Çt_æag
(
e
, 
IS_CHECKPOINTED
) ||

393 
	`g‘_Çt_æag
(
e
, 
HAS_FSYNCED_INODE
)))

394 
Ãed_upd©e
 = 
çl£
;

395 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

396  
Ãed_upd©e
;

397 
	}
}

400 
	$ÿche_Çt_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
,

401 
f2fs_Çt_’Œy
 *
Ã
)

403 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

404 
Çt_’Œy
 *
Ãw
, *
e
;

406 
Ãw
 = 
	`__®loc_Çt_’Œy
(
nid
, 
çl£
);

407 ià(!
Ãw
)

410 
	`down_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

411 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

412 ià(!
e
)

413 
e
 = 
	`__š™_Çt_’Œy
(
nm_i
, 
Ãw
, 
Ã
, 
çl£
);

415 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_šo
(
e
è!ğ
	`Ë32_to_ıu
(
Ã
->
šo
) ||

416 
	`Çt_g‘_blkaddr
(
e
) !=

417 
	`Ë32_to_ıu
(
Ã
->
block_addr
) ||

418 
	`Çt_g‘_v”siÚ
(
e
è!ğ
Ã
->
v”siÚ
);

419 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

420 ià(
e
 !ğ
Ãw
)

421 
	`__ä“_Çt_’Œy
(
Ãw
);

422 
	}
}

424 
	$£t_node_addr
(
f2fs_sb_šfo
 *
sbi
, 
node_šfo
 *
ni
,

425 
block_t
 
Ãw_blkaddr
, 
boŞ
 
fsync_dÚe
)

427 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

428 
Çt_’Œy
 *
e
;

429 
Çt_’Œy
 *
Ãw
 = 
	`__®loc_Çt_’Œy
(
ni
->
nid
, 
Œue
);

431 
	`down_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

432 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
ni
->
nid
);

433 ià(!
e
) {

434 
e
 = 
	`__š™_Çt_’Œy
(
nm_i
, 
Ãw
, 
NULL
, 
Œue
);

435 
	`cİy_node_šfo
(&
e
->
ni
,‚i);

436 
	`f2fs_bug_Ú
(
sbi
, 
ni
->
blk_addr
 =ğ
NEW_ADDR
);

437 } ià(
Ãw_blkaddr
 =ğ
NEW_ADDR
) {

443 
	`cİy_node_šfo
(&
e
->
ni
,‚i);

444 
	`f2fs_bug_Ú
(
sbi
, 
ni
->
blk_addr
 !ğ
NULL_ADDR
);

447 ià(
e
 !ğ
Ãw
)

448 
	`__ä“_Çt_’Œy
(
Ãw
);

451 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
e
è!ğ
ni
->
blk_addr
);

452 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
e
è=ğ
NULL_ADDR
 &&

453 
Ãw_blkaddr
 =ğ
NULL_ADDR
);

454 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
e
è=ğ
NEW_ADDR
 &&

455 
Ãw_blkaddr
 =ğ
NEW_ADDR
);

456 
	`f2fs_bug_Ú
(
sbi
, 
	`__is_v®id_d©a_blkaddr
(
	`Çt_g‘_blkaddr
(
e
)) &&

457 
Ãw_blkaddr
 =ğ
NEW_ADDR
);

460 ià(
	`Çt_g‘_blkaddr
(
e
è!ğ
NEW_ADDR
 && 
Ãw_blkaddr
 =ğ
NULL_ADDR
) {

461 
v”siÚ
 = 
	`Çt_g‘_v”siÚ
(
e
);

462 
	`Çt_£t_v”siÚ
(
e
, 
	`šc_node_v”siÚ
(
v”siÚ
));

466 
	`Çt_£t_blkaddr
(
e
, 
Ãw_blkaddr
);

467 ià(!
	`__is_v®id_d©a_blkaddr
(
Ãw_blkaddr
))

468 
	`£t_Çt_æag
(
e
, 
IS_CHECKPOINTED
, 
çl£
);

469 
	`__£t_Çt_ÿche_dœty
(
nm_i
, 
e
);

472 ià(
ni
->
nid
 !ğni->
šo
)

473 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
ni
->
šo
);

474 ià(
e
) {

475 ià(
fsync_dÚe
 && 
ni
->
nid
 =ğni->
šo
)

476 
	`£t_Çt_æag
(
e
, 
HAS_FSYNCED_INODE
, 
Œue
);

477 
	`£t_Çt_æag
(
e
, 
HAS_LAST_FSYNC
, 
fsync_dÚe
);

479 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

480 
	}
}

482 
	$f2fs_Œy_to_ä“_Çts
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
)

484 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

485 
Ä
 = 
Ä_shršk
;

487 ià(!
	`down_wr™e_Œylock
(&
nm_i
->
Çt_Œ“_lock
))

490 
	`¥š_lock
(&
nm_i
->
Çt_li¡_lock
);

491 
Ä_shršk
) {

492 
Çt_’Œy
 *
Ã
;

494 ià(
	`li¡_em±y
(&
nm_i
->
Çt_’Œ›s
))

497 
Ã
 = 
	`li¡_fœ¡_’Œy
(&
nm_i
->
Çt_’Œ›s
,

498 
Çt_’Œy
, 
li¡
);

499 
	`li¡_d–
(&
Ã
->
li¡
);

500 
	`¥š_uÆock
(&
nm_i
->
Çt_li¡_lock
);

502 
	`__d–_äom_Çt_ÿche
(
nm_i
, 
Ã
);

503 
Ä_shršk
--;

505 
	`¥š_lock
(&
nm_i
->
Çt_li¡_lock
);

507 
	`¥š_uÆock
(&
nm_i
->
Çt_li¡_lock
);

509 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

510  
Ä
 - 
Ä_shršk
;

511 
	}
}

516 
	$f2fs_g‘_node_šfo
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
,

517 
node_šfo
 *
ni
)

519 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

520 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

521 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

522 
nid_t
 
¡¬t_nid
 = 
	`START_NID
(
nid
);

523 
f2fs_Çt_block
 *
Çt_blk
;

524 
·ge
 *·gğ
NULL
;

525 
f2fs_Çt_’Œy
 
Ã
;

526 
Çt_’Œy
 *
e
;

527 
pgoff_t
 
šdex
;

528 
block_t
 
blkaddr
;

529 
i
;

531 
ni
->
nid
 =‚id;

534 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

535 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

536 ià(
e
) {

537 
ni
->
šo
 = 
	`Çt_g‘_šo
(
e
);

538 
ni
->
blk_addr
 = 
	`Çt_g‘_blkaddr
(
e
);

539 
ni
->
v”siÚ
 = 
	`Çt_g‘_v”siÚ
(
e
);

540 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

544 
	`mem£t
(&
Ã
, 0, (
f2fs_Çt_’Œy
));

547 
	`down_»ad
(&
cur£g
->
jouº®_rw£m
);

548 
i
 = 
	`f2fs_lookup_jouº®_š_cursum
(
jouº®
, 
NAT_JOURNAL
, 
nid
, 0);

549 ià(
i
 >= 0) {

550 
Ã
 = 
	`Çt_š_jouº®
(
jouº®
, 
i
);

551 
	`node_šfo_äom_¿w_Çt
(
ni
, &
Ã
);

553 
	`up_»ad
(&
cur£g
->
jouº®_rw£m
);

554 ià(
i
 >= 0) {

555 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

556 
ÿche
;

560 
šdex
 = 
	`cu¼’t_Çt_addr
(
sbi
, 
nid
);

561 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

563 
·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
šdex
);

564 ià(
	`IS_ERR
(
·ge
))

565  
	`PTR_ERR
(
·ge
);

567 
Çt_blk
 = (
f2fs_Çt_block
 *)
	`·ge_add»ss
(
·ge
);

568 
Ã
 = 
Çt_blk
->
’Œ›s
[
nid
 - 
¡¬t_nid
];

569 
	`node_šfo_äom_¿w_Çt
(
ni
, &
Ã
);

570 
	`f2fs_put_·ge
(
·ge
, 1);

571 
ÿche
:

572 
blkaddr
 = 
	`Ë32_to_ıu
(
Ã
.
block_addr
);

573 ià(
	`__is_v®id_d©a_blkaddr
(
blkaddr
) &&

574 !
	`f2fs_is_v®id_blkaddr
(
sbi
, 
blkaddr
, 
DATA_GENERIC_ENHANCE
))

575  -
EFAULT
;

578 
	`ÿche_Çt_’Œy
(
sbi
, 
nid
, &
Ã
);

580 
	}
}

585 
	$f2fs_¿_node_·ges
(
·ge
 *
·»Á
, 
¡¬t
, 
n
)

587 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·»Á
);

588 
blk_¶ug
 
¶ug
;

589 
i
, 
’d
;

590 
nid_t
 
nid
;

592 
	`blk_¡¬t_¶ug
(&
¶ug
);

595 
’d
 = 
¡¬t
 + 
n
;

596 
’d
 = 
	`mš
Ónd, 
NIDS_PER_BLOCK
);

597 
i
 = 
¡¬t
; i < 
’d
; i++) {

598 
nid
 = 
	`g‘_nid
(
·»Á
, 
i
, 
çl£
);

599 
	`f2fs_¿_node_·ge
(
sbi
, 
nid
);

602 
	`blk_fšish_¶ug
(&
¶ug
);

603 
	}
}

605 
pgoff_t
 
	$f2fs_g‘_Ãxt_·ge_off£t
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
pgofs
)

607 cÚ¡ 
dœeù_šdex
 = 
	`ADDRS_PER_INODE
(
dn
->
šode
);

608 cÚ¡ 
dœeù_blks
 = 
	`ADDRS_PER_BLOCK
(
dn
->
šode
);

609 cÚ¡ 
šdœeù_blks
 = 
	`ADDRS_PER_BLOCK
(
dn
->
šode
è* 
NIDS_PER_BLOCK
;

610 
sk³d_un™
 = 
	`ADDRS_PER_BLOCK
(
dn
->
šode
);

611 
cur_Ëv–
 = 
dn
->cur_level;

612 
max_Ëv–
 = 
dn
->max_level;

613 
pgoff_t
 
ba£
 = 0;

615 ià(!
dn
->
max_Ëv–
)

616  
pgofs
 + 1;

618 
max_Ëv–
-- > 
cur_Ëv–
)

619 
sk³d_un™
 *ğ
NIDS_PER_BLOCK
;

621 
dn
->
max_Ëv–
) {

623 
ba£
 +ğ2 * 
šdœeù_blks
;

626 
ba£
 +ğ2 * 
dœeù_blks
;

629 
ba£
 +ğ
dœeù_šdex
;

632 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
dn
->
šode
), 1);

635  ((
pgofs
 - 
ba£
è/ 
sk³d_un™
 + 1) * skipped_unit + base;

636 
	}
}

642 
	$g‘_node_·th
(
šode
 *šode, 
block
,

643 
off£t
[4], 
noff£t
[4])

645 cÚ¡ 
dœeù_šdex
 = 
	`ADDRS_PER_INODE
(
šode
);

646 cÚ¡ 
dœeù_blks
 = 
	`ADDRS_PER_BLOCK
(
šode
);

647 cÚ¡ 
d±rs_³r_blk
 = 
NIDS_PER_BLOCK
;

648 cÚ¡ 
šdœeù_blks
 = 
	`ADDRS_PER_BLOCK
(
šode
è* 
NIDS_PER_BLOCK
;

649 cÚ¡ 
dšdœeù_blks
 = 
šdœeù_blks
 * 
NIDS_PER_BLOCK
;

650 
n
 = 0;

651 
Ëv–
 = 0;

653 
noff£t
[0] = 0;

655 ià(
block
 < 
dœeù_šdex
) {

656 
off£t
[
n
] = 
block
;

657 
gÙ
;

659 
block
 -ğ
dœeù_šdex
;

660 ià(
block
 < 
dœeù_blks
) {

661 
off£t
[
n
++] = 
NODE_DIR1_BLOCK
;

662 
noff£t
[
n
] = 1;

663 
off£t
[
n
] = 
block
;

664 
Ëv–
 = 1;

665 
gÙ
;

667 
block
 -ğ
dœeù_blks
;

668 ià(
block
 < 
dœeù_blks
) {

669 
off£t
[
n
++] = 
NODE_DIR2_BLOCK
;

670 
noff£t
[
n
] = 2;

671 
off£t
[
n
] = 
block
;

672 
Ëv–
 = 1;

673 
gÙ
;

675 
block
 -ğ
dœeù_blks
;

676 ià(
block
 < 
šdœeù_blks
) {

677 
off£t
[
n
++] = 
NODE_IND1_BLOCK
;

678 
noff£t
[
n
] = 3;

679 
off£t
[
n
++] = 
block
 / 
dœeù_blks
;

680 
noff£t
[
n
] = 4 + 
off£t
[n - 1];

681 
off£t
[
n
] = 
block
 % 
dœeù_blks
;

682 
Ëv–
 = 2;

683 
gÙ
;

685 
block
 -ğ
šdœeù_blks
;

686 ià(
block
 < 
šdœeù_blks
) {

687 
off£t
[
n
++] = 
NODE_IND2_BLOCK
;

688 
noff£t
[
n
] = 4 + 
d±rs_³r_blk
;

689 
off£t
[
n
++] = 
block
 / 
dœeù_blks
;

690 
noff£t
[
n
] = 5 + 
d±rs_³r_blk
 + 
off£t
[n - 1];

691 
off£t
[
n
] = 
block
 % 
dœeù_blks
;

692 
Ëv–
 = 2;

693 
gÙ
;

695 
block
 -ğ
šdœeù_blks
;

696 ià(
block
 < 
dšdœeù_blks
) {

697 
off£t
[
n
++] = 
NODE_DIND_BLOCK
;

698 
noff£t
[
n
] = 5 + (
d±rs_³r_blk
 * 2);

699 
off£t
[
n
++] = 
block
 / 
šdœeù_blks
;

700 
noff£t
[
n
] = 6 + (
d±rs_³r_blk
 * 2) +

701 
off£t
[
n
 - 1] * (
d±rs_³r_blk
 + 1);

702 
off£t
[
n
++] = (
block
 / 
dœeù_blks
è% 
d±rs_³r_blk
;

703 
noff£t
[
n
] = 7 + (
d±rs_³r_blk
 * 2) +

704 
off£t
[
n
 - 2] * (
d±rs_³r_blk
 + 1) +

705 
off£t
[
n
 - 1];

706 
off£t
[
n
] = 
block
 % 
dœeù_blks
;

707 
Ëv–
 = 3;

708 
gÙ
;

710  -
E2BIG
;

712 
gÙ
:

713  
Ëv–
;

714 
	}
}

722 
	$f2fs_g‘_dnode_of_d©a
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
, 
mode
)

724 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

725 
·ge
 *
Åage
[4];

726 
·ge
 *
·»Á
 = 
NULL
;

727 
off£t
[4];

728 
noff£t
[4];

729 
nid_t
 
nids
[4];

730 
Ëv–
, 
i
 = 0;

731 
”r
 = 0;

733 
Ëv–
 = 
	`g‘_node_·th
(
dn
->
šode
, 
šdex
, 
off£t
, 
noff£t
);

734 ià(
Ëv–
 < 0)

735  
Ëv–
;

737 
nids
[0] = 
dn
->
šode
->
i_šo
;

738 
Åage
[0] = 
dn
->
šode_·ge
;

740 ià(!
Åage
[0]) {

741 
Åage
[0] = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nids
[0]);

742 ià(
	`IS_ERR
(
Åage
[0]))

743  
	`PTR_ERR
(
Åage
[0]);

747 ià(
	`f2fs_has_šlše_d©a
(
dn
->
šode
è&& 
šdex
) {

748 
”r
 = -
ENOENT
;

749 
	`f2fs_put_·ge
(
Åage
[0], 1);

750 
»Ëa£_out
;

753 
·»Á
 = 
Åage
[0];

754 ià(
Ëv–
 != 0)

755 
nids
[1] = 
	`g‘_nid
(
·»Á
, 
off£t
[0], 
Œue
);

756 
dn
->
šode_·ge
 = 
Åage
[0];

757 
dn
->
šode_·ge_locked
 = 
Œue
;

760 
i
 = 1; i <ğ
Ëv–
; i++) {

761 
boŞ
 
dÚe
 = 
çl£
;

763 ià(!
nids
[
i
] && 
mode
 =ğ
ALLOC_NODE
) {

765 ià(!
	`f2fs_®loc_nid
(
sbi
, &(
nids
[
i
]))) {

766 
”r
 = -
ENOSPC
;

767 
»Ëa£_·ges
;

770 
dn
->
nid
 = 
nids
[
i
];

771 
Åage
[
i
] = 
	`f2fs_Ãw_node_·ge
(
dn
, 
noff£t
[i]);

772 ià(
	`IS_ERR
(
Åage
[
i
])) {

773 
	`f2fs_®loc_nid_çed
(
sbi
, 
nids
[
i
]);

774 
”r
 = 
	`PTR_ERR
(
Åage
[
i
]);

775 
»Ëa£_·ges
;

778 
	`£t_nid
(
·»Á
, 
off£t
[
i
 - 1], 
nids
[i], i == 1);

779 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
nids
[
i
]);

780 
dÚe
 = 
Œue
;

781 } ià(
mode
 =ğ
LOOKUP_NODE_RA
 && 
i
 =ğ
Ëv–
 &&†evel > 1) {

782 
Åage
[
i
] = 
	`f2fs_g‘_node_·ge_¿
(
·»Á
, 
off£t
[i - 1]);

783 ià(
	`IS_ERR
(
Åage
[
i
])) {

784 
”r
 = 
	`PTR_ERR
(
Åage
[
i
]);

785 
»Ëa£_·ges
;

787 
dÚe
 = 
Œue
;

789 ià(
i
 == 1) {

790 
dn
->
šode_·ge_locked
 = 
çl£
;

791 
	`uÆock_·ge
(
·»Á
);

793 
	`f2fs_put_·ge
(
·»Á
, 1);

796 ià(!
dÚe
) {

797 
Åage
[
i
] = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nids
[i]);

798 ià(
	`IS_ERR
(
Åage
[
i
])) {

799 
”r
 = 
	`PTR_ERR
(
Åage
[
i
]);

800 
	`f2fs_put_·ge
(
Åage
[0], 0);

801 
»Ëa£_out
;

804 ià(
i
 < 
Ëv–
) {

805 
·»Á
 = 
Åage
[
i
];

806 
nids
[
i
 + 1] = 
	`g‘_nid
(
·»Á
, 
off£t
[i], 
çl£
);

809 
dn
->
nid
 = 
nids
[
Ëv–
];

810 
dn
->
ofs_š_node
 = 
off£t
[
Ëv–
];

811 
dn
->
node_·ge
 = 
Åage
[
Ëv–
];

812 
dn
->
d©a_blkaddr
 = 
	`d©ablock_addr
(dn->
šode
,

813 
dn
->
node_·ge
, dn->
ofs_š_node
);

816 
»Ëa£_·ges
:

817 
	`f2fs_put_·ge
(
·»Á
, 1);

818 ià(
i
 > 1)

819 
	`f2fs_put_·ge
(
Åage
[0], 0);

820 
»Ëa£_out
:

821 
dn
->
šode_·ge
 = 
NULL
;

822 
dn
->
node_·ge
 = 
NULL
;

823 ià(
”r
 =ğ-
ENOENT
) {

824 
dn
->
cur_Ëv–
 = 
i
;

825 
dn
->
max_Ëv–
 = 
Ëv–
;

826 
dn
->
ofs_š_node
 = 
off£t
[
Ëv–
];

828  
”r
;

829 
	}
}

831 
	$Œunÿ‹_node
(
dnode_of_d©a
 *
dn
)

833 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

834 
node_šfo
 
ni
;

835 
”r
;

836 
pgoff_t
 
šdex
;

838 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
ni
);

839 ià(
”r
)

840  
”r
;

843 
	`f2fs_šv®id©e_blocks
(
sbi
, 
ni
.
blk_addr
);

844 
	`dec_v®id_node_couÁ
(
sbi
, 
dn
->
šode
, dn->
nid
 =ğdn->šode->
i_šo
);

845 
	`£t_node_addr
(
sbi
, &
ni
, 
NULL_ADDR
, 
çl£
);

847 ià(
dn
->
nid
 =ğdn->
šode
->
i_šo
) {

848 
	`f2fs_»move_Üphª_šode
(
sbi
, 
dn
->
nid
);

849 
	`dec_v®id_šode_couÁ
(
sbi
);

850 
	`f2fs_šode_synûd
(
dn
->
šode
);

853 
	`ş—r_node_·ge_dœty
(
dn
->
node_·ge
);

854 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

856 
šdex
 = 
dn
->
node_·ge
->index;

857 
	`f2fs_put_·ge
(
dn
->
node_·ge
, 1);

859 
	`šv®id©e_m­pšg_·ges
(
	`NODE_MAPPING
(
sbi
),

860 
šdex
, index);

862 
dn
->
node_·ge
 = 
NULL
;

863 
	`Œaû_f2fs_Œunÿ‹_node
(
dn
->
šode
, dn->
nid
, 
ni
.
blk_addr
);

866 
	}
}

868 
	$Œunÿ‹_dnode
(
dnode_of_d©a
 *
dn
)

870 
·ge
 *page;

871 
”r
;

873 ià(
dn
->
nid
 == 0)

877 
·ge
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
dn
->
šode
), dn->
nid
);

878 ià(
	`IS_ERR
(
·ge
è&& 
	`PTR_ERR
Õageè=ğ-
ENOENT
)

880 ià(
	`IS_ERR
(
·ge
))

881  
	`PTR_ERR
(
·ge
);

884 
dn
->
node_·ge
 = 
·ge
;

885 
dn
->
ofs_š_node
 = 0;

886 
	`f2fs_Œunÿ‹_d©a_blocks
(
dn
);

887 
”r
 = 
	`Œunÿ‹_node
(
dn
);

888 ià(
”r
)

889  
”r
;

892 
	}
}

894 
	$Œunÿ‹_nodes
(
dnode_of_d©a
 *
dn
, 
nofs
,

895 
ofs
, 
d•th
)

897 
dnode_of_d©a
 
rdn
 = *
dn
;

898 
·ge
 *page;

899 
f2fs_node
 *
º
;

900 
nid_t
 
chd_nid
;

901 
chd_nofs
;

902 
ä“d
 = 0;

903 
i
, 
»t
;

905 ià(
dn
->
nid
 == 0)

906  
NIDS_PER_BLOCK
 + 1;

908 
	`Œaû_f2fs_Œunÿ‹_nodes_’‹r
(
dn
->
šode
, dn->
nid
, dn->
d©a_blkaddr
);

910 
·ge
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
dn
->
šode
), dn->
nid
);

911 ià(
	`IS_ERR
(
·ge
)) {

912 
	`Œaû_f2fs_Œunÿ‹_nodes_ex™
(
dn
->
šode
, 
	`PTR_ERR
(
·ge
));

913  
	`PTR_ERR
(
·ge
);

916 
	`f2fs_¿_node_·ges
(
·ge
, 
ofs
, 
NIDS_PER_BLOCK
);

918 
º
 = 
	`F2FS_NODE
(
·ge
);

919 ià(
d•th
 < 3) {

920 
i
 = 
ofs
; i < 
NIDS_PER_BLOCK
; i++, 
ä“d
++) {

921 
chd_nid
 = 
	`Ë32_to_ıu
(
º
->
š
.
nid
[
i
]);

922 ià(
chd_nid
 == 0)

924 
rdn
.
nid
 = 
chd_nid
;

925 
»t
 = 
	`Œunÿ‹_dnode
(&
rdn
);

926 ià(
»t
 < 0)

927 
out_”r
;

928 ià(
	`£t_nid
(
·ge
, 
i
, 0, 
çl£
))

929 
dn
->
node_chªged
 = 
Œue
;

932 
chd_nofs
 = 
nofs
 + 
ofs
 * (
NIDS_PER_BLOCK
 + 1) + 1;

933 
i
 = 
ofs
; i < 
NIDS_PER_BLOCK
; i++) {

934 
chd_nid
 = 
	`Ë32_to_ıu
(
º
->
š
.
nid
[
i
]);

935 ià(
chd_nid
 == 0) {

936 
chd_nofs
 +ğ
NIDS_PER_BLOCK
 + 1;

939 
rdn
.
nid
 = 
chd_nid
;

940 
»t
 = 
	`Œunÿ‹_nodes
(&
rdn
, 
chd_nofs
, 0, 
d•th
 - 1);

941 ià(
»t
 =ğ(
NIDS_PER_BLOCK
 + 1)) {

942 ià(
	`£t_nid
(
·ge
, 
i
, 0, 
çl£
))

943 
dn
->
node_chªged
 = 
Œue
;

944 
chd_nofs
 +ğ
»t
;

945 } ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
) {

946 
out_”r
;

949 
ä“d
 = 
chd_nofs
;

952 ià(!
ofs
) {

954 
dn
->
node_·ge
 = 
·ge
;

955 
»t
 = 
	`Œunÿ‹_node
(
dn
);

956 ià(
»t
)

957 
out_”r
;

958 
ä“d
++;

960 
	`f2fs_put_·ge
(
·ge
, 1);

962 
	`Œaû_f2fs_Œunÿ‹_nodes_ex™
(
dn
->
šode
, 
ä“d
);

963  
ä“d
;

965 
out_”r
:

966 
	`f2fs_put_·ge
(
·ge
, 1);

967 
	`Œaû_f2fs_Œunÿ‹_nodes_ex™
(
dn
->
šode
, 
»t
);

968  
»t
;

969 
	}
}

971 
	$Œunÿ‹_·¹Ÿl_nodes
(
dnode_of_d©a
 *
dn
,

972 
f2fs_šode
 *
ri
, *
off£t
, 
d•th
)

974 
·ge
 *
·ges
[2];

975 
nid_t
 
nid
[3];

976 
nid_t
 
chd_nid
;

977 
”r
 = 0;

978 
i
;

979 
idx
 = 
d•th
 - 2;

981 
nid
[0] = 
	`Ë32_to_ıu
(
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
]);

982 ià(!
nid
[0])

986 
i
 = 0; i < 
idx
 + 1; i++) {

988 
·ges
[
i
] = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
dn
->
šode
), 
nid
[i]);

989 ià(
	`IS_ERR
(
·ges
[
i
])) {

990 
”r
 = 
	`PTR_ERR
(
·ges
[
i
]);

991 
idx
 = 
i
 - 1;

992 
ç
;

994 
nid
[
i
 + 1] = 
	`g‘_nid
(
·ges
[i], 
off£t
[˜+ 1], 
çl£
);

997 
	`f2fs_¿_node_·ges
(
·ges
[
idx
], 
off£t
[idx + 1], 
NIDS_PER_BLOCK
);

1000 
i
 = 
off£t
[
idx
 + 1]; i < 
NIDS_PER_BLOCK
; i++) {

1001 
chd_nid
 = 
	`g‘_nid
(
·ges
[
idx
], 
i
, 
çl£
);

1002 ià(!
chd_nid
)

1004 
dn
->
nid
 = 
chd_nid
;

1005 
”r
 = 
	`Œunÿ‹_dnode
(
dn
);

1006 ià(
”r
 < 0)

1007 
ç
;

1008 ià(
	`£t_nid
(
·ges
[
idx
], 
i
, 0, 
çl£
))

1009 
dn
->
node_chªged
 = 
Œue
;

1012 ià(
off£t
[
idx
 + 1] == 0) {

1013 
dn
->
node_·ge
 = 
·ges
[
idx
];

1014 
dn
->
nid
 =‚id[
idx
];

1015 
”r
 = 
	`Œunÿ‹_node
(
dn
);

1016 ià(
”r
)

1017 
ç
;

1019 
	`f2fs_put_·ge
(
·ges
[
idx
], 1);

1021 
off£t
[
idx
]++;

1022 
off£t
[
idx
 + 1] = 0;

1023 
idx
--;

1024 
ç
:

1025 
i
 = 
idx
; i >= 0; i--)

1026 
	`f2fs_put_·ge
(
·ges
[
i
], 1);

1028 
	`Œaû_f2fs_Œunÿ‹_·¹Ÿl_nodes
(
dn
->
šode
, 
nid
, 
d•th
, 
”r
);

1030  
”r
;

1031 
	}
}

1036 
	$f2fs_Œunÿ‹_šode_blocks
(
šode
 *šode, 
pgoff_t
 
äom
)

1038 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1039 
”r
 = 0, 
cÚt
 = 1;

1040 
Ëv–
, 
off£t
[4], 
noff£t
[4];

1041 
nofs
 = 0;

1042 
f2fs_šode
 *
ri
;

1043 
dnode_of_d©a
 
dn
;

1044 
·ge
 *page;

1046 
	`Œaû_f2fs_Œunÿ‹_šode_blocks_’‹r
(
šode
, 
äom
);

1048 
Ëv–
 = 
	`g‘_node_·th
(
šode
, 
äom
, 
off£t
, 
noff£t
);

1049 ià(
Ëv–
 < 0)

1050  
Ëv–
;

1052 
·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

1053 ià(
	`IS_ERR
(
·ge
)) {

1054 
	`Œaû_f2fs_Œunÿ‹_šode_blocks_ex™
(
šode
, 
	`PTR_ERR
(
·ge
));

1055  
	`PTR_ERR
(
·ge
);

1058 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
·ge
, 
NULL
, 0);

1059 
	`uÆock_·ge
(
·ge
);

1061 
ri
 = 
	`F2FS_INODE
(
·ge
);

1062 
Ëv–
) {

1065 
nofs
 = 
noff£t
[1];

1068 
nofs
 = 
noff£t
[1];

1069 ià(!
off£t
[
Ëv–
 - 1])

1070 
sk_·¹Ÿl
;

1071 
”r
 = 
	`Œunÿ‹_·¹Ÿl_nodes
(&
dn
, 
ri
, 
off£t
, 
Ëv–
);

1072 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOENT
)

1073 
ç
;

1074 
nofs
 +ğ1 + 
NIDS_PER_BLOCK
;

1077 
nofs
 = 5 + 2 * 
NIDS_PER_BLOCK
;

1078 ià(!
off£t
[
Ëv–
 - 1])

1079 
sk_·¹Ÿl
;

1080 
”r
 = 
	`Œunÿ‹_·¹Ÿl_nodes
(&
dn
, 
ri
, 
off£t
, 
Ëv–
);

1081 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOENT
)

1082 
ç
;

1085 
	`BUG
();

1088 
sk_·¹Ÿl
:

1089 
cÚt
) {

1090 
dn
.
nid
 = 
	`Ë32_to_ıu
(
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
]);

1091 
off£t
[0]) {

1092 
NODE_DIR1_BLOCK
:

1093 
NODE_DIR2_BLOCK
:

1094 
”r
 = 
	`Œunÿ‹_dnode
(&
dn
);

1097 
NODE_IND1_BLOCK
:

1098 
NODE_IND2_BLOCK
:

1099 
”r
 = 
	`Œunÿ‹_nodes
(&
dn
, 
nofs
, 
off£t
[1], 2);

1102 
NODE_DIND_BLOCK
:

1103 
”r
 = 
	`Œunÿ‹_nodes
(&
dn
, 
nofs
, 
off£t
[1], 3);

1104 
cÚt
 = 0;

1108 
	`BUG
();

1110 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOENT
)

1111 
ç
;

1112 ià(
off£t
[1] == 0 &&

1113 
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
]) {

1114 
	`lock_·ge
(
·ge
);

1115 
	`BUG_ON
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
));

1116 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
,rue);

1117 
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
] = 0;

1118 
	`£t_·ge_dœty
(
·ge
);

1119 
	`uÆock_·ge
(
·ge
);

1121 
off£t
[1] = 0;

1122 
off£t
[0]++;

1123 
nofs
 +ğ
”r
;

1125 
ç
:

1126 
	`f2fs_put_·ge
(
·ge
, 0);

1127 
	`Œaû_f2fs_Œunÿ‹_šode_blocks_ex™
(
šode
, 
”r
);

1128  
”r
 > 0 ? 0 :ƒrr;

1129 
	}
}

1132 
	$f2fs_Œunÿ‹_x©Œ_node
(
šode
 *inode)

1134 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1135 
nid_t
 
nid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

1136 
dnode_of_d©a
 
dn
;

1137 
·ge
 *
Åage
;

1138 
”r
;

1140 ià(!
nid
)

1143 
Åage
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nid
);

1144 ià(
	`IS_ERR
(
Åage
))

1145  
	`PTR_ERR
(
Åage
);

1147 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, 
Åage
, 
nid
);

1148 
”r
 = 
	`Œunÿ‹_node
(&
dn
);

1149 ià(
”r
) {

1150 
	`f2fs_put_·ge
(
Åage
, 1);

1151  
”r
;

1154 
	`f2fs_i_xnid_wr™e
(
šode
, 0);

1157 
	}
}

1163 
	$f2fs_»move_šode_·ge
(
šode
 *inode)

1165 
dnode_of_d©a
 
dn
;

1166 
”r
;

1168 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, inode->
i_šo
);

1169 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 0, 
LOOKUP_NODE
);

1170 ià(
”r
)

1171  
”r
;

1173 
”r
 = 
	`f2fs_Œunÿ‹_x©Œ_node
(
šode
);

1174 ià(
”r
) {

1175 
	`f2fs_put_dnode
(&
dn
);

1176  
”r
;

1180 ià(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

1181 
	`S_ISLNK
(
šode
->
i_mode
))

1182 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

1185 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_I_SB
(
šode
)))) {

1186 
	`f2fs_put_dnode
(&
dn
);

1187  -
EIO
;

1190 ià(
	`uÆik–y
(
šode
->
i_blocks
 != 0 && inode->i_blocks != 8)) {

1191 
	`f2fs_w¬n
(
	`F2FS_I_SB
(
šode
), "Inconsistent i_blocks, ino:%lu, iblocks:%llu",

1192 
šode
->
i_šo
, ()šode->
i_blocks
);

1193 
	`£t_sbi_æag
(
	`F2FS_I_SB
(
šode
), 
SBI_NEED_FSCK
);

1197 
”r
 = 
	`Œunÿ‹_node
(&
dn
);

1198 ià(
”r
) {

1199 
	`f2fs_put_dnode
(&
dn
);

1200  
”r
;

1203 
	}
}

1205 
·ge
 *
	$f2fs_Ãw_šode_·ge
(
šode
 *inode)

1207 
dnode_of_d©a
 
dn
;

1210 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, inode->
i_šo
);

1213  
	`f2fs_Ãw_node_·ge
(&
dn
, 0);

1214 
	}
}

1216 
·ge
 *
	$f2fs_Ãw_node_·ge
(
dnode_of_d©a
 *
dn
, 
ofs
)

1218 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

1219 
node_šfo
 
Ãw_ni
;

1220 
·ge
 *page;

1221 
”r
;

1223 ià(
	`uÆik–y
(
	`is_šode_æag_£t
(
dn
->
šode
, 
FI_NO_ALLOC
)))

1224  
	`ERR_PTR
(-
EPERM
);

1226 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
dn
->
nid
, 
çl£
);

1227 ià(!
·ge
)

1228  
	`ERR_PTR
(-
ENOMEM
);

1230 ià(
	`uÆik–y
((
”r
 = 
	`šc_v®id_node_couÁ
(
sbi
, 
dn
->
šode
, !
ofs
))))

1231 
ç
;

1233 #ifdeà
CONFIG_F2FS_CHECK_FS


1234 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
Ãw_ni
);

1235 ià(
”r
) {

1236 
	`dec_v®id_node_couÁ
(
sbi
, 
dn
->
šode
, !
ofs
);

1237 
ç
;

1239 
	`f2fs_bug_Ú
(
sbi
, 
Ãw_ni
.
blk_addr
 !ğ
NULL_ADDR
);

1241 
Ãw_ni
.
nid
 = 
dn
->nid;

1242 
Ãw_ni
.
šo
 = 
dn
->
šode
->
i_šo
;

1243 
Ãw_ni
.
blk_addr
 = 
NULL_ADDR
;

1244 
Ãw_ni
.
æag
 = 0;

1245 
Ãw_ni
.
v”siÚ
 = 0;

1246 
	`£t_node_addr
(
sbi
, &
Ãw_ni
, 
NEW_ADDR
, 
çl£
);

1248 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
,rue);

1249 
	`fl_node_foÙ”
(
·ge
, 
dn
->
nid
, dn->
šode
->
i_šo
, 
ofs
, 
Œue
);

1250 
	`£t_cŞd_node
(
·ge
, 
	`S_ISDIR
(
dn
->
šode
->
i_mode
));

1251 ià(!
	`PageU±od©e
(
·ge
))

1252 
	`S‘PageU±od©e
(
·ge
);

1253 ià(
	`£t_·ge_dœty
(
·ge
))

1254 
dn
->
node_chªged
 = 
Œue
;

1256 ià(
	`f2fs_has_x©Œ_block
(
ofs
))

1257 
	`f2fs_i_xnid_wr™e
(
dn
->
šode
, dn->
nid
);

1259 ià(
ofs
 == 0)

1260 
	`šc_v®id_šode_couÁ
(
sbi
);

1261  
·ge
;

1263 
ç
:

1264 
	`ş—r_node_·ge_dœty
(
·ge
);

1265 
	`f2fs_put_·ge
(
·ge
, 1);

1266  
	`ERR_PTR
(
”r
);

1267 
	}
}

1274 
	$»ad_node_·ge
(
·ge
 *·ge, 
İ_æags
)

1276 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

1277 
node_šfo
 
ni
;

1278 
f2fs_io_šfo
 
fio
 = {

1279 .
sbi
 = sbi,

1280 .
ty³
 = 
NODE
,

1281 .
İ
 = 
REQ_OP_READ
,

1282 .
İ_æags
 = op_flags,

1283 .
·ge
 =…age,

1284 .
’üy±ed_·ge
 = 
NULL
,

1286 
”r
;

1288 ià(
	`PageU±od©e
(
·ge
)) {

1289 ià(!
	`f2fs_šode_chksum_v”ify
(
sbi
, 
·ge
)) {

1290 
	`CË¬PageU±od©e
(
·ge
);

1291  -
EFSBADCRC
;

1293  
LOCKED_PAGE
;

1296 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
·ge
->
šdex
, &
ni
);

1297 ià(
”r
)

1298  
”r
;

1300 ià(
	`uÆik–y
(
ni
.
blk_addr
 =ğ
NULL_ADDR
) ||

1301 
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_SHUTDOWN
)) {

1302 
	`CË¬PageU±od©e
(
·ge
);

1303  -
ENOENT
;

1306 
fio
.
Ãw_blkaddr
 = fio.
Şd_blkaddr
 = 
ni
.
blk_addr
;

1307  
	`f2fs_subm™_·ge_bio
(&
fio
);

1308 
	}
}

1313 
	$f2fs_¿_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

1315 
·ge
 *
­age
;

1316 
”r
;

1318 ià(!
nid
)

1320 ià(
	`f2fs_check_nid_¿nge
(
sbi
, 
nid
))

1323 
­age
 = 
	`xa_lßd
(&
	`NODE_MAPPING
(
sbi
)->
i_·ges
, 
nid
);

1324 ià(
­age
)

1327 
­age
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
nid
, 
çl£
);

1328 ià(!
­age
)

1331 
”r
 = 
	`»ad_node_·ge
(
­age
, 
REQ_RAHEAD
);

1332 
	`f2fs_put_·ge
(
­age
, 
”r
 ? 1 : 0);

1333 
	}
}

1335 
·ge
 *
	$__g‘_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
nid
,

1336 
·ge
 *
·»Á
, 
¡¬t
)

1338 
·ge
 *page;

1339 
”r
;

1341 ià(!
nid
)

1342  
	`ERR_PTR
(-
ENOENT
);

1343 ià(
	`f2fs_check_nid_¿nge
(
sbi
, 
nid
))

1344  
	`ERR_PTR
(-
EINVAL
);

1345 
»³©
:

1346 
·ge
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
nid
, 
çl£
);

1347 ià(!
·ge
)

1348  
	`ERR_PTR
(-
ENOMEM
);

1350 
”r
 = 
	`»ad_node_·ge
(
·ge
, 0);

1351 ià(
”r
 < 0) {

1352 
	`f2fs_put_·ge
(
·ge
, 1);

1353  
	`ERR_PTR
(
”r
);

1354 } ià(
”r
 =ğ
LOCKED_PAGE
) {

1355 
”r
 = 0;

1356 
·ge_h™
;

1359 ià(
·»Á
)

1360 
	`f2fs_¿_node_·ges
(
·»Á
, 
¡¬t
 + 1, 
MAX_RA_NODE
);

1362 
	`lock_·ge
(
·ge
);

1364 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1365 
	`f2fs_put_·ge
(
·ge
, 1);

1366 
»³©
;

1369 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

1370 
”r
 = -
EIO
;

1371 
out_”r
;

1374 ià(!
	`f2fs_šode_chksum_v”ify
(
sbi
, 
·ge
)) {

1375 
”r
 = -
EFSBADCRC
;

1376 
out_”r
;

1378 
·ge_h™
:

1379 if(
	`uÆik–y
(
nid
 !ğ
	`nid_of_node
(
·ge
))) {

1380 
	`f2fs_w¬n
(
sbi
, "inconsistent‚ode block,‚id:%lu,‚ode_footer[nid:%u,ino:%u,ofs:%u,cpver:%llu,blkaddr:%u]",

1381 
nid
, 
	`nid_of_node
(
·ge
), 
	`šo_of_node
(page),

1382 
	`ofs_of_node
(
·ge
), 
	`ıv”_of_node
(page),

1383 
	`Ãxt_blkaddr_of_node
(
·ge
));

1384 
”r
 = -
EINVAL
;

1385 
out_”r
:

1386 
	`CË¬PageU±od©e
(
·ge
);

1387 
	`f2fs_put_·ge
(
·ge
, 1);

1388  
	`ERR_PTR
(
”r
);

1390  
·ge
;

1391 
	}
}

1393 
·ge
 *
	$f2fs_g‘_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
nid
)

1395  
	`__g‘_node_·ge
(
sbi
, 
nid
, 
NULL
, 0);

1396 
	}
}

1398 
·ge
 *
	$f2fs_g‘_node_·ge_¿
(
·ge
 *
·»Á
, 
¡¬t
)

1400 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·»Á
);

1401 
nid_t
 
nid
 = 
	`g‘_nid
(
·»Á
, 
¡¬t
, 
çl£
);

1403  
	`__g‘_node_·ge
(
sbi
, 
nid
, 
·»Á
, 
¡¬t
);

1404 
	}
}

1406 
	$æush_šlše_d©a
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

1408 
šode
 *inode;

1409 
·ge
 *page;

1410 
»t
;

1413 
šode
 = 
	`ookup
(
sbi
->
sb
, 
šo
);

1414 ià(!
šode
)

1417 
·ge
 = 
	`f2fs_·geÿche_g‘_·ge
(
šode
->
i_m­pšg
, 0,

1418 
FGP_LOCK
|
FGP_NOWAIT
, 0);

1419 ià(!
·ge
)

1420 
ut_out
;

1422 ià(!
	`PageU±od©e
(
·ge
))

1423 
·ge_out
;

1425 ià(!
	`PageDœty
(
·ge
))

1426 
·ge_out
;

1428 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

1429 
·ge_out
;

1431 
»t
 = 
	`f2fs_wr™e_šlše_d©a
(
šode
, 
·ge
);

1432 
	`šode_dec_dœty_·ges
(
šode
);

1433 
	`f2fs_»move_dœty_šode
(
šode
);

1434 ià(
»t
)

1435 
	`£t_·ge_dœty
(
·ge
);

1436 
·ge_out
:

1437 
	`f2fs_put_·ge
(
·ge
, 1);

1438 
ut_out
:

1439 
	`ut
(
šode
);

1440 
	}
}

1442 
·ge
 *
	$Ï¡_fsync_dnode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

1444 
pgoff_t
 
šdex
;

1445 
·gevec
 
pvec
;

1446 
·ge
 *
Ï¡_·ge
 = 
NULL
;

1447 
Ä_·ges
;

1449 
	`·gevec_š™
(&
pvec
);

1450 
šdex
 = 0;

1452 (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
	`NODE_MAPPING
(
sbi
), &
šdex
,

1453 
PAGECACHE_TAG_DIRTY
))) {

1454 
i
;

1456 
i
 = 0; i < 
Ä_·ges
; i++) {

1457 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1459 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1460 
	`f2fs_put_·ge
(
Ï¡_·ge
, 0);

1461 
	`·gevec_»Ëa£
(&
pvec
);

1462  
	`ERR_PTR
(-
EIO
);

1465 ià(!
	`IS_DNODE
(
·ge
è|| !
	`is_cŞd_node
(page))

1467 ià(
	`šo_of_node
(
·ge
è!ğ
šo
)

1470 
	`lock_·ge
(
·ge
);

1472 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1473 
cÚtšue_uÆock
:

1474 
	`uÆock_·ge
(
·ge
);

1477 ià(
	`šo_of_node
(
·ge
è!ğ
šo
)

1478 
cÚtšue_uÆock
;

1480 ià(!
	`PageDœty
(
·ge
)) {

1482 
cÚtšue_uÆock
;

1485 ià(
Ï¡_·ge
)

1486 
	`f2fs_put_·ge
(
Ï¡_·ge
, 0);

1488 
	`g‘_·ge
(
·ge
);

1489 
Ï¡_·ge
 = 
·ge
;

1490 
	`uÆock_·ge
(
·ge
);

1492 
	`·gevec_»Ëa£
(&
pvec
);

1493 
	`cÚd_»sched
();

1495  
Ï¡_·ge
;

1496 
	}
}

1498 
	$__wr™e_node_·ge
(
·ge
 *·ge, 
boŞ
 
©omic
, boŞ *
subm™‹d
,

1499 
wr™eback_cÚŒŞ
 *
wbc
, 
boŞ
 
do_b®ªû
,

1500 
io¡©_ty³
 
io_ty³
, *
£q_id
)

1502 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

1503 
nid_t
 
nid
;

1504 
node_šfo
 
ni
;

1505 
f2fs_io_šfo
 
fio
 = {

1506 .
sbi
 = sbi,

1507 .
šo
 = 
	`šo_of_node
(
·ge
),

1508 .
ty³
 = 
NODE
,

1509 .
İ
 = 
REQ_OP_WRITE
,

1510 .
İ_æags
 = 
	`wbc_to_wr™e_æags
(
wbc
),

1511 .
·ge
 =…age,

1512 .
’üy±ed_·ge
 = 
NULL
,

1513 .
subm™‹d
 = 
çl£
,

1514 .
io_ty³
 = io_type,

1515 .
io_wbc
 = 
wbc
,

1517 
£q
;

1519 
	`Œaû_f2fs_wr™•age
(
·ge
, 
NODE
);

1521 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1522 
»dœty_out
;

1524 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

1525 
»dœty_out
;

1527 ià(!
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
) &&

1528 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
 &&

1529 
	`IS_DNODE
(
·ge
è&& 
	`is_cŞd_node
(page))

1530 
»dœty_out
;

1533 
nid
 = 
	`nid_of_node
(
·ge
);

1534 
	`f2fs_bug_Ú
(
sbi
, 
·ge
->
šdex
 !ğ
nid
);

1536 ià(
	`f2fs_g‘_node_šfo
(
sbi
, 
nid
, &
ni
))

1537 
»dœty_out
;

1539 ià(
wbc
->
fÜ_»şaim
) {

1540 ià(!
	`down_»ad_Œylock
(&
sbi
->
node_wr™e
))

1541 
»dœty_out
;

1543 
	`down_»ad
(&
sbi
->
node_wr™e
);

1547 ià(
	`uÆik–y
(
ni
.
blk_addr
 =ğ
NULL_ADDR
)) {

1548 
	`CË¬PageU±od©e
(
·ge
);

1549 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_NODES
);

1550 
	`up_»ad
(&
sbi
->
node_wr™e
);

1551 
	`uÆock_·ge
(
·ge
);

1555 ià(
	`__is_v®id_d©a_blkaddr
(
ni
.
blk_addr
) &&

1556 !
	`f2fs_is_v®id_blkaddr
(
sbi
, 
ni
.
blk_addr
,

1557 
DATA_GENERIC_ENHANCE
)) {

1558 
	`up_»ad
(&
sbi
->
node_wr™e
);

1559 
»dœty_out
;

1562 ià(
©omic
 && !
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

1563 
fio
.
İ_æags
 |ğ
REQ_PREFLUSH
 | 
REQ_FUA
;

1565 
	`£t_·ge_wr™eback
(
·ge
);

1566 
	`CË¬PageE¼Ü
(
·ge
);

1568 ià(
	`f2fs_š_w¬m_node_li¡
(
sbi
, 
·ge
)) {

1569 
£q
 = 
	`f2fs_add_fsync_node_’Œy
(
sbi
, 
·ge
);

1570 ià(
£q_id
)

1571 *
£q_id
 = 
£q
;

1574 
fio
.
Şd_blkaddr
 = 
ni
.
blk_addr
;

1575 
	`f2fs_do_wr™e_node_·ge
(
nid
, &
fio
);

1576 
	`£t_node_addr
(
sbi
, &
ni
, 
fio
.
Ãw_blkaddr
, 
	`is_fsync_dnode
(
·ge
));

1577 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_NODES
);

1578 
	`up_»ad
(&
sbi
->
node_wr™e
);

1580 ià(
wbc
->
fÜ_»şaim
) {

1581 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
NULL
, 
·ge
, 0, 
NODE
);

1582 
subm™‹d
 = 
NULL
;

1585 
	`uÆock_·ge
(
·ge
);

1587 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1588 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
NODE
);

1589 
subm™‹d
 = 
NULL
;

1591 ià(
subm™‹d
)

1592 *
subm™‹d
 = 
fio
.submitted;

1594 ià(
do_b®ªû
)

1595 
	`f2fs_b®ªû_fs
(
sbi
, 
çl£
);

1598 
»dœty_out
:

1599 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

1600  
AOP_WRITEPAGE_ACTIVATE
;

1601 
	}
}

1603 
	$f2fs_move_node_·ge
(
·ge
 *
node_·ge
, 
gc_ty³
)

1605 
”r
 = 0;

1607 ià(
gc_ty³
 =ğ
FG_GC
) {

1608 
wr™eback_cÚŒŞ
 
wbc
 = {

1609 .
sync_mode
 = 
WB_SYNC_ALL
,

1610 .
Ä_to_wr™e
 = 1,

1611 .
fÜ_»şaim
 = 0,

1614 
	`f2fs_wa™_Ú_·ge_wr™eback
(
node_·ge
, 
NODE
, 
Œue
,rue);

1616 
	`£t_·ge_dœty
(
node_·ge
);

1618 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
node_·ge
)) {

1619 
”r
 = -
EAGAIN
;

1620 
out_·ge
;

1623 ià(
	`__wr™e_node_·ge
(
node_·ge
, 
çl£
, 
NULL
,

1624 &
wbc
, 
çl£
, 
FS_GC_NODE_IO
, 
NULL
)) {

1625 
”r
 = -
EAGAIN
;

1626 
	`uÆock_·ge
(
node_·ge
);

1628 
»Ëa£_·ge
;

1631 ià(!
	`PageWr™eback
(
node_·ge
))

1632 
	`£t_·ge_dœty
(
node_·ge
);

1634 
out_·ge
:

1635 
	`uÆock_·ge
(
node_·ge
);

1636 
»Ëa£_·ge
:

1637 
	`f2fs_put_·ge
(
node_·ge
, 0);

1638  
”r
;

1639 
	}
}

1641 
	$f2fs_wr™e_node_·ge
(
·ge
 *page,

1642 
wr™eback_cÚŒŞ
 *
wbc
)

1644  
	`__wr™e_node_·ge
(
·ge
, 
çl£
, 
NULL
, 
wbc
, false,

1645 
FS_NODE_IO
, 
NULL
);

1646 
	}
}

1648 
	$f2fs_fsync_node_·ges
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

1649 
wr™eback_cÚŒŞ
 *
wbc
, 
boŞ
 
©omic
,

1650 *
£q_id
)

1652 
pgoff_t
 
šdex
;

1653 
·gevec
 
pvec
;

1654 
»t
 = 0;

1655 
·ge
 *
Ï¡_·ge
 = 
NULL
;

1656 
boŞ
 
m¬ked
 = 
çl£
;

1657 
nid_t
 
šo
 = 
šode
->
i_šo
;

1658 
Ä_·ges
;

1659 
nwr™‹n
 = 0;

1661 ià(
©omic
) {

1662 
Ï¡_·ge
 = 
	`Ï¡_fsync_dnode
(
sbi
, 
šo
);

1663 ià(
	`IS_ERR_OR_NULL
(
Ï¡_·ge
))

1664  
	`PTR_ERR_OR_ZERO
(
Ï¡_·ge
);

1666 
»Œy
:

1667 
	`·gevec_š™
(&
pvec
);

1668 
šdex
 = 0;

1670 (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
	`NODE_MAPPING
(
sbi
), &
šdex
,

1671 
PAGECACHE_TAG_DIRTY
))) {

1672 
i
;

1674 
i
 = 0; i < 
Ä_·ges
; i++) {

1675 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1676 
boŞ
 
subm™‹d
 = 
çl£
;

1678 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1679 
	`f2fs_put_·ge
(
Ï¡_·ge
, 0);

1680 
	`·gevec_»Ëa£
(&
pvec
);

1681 
»t
 = -
EIO
;

1682 
out
;

1685 ià(!
	`IS_DNODE
(
·ge
è|| !
	`is_cŞd_node
(page))

1687 ià(
	`šo_of_node
(
·ge
è!ğ
šo
)

1690 
	`lock_·ge
(
·ge
);

1692 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1693 
cÚtšue_uÆock
:

1694 
	`uÆock_·ge
(
·ge
);

1697 ià(
	`šo_of_node
(
·ge
è!ğ
šo
)

1698 
cÚtšue_uÆock
;

1700 ià(!
	`PageDœty
(
·ge
è&&…ag!ğ
Ï¡_·ge
) {

1702 
cÚtšue_uÆock
;

1705 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
,rue);

1707 
	`£t_fsync_m¬k
(
·ge
, 0);

1708 
	`£t_d’Œy_m¬k
(
·ge
, 0);

1710 ià(!
©omic
 || 
·ge
 =ğ
Ï¡_·ge
) {

1711 
	`£t_fsync_m¬k
(
·ge
, 1);

1712 ià(
	`IS_INODE
(
·ge
)) {

1713 ià(
	`is_šode_æag_£t
(
šode
,

1714 
FI_DIRTY_INODE
))

1715 
	`f2fs_upd©e_šode
(
šode
, 
·ge
);

1716 
	`£t_d’Œy_m¬k
(
·ge
,

1717 
	`f2fs_Ãed_d’Œy_m¬k
(
sbi
, 
šo
));

1720 ià(!
	`PageDœty
(
·ge
))

1721 
	`£t_·ge_dœty
(
·ge
);

1724 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

1725 
cÚtšue_uÆock
;

1727 
»t
 = 
	`__wr™e_node_·ge
(
·ge
, 
©omic
 &&

1728 
·ge
 =ğ
Ï¡_·ge
,

1729 &
subm™‹d
, 
wbc
, 
Œue
,

1730 
FS_NODE_IO
, 
£q_id
);

1731 ià(
»t
) {

1732 
	`uÆock_·ge
(
·ge
);

1733 
	`f2fs_put_·ge
(
Ï¡_·ge
, 0);

1735 } ià(
subm™‹d
) {

1736 
nwr™‹n
++;

1739 ià(
·ge
 =ğ
Ï¡_·ge
) {

1740 
	`f2fs_put_·ge
(
·ge
, 0);

1741 
m¬ked
 = 
Œue
;

1745 
	`·gevec_»Ëa£
(&
pvec
);

1746 
	`cÚd_»sched
();

1748 ià(
»t
 || 
m¬ked
)

1751 ià(!
»t
 && 
©omic
 && !
m¬ked
) {

1752 
	`f2fs_debug
(
sbi
, "Retryo write fsync mark: ino=%u, idx=%lx",

1753 
šo
, 
Ï¡_·ge
->
šdex
);

1754 
	`lock_·ge
(
Ï¡_·ge
);

1755 
	`f2fs_wa™_Ú_·ge_wr™eback
(
Ï¡_·ge
, 
NODE
, 
Œue
,rue);

1756 
	`£t_·ge_dœty
(
Ï¡_·ge
);

1757 
	`uÆock_·ge
(
Ï¡_·ge
);

1758 
»Œy
;

1760 
out
:

1761 ià(
nwr™‹n
)

1762 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
NULL
, NULL, 
šo
, 
NODE
);

1763  
»t
 ? -
EIO
: 0;

1764 
	}
}

1766 
	$f2fs_m©ch_šo
(
šode
 *šode, 
šo
, *
d©a
)

1768 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1769 
boŞ
 
ş—n
;

1771 ià(
šode
->
i_šo
 !ğ
šo
)

1774 ià(!
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
))

1777 
	`¥š_lock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1778 
ş—n
 = 
	`li¡_em±y
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
);

1779 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1781 ià(
ş—n
)

1784 
šode
 = 
	`ig¿b
(inode);

1785 ià(!
šode
)

1788 
	}
}

1790 
boŞ
 
	$æush_dœty_šode
(
·ge
 *page)

1792 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

1793 
šode
 *inode;

1794 
nid_t
 
šo
 = 
	`šo_of_node
(
·ge
);

1796 
šode
 = 
	`fšd_šode_nowa™
(
sbi
->
sb
, 
šo
, 
f2fs_m©ch_šo
, 
NULL
);

1797 ià(!
šode
)

1798  
çl£
;

1800 
	`f2fs_upd©e_šode
(
šode
, 
·ge
);

1801 
	`uÆock_·ge
(
·ge
);

1803 
	`ut
(
šode
);

1804  
Œue
;

1805 
	}
}

1807 
	$f2fs_sync_node_·ges
(
f2fs_sb_šfo
 *
sbi
,

1808 
wr™eback_cÚŒŞ
 *
wbc
,

1809 
boŞ
 
do_b®ªû
, 
io¡©_ty³
 
io_ty³
)

1811 
pgoff_t
 
šdex
;

1812 
·gevec
 
pvec
;

1813 
¡•
 = 0;

1814 
nwr™‹n
 = 0;

1815 
»t
 = 0;

1816 
Ä_·ges
, 
dÚe
 = 0;

1818 
	`·gevec_š™
(&
pvec
);

1820 
Ãxt_¡•
:

1821 
šdex
 = 0;

1823 !
dÚe
 && (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
,

1824 
	`NODE_MAPPING
(
sbi
), &
šdex
, 
PAGECACHE_TAG_DIRTY
))) {

1825 
i
;

1827 
i
 = 0; i < 
Ä_·ges
; i++) {

1828 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1829 
boŞ
 
subm™‹d
 = 
çl£
;

1830 
boŞ
 
may_dœty
 = 
Œue
;

1833 ià(
	`©omic_»ad
(&
sbi
->
wb_sync_»q
[
NODE
]) &&

1834 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
) {

1835 
dÚe
 = 1;

1845 ià(
¡•
 =ğ0 && 
	`IS_DNODE
(
·ge
))

1847 ià(
¡•
 =ğ1 && (!
	`IS_DNODE
(
·ge
) ||

1848 
	`is_cŞd_node
(
·ge
)))

1850 ià(
¡•
 =ğ2 && (!
	`IS_DNODE
(
·ge
) ||

1851 !
	`is_cŞd_node
(
·ge
)))

1853 
lock_node
:

1854 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

1855 
	`lock_·ge
(
·ge
);

1856 ià(!
	`Œylock_·ge
(
·ge
))

1859 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1860 
cÚtšue_uÆock
:

1861 
	`uÆock_·ge
(
·ge
);

1865 ià(!
	`PageDœty
(
·ge
)) {

1867 
cÚtšue_uÆock
;

1871 ià(
	`is_šlše_node
(
·ge
)) {

1872 
	`ş—r_šlše_node
(
·ge
);

1873 
	`uÆock_·ge
(
·ge
);

1874 
	`æush_šlše_d©a
(
sbi
, 
	`šo_of_node
(
·ge
));

1875 
lock_node
;

1879 ià(
	`IS_INODE
(
·ge
è&& 
may_dœty
) {

1880 
may_dœty
 = 
çl£
;

1881 ià(
	`æush_dœty_šode
(
·ge
))

1882 
lock_node
;

1885 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
,rue);

1887 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

1888 
cÚtšue_uÆock
;

1890 
	`£t_fsync_m¬k
(
·ge
, 0);

1891 
	`£t_d’Œy_m¬k
(
·ge
, 0);

1893 
»t
 = 
	`__wr™e_node_·ge
(
·ge
, 
çl£
, &
subm™‹d
,

1894 
wbc
, 
do_b®ªû
, 
io_ty³
, 
NULL
);

1895 ià(
»t
)

1896 
	`uÆock_·ge
(
·ge
);

1897 ià(
subm™‹d
)

1898 
nwr™‹n
++;

1900 ià(--
wbc
->
Ä_to_wr™e
 == 0)

1903 
	`·gevec_»Ëa£
(&
pvec
);

1904 
	`cÚd_»sched
();

1906 ià(
wbc
->
Ä_to_wr™e
 == 0) {

1907 
¡•
 = 2;

1912 ià(
¡•
 < 2) {

1913 ià(!
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
) &&

1914 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
 && 
¡•
 == 1)

1915 
out
;

1916 
¡•
++;

1917 
Ãxt_¡•
;

1919 
out
:

1920 ià(
nwr™‹n
)

1921 
	`f2fs_subm™_m”ged_wr™e
(
sbi
, 
NODE
);

1923 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1924  -
EIO
;

1925  
»t
;

1926 
	}
}

1928 
	$f2fs_wa™_Ú_node_·ges_wr™eback
(
f2fs_sb_šfo
 *
sbi
,

1929 
£q_id
)

1931 
fsync_node_’Œy
 *
â
;

1932 
·ge
 *page;

1933 
li¡_h—d
 *
h—d
 = &
sbi
->
fsync_node_li¡
;

1934 
æags
;

1935 
cur_£q_id
 = 0;

1936 
»t2
, 
»t
 = 0;

1938 
£q_id
 && 
cur_£q_id
 < seq_id) {

1939 
	`¥š_lock_œq§ve
(&
sbi
->
fsync_node_lock
, 
æags
);

1940 ià(
	`li¡_em±y
(
h—d
)) {

1941 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
fsync_node_lock
, 
æags
);

1944 
â
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
fsync_node_’Œy
, 
li¡
);

1945 ià(
â
->
£q_id
 > seq_id) {

1946 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
fsync_node_lock
, 
æags
);

1949 
cur_£q_id
 = 
â
->
£q_id
;

1950 
·ge
 = 
â
->page;

1951 
	`g‘_·ge
(
·ge
);

1952 
	`¥š_uÆock_œq»¡Üe
(&
sbi
->
fsync_node_lock
, 
æags
);

1954 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
, 
Œue
, 
çl£
);

1955 ià(
	`Te¡CË¬PageE¼Ü
(
·ge
))

1956 
»t
 = -
EIO
;

1958 
	`put_·ge
(
·ge
);

1960 ià(
»t
)

1964 
»t2
 = 
	`fem­_check_”rÜs
(
	`NODE_MAPPING
(
sbi
));

1965 ià(!
»t
)

1966 
»t
 = 
»t2
;

1968  
»t
;

1969 
	}
}

1971 
	$f2fs_wr™e_node_·ges
(
add»ss_¥aû
 *
m­pšg
,

1972 
wr™eback_cÚŒŞ
 *
wbc
)

1974 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_M_SB
(
m­pšg
);

1975 
blk_¶ug
 
¶ug
;

1976 
diff
;

1978 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

1979 
sk_wr™e
;

1982 
	`f2fs_b®ªû_fs_bg
(
sbi
);

1985 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_ALL
 &&

1986 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
) <

1987 
	`Ä_·ges_to_sk
(
sbi
, 
NODE
))

1988 
sk_wr™e
;

1990 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

1991 
	`©omic_šc
(&
sbi
->
wb_sync_»q
[
NODE
]);

1992 ià(
	`©omic_»ad
(&
sbi
->
wb_sync_»q
[
NODE
]))

1993 
sk_wr™e
;

1995 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
NODE
);

1997 
diff
 = 
	`Ä_·ges_to_wr™e
(
sbi
, 
NODE
, 
wbc
);

1998 
	`blk_¡¬t_¶ug
(&
¶ug
);

1999 
	`f2fs_sync_node_·ges
(
sbi
, 
wbc
, 
Œue
, 
FS_NODE_IO
);

2000 
	`blk_fšish_¶ug
(&
¶ug
);

2001 
wbc
->
Ä_to_wr™e
 = 
	`max
(()0, wbc->Ä_to_wr™- 
diff
);

2003 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

2004 
	`©omic_dec
(&
sbi
->
wb_sync_»q
[
NODE
]);

2007 
sk_wr™e
:

2008 
wbc
->
·ges_sk³d
 +ğ
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
);

2009 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
NODE
);

2011 
	}
}

2013 
	$f2fs_£t_node_·ge_dœty
(
·ge
 *page)

2015 
	`Œaû_f2fs_£t_·ge_dœty
(
·ge
, 
NODE
);

2017 ià(!
	`PageU±od©e
(
·ge
))

2018 
	`S‘PageU±od©e
(
·ge
);

2019 #ifdeà
CONFIG_F2FS_CHECK_FS


2020 ià(
	`IS_INODE
(
·ge
))

2021 
	`f2fs_šode_chksum_£t
(
	`F2FS_P_SB
(
·ge
),…age);

2023 ià(!
	`PageDœty
(
·ge
)) {

2024 
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

2025 
	`šc_·ge_couÁ
(
	`F2FS_P_SB
(
·ge
), 
F2FS_DIRTY_NODES
);

2026 
	`f2fs_£t_·ge_´iv©e
(
·ge
, 0);

2027 
	`f2fs_Œaû_pid
(
·ge
);

2031 
	}
}

2036 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gf2fs_node_aİs
 = {

2037 .
wr™•age
 = 
f2fs_wr™e_node_·ge
,

2038 .
	gwr™•ages
 = 
f2fs_wr™e_node_·ges
,

2039 .
	g£t_·ge_dœty
 = 
f2fs_£t_node_·ge_dœty
,

2040 .
	gšv®id©•age
 = 
f2fs_šv®id©e_·ge
,

2041 .
	g»Ëa£·ge
 = 
f2fs_»Ëa£_·ge
,

2042 #ifdeà
CONFIG_MIGRATION


2043 .
	gmig¿‹·ge
 = 
f2fs_mig¿‹_·ge
,

2047 
ä“_nid
 *
	$__lookup_ä“_nid_li¡
(
f2fs_nm_šfo
 *
nm_i
,

2048 
nid_t
 
n
)

2050  
	`¿dix_Œ“_lookup
(&
nm_i
->
ä“_nid_roÙ
, 
n
);

2051 
	}
}

2053 
	$__š£¹_ä“_nid
(
f2fs_sb_šfo
 *
sbi
,

2054 
ä“_nid
 *
i
, 
nid_¡©e
 
¡©e
)

2056 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2058 
”r
 = 
	`¿dix_Œ“_š£¹
(&
nm_i
->
ä“_nid_roÙ
, 
i
->
nid
, i);

2059 ià(
”r
)

2060  
”r
;

2062 
	`f2fs_bug_Ú
(
sbi
, 
¡©e
 !ğ
i
->state);

2063 
nm_i
->
nid_út
[
¡©e
]++;

2064 ià(
¡©e
 =ğ
FREE_NID
)

2065 
	`li¡_add_
(&
i
->
li¡
, &
nm_i
->
ä“_nid_li¡
);

2067 
	}
}

2069 
	$__»move_ä“_nid
(
f2fs_sb_šfo
 *
sbi
,

2070 
ä“_nid
 *
i
, 
nid_¡©e
 
¡©e
)

2072 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2074 
	`f2fs_bug_Ú
(
sbi
, 
¡©e
 !ğ
i
->state);

2075 
nm_i
->
nid_út
[
¡©e
]--;

2076 ià(
¡©e
 =ğ
FREE_NID
)

2077 
	`li¡_d–
(&
i
->
li¡
);

2078 
	`¿dix_Œ“_d–‘e
(&
nm_i
->
ä“_nid_roÙ
, 
i
->
nid
);

2079 
	}
}

2081 
	$__move_ä“_nid
(
f2fs_sb_šfo
 *
sbi
, 
ä“_nid
 *
i
,

2082 
nid_¡©e
 
Üg_¡©e
, nid_¡©
d¡_¡©e
)

2084 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2086 
	`f2fs_bug_Ú
(
sbi
, 
Üg_¡©e
 !ğ
i
->
¡©e
);

2087 
i
->
¡©e
 = 
d¡_¡©e
;

2088 
nm_i
->
nid_út
[
Üg_¡©e
]--;

2089 
nm_i
->
nid_út
[
d¡_¡©e
]++;

2091 
d¡_¡©e
) {

2092 
PREALLOC_NID
:

2093 
	`li¡_d–
(&
i
->
li¡
);

2095 
FREE_NID
:

2096 
	`li¡_add_
(&
i
->
li¡
, &
nm_i
->
ä“_nid_li¡
);

2099 
	`BUG_ON
(1);

2101 
	}
}

2103 
	$upd©e_ä“_nid_b™m­
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
,

2104 
boŞ
 
£t
, boŞ 
bud
)

2106 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2107 
Çt_ofs
 = 
	`NAT_BLOCK_OFFSET
(
nid
);

2108 
nid_ofs
 = 
nid
 - 
	`START_NID
(nid);

2110 ià(!
	`‹¡_b™_Ë
(
Çt_ofs
, 
nm_i
->
Çt_block_b™m­
))

2113 ià(
£t
) {

2114 ià(
	`‹¡_b™_Ë
(
nid_ofs
, 
nm_i
->
ä“_nid_b™m­
[
Çt_ofs
]))

2116 
	`__£t_b™_Ë
(
nid_ofs
, 
nm_i
->
ä“_nid_b™m­
[
Çt_ofs
]);

2117 
nm_i
->
ä“_nid_couÁ
[
Çt_ofs
]++;

2119 ià(!
	`‹¡_b™_Ë
(
nid_ofs
, 
nm_i
->
ä“_nid_b™m­
[
Çt_ofs
]))

2121 
	`__ş—r_b™_Ë
(
nid_ofs
, 
nm_i
->
ä“_nid_b™m­
[
Çt_ofs
]);

2122 ià(!
bud
)

2123 
nm_i
->
ä“_nid_couÁ
[
Çt_ofs
]--;

2125 
	}
}

2128 
boŞ
 
	$add_ä“_nid
(
f2fs_sb_šfo
 *
sbi
,

2129 
nid_t
 
nid
, 
boŞ
 
bud
, boŞ 
upd©e
)

2131 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2132 
ä“_nid
 *
i
, *
e
;

2133 
Çt_’Œy
 *
Ã
;

2134 
”r
 = -
EINVAL
;

2135 
boŞ
 
»t
 = 
çl£
;

2138 ià(
	`uÆik–y
(
nid
 == 0))

2139  
çl£
;

2141 ià(
	`uÆik–y
(
	`f2fs_check_nid_¿nge
(
sbi
, 
nid
)))

2142  
çl£
;

2144 
i
 = 
	`f2fs_kmem_ÿche_®loc
(
ä“_nid_¦ab
, 
GFP_NOFS
);

2145 
i
->
nid
 =‚id;

2146 
i
->
¡©e
 = 
FREE_NID
;

2148 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
 | 
__GFP_NOFAIL
);

2150 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2152 ià(
bud
) {

2174 
Ã
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

2175 ià(
Ã
 && (!
	`g‘_Çt_æag
Òe, 
IS_CHECKPOINTED
) ||

2176 
	`Çt_g‘_blkaddr
(
Ã
è!ğ
NULL_ADDR
))

2177 
”r_out
;

2179 
e
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

2180 ià(
e
) {

2181 ià(
e
->
¡©e
 =ğ
FREE_NID
)

2182 
»t
 = 
Œue
;

2183 
”r_out
;

2186 
»t
 = 
Œue
;

2187 
”r
 = 
	`__š£¹_ä“_nid
(
sbi
, 
i
, 
FREE_NID
);

2188 
”r_out
:

2189 ià(
upd©e
) {

2190 
	`upd©e_ä“_nid_b™m­
(
sbi
, 
nid
, 
»t
, 
bud
);

2191 ià(!
bud
)

2192 
nm_i
->
avaabË_nids
++;

2194 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2195 
	`¿dix_Œ“_´–ßd_’d
();

2197 ià(
”r
)

2198 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

2199  
»t
;

2200 
	}
}

2202 
	$»move_ä“_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

2204 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2205 
ä“_nid
 *
i
;

2206 
boŞ
 
Ãed_ä“
 = 
çl£
;

2208 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2209 
i
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

2210 ià(
i
 && i->
¡©e
 =ğ
FREE_NID
) {

2211 
	`__»move_ä“_nid
(
sbi
, 
i
, 
FREE_NID
);

2212 
Ãed_ä“
 = 
Œue
;

2214 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2216 ià(
Ãed_ä“
)

2217 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

2218 
	}
}

2220 
	$sÿn_Çt_·ge
(
f2fs_sb_šfo
 *
sbi
,

2221 
·ge
 *
Çt_·ge
, 
nid_t
 
¡¬t_nid
)

2223 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2224 
f2fs_Çt_block
 *
Çt_blk
 = 
	`·ge_add»ss
(
Çt_·ge
);

2225 
block_t
 
blk_addr
;

2226 
Çt_ofs
 = 
	`NAT_BLOCK_OFFSET
(
¡¬t_nid
);

2227 
i
;

2229 
	`__£t_b™_Ë
(
Çt_ofs
, 
nm_i
->
Çt_block_b™m­
);

2231 
i
 = 
¡¬t_nid
 % 
NAT_ENTRY_PER_BLOCK
;

2233 ; 
i
 < 
NAT_ENTRY_PER_BLOCK
; i++, 
¡¬t_nid
++) {

2234 ià(
	`uÆik–y
(
¡¬t_nid
 >ğ
nm_i
->
max_nid
))

2237 
blk_addr
 = 
	`Ë32_to_ıu
(
Çt_blk
->
’Œ›s
[
i
].
block_addr
);

2239 ià(
blk_addr
 =ğ
NEW_ADDR
)

2240  -
EINVAL
;

2242 ià(
blk_addr
 =ğ
NULL_ADDR
) {

2243 
	`add_ä“_nid
(
sbi
, 
¡¬t_nid
, 
Œue
,rue);

2245 
	`¥š_lock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

2246 
	`upd©e_ä“_nid_b™m­
(
sbi
, 
¡¬t_nid
, 
çl£
, 
Œue
);

2247 
	`¥š_uÆock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

2252 
	}
}

2254 
	$sÿn_cur£g_ÿche
(
f2fs_sb_šfo
 *
sbi
)

2256 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

2257 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

2258 
i
;

2260 
	`down_»ad
(&
cur£g
->
jouº®_rw£m
);

2261 
i
 = 0; i < 
	`Çts_š_cursum
(
jouº®
); i++) {

2262 
block_t
 
addr
;

2263 
nid_t
 
nid
;

2265 
addr
 = 
	`Ë32_to_ıu
(
	`Çt_š_jouº®
(
jouº®
, 
i
).
block_addr
);

2266 
nid
 = 
	`Ë32_to_ıu
(
	`nid_š_jouº®
(
jouº®
, 
i
));

2267 ià(
addr
 =ğ
NULL_ADDR
)

2268 
	`add_ä“_nid
(
sbi
, 
nid
, 
Œue
, 
çl£
);

2270 
	`»move_ä“_nid
(
sbi
, 
nid
);

2272 
	`up_»ad
(&
cur£g
->
jouº®_rw£m
);

2273 
	}
}

2275 
	$sÿn_ä“_nid_b™s
(
f2fs_sb_šfo
 *
sbi
)

2277 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2278 
i
, 
idx
;

2279 
nid_t
 
nid
;

2281 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

2283 
i
 = 0; i < 
nm_i
->
Çt_blocks
; i++) {

2284 ià(!
	`‹¡_b™_Ë
(
i
, 
nm_i
->
Çt_block_b™m­
))

2286 ià(!
nm_i
->
ä“_nid_couÁ
[
i
])

2288 
idx
 = 0; idx < 
NAT_ENTRY_PER_BLOCK
; idx++) {

2289 
idx
 = 
	`fšd_Ãxt_b™_Ë
(
nm_i
->
ä“_nid_b™m­
[
i
],

2290 
NAT_ENTRY_PER_BLOCK
, 
idx
);

2291 ià(
idx
 >ğ
NAT_ENTRY_PER_BLOCK
)

2294 
nid
 = 
i
 * 
NAT_ENTRY_PER_BLOCK
 + 
idx
;

2295 
	`add_ä“_nid
(
sbi
, 
nid
, 
Œue
, 
çl£
);

2297 ià(
nm_i
->
nid_út
[
FREE_NID
] >ğ
MAX_FREE_NIDS
)

2298 
out
;

2301 
out
:

2302 
	`sÿn_cur£g_ÿche
(
sbi
);

2304 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

2305 
	}
}

2307 
	$__f2fs_bud_ä“_nids
(
f2fs_sb_šfo
 *
sbi
,

2308 
boŞ
 
sync
, boŞ 
mouÁ
)

2310 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2311 
i
 = 0, 
»t
;

2312 
nid_t
 
nid
 = 
nm_i
->
Ãxt_sÿn_nid
;

2314 ià(
	`uÆik–y
(
nid
 >ğ
nm_i
->
max_nid
))

2315 
nid
 = 0;

2318 ià(
nm_i
->
nid_út
[
FREE_NID
] >ğ
NAT_ENTRY_PER_BLOCK
)

2321 ià(!
sync
 && !
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
FREE_NIDS
))

2324 ià(!
mouÁ
) {

2326 
	`sÿn_ä“_nid_b™s
(
sbi
);

2328 ià(
nm_i
->
nid_út
[
FREE_NID
] >ğ
NAT_ENTRY_PER_BLOCK
)

2333 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`NAT_BLOCK_OFFSET
(
nid
), 
FREE_NID_PAGES
,

2334 
META_NAT
, 
Œue
);

2336 
	`down_»ad
(&
nm_i
->
Çt_Œ“_lock
);

2339 ià(!
	`‹¡_b™_Ë
(
	`NAT_BLOCK_OFFSET
(
nid
),

2340 
nm_i
->
Çt_block_b™m­
)) {

2341 
·ge
 *·gğ
	`g‘_cu¼’t_Çt_·ge
(
sbi
, 
nid
);

2343 ià(
	`IS_ERR
(
·ge
)) {

2344 
»t
 = 
	`PTR_ERR
(
·ge
);

2346 
»t
 = 
	`sÿn_Çt_·ge
(
sbi
, 
·ge
, 
nid
);

2347 
	`f2fs_put_·ge
(
·ge
, 1);

2350 ià(
»t
) {

2351 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

2352 
	`f2fs_bug_Ú
(
sbi
, !
mouÁ
);

2353 
	`f2fs_”r
(
sbi
, "NAT is corrupt,„un fscko fix it");

2354  
»t
;

2358 
nid
 +ğ(
NAT_ENTRY_PER_BLOCK
 - (nid % NAT_ENTRY_PER_BLOCK));

2359 ià(
	`uÆik–y
(
nid
 >ğ
nm_i
->
max_nid
))

2360 
nid
 = 0;

2362 ià(++
i
 >ğ
FREE_NID_PAGES
)

2367 
nm_i
->
Ãxt_sÿn_nid
 = 
nid
;

2370 
	`sÿn_cur£g_ÿche
(
sbi
);

2372 
	`up_»ad
(&
nm_i
->
Çt_Œ“_lock
);

2374 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`NAT_BLOCK_OFFSET
(
nm_i
->
Ãxt_sÿn_nid
),

2375 
nm_i
->
¿_nid_·ges
, 
META_NAT
, 
çl£
);

2378 
	}
}

2380 
	$f2fs_bud_ä“_nids
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
sync
, boŞ 
mouÁ
)

2382 
»t
;

2384 
	`mu‹x_lock
(&
	`NM_I
(
sbi
)->
bud_lock
);

2385 
»t
 = 
	`__f2fs_bud_ä“_nids
(
sbi
, 
sync
, 
mouÁ
);

2386 
	`mu‹x_uÆock
(&
	`NM_I
(
sbi
)->
bud_lock
);

2388  
»t
;

2389 
	}
}

2396 
boŞ
 
	$f2fs_®loc_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 *
nid
)

2398 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2399 
ä“_nid
 *
i
 = 
NULL
;

2400 
»Œy
:

2401 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_ALLOC_NID
)) {

2402 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_ALLOC_NID
);

2403  
çl£
;

2406 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2408 ià(
	`uÆik–y
(
nm_i
->
avaabË_nids
 == 0)) {

2409 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2410  
çl£
;

2414 ià(
nm_i
->
nid_út
[
FREE_NID
] && !
	`Ú_f2fs_bud_ä“_nids
(nm_i)) {

2415 
	`f2fs_bug_Ú
(
sbi
, 
	`li¡_em±y
(&
nm_i
->
ä“_nid_li¡
));

2416 
i
 = 
	`li¡_fœ¡_’Œy
(&
nm_i
->
ä“_nid_li¡
,

2417 
ä“_nid
, 
li¡
);

2418 *
nid
 = 
i
->nid;

2420 
	`__move_ä“_nid
(
sbi
, 
i
, 
FREE_NID
, 
PREALLOC_NID
);

2421 
nm_i
->
avaabË_nids
--;

2423 
	`upd©e_ä“_nid_b™m­
(
sbi
, *
nid
, 
çl£
, false);

2425 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2426  
Œue
;

2428 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2431 ià(!
	`f2fs_bud_ä“_nids
(
sbi
, 
Œue
, 
çl£
))

2432 
»Œy
;

2433  
çl£
;

2434 
	}
}

2439 
	$f2fs_®loc_nid_dÚe
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

2441 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2442 
ä“_nid
 *
i
;

2444 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2445 
i
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

2446 
	`f2fs_bug_Ú
(
sbi
, !
i
);

2447 
	`__»move_ä“_nid
(
sbi
, 
i
, 
PREALLOC_NID
);

2448 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2450 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

2451 
	}
}

2456 
	$f2fs_®loc_nid_çed
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

2458 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2459 
ä“_nid
 *
i
;

2460 
boŞ
 
Ãed_ä“
 = 
çl£
;

2462 ià(!
nid
)

2465 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2466 
i
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

2467 
	`f2fs_bug_Ú
(
sbi
, !
i
);

2469 ià(!
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
FREE_NIDS
)) {

2470 
	`__»move_ä“_nid
(
sbi
, 
i
, 
PREALLOC_NID
);

2471 
Ãed_ä“
 = 
Œue
;

2473 
	`__move_ä“_nid
(
sbi
, 
i
, 
PREALLOC_NID
, 
FREE_NID
);

2476 
nm_i
->
avaabË_nids
++;

2478 
	`upd©e_ä“_nid_b™m­
(
sbi
, 
nid
, 
Œue
, 
çl£
);

2480 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2482 ià(
Ãed_ä“
)

2483 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

2484 
	}
}

2486 
	$f2fs_Œy_to_ä“_nids
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
)

2488 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2489 
ä“_nid
 *
i
, *
Ãxt
;

2490 
Ä
 = 
Ä_shršk
;

2492 ià(
nm_i
->
nid_út
[
FREE_NID
] <ğ
MAX_FREE_NIDS
)

2495 ià(!
	`mu‹x_Œylock
(&
nm_i
->
bud_lock
))

2498 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2499 
	`li¡_fÜ_—ch_’Œy_§ã
(
i
, 
Ãxt
, &
nm_i
->
ä“_nid_li¡
, 
li¡
) {

2500 ià(
Ä_shršk
 <= 0 ||

2501 
nm_i
->
nid_út
[
FREE_NID
] <ğ
MAX_FREE_NIDS
)

2504 
	`__»move_ä“_nid
(
sbi
, 
i
, 
FREE_NID
);

2505 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

2506 
Ä_shršk
--;

2508 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2509 
	`mu‹x_uÆock
(&
nm_i
->
bud_lock
);

2511  
Ä
 - 
Ä_shršk
;

2512 
	}
}

2514 
	$f2fs_»cov”_šlše_x©Œ
(
šode
 *šode, 
·ge
 *page)

2516 *
¤c_addr
, *
d¡_addr
;

2517 
size_t
 
šlše_size
;

2518 
·ge
 *
age
;

2519 
f2fs_šode
 *
ri
;

2521 
age
 = 
	`f2fs_g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

2522 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
	`IS_ERR
(
age
));

2524 
ri
 = 
	`F2FS_INODE
(
·ge
);

2525 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_XATTR
) {

2526 
	`£t_šode_æag
(
šode
, 
FI_INLINE_XATTR
);

2528 
	`ş—r_šode_æag
(
šode
, 
FI_INLINE_XATTR
);

2529 
upd©e_šode
;

2532 
d¡_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
age
);

2533 
¤c_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
·ge
);

2534 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

2536 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
, 
Œue
,rue);

2537 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
šlše_size
);

2538 
upd©e_šode
:

2539 
	`f2fs_upd©e_šode
(
šode
, 
age
);

2540 
	`f2fs_put_·ge
(
age
, 1);

2541 
	}
}

2543 
	$f2fs_»cov”_x©Œ_d©a
(
šode
 *šode, 
·ge
 *page)

2545 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2546 
nid_t
 
´ev_xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

2547 
nid_t
 
Ãw_xnid
;

2548 
dnode_of_d©a
 
dn
;

2549 
node_šfo
 
ni
;

2550 
·ge
 *
x·ge
;

2551 
”r
;

2553 ià(!
´ev_xnid
)

2554 
»cov”_xnid
;

2557 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
´ev_xnid
, &
ni
);

2558 ià(
”r
)

2559  
”r
;

2561 
	`f2fs_šv®id©e_blocks
(
sbi
, 
ni
.
blk_addr
);

2562 
	`dec_v®id_node_couÁ
(
sbi
, 
šode
, 
çl£
);

2563 
	`£t_node_addr
(
sbi
, &
ni
, 
NULL_ADDR
, 
çl£
);

2565 
»cov”_xnid
:

2567 ià(!
	`f2fs_®loc_nid
(
sbi
, &
Ãw_xnid
))

2568  -
ENOSPC
;

2570 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 
Ãw_xnid
);

2571 
x·ge
 = 
	`f2fs_Ãw_node_·ge
(&
dn
, 
XATTR_NODE_OFFSET
);

2572 ià(
	`IS_ERR
(
x·ge
)) {

2573 
	`f2fs_®loc_nid_çed
(
sbi
, 
Ãw_xnid
);

2574  
	`PTR_ERR
(
x·ge
);

2577 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
Ãw_xnid
);

2578 
	`f2fs_upd©e_šode_·ge
(
šode
);

2581 
	`memıy
(
	`F2FS_NODE
(
x·ge
), F2FS_NODE(
·ge
), 
VALID_XATTR_BLOCK_SIZE
);

2583 
	`£t_·ge_dœty
(
x·ge
);

2584 
	`f2fs_put_·ge
(
x·ge
, 1);

2587 
	}
}

2589 
	$f2fs_»cov”_šode_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

2591 
f2fs_šode
 *
¤c
, *
d¡
;

2592 
nid_t
 
šo
 = 
	`šo_of_node
(
·ge
);

2593 
node_šfo
 
Şd_ni
, 
Ãw_ni
;

2594 
·ge
 *
age
;

2595 
”r
;

2597 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
šo
, &
Şd_ni
);

2598 ià(
”r
)

2599  
”r
;

2601 ià(
	`uÆik–y
(
Şd_ni
.
blk_addr
 !ğ
NULL_ADDR
))

2602  -
EINVAL
;

2603 
»Œy
:

2604 
age
 = 
	`f2fs_g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
šo
, 
çl£
);

2605 ià(!
age
) {

2606 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

2607 
»Œy
;

2611 
	`»move_ä“_nid
(
sbi
, 
šo
);

2613 ià(!
	`PageU±od©e
(
age
))

2614 
	`S‘PageU±od©e
(
age
);

2615 
	`fl_node_foÙ”
(
age
, 
šo
, ino, 0, 
Œue
);

2616 
	`£t_cŞd_node
(
age
, 
çl£
);

2618 
¤c
 = 
	`F2FS_INODE
(
·ge
);

2619 
d¡
 = 
	`F2FS_INODE
(
age
);

2621 
	`memıy
(
d¡
, 
¤c
, ()&¤c->
i_ext
 - ()src);

2622 
d¡
->
i_size
 = 0;

2623 
d¡
->
i_blocks
 = 
	`ıu_to_Ë64
(1);

2624 
d¡
->
i_lšks
 = 
	`ıu_to_Ë32
(1);

2625 
d¡
->
i_x©Œ_nid
 = 0;

2626 
d¡
->
i_šlše
 = 
¤c
->i_šlš& (
F2FS_INLINE_XATTR
 | 
F2FS_EXTRA_ATTR
);

2627 ià(
d¡
->
i_šlše
 & 
F2FS_EXTRA_ATTR
) {

2628 
d¡
->
i_exŒa_isize
 = 
¤c
->i_extra_isize;

2630 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
) &&

2631 
	`F2FS_FITS_IN_INODE
(
¤c
, 
	`Ë16_to_ıu
(¤c->
i_exŒa_isize
),

2632 
i_šlše_x©Œ_size
))

2633 
d¡
->
i_šlše_x©Œ_size
 = 
¤c
->i_inline_xattr_size;

2635 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
sbi
) &&

2636 
	`F2FS_FITS_IN_INODE
(
¤c
, 
	`Ë16_to_ıu
(¤c->
i_exŒa_isize
),

2637 
i_´ojid
))

2638 
d¡
->
i_´ojid
 = 
¤c
->i_projid;

2640 ià(
	`f2fs_sb_has_šode_ütime
(
sbi
) &&

2641 
	`F2FS_FITS_IN_INODE
(
¤c
, 
	`Ë16_to_ıu
(¤c->
i_exŒa_isize
),

2642 
i_ütime_n£c
)) {

2643 
d¡
->
i_ütime
 = 
¤c
->i_crtime;

2644 
d¡
->
i_ütime_n£c
 = 
¤c
->i_crtime_nsec;

2648 
Ãw_ni
 = 
Şd_ni
;

2649 
Ãw_ni
.
šo
 = ino;

2651 ià(
	`uÆik–y
(
	`šc_v®id_node_couÁ
(
sbi
, 
NULL
, 
Œue
)))

2652 
	`WARN_ON
(1);

2653 
	`£t_node_addr
(
sbi
, &
Ãw_ni
, 
NEW_ADDR
, 
çl£
);

2654 
	`šc_v®id_šode_couÁ
(
sbi
);

2655 
	`£t_·ge_dœty
(
age
);

2656 
	`f2fs_put_·ge
(
age
, 1);

2658 
	}
}

2660 
	$f2fs_»¡Üe_node_summ¬y
(
f2fs_sb_šfo
 *
sbi
,

2661 
£gno
, 
f2fs_summ¬y_block
 *
sum
)

2663 
f2fs_node
 *
º
;

2664 
f2fs_summ¬y
 *
sum_’Œy
;

2665 
block_t
 
addr
;

2666 
i
, 
idx
, 
Ï¡_off£t
, 
Ä·ges
;

2669 
Ï¡_off£t
 = 
sbi
->
blocks_³r_£g
;

2670 
addr
 = 
	`START_BLOCK
(
sbi
, 
£gno
);

2671 
sum_’Œy
 = &
sum
->
’Œ›s
[0];

2673 
i
 = 0; i < 
Ï¡_off£t
; i +ğ
Ä·ges
, 
addr
 +=‚rpages) {

2674 
Ä·ges
 = 
	`mš
(
Ï¡_off£t
 - 
i
, 
BIO_MAX_PAGES
);

2677 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
addr
, 
Ä·ges
, 
META_POR
, 
Œue
);

2679 
idx
 = 
addr
; idx <‡dd¸+ 
Ä·ges
; idx++) {

2680 
·ge
 *·gğ
	`f2fs_g‘_tmp_·ge
(
sbi
, 
idx
);

2682 ià(
	`IS_ERR
(
·ge
))

2683  
	`PTR_ERR
(
·ge
);

2685 
º
 = 
	`F2FS_NODE
(
·ge
);

2686 
sum_’Œy
->
nid
 = 
º
->
foÙ”
.nid;

2687 
sum_’Œy
->
v”siÚ
 = 0;

2688 
sum_’Œy
->
ofs_š_node
 = 0;

2689 
sum_’Œy
++;

2690 
	`f2fs_put_·ge
(
·ge
, 1);

2693 
	`šv®id©e_m­pšg_·ges
(
	`META_MAPPING
(
sbi
), 
addr
,

2694 
addr
 + 
Ä·ges
);

2697 
	}
}

2699 
	$»move_Çts_š_jouº®
(
f2fs_sb_šfo
 *
sbi
)

2701 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2702 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

2703 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

2704 
i
;

2706 
	`down_wr™e
(&
cur£g
->
jouº®_rw£m
);

2707 
i
 = 0; i < 
	`Çts_š_cursum
(
jouº®
); i++) {

2708 
Çt_’Œy
 *
Ã
;

2709 
f2fs_Çt_’Œy
 
¿w_Ã
;

2710 
nid_t
 
nid
 = 
	`Ë32_to_ıu
(
	`nid_š_jouº®
(
jouº®
, 
i
));

2712 
¿w_Ã
 = 
	`Çt_š_jouº®
(
jouº®
, 
i
);

2714 
Ã
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

2715 ià(!
Ã
) {

2716 
Ã
 = 
	`__®loc_Çt_’Œy
(
nid
, 
Œue
);

2717 
	`__š™_Çt_’Œy
(
nm_i
, 
Ã
, &
¿w_Ã
, 
Œue
);

2725 ià(!
	`g‘_Çt_æag
(
Ã
, 
IS_DIRTY
) &&

2726 
	`Ë32_to_ıu
(
¿w_Ã
.
block_addr
è=ğ
NULL_ADDR
) {

2727 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

2728 
nm_i
->
avaabË_nids
--;

2729 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

2732 
	`__£t_Çt_ÿche_dœty
(
nm_i
, 
Ã
);

2734 
	`upd©e_Çts_š_cursum
(
jouº®
, -
i
);

2735 
	`up_wr™e
(&
cur£g
->
jouº®_rw£m
);

2736 
	}
}

2738 
	$__adju¡_Çt_’Œy_£t
(
Çt_’Œy_£t
 *
Ãs
,

2739 
li¡_h—d
 *
h—d
, 
max
)

2741 
Çt_’Œy_£t
 *
cur
;

2743 ià(
Ãs
->
’Œy_út
 >ğ
max
)

2744 
add_out
;

2746 
	`li¡_fÜ_—ch_’Œy
(
cur
, 
h—d
, 
£t_li¡
) {

2747 ià(
cur
->
’Œy_út
 >ğ
Ãs
->entry_cnt) {

2748 
	`li¡_add
(&
Ãs
->
£t_li¡
, 
cur
->£t_li¡.
´ev
);

2752 
add_out
:

2753 
	`li¡_add_
(&
Ãs
->
£t_li¡
, 
h—d
);

2754 
	}
}

2756 
	$__upd©e_Çt_b™s
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
¡¬t_nid
,

2757 
·ge
 *page)

2759 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2760 
Çt_šdex
 = 
¡¬t_nid
 / 
NAT_ENTRY_PER_BLOCK
;

2761 
f2fs_Çt_block
 *
Çt_blk
 = 
	`·ge_add»ss
(
·ge
);

2762 
v®id
 = 0;

2763 
i
 = 0;

2765 ià(!
	`’abËd_Çt_b™s
(
sbi
, 
NULL
))

2768 ià(
Çt_šdex
 == 0) {

2769 
v®id
 = 1;

2770 
i
 = 1;

2772 ; 
i
 < 
NAT_ENTRY_PER_BLOCK
; i++) {

2773 ià(
	`Ë32_to_ıu
(
Çt_blk
->
’Œ›s
[
i
].
block_addr
è!ğ
NULL_ADDR
)

2774 
v®id
++;

2776 ià(
v®id
 == 0) {

2777 
	`__£t_b™_Ë
(
Çt_šdex
, 
nm_i
->
em±y_Çt_b™s
);

2778 
	`__ş—r_b™_Ë
(
Çt_šdex
, 
nm_i
->
fuÎ_Çt_b™s
);

2782 
	`__ş—r_b™_Ë
(
Çt_šdex
, 
nm_i
->
em±y_Çt_b™s
);

2783 ià(
v®id
 =ğ
NAT_ENTRY_PER_BLOCK
)

2784 
	`__£t_b™_Ë
(
Çt_šdex
, 
nm_i
->
fuÎ_Çt_b™s
);

2786 
	`__ş—r_b™_Ë
(
Çt_šdex
, 
nm_i
->
fuÎ_Çt_b™s
);

2787 
	}
}

2789 
	$__æush_Çt_’Œy_£t
(
f2fs_sb_šfo
 *
sbi
,

2790 
Çt_’Œy_£t
 *
£t
, 
ı_cÚŒŞ
 *
ıc
)

2792 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

2793 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

2794 
nid_t
 
¡¬t_nid
 = 
£t
->£ˆ* 
NAT_ENTRY_PER_BLOCK
;

2795 
boŞ
 
to_jouº®
 = 
Œue
;

2796 
f2fs_Çt_block
 *
Çt_blk
;

2797 
Çt_’Œy
 *
Ã
, *
cur
;

2798 
·ge
 *·gğ
NULL
;

2805 ià(
	`’abËd_Çt_b™s
(
sbi
, 
ıc
) ||

2806 !
	`__has_cursum_¥aû
(
jouº®
, 
£t
->
’Œy_út
, 
NAT_JOURNAL
))

2807 
to_jouº®
 = 
çl£
;

2809 ià(
to_jouº®
) {

2810 
	`down_wr™e
(&
cur£g
->
jouº®_rw£m
);

2812 
·ge
 = 
	`g‘_Ãxt_Çt_·ge
(
sbi
, 
¡¬t_nid
);

2813 ià(
	`IS_ERR
(
·ge
))

2814  
	`PTR_ERR
(
·ge
);

2816 
Çt_blk
 = 
	`·ge_add»ss
(
·ge
);

2817 
	`f2fs_bug_Ú
(
sbi
, !
Çt_blk
);

2821 
	`li¡_fÜ_—ch_’Œy_§ã
(
Ã
, 
cur
, &
£t
->
’Œy_li¡
, 
li¡
) {

2822 
f2fs_Çt_’Œy
 *
¿w_Ã
;

2823 
nid_t
 
nid
 = 
	`Çt_g‘_nid
(
Ã
);

2824 
off£t
;

2826 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
Ã
è=ğ
NEW_ADDR
);

2828 ià(
to_jouº®
) {

2829 
off£t
 = 
	`f2fs_lookup_jouº®_š_cursum
(
jouº®
,

2830 
NAT_JOURNAL
, 
nid
, 1);

2831 
	`f2fs_bug_Ú
(
sbi
, 
off£t
 < 0);

2832 
¿w_Ã
 = &
	`Çt_š_jouº®
(
jouº®
, 
off£t
);

2833 
	`nid_š_jouº®
(
jouº®
, 
off£t
èğ
	`ıu_to_Ë32
(
nid
);

2835 
¿w_Ã
 = &
Çt_blk
->
’Œ›s
[
nid
 - 
¡¬t_nid
];

2837 
	`¿w_Çt_äom_node_šfo
(
¿w_Ã
, &
Ã
->
ni
);

2838 
	`Çt_»£t_æag
(
Ã
);

2839 
	`__ş—r_Çt_ÿche_dœty
(
	`NM_I
(
sbi
), 
£t
, 
Ã
);

2840 ià(
	`Çt_g‘_blkaddr
(
Ã
è=ğ
NULL_ADDR
) {

2841 
	`add_ä“_nid
(
sbi
, 
nid
, 
çl£
, 
Œue
);

2843 
	`¥š_lock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

2844 
	`upd©e_ä“_nid_b™m­
(
sbi
, 
nid
, 
çl£
, false);

2845 
	`¥š_uÆock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

2849 ià(
to_jouº®
) {

2850 
	`up_wr™e
(&
cur£g
->
jouº®_rw£m
);

2852 
	`__upd©e_Çt_b™s
(
sbi
, 
¡¬t_nid
, 
·ge
);

2853 
	`f2fs_put_·ge
(
·ge
, 1);

2857 ià(!
£t
->
’Œy_út
) {

2858 
	`¿dix_Œ“_d–‘e
(&
	`NM_I
(
sbi
)->
Çt_£t_roÙ
, 
£t
->set);

2859 
	`kmem_ÿche_ä“
(
Çt_’Œy_£t_¦ab
, 
£t
);

2862 
	}
}

2867 
	$f2fs_æush_Çt_’Œ›s
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

2869 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2870 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

2871 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

2872 
Çt_’Œy_£t
 *
£tvec
[
SETVEC_SIZE
];

2873 
Çt_’Œy_£t
 *
£t
, *
tmp
;

2874 
found
;

2875 
nid_t
 
£t_idx
 = 0;

2876 
	`LIST_HEAD
(
£ts
);

2877 
”r
 = 0;

2880 ià(
	`’abËd_Çt_b™s
(
sbi
, 
ıc
)) {

2881 
	`down_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

2882 
	`»move_Çts_š_jouº®
(
sbi
);

2883 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

2886 ià(!
nm_i
->
dœty_Çt_út
)

2889 
	`down_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

2896 ià(
	`’abËd_Çt_b™s
(
sbi
, 
ıc
) ||

2897 !
	`__has_cursum_¥aû
(
jouº®
, 
nm_i
->
dœty_Çt_út
, 
NAT_JOURNAL
))

2898 
	`»move_Çts_š_jouº®
(
sbi
);

2900 (
found
 = 
	`__gªg_lookup_Çt_£t
(
nm_i
,

2901 
£t_idx
, 
SETVEC_SIZE
, 
£tvec
))) {

2902 
idx
;

2903 
£t_idx
 = 
£tvec
[
found
 - 1]->
£t
 + 1;

2904 
idx
 = 0; idx < 
found
; idx++)

2905 
	`__adju¡_Çt_’Œy_£t
(
£tvec
[
idx
], &
£ts
,

2906 
	`MAX_NAT_JENTRIES
(
jouº®
));

2910 
	`li¡_fÜ_—ch_’Œy_§ã
(
£t
, 
tmp
, &
£ts
, 
£t_li¡
) {

2911 
”r
 = 
	`__æush_Çt_’Œy_£t
(
sbi
, 
£t
, 
ıc
);

2912 ià(
”r
)

2916 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

2919  
”r
;

2920 
	}
}

2922 
	$__g‘_Çt_b™m­s
(
f2fs_sb_šfo
 *
sbi
)

2924 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

2925 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2926 
Çt_b™s_by‹s
 = 
nm_i
->
Çt_blocks
 / 
BITS_PER_BYTE
;

2927 
i
;

2928 
__u64
 
ı_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

2929 
block_t
 
Çt_b™s_addr
;

2931 ià(!
	`’abËd_Çt_b™s
(
sbi
, 
NULL
))

2934 
nm_i
->
Çt_b™s_blocks
 = 
	`F2FS_BLK_ALIGN
((
Çt_b™s_by‹s
 << 1) + 8);

2935 
nm_i
->
Çt_b™s
 = 
	`f2fs_kz®loc
(
sbi
,

2936 
nm_i
->
Çt_b™s_blocks
 << 
F2FS_BLKSIZE_BITS
, 
GFP_KERNEL
);

2937 ià(!
nm_i
->
Çt_b™s
)

2938  -
ENOMEM
;

2940 
Çt_b™s_addr
 = 
	`__¡¬t_ı_addr
(
sbi
è+ sbi->
blocks_³r_£g
 -

2941 
nm_i
->
Çt_b™s_blocks
;

2942 
i
 = 0; i < 
nm_i
->
Çt_b™s_blocks
; i++) {

2943 
·ge
 *page;

2945 
·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
Çt_b™s_addr
++);

2946 ià(
	`IS_ERR
(
·ge
))

2947  
	`PTR_ERR
(
·ge
);

2949 
	`memıy
(
nm_i
->
Çt_b™s
 + (
i
 << 
F2FS_BLKSIZE_BITS
),

2950 
	`·ge_add»ss
(
·ge
), 
F2FS_BLKSIZE
);

2951 
	`f2fs_put_·ge
(
·ge
, 1);

2954 
ı_v”
 |ğ(
	`cur_ı_üc
(
ck±
) << 32);

2955 ià(
	`ıu_to_Ë64
(
ı_v”
è!ğ*(
__Ë64
 *)
nm_i
->
Çt_b™s
) {

2956 
	`di§bË_Çt_b™s
(
sbi
, 
Œue
);

2960 
nm_i
->
fuÎ_Çt_b™s
 =‚m_i->
Çt_b™s
 + 8;

2961 
nm_i
->
em±y_Çt_b™s
 =‚m_i->
fuÎ_Çt_b™s
 + 
Çt_b™s_by‹s
;

2963 
	`f2fs_nÙiû
(
sbi
, "Found‚at_bits in checkpoint");

2965 
	}
}

2967 
šlše
 
	$lßd_ä“_nid_b™m­
(
f2fs_sb_šfo
 *
sbi
)

2969 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2970 
i
 = 0;

2971 
nid_t
 
nid
, 
Ï¡_nid
;

2973 ià(!
	`’abËd_Çt_b™s
(
sbi
, 
NULL
))

2976 
i
 = 0; i < 
nm_i
->
Çt_blocks
; i++) {

2977 
i
 = 
	`fšd_Ãxt_b™_Ë
(
nm_i
->
em±y_Çt_b™s
,‚m_i->
Çt_blocks
, i);

2978 ià(
i
 >ğ
nm_i
->
Çt_blocks
)

2981 
	`__£t_b™_Ë
(
i
, 
nm_i
->
Çt_block_b™m­
);

2983 
nid
 = 
i
 * 
NAT_ENTRY_PER_BLOCK
;

2984 
Ï¡_nid
 = 
nid
 + 
NAT_ENTRY_PER_BLOCK
;

2986 
	`¥š_lock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

2987 ; 
nid
 < 
Ï¡_nid
;‚id++)

2988 
	`upd©e_ä“_nid_b™m­
(
sbi
, 
nid
, 
Œue
,rue);

2989 
	`¥š_uÆock
(&
	`NM_I
(
sbi
)->
nid_li¡_lock
);

2992 
i
 = 0; i < 
nm_i
->
Çt_blocks
; i++) {

2993 
i
 = 
	`fšd_Ãxt_b™_Ë
(
nm_i
->
fuÎ_Çt_b™s
,‚m_i->
Çt_blocks
, i);

2994 ià(
i
 >ğ
nm_i
->
Çt_blocks
)

2997 
	`__£t_b™_Ë
(
i
, 
nm_i
->
Çt_block_b™m­
);

2999 
	}
}

3001 
	$š™_node_mªag”
(
f2fs_sb_šfo
 *
sbi
)

3003 
f2fs_su³r_block
 *
sb_¿w
 = 
	`F2FS_RAW_SUPER
(
sbi
);

3004 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

3005 *
v”siÚ_b™m­
;

3006 
Çt_£gs
;

3007 
”r
;

3009 
nm_i
->
Çt_blkaddr
 = 
	`Ë32_to_ıu
(
sb_¿w
->nat_blkaddr);

3012 
Çt_£gs
 = 
	`Ë32_to_ıu
(
sb_¿w
->
£gm’t_couÁ_Çt
) >> 1;

3013 
nm_i
->
Çt_blocks
 = 
Çt_£gs
 << 
	`Ë32_to_ıu
(
sb_¿w
->
log_blocks_³r_£g
);

3014 
nm_i
->
max_nid
 = 
NAT_ENTRY_PER_BLOCK
 *‚m_i->
Çt_blocks
;

3017 
nm_i
->
avaabË_nids
 =‚m_i->
max_nid
 - 
sbi
->
tÙ®_v®id_node_couÁ
 -

3018 
F2FS_RESERVED_NODE_NUM
;

3019 
nm_i
->
nid_út
[
FREE_NID
] = 0;

3020 
nm_i
->
nid_út
[
PREALLOC_NID
] = 0;

3021 
nm_i
->
Çt_út
 = 0;

3022 
nm_i
->
¿m_th»sh
 = 
DEF_RAM_THRESHOLD
;

3023 
nm_i
->
¿_nid_·ges
 = 
DEF_RA_NID_PAGES
;

3024 
nm_i
->
dœty_Çts_¿tio
 = 
DEF_DIRTY_NAT_RATIO_THRESHOLD
;

3026 
	`INIT_RADIX_TREE
(&
nm_i
->
ä“_nid_roÙ
, 
GFP_ATOMIC
);

3027 
	`INIT_LIST_HEAD
(&
nm_i
->
ä“_nid_li¡
);

3028 
	`INIT_RADIX_TREE
(&
nm_i
->
Çt_roÙ
, 
GFP_NOIO
);

3029 
	`INIT_RADIX_TREE
(&
nm_i
->
Çt_£t_roÙ
, 
GFP_NOIO
);

3030 
	`INIT_LIST_HEAD
(&
nm_i
->
Çt_’Œ›s
);

3031 
	`¥š_lock_š™
(&
nm_i
->
Çt_li¡_lock
);

3033 
	`mu‹x_š™
(&
nm_i
->
bud_lock
);

3034 
	`¥š_lock_š™
(&
nm_i
->
nid_li¡_lock
);

3035 
	`š™_rw£m
(&
nm_i
->
Çt_Œ“_lock
);

3037 
nm_i
->
Ãxt_sÿn_nid
 = 
	`Ë32_to_ıu
(
sbi
->
ck±
->
Ãxt_ä“_nid
);

3038 
nm_i
->
b™m­_size
 = 
	`__b™m­_size
(
sbi
, 
NAT_BITMAP
);

3039 
v”siÚ_b™m­
 = 
	`__b™m­_±r
(
sbi
, 
NAT_BITMAP
);

3040 ià(!
v”siÚ_b™m­
)

3041  -
EFAULT
;

3043 
nm_i
->
Çt_b™m­
 = 
	`kmemdup
(
v”siÚ_b™m­
,‚m_i->
b™m­_size
,

3044 
GFP_KERNEL
);

3045 ià(!
nm_i
->
Çt_b™m­
)

3046  -
ENOMEM
;

3048 
”r
 = 
	`__g‘_Çt_b™m­s
(
sbi
);

3049 ià(
”r
)

3050  
”r
;

3052 #ifdeà
CONFIG_F2FS_CHECK_FS


3053 
nm_i
->
Çt_b™m­_mœ
 = 
	`kmemdup
(
v”siÚ_b™m­
,‚m_i->
b™m­_size
,

3054 
GFP_KERNEL
);

3055 ià(!
nm_i
->
Çt_b™m­_mœ
)

3056  -
ENOMEM
;

3060 
	}
}

3062 
	$š™_ä“_nid_ÿche
(
f2fs_sb_šfo
 *
sbi
)

3064 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

3065 
i
;

3067 
nm_i
->
ä“_nid_b™m­
 =

3068 
	`f2fs_kz®loc
(
sbi
, 
	`¬¿y_size
((*),

3069 
nm_i
->
Çt_blocks
),

3070 
GFP_KERNEL
);

3071 ià(!
nm_i
->
ä“_nid_b™m­
)

3072  -
ENOMEM
;

3074 
i
 = 0; i < 
nm_i
->
Çt_blocks
; i++) {

3075 
nm_i
->
ä“_nid_b™m­
[
i
] = 
	`f2fs_kvz®loc
(
sbi
,

3076 
	`f2fs_b™m­_size
(
NAT_ENTRY_PER_BLOCK
), 
GFP_KERNEL
);

3077 ià(!
nm_i
->
ä“_nid_b™m­
[
i
])

3078  -
ENOMEM
;

3081 
nm_i
->
Çt_block_b™m­
 = 
	`f2fs_kvz®loc
(
sbi
,‚m_i->
Çt_blocks
 / 8,

3082 
GFP_KERNEL
);

3083 ià(!
nm_i
->
Çt_block_b™m­
)

3084  -
ENOMEM
;

3086 
nm_i
->
ä“_nid_couÁ
 =

3087 
	`f2fs_kvz®loc
(
sbi
, 
	`¬¿y_size
((),

3088 
nm_i
->
Çt_blocks
),

3089 
GFP_KERNEL
);

3090 ià(!
nm_i
->
ä“_nid_couÁ
)

3091  -
ENOMEM
;

3093 
	}
}

3095 
	$f2fs_bud_node_mªag”
(
f2fs_sb_šfo
 *
sbi
)

3097 
”r
;

3099 
sbi
->
nm_šfo
 = 
	`f2fs_kz®loc
(sbi, (
f2fs_nm_šfo
),

3100 
GFP_KERNEL
);

3101 ià(!
sbi
->
nm_šfo
)

3102  -
ENOMEM
;

3104 
”r
 = 
	`š™_node_mªag”
(
sbi
);

3105 ià(
”r
)

3106  
”r
;

3108 
”r
 = 
	`š™_ä“_nid_ÿche
(
sbi
);

3109 ià(
”r
)

3110  
”r
;

3113 
	`lßd_ä“_nid_b™m­
(
sbi
);

3115  
	`f2fs_bud_ä“_nids
(
sbi
, 
Œue
,rue);

3116 
	}
}

3118 
	$f2fs_de¡roy_node_mªag”
(
f2fs_sb_šfo
 *
sbi
)

3120 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

3121 
ä“_nid
 *
i
, *
Ãxt_i
;

3122 
Çt_’Œy
 *
Çtvec
[
NATVEC_SIZE
];

3123 
Çt_’Œy_£t
 *
£tvec
[
SETVEC_SIZE
];

3124 
nid_t
 
nid
 = 0;

3125 
found
;

3127 ià(!
nm_i
)

3131 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

3132 
	`li¡_fÜ_—ch_’Œy_§ã
(
i
, 
Ãxt_i
, &
nm_i
->
ä“_nid_li¡
, 
li¡
) {

3133 
	`__»move_ä“_nid
(
sbi
, 
i
, 
FREE_NID
);

3134 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

3135 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

3136 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

3138 
	`f2fs_bug_Ú
(
sbi
, 
nm_i
->
nid_út
[
FREE_NID
]);

3139 
	`f2fs_bug_Ú
(
sbi
, 
nm_i
->
nid_út
[
PREALLOC_NID
]);

3140 
	`f2fs_bug_Ú
(
sbi
, !
	`li¡_em±y
(&
nm_i
->
ä“_nid_li¡
));

3141 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

3144 
	`down_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

3145 (
found
 = 
	`__gªg_lookup_Çt_ÿche
(
nm_i
,

3146 
nid
, 
NATVEC_SIZE
, 
Çtvec
))) {

3147 
idx
;

3149 
nid
 = 
	`Çt_g‘_nid
(
Çtvec
[
found
 - 1]) + 1;

3150 
idx
 = 0; idx < 
found
; idx++) {

3151 
	`¥š_lock
(&
nm_i
->
Çt_li¡_lock
);

3152 
	`li¡_d–
(&
Çtvec
[
idx
]->
li¡
);

3153 
	`¥š_uÆock
(&
nm_i
->
Çt_li¡_lock
);

3155 
	`__d–_äom_Çt_ÿche
(
nm_i
, 
Çtvec
[
idx
]);

3158 
	`f2fs_bug_Ú
(
sbi
, 
nm_i
->
Çt_út
);

3161 
nid
 = 0;

3162 (
found
 = 
	`__gªg_lookup_Çt_£t
(
nm_i
,

3163 
nid
, 
SETVEC_SIZE
, 
£tvec
))) {

3164 
idx
;

3166 
nid
 = 
£tvec
[
found
 - 1]->
£t
 + 1;

3167 
idx
 = 0; idx < 
found
; idx++) {

3169 
	`f2fs_bug_Ú
(
sbi
, !
	`li¡_em±y
(&
£tvec
[
idx
]->
’Œy_li¡
));

3170 
	`¿dix_Œ“_d–‘e
(&
nm_i
->
Çt_£t_roÙ
, 
£tvec
[
idx
]->
£t
);

3171 
	`kmem_ÿche_ä“
(
Çt_’Œy_£t_¦ab
, 
£tvec
[
idx
]);

3174 
	`up_wr™e
(&
nm_i
->
Çt_Œ“_lock
);

3176 
	`kvä“
(
nm_i
->
Çt_block_b™m­
);

3177 ià(
nm_i
->
ä“_nid_b™m­
) {

3178 
i
;

3180 
i
 = 0; i < 
nm_i
->
Çt_blocks
; i++)

3181 
	`kvä“
(
nm_i
->
ä“_nid_b™m­
[
i
]);

3182 
	`kvä“
(
nm_i
->
ä“_nid_b™m­
);

3184 
	`kvä“
(
nm_i
->
ä“_nid_couÁ
);

3186 
	`kvä“
(
nm_i
->
Çt_b™m­
);

3187 
	`kvä“
(
nm_i
->
Çt_b™s
);

3188 #ifdeà
CONFIG_F2FS_CHECK_FS


3189 
	`kvä“
(
nm_i
->
Çt_b™m­_mœ
);

3191 
sbi
->
nm_šfo
 = 
NULL
;

3192 
	`kvä“
(
nm_i
);

3193 
	}
}

3195 
__š™
 
	$f2fs_ü—‹_node_mªag”_ÿches
()

3197 
Çt_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("nat_entry",

3198 (
Çt_’Œy
));

3199 ià(!
Çt_’Œy_¦ab
)

3200 
ç
;

3202 
ä“_nid_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("free_nid",

3203 (
ä“_nid
));

3204 ià(!
ä“_nid_¦ab
)

3205 
de¡roy_Çt_’Œy
;

3207 
Çt_’Œy_£t_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("nat_entry_set",

3208 (
Çt_’Œy_£t
));

3209 ià(!
Çt_’Œy_£t_¦ab
)

3210 
de¡roy_ä“_nid
;

3212 
fsync_node_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("fsync_node_entry",

3213 (
fsync_node_’Œy
));

3214 ià(!
fsync_node_’Œy_¦ab
)

3215 
de¡roy_Çt_’Œy_£t
;

3218 
de¡roy_Çt_’Œy_£t
:

3219 
	`kmem_ÿche_de¡roy
(
Çt_’Œy_£t_¦ab
);

3220 
de¡roy_ä“_nid
:

3221 
	`kmem_ÿche_de¡roy
(
ä“_nid_¦ab
);

3222 
de¡roy_Çt_’Œy
:

3223 
	`kmem_ÿche_de¡roy
(
Çt_’Œy_¦ab
);

3224 
ç
:

3225  -
ENOMEM
;

3226 
	}
}

3228 
	$f2fs_de¡roy_node_mªag”_ÿches
()

3230 
	`kmem_ÿche_de¡roy
(
fsync_node_’Œy_¦ab
);

3231 
	`kmem_ÿche_de¡roy
(
Çt_’Œy_£t_¦ab
);

3232 
	`kmem_ÿche_de¡roy
(
ä“_nid_¦ab
);

3233 
	`kmem_ÿche_de¡roy
(
Çt_’Œy_¦ab
);

3234 
	}
}

	@node.h

9 
	#START_NID
(
nid
è((Òidè/ 
NAT_ENTRY_PER_BLOCK
è* NAT_ENTRY_PER_BLOCK)

	)

12 
	#NAT_BLOCK_OFFSET
(
¡¬t_nid
è((¡¬t_nidè/ 
NAT_ENTRY_PER_BLOCK
)

	)

15 
	#FREE_NID_PAGES
 8

	)

16 
	#MAX_FREE_NIDS
 (
NAT_ENTRY_PER_BLOCK
 * 
FREE_NID_PAGES
)

	)

18 
	#DEF_RA_NID_PAGES
 0

	)

21 
	#MAX_RA_NODE
 128

	)

24 
	#DEF_RAM_THRESHOLD
 1

	)

27 
	#DEF_DIRTY_NAT_RATIO_THRESHOLD
 10

	)

29 
	#DEF_NAT_CACHE_THRESHOLD
 100000

	)

32 
	#NATVEC_SIZE
 64

	)

33 
	#SETVEC_SIZE
 32

	)

36 
	#LOCKED_PAGE
 1

	)

40 
	mIS_CHECKPOINTED
,

41 
	mHAS_FSYNCED_INODE
,

42 
	mHAS_LAST_FSYNC
,

43 
	mIS_DIRTY
,

44 
	mIS_PREALLOC
,

50 
	snode_šfo
 {

51 
nid_t
 
	mnid
;

52 
nid_t
 
	mšo
;

53 
block_t
 
	mblk_addr
;

54 
	mv”siÚ
;

55 
	mæag
;

58 
	sÇt_’Œy
 {

59 
li¡_h—d
 
	mli¡
;

60 
node_šfo
 
	mni
;

63 
	#Çt_g‘_nid
(
Çt
è(Ò©)->
ni
.
nid
)

	)

64 
	#Çt_£t_nid
(
Çt
, 
n
è(Ò©)->
ni
.
nid
 = (n))

	)

65 
	#Çt_g‘_blkaddr
(
Çt
è(Ò©)->
ni
.
blk_addr
)

	)

66 
	#Çt_£t_blkaddr
(
Çt
, 
b
è(Ò©)->
ni
.
blk_addr
 = (b))

	)

67 
	#Çt_g‘_šo
(
Çt
è(Ò©)->
ni
.
šo
)

	)

68 
	#Çt_£t_šo
(
Çt
, 
i
è(Ò©)->
ni
.
šo
 = (i))

	)

69 
	#Çt_g‘_v”siÚ
(
Çt
è(Ò©)->
ni
.
v”siÚ
)

	)

70 
	#Çt_£t_v”siÚ
(
Çt
, 
v
è(Ò©)->
ni
.
v”siÚ
 = (v))

	)

72 
	#šc_node_v”siÚ
(
v”siÚ
è(++(v”siÚ))

	)

74 
šlše
 
	$cİy_node_šfo
(
node_šfo
 *
d¡
,

75 
node_šfo
 *
¤c
)

77 
d¡
->
nid
 = 
¤c
->nid;

78 
d¡
->
šo
 = 
¤c
->ino;

79 
d¡
->
blk_addr
 = 
¤c
->blk_addr;

80 
d¡
->
v”siÚ
 = 
¤c
->version;

82 
	}
}

84 
šlše
 
	$£t_Çt_æag
(
Çt_’Œy
 *
Ã
,

85 
ty³
, 
boŞ
 
£t
)

87 
mask
 = 0x01 << 
ty³
;

88 ià(
£t
)

89 
Ã
->
ni
.
æag
 |ğ
mask
;

91 
Ã
->
ni
.
æag
 &ğ~
mask
;

92 
	}
}

94 
šlše
 
boŞ
 
	$g‘_Çt_æag
(
Çt_’Œy
 *
Ã
, 
ty³
)

96 
mask
 = 0x01 << 
ty³
;

97  
Ã
->
ni
.
æag
 & 
mask
;

98 
	}
}

100 
šlše
 
	$Çt_»£t_æag
(
Çt_’Œy
 *
Ã
)

103 
	`£t_Çt_æag
(
Ã
, 
IS_CHECKPOINTED
, 
Œue
);

104 
	`£t_Çt_æag
(
Ã
, 
HAS_FSYNCED_INODE
, 
çl£
);

105 
	`£t_Çt_æag
(
Ã
, 
HAS_LAST_FSYNC
, 
Œue
);

106 
	}
}

108 
šlše
 
	$node_šfo_äom_¿w_Çt
(
node_šfo
 *
ni
,

109 
f2fs_Çt_’Œy
 *
¿w_Ã
)

111 
ni
->
šo
 = 
	`Ë32_to_ıu
(
¿w_Ã
->ino);

112 
ni
->
blk_addr
 = 
	`Ë32_to_ıu
(
¿w_Ã
->
block_addr
);

113 
ni
->
v”siÚ
 = 
¿w_Ã
->version;

114 
	}
}

116 
šlše
 
	$¿w_Çt_äom_node_šfo
(
f2fs_Çt_’Œy
 *
¿w_Ã
,

117 
node_šfo
 *
ni
)

119 
¿w_Ã
->
šo
 = 
	`ıu_to_Ë32
(
ni
->ino);

120 
¿w_Ã
->
block_addr
 = 
	`ıu_to_Ë32
(
ni
->
blk_addr
);

121 
¿w_Ã
->
v”siÚ
 = 
ni
->version;

122 
	}
}

124 
šlše
 
boŞ
 
	$exûss_dœty_Çts
(
f2fs_sb_šfo
 *
sbi
)

126  
	`NM_I
(
sbi
)->
dœty_Çt_út
 >ğNM_I(sbi)->
max_nid
 *

127 
	`NM_I
(
sbi
)->
dœty_Çts_¿tio
 / 100;

128 
	}
}

130 
šlše
 
boŞ
 
	$exûss_ÿched_Çts
(
f2fs_sb_šfo
 *
sbi
)

132  
	`NM_I
(
sbi
)->
Çt_út
 >ğ
DEF_NAT_CACHE_THRESHOLD
;

133 
	}
}

135 
šlše
 
boŞ
 
	$exûss_dœty_nodes
(
f2fs_sb_šfo
 *
sbi
)

137  
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
è>ğsbi->
blocks_³r_£g
 * 8;

138 
	}
}

140 
	emem_ty³
 {

141 
	mFREE_NIDS
,

142 
	mNAT_ENTRIES
,

143 
	mDIRTY_DENTS
,

144 
	mINO_ENTRIES
,

145 
	mEXTENT_CACHE
,

146 
	mINMEM_PAGES
,

147 
	mBASE_CHECK
,

150 
	sÇt_’Œy_£t
 {

151 
li¡_h—d
 
	m£t_li¡
;

152 
li¡_h—d
 
	m’Œy_li¡
;

153 
nid_t
 
	m£t
;

154 
	m’Œy_út
;

157 
	sä“_nid
 {

158 
li¡_h—d
 
	mli¡
;

159 
nid_t
 
	mnid
;

160 
	m¡©e
;

163 
šlše
 
	$Ãxt_ä“_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 *
nid
)

165 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

166 
ä“_nid
 *
âid
;

168 
	`¥š_lock
(&
nm_i
->
nid_li¡_lock
);

169 ià(
nm_i
->
nid_út
[
FREE_NID
] <= 0) {

170 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

173 
âid
 = 
	`li¡_fœ¡_’Œy
(&
nm_i
->
ä“_nid_li¡
, 
ä“_nid
, 
li¡
);

174 *
nid
 = 
âid
->nid;

175 
	`¥š_uÆock
(&
nm_i
->
nid_li¡_lock
);

176 
	}
}

181 
šlše
 
	$g‘_Çt_b™m­
(
f2fs_sb_šfo
 *
sbi
, *
addr
)

183 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

185 #ifdeà
CONFIG_F2FS_CHECK_FS


186 ià(
	`memcmp
(
nm_i
->
Çt_b™m­
,‚m_i->
Çt_b™m­_mœ
,

187 
nm_i
->
b™m­_size
))

188 
	`f2fs_bug_Ú
(
sbi
, 1);

190 
	`memıy
(
addr
, 
nm_i
->
Çt_b™m­
,‚m_i->
b™m­_size
);

191 
	}
}

193 
šlše
 
pgoff_t
 
	$cu¼’t_Çt_addr
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
¡¬t
)

195 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

196 
pgoff_t
 
block_off
;

197 
pgoff_t
 
block_addr
;

204 
block_off
 = 
	`NAT_BLOCK_OFFSET
(
¡¬t
);

206 
block_addr
 = (
pgoff_t
)(
nm_i
->
Çt_blkaddr
 +

207 (
block_off
 << 1) -

208 (
block_off
 & (
sbi
->
blocks_³r_£g
 - 1)));

210 ià(
	`f2fs_‹¡_b™
(
block_off
, 
nm_i
->
Çt_b™m­
))

211 
block_addr
 +ğ
sbi
->
blocks_³r_£g
;

213  
block_addr
;

214 
	}
}

216 
šlše
 
pgoff_t
 
	$Ãxt_Çt_addr
(
f2fs_sb_šfo
 *
sbi
,

217 
pgoff_t
 
block_addr
)

219 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

221 
block_addr
 -ğ
nm_i
->
Çt_blkaddr
;

222 
block_addr
 ^ğ1 << 
sbi
->
log_blocks_³r_£g
;

223  
block_addr
 + 
nm_i
->
Çt_blkaddr
;

224 
	}
}

226 
šlše
 
	$£t_to_Ãxt_Çt
(
f2fs_nm_šfo
 *
nm_i
, 
nid_t
 
¡¬t_nid
)

228 
block_off
 = 
	`NAT_BLOCK_OFFSET
(
¡¬t_nid
);

230 
	`f2fs_chªge_b™
(
block_off
, 
nm_i
->
Çt_b™m­
);

231 #ifdeà
CONFIG_F2FS_CHECK_FS


232 
	`f2fs_chªge_b™
(
block_off
, 
nm_i
->
Çt_b™m­_mœ
);

234 
	}
}

236 
šlše
 
nid_t
 
	$šo_of_node
(
·ge
 *
node_·ge
)

238 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

239  
	`Ë32_to_ıu
(
º
->
foÙ”
.
šo
);

240 
	}
}

242 
šlše
 
nid_t
 
	$nid_of_node
(
·ge
 *
node_·ge
)

244 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

245  
	`Ë32_to_ıu
(
º
->
foÙ”
.
nid
);

246 
	}
}

248 
šlše
 
	$ofs_of_node
(
·ge
 *
node_·ge
)

250 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

251 
æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.flag);

252  
æag
 >> 
OFFSET_BIT_SHIFT
;

253 
	}
}

255 
šlše
 
__u64
 
	$ıv”_of_node
(
·ge
 *
node_·ge
)

257 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

258  
	`Ë64_to_ıu
(
º
->
foÙ”
.
ı_v”
);

259 
	}
}

261 
šlše
 
block_t
 
	$Ãxt_blkaddr_of_node
(
·ge
 *
node_·ge
)

263 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

264  
	`Ë32_to_ıu
(
º
->
foÙ”
.
Ãxt_blkaddr
);

265 
	}
}

267 
šlše
 
	$fl_node_foÙ”
(
·ge
 *·ge, 
nid_t
 
nid
,

268 
nid_t
 
šo
, 
ofs
, 
boŞ
 
»£t
)

270 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

271 
Şd_æag
 = 0;

273 ià(
»£t
)

274 
	`mem£t
(
º
, 0, (*rn));

276 
Şd_æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.
æag
);

278 
º
->
foÙ”
.
nid
 = 
	`ıu_to_Ë32
(nid);

279 
º
->
foÙ”
.
šo
 = 
	`ıu_to_Ë32
(ino);

282 
º
->
foÙ”
.
æag
 = 
	`ıu_to_Ë32
((
ofs
 << 
OFFSET_BIT_SHIFT
) |

283 (
Şd_æag
 & 
OFFSET_BIT_MASK
));

284 
	}
}

286 
šlše
 
	$cİy_node_foÙ”
(
·ge
 *
d¡
, ·g*
¤c
)

288 
f2fs_node
 *
¤c_º
 = 
	`F2FS_NODE
(
¤c
);

289 
f2fs_node
 *
d¡_º
 = 
	`F2FS_NODE
(
d¡
);

290 
	`memıy
(&
d¡_º
->
foÙ”
, &
¤c_º
->foÙ”, (
node_foÙ”
));

291 
	}
}

293 
šlše
 
	$fl_node_foÙ”_blkaddr
(
·ge
 *·ge, 
block_t
 
blkaddr
)

295 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
	`F2FS_P_SB
(
·ge
));

296 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

297 
__u64
 
ı_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

299 ià(
	`__is_£t_ck±_æags
(
ck±
, 
CP_CRC_RECOVERY_FLAG
))

300 
ı_v”
 |ğ(
	`cur_ı_üc
(
ck±
) << 32);

302 
º
->
foÙ”
.
ı_v”
 = 
	`ıu_to_Ë64
(cp_ver);

303 
º
->
foÙ”
.
Ãxt_blkaddr
 = 
	`ıu_to_Ë32
(
blkaddr
);

304 
	}
}

306 
šlše
 
boŞ
 
	$is_»cov”abË_dnode
(
·ge
 *page)

308 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
	`F2FS_P_SB
(
·ge
));

309 
__u64
 
ı_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

312 ià(
	`__is_£t_ck±_æags
(
ck±
, 
CP_NOCRC_RECOVERY_FLAG
))

313  (
ı_v”
 << 32è=ğ(
	`ıv”_of_node
(
·ge
) << 32);

315 ià(
	`__is_£t_ck±_æags
(
ck±
, 
CP_CRC_RECOVERY_FLAG
))

316 
ı_v”
 |ğ(
	`cur_ı_üc
(
ck±
) << 32);

318  
ı_v”
 =ğ
	`ıv”_of_node
(
·ge
);

319 
	}
}

342 
šlše
 
boŞ
 
	$IS_DNODE
(
·ge
 *
node_·ge
)

344 
ofs
 = 
	`ofs_of_node
(
node_·ge
);

346 ià(
	`f2fs_has_x©Œ_block
(
ofs
))

347  
Œue
;

349 ià(
ofs
 =ğ3 || of =ğ4 + 
NIDS_PER_BLOCK
 ||

350 
ofs
 =ğ5 + 2 * 
NIDS_PER_BLOCK
)

351  
çl£
;

352 ià(
ofs
 >ğ6 + 2 * 
NIDS_PER_BLOCK
) {

353 
ofs
 -ğ6 + 2 * 
NIDS_PER_BLOCK
;

354 ià(!(()
ofs
 % (
NIDS_PER_BLOCK
 + 1)))

355  
çl£
;

357  
Œue
;

358 
	}
}

360 
šlše
 
	$£t_nid
(
·ge
 *
p
, 
off
, 
nid_t
 
nid
, 
boŞ
 
i
)

362 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
p
);

364 
	`f2fs_wa™_Ú_·ge_wr™eback
(
p
, 
NODE
, 
Œue
,rue);

366 ià(
i
)

367 
º
->
i
.
i_nid
[
off
 - 
NODE_DIR1_BLOCK
] = 
	`ıu_to_Ë32
(
nid
);

369 
º
->
š
.
nid
[
off
] = 
	`ıu_to_Ë32
(nid);

370  
	`£t_·ge_dœty
(
p
);

371 
	}
}

373 
šlše
 
nid_t
 
	$g‘_nid
(
·ge
 *
p
, 
off
, 
boŞ
 
i
)

375 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
p
);

377 ià(
i
)

378  
	`Ë32_to_ıu
(
º
->
i
.
i_nid
[
off
 - 
NODE_DIR1_BLOCK
]);

379  
	`Ë32_to_ıu
(
º
->
š
.
nid
[
off
]);

380 
	}
}

388 
šlše
 
	$is_cŞd_d©a
(
·ge
 *page)

390  
	`PageChecked
(
·ge
);

391 
	}
}

393 
šlše
 
	$£t_cŞd_d©a
(
·ge
 *page)

395 
	`S‘PageChecked
(
·ge
);

396 
	}
}

398 
šlše
 
	$ş—r_cŞd_d©a
(
·ge
 *page)

400 
	`CË¬PageChecked
(
·ge
);

401 
	}
}

403 
šlše
 
	$is_node
(
·ge
 *·ge, 
ty³
)

405 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

406  
	`Ë32_to_ıu
(
º
->
foÙ”
.
æag
è& (1 << 
ty³
);

407 
	}
}

409 
	#is_cŞd_node
(
·ge
è
	`is_node
Õage, 
COLD_BIT_SHIFT
)

	)

410 
	#is_fsync_dnode
(
·ge
è
	`is_node
Õage, 
FSYNC_BIT_SHIFT
)

	)

411 
	#is_d’t_dnode
(
·ge
è
	`is_node
Õage, 
DENT_BIT_SHIFT
)

	)

413 
šlše
 
	$is_šlše_node
(
·ge
 *page)

415  
	`PageChecked
(
·ge
);

416 
	}
}

418 
šlše
 
	$£t_šlše_node
(
·ge
 *page)

420 
	`S‘PageChecked
(
·ge
);

421 
	}
}

423 
šlše
 
	$ş—r_šlše_node
(
·ge
 *page)

425 
	`CË¬PageChecked
(
·ge
);

426 
	}
}

428 
šlše
 
	$£t_cŞd_node
(
·ge
 *·ge, 
boŞ
 
is_dœ
)

430 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

431 
æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.flag);

433 ià(
is_dœ
)

434 
æag
 &ğ~(0x1 << 
COLD_BIT_SHIFT
);

436 
æag
 |ğ(0x1 << 
COLD_BIT_SHIFT
);

437 
º
->
foÙ”
.
æag
 = 
	`ıu_to_Ë32
(flag);

438 
	}
}

440 
šlše
 
	$£t_m¬k
(
·ge
 *·ge, 
m¬k
, 
ty³
)

442 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

443 
æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.flag);

444 ià(
m¬k
)

445 
æag
 |ğ(0x1 << 
ty³
);

447 
æag
 &ğ~(0x1 << 
ty³
);

448 
º
->
foÙ”
.
æag
 = 
	`ıu_to_Ë32
(flag);

450 #ifdeà
CONFIG_F2FS_CHECK_FS


451 
	`f2fs_šode_chksum_£t
(
	`F2FS_P_SB
(
·ge
),…age);

453 
	}
}

454 
	#£t_d’Œy_m¬k
(
·ge
, 
m¬k
è
	`£t_m¬k
Õage, m¬k, 
DENT_BIT_SHIFT
)

	)

455 
	#£t_fsync_m¬k
(
·ge
, 
m¬k
è
	`£t_m¬k
Õage, m¬k, 
FSYNC_BIT_SHIFT
)

	)

	@recovery.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/f2fs_fs.h
>

10 
	~"f2fs.h
"

11 
	~"node.h
"

12 
	~"£gm’t.h
"

45 
kmem_ÿche
 *
	gfsync_’Œy_¦ab
;

47 
boŞ
 
	$f2fs_¥aû_fÜ_rŞl_fÜw¬d
(
f2fs_sb_šfo
 *
sbi
)

49 
s64
 
ÇÎoc
 = 
	`³rıu_couÁ”_sum_pos™ive
(&
sbi
->
®loc_v®id_block_couÁ
);

51 ià(
sbi
->
Ï¡_v®id_block_couÁ
 + 
ÇÎoc
 > sbi->
u£r_block_couÁ
)

52  
çl£
;

53  
Œue
;

54 
	}
}

56 
fsync_šode_’Œy
 *
	$g‘_fsync_šode
(
li¡_h—d
 *
h—d
,

57 
nid_t
 
šo
)

59 
fsync_šode_’Œy
 *
’Œy
;

61 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, 
h—d
, 
li¡
)

62 ià(
’Œy
->
šode
->
i_šo
 =ğ
šo
)

63  
’Œy
;

65  
NULL
;

66 
	}
}

68 
fsync_šode_’Œy
 *
	$add_fsync_šode
(
f2fs_sb_šfo
 *
sbi
,

69 
li¡_h—d
 *
h—d
, 
nid_t
 
šo
, 
boŞ
 
quÙa_šode
)

71 
šode
 *inode;

72 
fsync_šode_’Œy
 *
’Œy
;

73 
”r
;

75 
šode
 = 
	`f2fs_ig‘_»Œy
(
sbi
->
sb
, 
šo
);

76 ià(
	`IS_ERR
(
šode
))

77  
	`ERR_CAST
(
šode
);

79 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

80 ià(
”r
)

81 
”r_out
;

83 ià(
quÙa_šode
) {

84 
”r
 = 
	`dquÙ_®loc_šode
(
šode
);

85 ià(
”r
)

86 
”r_out
;

89 
’Œy
 = 
	`f2fs_kmem_ÿche_®loc
(
fsync_’Œy_¦ab
, 
GFP_F2FS_ZERO
);

90 
’Œy
->
šode
 = inode;

91 
	`li¡_add_
(&
’Œy
->
li¡
, 
h—d
);

93  
’Œy
;

94 
”r_out
:

95 
	`ut
(
šode
);

96  
	`ERR_PTR
(
”r
);

97 
	}
}

99 
	$d–_fsync_šode
(
fsync_šode_’Œy
 *
’Œy
, 
drİ
)

101 ià(
drİ
) {

103 
	`f2fs_šode_synûd
(
’Œy
->
šode
);

105 
	`ut
(
’Œy
->
šode
);

106 
	`li¡_d–
(&
’Œy
->
li¡
);

107 
	`kmem_ÿche_ä“
(
fsync_’Œy_¦ab
, 
’Œy
);

108 
	}
}

110 
	$»cov”_d’Œy
(
šode
 *šode, 
·ge
 *
age
,

111 
li¡_h—d
 *
dœ_li¡
)

113 
f2fs_šode
 *
¿w_šode
 = 
	`F2FS_INODE
(
age
);

114 
nid_t
 
pšo
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_pšo
);

115 
f2fs_dœ_’Œy
 *
de
;

116 
fsüy±_Çme
 
âame
;

117 
·ge
 *page;

118 
šode
 *
dœ
, *
ešode
;

119 
fsync_šode_’Œy
 *
’Œy
;

120 
”r
 = 0;

121 *
Çme
;

123 
’Œy
 = 
	`g‘_fsync_šode
(
dœ_li¡
, 
pšo
);

124 ià(!
’Œy
) {

125 
’Œy
 = 
	`add_fsync_šode
(
	`F2FS_I_SB
(
šode
), 
dœ_li¡
,

126 
pšo
, 
çl£
);

127 ià(
	`IS_ERR
(
’Œy
)) {

128 
dœ
 = 
	`ERR_CAST
(
’Œy
);

129 
”r
 = 
	`PTR_ERR
(
’Œy
);

130 
out
;

134 
dœ
 = 
’Œy
->
šode
;

136 
	`mem£t
(&
âame
, 0, (
fsüy±_Çme
));

137 
âame
.
disk_Çme
.
Ën
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_Çm–’
);

138 
âame
.
disk_Çme
.
Çme
 = 
¿w_šode
->
i_Çme
;

140 ià(
	`uÆik–y
(
âame
.
disk_Çme
.
Ën
 > 
F2FS_NAME_LEN
)) {

141 
	`WARN_ON
(1);

142 
”r
 = -
ENAMETOOLONG
;

143 
out
;

145 
»Œy
:

146 
de
 = 
	`__f2fs_fšd_’Œy
(
dœ
, &
âame
, &
·ge
);

147 ià(
de
 && 
šode
->
i_šo
 =ğ
	`Ë32_to_ıu
(de->
šo
))

148 
out_put
;

150 ià(
de
) {

151 
ešode
 = 
	`f2fs_ig‘_»Œy
(
šode
->
i_sb
, 
	`Ë32_to_ıu
(
de
->
šo
));

152 ià(
	`IS_ERR
(
ešode
)) {

153 
	`WARN_ON
(1);

154 
”r
 = 
	`PTR_ERR
(
ešode
);

155 ià(
”r
 =ğ-
ENOENT
)

156 
”r
 = -
EEXIST
;

157 
out_put
;

160 
”r
 = 
	`dquÙ_š™Ÿlize
(
ešode
);

161 ià(
”r
) {

162 
	`ut
(
ešode
);

163 
out_put
;

166 
”r
 = 
	`f2fs_acquœe_Üphª_šode
(
	`F2FS_I_SB
(
šode
));

167 ià(
”r
) {

168 
	`ut
(
ešode
);

169 
out_put
;

171 
	`f2fs_d–‘e_’Œy
(
de
, 
·ge
, 
dœ
, 
ešode
);

172 
	`ut
(
ešode
);

173 
»Œy
;

174 } ià(
	`IS_ERR
(
·ge
)) {

175 
”r
 = 
	`PTR_ERR
(
·ge
);

177 
”r
 = 
	`f2fs_add_d’Œy
(
dœ
, &
âame
, 
šode
,

178 
šode
->
i_šo
, inode->
i_mode
);

180 ià(
”r
 =ğ-
ENOMEM
)

181 
»Œy
;

182 
out
;

184 
out_put
:

185 
	`f2fs_put_·ge
(
·ge
, 0);

186 
out
:

187 ià(
	`fe_’c_Çme
(
šode
))

188 
Çme
 = "<encrypted>";

190 
Çme
 = 
¿w_šode
->
i_Çme
;

191 
	`f2fs_nÙiû
(
	`F2FS_I_SB
(
šode
), "%s: ino = %x,‚ame = %s, dir = %lx,ƒrr = %d",

192 
__func__
, 
	`šo_of_node
(
age
), 
Çme
,

193 
	`IS_ERR
(
dœ
è? 0 : dœ->
i_šo
, 
”r
);

194  
”r
;

195 
	}
}

197 
	$»cov”_quÙa_d©a
(
šode
 *šode, 
·ge
 *page)

199 
f2fs_šode
 *
¿w
 = 
	`F2FS_INODE
(
·ge
);

200 
Ÿ‰r
 
©Œ
;

201 
uid_t
 
i_uid
 = 
	`Ë32_to_ıu
(
¿w
->i_uid);

202 
gid_t
 
i_gid
 = 
	`Ë32_to_ıu
(
¿w
->i_gid);

203 
”r
;

205 
	`mem£t
(&
©Œ
, 0, (attr));

207 
©Œ
.
Ÿ_uid
 = 
	`make_kuid
(
šode
->
i_sb
->
s_u£r_ns
, 
i_uid
);

208 
©Œ
.
Ÿ_gid
 = 
	`make_kgid
(
šode
->
i_sb
->
s_u£r_ns
, 
i_gid
);

210 ià(!
	`uid_eq
(
©Œ
.
Ÿ_uid
, 
šode
->
i_uid
))

211 
©Œ
.
Ÿ_v®id
 |ğ
ATTR_UID
;

212 ià(!
	`gid_eq
(
©Œ
.
Ÿ_gid
, 
šode
->
i_gid
))

213 
©Œ
.
Ÿ_v®id
 |ğ
ATTR_GID
;

215 ià(!
©Œ
.
Ÿ_v®id
)

218 
”r
 = 
	`dquÙ_Œªsãr
(
šode
, &
©Œ
);

219 ià(
”r
)

220 
	`£t_sbi_æag
(
	`F2FS_I_SB
(
šode
), 
SBI_QUOTA_NEED_REPAIR
);

221  
”r
;

222 
	}
}

224 
	$»cov”_šlše_æags
(
šode
 *šode, 
f2fs_šode
 *
ri
)

226 ià(
ri
->
i_šlše
 & 
F2FS_PIN_FILE
)

227 
	`£t_šode_æag
(
šode
, 
FI_PIN_FILE
);

229 
	`ş—r_šode_æag
(
šode
, 
FI_PIN_FILE
);

230 ià(
ri
->
i_šlše
 & 
F2FS_DATA_EXIST
)

231 
	`£t_šode_æag
(
šode
, 
FI_DATA_EXIST
);

233 
	`ş—r_šode_æag
(
šode
, 
FI_DATA_EXIST
);

234 
	}
}

236 
	$»cov”_šode
(
šode
 *šode, 
·ge
 *page)

238 
f2fs_šode
 *
¿w
 = 
	`F2FS_INODE
(
·ge
);

239 *
Çme
;

240 
”r
;

242 
šode
->
i_mode
 = 
	`Ë16_to_ıu
(
¿w
->i_mode);

244 
”r
 = 
	`»cov”_quÙa_d©a
(
šode
, 
·ge
);

245 ià(
”r
)

246  
”r
;

248 
	`i_uid_wr™e
(
šode
, 
	`Ë32_to_ıu
(
¿w
->
i_uid
));

249 
	`i_gid_wr™e
(
šode
, 
	`Ë32_to_ıu
(
¿w
->
i_gid
));

251 ià(
¿w
->
i_šlše
 & 
F2FS_EXTRA_ATTR
) {

252 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
	`F2FS_I_SB
(
šode
)) &&

253 
	`F2FS_FITS_IN_INODE
(
¿w
, 
	`Ë16_to_ıu
Ôaw->
i_exŒa_isize
),

254 
i_´ojid
)) {

255 
´ojid_t
 
i_´ojid
;

256 
k´ojid_t
 
k´ojid
;

258 
i_´ojid
 = (
´ojid_t
)
	`Ë32_to_ıu
(
¿w
->i_projid);

259 
k´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, 
i_´ojid
);

261 ià(!
	`´ojid_eq
(
k´ojid
, 
	`F2FS_I
(
šode
)->
i_´ojid
)) {

262 
”r
 = 
	`f2fs_Œªsãr_´ojeù_quÙa
(
šode
,

263 
k´ojid
);

264 ià(
”r
)

265  
”r
;

266 
	`F2FS_I
(
šode
)->
i_´ojid
 = 
k´ojid
;

271 
	`f2fs_i_size_wr™e
(
šode
, 
	`Ë64_to_ıu
(
¿w
->
i_size
));

272 
šode
->
i_©ime
.
tv_£c
 = 
	`Ë64_to_ıu
(
¿w
->i_atime);

273 
šode
->
i_ùime
.
tv_£c
 = 
	`Ë64_to_ıu
(
¿w
->i_ctime);

274 
šode
->
i_mtime
.
tv_£c
 = 
	`Ë64_to_ıu
(
¿w
->i_mtime);

275 
šode
->
i_©ime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
¿w
->
i_©ime_n£c
);

276 
šode
->
i_ùime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
¿w
->
i_ùime_n£c
);

277 
šode
->
i_mtime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
¿w
->
i_mtime_n£c
);

279 
	`F2FS_I
(
šode
)->
i_advi£
 = 
¿w
->i_advise;

280 
	`F2FS_I
(
šode
)->
i_æags
 = 
	`Ë32_to_ıu
(
¿w
->i_flags);

281 
	`f2fs_£t_šode_æags
(
šode
);

282 
	`F2FS_I
(
šode
)->
i_gc_çu»s
[
GC_FAILURE_PIN
] =

283 
	`Ë16_to_ıu
(
¿w
->
i_gc_çu»s
);

285 
	`»cov”_šlše_æags
(
šode
, 
¿w
);

287 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

289 ià(
	`fe_’c_Çme
(
šode
))

290 
Çme
 = "<encrypted>";

292 
Çme
 = 
	`F2FS_INODE
(
·ge
)->
i_Çme
;

294 
	`f2fs_nÙiû
(
	`F2FS_I_SB
(
šode
), "recover_inode: ino = %x,‚ame = %s, inline = %x",

295 
	`šo_of_node
(
·ge
), 
Çme
, 
¿w
->
i_šlše
);

297 
	}
}

299 
	$fšd_fsync_dnodes
(
f2fs_sb_šfo
 *
sbi
, 
li¡_h—d
 *
h—d
,

300 
boŞ
 
check_Úly
)

302 
cur£g_šfo
 *
cur£g
;

303 
·ge
 *·gğ
NULL
;

304 
block_t
 
blkaddr
;

305 
loİ_út
 = 0;

306 
ä“_blocks
 = 
	`MAIN_SEGS
(
sbi
è* sbi->
blocks_³r_£g
 -

307 
	`v®id_u£r_blocks
(
sbi
);

308 
”r
 = 0;

311 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
);

312 
blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

315 
fsync_šode_’Œy
 *
’Œy
;

317 ià(!
	`f2fs_is_v®id_blkaddr
(
sbi
, 
blkaddr
, 
META_POR
))

320 
·ge
 = 
	`f2fs_g‘_tmp_·ge
(
sbi
, 
blkaddr
);

321 ià(
	`IS_ERR
(
·ge
)) {

322 
”r
 = 
	`PTR_ERR
(
·ge
);

326 ià(!
	`is_»cov”abË_dnode
(
·ge
)) {

327 
	`f2fs_put_·ge
(
·ge
, 1);

331 ià(!
	`is_fsync_dnode
(
·ge
))

332 
Ãxt
;

334 
’Œy
 = 
	`g‘_fsync_šode
(
h—d
, 
	`šo_of_node
(
·ge
));

335 ià(!
’Œy
) {

336 
boŞ
 
quÙa_šode
 = 
çl£
;

338 ià(!
check_Úly
 &&

339 
	`IS_INODE
(
·ge
è&& 
	`is_d’t_dnode
(page)) {

340 
”r
 = 
	`f2fs_»cov”_šode_·ge
(
sbi
, 
·ge
);

341 ià(
”r
) {

342 
	`f2fs_put_·ge
(
·ge
, 1);

345 
quÙa_šode
 = 
Œue
;

352 
’Œy
 = 
	`add_fsync_šode
(
sbi
, 
h—d
, 
	`šo_of_node
(
·ge
),

353 
quÙa_šode
);

354 ià(
	`IS_ERR
(
’Œy
)) {

355 
”r
 = 
	`PTR_ERR
(
’Œy
);

356 ià(
”r
 =ğ-
ENOENT
) {

357 
”r
 = 0;

358 
Ãxt
;

360 
	`f2fs_put_·ge
(
·ge
, 1);

364 
’Œy
->
blkaddr
 = blkaddr;

366 ià(
	`IS_INODE
(
·ge
è&& 
	`is_d’t_dnode
(page))

367 
’Œy
->
Ï¡_d’Œy
 = 
blkaddr
;

368 
Ãxt
:

370 ià(++
loİ_út
 >ğ
ä“_blocks
 ||

371 
blkaddr
 =ğ
	`Ãxt_blkaddr_of_node
(
·ge
)) {

372 
	`f2fs_nÙiû
(
sbi
, "%s: detect†ooped‚ode chain, blkaddr:%u,‚ext:%u",

373 
__func__
, 
blkaddr
,

374 
	`Ãxt_blkaddr_of_node
(
·ge
));

375 
	`f2fs_put_·ge
(
·ge
, 1);

376 
”r
 = -
EINVAL
;

381 
blkaddr
 = 
	`Ãxt_blkaddr_of_node
(
·ge
);

382 
	`f2fs_put_·ge
(
·ge
, 1);

384 
	`f2fs_¿_m‘a_·ges_cÚd
(
sbi
, 
blkaddr
);

386  
”r
;

387 
	}
}

389 
	$de¡roy_fsync_dnodes
(
li¡_h—d
 *
h—d
, 
drİ
)

391 
fsync_šode_’Œy
 *
’Œy
, *
tmp
;

393 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, 
h—d
, 
li¡
)

394 
	`d–_fsync_šode
(
’Œy
, 
drİ
);

395 
	}
}

397 
	$check_šdex_š_´ev_nodes
(
f2fs_sb_šfo
 *
sbi
,

398 
block_t
 
blkaddr
, 
dnode_of_d©a
 *
dn
)

400 
£g_’Œy
 *
£Áry
;

401 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blkaddr
);

402 
blkoff
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blkaddr
);

403 
f2fs_summ¬y_block
 *
sum_node
;

404 
f2fs_summ¬y
 
sum
;

405 
·ge
 *
sum_·ge
, *
node_·ge
;

406 
dnode_of_d©a
 
tdn
 = *
dn
;

407 
nid_t
 
šo
, 
nid
;

408 
šode
 *inode;

409 
off£t
;

410 
block_t
 
bidx
;

411 
i
;

413 
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

414 ià(!
	`f2fs_‹¡_b™
(
blkoff
, 
£Áry
->
cur_v®id_m­
))

418 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

419 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

420 ià(
cur£g
->
£gno
 == segno) {

421 
sum
 = 
cur£g
->
sum_blk
->
’Œ›s
[
blkoff
];

422 
gÙ_™
;

426 
sum_·ge
 = 
	`f2fs_g‘_sum_·ge
(
sbi
, 
£gno
);

427 ià(
	`IS_ERR
(
sum_·ge
))

428  
	`PTR_ERR
(
sum_·ge
);

429 
sum_node
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
sum_·ge
);

430 
sum
 = 
sum_node
->
’Œ›s
[
blkoff
];

431 
	`f2fs_put_·ge
(
sum_·ge
, 1);

432 
gÙ_™
:

434 
nid
 = 
	`Ë32_to_ıu
(
sum
.nid);

435 ià(
dn
->
šode
->
i_šo
 =ğ
nid
) {

436 
tdn
.
nid
 =‚id;

437 ià(!
dn
->
šode_·ge_locked
)

438 
	`lock_·ge
(
dn
->
šode_·ge
);

439 
tdn
.
node_·ge
 = 
dn
->
šode_·ge
;

440 
tdn
.
ofs_š_node
 = 
	`Ë16_to_ıu
(
sum
.ofs_in_node);

441 
Œunÿ‹_out
;

442 } ià(
dn
->
nid
 ==‚id) {

443 
tdn
.
ofs_š_node
 = 
	`Ë16_to_ıu
(
sum
.ofs_in_node);

444 
Œunÿ‹_out
;

448 
node_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
nid
);

449 ià(
	`IS_ERR
(
node_·ge
))

450  
	`PTR_ERR
(
node_·ge
);

452 
off£t
 = 
	`ofs_of_node
(
node_·ge
);

453 
šo
 = 
	`šo_of_node
(
node_·ge
);

454 
	`f2fs_put_·ge
(
node_·ge
, 1);

456 ià(
šo
 !ğ
dn
->
šode
->
i_šo
) {

457 
»t
;

460 
šode
 = 
	`f2fs_ig‘_»Œy
(
sbi
->
sb
, 
šo
);

461 ià(
	`IS_ERR
(
šode
))

462  
	`PTR_ERR
(
šode
);

464 
»t
 = 
	`dquÙ_š™Ÿlize
(
šode
);

465 ià(
»t
) {

466 
	`ut
(
šode
);

467  
»t
;

470 
šode
 = 
dn
->inode;

473 
bidx
 = 
	`f2fs_¡¬t_bidx_of_node
(
off£t
, 
šode
) +

474 
	`Ë16_to_ıu
(
sum
.
ofs_š_node
);

480 ià(
šo
 =ğ
dn
->
šode
->
i_šo
 && dn->
šode_·ge_locked
)

481 
	`uÆock_·ge
(
dn
->
šode_·ge
);

483 
	`£t_Ãw_dnode
(&
tdn
, 
šode
, 
NULL
, NULL, 0);

484 ià(
	`f2fs_g‘_dnode_of_d©a
(&
tdn
, 
bidx
, 
LOOKUP_NODE
))

485 
out
;

487 ià(
tdn
.
d©a_blkaddr
 =ğ
blkaddr
)

488 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
tdn
, 1);

490 
	`f2fs_put_dnode
(&
tdn
);

491 
out
:

492 ià(
šo
 !ğ
dn
->
šode
->
i_šo
)

493 
	`ut
(
šode
);

494 ià(
dn
->
šode_·ge_locked
)

495 
	`lock_·ge
(
dn
->
šode_·ge
);

498 
Œunÿ‹_out
:

499 ià(
	`d©ablock_addr
(
tdn
.
šode
,dn.
node_·ge
,

500 
tdn
.
ofs_š_node
è=ğ
blkaddr
)

501 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
tdn
, 1);

502 ià(
dn
->
šode
->
i_šo
 =ğ
nid
 && !dn->
šode_·ge_locked
)

503 
	`uÆock_·ge
(
dn
->
šode_·ge
);

505 
	}
}

507 
	$do_»cov”_d©a
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

508 
·ge
 *page)

510 
dnode_of_d©a
 
dn
;

511 
node_šfo
 
ni
;

512 
¡¬t
, 
’d
;

513 
”r
 = 0, 
»cov”ed
 = 0;

516 ià(
	`IS_INODE
(
·ge
)) {

517 
	`f2fs_»cov”_šlše_x©Œ
(
šode
, 
·ge
);

518 } ià(
	`f2fs_has_x©Œ_block
(
	`ofs_of_node
(
·ge
))) {

519 
”r
 = 
	`f2fs_»cov”_x©Œ_d©a
(
šode
, 
·ge
);

520 ià(!
”r
)

521 
»cov”ed
++;

522 
out
;

526 ià(
	`f2fs_»cov”_šlše_d©a
(
šode
, 
·ge
))

527 
out
;

530 
¡¬t
 = 
	`f2fs_¡¬t_bidx_of_node
(
	`ofs_of_node
(
·ge
), 
šode
);

531 
’d
 = 
¡¬t
 + 
	`ADDRS_PER_PAGE
(
·ge
, 
šode
);

533 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

534 
»Œy_dn
:

535 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
¡¬t
, 
ALLOC_NODE
);

536 ià(
”r
) {

537 ià(
”r
 =ğ-
ENOMEM
) {

538 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

539 
»Œy_dn
;

541 
out
;

544 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
.
node_·ge
, 
NODE
, 
Œue
,rue);

546 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
.
nid
, &
ni
);

547 ià(
”r
)

548 
”r
;

550 
	`f2fs_bug_Ú
(
sbi
, 
ni
.
šo
 !ğ
	`šo_of_node
(
·ge
));

552 ià(
	`ofs_of_node
(
dn
.
node_·ge
è!ğofs_of_node(
·ge
)) {

553 
	`f2fs_w¬n
(
sbi
, "Inconsistent ofs_of_node, ino:%lu, ofs:%u, %u",

554 
šode
->
i_šo
, 
	`ofs_of_node
(
dn
.
node_·ge
),

555 
	`ofs_of_node
(
·ge
));

556 
”r
 = -
EFSCORRUPTED
;

557 
”r
;

560 ; 
¡¬t
 < 
’d
; s¹++, 
dn
.
ofs_š_node
++) {

561 
block_t
 
¤c
, 
de¡
;

563 
¤c
 = 
	`d©ablock_addr
(
dn
.
šode
, dn.
node_·ge
, dn.
ofs_š_node
);

564 
de¡
 = 
	`d©ablock_addr
(
dn
.
šode
, 
·ge
, dn.
ofs_š_node
);

566 ià(
	`__is_v®id_d©a_blkaddr
(
¤c
) &&

567 !
	`f2fs_is_v®id_blkaddr
(
sbi
, 
¤c
, 
META_POR
)) {

568 
”r
 = -
EFSCORRUPTED
;

569 
”r
;

572 ià(
	`__is_v®id_d©a_blkaddr
(
de¡
) &&

573 !
	`f2fs_is_v®id_blkaddr
(
sbi
, 
de¡
, 
META_POR
)) {

574 
”r
 = -
EFSCORRUPTED
;

575 
”r
;

579 ià(
¤c
 =ğ
de¡
)

583 ià(
de¡
 =ğ
NULL_ADDR
) {

584 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

588 ià(!
	`fe_k“p_isize
(
šode
) &&

589 (
	`i_size_»ad
(
šode
è<ğ((
loff_t
)
¡¬t
 << 
PAGE_SHIFT
)))

590 
	`f2fs_i_size_wr™e
(
šode
,

591 (
loff_t
)(
¡¬t
 + 1è<< 
PAGE_SHIFT
);

597 ià(
de¡
 =ğ
NEW_ADDR
) {

598 
	`f2fs_Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

599 
	`f2fs_»£rve_Ãw_block
(&
dn
);

604 ià(
	`f2fs_is_v®id_blkaddr
(
sbi
, 
de¡
, 
META_POR
)) {

606 ià(
¤c
 =ğ
NULL_ADDR
) {

607 
”r
 = 
	`f2fs_»£rve_Ãw_block
(&
dn
);

608 
”r
 &&

609 
	`IS_ENABLED
(
CONFIG_F2FS_FAULT_INJECTION
))

610 
”r
 = 
	`f2fs_»£rve_Ãw_block
(&
dn
);

612 
	`f2fs_bug_Ú
(
sbi
, 
”r
);

613 ià(
”r
)

614 
”r
;

616 
»Œy_´ev
:

618 
”r
 = 
	`check_šdex_š_´ev_nodes
(
sbi
, 
de¡
, &
dn
);

619 ià(
”r
) {

620 ià(
”r
 =ğ-
ENOMEM
) {

621 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

622 
»Œy_´ev
;

624 
”r
;

628 
	`f2fs_»¶aû_block
(
sbi
, &
dn
, 
¤c
, 
de¡
,

629 
ni
.
v”siÚ
, 
çl£
, false);

630 
»cov”ed
++;

634 
	`cİy_node_foÙ”
(
dn
.
node_·ge
, 
·ge
);

635 
	`fl_node_foÙ”
(
dn
.
node_·ge
, dn.
nid
, 
ni
.
šo
,

636 
	`ofs_of_node
(
·ge
), 
çl£
);

637 
	`£t_·ge_dœty
(
dn
.
node_·ge
);

638 
”r
:

639 
	`f2fs_put_dnode
(&
dn
);

640 
out
:

641 
	`f2fs_nÙiû
(
sbi
, "recover_data: ino = %lx (i_size: %s)„ecovered = %d,ƒrr = %d",

642 
šode
->
i_šo
, 
	`fe_k“p_isize
(inode) ? "keep" : "recover",

643 
»cov”ed
, 
”r
);

644  
”r
;

645 
	}
}

647 
	$»cov”_d©a
(
f2fs_sb_šfo
 *
sbi
, 
li¡_h—d
 *
šode_li¡
,

648 
li¡_h—d
 *
tmp_šode_li¡
, li¡_h—d *
dœ_li¡
)

650 
cur£g_šfo
 *
cur£g
;

651 
·ge
 *·gğ
NULL
;

652 
”r
 = 0;

653 
block_t
 
blkaddr
;

656 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
);

657 
blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

660 
fsync_šode_’Œy
 *
’Œy
;

662 ià(!
	`f2fs_is_v®id_blkaddr
(
sbi
, 
blkaddr
, 
META_POR
))

665 
	`f2fs_¿_m‘a_·ges_cÚd
(
sbi
, 
blkaddr
);

667 
·ge
 = 
	`f2fs_g‘_tmp_·ge
(
sbi
, 
blkaddr
);

668 ià(
	`IS_ERR
(
·ge
)) {

669 
”r
 = 
	`PTR_ERR
(
·ge
);

673 ià(!
	`is_»cov”abË_dnode
(
·ge
)) {

674 
	`f2fs_put_·ge
(
·ge
, 1);

678 
’Œy
 = 
	`g‘_fsync_šode
(
šode_li¡
, 
	`šo_of_node
(
·ge
));

679 ià(!
’Œy
)

680 
Ãxt
;

686 ià(
	`IS_INODE
(
·ge
)) {

687 
”r
 = 
	`»cov”_šode
(
’Œy
->
šode
, 
·ge
);

688 ià(
”r
) {

689 
	`f2fs_put_·ge
(
·ge
, 1);

693 ià(
’Œy
->
Ï¡_d’Œy
 =ğ
blkaddr
) {

694 
”r
 = 
	`»cov”_d’Œy
(
’Œy
->
šode
, 
·ge
, 
dœ_li¡
);

695 ià(
”r
) {

696 
	`f2fs_put_·ge
(
·ge
, 1);

700 
”r
 = 
	`do_»cov”_d©a
(
sbi
, 
’Œy
->
šode
, 
·ge
);

701 ià(
”r
) {

702 
	`f2fs_put_·ge
(
·ge
, 1);

706 ià(
’Œy
->
blkaddr
 == blkaddr)

707 
	`li¡_move_
(&
’Œy
->
li¡
, 
tmp_šode_li¡
);

708 
Ãxt
:

710 
blkaddr
 = 
	`Ãxt_blkaddr_of_node
(
·ge
);

711 
	`f2fs_put_·ge
(
·ge
, 1);

713 ià(!
”r
)

714 
	`f2fs_®loÿ‹_Ãw_£gm’ts
(
sbi
);

715  
”r
;

716 
	}
}

718 
	$f2fs_»cov”_fsync_d©a
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
check_Úly
)

720 
li¡_h—d
 
šode_li¡
, 
tmp_šode_li¡
;

721 
li¡_h—d
 
dœ_li¡
;

722 
”r
;

723 
»t
 = 0;

724 
s_æags
 = 
sbi
->
sb
->s_flags;

725 
boŞ
 
Ãed_wr™eı
 = 
çl£
;

726 #ifdeà
CONFIG_QUOTA


727 
quÙa_’abËd
;

730 ià(
s_æags
 & 
SB_RDONLY
) {

731 
	`f2fs_šfo
(
sbi
, "recover fsync data on„eadonly fs");

732 
sbi
->
sb
->
s_æags
 &ğ~
SB_RDONLY
;

735 #ifdeà
CONFIG_QUOTA


737 
sbi
->
sb
->
s_æags
 |ğ
SB_ACTIVE
;

739 
quÙa_’abËd
 = 
	`f2fs_’abË_quÙa_fes
(
sbi
, 
s_æags
 & 
SB_RDONLY
);

742 
fsync_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_fsync_inode_entry",

743 (
fsync_šode_’Œy
));

744 ià(!
fsync_’Œy_¦ab
) {

745 
”r
 = -
ENOMEM
;

746 
out
;

749 
	`INIT_LIST_HEAD
(&
šode_li¡
);

750 
	`INIT_LIST_HEAD
(&
tmp_šode_li¡
);

751 
	`INIT_LIST_HEAD
(&
dœ_li¡
);

754 
	`mu‹x_lock
(&
sbi
->
ı_mu‹x
);

757 
”r
 = 
	`fšd_fsync_dnodes
(
sbi
, &
šode_li¡
, 
check_Úly
);

758 ià(
”r
 || 
	`li¡_em±y
(&
šode_li¡
))

759 
sk
;

761 ià(
check_Úly
) {

762 
»t
 = 1;

763 
sk
;

766 
Ãed_wr™eı
 = 
Œue
;

769 
”r
 = 
	`»cov”_d©a
(
sbi
, &
šode_li¡
, &
tmp_šode_li¡
, &
dœ_li¡
);

770 ià(!
”r
)

771 
	`f2fs_bug_Ú
(
sbi
, !
	`li¡_em±y
(&
šode_li¡
));

774 
sbi
->
sb
->
s_æags
 = s_flags;

776 
sk
:

777 
	`de¡roy_fsync_dnodes
(&
šode_li¡
, 
”r
);

778 
	`de¡roy_fsync_dnodes
(&
tmp_šode_li¡
, 
”r
);

781 
	`Œunÿ‹_šode_·ges_¿nge
(
	`META_MAPPING
(
sbi
),

782 (
loff_t
)
	`MAIN_BLKADDR
(
sbi
è<< 
PAGE_SHIFT
, -1);

784 ià(
”r
) {

785 
	`Œunÿ‹_šode_·ges_fš®
(
	`NODE_MAPPING
(
sbi
));

786 
	`Œunÿ‹_šode_·ges_fš®
(
	`META_MAPPING
(
sbi
));

788 
	`ş—r_sbi_æag
(
sbi
, 
SBI_POR_DOING
);

790 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

793 
	`de¡roy_fsync_dnodes
(&
dœ_li¡
, 
”r
);

795 ià(
Ãed_wr™eı
) {

796 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_RECOVERED
);

798 ià(!
”r
) {

799 
ı_cÚŒŞ
 
ıc
 = {

800 .
»asÚ
 = 
CP_RECOVERY
,

802 
”r
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

806 
	`kmem_ÿche_de¡roy
(
fsync_’Œy_¦ab
);

807 
out
:

808 #ifdeà
CONFIG_QUOTA


810 ià(
quÙa_’abËd
)

811 
	`f2fs_quÙa_off_umouÁ
(
sbi
->
sb
);

813 
sbi
->
sb
->
s_æags
 = s_flags;

815  
»t
 ?„‘: 
”r
;

816 
	}
}

	@segment.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/f2fs_fs.h
>

10 
	~<lšux/bio.h
>

11 
	~<lšux/blkdev.h
>

12 
	~<lšux/´eãtch.h
>

13 
	~<lšux/kth»ad.h
>

14 
	~<lšux/sw­.h
>

15 
	~<lšux/tim”.h
>

16 
	~<lšux/ä“z”.h
>

17 
	~<lšux/sched/sigÇl.h
>

19 
	~"f2fs.h
"

20 
	~"£gm’t.h
"

21 
	~"node.h
"

22 
	~"gc.h
"

23 
	~"Œaû.h
"

24 
	~<Œaû/ev’ts/f2fs.h
>

26 
	snvme_·s¡hru_cmd
 {

27 
__u8
 
	mİcode
; __u8 
	mæags
; 
__u16
 
	mrsvd1
; 
__u32
 
	mnsid
; __u32 
	mcdw2
; __u32 
	mcdw3
; 
__u64
 
	mm‘ad©a
;

28 
__u64
 
	maddr
; 
__u32
 
	mm‘ad©a_Ën
; __u32 
	md©a_Ën
; __u32 
	mcdw10
; __u32 
	mcdw11
;

29 
__u32
 
	mcdw12
; __u32 
	mcdw13
; __u32 
	mcdw14
; __u32 
	mcdw15
; __u32 
	mtimeout_ms
; __u32 
	m»suÉ
;

32 
	#COSMOS_DEV
 "/dev/nvme1n1"

	)

33 
	$ÿÎ_§Îoÿ‹
(
u32
 
lba
, 
ušt64_t
 
Ën
) {

34 
”r
; *
ioùl_buf
 = 
NULL
;

35 
”r
 = 
	`posix_mem®ign
(&
ioùl_buf
, 
	`g‘·gesize
(), 
d©a_Ën
);

36 ià(
”r
) ƒrr;

37 
nvme_·s¡hru_cmd
 
cmd
;

38 
cmd
.
addr
=(
__u64
)(
ušŒ_t
)
ioùl_buf
;

39 
cmd
.
İcode
=(
ušt8_t
)opcode;

40 
cmd
.
cdw10
=
lba
;

41 
cmd
.
cdw14
=
d©a_Ën
;

43 
fe
* 
f
 = 
	`fp_İ’
(
COSMOS_DEV
, 
O_WRONLY
, 0);

44 
f
->
f_İ
->
	`uÆocked_ioùl
(f,
NVME_IOCTL_IO_CMD
, &
cmd
);

45 
	`fp_şo£
(
f
,0);

46 
	}
}

48 
	#__»v”£_ffz
(
x
è
	`__»v”£_ffs
(~(x))

	)

50 
kmem_ÿche
 *
	gdisÿrd_’Œy_¦ab
;

51 
kmem_ÿche
 *
	gdisÿrd_cmd_¦ab
;

52 
kmem_ÿche
 *
	gs™_’Œy_£t_¦ab
;

53 
kmem_ÿche
 *
	gšmem_’Œy_¦ab
;

55 
	$__»v”£_ulÚg
(*
¡r
)

57 
tmp
 = 0;

58 
shiá
 = 24, 
idx
 = 0;

60 #ià
BITS_PER_LONG
 == 64

61 
shiá
 = 56;

63 
shiá
 >= 0) {

64 
tmp
 |ğ()
¡r
[
idx
++] << 
shiá
;

65 
shiá
 -ğ
BITS_PER_BYTE
;

67  
tmp
;

68 
	}
}

74 
šlše
 
	$__»v”£_ffs
(
wÜd
)

76 
num
 = 0;

78 #ià
BITS_PER_LONG
 == 64

79 ià((
wÜd
 & 0xffffffff00000000UL) == 0)

80 
num
 += 32;

82 
wÜd
 >>= 32;

84 ià((
wÜd
 & 0xffff0000) == 0)

85 
num
 += 16;

87 
wÜd
 >>= 16;

89 ià((
wÜd
 & 0xff00) == 0)

90 
num
 += 8;

92 
wÜd
 >>= 8;

94 ià((
wÜd
 & 0xf0) == 0)

95 
num
 += 4;

97 
wÜd
 >>= 4;

99 ià((
wÜd
 & 0xc) == 0)

100 
num
 += 2;

102 
wÜd
 >>= 2;

104 ià((
wÜd
 & 0x2) == 0)

105 
num
 += 1;

106  
num
;

107 
	}
}

118 
	$__fšd_»v_Ãxt_b™
(cÚ¡ *
addr
,

119 
size
, 
off£t
)

121 cÚ¡ *
p
 = 
addr
 + 
	`BIT_WORD
(
off£t
);

122 
»suÉ
 = 
size
;

123 
tmp
;

125 ià(
off£t
 >ğ
size
)

126  
size
;

128 
size
 -ğ(
off£t
 & ~(
BITS_PER_LONG
 - 1));

129 
off£t
 %ğ
BITS_PER_LONG
;

132 ià(*
p
 == 0)

133 
·ss
;

135 
tmp
 = 
	`__»v”£_ulÚg
((*)
p
);

137 
tmp
 &ğ~0UL >> 
off£t
;

138 ià(
size
 < 
BITS_PER_LONG
)

139 
tmp
 &ğ(~0UL << (
BITS_PER_LONG
 - 
size
));

140 ià(
tmp
)

141 
found
;

142 
·ss
:

143 ià(
size
 <ğ
BITS_PER_LONG
)

145 
size
 -ğ
BITS_PER_LONG
;

146 
off£t
 = 0;

147 
p
++;

149  
»suÉ
;

150 
found
:

151  
»suÉ
 - 
size
 + 
	`__»v”£_ffs
(
tmp
);

152 
	}
}

154 
	$__fšd_»v_Ãxt_z”o_b™
(cÚ¡ *
addr
,

155 
size
, 
off£t
)

157 cÚ¡ *
p
 = 
addr
 + 
	`BIT_WORD
(
off£t
);

158 
»suÉ
 = 
size
;

159 
tmp
;

161 ià(
off£t
 >ğ
size
)

162  
size
;

164 
size
 -ğ(
off£t
 & ~(
BITS_PER_LONG
 - 1));

165 
off£t
 %ğ
BITS_PER_LONG
;

168 ià(*
p
 == ~0UL)

169 
·ss
;

171 
tmp
 = 
	`__»v”£_ulÚg
((*)
p
);

173 ià(
off£t
)

174 
tmp
 |ğ~0UL << (
BITS_PER_LONG
 - 
off£t
);

175 ià(
size
 < 
BITS_PER_LONG
)

176 
tmp
 |ğ~0UL >> 
size
;

177 ià(
tmp
 != ~0UL)

178 
found
;

179 
·ss
:

180 ià(
size
 <ğ
BITS_PER_LONG
)

182 
size
 -ğ
BITS_PER_LONG
;

183 
off£t
 = 0;

184 
p
++;

186  
»suÉ
;

187 
found
:

188  
»suÉ
 - 
size
 + 
	`__»v”£_ffz
(
tmp
);

189 
	}
}

191 
boŞ
 
	$f2fs_Ãed_SSR
(
f2fs_sb_šfo
 *
sbi
)

193 
node_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_NODES
);

194 
d’t_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_DENTS
);

195 
im‘a_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_IMETA
);

197 ià(
	`‹¡_İt
(
sbi
, 
LFS
))

198  
çl£
;

199 ià(
sbi
->
gc_mode
 =ğ
GC_URGENT
)

200  
Œue
;

201 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)))

202  
Œue
;

204  
	`ä“_£ùiÚs
(
sbi
è<ğ(
node_£cs
 + 2 * 
d’t_£cs
 + 
im‘a_£cs
 +

205 
	`SM_I
(
sbi
)->
mš_s¤_£ùiÚs
 + 
	`»£rved_£ùiÚs
(sbi));

206 
	}
}

208 
	$f2fs_»gi¡”_šmem_·ge
(
šode
 *šode, 
·ge
 *page)

210 
šmem_·ges
 *
Ãw
;

212 
	`f2fs_Œaû_pid
(
·ge
);

214 
	`f2fs_£t_·ge_´iv©e
(
·ge
, ()
ATOMIC_WRITTEN_PAGE
);

216 
Ãw
 = 
	`f2fs_kmem_ÿche_®loc
(
šmem_’Œy_¦ab
, 
GFP_NOFS
);

219 
Ãw
->
·ge
 =…age;

220 
	`INIT_LIST_HEAD
(&
Ãw
->
li¡
);

223 
	`g‘_·ge
(
·ge
);

224 
	`mu‹x_lock
(&
	`F2FS_I
(
šode
)->
šmem_lock
);

225 
	`li¡_add_
(&
Ãw
->
li¡
, &
	`F2FS_I
(
šode
)->
šmem_·ges
);

226 
	`šc_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_INMEM_PAGES
);

227 
	`mu‹x_uÆock
(&
	`F2FS_I
(
šode
)->
šmem_lock
);

229 
	`Œaû_f2fs_»gi¡”_šmem_·ge
(
·ge
, 
INMEM
);

230 
	}
}

232 
	$__»voke_šmem_·ges
(
šode
 *inode,

233 
li¡_h—d
 *
h—d
, 
boŞ
 
drİ
, boŞ 
»cov”
,

234 
boŞ
 
Œylock
)

236 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

237 
šmem_·ges
 *
cur
, *
tmp
;

238 
”r
 = 0;

240 
	`li¡_fÜ_—ch_’Œy_§ã
(
cur
, 
tmp
, 
h—d
, 
li¡
) {

241 
·ge
 *·gğ
cur
->page;

243 ià(
drİ
)

244 
	`Œaû_f2fs_comm™_šmem_·ge
(
·ge
, 
INMEM_DROP
);

246 ià(
Œylock
) {

251 ià(!
	`Œylock_·ge
(
·ge
))

254 
	`lock_·ge
(
·ge
);

257 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
,rue);

259 ià(
»cov”
) {

260 
dnode_of_d©a
 
dn
;

261 
node_šfo
 
ni
;

263 
	`Œaû_f2fs_comm™_šmem_·ge
(
·ge
, 
INMEM_REVOKE
);

264 
»Œy
:

265 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

266 
”r
 = 
	`f2fs_g‘_dnode_of_d©a
(&
dn
, 
·ge
->
šdex
,

267 
LOOKUP_NODE
);

268 ià(
”r
) {

269 ià(
”r
 =ğ-
ENOMEM
) {

270 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

271 
	`cÚd_»sched
();

272 
»Œy
;

274 
”r
 = -
EAGAIN
;

275 
Ãxt
;

278 
”r
 = 
	`f2fs_g‘_node_šfo
(
sbi
, 
dn
.
nid
, &
ni
);

279 ià(
”r
) {

280 
	`f2fs_put_dnode
(&
dn
);

281  
”r
;

284 ià(
cur
->
Şd_addr
 =ğ
NEW_ADDR
) {

285 
	`f2fs_šv®id©e_blocks
(
sbi
, 
dn
.
d©a_blkaddr
);

286 
	`f2fs_upd©e_d©a_blkaddr
(&
dn
, 
NEW_ADDR
);

288 
	`f2fs_»¶aû_block
(
sbi
, &
dn
, dn.
d©a_blkaddr
,

289 
cur
->
Şd_addr
, 
ni
.
v”siÚ
, 
Œue
,rue);

290 
	`f2fs_put_dnode
(&
dn
);

292 
Ãxt
:

294 ià(
drİ
 || 
»cov”
) {

295 
	`CË¬PageU±od©e
(
·ge
);

296 
	`ş—r_cŞd_d©a
(
·ge
);

298 
	`f2fs_ş—r_·ge_´iv©e
(
·ge
);

299 
	`f2fs_put_·ge
(
·ge
, 1);

301 
	`li¡_d–
(&
cur
->
li¡
);

302 
	`kmem_ÿche_ä“
(
šmem_’Œy_¦ab
, 
cur
);

303 
	`dec_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_INMEM_PAGES
);

305  
”r
;

306 
	}
}

308 
	$f2fs_drİ_šmem_·ges_®l
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
gc_çu»
)

310 
li¡_h—d
 *
h—d
 = &
sbi
->
šode_li¡
[
ATOMIC_FILE
];

311 
šode
 *inode;

312 
f2fs_šode_šfo
 *
fi
;

313 
couÁ
 = 
sbi
->
©omic_fes
;

314 
loİed
 = 0;

315 
Ãxt
:

316 
	`¥š_lock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

317 ià(
	`li¡_em±y
(
h—d
)) {

318 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

321 
fi
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
f2fs_šode_šfo
, 
šmem_i¡
);

322 
šode
 = 
	`ig¿b
(&
fi
->
vfs_šode
);

323 ià(
šode
)

324 
	`li¡_move_
(&
fi
->
šmem_i¡
, 
h—d
);

325 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

327 ià(
šode
) {

328 ià(
gc_çu»
) {

329 ià(!
fi
->
i_gc_çu»s
[
GC_FAILURE_ATOMIC
])

330 
sk
;

332 
	`£t_šode_æag
(
šode
, 
FI_ATOMIC_REVOKE_REQUEST
);

333 
	`f2fs_drİ_šmem_·ges
(
šode
);

334 
sk
:

335 
	`ut
(
šode
);

337 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

338 
	`cÚd_»sched
();

339 ià(
gc_çu»
) {

340 ià(++
loİed
 >ğ
couÁ
)

343 
Ãxt
;

344 
	}
}

346 
	$f2fs_drİ_šmem_·ges
(
šode
 *inode)

348 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

349 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

351 !
	`li¡_em±y
(&
fi
->
šmem_·ges
)) {

352 
	`mu‹x_lock
(&
fi
->
šmem_lock
);

353 
	`__»voke_šmem_·ges
(
šode
, &
fi
->
šmem_·ges
,

354 
Œue
, 
çl£
,rue);

355 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

358 
fi
->
i_gc_çu»s
[
GC_FAILURE_ATOMIC
] = 0;

359 
	`¡©_dec_©omic_wr™e
(
šode
);

361 
	`¥š_lock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

362 ià(!
	`li¡_em±y
(&
fi
->
šmem_i¡
))

363 
	`li¡_d–_š™
(&
fi
->
šmem_i¡
);

364 ià(
	`f2fs_is_©omic_fe
(
šode
)) {

365 
	`ş—r_šode_æag
(
šode
, 
FI_ATOMIC_FILE
);

366 
sbi
->
©omic_fes
--;

368 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
ATOMIC_FILE
]);

369 
	}
}

371 
	$f2fs_drİ_šmem_·ge
(
šode
 *šode, 
·ge
 *page)

373 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

374 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

375 
li¡_h—d
 *
h—d
 = &
fi
->
šmem_·ges
;

376 
šmem_·ges
 *
cur
 = 
NULL
;

378 
	`f2fs_bug_Ú
(
sbi
, !
	`IS_ATOMIC_WRITTEN_PAGE
(
·ge
));

380 
	`mu‹x_lock
(&
fi
->
šmem_lock
);

381 
	`li¡_fÜ_—ch_’Œy
(
cur
, 
h—d
, 
li¡
) {

382 ià(
cur
->
·ge
 ==…age)

386 
	`f2fs_bug_Ú
(
sbi
, 
	`li¡_em±y
(
h—d
è|| 
cur
->
·ge
 !=…age);

387 
	`li¡_d–
(&
cur
->
li¡
);

388 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

390 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_INMEM_PAGES
);

391 
	`kmem_ÿche_ä“
(
šmem_’Œy_¦ab
, 
cur
);

393 
	`CË¬PageU±od©e
(
·ge
);

394 
	`f2fs_ş—r_·ge_´iv©e
(
·ge
);

395 
	`f2fs_put_·ge
(
·ge
, 0);

397 
	`Œaû_f2fs_comm™_šmem_·ge
(
·ge
, 
INMEM_INVALIDATE
);

398 
	}
}

400 
	$__f2fs_comm™_šmem_·ges
(
šode
 *inode)

402 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

403 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

404 
šmem_·ges
 *
cur
, *
tmp
;

405 
f2fs_io_šfo
 
fio
 = {

406 .
sbi
 = sbi,

407 .
šo
 = 
šode
->
i_šo
,

408 .
ty³
 = 
DATA
,

409 .
İ
 = 
REQ_OP_WRITE
,

410 .
İ_æags
 = 
REQ_SYNC
 | 
REQ_PRIO
,

411 .
io_ty³
 = 
FS_DATA_IO
,

413 
li¡_h—d
 
»voke_li¡
;

414 
boŞ
 
subm™_bio
 = 
çl£
;

415 
”r
 = 0;

417 
	`INIT_LIST_HEAD
(&
»voke_li¡
);

419 
	`li¡_fÜ_—ch_’Œy_§ã
(
cur
, 
tmp
, &
fi
->
šmem_·ges
, 
li¡
) {

420 
·ge
 *·gğ
cur
->page;

422 
	`lock_·ge
(
·ge
);

423 ià(
·ge
->
m­pšg
 =ğ
šode
->
i_m­pšg
) {

424 
	`Œaû_f2fs_comm™_šmem_·ge
(
·ge
, 
INMEM
);

426 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
, 
Œue
,rue);

428 
	`£t_·ge_dœty
(
·ge
);

429 ià(
	`ş—r_·ge_dœty_fÜ_io
(
·ge
)) {

430 
	`šode_dec_dœty_·ges
(
šode
);

431 
	`f2fs_»move_dœty_šode
(
šode
);

433 
»Œy
:

434 
fio
.
·ge
 =…age;

435 
fio
.
Şd_blkaddr
 = 
NULL_ADDR
;

436 
fio
.
’üy±ed_·ge
 = 
NULL
;

437 
fio
.
Ãed_lock
 = 
LOCK_DONE
;

438 
”r
 = 
	`f2fs_do_wr™e_d©a_·ge
(&
fio
);

439 ià(
”r
) {

440 ià(
”r
 =ğ-
ENOMEM
) {

441 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

442 
	`cÚd_»sched
();

443 
»Œy
;

445 
	`uÆock_·ge
(
·ge
);

449 
cur
->
Şd_addr
 = 
fio
.
Şd_blkaddr
;

450 
subm™_bio
 = 
Œue
;

452 
	`uÆock_·ge
(
·ge
);

453 
	`li¡_move_
(&
cur
->
li¡
, &
»voke_li¡
);

456 ià(
subm™_bio
)

457 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
šode
, 
NULL
, 0, 
DATA
);

459 ià(
”r
) {

468 
”r
 = 
	`__»voke_šmem_·ges
(
šode
, &
»voke_li¡
,

469 
çl£
, 
Œue
, false);

472 
	`__»voke_šmem_·ges
(
šode
, &
fi
->
šmem_·ges
,

473 
Œue
, 
çl£
, false);

475 
	`__»voke_šmem_·ges
(
šode
, &
»voke_li¡
,

476 
çl£
, false, false);

479  
”r
;

480 
	}
}

482 
	$f2fs_comm™_šmem_·ges
(
šode
 *inode)

484 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

485 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

486 
”r
;

488 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

490 
	`down_wr™e
(&
fi
->
i_gc_rw£m
[
WRITE
]);

492 
	`f2fs_lock_İ
(
sbi
);

493 
	`£t_šode_æag
(
šode
, 
FI_ATOMIC_COMMIT
);

495 
	`mu‹x_lock
(&
fi
->
šmem_lock
);

496 
”r
 = 
	`__f2fs_comm™_šmem_·ges
(
šode
);

497 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

499 
	`ş—r_šode_æag
(
šode
, 
FI_ATOMIC_COMMIT
);

501 
	`f2fs_uÆock_İ
(
sbi
);

502 
	`up_wr™e
(&
fi
->
i_gc_rw£m
[
WRITE
]);

504  
”r
;

505 
	}
}

511 
	$f2fs_b®ªû_fs
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
Ãed
)

513 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_CHECKPOINT
)) {

514 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_CHECKPOINT
);

515 
	`f2fs_¡İ_checkpošt
(
sbi
, 
çl£
);

519 ià(
Ãed
 && 
	`exûss_ÿched_Çts
(
sbi
))

520 
	`f2fs_b®ªû_fs_bg
(
sbi
);

522 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
))

529 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0)) {

530 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

531 
	`f2fs_gc
(
sbi
, 
çl£
, f®£, 
NULL_SEGNO
);

533 
	}
}

535 
	$f2fs_b®ªû_fs_bg
(
f2fs_sb_šfo
 *
sbi
)

537 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

541 ià(!
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
EXTENT_CACHE
))

542 
	`f2fs_shršk_ex‹Á_Œ“
(
sbi
, 
EXTENT_CACHE_SHRINK_NUMBER
);

545 ià(!
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
NAT_ENTRIES
))

546 
	`f2fs_Œy_to_ä“_Çts
(
sbi
, 
NAT_ENTRY_PER_BLOCK
);

548 ià(!
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
FREE_NIDS
))

549 
	`f2fs_Œy_to_ä“_nids
(
sbi
, 
MAX_FREE_NIDS
);

551 
	`f2fs_bud_ä“_nids
(
sbi
, 
çl£
, false);

553 ià(!
	`is_idË
(
sbi
, 
REQ_TIME
) &&

554 (!
	`exûss_dœty_Çts
(
sbi
è&& !
	`exûss_dœty_nodes
(sbi)))

558 ià(!
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
NAT_ENTRIES
) ||

559 !
	`f2fs_avaabË_ä“_memÜy
(
sbi
, 
INO_ENTRIES
) ||

560 
	`exûss_´eä“_£gs
(
sbi
) ||

561 
	`exûss_dœty_Çts
(
sbi
) ||

562 
	`exûss_dœty_nodes
(
sbi
) ||

563 
	`f2fs_time_ov”
(
sbi
, 
CP_TIME
)) {

564 ià(
	`‹¡_İt
(
sbi
, 
DATA_FLUSH
)) {

565 
blk_¶ug
 
¶ug
;

567 
	`mu‹x_lock
(&
sbi
->
æush_lock
);

569 
	`blk_¡¬t_¶ug
(&
¶ug
);

570 
	`f2fs_sync_dœty_šodes
(
sbi
, 
FILE_INODE
);

571 
	`blk_fšish_¶ug
(&
¶ug
);

573 
	`mu‹x_uÆock
(&
sbi
->
æush_lock
);

575 
	`f2fs_sync_fs
(
sbi
->
sb
, 
Œue
);

576 
	`¡©_šc_bg_ı_couÁ
(
sbi
->
¡©_šfo
);

578 
	}
}

580 
	$__subm™_æush_wa™
(
f2fs_sb_šfo
 *
sbi
,

581 
block_deviû
 *
bdev
)

583 
bio
 *bio;

584 
»t
;

586 
bio
 = 
	`f2fs_bio_®loc
(
sbi
, 0, 
çl£
);

587 ià(!
bio
)

588  -
ENOMEM
;

590 
bio
->
bi_İf
 = 
REQ_OP_WRITE
 | 
REQ_SYNC
 | 
REQ_PREFLUSH
;

591 
	`bio_£t_dev
(
bio
, 
bdev
);

592 
»t
 = 
	`subm™_bio_wa™
(
bio
);

593 
	`bio_put
(
bio
);

595 
	`Œaû_f2fs_issue_æush
(
bdev
, 
	`‹¡_İt
(
sbi
, 
NOBARRIER
),

596 
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
), 
»t
);

597  
»t
;

598 
	}
}

600 
	$subm™_æush_wa™
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

602 
»t
 = 0;

603 
i
;

605 ià(!
	`f2fs_is_muÉi_deviû
(
sbi
))

606  
	`__subm™_æush_wa™
(
sbi
, sbi->
sb
->
s_bdev
);

608 
i
 = 0; i < 
sbi
->
s_ndevs
; i++) {

609 ià(!
	`f2fs_is_dœty_deviû
(
sbi
, 
šo
, 
i
, 
FLUSH_INO
))

611 
»t
 = 
	`__subm™_æush_wa™
(
sbi
, 
	`FDEV
(
i
).
bdev
);

612 ià(
»t
)

615  
»t
;

616 
	}
}

618 
	$issue_æush_th»ad
(*
d©a
)

620 
f2fs_sb_šfo
 *
sbi
 = 
d©a
;

621 
æush_cmd_cÚŒŞ
 *
fcc
 = 
	`SM_I
(
sbi
)->
fcc_šfo
;

622 
wa™_queue_h—d_t
 *
q
 = &
fcc
->
æush_wa™_queue
;

623 
»³©
:

624 ià(
	`kth»ad_should_¡İ
())

627 
	`sb_¡¬t_štwr™e
(
sbi
->
sb
);

629 ià(!
	`Îi¡_em±y
(&
fcc
->
issue_li¡
)) {

630 
æush_cmd
 *
cmd
, *
Ãxt
;

631 
»t
;

633 
fcc
->
di¥©ch_li¡
 = 
	`Îi¡_d–_®l
(&fcc->
issue_li¡
);

634 
fcc
->
di¥©ch_li¡
 = 
	`Îi¡_»v”£_Üd”
(fcc->dispatch_list);

636 
cmd
 = 
	`Îi¡_’Œy
(
fcc
->
di¥©ch_li¡
, 
æush_cmd
, 
Înode
);

638 
»t
 = 
	`subm™_æush_wa™
(
sbi
, 
cmd
->
šo
);

639 
	`©omic_šc
(&
fcc
->
issued_æush
);

641 
	`Îi¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
Ãxt
,

642 
fcc
->
di¥©ch_li¡
, 
Înode
) {

643 
cmd
->
»t
 =„et;

644 
	`com¶‘e
(&
cmd
->
wa™
);

646 
fcc
->
di¥©ch_li¡
 = 
NULL
;

649 
	`sb_’d_štwr™e
(
sbi
->
sb
);

651 
	`wa™_ev’t_š‹¼u±ibË
(*
q
,

652 
	`kth»ad_should_¡İ
(è|| !
	`Îi¡_em±y
(&
fcc
->
issue_li¡
));

653 
»³©
;

654 
	}
}

656 
	$f2fs_issue_æush
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

658 
æush_cmd_cÚŒŞ
 *
fcc
 = 
	`SM_I
(
sbi
)->
fcc_šfo
;

659 
æush_cmd
 
cmd
;

660 
»t
;

662 ià(
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

665 ià(!
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
)) {

666 
	`©omic_šc
(&
fcc
->
queued_æush
);

667 
»t
 = 
	`subm™_æush_wa™
(
sbi
, 
šo
);

668 
	`©omic_dec
(&
fcc
->
queued_æush
);

669 
	`©omic_šc
(&
fcc
->
issued_æush
);

670  
»t
;

673 ià(
	`©omic_šc_»tuº
(&
fcc
->
queued_æush
) == 1 ||

674 
	`f2fs_is_muÉi_deviû
(
sbi
)) {

675 
»t
 = 
	`subm™_æush_wa™
(
sbi
, 
šo
);

676 
	`©omic_dec
(&
fcc
->
queued_æush
);

678 
	`©omic_šc
(&
fcc
->
issued_æush
);

679  
»t
;

682 
cmd
.
šo
 = ino;

683 
	`š™_com¶‘iÚ
(&
cmd
.
wa™
);

685 
	`Îi¡_add
(&
cmd
.
Înode
, &
fcc
->
issue_li¡
);

688 
	`smp_mb
();

690 ià(
	`wa™queue_aùive
(&
fcc
->
æush_wa™_queue
))

691 
	`wake_up
(&
fcc
->
æush_wa™_queue
);

693 ià(
fcc
->
f2fs_issue_æush
) {

694 
	`wa™_fÜ_com¶‘iÚ
(&
cmd
.
wa™
);

695 
	`©omic_dec
(&
fcc
->
queued_æush
);

697 
Îi¡_node
 *
li¡
;

699 
li¡
 = 
	`Îi¡_d–_®l
(&
fcc
->
issue_li¡
);

700 ià(!
li¡
) {

701 
	`wa™_fÜ_com¶‘iÚ
(&
cmd
.
wa™
);

702 
	`©omic_dec
(&
fcc
->
queued_æush
);

704 
æush_cmd
 *
tmp
, *
Ãxt
;

706 
»t
 = 
	`subm™_æush_wa™
(
sbi
, 
šo
);

708 
	`Îi¡_fÜ_—ch_’Œy_§ã
(
tmp
, 
Ãxt
, 
li¡
, 
Înode
) {

709 ià(
tmp
 =ğ&
cmd
) {

710 
cmd
.
»t
 =„et;

711 
	`©omic_dec
(&
fcc
->
queued_æush
);

714 
tmp
->
»t
 =„et;

715 
	`com¶‘e
(&
tmp
->
wa™
);

720  
cmd
.
»t
;

721 
	}
}

723 
	$f2fs_ü—‹_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
)

725 
dev_t
 
dev
 = 
sbi
->
sb
->
s_bdev
->
bd_dev
;

726 
æush_cmd_cÚŒŞ
 *
fcc
;

727 
”r
 = 0;

729 ià(
	`SM_I
(
sbi
)->
fcc_šfo
) {

730 
fcc
 = 
	`SM_I
(
sbi
)->
fcc_šfo
;

731 ià(
fcc
->
f2fs_issue_æush
)

732  
”r
;

733 
š™_th»ad
;

736 
fcc
 = 
	`f2fs_kz®loc
(
sbi
, (
æush_cmd_cÚŒŞ
), 
GFP_KERNEL
);

737 ià(!
fcc
)

738  -
ENOMEM
;

739 
	`©omic_£t
(&
fcc
->
issued_æush
, 0);

740 
	`©omic_£t
(&
fcc
->
queued_æush
, 0);

741 
	`š™_wa™queue_h—d
(&
fcc
->
æush_wa™_queue
);

742 
	`š™_Îi¡_h—d
(&
fcc
->
issue_li¡
);

743 
	`SM_I
(
sbi
)->
fcc_šfo
 = 
fcc
;

744 ià(!
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
))

745  
”r
;

747 
š™_th»ad
:

748 
fcc
->
f2fs_issue_æush
 = 
	`kth»ad_run
(
issue_æush_th»ad
, 
sbi
,

749 "f2fs_æush-%u:%u", 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

750 ià(
	`IS_ERR
(
fcc
->
f2fs_issue_æush
)) {

751 
”r
 = 
	`PTR_ERR
(
fcc
->
f2fs_issue_æush
);

752 
	`kvä“
(
fcc
);

753 
	`SM_I
(
sbi
)->
fcc_šfo
 = 
NULL
;

754  
”r
;

757  
”r
;

758 
	}
}

760 
	$f2fs_de¡roy_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
ä“
)

762 
æush_cmd_cÚŒŞ
 *
fcc
 = 
	`SM_I
(
sbi
)->
fcc_šfo
;

764 ià(
fcc
 && fcc->
f2fs_issue_æush
) {

765 
sk_¡ruù
 *
æush_th»ad
 = 
fcc
->
f2fs_issue_æush
;

767 
fcc
->
f2fs_issue_æush
 = 
NULL
;

768 
	`kth»ad_¡İ
(
æush_th»ad
);

770 ià(
ä“
) {

771 
	`kvä“
(
fcc
);

772 
	`SM_I
(
sbi
)->
fcc_šfo
 = 
NULL
;

774 
	}
}

776 
	$f2fs_æush_deviû_ÿche
(
f2fs_sb_šfo
 *
sbi
)

778 
»t
 = 0, 
i
;

780 ià(!
	`f2fs_is_muÉi_deviû
(
sbi
))

783 
i
 = 1; i < 
sbi
->
s_ndevs
; i++) {

784 ià(!
	`f2fs_‹¡_b™
(
i
, (*)&
sbi
->
dœty_deviû
))

786 
»t
 = 
	`__subm™_æush_wa™
(
sbi
, 
	`FDEV
(
i
).
bdev
);

787 ià(
»t
)

790 
	`¥š_lock
(&
sbi
->
dev_lock
);

791 
	`f2fs_ş—r_b™
(
i
, (*)&
sbi
->
dœty_deviû
);

792 
	`¥š_uÆock
(&
sbi
->
dev_lock
);

795  
»t
;

796 
	}
}

798 
	$__loÿ‹_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
,

799 
dœty_ty³
 dirty_type)

801 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

804 ià(
	`IS_CURSEG
(
sbi
, 
£gno
))

807 ià(!
	`‹¡_ªd_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
dœty_ty³
]))

808 
dœty_i
->
Ä_dœty
[
dœty_ty³
]++;

810 ià(
dœty_ty³
 =ğ
DIRTY
) {

811 
£g_’Œy
 *
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

812 
dœty_ty³
 
t
 = 
£Áry
->
ty³
;

814 ià(
	`uÆik–y
(
t
 >ğ
DIRTY
)) {

815 
	`f2fs_bug_Ú
(
sbi
, 1);

818 ià(!
	`‹¡_ªd_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
t
]))

819 
dœty_i
->
Ä_dœty
[
t
]++;

821 
	}
}

823 
	$__»move_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
,

824 
dœty_ty³
 dirty_type)

826 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

828 ià(
	`‹¡_ªd_ş—r_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
dœty_ty³
]))

829 
dœty_i
->
Ä_dœty
[
dœty_ty³
]--;

831 ià(
dœty_ty³
 =ğ
DIRTY
) {

832 
£g_’Œy
 *
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

833 
dœty_ty³
 
t
 = 
£Áry
->
ty³
;

835 ià(
	`‹¡_ªd_ş—r_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
t
]))

836 
dœty_i
->
Ä_dœty
[
t
]--;

838 ià(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
Œue
) == 0) {

839 
	`ş—r_b™
(
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
),

840 
dœty_i
->
viùim_£cm­
);

841 #ifdeà
CONFIG_F2FS_CHECK_FS


842 
	`ş—r_b™
(
£gno
, 
	`SIT_I
(
sbi
)->
šv®id_£gm­
);

846 
	}
}

853 
	$loÿ‹_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

855 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

856 
v®id_blocks
, 
ck±_v®id_blocks
;

858 ià(
£gno
 =ğ
NULL_SEGNO
 || 
	`IS_CURSEG
(
sbi
, segno))

861 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

863 
v®id_blocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
çl£
);

864 
ck±_v®id_blocks
 = 
	`g‘_ck±_v®id_blocks
(
sbi
, 
£gno
);

866 ià(
v®id_blocks
 =ğ0 && (!
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
) ||

867 
ck±_v®id_blocks
 =ğ
sbi
->
blocks_³r_£g
)) {

868 
	`__loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
, 
PRE
);

869 
	`__»move_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

870 } ià(
v®id_blocks
 < 
sbi
->
blocks_³r_£g
) {

871 
	`__loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

874 
	`__»move_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

877 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

878 
	}
}

881 
	$f2fs_dœty_to_´eä“
(
f2fs_sb_šfo
 *
sbi
)

883 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

884 
£gno
;

886 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

887 
	`fÜ_—ch_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
DIRTY
], 
	`MAIN_SEGS
(
sbi
)) {

888 ià(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
çl£
))

890 ià(
	`IS_CURSEG
(
sbi
, 
£gno
))

892 
	`__loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
, 
PRE
);

893 
	`__»move_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

895 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

896 
	}
}

898 
block_t
 
	$f2fs_g‘_unu§bË_blocks
(
f2fs_sb_šfo
 *
sbi
)

900 
ovp_hŞe_£gs
 =

901 (
	`ov”´ovisiÚ_£gm’ts
(
sbi
è- 
	`»£rved_£gm’ts
(sbi));

902 
block_t
 
ovp_hŞes
 = 
ovp_hŞe_£gs
 << 
sbi
->
log_blocks_³r_£g
;

903 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

904 
block_t
 
hŞes
[2] = {0, 0};

905 
block_t
 
unu§bË
;

906 
£g_’Œy
 *
£
;

907 
£gno
;

909 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

910 
	`fÜ_—ch_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
DIRTY
], 
	`MAIN_SEGS
(
sbi
)) {

911 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

912 ià(
	`IS_NODESEG
(
£
->
ty³
))

913 
hŞes
[
NODE
] +ğ
sbi
->
blocks_³r_£g
 - 
£
->
v®id_blocks
;

915 
hŞes
[
DATA
] +ğ
sbi
->
blocks_³r_£g
 - 
£
->
v®id_blocks
;

917 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

919 
unu§bË
 = 
hŞes
[
DATA
] > hŞes[
NODE
] ? holes[DATA] : holes[NODE];

920 ià(
unu§bË
 > 
ovp_hŞes
)

921  
unu§bË
 - 
ovp_hŞes
;

923 
	}
}

925 
	$f2fs_di§bË_ı_agaš
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
unu§bË
)

927 
ovp_hŞe_£gs
 =

928 (
	`ov”´ovisiÚ_£gm’ts
(
sbi
è- 
	`»£rved_£gm’ts
(sbi));

929 ià(
unu§bË
 > 
	`F2FS_OPTION
(
sbi
).
unu§bË_ÿp
)

930  -
EAGAIN
;

931 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED_QUICK
) &&

932 
	`dœty_£gm’ts
(
sbi
è> 
ovp_hŞe_£gs
)

933  -
EAGAIN
;

935 
	}
}

938 
	$g‘_ä“_£gm’t
(
f2fs_sb_šfo
 *
sbi
)

940 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

941 
£gno
 = 0;

943 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

944 
	`fÜ_—ch_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
DIRTY
], 
	`MAIN_SEGS
(
sbi
)) {

945 ià(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
çl£
))

947 ià(
	`g‘_ck±_v®id_blocks
(
sbi
, 
£gno
))

949 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

950  
£gno
;

952 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

953  
NULL_SEGNO
;

954 
	}
}

956 
disÿrd_cmd
 *
	$__ü—‹_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

957 
block_deviû
 *
bdev
, 
block_t
 
l¡¬t
,

958 
block_t
 
¡¬t
, block_ˆ
Ën
)

960 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

961 
li¡_h—d
 *
³nd_li¡
;

962 
disÿrd_cmd
 *
dc
;

964 
	`f2fs_bug_Ú
(
sbi
, !
Ën
);

966 
³nd_li¡
 = &
dcc
->³nd_li¡[
	`¶i¡_idx
(
Ën
)];

968 
dc
 = 
	`f2fs_kmem_ÿche_®loc
(
disÿrd_cmd_¦ab
, 
GFP_NOFS
);

969 
	`INIT_LIST_HEAD
(&
dc
->
li¡
);

970 
dc
->
bdev
 = bdev;

971 
dc
->
l¡¬t
 =†start;

972 
dc
->
¡¬t
 = start;

973 
dc
->
Ën
 =†en;

974 
dc
->
»f
 = 0;

975 
dc
->
¡©e
 = 
D_PREP
;

976 
dc
->
queued
 = 0;

977 
dc
->
”rÜ
 = 0;

978 
	`š™_com¶‘iÚ
(&
dc
->
wa™
);

979 
	`li¡_add_
(&
dc
->
li¡
, 
³nd_li¡
);

980 
	`¥š_lock_š™
(&
dc
->
lock
);

981 
dc
->
bio_»f
 = 0;

982 
	`©omic_šc
(&
dcc
->
disÿrd_cmd_út
);

983 
dcc
->
undisÿrd_blks
 +ğ
Ën
;

985  
dc
;

986 
	}
}

988 
disÿrd_cmd
 *
	$__©ch_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

989 
block_deviû
 *
bdev
, 
block_t
 
l¡¬t
,

990 
block_t
 
¡¬t
, block_ˆ
Ën
,

991 
rb_node
 *
·»Á
, rb_nod**
p
,

992 
boŞ
 
Ëámo¡
)

994 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

995 
disÿrd_cmd
 *
dc
;

997 
dc
 = 
	`__ü—‹_disÿrd_cmd
(
sbi
, 
bdev
, 
l¡¬t
, 
¡¬t
, 
Ën
);

999 
	`rb_lšk_node
(&
dc
->
rb_node
, 
·»Á
, 
p
);

1000 
	`rb_š£¹_cŞÜ_ÿched
(&
dc
->
rb_node
, &
dcc
->
roÙ
, 
Ëámo¡
);

1002  
dc
;

1003 
	}
}

1005 
	$__d‘ach_disÿrd_cmd
(
disÿrd_cmd_cÚŒŞ
 *
dcc
,

1006 
disÿrd_cmd
 *
dc
)

1008 ià(
dc
->
¡©e
 =ğ
D_DONE
)

1009 
	`©omic_sub
(
dc
->
queued
, &
dcc
->
queued_disÿrd
);

1011 
	`li¡_d–
(&
dc
->
li¡
);

1012 
	`rb_”a£_ÿched
(&
dc
->
rb_node
, &
dcc
->
roÙ
);

1013 
dcc
->
undisÿrd_blks
 -ğ
dc
->
Ën
;

1015 
	`kmem_ÿche_ä“
(
disÿrd_cmd_¦ab
, 
dc
);

1017 
	`©omic_dec
(&
dcc
->
disÿrd_cmd_út
);

1018 
	}
}

1020 
	$__»move_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

1021 
disÿrd_cmd
 *
dc
)

1023 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1024 
æags
;

1026 
	`Œaû_f2fs_»move_disÿrd
(
dc
->
bdev
, dc->
¡¬t
, dc->
Ën
);

1028 
	`¥š_lock_œq§ve
(&
dc
->
lock
, 
æags
);

1029 ià(
dc
->
bio_»f
) {

1030 
	`¥š_uÆock_œq»¡Üe
(&
dc
->
lock
, 
æags
);

1033 
	`¥š_uÆock_œq»¡Üe
(&
dc
->
lock
, 
æags
);

1035 
	`f2fs_bug_Ú
(
sbi
, 
dc
->
»f
);

1037 ià(
dc
->
”rÜ
 =ğ-
EOPNOTSUPP
)

1038 
dc
->
”rÜ
 = 0;

1040 ià(
dc
->
”rÜ
)

1041 
	`´štk_¿‹lim™ed
(

1043 
KERN_INFO
, 
dc
->
l¡¬t
, dc->
¡¬t
, dc->
Ën
, dc->
”rÜ
);

1044 
	`__d‘ach_disÿrd_cmd
(
dcc
, 
dc
);

1045 
	}
}

1047 
	$f2fs_subm™_disÿrd_’dio
(
bio
 *bio)

1049 
disÿrd_cmd
 *
dc
 = (disÿrd_cmd *)
bio
->
bi_´iv©e
;

1050 
æags
;

1052 
dc
->
”rÜ
 = 
	`blk_¡©us_to_”ºo
(
bio
->
bi_¡©us
);

1054 
	`¥š_lock_œq§ve
(&
dc
->
lock
, 
æags
);

1055 
dc
->
bio_»f
--;

1056 ià(!
dc
->
bio_»f
 && dc->
¡©e
 =ğ
D_SUBMIT
) {

1057 
dc
->
¡©e
 = 
D_DONE
;

1058 
	`com¶‘e_®l
(&
dc
->
wa™
);

1060 
	`¥š_uÆock_œq»¡Üe
(&
dc
->
lock
, 
æags
);

1061 
	`bio_put
(
bio
);

1062 
	}
}

1064 
	$__check_s™_b™m­
(
f2fs_sb_šfo
 *
sbi
,

1065 
block_t
 
¡¬t
, block_ˆ
’d
)

1067 #ifdeà
CONFIG_F2FS_CHECK_FS


1068 
£g_’Œy
 *
£Áry
;

1069 
£gno
;

1070 
block_t
 
blk
 = 
¡¬t
;

1071 
off£t
, 
size
, 
max_blocks
 = 
sbi
->
blocks_³r_£g
;

1072 *
m­
;

1074 
blk
 < 
’d
) {

1075 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blk
);

1076 
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

1077 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blk
);

1079 ià(
’d
 < 
	`START_BLOCK
(
sbi
, 
£gno
 + 1))

1080 
size
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
’d
);

1082 
size
 = 
max_blocks
;

1083 
m­
 = (*)(
£Áry
->
cur_v®id_m­
);

1084 
off£t
 = 
	`__fšd_»v_Ãxt_b™
(
m­
, 
size
, offset);

1085 
	`f2fs_bug_Ú
(
sbi
, 
off£t
 !ğ
size
);

1086 
blk
 = 
	`START_BLOCK
(
sbi
, 
£gno
 + 1);

1089 
	}
}

1091 
	$__š™_disÿrd_pŞicy
(
f2fs_sb_šfo
 *
sbi
,

1092 
disÿrd_pŞicy
 *
dpŞicy
,

1093 
disÿrd_ty³
, 
g¿nuÏr™y
)

1096 
dpŞicy
->
ty³
 = 
disÿrd_ty³
;

1097 
dpŞicy
->
sync
 = 
Œue
;

1098 
dpŞicy
->
Üd”ed
 = 
çl£
;

1099 
dpŞicy
->
g¿nuÏr™y
 = granularity;

1101 
dpŞicy
->
max_»que¡s
 = 
DEF_MAX_DISCARD_REQUEST
;

1102 
dpŞicy
->
io_aw¬e_g¿n
 = 
MAX_PLIST_NUM
;

1103 
dpŞicy
->
timeout
 = 0;

1105 ià(
disÿrd_ty³
 =ğ
DPOLICY_BG
) {

1106 
dpŞicy
->
mš_š‹rv®
 = 
DEF_MIN_DISCARD_ISSUE_TIME
;

1107 
dpŞicy
->
mid_š‹rv®
 = 
DEF_MID_DISCARD_ISSUE_TIME
;

1108 
dpŞicy
->
max_š‹rv®
 = 
DEF_MAX_DISCARD_ISSUE_TIME
;

1109 
dpŞicy
->
io_aw¬e
 = 
Œue
;

1110 
dpŞicy
->
sync
 = 
çl£
;

1111 
dpŞicy
->
Üd”ed
 = 
Œue
;

1112 ià(
	`utiz©iÚ
(
sbi
è> 
DEF_DISCARD_URGENT_UTIL
) {

1113 
dpŞicy
->
g¿nuÏr™y
 = 1;

1114 
dpŞicy
->
max_š‹rv®
 = 
DEF_MIN_DISCARD_ISSUE_TIME
;

1116 } ià(
disÿrd_ty³
 =ğ
DPOLICY_FORCE
) {

1117 
dpŞicy
->
mš_š‹rv®
 = 
DEF_MIN_DISCARD_ISSUE_TIME
;

1118 
dpŞicy
->
mid_š‹rv®
 = 
DEF_MID_DISCARD_ISSUE_TIME
;

1119 
dpŞicy
->
max_š‹rv®
 = 
DEF_MAX_DISCARD_ISSUE_TIME
;

1120 
dpŞicy
->
io_aw¬e
 = 
çl£
;

1121 } ià(
disÿrd_ty³
 =ğ
DPOLICY_FSTRIM
) {

1122 
dpŞicy
->
io_aw¬e
 = 
çl£
;

1123 } ià(
disÿrd_ty³
 =ğ
DPOLICY_UMOUNT
) {

1124 
dpŞicy
->
max_»que¡s
 = 
UINT_MAX
;

1125 
dpŞicy
->
io_aw¬e
 = 
çl£
;

1127 
dpŞicy
->
g¿nuÏr™y
 = 1;

1129 
	}
}

1131 
__upd©e_disÿrd_Œ“_¿nge
(
f2fs_sb_šfo
 *
sbi
,

1132 
block_deviû
 *
bdev
, 
block_t
 
l¡¬t
,

1133 
block_t
 
¡¬t
, block_ˆ
Ën
);

1135 
	$__subm™_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

1136 
disÿrd_pŞicy
 *
dpŞicy
,

1137 
disÿrd_cmd
 *
dc
,

1138 *
issued
)

1140 
block_deviû
 *
bdev
 = 
dc
->bdev;

1141 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
bdev
);

1142 
max_disÿrd_blocks
 =

1143 
	`SECTOR_TO_BLOCK
(
q
->
lim™s
.
max_disÿrd_£ùÜs
);

1144 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1145 
li¡_h—d
 *
wa™_li¡
 = (
dpŞicy
->
ty³
 =ğ
DPOLICY_FSTRIM
) ?

1146 &(
dcc
->
f¡rim_li¡
è: &(dcc->
wa™_li¡
);

1147 
æag
 = 
dpŞicy
->
sync
 ? 
REQ_SYNC
 : 0;

1148 
block_t
 
l¡¬t
, 
¡¬t
, 
Ën
, 
tÙ®_Ën
;

1149 
”r
 = 0;

1151 ià(
dc
->
¡©e
 !ğ
D_PREP
)

1154 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_FSCK
))

1157 
	`Œaû_f2fs_issue_disÿrd
(
bdev
, 
dc
->
¡¬t
, dc->
Ën
);

1159 
l¡¬t
 = 
dc
->lstart;

1160 
¡¬t
 = 
dc
->start;

1161 
Ën
 = 
dc
->len;

1162 
tÙ®_Ën
 = 
Ën
;

1164 
dc
->
Ën
 = 0;

1166 
tÙ®_Ën
 && *
issued
 < 
dpŞicy
->
max_»que¡s
 && !
”r
) {

1167 
bio
 *biØğ
NULL
;

1168 
æags
;

1169 
boŞ
 
Ï¡
 = 
Œue
;

1171 ià(
Ën
 > 
max_disÿrd_blocks
) {

1172 
Ën
 = 
max_disÿrd_blocks
;

1173 
Ï¡
 = 
çl£
;

1176 (*
issued
)++;

1177 ià(*
issued
 =ğ
dpŞicy
->
max_»que¡s
)

1178 
Ï¡
 = 
Œue
;

1180 
dc
->
Ën
 +=†en;

1182 ià(
	`time_to_šjeù
(
sbi
, 
FAULT_DISCARD
)) {

1183 
	`f2fs_show_šjeùiÚ_šfo
(
FAULT_DISCARD
);

1184 
”r
 = -
EIO
;

1185 
subm™
;

1187 
”r
 = 
	`__blkdev_issue_disÿrd
(
bdev
,

1188 
	`SECTOR_FROM_BLOCK
(
¡¬t
),

1189 
	`SECTOR_FROM_BLOCK
(
Ën
),

1190 
GFP_NOFS
, 0, &
bio
);

1191 
subm™
:

1192 ià(
”r
) {

1193 
	`¥š_lock_œq§ve
(&
dc
->
lock
, 
æags
);

1194 ià(
dc
->
¡©e
 =ğ
D_PARTIAL
)

1195 
dc
->
¡©e
 = 
D_SUBMIT
;

1196 
	`¥š_uÆock_œq»¡Üe
(&
dc
->
lock
, 
æags
);

1201 
	`f2fs_bug_Ú
(
sbi
, !
bio
);

1207 
	`¥š_lock_œq§ve
(&
dc
->
lock
, 
æags
);

1208 ià(
Ï¡
)

1209 
dc
->
¡©e
 = 
D_SUBMIT
;

1211 
dc
->
¡©e
 = 
D_PARTIAL
;

1212 
dc
->
bio_»f
++;

1213 
	`¥š_uÆock_œq»¡Üe
(&
dc
->
lock
, 
æags
);

1215 
	`©omic_šc
(&
dcc
->
queued_disÿrd
);

1216 
dc
->
queued
++;

1217 
	`li¡_move_
(&
dc
->
li¡
, 
wa™_li¡
);

1220 
	`__check_s™_b™m­
(
sbi
, 
l¡¬t
,†¡¬ˆ+ 
Ën
);

1222 
bio
->
bi_´iv©e
 = 
dc
;

1223 
bio
->
bi_’d_io
 = 
f2fs_subm™_disÿrd_’dio
;

1224 
bio
->
bi_İf
 |ğ
æag
;

1225 
	`subm™_bio
(
bio
);

1227 
	`©omic_šc
(&
dcc
->
issued_disÿrd
);

1229 
	`f2fs_upd©e_io¡©
(
sbi
, 
FS_DISCARD
, 1);

1231 
l¡¬t
 +ğ
Ën
;

1232 
¡¬t
 +ğ
Ën
;

1233 
tÙ®_Ën
 -ğ
Ën
;

1234 
Ën
 = 
tÙ®_Ën
;

1237 ià(!
”r
 && 
Ën
)

1238 
	`__upd©e_disÿrd_Œ“_¿nge
(
sbi
, 
bdev
, 
l¡¬t
, 
¡¬t
, 
Ën
);

1239  
”r
;

1240 
	}
}

1242 
disÿrd_cmd
 *
	$__š£¹_disÿrd_Œ“
(
f2fs_sb_šfo
 *
sbi
,

1243 
block_deviû
 *
bdev
, 
block_t
 
l¡¬t
,

1244 
block_t
 
¡¬t
, block_ˆ
Ën
,

1245 
rb_node
 **
š£¹_p
,

1246 
rb_node
 *
š£¹_·»Á
)

1248 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1249 
rb_node
 **
p
;

1250 
rb_node
 *
·»Á
 = 
NULL
;

1251 
disÿrd_cmd
 *
dc
 = 
NULL
;

1252 
boŞ
 
Ëámo¡
 = 
Œue
;

1254 ià(
š£¹_p
 && 
š£¹_·»Á
) {

1255 
·»Á
 = 
š£¹_·»Á
;

1256 
p
 = 
š£¹_p
;

1257 
do_š£¹
;

1260 
p
 = 
	`f2fs_lookup_rb_Œ“_fÜ_š£¹
(
sbi
, &
dcc
->
roÙ
, &
·»Á
,

1261 
l¡¬t
, &
Ëámo¡
);

1262 
do_š£¹
:

1263 
dc
 = 
	`__©ch_disÿrd_cmd
(
sbi
, 
bdev
, 
l¡¬t
, 
¡¬t
, 
Ën
, 
·»Á
,

1264 
p
, 
Ëámo¡
);

1265 ià(!
dc
)

1266  
NULL
;

1268  
dc
;

1269 
	}
}

1271 
	$__»loÿ‹_disÿrd_cmd
(
disÿrd_cmd_cÚŒŞ
 *
dcc
,

1272 
disÿrd_cmd
 *
dc
)

1274 
	`li¡_move_
(&
dc
->
li¡
, &
dcc
->
³nd_li¡
[
	`¶i¡_idx
(dc->
Ën
)]);

1275 
	}
}

1277 
	$__punch_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

1278 
disÿrd_cmd
 *
dc
, 
block_t
 
blkaddr
)

1280 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1281 
disÿrd_šfo
 
di
 = 
dc
->di;

1282 
boŞ
 
modif›d
 = 
çl£
;

1284 ià(
dc
->
¡©e
 =ğ
D_DONE
 || dc->
Ën
 == 1) {

1285 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

1289 
dcc
->
undisÿrd_blks
 -ğ
di
.
Ën
;

1291 ià(
blkaddr
 > 
di
.
l¡¬t
) {

1292 
dc
->
Ën
 = 
blkaddr
 - dc->
l¡¬t
;

1293 
dcc
->
undisÿrd_blks
 +ğ
dc
->
Ën
;

1294 
	`__»loÿ‹_disÿrd_cmd
(
dcc
, 
dc
);

1295 
modif›d
 = 
Œue
;

1298 ià(
blkaddr
 < 
di
.
l¡¬t
 + di.
Ën
 - 1) {

1299 ià(
modif›d
) {

1300 
	`__š£¹_disÿrd_Œ“
(
sbi
, 
dc
->
bdev
, 
blkaddr
 + 1,

1301 
di
.
¡¬t
 + 
blkaddr
 + 1 - di.
l¡¬t
,

1302 
di
.
l¡¬t
 + di.
Ën
 - 1 - 
blkaddr
,

1303 
NULL
, NULL);

1305 
dc
->
l¡¬t
++;

1306 
dc
->
Ën
--;

1307 
dc
->
¡¬t
++;

1308 
dcc
->
undisÿrd_blks
 +ğ
dc
->
Ën
;

1309 
	`__»loÿ‹_disÿrd_cmd
(
dcc
, 
dc
);

1312 
	}
}

1314 
	$__upd©e_disÿrd_Œ“_¿nge
(
f2fs_sb_šfo
 *
sbi
,

1315 
block_deviû
 *
bdev
, 
block_t
 
l¡¬t
,

1316 
block_t
 
¡¬t
, block_ˆ
Ën
)

1318 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1319 
disÿrd_cmd
 *
´ev_dc
 = 
NULL
, *
Ãxt_dc
 = NULL;

1320 
disÿrd_cmd
 *
dc
;

1321 
disÿrd_šfo
 
di
 = {0};

1322 
rb_node
 **
š£¹_p
 = 
NULL
, *
š£¹_·»Á
 = NULL;

1323 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
bdev
);

1324 
max_disÿrd_blocks
 =

1325 
	`SECTOR_TO_BLOCK
(
q
->
lim™s
.
max_disÿrd_£ùÜs
);

1326 
block_t
 
’d
 = 
l¡¬t
 + 
Ën
;

1328 
dc
 = (
disÿrd_cmd
 *)
	`f2fs_lookup_rb_Œ“_»t
(&
dcc
->
roÙ
,

1329 
NULL
, 
l¡¬t
,

1330 (
rb_’Œy
 **)&
´ev_dc
,

1331 (
rb_’Œy
 **)&
Ãxt_dc
,

1332 &
š£¹_p
, &
š£¹_·»Á
, 
Œue
, 
NULL
);

1333 ià(
dc
)

1334 
´ev_dc
 = 
dc
;

1336 ià(!
´ev_dc
) {

1337 
di
.
l¡¬t
 =†start;

1338 
di
.
Ën
 = 
Ãxt_dc
 ?‚ext_dc->
l¡¬t
 -†start :†en;

1339 
di
.
Ën
 = 
	`mš
(di.len,†en);

1340 
di
.
¡¬t
 = start;

1344 
rb_node
 *
node
;

1345 
boŞ
 
m”ged
 = 
çl£
;

1346 
disÿrd_cmd
 *
tdc
 = 
NULL
;

1348 ià(
´ev_dc
) {

1349 
di
.
l¡¬t
 = 
´ev_dc
->l¡¬ˆ+…»v_dc->
Ën
;

1350 ià(
di
.
l¡¬t
 <†start)

1351 
di
.
l¡¬t
 =†start;

1352 ià(
di
.
l¡¬t
 >ğ
’d
)

1355 ià(!
Ãxt_dc
 ||‚ext_dc->
l¡¬t
 > 
’d
)

1356 
di
.
Ën
 = 
’d
 - di.
l¡¬t
;

1358 
di
.
Ën
 = 
Ãxt_dc
->
l¡¬t
 - di.lstart;

1359 
di
.
¡¬t
 = s¹ + di.
l¡¬t
 -†start;

1362 ià(!
di
.
Ën
)

1363 
Ãxt
;

1365 ià(
´ev_dc
 &&…»v_dc->
¡©e
 =ğ
D_PREP
 &&

1366 
´ev_dc
->
bdev
 == bdev &&

1367 
	`__is_disÿrd_back_m”g—bË
(&
di
, &
´ev_dc
->di,

1368 
max_disÿrd_blocks
)) {

1369 
´ev_dc
->
di
.
Ën
 += di.len;

1370 
dcc
->
undisÿrd_blks
 +ğ
di
.
Ën
;

1371 
	`__»loÿ‹_disÿrd_cmd
(
dcc
, 
´ev_dc
);

1372 
di
 = 
´ev_dc
->di;

1373 
tdc
 = 
´ev_dc
;

1374 
m”ged
 = 
Œue
;

1377 ià(
Ãxt_dc
 &&‚ext_dc->
¡©e
 =ğ
D_PREP
 &&

1378 
Ãxt_dc
->
bdev
 == bdev &&

1379 
	`__is_disÿrd_äÚt_m”g—bË
(&
di
, &
Ãxt_dc
->di,

1380 
max_disÿrd_blocks
)) {

1381 
Ãxt_dc
->
di
.
l¡¬t
 = di.lstart;

1382 
Ãxt_dc
->
di
.
Ën
 += di.len;

1383 
Ãxt_dc
->
di
.
¡¬t
 = di.start;

1384 
dcc
->
undisÿrd_blks
 +ğ
di
.
Ën
;

1385 
	`__»loÿ‹_disÿrd_cmd
(
dcc
, 
Ãxt_dc
);

1386 ià(
tdc
)

1387 
	`__»move_disÿrd_cmd
(
sbi
, 
tdc
);

1388 
m”ged
 = 
Œue
;

1391 ià(!
m”ged
) {

1392 
	`__š£¹_disÿrd_Œ“
(
sbi
, 
bdev
, 
di
.
l¡¬t
, di.
¡¬t
,

1393 
di
.
Ën
, 
NULL
, NULL);

1395 
Ãxt
:

1396 
´ev_dc
 = 
Ãxt_dc
;

1397 ià(!
´ev_dc
)

1400 
node
 = 
	`rb_Ãxt
(&
´ev_dc
->
rb_node
);

1401 
Ãxt_dc
 = 
	`rb_’Œy_§ã
(
node
, 
disÿrd_cmd
, 
rb_node
);

1403 
	}
}

1405 
	$__queue_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

1406 
block_deviû
 *
bdev
, 
block_t
 
blk¡¬t
, block_ˆ
blkËn
)

1408 
block_t
 
lblk¡¬t
 = 
blk¡¬t
;

1410 ià(!
	`f2fs_bdev_suµÜt_disÿrd
(
bdev
))

1413 
	`Œaû_f2fs_queue_disÿrd
(
bdev
, 
blk¡¬t
, 
blkËn
);

1415 ià(
	`f2fs_is_muÉi_deviû
(
sbi
)) {

1416 
devi
 = 
	`f2fs_rg‘_deviû_šdex
(
sbi
, 
blk¡¬t
);

1418 
blk¡¬t
 -ğ
	`FDEV
(
devi
).
¡¬t_blk
;

1420 
	`mu‹x_lock
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
cmd_lock
);

1421 
	`__upd©e_disÿrd_Œ“_¿nge
(
sbi
, 
bdev
, 
lblk¡¬t
, 
blk¡¬t
, 
blkËn
);

1422 
	`mu‹x_uÆock
(&
	`SM_I
(
sbi
)->
dcc_šfo
->
cmd_lock
);

1424 
	}
}

1426 
	$__issue_disÿrd_cmd_Üd”ly
(
f2fs_sb_šfo
 *
sbi
,

1427 
disÿrd_pŞicy
 *
dpŞicy
)

1429 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1430 
disÿrd_cmd
 *
´ev_dc
 = 
NULL
, *
Ãxt_dc
 = NULL;

1431 
rb_node
 **
š£¹_p
 = 
NULL
, *
š£¹_·»Á
 = NULL;

1432 
disÿrd_cmd
 *
dc
;

1433 
blk_¶ug
 
¶ug
;

1434 
pos
 = 
dcc
->
Ãxt_pos
;

1435 
issued
 = 0;

1436 
boŞ
 
io_š‹¼u±ed
 = 
çl£
;

1438 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1439 
dc
 = (
disÿrd_cmd
 *)
	`f2fs_lookup_rb_Œ“_»t
(&
dcc
->
roÙ
,

1440 
NULL
, 
pos
,

1441 (
rb_’Œy
 **)&
´ev_dc
,

1442 (
rb_’Œy
 **)&
Ãxt_dc
,

1443 &
š£¹_p
, &
š£¹_·»Á
, 
Œue
, 
NULL
);

1444 ià(!
dc
)

1445 
dc
 = 
Ãxt_dc
;

1447 
	`blk_¡¬t_¶ug
(&
¶ug
);

1449 
dc
) {

1450 
rb_node
 *
node
;

1451 
”r
 = 0;

1453 ià(
dc
->
¡©e
 !ğ
D_PREP
)

1454 
Ãxt
;

1456 ià(
dpŞicy
->
io_aw¬e
 && !
	`is_idË
(
sbi
, 
DISCARD_TIME
)) {

1457 
io_š‹¼u±ed
 = 
Œue
;

1461 
dcc
->
Ãxt_pos
 = 
dc
->
l¡¬t
 + dc->
Ën
;

1462 
”r
 = 
	`__subm™_disÿrd_cmd
(
sbi
, 
dpŞicy
, 
dc
, &
issued
);

1464 ià(
issued
 >ğ
dpŞicy
->
max_»que¡s
)

1466 
Ãxt
:

1467 
node
 = 
	`rb_Ãxt
(&
dc
->
rb_node
);

1468 ià(
”r
)

1469 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

1470 
dc
 = 
	`rb_’Œy_§ã
(
node
, 
disÿrd_cmd
, 
rb_node
);

1473 
	`blk_fšish_¶ug
(&
¶ug
);

1475 ià(!
dc
)

1476 
dcc
->
Ãxt_pos
 = 0;

1478 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1480 ià(!
issued
 && 
io_š‹¼u±ed
)

1481 
issued
 = -1;

1483  
issued
;

1484 
	}
}

1486 
	$__issue_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

1487 
disÿrd_pŞicy
 *
dpŞicy
)

1489 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1490 
li¡_h—d
 *
³nd_li¡
;

1491 
disÿrd_cmd
 *
dc
, *
tmp
;

1492 
blk_¶ug
 
¶ug
;

1493 
i
, 
issued
 = 0;

1494 
boŞ
 
io_š‹¼u±ed
 = 
çl£
;

1496 ià(
dpŞicy
->
timeout
 != 0)

1497 
	`f2fs_upd©e_time
(
sbi
, 
dpŞicy
->
timeout
);

1499 
i
 = 
MAX_PLIST_NUM
 - 1; i >= 0; i--) {

1500 ià(
dpŞicy
->
timeout
 != 0 &&

1501 
	`f2fs_time_ov”
(
sbi
, 
dpŞicy
->
timeout
))

1504 ià(
i
 + 1 < 
dpŞicy
->
g¿nuÏr™y
)

1507 ià(
i
 < 
DEFAULT_DISCARD_GRANULARITY
 && 
dpŞicy
->
Üd”ed
)

1508  
	`__issue_disÿrd_cmd_Üd”ly
(
sbi
, 
dpŞicy
);

1510 
³nd_li¡
 = &
dcc
->³nd_li¡[
i
];

1512 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1513 ià(
	`li¡_em±y
(
³nd_li¡
))

1514 
Ãxt
;

1515 ià(
	`uÆik–y
(
dcc
->
rbŒ“_check
))

1516 
	`f2fs_bug_Ú
(
sbi
, !
	`f2fs_check_rb_Œ“_cÚsi¡’û
(sbi,

1517 &
dcc
->
roÙ
));

1518 
	`blk_¡¬t_¶ug
(&
¶ug
);

1519 
	`li¡_fÜ_—ch_’Œy_§ã
(
dc
, 
tmp
, 
³nd_li¡
, 
li¡
) {

1520 
	`f2fs_bug_Ú
(
sbi
, 
dc
->
¡©e
 !ğ
D_PREP
);

1522 ià(
dpŞicy
->
timeout
 != 0 &&

1523 
	`f2fs_time_ov”
(
sbi
, 
dpŞicy
->
timeout
))

1526 ià(
dpŞicy
->
io_aw¬e
 && 
i
 < dpŞicy->
io_aw¬e_g¿n
 &&

1527 !
	`is_idË
(
sbi
, 
DISCARD_TIME
)) {

1528 
io_š‹¼u±ed
 = 
Œue
;

1532 
	`__subm™_disÿrd_cmd
(
sbi
, 
dpŞicy
, 
dc
, &
issued
);

1534 ià(
issued
 >ğ
dpŞicy
->
max_»que¡s
)

1537 
	`blk_fšish_¶ug
(&
¶ug
);

1538 
Ãxt
:

1539 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1541 ià(
issued
 >ğ
dpŞicy
->
max_»que¡s
 || 
io_š‹¼u±ed
)

1545 ià(!
issued
 && 
io_š‹¼u±ed
)

1546 
issued
 = -1;

1548  
issued
;

1549 
	}
}

1551 
boŞ
 
	$__drİ_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
)

1553 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1554 
li¡_h—d
 *
³nd_li¡
;

1555 
disÿrd_cmd
 *
dc
, *
tmp
;

1556 
i
;

1557 
boŞ
 
drİ³d
 = 
çl£
;

1559 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1560 
i
 = 
MAX_PLIST_NUM
 - 1; i >= 0; i--) {

1561 
³nd_li¡
 = &
dcc
->³nd_li¡[
i
];

1562 
	`li¡_fÜ_—ch_’Œy_§ã
(
dc
, 
tmp
, 
³nd_li¡
, 
li¡
) {

1563 
	`f2fs_bug_Ú
(
sbi
, 
dc
->
¡©e
 !ğ
D_PREP
);

1564 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

1565 
drİ³d
 = 
Œue
;

1568 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1570  
drİ³d
;

1571 
	}
}

1573 
	$f2fs_drİ_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
)

1575 
	`__drİ_disÿrd_cmd
(
sbi
);

1576 
	}
}

1578 
	$__wa™_Úe_disÿrd_bio
(
f2fs_sb_šfo
 *
sbi
,

1579 
disÿrd_cmd
 *
dc
)

1581 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1582 
Ën
 = 0;

1584 
	`wa™_fÜ_com¶‘iÚ_io
(&
dc
->
wa™
);

1585 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1586 
	`f2fs_bug_Ú
(
sbi
, 
dc
->
¡©e
 !ğ
D_DONE
);

1587 
dc
->
»f
--;

1588 ià(!
dc
->
»f
) {

1589 ià(!
dc
->
”rÜ
)

1590 
Ën
 = 
dc
->len;

1591 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

1593 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1595  
Ën
;

1596 
	}
}

1598 
	$__wa™_disÿrd_cmd_¿nge
(
f2fs_sb_šfo
 *
sbi
,

1599 
disÿrd_pŞicy
 *
dpŞicy
,

1600 
block_t
 
¡¬t
, block_ˆ
’d
)

1602 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1603 
li¡_h—d
 *
wa™_li¡
 = (
dpŞicy
->
ty³
 =ğ
DPOLICY_FSTRIM
) ?

1604 &(
dcc
->
f¡rim_li¡
è: &(dcc->
wa™_li¡
);

1605 
disÿrd_cmd
 *
dc
, *
tmp
;

1606 
boŞ
 
Ãed_wa™
;

1607 
Œimmed
 = 0;

1609 
Ãxt
:

1610 
Ãed_wa™
 = 
çl£
;

1612 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1613 
	`li¡_fÜ_—ch_’Œy_§ã
(
dc
, 
tmp
, 
wa™_li¡
, 
li¡
) {

1614 ià(
dc
->
l¡¬t
 + dc->
Ën
 <ğ
¡¬t
 || 
’d
 <= dc->lstart)

1616 ià(
dc
->
Ën
 < 
dpŞicy
->
g¿nuÏr™y
)

1618 ià(
dc
->
¡©e
 =ğ
D_DONE
 && !dc->
»f
) {

1619 
	`wa™_fÜ_com¶‘iÚ_io
(&
dc
->
wa™
);

1620 ià(!
dc
->
”rÜ
)

1621 
Œimmed
 +ğ
dc
->
Ën
;

1622 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

1624 
dc
->
»f
++;

1625 
Ãed_wa™
 = 
Œue
;

1629 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1631 ià(
Ãed_wa™
) {

1632 
Œimmed
 +ğ
	`__wa™_Úe_disÿrd_bio
(
sbi
, 
dc
);

1633 
Ãxt
;

1636  
Œimmed
;

1637 
	}
}

1639 
	$__wa™_®l_disÿrd_cmd
(
f2fs_sb_šfo
 *
sbi
,

1640 
disÿrd_pŞicy
 *
dpŞicy
)

1642 
disÿrd_pŞicy
 
dp
;

1643 
disÿrd_blks
;

1645 ià(
dpŞicy
)

1646  
	`__wa™_disÿrd_cmd_¿nge
(
sbi
, 
dpŞicy
, 0, 
UINT_MAX
);

1649 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dp
, 
DPOLICY_FSTRIM
, 1);

1650 
disÿrd_blks
 = 
	`__wa™_disÿrd_cmd_¿nge
(
sbi
, &
dp
, 0, 
UINT_MAX
);

1651 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dp
, 
DPOLICY_UMOUNT
, 1);

1652 
disÿrd_blks
 +ğ
	`__wa™_disÿrd_cmd_¿nge
(
sbi
, &
dp
, 0, 
UINT_MAX
);

1654  
disÿrd_blks
;

1655 
	}
}

1658 
	$f2fs_wa™_disÿrd_bio
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

1660 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1661 
disÿrd_cmd
 *
dc
;

1662 
boŞ
 
Ãed_wa™
 = 
çl£
;

1664 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

1665 
dc
 = (
disÿrd_cmd
 *)
	`f2fs_lookup_rb_Œ“
(&
dcc
->
roÙ
,

1666 
NULL
, 
blkaddr
);

1667 ià(
dc
) {

1668 ià(
dc
->
¡©e
 =ğ
D_PREP
) {

1669 
	`__punch_disÿrd_cmd
(
sbi
, 
dc
, 
blkaddr
);

1671 
dc
->
»f
++;

1672 
Ãed_wa™
 = 
Œue
;

1675 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

1677 ià(
Ãed_wa™
)

1678 
	`__wa™_Úe_disÿrd_bio
(
sbi
, 
dc
);

1679 
	}
}

1681 
	$f2fs_¡İ_disÿrd_th»ad
(
f2fs_sb_šfo
 *
sbi
)

1683 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1685 ià(
dcc
 && dcc->
f2fs_issue_disÿrd
) {

1686 
sk_¡ruù
 *
disÿrd_th»ad
 = 
dcc
->
f2fs_issue_disÿrd
;

1688 
dcc
->
f2fs_issue_disÿrd
 = 
NULL
;

1689 
	`kth»ad_¡İ
(
disÿrd_th»ad
);

1691 
	}
}

1694 
boŞ
 
	$f2fs_issue_disÿrd_timeout
(
f2fs_sb_šfo
 *
sbi
)

1696 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1697 
disÿrd_pŞicy
 
dpŞicy
;

1698 
boŞ
 
drİ³d
;

1700 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dpŞicy
, 
DPOLICY_UMOUNT
,

1701 
dcc
->
disÿrd_g¿nuÏr™y
);

1702 
dpŞicy
.
timeout
 = 
UMOUNT_DISCARD_TIMEOUT
;

1703 
	`__issue_disÿrd_cmd
(
sbi
, &
dpŞicy
);

1704 
drİ³d
 = 
	`__drİ_disÿrd_cmd
(
sbi
);

1707 
	`__wa™_®l_disÿrd_cmd
(
sbi
, 
NULL
);

1709 
	`f2fs_bug_Ú
(
sbi
, 
	`©omic_»ad
(&
dcc
->
disÿrd_cmd_út
));

1710  
drİ³d
;

1711 
	}
}

1713 
	$issue_disÿrd_th»ad
(*
d©a
)

1715 
f2fs_sb_šfo
 *
sbi
 = 
d©a
;

1716 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1717 
wa™_queue_h—d_t
 *
q
 = &
dcc
->
disÿrd_wa™_queue
;

1718 
disÿrd_pŞicy
 
dpŞicy
;

1719 
wa™_ms
 = 
DEF_MIN_DISCARD_ISSUE_TIME
;

1720 
issued
;

1722 
	`£t_ä“zabË
();

1725 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dpŞicy
, 
DPOLICY_BG
,

1726 
dcc
->
disÿrd_g¿nuÏr™y
);

1728 
	`wa™_ev’t_š‹¼u±ibË_timeout
(*
q
,

1729 
	`kth»ad_should_¡İ
(è|| 
	`ä“zšg
(
cu¼’t
) ||

1730 
dcc
->
disÿrd_wake
,

1731 
	`m£cs_to_jiff›s
(
wa™_ms
));

1733 ià(
dcc
->
disÿrd_wake
)

1734 
dcc
->
disÿrd_wake
 = 0;

1737 ià(
	`©omic_»ad
(&
dcc
->
queued_disÿrd
))

1738 
	`__wa™_®l_disÿrd_cmd
(
sbi
, 
NULL
);

1740 ià(
	`Œy_to_ä“ze
())

1742 ià(
	`f2fs_»adÚly
(
sbi
->
sb
))

1744 ià(
	`kth»ad_should_¡İ
())

1746 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_FSCK
)) {

1747 
wa™_ms
 = 
dpŞicy
.
max_š‹rv®
;

1751 ià(
sbi
->
gc_mode
 =ğ
GC_URGENT
)

1752 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dpŞicy
, 
DPOLICY_FORCE
, 1);

1754 
	`sb_¡¬t_štwr™e
(
sbi
->
sb
);

1756 
issued
 = 
	`__issue_disÿrd_cmd
(
sbi
, &
dpŞicy
);

1757 ià(
issued
 > 0) {

1758 
	`__wa™_®l_disÿrd_cmd
(
sbi
, &
dpŞicy
);

1759 
wa™_ms
 = 
dpŞicy
.
mš_š‹rv®
;

1760 } ià(
issued
 == -1){

1761 
wa™_ms
 = 
	`f2fs_time_to_wa™
(
sbi
, 
DISCARD_TIME
);

1762 ià(!
wa™_ms
)

1763 
wa™_ms
 = 
dpŞicy
.
mid_š‹rv®
;

1765 
wa™_ms
 = 
dpŞicy
.
max_š‹rv®
;

1768 
	`sb_’d_štwr™e
(
sbi
->
sb
);

1770 } !
	`kth»ad_should_¡İ
());

1772 
	}
}

1774 #ifdeà
CONFIG_BLK_DEV_ZONED


1775 
	$__f2fs_issue_disÿrd_zÚe
(
f2fs_sb_šfo
 *
sbi
,

1776 
block_deviû
 *
bdev
, 
block_t
 
blk¡¬t
, block_ˆ
blkËn
)

1778 
£ùÜ_t
 
£ùÜ
, 
Ä_£ùs
;

1779 
block_t
 
lblk¡¬t
 = 
blk¡¬t
;

1780 
devi
 = 0;

1782 ià(
	`f2fs_is_muÉi_deviû
(
sbi
)) {

1783 
devi
 = 
	`f2fs_rg‘_deviû_šdex
(
sbi
, 
blk¡¬t
);

1784 ià(
blk¡¬t
 < 
	`FDEV
(
devi
).
¡¬t_blk
 ||

1785 
blk¡¬t
 > 
	`FDEV
(
devi
).
’d_blk
) {

1786 
	`f2fs_”r
(
sbi
, "Inv®id block %x", 
blk¡¬t
);

1787  -
EIO
;

1789 
blk¡¬t
 -ğ
	`FDEV
(
devi
).
¡¬t_blk
;

1793 ià(
	`f2fs_blkz_is_£q
(
sbi
, 
devi
, 
blk¡¬t
)) {

1794 
£ùÜ
 = 
	`SECTOR_FROM_BLOCK
(
blk¡¬t
);

1795 
Ä_£ùs
 = 
	`SECTOR_FROM_BLOCK
(
blkËn
);

1797 ià(
£ùÜ
 & (
	`bdev_zÚe_£ùÜs
(
bdev
) - 1) ||

1798 
Ä_£ùs
 !ğ
	`bdev_zÚe_£ùÜs
(
bdev
)) {

1799 
	`f2fs_”r
(
sbi
, "(%d) %s: Unaligned zone„eset‡ttempted (block %x + %x)",

1800 
devi
, 
sbi
->
s_ndevs
 ? 
	`FDEV
(devi).
·th
 : "",

1801 
blk¡¬t
, 
blkËn
);

1802  -
EIO
;

1804 
	`Œaû_f2fs_issue_»£t_zÚe
(
bdev
, 
blk¡¬t
);

1805  
	`blkdev_»£t_zÚes
(
bdev
, 
£ùÜ
, 
Ä_£ùs
, 
GFP_NOFS
);

1809  
	`__queue_disÿrd_cmd
(
sbi
, 
bdev
, 
lblk¡¬t
, 
blkËn
);

1810 
	}
}

1813 
	$__issue_disÿrd_async
(
f2fs_sb_šfo
 *
sbi
,

1814 
block_deviû
 *
bdev
, 
block_t
 
blk¡¬t
, block_ˆ
blkËn
)

1816 #ifdeà
CONFIG_BLK_DEV_ZONED


1817 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
è&& 
	`bdev_is_zÚed
(
bdev
))

1818  
	`__f2fs_issue_disÿrd_zÚe
(
sbi
, 
bdev
, 
blk¡¬t
, 
blkËn
);

1820  
	`__queue_disÿrd_cmd
(
sbi
, 
bdev
, 
blk¡¬t
, 
blkËn
);

1821 
	}
}

1823 
	$f2fs_issue_disÿrd
(
f2fs_sb_šfo
 *
sbi
,

1824 
block_t
 
blk¡¬t
, block_ˆ
blkËn
)

1826 
£ùÜ_t
 
¡¬t
 = 
blk¡¬t
, 
Ën
 = 0;

1827 
block_deviû
 *
bdev
;

1828 
£g_’Œy
 *
£
;

1829 
off£t
;

1830 
block_t
 
i
;

1831 
”r
 = 0;

1833 
bdev
 = 
	`f2fs_rg‘_deviû
(
sbi
, 
blk¡¬t
, 
NULL
);

1835 
i
 = 
blk¡¬t
; i < blk¡¬ˆ+ 
blkËn
; i++, 
Ën
++) {

1836 ià(
i
 !ğ
¡¬t
) {

1837 
block_deviû
 *
bdev2
 =

1838 
	`f2fs_rg‘_deviû
(
sbi
, 
i
, 
NULL
);

1840 ià(
bdev2
 !ğ
bdev
) {

1841 
”r
 = 
	`__issue_disÿrd_async
(
sbi
, 
bdev
,

1842 
¡¬t
, 
Ën
);

1843 ià(
”r
)

1844  
”r
;

1845 
bdev
 = 
bdev2
;

1846 
¡¬t
 = 
i
;

1847 
Ën
 = 0;

1851 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
	`GET_SEGNO
(sbi, 
i
));

1852 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
i
);

1854 ià(!
	`f2fs_‹¡_ªd_£t_b™
(
off£t
, 
£
->
disÿrd_m­
))

1855 
sbi
->
disÿrd_blks
--;

1858 ià(
Ën
)

1859 
”r
 = 
	`__issue_disÿrd_async
(
sbi
, 
bdev
, 
¡¬t
, 
Ën
);

1860  
”r
;

1861 
	}
}

1863 
boŞ
 
	$add_disÿrd_addrs
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
,

1864 
boŞ
 
check_Úly
)

1866 
’Œ›s
 = 
SIT_VBLOCK_MAP_SIZE
 / ();

1867 
max_blocks
 = 
sbi
->
blocks_³r_£g
;

1868 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
ıc
->
Œim_¡¬t
);

1869 *
cur_m­
 = (*)
£
->
cur_v®id_m­
;

1870 *
ck±_m­
 = (*)
£
->
ck±_v®id_m­
;

1871 *
disÿrd_m­
 = (*)
£
->discard_map;

1872 *
dm­
 = 
	`SIT_I
(
sbi
)->
tmp_m­
;

1873 
¡¬t
 = 0, 
’d
 = -1;

1874 
boŞ
 
fÜû
 = (
ıc
->
»asÚ
 & 
CP_DISCARD
);

1875 
disÿrd_’Œy
 *
de
 = 
NULL
;

1876 
li¡_h—d
 *
h—d
 = &
	`SM_I
(
sbi
)->
dcc_šfo
->
’Œy_li¡
;

1877 
i
;

1879 ià(
£
->
v®id_blocks
 =ğ
max_blocks
 || !
	`f2fs_hw_suµÜt_disÿrd
(
sbi
))

1880  
çl£
;

1882 ià(!
fÜû
) {

1883 ià(!
	`f2fs_»®time_disÿrd_’abË
(
sbi
è|| !
£
->
v®id_blocks
 ||

1884 
	`SM_I
(
sbi
)->
dcc_šfo
->
Ä_disÿrds
 >=

1885 
	`SM_I
(
sbi
)->
dcc_šfo
->
max_disÿrds
)

1886  
çl£
;

1890 
i
 = 0; i < 
’Œ›s
; i++)

1891 
dm­
[
i
] = 
fÜû
 ? ~
ck±_m­
[i] & ~
disÿrd_m­
[i] :

1892 (
cur_m­
[
i
] ^ 
ck±_m­
[i]) & ckpt_map[i];

1894 
fÜû
 || 
	`SM_I
(
sbi
)->
dcc_šfo
->
Ä_disÿrds
 <=

1895 
	`SM_I
(
sbi
)->
dcc_šfo
->
max_disÿrds
) {

1896 
¡¬t
 = 
	`__fšd_»v_Ãxt_b™
(
dm­
, 
max_blocks
, 
’d
 + 1);

1897 ià(
¡¬t
 >ğ
max_blocks
)

1900 
’d
 = 
	`__fšd_»v_Ãxt_z”o_b™
(
dm­
, 
max_blocks
, 
¡¬t
 + 1);

1901 ià(
fÜû
 && 
¡¬t
 && 
’d
 !ğ
max_blocks


1902 && (
’d
 - 
¡¬t
è< 
ıc
->
Œim_mšËn
)

1905 ià(
check_Úly
)

1906  
Œue
;

1908 ià(!
de
) {

1909 
de
 = 
	`f2fs_kmem_ÿche_®loc
(
disÿrd_’Œy_¦ab
,

1910 
GFP_F2FS_ZERO
);

1911 
de
->
¡¬t_blkaddr
 = 
	`START_BLOCK
(
sbi
, 
ıc
->
Œim_¡¬t
);

1912 
	`li¡_add_
(&
de
->
li¡
, 
h—d
);

1915 
i
 = 
¡¬t
; i < 
’d
; i++)

1916 
	`__£t_b™_Ë
(
i
, (*)
de
->
disÿrd_m­
);

1918 
	`SM_I
(
sbi
)->
dcc_šfo
->
Ä_disÿrds
 +ğ
’d
 - 
¡¬t
;

1920  
çl£
;

1921 
	}
}

1923 
	$»Ëa£_disÿrd_addr
(
disÿrd_’Œy
 *
’Œy
)

1925 
	`li¡_d–
(&
’Œy
->
li¡
);

1926 
	`kmem_ÿche_ä“
(
disÿrd_’Œy_¦ab
, 
’Œy
);

1927 
	}
}

1929 
	$f2fs_»Ëa£_disÿrd_addrs
(
f2fs_sb_šfo
 *
sbi
)

1931 
li¡_h—d
 *
h—d
 = &(
	`SM_I
(
sbi
)->
dcc_šfo
->
’Œy_li¡
);

1932 
disÿrd_’Œy
 *
’Œy
, *
this
;

1935 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
this
, 
h—d
, 
li¡
)

1936 
	`»Ëa£_disÿrd_addr
(
’Œy
);

1937 
	}
}

1942 
	$£t_´eä“_as_ä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

1944 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

1945 
£gno
;

1947 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

1948 
	`fÜ_—ch_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
PRE
], 
	`MAIN_SEGS
(
sbi
))

1949 
	`__£t_‹¡_ªd_ä“
(
sbi
, 
£gno
);

1950 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

1951 
	}
}

1953 
	$f2fs_ş—r_´eä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
,

1954 
ı_cÚŒŞ
 *
ıc
)

1956 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

1957 
li¡_h—d
 *
h—d
 = &
dcc
->
’Œy_li¡
;

1958 
disÿrd_’Œy
 *
’Œy
, *
this
;

1959 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

1960 *
´eä“_m­
 = 
dœty_i
->
dœty_£gm­
[
PRE
];

1961 
¡¬t
 = 0, 
’d
 = -1;

1962 
£úo
, 
¡¬t_£gno
;

1963 
boŞ
 
fÜû
 = (
ıc
->
»asÚ
 & 
CP_DISCARD
);

1964 
boŞ
 
Ãed_®ign
 = 
	`‹¡_İt
(
sbi
, 
LFS
è&& 
	`__is_Ïrge_£ùiÚ
(sbi);

1966 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

1969 
i
;

1971 ià(
Ãed_®ign
 && 
’d
 != -1)

1972 
’d
--;

1973 
¡¬t
 = 
	`fšd_Ãxt_b™
(
´eä“_m­
, 
	`MAIN_SEGS
(
sbi
), 
’d
 + 1);

1974 ià(
¡¬t
 >ğ
	`MAIN_SEGS
(
sbi
))

1976 
’d
 = 
	`fšd_Ãxt_z”o_b™
(
´eä“_m­
, 
	`MAIN_SEGS
(
sbi
),

1977 
¡¬t
 + 1);

1979 ià(
Ãed_®ign
) {

1980 
¡¬t
 = 
	`rounddown
(¡¬t, 
sbi
->
£gs_³r_£c
);

1981 
’d
 = 
	`roundup
Ónd, 
sbi
->
£gs_³r_£c
);

1984 
i
 = 
¡¬t
; i < 
’d
; i++) {

1985 ià(
	`‹¡_ªd_ş—r_b™
(
i
, 
´eä“_m­
))

1986 
dœty_i
->
Ä_dœty
[
PRE
]--;

1989 ià(!
	`f2fs_»®time_disÿrd_’abË
(
sbi
))

1992 ià(
fÜû
 && 
¡¬t
 >ğ
ıc
->
Œim_¡¬t
 &&

1993 (
’d
 - 1è<ğ
ıc
->
Œim_’d
)

1996 ià(!
	`‹¡_İt
(
sbi
, 
LFS
è|| !
	`__is_Ïrge_£ùiÚ
(sbi)) {

1997 
	`f2fs_issue_disÿrd
(
sbi
, 
	`START_BLOCK
(sbi, 
¡¬t
),

1998 (
’d
 - 
¡¬t
è<< 
sbi
->
log_blocks_³r_£g
);

2001 
Ãxt
:

2002 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
¡¬t
);

2003 
¡¬t_£gno
 = 
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

2004 ià(!
	`IS_CURSEC
(
sbi
, 
£úo
) &&

2005 !
	`g‘_v®id_blocks
(
sbi
, 
¡¬t
, 
Œue
))

2006 
	`f2fs_issue_disÿrd
(
sbi
, 
	`START_BLOCK
(sbi, 
¡¬t_£gno
),

2007 
sbi
->
£gs_³r_£c
 << sbi->
log_blocks_³r_£g
);

2009 
¡¬t
 = 
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
;

2010 ià(
¡¬t
 < 
’d
)

2011 
Ãxt
;

2013 
’d
 = 
¡¬t
 - 1;

2015 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

2018 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
this
, 
h—d
, 
li¡
) {

2019 
cur_pos
 = 0, 
Ãxt_pos
, 
Ën
, 
tÙ®_Ën
 = 0;

2020 
boŞ
 
is_v®id
 = 
	`‹¡_b™_Ë
(0, 
’Œy
->
disÿrd_m­
);

2022 
fšd_Ãxt
:

2023 ià(
is_v®id
) {

2024 
Ãxt_pos
 = 
	`fšd_Ãxt_z”o_b™_Ë
(
’Œy
->
disÿrd_m­
,

2025 
sbi
->
blocks_³r_£g
, 
cur_pos
);

2026 
Ën
 = 
Ãxt_pos
 - 
cur_pos
;

2028 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
) ||

2029 (
fÜû
 && 
Ën
 < 
ıc
->
Œim_mšËn
))

2030 
sk
;

2032 
	`f2fs_issue_disÿrd
(
sbi
, 
’Œy
->
¡¬t_blkaddr
 + 
cur_pos
,

2033 
Ën
);

2034 
tÙ®_Ën
 +ğ
Ën
;

2036 
Ãxt_pos
 = 
	`fšd_Ãxt_b™_Ë
(
’Œy
->
disÿrd_m­
,

2037 
sbi
->
blocks_³r_£g
, 
cur_pos
);

2039 
sk
:

2040 
cur_pos
 = 
Ãxt_pos
;

2041 
is_v®id
 = !is_valid;

2043 ià(
cur_pos
 < 
sbi
->
blocks_³r_£g
)

2044 
fšd_Ãxt
;

2046 
	`»Ëa£_disÿrd_addr
(
’Œy
);

2047 
dcc
->
Ä_disÿrds
 -ğ
tÙ®_Ën
;

2050 
	`wake_up_disÿrd_th»ad
(
sbi
, 
çl£
);

2051 
	}
}

2053 
	$ü—‹_disÿrd_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
)

2055 
dev_t
 
dev
 = 
sbi
->
sb
->
s_bdev
->
bd_dev
;

2056 
disÿrd_cmd_cÚŒŞ
 *
dcc
;

2057 
”r
 = 0, 
i
;

2059 ià(
	`SM_I
(
sbi
)->
dcc_šfo
) {

2060 
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

2061 
š™_th»ad
;

2064 
dcc
 = 
	`f2fs_kz®loc
(
sbi
, (
disÿrd_cmd_cÚŒŞ
), 
GFP_KERNEL
);

2065 ià(!
dcc
)

2066  -
ENOMEM
;

2068 
dcc
->
disÿrd_g¿nuÏr™y
 = 
DEFAULT_DISCARD_GRANULARITY
;

2069 
	`INIT_LIST_HEAD
(&
dcc
->
’Œy_li¡
);

2070 
i
 = 0; i < 
MAX_PLIST_NUM
; i++)

2071 
	`INIT_LIST_HEAD
(&
dcc
->
³nd_li¡
[
i
]);

2072 
	`INIT_LIST_HEAD
(&
dcc
->
wa™_li¡
);

2073 
	`INIT_LIST_HEAD
(&
dcc
->
f¡rim_li¡
);

2074 
	`mu‹x_š™
(&
dcc
->
cmd_lock
);

2075 
	`©omic_£t
(&
dcc
->
issued_disÿrd
, 0);

2076 
	`©omic_£t
(&
dcc
->
queued_disÿrd
, 0);

2077 
	`©omic_£t
(&
dcc
->
disÿrd_cmd_út
, 0);

2078 
dcc
->
Ä_disÿrds
 = 0;

2079 
dcc
->
max_disÿrds
 = 
	`MAIN_SEGS
(
sbi
è<< sbi->
log_blocks_³r_£g
;

2080 
dcc
->
undisÿrd_blks
 = 0;

2081 
dcc
->
Ãxt_pos
 = 0;

2082 
dcc
->
roÙ
 = 
RB_ROOT_CACHED
;

2083 
dcc
->
rbŒ“_check
 = 
çl£
;

2085 
	`š™_wa™queue_h—d
(&
dcc
->
disÿrd_wa™_queue
);

2086 
	`SM_I
(
sbi
)->
dcc_šfo
 = 
dcc
;

2087 
š™_th»ad
:

2088 
dcc
->
f2fs_issue_disÿrd
 = 
	`kth»ad_run
(
issue_disÿrd_th»ad
, 
sbi
,

2089 "f2fs_disÿrd-%u:%u", 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

2090 ià(
	`IS_ERR
(
dcc
->
f2fs_issue_disÿrd
)) {

2091 
”r
 = 
	`PTR_ERR
(
dcc
->
f2fs_issue_disÿrd
);

2092 
	`kvä“
(
dcc
);

2093 
	`SM_I
(
sbi
)->
dcc_šfo
 = 
NULL
;

2094  
”r
;

2097  
”r
;

2098 
	}
}

2100 
	$de¡roy_disÿrd_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
)

2102 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

2104 ià(!
dcc
)

2107 
	`f2fs_¡İ_disÿrd_th»ad
(
sbi
);

2113 ià(
	`uÆik–y
(
	`©omic_»ad
(&
dcc
->
disÿrd_cmd_út
)))

2114 
	`f2fs_issue_disÿrd_timeout
(
sbi
);

2116 
	`kvä“
(
dcc
);

2117 
	`SM_I
(
sbi
)->
dcc_šfo
 = 
NULL
;

2118 
	}
}

2120 
boŞ
 
	$__m¬k_s™_’Œy_dœty
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

2122 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

2124 ià(!
	`__‹¡_ªd_£t_b™
(
£gno
, 
s™_i
->
dœty_£Ár›s_b™m­
)) {

2125 
s™_i
->
dœty_£Ár›s
++;

2126  
çl£
;

2129  
Œue
;

2130 
	}
}

2132 
	$__£t_s™_’Œy_ty³
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

2133 
£gno
, 
modif›d
)

2135 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

2136 
£
->
ty³
 =ype;

2137 ià(
modif›d
)

2138 
	`__m¬k_s™_’Œy_dœty
(
sbi
, 
£gno
);

2139 
	}
}

2141 
	$upd©e_s™_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
, 
d–
)

2143 
£g_’Œy
 *
£
;

2144 
£gno
, 
off£t
;

2145 
Ãw_vblocks
;

2146 
boŞ
 
exi¡
;

2147 #ifdeà
CONFIG_F2FS_CHECK_FS


2148 
boŞ
 
mœ_exi¡
;

2151 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blkaddr
);

2153 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

2154 
Ãw_vblocks
 = 
£
->
v®id_blocks
 + 
d–
;

2155 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blkaddr
);

2157 
	`f2fs_bug_Ú
(
sbi
, (
Ãw_vblocks
 >> (() << 3) ||

2158 (
Ãw_vblocks
 > 
sbi
->
blocks_³r_£g
)));

2160 
£
->
v®id_blocks
 = 
Ãw_vblocks
;

2161 
£
->
mtime
 = 
	`g‘_mtime
(
sbi
, 
çl£
);

2162 ià(
£
->
mtime
 > 
	`SIT_I
(
sbi
)->
max_mtime
)

2163 
	`SIT_I
(
sbi
)->
max_mtime
 = 
£
->
mtime
;

2166 ià(
d–
 > 0) {

2167 
exi¡
 = 
	`f2fs_‹¡_ªd_£t_b™
(
off£t
, 
£
->
cur_v®id_m­
);

2168 #ifdeà
CONFIG_F2FS_CHECK_FS


2169 
mœ_exi¡
 = 
	`f2fs_‹¡_ªd_£t_b™
(
off£t
,

2170 
£
->
cur_v®id_m­_mœ
);

2171 ià(
	`uÆik–y
(
exi¡
 !ğ
mœ_exi¡
)) {

2172 
	`f2fs_”r
(
sbi
, "Inconsistentƒrror when setting bitmap, blk:%u, old bit:%d",

2173 
blkaddr
, 
exi¡
);

2174 
	`f2fs_bug_Ú
(
sbi
, 1);

2177 ià(
	`uÆik–y
(
exi¡
)) {

2178 
	`f2fs_”r
(
sbi
, "Bitmap was wrongly set, blk:%u",

2179 
blkaddr
);

2180 
	`f2fs_bug_Ú
(
sbi
, 1);

2181 
£
->
v®id_blocks
--;

2182 
d–
 = 0;

2185 ià(!
	`f2fs_‹¡_ªd_£t_b™
(
off£t
, 
£
->
disÿrd_m­
))

2186 
sbi
->
disÿrd_blks
--;

2192 ià(!
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)) {

2193 ià(!
	`f2fs_‹¡_ªd_£t_b™
(
off£t
, 
£
->
ck±_v®id_m­
))

2194 
£
->
ck±_v®id_blocks
++;

2197 
exi¡
 = 
	`f2fs_‹¡_ªd_ş—r_b™
(
off£t
, 
£
->
cur_v®id_m­
);

2198 #ifdeà
CONFIG_F2FS_CHECK_FS


2199 
mœ_exi¡
 = 
	`f2fs_‹¡_ªd_ş—r_b™
(
off£t
,

2200 
£
->
cur_v®id_m­_mœ
);

2201 ià(
	`uÆik–y
(
exi¡
 !ğ
mœ_exi¡
)) {

2202 
	`f2fs_”r
(
sbi
, "Inconsistentƒrror when clearing bitmap, blk:%u, old bit:%d",

2203 
blkaddr
, 
exi¡
);

2204 
	`f2fs_bug_Ú
(
sbi
, 1);

2207 ià(
	`uÆik–y
(!
exi¡
)) {

2208 
	`f2fs_”r
(
sbi
, "Bitmap was wrongly cleared, blk:%u",

2209 
blkaddr
);

2210 
	`f2fs_bug_Ú
(
sbi
, 1);

2211 
£
->
v®id_blocks
++;

2212 
d–
 = 0;

2213 } ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
))) {

2220 ià(
	`f2fs_‹¡_b™
(
off£t
, 
£
->
ck±_v®id_m­
)) {

2221 
	`¥š_lock
(&
sbi
->
¡©_lock
);

2222 
sbi
->
unu§bË_block_couÁ
++;

2223 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

2227 ià(
	`f2fs_‹¡_ªd_ş—r_b™
(
off£t
, 
£
->
disÿrd_m­
))

2228 
sbi
->
disÿrd_blks
++;

2230 ià(!
	`f2fs_‹¡_b™
(
off£t
, 
£
->
ck±_v®id_m­
))

2231 
£
->
ck±_v®id_blocks
 +ğ
d–
;

2233 
	`__m¬k_s™_’Œy_dœty
(
sbi
, 
£gno
);

2236 
	`SIT_I
(
sbi
)->
wr™‹n_v®id_blocks
 +ğ
d–
;

2238 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
))

2239 
	`g‘_£c_’Œy
(
sbi
, 
£gno
)->
v®id_blocks
 +ğ
d–
;

2240 
	}
}

2242 
	$f2fs_šv®id©e_blocks
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
addr
)

2244 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
addr
);

2245 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

2247 
	`f2fs_bug_Ú
(
sbi
, 
addr
 =ğ
NULL_ADDR
);

2248 ià(
addr
 =ğ
NEW_ADDR
)

2251 
	`šv®id©e_m­pšg_·ges
(
	`META_MAPPING
(
sbi
), 
addr
,‡ddr);

2254 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

2256 
	`upd©e_s™_’Œy
(
sbi
, 
addr
, -1);

2259 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
);

2261 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

2262 
	}
}

2264 
boŞ
 
	$f2fs_is_checkpoš‹d_d©a
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

2266 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

2267 
£gno
, 
off£t
;

2268 
£g_’Œy
 *
£
;

2269 
boŞ
 
is_ı
 = 
çl£
;

2271 ià(!
	`__is_v®id_d©a_blkaddr
(
blkaddr
))

2272  
Œue
;

2274 
	`down_»ad
(&
s™_i
->
£Áry_lock
);

2276 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blkaddr
);

2277 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

2278 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blkaddr
);

2280 ià(
	`f2fs_‹¡_b™
(
off£t
, 
£
->
ck±_v®id_m­
))

2281 
is_ı
 = 
Œue
;

2283 
	`up_»ad
(&
s™_i
->
£Áry_lock
);

2285  
is_ı
;

2286 
	}
}

2291 
	$__add_sum_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

2292 
f2fs_summ¬y
 *
sum
)

2294 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2295 *
addr
 = 
cur£g
->
sum_blk
;

2296 
addr
 +ğ
cur£g
->
Ãxt_blkoff
 * (
f2fs_summ¬y
);

2297 
	`memıy
(
addr
, 
sum
, (
f2fs_summ¬y
));

2298 
	}
}

2303 
	$f2fs_Åages_fÜ_summ¬y_æush
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
fÜ_¿
)

2305 
v®id_sum_couÁ
 = 0;

2306 
i
, 
sum_š_·ge
;

2308 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

2309 ià(
sbi
->
ck±
->
®loc_ty³
[
i
] =ğ
SSR
)

2310 
v®id_sum_couÁ
 +ğ
sbi
->
blocks_³r_£g
;

2312 ià(
fÜ_¿
)

2313 
v®id_sum_couÁ
 +ğ
	`Ë16_to_ıu
(

2314 
	`F2FS_CKPT
(
sbi
)->
cur_d©a_blkoff
[
i
]);

2316 
v®id_sum_couÁ
 +ğ
	`cur£g_blkoff
(
sbi
, 
i
);

2320 
sum_š_·ge
 = (
PAGE_SIZE
 - 2 * 
SUM_JOURNAL_SIZE
 -

2321 
SUM_FOOTER_SIZE
è/ 
SUMMARY_SIZE
;

2322 ià(
v®id_sum_couÁ
 <ğ
sum_š_·ge
)

2324 ià((
v®id_sum_couÁ
 - 
sum_š_·ge
) <=

2325 (
PAGE_SIZE
 - 
SUM_FOOTER_SIZE
è/ 
SUMMARY_SIZE
)

2328 
	}
}

2333 
·ge
 *
	$f2fs_g‘_sum_·ge
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

2335  
	`f2fs_g‘_m‘a_·ge_noç
(
sbi
, 
	`GET_SUM_BLOCK
(sbi, 
£gno
));

2336 
	}
}

2338 
	$f2fs_upd©e_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
,

2339 *
¤c
, 
block_t
 
blk_addr
)

2341 
·ge
 *·gğ
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
blk_addr
);

2343 
	`memıy
(
	`·ge_add»ss
(
·ge
), 
¤c
, 
PAGE_SIZE
);

2344 
	`£t_·ge_dœty
(
·ge
);

2345 
	`f2fs_put_·ge
(
·ge
, 1);

2346 
	}
}

2348 
	$wr™e_sum_·ge
(
f2fs_sb_šfo
 *
sbi
,

2349 
f2fs_summ¬y_block
 *
sum_blk
, 
block_t
 
blk_addr
)

2351 
	`f2fs_upd©e_m‘a_·ge
(
sbi
, (*)
sum_blk
, 
blk_addr
);

2352 
	}
}

2354 
	$wr™e_cu¼’t_sum_·ge
(
f2fs_sb_šfo
 *
sbi
,

2355 
ty³
, 
block_t
 
blk_addr
)

2357 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2358 
·ge
 *·gğ
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
blk_addr
);

2359 
f2fs_summ¬y_block
 *
¤c
 = 
cur£g
->
sum_blk
;

2360 
f2fs_summ¬y_block
 *
d¡
;

2362 
d¡
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
·ge
);

2363 
	`mem£t
(
d¡
, 0, 
PAGE_SIZE
);

2365 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

2367 
	`down_»ad
(&
cur£g
->
jouº®_rw£m
);

2368 
	`memıy
(&
d¡
->
jouº®
, 
cur£g
->jouº®, 
SUM_JOURNAL_SIZE
);

2369 
	`up_»ad
(&
cur£g
->
jouº®_rw£m
);

2371 
	`memıy
(
d¡
->
’Œ›s
, 
¤c
->’Œ›s, 
SUM_ENTRY_SIZE
);

2372 
	`memıy
(&
d¡
->
foÙ”
, &
¤c
->foÙ”, 
SUM_FOOTER_SIZE
);

2374 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

2376 
	`£t_·ge_dœty
(
·ge
);

2377 
	`f2fs_put_·ge
(
·ge
, 1);

2378 
	}
}

2380 
	$is_Ãxt_£gm’t_ä“
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2382 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2383 
£gno
 = 
cur£g
->segno + 1;

2384 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

2386 ià(
£gno
 < 
	`MAIN_SEGS
(
sbi
è&& segnØ% sbi->
£gs_³r_£c
)

2387  !
	`‹¡_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
);

2389 
	}
}

2395 
	$g‘_Ãw_£gm’t
(
f2fs_sb_šfo
 *
sbi
,

2396 *
Ãw£g
, 
boŞ
 
Ãw_£c
, 
dœ
)

2398 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

2399 
£gno
, 
£úo
, 
zÚ’o
;

2400 
tÙ®_zÚes
 = 
	`MAIN_SECS
(
sbi
è/ sbi->
£cs_³r_zÚe
;

2401 
hšt
 = 
	`GET_SEC_FROM_SEG
(
sbi
, *
Ãw£g
);

2402 
Şd_zÚ’o
 = 
	`GET_ZONE_FROM_SEG
(
sbi
, *
Ãw£g
);

2403 
Ëá_¡¬t
 = 
hšt
;

2404 
boŞ
 
š™
 = 
Œue
;

2405 
go_Ëá
 = 0;

2406 
i
;

2408 
	`¥š_lock
(&
ä“_i
->
£gm­_lock
);

2410 ià(!
Ãw_£c
 && ((*
Ãw£g
 + 1è% 
sbi
->
£gs_³r_£c
)) {

2411 
£gno
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£gm­
,

2412 
	`GET_SEG_FROM_SEC
(
sbi
, 
hšt
 + 1), *
Ãw£g
 + 1);

2413 ià(
£gno
 < 
	`GET_SEG_FROM_SEC
(
sbi
, 
hšt
 + 1))

2414 
gÙ_™
;

2416 
fšd_Ùh”_zÚe
:

2417 
£úo
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£cm­
, 
	`MAIN_SECS
(
sbi
), 
hšt
);

2418 ià(
£úo
 >ğ
	`MAIN_SECS
(
sbi
)) {

2419 ià(
dœ
 =ğ
ALLOC_RIGHT
) {

2420 
£úo
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£cm­
,

2421 
	`MAIN_SECS
(
sbi
), 0);

2422 
	`f2fs_bug_Ú
(
sbi
, 
£úo
 >ğ
	`MAIN_SECS
(sbi));

2424 
go_Ëá
 = 1;

2425 
Ëá_¡¬t
 = 
hšt
 - 1;

2428 ià(
go_Ëá
 == 0)

2429 
sk_Ëá
;

2431 
	`‹¡_b™
(
Ëá_¡¬t
, 
ä“_i
->
ä“_£cm­
)) {

2432 ià(
Ëá_¡¬t
 > 0) {

2433 
Ëá_¡¬t
--;

2436 
Ëá_¡¬t
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£cm­
,

2437 
	`MAIN_SECS
(
sbi
), 0);

2438 
	`f2fs_bug_Ú
(
sbi
, 
Ëá_¡¬t
 >ğ
	`MAIN_SECS
(sbi));

2441 
£úo
 = 
Ëá_¡¬t
;

2442 
sk_Ëá
:

2443 
£gno
 = 
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

2444 
zÚ’o
 = 
	`GET_ZONE_FROM_SEC
(
sbi
, 
£úo
);

2447 ià(!
š™
)

2448 
gÙ_™
;

2449 ià(
sbi
->
£cs_³r_zÚe
 == 1)

2450 
gÙ_™
;

2451 ià(
zÚ’o
 =ğ
Şd_zÚ’o
)

2452 
gÙ_™
;

2453 ià(
dœ
 =ğ
ALLOC_LEFT
) {

2454 ià(!
go_Ëá
 && 
zÚ’o
 + 1 >ğ
tÙ®_zÚes
)

2455 
gÙ_™
;

2456 ià(
go_Ëá
 && 
zÚ’o
 == 0)

2457 
gÙ_™
;

2459 
i
 = 0; i < 
NR_CURSEG_TYPE
; i++)

2460 ià(
	`CURSEG_I
(
sbi
, 
i
)->
zÚe
 =ğ
zÚ’o
)

2463 ià(
i
 < 
NR_CURSEG_TYPE
) {

2465 ià(
go_Ëá
)

2466 
hšt
 = 
zÚ’o
 * 
sbi
->
£cs_³r_zÚe
 - 1;

2467 ià(
zÚ’o
 + 1 >ğ
tÙ®_zÚes
)

2468 
hšt
 = 0;

2470 
hšt
 = (
zÚ’o
 + 1è* 
sbi
->
£cs_³r_zÚe
;

2471 
š™
 = 
çl£
;

2472 
fšd_Ùh”_zÚe
;

2474 
gÙ_™
:

2476 
	`f2fs_bug_Ú
(
sbi
, 
	`‹¡_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
));

2477 
	`__£t_šu£
(
sbi
, 
£gno
);

2478 *
Ãw£g
 = 
£gno
;

2479 
	`¥š_uÆock
(&
ä“_i
->
£gm­_lock
);

2480 
	}
}

2482 
	$»£t_cur£g
(
f2fs_sb_šfo
 *
sbi
, 
ty³
, 
modif›d
)

2484 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2485 
summ¬y_foÙ”
 *
sum_foÙ”
;

2487 
cur£g
->
£gno
 = cur£g->
Ãxt_£gno
;

2488 
cur£g
->
zÚe
 = 
	`GET_ZONE_FROM_SEG
(
sbi
, cur£g->
£gno
);

2489 
cur£g
->
Ãxt_blkoff
 = 0;

2490 
cur£g
->
Ãxt_£gno
 = 
NULL_SEGNO
;

2492 
sum_foÙ”
 = &(
cur£g
->
sum_blk
->
foÙ”
);

2493 
	`mem£t
(
sum_foÙ”
, 0, (
summ¬y_foÙ”
));

2494 ià(
	`IS_DATASEG
(
ty³
))

2495 
	`SET_SUM_TYPE
(
sum_foÙ”
, 
SUM_TYPE_DATA
);

2496 ià(
	`IS_NODESEG
(
ty³
))

2497 
	`SET_SUM_TYPE
(
sum_foÙ”
, 
SUM_TYPE_NODE
);

2498 
	`__£t_s™_’Œy_ty³
(
sbi
, 
ty³
, 
cur£g
->
£gno
, 
modif›d
);

2499 
	}
}

2501 
	$__g‘_Ãxt_£gno
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2504 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
))

2505  
	`CURSEG_I
(
sbi
, 
ty³
)->
£gno
;

2507 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)))

2510 ià(
	`‹¡_İt
(
sbi
, 
NOHEAP
) &&

2511 (
ty³
 =ğ
CURSEG_HOT_DATA
 || 
	`IS_NODESEG
(type)))

2514 ià(
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
ALLOC_NEXT
])

2515  
	`SIT_I
(
sbi
)->
Ï¡_viùim
[
ALLOC_NEXT
];

2518 ià(
	`F2FS_OPTION
(
sbi
).
®loc_mode
 =ğ
ALLOC_MODE_REUSE
)

2521  
	`CURSEG_I
(
sbi
, 
ty³
)->
£gno
;

2522 
	}
}

2528 
	$Ãw_cur£g
(
f2fs_sb_šfo
 *
sbi
, 
ty³
, 
boŞ
 
Ãw_£c
)

2530 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2531 
£gno
 = 
cur£g
->segno;

2532 
dœ
 = 
ALLOC_LEFT
;

2534 
	`wr™e_sum_·ge
(
sbi
, 
cur£g
->
sum_blk
,

2535 
	`GET_SUM_BLOCK
(
sbi
, 
£gno
));

2536 ià(
ty³
 =ğ
CURSEG_WARM_DATA
 ||y³ =ğ
CURSEG_COLD_DATA
)

2537 
dœ
 = 
ALLOC_RIGHT
;

2539 ià(
	`‹¡_İt
(
sbi
, 
NOHEAP
))

2540 
dœ
 = 
ALLOC_RIGHT
;

2542 
£gno
 = 
	`__g‘_Ãxt_£gno
(
sbi
, 
ty³
);

2543 
	`g‘_Ãw_£gm’t
(
sbi
, &
£gno
, 
Ãw_£c
, 
dœ
);

2545 
cur_£g_addr
 = 
	`START_BLOCK
(
sbi
, 
cur£g
->
£gno
);

2546 
	`ÿÎ_§Îoÿ‹
(
cur_£g_addr
, 512);

2548 
cur£g
->
Ãxt_£gno
 = 
£gno
;

2549 
	`»£t_cur£g
(
sbi
, 
ty³
, 1);

2550 
cur£g
->
®loc_ty³
 = 
LFS
;

2551 
	}
}

2553 
	$__Ãxt_ä“_blkoff
(
f2fs_sb_šfo
 *
sbi
,

2554 
cur£g_šfo
 *
£g
, 
block_t
 
¡¬t
)

2556 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£g
->
£gno
);

2557 
’Œ›s
 = 
SIT_VBLOCK_MAP_SIZE
 / ();

2558 *
rg‘_m­
 = 
	`SIT_I
(
sbi
)->
tmp_m­
;

2559 *
ck±_m­
 = (*)
£
->
ck±_v®id_m­
;

2560 *
cur_m­
 = (*)
£
->
cur_v®id_m­
;

2561 
i
, 
pos
;

2563 
i
 = 0; i < 
’Œ›s
; i++)

2564 
rg‘_m­
[
i
] = 
ck±_m­
[i] | 
cur_m­
[i];

2566 
pos
 = 
	`__fšd_»v_Ãxt_z”o_b™
(
rg‘_m­
, 
sbi
->
blocks_³r_£g
, 
¡¬t
);

2568 
£g
->
Ãxt_blkoff
 = 
pos
;

2569 
	}
}

2576 
	$__»äesh_Ãxt_blkoff
(
f2fs_sb_šfo
 *
sbi
,

2577 
cur£g_šfo
 *
£g
)

2579 ià(
£g
->
®loc_ty³
 =ğ
SSR
)

2580 
	`__Ãxt_ä“_blkoff
(
sbi
, 
£g
, seg->
Ãxt_blkoff
 + 1);

2582 
£g
->
Ãxt_blkoff
++;

2583 
	}
}

2589 
	$chªge_cur£g
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2591 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

2592 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2593 
Ãw_£gno
 = 
cur£g
->
Ãxt_£gno
;

2594 
f2fs_summ¬y_block
 *
sum_node
;

2595 
·ge
 *
sum_·ge
;

2597 
	`wr™e_sum_·ge
(
sbi
, 
cur£g
->
sum_blk
,

2598 
	`GET_SUM_BLOCK
(
sbi
, 
cur£g
->
£gno
));

2599 
	`__£t_‹¡_ªd_šu£
(
sbi
, 
Ãw_£gno
);

2601 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

2602 
	`__»move_dœty_£gm’t
(
sbi
, 
Ãw_£gno
, 
PRE
);

2603 
	`__»move_dœty_£gm’t
(
sbi
, 
Ãw_£gno
, 
DIRTY
);

2604 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

2606 
	`»£t_cur£g
(
sbi
, 
ty³
, 1);

2607 
cur£g
->
®loc_ty³
 = 
SSR
;

2608 
	`__Ãxt_ä“_blkoff
(
sbi
, 
cur£g
, 0);

2610 
sum_·ge
 = 
	`f2fs_g‘_sum_·ge
(
sbi
, 
Ãw_£gno
);

2611 
	`f2fs_bug_Ú
(
sbi
, 
	`IS_ERR
(
sum_·ge
));

2612 
sum_node
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
sum_·ge
);

2613 
	`memıy
(
cur£g
->
sum_blk
, 
sum_node
, 
SUM_ENTRY_SIZE
);

2614 
	`f2fs_put_·ge
(
sum_·ge
, 1);

2615 
	}
}

2617 
	$g‘_s¤_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2619 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2620 cÚ¡ 
viùim_£ËùiÚ
 *
v_İs
 = 
	`DIRTY_I
(
sbi
)->v_ops;

2621 
£gno
 = 
NULL_SEGNO
;

2622 
i
, 
út
;

2623 
boŞ
 
»v”£d
 = 
çl£
;

2626 ià(
v_İs
->
	`g‘_viùim
(
sbi
, &
£gno
, 
BG_GC
, 
ty³
, 
SSR
)) {

2627 
cur£g
->
Ãxt_£gno
 = 
£gno
;

2632 ià(
	`IS_NODESEG
(
ty³
)) {

2633 ià(
ty³
 >ğ
CURSEG_WARM_NODE
) {

2634 
»v”£d
 = 
Œue
;

2635 
i
 = 
CURSEG_COLD_NODE
;

2637 
i
 = 
CURSEG_HOT_NODE
;

2639 
út
 = 
NR_CURSEG_NODE_TYPE
;

2641 ià(
ty³
 >ğ
CURSEG_WARM_DATA
) {

2642 
»v”£d
 = 
Œue
;

2643 
i
 = 
CURSEG_COLD_DATA
;

2645 
i
 = 
CURSEG_HOT_DATA
;

2647 
út
 = 
NR_CURSEG_DATA_TYPE
;

2650 ; 
út
-- > 0; 
»v”£d
 ? 
i
-- : i++) {

2651 ià(
i
 =ğ
ty³
)

2653 ià(
v_İs
->
	`g‘_viùim
(
sbi
, &
£gno
, 
BG_GC
, 
i
, 
SSR
)) {

2654 
cur£g
->
Ãxt_£gno
 = 
£gno
;

2660 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
))) {

2661 
£gno
 = 
	`g‘_ä“_£gm’t
(
sbi
);

2662 ià(
£gno
 !ğ
NULL_SEGNO
) {

2663 
cur£g
->
Ãxt_£gno
 = 
£gno
;

2668 
	}
}

2674 
	$®loÿ‹_£gm’t_by_deçuÉ
(
f2fs_sb_šfo
 *
sbi
,

2675 
ty³
, 
boŞ
 
fÜû
)

2677 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2679 ià(
fÜû
)

2680 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
Œue
);

2681 ià(!
	`is_£t_ck±_æags
(
sbi
, 
CP_CRC_RECOVERY_FLAG
) &&

2682 
ty³
 =ğ
CURSEG_WARM_NODE
)

2683 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
çl£
);

2684 ià(
cur£g
->
®loc_ty³
 =ğ
LFS
 && 
	`is_Ãxt_£gm’t_ä“
(
sbi
, 
ty³
) &&

2685 
	`lik–y
(!
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)))

2686 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
çl£
);

2687 ià(
	`f2fs_Ãed_SSR
(
sbi
è&& 
	`g‘_s¤_£gm’t
(sbi, 
ty³
))

2688 
	`chªge_cur£g
(
sbi
, 
ty³
);

2690 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
çl£
);

2692 
	`¡©_šc_£g_ty³
(
sbi
, 
cur£g
);

2693 
	}
}

2695 
	$®loÿ‹_£gm’t_fÜ_»size
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

2696 
¡¬t
, 
’d
)

2698 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2699 
£gno
;

2701 
	`down_»ad
(&
	`SM_I
(
sbi
)->
cur£g_lock
);

2702 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

2703 
	`down_wr™e
(&
	`SIT_I
(
sbi
)->
£Áry_lock
);

2705 
£gno
 = 
	`CURSEG_I
(
sbi
, 
ty³
)->segno;

2706 ià(
£gno
 < 
¡¬t
 || segnØ> 
’d
)

2707 
uÆock
;

2709 ià(
	`f2fs_Ãed_SSR
(
sbi
è&& 
	`g‘_s¤_£gm’t
(sbi, 
ty³
))

2710 
	`chªge_cur£g
(
sbi
, 
ty³
);

2712 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
Œue
);

2714 
	`¡©_šc_£g_ty³
(
sbi
, 
cur£g
);

2716 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
);

2717 
uÆock
:

2718 
	`up_wr™e
(&
	`SIT_I
(
sbi
)->
£Áry_lock
);

2720 ià(
£gno
 !ğ
cur£g
->segno)

2721 
	`f2fs_nÙiû
(
sbi
, "For„esize: curseg ofype %d: %u ==> %u",

2722 
ty³
, 
£gno
, 
cur£g
->segno);

2724 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

2725 
	`up_»ad
(&
	`SM_I
(
sbi
)->
cur£g_lock
);

2726 
	}
}

2728 
	$f2fs_®loÿ‹_Ãw_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

2730 
cur£g_šfo
 *
cur£g
;

2731 
Şd_£gno
;

2732 
i
;

2734 
	`down_wr™e
(&
	`SIT_I
(
sbi
)->
£Áry_lock
);

2736 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

2737 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

2738 
Şd_£gno
 = 
cur£g
->
£gno
;

2739 
	`SIT_I
(
sbi
)->
s_İs
->
	`®loÿ‹_£gm’t
(sbi, 
i
, 
Œue
);

2740 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
Şd_£gno
);

2743 
	`up_wr™e
(&
	`SIT_I
(
sbi
)->
£Áry_lock
);

2744 
	}
}

2746 cÚ¡ 
£gm’t_®loÿtiÚ
 
	gdeçuÉ_§Îoc_İs
 = {

2747 .
®loÿ‹_£gm’t
 = 
®loÿ‹_£gm’t_by_deçuÉ
,

2750 
boŞ
 
	$f2fs_exi¡_Œim_ÿndid©es
(
f2fs_sb_šfo
 *
sbi
,

2751 
ı_cÚŒŞ
 *
ıc
)

2753 
__u64
 
Œim_¡¬t
 = 
ıc
->trim_start;

2754 
boŞ
 
has_ÿndid©e
 = 
çl£
;

2756 
	`down_wr™e
(&
	`SIT_I
(
sbi
)->
£Áry_lock
);

2757 ; 
ıc
->
Œim_¡¬t
 <ğıc->
Œim_’d
; cpc->trim_start++) {

2758 ià(
	`add_disÿrd_addrs
(
sbi
, 
ıc
, 
Œue
)) {

2759 
has_ÿndid©e
 = 
Œue
;

2763 
	`up_wr™e
(&
	`SIT_I
(
sbi
)->
£Áry_lock
);

2765 
ıc
->
Œim_¡¬t
 =rim_start;

2766  
has_ÿndid©e
;

2767 
	}
}

2769 
	$__issue_disÿrd_cmd_¿nge
(
f2fs_sb_šfo
 *
sbi
,

2770 
disÿrd_pŞicy
 *
dpŞicy
,

2771 
¡¬t
, 
’d
)

2773 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

2774 
disÿrd_cmd
 *
´ev_dc
 = 
NULL
, *
Ãxt_dc
 = NULL;

2775 
rb_node
 **
š£¹_p
 = 
NULL
, *
š£¹_·»Á
 = NULL;

2776 
disÿrd_cmd
 *
dc
;

2777 
blk_¶ug
 
¶ug
;

2778 
issued
;

2779 
Œimmed
 = 0;

2781 
Ãxt
:

2782 
issued
 = 0;

2784 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

2785 ià(
	`uÆik–y
(
dcc
->
rbŒ“_check
))

2786 
	`f2fs_bug_Ú
(
sbi
, !
	`f2fs_check_rb_Œ“_cÚsi¡’û
(sbi,

2787 &
dcc
->
roÙ
));

2789 
dc
 = (
disÿrd_cmd
 *)
	`f2fs_lookup_rb_Œ“_»t
(&
dcc
->
roÙ
,

2790 
NULL
, 
¡¬t
,

2791 (
rb_’Œy
 **)&
´ev_dc
,

2792 (
rb_’Œy
 **)&
Ãxt_dc
,

2793 &
š£¹_p
, &
š£¹_·»Á
, 
Œue
, 
NULL
);

2794 ià(!
dc
)

2795 
dc
 = 
Ãxt_dc
;

2797 
	`blk_¡¬t_¶ug
(&
¶ug
);

2799 
dc
 && dc->
l¡¬t
 <ğ
’d
) {

2800 
rb_node
 *
node
;

2801 
”r
 = 0;

2803 ià(
dc
->
Ën
 < 
dpŞicy
->
g¿nuÏr™y
)

2804 
sk
;

2806 ià(
dc
->
¡©e
 !ğ
D_PREP
) {

2807 
	`li¡_move_
(&
dc
->
li¡
, &
dcc
->
f¡rim_li¡
);

2808 
sk
;

2811 
”r
 = 
	`__subm™_disÿrd_cmd
(
sbi
, 
dpŞicy
, 
dc
, &
issued
);

2813 ià(
issued
 >ğ
dpŞicy
->
max_»que¡s
) {

2814 
¡¬t
 = 
dc
->
l¡¬t
 + dc->
Ën
;

2816 ià(
”r
)

2817 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

2819 
	`blk_fšish_¶ug
(&
¶ug
);

2820 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

2821 
Œimmed
 +ğ
	`__wa™_®l_disÿrd_cmd
(
sbi
, 
NULL
);

2822 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

2823 
Ãxt
;

2825 
sk
:

2826 
node
 = 
	`rb_Ãxt
(&
dc
->
rb_node
);

2827 ià(
”r
)

2828 
	`__»move_disÿrd_cmd
(
sbi
, 
dc
);

2829 
dc
 = 
	`rb_’Œy_§ã
(
node
, 
disÿrd_cmd
, 
rb_node
);

2831 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2835 
	`blk_fšish_¶ug
(&
¶ug
);

2836 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

2838  
Œimmed
;

2839 
	}
}

2841 
	$f2fs_Œim_fs
(
f2fs_sb_šfo
 *
sbi
, 
f¡rim_¿nge
 *
¿nge
)

2843 
__u64
 
¡¬t
 = 
	`F2FS_BYTES_TO_BLK
(
¿nge
->start);

2844 
__u64
 
’d
 = 
¡¬t
 + 
	`F2FS_BYTES_TO_BLK
(
¿nge
->
Ën
) - 1;

2845 
¡¬t_£gno
, 
’d_£gno
;

2846 
block_t
 
¡¬t_block
, 
’d_block
;

2847 
ı_cÚŒŞ
 
ıc
;

2848 
disÿrd_pŞicy
 
dpŞicy
;

2849 
Œimmed
 = 0;

2850 
”r
 = 0;

2851 
boŞ
 
Ãed_®ign
 = 
	`‹¡_İt
(
sbi
, 
LFS
è&& 
	`__is_Ïrge_£ùiÚ
(sbi);

2853 ià(
¡¬t
 >ğ
	`MAX_BLKADDR
(
sbi
è|| 
¿nge
->
Ën
 < sbi->
blocksize
)

2854  -
EINVAL
;

2856 ià(
’d
 < 
	`MAIN_BLKADDR
(
sbi
))

2857 
out
;

2859 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_FSCK
)) {

2860 
	`f2fs_w¬n
(
sbi
, "Found FS corruption,„un fscko fix.");

2861  -
EFSCORRUPTED
;

2865 
¡¬t_£gno
 = (
¡¬t
 <ğ
	`MAIN_BLKADDR
(
sbi
)è? 0 : 
	`GET_SEGNO
(sbi, start);

2866 
’d_£gno
 = (
’d
 >ğ
	`MAX_BLKADDR
(
sbi
)è? 
	`MAIN_SEGS
(sbi) - 1 :

2867 
	`GET_SEGNO
(
sbi
, 
’d
);

2868 ià(
Ãed_®ign
) {

2869 
¡¬t_£gno
 = 
	`rounddown
(¡¬t_£gno, 
sbi
->
£gs_³r_£c
);

2870 
’d_£gno
 = 
	`roundup
Ónd_£gnØ+ 1, 
sbi
->
£gs_³r_£c
) - 1;

2873 
ıc
.
»asÚ
 = 
CP_DISCARD
;

2874 
ıc
.
Œim_mšËn
 = 
	`max_t
(
__u64
, 1, 
	`F2FS_BYTES_TO_BLK
(
¿nge
->
mšËn
));

2875 
ıc
.
Œim_¡¬t
 = 
¡¬t_£gno
;

2876 
ıc
.
Œim_’d
 = 
’d_£gno
;

2878 ià(
sbi
->
disÿrd_blks
 == 0)

2879 
out
;

2881 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

2882 
”r
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

2883 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

2884 ià(
”r
)

2885 
out
;

2893 ià(
	`f2fs_»®time_disÿrd_’abË
(
sbi
))

2894 
out
;

2896 
¡¬t_block
 = 
	`START_BLOCK
(
sbi
, 
¡¬t_£gno
);

2897 
’d_block
 = 
	`START_BLOCK
(
sbi
, 
’d_£gno
 + 1);

2899 
	`__š™_disÿrd_pŞicy
(
sbi
, &
dpŞicy
, 
DPOLICY_FSTRIM
, 
ıc
.
Œim_mšËn
);

2900 
Œimmed
 = 
	`__issue_disÿrd_cmd_¿nge
(
sbi
, &
dpŞicy
,

2901 
¡¬t_block
, 
’d_block
);

2903 
Œimmed
 +ğ
	`__wa™_disÿrd_cmd_¿nge
(
sbi
, &
dpŞicy
,

2904 
¡¬t_block
, 
’d_block
);

2905 
out
:

2906 ià(!
”r
)

2907 
¿nge
->
Ën
 = 
	`F2FS_BLK_TO_BYTES
(
Œimmed
);

2908  
”r
;

2909 
	}
}

2911 
boŞ
 
	$__has_cur£g_¥aû
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

2913 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2914 ià(
cur£g
->
Ãxt_blkoff
 < 
sbi
->
blocks_³r_£g
)

2915  
Œue
;

2916  
çl£
;

2917 
	}
}

2919 
	$f2fs_rw_hšt_to_£g_ty³
(
rw_hšt
 
hšt
)

2921 
hšt
) {

2922 
WRITE_LIFE_SHORT
:

2923  
CURSEG_HOT_DATA
;

2924 
WRITE_LIFE_EXTREME
:

2925  
CURSEG_COLD_DATA
;

2927  
CURSEG_WARM_DATA
;

2929 
	}
}

2992 
rw_hšt
 
	$f2fs_io_ty³_to_rw_hšt
(
f2fs_sb_šfo
 *
sbi
,

2993 
·ge_ty³
 
ty³
, 
‹mp_ty³
 
‹mp
)

2995 ià(
	`F2FS_OPTION
(
sbi
).
whšt_mode
 =ğ
WHINT_MODE_USER
) {

2996 ià(
ty³
 =ğ
DATA
) {

2997 ià(
‹mp
 =ğ
WARM
)

2998  
WRITE_LIFE_NOT_SET
;

2999 ià(
‹mp
 =ğ
HOT
)

3000  
WRITE_LIFE_SHORT
;

3001 ià(
‹mp
 =ğ
COLD
)

3002  
WRITE_LIFE_EXTREME
;

3004  
WRITE_LIFE_NOT_SET
;

3006 } ià(
	`F2FS_OPTION
(
sbi
).
whšt_mode
 =ğ
WHINT_MODE_FS
) {

3007 ià(
ty³
 =ğ
DATA
) {

3008 ià(
‹mp
 =ğ
WARM
)

3009  
WRITE_LIFE_LONG
;

3010 ià(
‹mp
 =ğ
HOT
)

3011  
WRITE_LIFE_SHORT
;

3012 ià(
‹mp
 =ğ
COLD
)

3013  
WRITE_LIFE_EXTREME
;

3014 } ià(
ty³
 =ğ
NODE
) {

3015 ià(
‹mp
 =ğ
WARM
 ||em°=ğ
HOT
)

3016  
WRITE_LIFE_NOT_SET
;

3017 ià(
‹mp
 =ğ
COLD
)

3018  
WRITE_LIFE_NONE
;

3019 } ià(
ty³
 =ğ
META
) {

3020  
WRITE_LIFE_MEDIUM
;

3023  
WRITE_LIFE_NOT_SET
;

3024 
	}
}

3026 
	$__g‘_£gm’t_ty³_2
(
f2fs_io_šfo
 *
fio
)

3028 ià(
fio
->
ty³
 =ğ
DATA
)

3029  
CURSEG_HOT_DATA
;

3031  
CURSEG_HOT_NODE
;

3032 
	}
}

3034 
	$__g‘_£gm’t_ty³_4
(
f2fs_io_šfo
 *
fio
)

3036 ià(
fio
->
ty³
 =ğ
DATA
) {

3037 
šode
 *šodğ
fio
->
·ge
->
m­pšg
->
ho¡
;

3039 ià(
	`S_ISDIR
(
šode
->
i_mode
))

3040  
CURSEG_HOT_DATA
;

3042  
CURSEG_COLD_DATA
;

3044 ià(
	`IS_DNODE
(
fio
->
·ge
è&& 
	`is_cŞd_node
(fio->page))

3045  
CURSEG_WARM_NODE
;

3047  
CURSEG_COLD_NODE
;

3049 
	}
}

3051 
	$__g‘_£gm’t_ty³_6
(
f2fs_io_šfo
 *
fio
)

3053 ià(
fio
->
ty³
 =ğ
DATA
) {

3054 
šode
 *šodğ
fio
->
·ge
->
m­pšg
->
ho¡
;

3056 ià(
	`is_cŞd_d©a
(
fio
->
·ge
è|| 
	`fe_is_cŞd
(
šode
))

3057  
CURSEG_COLD_DATA
;

3058 ià(
	`fe_is_hÙ
(
šode
) ||

3059 
	`is_šode_æag_£t
(
šode
, 
FI_HOT_DATA
) ||

3060 
	`f2fs_is_©omic_fe
(
šode
) ||

3061 
	`f2fs_is_vŞ©e_fe
(
šode
))

3062  
CURSEG_HOT_DATA
;

3063  
	`f2fs_rw_hšt_to_£g_ty³
(
šode
->
i_wr™e_hšt
);

3065 ià(
	`IS_DNODE
(
fio
->
·ge
))

3066  
	`is_cŞd_node
(
fio
->
·ge
è? 
CURSEG_WARM_NODE
 :

3067 
CURSEG_HOT_NODE
;

3068  
CURSEG_COLD_NODE
;

3070 
	}
}

3072 
	$__g‘_£gm’t_ty³
(
f2fs_io_šfo
 *
fio
)

3074 
ty³
 = 0;

3076 
	`F2FS_OPTION
(
fio
->
sbi
).
aùive_logs
) {

3078 
ty³
 = 
	`__g‘_£gm’t_ty³_2
(
fio
);

3081 
ty³
 = 
	`__g‘_£gm’t_ty³_4
(
fio
);

3084 
ty³
 = 
	`__g‘_£gm’t_ty³_6
(
fio
);

3087 
	`f2fs_bug_Ú
(
fio
->
sbi
, 
Œue
);

3090 ià(
	`IS_HOT
(
ty³
))

3091 
fio
->
‹mp
 = 
HOT
;

3092 ià(
	`IS_WARM
(
ty³
))

3093 
fio
->
‹mp
 = 
WARM
;

3095 
fio
->
‹mp
 = 
COLD
;

3096  
ty³
;

3097 
	}
}

3099 
	$f2fs_®loÿ‹_d©a_block
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

3100 
block_t
 
Şd_blkaddr
, block_ˆ*
Ãw_blkaddr
,

3101 
f2fs_summ¬y
 *
sum
, 
ty³
,

3102 
f2fs_io_šfo
 *
fio
, 
boŞ
 
add_li¡
)

3104 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

3105 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

3107 
	`down_»ad
(&
	`SM_I
(
sbi
)->
cur£g_lock
);

3109 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

3110 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

3112 *
Ãw_blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

3114 
	`f2fs_wa™_disÿrd_bio
(
sbi
, *
Ãw_blkaddr
);

3121 
	`__add_sum_’Œy
(
sbi
, 
ty³
, 
sum
);

3123 
	`__»äesh_Ãxt_blkoff
(
sbi
, 
cur£g
);

3125 
	`¡©_šc_block_couÁ
(
sbi
, 
cur£g
);

3131 
	`upd©e_s™_’Œy
(
sbi
, *
Ãw_blkaddr
, 1);

3132 ià(
	`GET_SEGNO
(
sbi
, 
Şd_blkaddr
è!ğ
NULL_SEGNO
)

3133 
	`upd©e_s™_’Œy
(
sbi
, 
Şd_blkaddr
, -1);

3135 ià(!
	`__has_cur£g_¥aû
(
sbi
, 
ty³
))

3136 
s™_i
->
s_İs
->
	`®loÿ‹_£gm’t
(
sbi
, 
ty³
, 
çl£
);

3143 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, 
Şd_blkaddr
));

3144 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, *
Ãw_blkaddr
));

3146 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

3148 ià(
·ge
 && 
	`IS_NODESEG
(
ty³
)) {

3149 
	`fl_node_foÙ”_blkaddr
(
·ge
, 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
));

3151 
	`f2fs_šode_chksum_£t
(
sbi
, 
·ge
);

3154 ià(
	`F2FS_IO_ALIGNED
(
sbi
))

3155 
fio
->
»Œy
 = 
çl£
;

3157 ià(
add_li¡
) {

3158 
f2fs_bio_šfo
 *
io
;

3160 
	`INIT_LIST_HEAD
(&
fio
->
li¡
);

3161 
fio
->
š_li¡
 = 
Œue
;

3162 
io
 = 
sbi
->
wr™e_io
[
fio
->
ty³
] + fio->
‹mp
;

3163 
	`¥š_lock
(&
io
->
io_lock
);

3164 
	`li¡_add_
(&
fio
->
li¡
, &
io
->
io_li¡
);

3165 
	`¥š_uÆock
(&
io
->
io_lock
);

3168 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

3170 
	`up_»ad
(&
	`SM_I
(
sbi
)->
cur£g_lock
);

3171 
	}
}

3173 
	$upd©e_deviû_¡©e
(
f2fs_io_šfo
 *
fio
)

3175 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

3176 
devidx
;

3178 ià(!
	`f2fs_is_muÉi_deviû
(
sbi
))

3181 
devidx
 = 
	`f2fs_rg‘_deviû_šdex
(
sbi
, 
fio
->
Ãw_blkaddr
);

3184 
	`f2fs_£t_dœty_deviû
(
sbi
, 
fio
->
šo
, 
devidx
, 
FLUSH_INO
);

3187 ià(!
	`f2fs_‹¡_b™
(
devidx
, (*)&
sbi
->
dœty_deviû
)) {

3188 
	`¥š_lock
(&
sbi
->
dev_lock
);

3189 
	`f2fs_£t_b™
(
devidx
, (*)&
sbi
->
dœty_deviû
);

3190 
	`¥š_uÆock
(&
sbi
->
dev_lock
);

3192 
	}
}

3194 
	$do_wr™e_·ge
(
f2fs_summ¬y
 *
sum
, 
f2fs_io_šfo
 *
fio
)

3196 
ty³
 = 
	`__g‘_£gm’t_ty³
(
fio
);

3197 
boŞ
 
k“p_Üd”
 = (
	`‹¡_İt
(
fio
->
sbi
, 
LFS
è&& 
ty³
 =ğ
CURSEG_COLD_DATA
);

3199 ià(
k“p_Üd”
)

3200 
	`down_»ad
(&
fio
->
sbi
->
io_Üd”_lock
);

3201 
»®loÿ‹
:

3202 
	`f2fs_®loÿ‹_d©a_block
(
fio
->
sbi
, fio->
·ge
, fio->
Şd_blkaddr
,

3203 &
fio
->
Ãw_blkaddr
, 
sum
, 
ty³
, fio, 
Œue
);

3204 ià(
	`GET_SEGNO
(
fio
->
sbi
, fio->
Şd_blkaddr
è!ğ
NULL_SEGNO
)

3205 
	`šv®id©e_m­pšg_·ges
(
	`META_MAPPING
(
fio
->
sbi
),

3206 
fio
->
Şd_blkaddr
, fio->old_blkaddr);

3209 
	`f2fs_subm™_·ge_wr™e
(
fio
);

3210 ià(
fio
->
»Œy
) {

3211 
fio
->
Şd_blkaddr
 = fio->
Ãw_blkaddr
;

3212 
»®loÿ‹
;

3215 
	`upd©e_deviû_¡©e
(
fio
);

3217 ià(
k“p_Üd”
)

3218 
	`up_»ad
(&
fio
->
sbi
->
io_Üd”_lock
);

3219 
	}
}

3221 
	$f2fs_do_wr™e_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

3222 
io¡©_ty³
 
io_ty³
)

3224 
f2fs_io_šfo
 
fio
 = {

3225 .
sbi
 = sbi,

3226 .
ty³
 = 
META
,

3227 .
‹mp
 = 
HOT
,

3228 .
İ
 = 
REQ_OP_WRITE
,

3229 .
İ_æags
 = 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
,

3230 .
Şd_blkaddr
 = 
·ge
->
šdex
,

3231 .
Ãw_blkaddr
 = 
·ge
->
šdex
,

3232 .
·ge
 =…age,

3233 .
’üy±ed_·ge
 = 
NULL
,

3234 .
š_li¡
 = 
çl£
,

3237 ià(
	`uÆik–y
(
·ge
->
šdex
 >ğ
	`MAIN_BLKADDR
(
sbi
)))

3238 
fio
.
İ_æags
 &ğ~
REQ_META
;

3240 
	`£t_·ge_wr™eback
(
·ge
);

3241 
	`CË¬PageE¼Ü
(
·ge
);

3242 
	`f2fs_subm™_·ge_wr™e
(&
fio
);

3244 
	`¡©_šc_m‘a_couÁ
(
sbi
, 
·ge
->
šdex
);

3245 
	`f2fs_upd©e_io¡©
(
sbi
, 
io_ty³
, 
F2FS_BLKSIZE
);

3246 
	}
}

3248 
	$f2fs_do_wr™e_node_·ge
(
nid
, 
f2fs_io_šfo
 *
fio
)

3250 
f2fs_summ¬y
 
sum
;

3252 
	`£t_summ¬y
(&
sum
, 
nid
, 0, 0);

3253 
	`do_wr™e_·ge
(&
sum
, 
fio
);

3255 
	`f2fs_upd©e_io¡©
(
fio
->
sbi
, fio->
io_ty³
, 
F2FS_BLKSIZE
);

3256 
	}
}

3258 
	$f2fs_ouÏû_wr™e_d©a
(
dnode_of_d©a
 *
dn
,

3259 
f2fs_io_šfo
 *
fio
)

3261 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

3262 
f2fs_summ¬y
 
sum
;

3264 
	`f2fs_bug_Ú
(
sbi
, 
dn
->
d©a_blkaddr
 =ğ
NULL_ADDR
);

3265 
	`£t_summ¬y
(&
sum
, 
dn
->
nid
, dn->
ofs_š_node
, 
fio
->
v”siÚ
);

3266 
	`do_wr™e_·ge
(&
sum
, 
fio
);

3267 
	`f2fs_upd©e_d©a_blkaddr
(
dn
, 
fio
->
Ãw_blkaddr
);

3269 
	`f2fs_upd©e_io¡©
(
sbi
, 
fio
->
io_ty³
, 
F2FS_BLKSIZE
);

3270 
	}
}

3272 
	$f2fs_š¶aû_wr™e_d©a
(
f2fs_io_šfo
 *
fio
)

3274 
”r
;

3275 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

3276 
£gno
;

3278 
fio
->
Ãw_blkaddr
 = fio->
Şd_blkaddr
;

3280 
	`__g‘_£gm’t_ty³
(
fio
);

3282 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
fio
->
Ãw_blkaddr
);

3284 ià(!
	`IS_DATASEG
(
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
ty³
)) {

3285 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

3286 
	`f2fs_w¬n
(
sbi
, "%s: incorrect segment(%u)ype,„un fscko fix.",

3287 
__func__
, 
£gno
);

3288  -
EFSCORRUPTED
;

3291 
	`¡©_šc_š¶aû_blocks
(
fio
->
sbi
);

3293 ià(
fio
->
bio
)

3294 
”r
 = 
	`f2fs_m”ge_·ge_bio
(
fio
);

3296 
”r
 = 
	`f2fs_subm™_·ge_bio
(
fio
);

3297 ià(!
”r
) {

3298 
	`upd©e_deviû_¡©e
(
fio
);

3299 
	`f2fs_upd©e_io¡©
(
fio
->
sbi
, fio->
io_ty³
, 
F2FS_BLKSIZE
);

3302  
”r
;

3303 
	}
}

3305 
šlše
 
	$__f2fs_g‘_cur£g
(
f2fs_sb_šfo
 *
sbi
,

3306 
£gno
)

3308 
i
;

3310 
i
 = 
CURSEG_HOT_DATA
; i < 
NO_CHECK_TYPE
; i++) {

3311 ià(
	`CURSEG_I
(
sbi
, 
i
)->
£gno
 == segno)

3314  
i
;

3315 
	}
}

3317 
	$f2fs_do_»¶aû_block
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

3318 
block_t
 
Şd_blkaddr
, block_ˆ
Ãw_blkaddr
,

3319 
boŞ
 
»cov”_cur£g
, boŞ 
»cov”_Ãwaddr
)

3321 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

3322 
cur£g_šfo
 *
cur£g
;

3323 
£gno
, 
Şd_cur£gno
;

3324 
£g_’Œy
 *
£
;

3325 
ty³
;

3326 
Şd_blkoff
;

3328 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
Ãw_blkaddr
);

3329 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

3330 
ty³
 = 
£
->type;

3332 
	`down_wr™e
(&
	`SM_I
(
sbi
)->
cur£g_lock
);

3334 ià(!
»cov”_cur£g
) {

3336 ià(
£
->
v®id_blocks
 =ğ0 && !
	`IS_CURSEG
(
sbi
, 
£gno
)) {

3337 ià(
Şd_blkaddr
 =ğ
NULL_ADDR
)

3338 
ty³
 = 
CURSEG_COLD_DATA
;

3340 
ty³
 = 
CURSEG_WARM_DATA
;

3343 ià(
	`IS_CURSEG
(
sbi
, 
£gno
)) {

3345 
ty³
 = 
	`__f2fs_g‘_cur£g
(
sbi
, 
£gno
);

3346 
	`f2fs_bug_Ú
(
sbi
, 
ty³
 =ğ
NO_CHECK_TYPE
);

3348 
ty³
 = 
CURSEG_WARM_DATA
;

3352 
	`f2fs_bug_Ú
(
sbi
, !
	`IS_DATASEG
(
ty³
));

3353 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

3355 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

3356 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

3358 
Şd_cur£gno
 = 
cur£g
->
£gno
;

3359 
Şd_blkoff
 = 
cur£g
->
Ãxt_blkoff
;

3362 ià(
£gno
 !ğ
cur£g
->segno) {

3363 
cur£g
->
Ãxt_£gno
 = 
£gno
;

3364 
	`chªge_cur£g
(
sbi
, 
ty³
);

3367 
cur£g
->
Ãxt_blkoff
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
Ãw_blkaddr
);

3368 
	`__add_sum_’Œy
(
sbi
, 
ty³
, 
sum
);

3370 ià(!
»cov”_cur£g
 || 
»cov”_Ãwaddr
)

3371 
	`upd©e_s™_’Œy
(
sbi
, 
Ãw_blkaddr
, 1);

3372 ià(
	`GET_SEGNO
(
sbi
, 
Şd_blkaddr
è!ğ
NULL_SEGNO
) {

3373 
	`šv®id©e_m­pšg_·ges
(
	`META_MAPPING
(
sbi
),

3374 
Şd_blkaddr
, old_blkaddr);

3375 
	`upd©e_s™_’Œy
(
sbi
, 
Şd_blkaddr
, -1);

3378 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, 
Şd_blkaddr
));

3379 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, 
Ãw_blkaddr
));

3381 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
Şd_cur£gno
);

3383 ià(
»cov”_cur£g
) {

3384 ià(
Şd_cur£gno
 !ğ
cur£g
->
£gno
) {

3385 
cur£g
->
Ãxt_£gno
 = 
Şd_cur£gno
;

3386 
	`chªge_cur£g
(
sbi
, 
ty³
);

3388 
cur£g
->
Ãxt_blkoff
 = 
Şd_blkoff
;

3391 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

3392 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

3393 
	`up_wr™e
(&
	`SM_I
(
sbi
)->
cur£g_lock
);

3394 
	}
}

3396 
	$f2fs_»¶aû_block
(
f2fs_sb_šfo
 *
sbi
, 
dnode_of_d©a
 *
dn
,

3397 
block_t
 
Şd_addr
, block_ˆ
Ãw_addr
,

3398 
v”siÚ
, 
boŞ
 
»cov”_cur£g
,

3399 
boŞ
 
»cov”_Ãwaddr
)

3401 
f2fs_summ¬y
 
sum
;

3403 
	`£t_summ¬y
(&
sum
, 
dn
->
nid
, dn->
ofs_š_node
, 
v”siÚ
);

3405 
	`f2fs_do_»¶aû_block
(
sbi
, &
sum
, 
Şd_addr
, 
Ãw_addr
,

3406 
»cov”_cur£g
, 
»cov”_Ãwaddr
);

3408 
	`f2fs_upd©e_d©a_blkaddr
(
dn
, 
Ãw_addr
);

3409 
	}
}

3411 
	$f2fs_wa™_Ú_·ge_wr™eback
(
·ge
 *page,

3412 
·ge_ty³
 
ty³
, 
boŞ
 
Üd”ed
, boŞ 
locked
)

3414 ià(
	`PageWr™eback
(
·ge
)) {

3415 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

3417 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
sbi
, 
NULL
, 
·ge
, 0, 
ty³
);

3418 ià(
Üd”ed
) {

3419 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

3420 
	`f2fs_bug_Ú
(
sbi
, 
locked
 && 
	`PageWr™eback
(
·ge
));

3422 
	`wa™_fÜ_¡abË_·ge
(
·ge
);

3425 
	}
}

3427 
	$f2fs_wa™_Ú_block_wr™eback
(
šode
 *šode, 
block_t
 
blkaddr
)

3429 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

3430 
·ge
 *
ıage
;

3432 ià(!
	`f2fs_po¡_»ad_»quœed
(
šode
))

3435 ià(!
	`__is_v®id_d©a_blkaddr
(
blkaddr
))

3438 
ıage
 = 
	`fšd_lock_·ge
(
	`META_MAPPING
(
sbi
), 
blkaddr
);

3439 ià(
ıage
) {

3440 
	`f2fs_wa™_Ú_·ge_wr™eback
(
ıage
, 
DATA
, 
Œue
,rue);

3441 
	`f2fs_put_·ge
(
ıage
, 1);

3443 
	}
}

3445 
	$f2fs_wa™_Ú_block_wr™eback_¿nge
(
šode
 *šode, 
block_t
 
blkaddr
,

3446 
block_t
 
Ën
)

3448 
block_t
 
i
;

3450 
i
 = 0; i < 
Ën
; i++)

3451 
	`f2fs_wa™_Ú_block_wr™eback
(
šode
, 
blkaddr
 + 
i
);

3452 
	}
}

3454 
	$»ad_com·ùed_summ¬›s
(
f2fs_sb_šfo
 *
sbi
)

3456 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

3457 
cur£g_šfo
 *
£g_i
;

3458 *
kaddr
;

3459 
·ge
 *page;

3460 
block_t
 
¡¬t
;

3461 
i
, 
j
, 
off£t
;

3463 
¡¬t
 = 
	`¡¬t_sum_block
(
sbi
);

3465 
·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
¡¬t
++);

3466 ià(
	`IS_ERR
(
·ge
))

3467  
	`PTR_ERR
(
·ge
);

3468 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

3471 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

3472 
	`memıy
(
£g_i
->
jouº®
, 
kaddr
, 
SUM_JOURNAL_SIZE
);

3475 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

3476 
	`memıy
(
£g_i
->
jouº®
, 
kaddr
 + 
SUM_JOURNAL_SIZE
, SUM_JOURNAL_SIZE);

3477 
off£t
 = 2 * 
SUM_JOURNAL_SIZE
;

3480 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

3481 
blk_off
;

3482 
£gno
;

3484 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
i
);

3485 
£gno
 = 
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
i
]);

3486 
blk_off
 = 
	`Ë16_to_ıu
(
ck±
->
cur_d©a_blkoff
[
i
]);

3487 
£g_i
->
Ãxt_£gno
 = 
£gno
;

3488 
	`»£t_cur£g
(
sbi
, 
i
, 0);

3489 
£g_i
->
®loc_ty³
 = 
ck±
->®loc_ty³[
i
];

3490 
£g_i
->
Ãxt_blkoff
 = 
blk_off
;

3492 ià(
£g_i
->
®loc_ty³
 =ğ
SSR
)

3493 
blk_off
 = 
sbi
->
blocks_³r_£g
;

3495 
j
 = 0; j < 
blk_off
; j++) {

3496 
f2fs_summ¬y
 *
s
;

3497 
s
 = (
f2fs_summ¬y
 *)(
kaddr
 + 
off£t
);

3498 
£g_i
->
sum_blk
->
’Œ›s
[
j
] = *
s
;

3499 
off£t
 +ğ
SUMMARY_SIZE
;

3500 ià(
off£t
 + 
SUMMARY_SIZE
 <ğ
PAGE_SIZE
 -

3501 
SUM_FOOTER_SIZE
)

3504 
	`f2fs_put_·ge
(
·ge
, 1);

3505 
·ge
 = 
NULL
;

3507 
·ge
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
¡¬t
++);

3508 ià(
	`IS_ERR
(
·ge
))

3509  
	`PTR_ERR
(
·ge
);

3510 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

3511 
off£t
 = 0;

3514 
	`f2fs_put_·ge
(
·ge
, 1);

3516 
	}
}

3518 
	$»ad_nÜm®_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

3520 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

3521 
f2fs_summ¬y_block
 *
sum
;

3522 
cur£g_šfo
 *
cur£g
;

3523 
·ge
 *
Ãw
;

3524 
blk_off
;

3525 
£gno
 = 0;

3526 
block_t
 
blk_addr
 = 0;

3527 
”r
 = 0;

3530 ià(
	`IS_DATASEG
(
ty³
)) {

3531 
£gno
 = 
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
ty³
]);

3532 
blk_off
 = 
	`Ë16_to_ıu
(
ck±
->
cur_d©a_blkoff
[
ty³
 -

3533 
CURSEG_HOT_DATA
]);

3534 ià(
	`__exi¡_node_summ¬›s
(
sbi
))

3535 
blk_addr
 = 
	`sum_blk_addr
(
sbi
, 
NR_CURSEG_TYPE
, 
ty³
);

3537 
blk_addr
 = 
	`sum_blk_addr
(
sbi
, 
NR_CURSEG_DATA_TYPE
, 
ty³
);

3539 
£gno
 = 
	`Ë32_to_ıu
(
ck±
->
cur_node_£gno
[
ty³
 -

3540 
CURSEG_HOT_NODE
]);

3541 
blk_off
 = 
	`Ë16_to_ıu
(
ck±
->
cur_node_blkoff
[
ty³
 -

3542 
CURSEG_HOT_NODE
]);

3543 ià(
	`__exi¡_node_summ¬›s
(
sbi
))

3544 
blk_addr
 = 
	`sum_blk_addr
(
sbi
, 
NR_CURSEG_NODE_TYPE
,

3545 
ty³
 - 
CURSEG_HOT_NODE
);

3547 
blk_addr
 = 
	`GET_SUM_BLOCK
(
sbi
, 
£gno
);

3550 
Ãw
 = 
	`f2fs_g‘_m‘a_·ge
(
sbi
, 
blk_addr
);

3551 ià(
	`IS_ERR
(
Ãw
))

3552  
	`PTR_ERR
(
Ãw
);

3553 
sum
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
Ãw
);

3555 ià(
	`IS_NODESEG
(
ty³
)) {

3556 ià(
	`__exi¡_node_summ¬›s
(
sbi
)) {

3557 
f2fs_summ¬y
 *
ns
 = &
sum
->
’Œ›s
[0];

3558 
i
;

3559 
i
 = 0; i < 
sbi
->
blocks_³r_£g
; i++, 
ns
++) {

3560 
ns
->
v”siÚ
 = 0;

3561 
ns
->
ofs_š_node
 = 0;

3564 
”r
 = 
	`f2fs_»¡Üe_node_summ¬y
(
sbi
, 
£gno
, 
sum
);

3565 ià(
”r
)

3566 
out
;

3571 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

3572 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

3575 
	`down_wr™e
(&
cur£g
->
jouº®_rw£m
);

3576 
	`memıy
(
cur£g
->
jouº®
, &
sum
->jouº®, 
SUM_JOURNAL_SIZE
);

3577 
	`up_wr™e
(&
cur£g
->
jouº®_rw£m
);

3579 
	`memıy
(
cur£g
->
sum_blk
->
’Œ›s
, 
sum
->’Œ›s, 
SUM_ENTRY_SIZE
);

3580 
	`memıy
(&
cur£g
->
sum_blk
->
foÙ”
, &
sum
->foÙ”, 
SUM_FOOTER_SIZE
);

3581 
cur£g
->
Ãxt_£gno
 = 
£gno
;

3582 
	`»£t_cur£g
(
sbi
, 
ty³
, 0);

3583 
cur£g
->
®loc_ty³
 = 
ck±
->®loc_ty³[
ty³
];

3584 
cur£g
->
Ãxt_blkoff
 = 
blk_off
;

3585 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

3586 
out
:

3587 
	`f2fs_put_·ge
(
Ãw
, 1);

3588  
”r
;

3589 
	}
}

3591 
	$»¡Üe_cur£g_summ¬›s
(
f2fs_sb_šfo
 *
sbi
)

3593 
f2fs_jouº®
 *
s™_j
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
)->
jouº®
;

3594 
f2fs_jouº®
 *
Çt_j
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
)->
jouº®
;

3595 
ty³
 = 
CURSEG_HOT_DATA
;

3596 
”r
;

3598 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_COMPACT_SUM_FLAG
)) {

3599 
Åages
 = 
	`f2fs_Åages_fÜ_summ¬y_æush
(
sbi
, 
Œue
);

3601 ià(
Åages
 >= 2)

3602 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`¡¬t_sum_block
(sbi), 
Åages
,

3603 
META_CP
, 
Œue
);

3606 
”r
 = 
	`»ad_com·ùed_summ¬›s
(
sbi
);

3607 ià(
”r
)

3608  
”r
;

3609 
ty³
 = 
CURSEG_HOT_NODE
;

3612 ià(
	`__exi¡_node_summ¬›s
(
sbi
))

3613 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
	`sum_blk_addr
(sbi, 
NR_CURSEG_TYPE
, 
ty³
),

3614 
NR_CURSEG_TYPE
 - 
ty³
, 
META_CP
, 
Œue
);

3616 ; 
ty³
 <ğ
CURSEG_COLD_NODE
;ype++) {

3617 
”r
 = 
	`»ad_nÜm®_summ¬›s
(
sbi
, 
ty³
);

3618 ià(
”r
)

3619  
”r
;

3623 ià(
	`Çts_š_cursum
(
Çt_j
è> 
NAT_JOURNAL_ENTRIES
 ||

3624 
	`s™s_š_cursum
(
s™_j
è> 
SIT_JOURNAL_ENTRIES
) {

3625 
	`f2fs_”r
(
sbi
, "invalid journalƒntries‚ats %u sits %u\n",

3626 
	`Çts_š_cursum
(
Çt_j
), 
	`s™s_š_cursum
(
s™_j
));

3627  -
EINVAL
;

3631 
	}
}

3633 
	$wr™e_com·ùed_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

3635 
·ge
 *page;

3636 *
kaddr
;

3637 
f2fs_summ¬y
 *
summ¬y
;

3638 
cur£g_šfo
 *
£g_i
;

3639 
wr™‹n_size
 = 0;

3640 
i
, 
j
;

3642 
·ge
 = 
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
blkaddr
++);

3643 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

3644 
	`mem£t
(
kaddr
, 0, 
PAGE_SIZE
);

3647 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

3648 
	`memıy
(
kaddr
, 
£g_i
->
jouº®
, 
SUM_JOURNAL_SIZE
);

3649 
wr™‹n_size
 +ğ
SUM_JOURNAL_SIZE
;

3652 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

3653 
	`memıy
(
kaddr
 + 
wr™‹n_size
, 
£g_i
->
jouº®
, 
SUM_JOURNAL_SIZE
);

3654 
wr™‹n_size
 +ğ
SUM_JOURNAL_SIZE
;

3657 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

3658 
blkoff
;

3659 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
i
);

3660 ià(
sbi
->
ck±
->
®loc_ty³
[
i
] =ğ
SSR
)

3661 
blkoff
 = 
sbi
->
blocks_³r_£g
;

3663 
blkoff
 = 
	`cur£g_blkoff
(
sbi
, 
i
);

3665 
j
 = 0; j < 
blkoff
; j++) {

3666 ià(!
·ge
) {

3667 
·ge
 = 
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
blkaddr
++);

3668 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

3669 
	`mem£t
(
kaddr
, 0, 
PAGE_SIZE
);

3670 
wr™‹n_size
 = 0;

3672 
summ¬y
 = (
f2fs_summ¬y
 *)(
kaddr
 + 
wr™‹n_size
);

3673 *
summ¬y
 = 
£g_i
->
sum_blk
->
’Œ›s
[
j
];

3674 
wr™‹n_size
 +ğ
SUMMARY_SIZE
;

3676 ià(
wr™‹n_size
 + 
SUMMARY_SIZE
 <ğ
PAGE_SIZE
 -

3677 
SUM_FOOTER_SIZE
)

3680 
	`£t_·ge_dœty
(
·ge
);

3681 
	`f2fs_put_·ge
(
·ge
, 1);

3682 
·ge
 = 
NULL
;

3685 ià(
·ge
) {

3686 
	`£t_·ge_dœty
(
·ge
);

3687 
	`f2fs_put_·ge
(
·ge
, 1);

3689 
	}
}

3691 
	$wr™e_nÜm®_summ¬›s
(
f2fs_sb_šfo
 *
sbi
,

3692 
block_t
 
blkaddr
, 
ty³
)

3694 
i
, 
’d
;

3695 ià(
	`IS_DATASEG
(
ty³
))

3696 
’d
 = 
ty³
 + 
NR_CURSEG_DATA_TYPE
;

3698 
’d
 = 
ty³
 + 
NR_CURSEG_NODE_TYPE
;

3700 
i
 = 
ty³
; i < 
’d
; i++)

3701 
	`wr™e_cu¼’t_sum_·ge
(
sbi
, 
i
, 
blkaddr
 + (˜- 
ty³
));

3702 
	}
}

3704 
	$f2fs_wr™e_d©a_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
)

3706 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_COMPACT_SUM_FLAG
))

3707 
	`wr™e_com·ùed_summ¬›s
(
sbi
, 
¡¬t_blk
);

3709 
	`wr™e_nÜm®_summ¬›s
(
sbi
, 
¡¬t_blk
, 
CURSEG_HOT_DATA
);

3710 
	}
}

3712 
	$f2fs_wr™e_node_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
)

3714 
	`wr™e_nÜm®_summ¬›s
(
sbi
, 
¡¬t_blk
, 
CURSEG_HOT_NODE
);

3715 
	}
}

3717 
	$f2fs_lookup_jouº®_š_cursum
(
f2fs_jouº®
 *
jouº®
, 
ty³
,

3718 
v®
, 
®loc
)

3720 
i
;

3722 ià(
ty³
 =ğ
NAT_JOURNAL
) {

3723 
i
 = 0; i < 
	`Çts_š_cursum
(
jouº®
); i++) {

3724 ià(
	`Ë32_to_ıu
(
	`nid_š_jouº®
(
jouº®
, 
i
)è=ğ
v®
)

3725  
i
;

3727 ià(
®loc
 && 
	`__has_cursum_¥aû
(
jouº®
, 1, 
NAT_JOURNAL
))

3728  
	`upd©e_Çts_š_cursum
(
jouº®
, 1);

3729 } ià(
ty³
 =ğ
SIT_JOURNAL
) {

3730 
i
 = 0; i < 
	`s™s_š_cursum
(
jouº®
); i++)

3731 ià(
	`Ë32_to_ıu
(
	`£gno_š_jouº®
(
jouº®
, 
i
)è=ğ
v®
)

3732  
i
;

3733 ià(
®loc
 && 
	`__has_cursum_¥aû
(
jouº®
, 1, 
SIT_JOURNAL
))

3734  
	`upd©e_s™s_š_cursum
(
jouº®
, 1);

3737 
	}
}

3739 
·ge
 *
	$g‘_cu¼’t_s™_·ge
(
f2fs_sb_šfo
 *
sbi
,

3740 
£gno
)

3742  
	`f2fs_g‘_m‘a_·ge_noç
(
sbi
, 
	`cu¼’t_s™_addr
(sbi, 
£gno
));

3743 
	}
}

3745 
·ge
 *
	$g‘_Ãxt_s™_·ge
(
f2fs_sb_šfo
 *
sbi
,

3746 
¡¬t
)

3748 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

3749 
·ge
 *page;

3750 
pgoff_t
 
¤c_off
, 
d¡_off
;

3752 
¤c_off
 = 
	`cu¼’t_s™_addr
(
sbi
, 
¡¬t
);

3753 
d¡_off
 = 
	`Ãxt_s™_addr
(
sbi
, 
¤c_off
);

3755 
·ge
 = 
	`f2fs_g¿b_m‘a_·ge
(
sbi
, 
d¡_off
);

3756 
	`£g_šfo_to_s™_·ge
(
sbi
, 
·ge
, 
¡¬t
);

3758 
	`£t_·ge_dœty
(
·ge
);

3759 
	`£t_to_Ãxt_s™
(
s™_i
, 
¡¬t
);

3761  
·ge
;

3762 
	}
}

3764 
s™_’Œy_£t
 *
	$g¿b_s™_’Œy_£t
()

3766 
s™_’Œy_£t
 *
£s
 =

3767 
	`f2fs_kmem_ÿche_®loc
(
s™_’Œy_£t_¦ab
, 
GFP_NOFS
);

3769 
£s
->
’Œy_út
 = 0;

3770 
	`INIT_LIST_HEAD
(&
£s
->
£t_li¡
);

3771  
£s
;

3772 
	}
}

3774 
	$»Ëa£_s™_’Œy_£t
(
s™_’Œy_£t
 *
£s
)

3776 
	`li¡_d–
(&
£s
->
£t_li¡
);

3777 
	`kmem_ÿche_ä“
(
s™_’Œy_£t_¦ab
, 
£s
);

3778 
	}
}

3780 
	$adju¡_s™_’Œy_£t
(
s™_’Œy_£t
 *
£s
,

3781 
li¡_h—d
 *
h—d
)

3783 
s™_’Œy_£t
 *
Ãxt
 = 
£s
;

3785 ià(
	`li¡_is_Ï¡
(&
£s
->
£t_li¡
, 
h—d
))

3788 
	`li¡_fÜ_—ch_’Œy_cÚtšue
(
Ãxt
, 
h—d
, 
£t_li¡
)

3789 ià(
£s
->
’Œy_út
 <ğ
Ãxt
->entry_cnt)

3792 
	`li¡_move_
(&
£s
->
£t_li¡
, &
Ãxt
->set_list);

3793 
	}
}

3795 
	$add_s™_’Œy
(
£gno
, 
li¡_h—d
 *
h—d
)

3797 
s™_’Œy_£t
 *
£s
;

3798 
¡¬t_£gno
 = 
	`START_SEGNO
(
£gno
);

3800 
	`li¡_fÜ_—ch_’Œy
(
£s
, 
h—d
, 
£t_li¡
) {

3801 ià(
£s
->
¡¬t_£gno
 == start_segno) {

3802 
£s
->
’Œy_út
++;

3803 
	`adju¡_s™_’Œy_£t
(
£s
, 
h—d
);

3808 
£s
 = 
	`g¿b_s™_’Œy_£t
();

3810 
£s
->
¡¬t_£gno
 = start_segno;

3811 
£s
->
’Œy_út
++;

3812 
	`li¡_add
(&
£s
->
£t_li¡
, 
h—d
);

3813 
	}
}

3815 
	$add_s™s_š_£t
(
f2fs_sb_šfo
 *
sbi
)

3817 
f2fs_sm_šfo
 *
sm_šfo
 = 
	`SM_I
(
sbi
);

3818 
li¡_h—d
 *
£t_li¡
 = &
sm_šfo
->
s™_’Œy_£t
;

3819 *
b™m­
 = 
	`SIT_I
(
sbi
)->
dœty_£Ár›s_b™m­
;

3820 
£gno
;

3822 
	`fÜ_—ch_£t_b™
(
£gno
, 
b™m­
, 
	`MAIN_SEGS
(
sbi
))

3823 
	`add_s™_’Œy
(
£gno
, 
£t_li¡
);

3824 
	}
}

3826 
	$»move_s™s_š_jouº®
(
f2fs_sb_šfo
 *
sbi
)

3828 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

3829 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

3830 
i
;

3832 
	`down_wr™e
(&
cur£g
->
jouº®_rw£m
);

3833 
i
 = 0; i < 
	`s™s_š_cursum
(
jouº®
); i++) {

3834 
£gno
;

3835 
boŞ
 
dœt›d
;

3837 
£gno
 = 
	`Ë32_to_ıu
(
	`£gno_š_jouº®
(
jouº®
, 
i
));

3838 
dœt›d
 = 
	`__m¬k_s™_’Œy_dœty
(
sbi
, 
£gno
);

3840 ià(!
dœt›d
)

3841 
	`add_s™_’Œy
(
£gno
, &
	`SM_I
(
sbi
)->
s™_’Œy_£t
);

3843 
	`upd©e_s™s_š_cursum
(
jouº®
, -
i
);

3844 
	`up_wr™e
(&
cur£g
->
jouº®_rw£m
);

3845 
	}
}

3851 
	$f2fs_æush_s™_’Œ›s
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

3853 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

3854 *
b™m­
 = 
s™_i
->
dœty_£Ár›s_b™m­
;

3855 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

3856 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

3857 
s™_’Œy_£t
 *
£s
, *
tmp
;

3858 
li¡_h—d
 *
h—d
 = &
	`SM_I
(
sbi
)->
s™_’Œy_£t
;

3859 
boŞ
 
to_jouº®
 = !
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_RESIZEFS
);

3860 
£g_’Œy
 *
£
;

3862 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

3864 ià(!
s™_i
->
dœty_£Ár›s
)

3865 
out
;

3871 
	`add_s™s_š_£t
(
sbi
);

3878 ià(!
	`__has_cursum_¥aû
(
jouº®
, 
s™_i
->
dœty_£Ár›s
, 
SIT_JOURNAL
) ||

3879 !
to_jouº®
)

3880 
	`»move_s™s_š_jouº®
(
sbi
);

3887 
	`li¡_fÜ_—ch_’Œy_§ã
(
£s
, 
tmp
, 
h—d
, 
£t_li¡
) {

3888 
·ge
 *·gğ
NULL
;

3889 
f2fs_s™_block
 *
¿w_s™
 = 
NULL
;

3890 
¡¬t_£gno
 = 
£s
->start_segno;

3891 
’d
 = 
	`mš
(
¡¬t_£gno
 + 
SIT_ENTRY_PER_BLOCK
,

3892 ()
	`MAIN_SEGS
(
sbi
));

3893 
£gno
 = 
¡¬t_£gno
;

3895 ià(
to_jouº®
 &&

3896 !
	`__has_cursum_¥aû
(
jouº®
, 
£s
->
’Œy_út
, 
SIT_JOURNAL
))

3897 
to_jouº®
 = 
çl£
;

3899 ià(
to_jouº®
) {

3900 
	`down_wr™e
(&
cur£g
->
jouº®_rw£m
);

3902 
·ge
 = 
	`g‘_Ãxt_s™_·ge
(
sbi
, 
¡¬t_£gno
);

3903 
¿w_s™
 = 
	`·ge_add»ss
(
·ge
);

3907 
	`fÜ_—ch_£t_b™_äom
(
£gno
, 
b™m­
, 
’d
) {

3908 
off£t
, 
s™_off£t
;

3910 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

3911 #ifdeà
CONFIG_F2FS_CHECK_FS


3912 ià(
	`memcmp
(
£
->
cur_v®id_m­
, se->
cur_v®id_m­_mœ
,

3913 
SIT_VBLOCK_MAP_SIZE
))

3914 
	`f2fs_bug_Ú
(
sbi
, 1);

3918 ià(!(
ıc
->
»asÚ
 & 
CP_DISCARD
)) {

3919 
ıc
->
Œim_¡¬t
 = 
£gno
;

3920 
	`add_disÿrd_addrs
(
sbi
, 
ıc
, 
çl£
);

3923 ià(
to_jouº®
) {

3924 
off£t
 = 
	`f2fs_lookup_jouº®_š_cursum
(
jouº®
,

3925 
SIT_JOURNAL
, 
£gno
, 1);

3926 
	`f2fs_bug_Ú
(
sbi
, 
off£t
 < 0);

3927 
	`£gno_š_jouº®
(
jouº®
, 
off£t
) =

3928 
	`ıu_to_Ë32
(
£gno
);

3929 
	`£g_šfo_to_¿w_s™
(
£
,

3930 &
	`s™_š_jouº®
(
jouº®
, 
off£t
));

3931 
	`check_block_couÁ
(
sbi
, 
£gno
,

3932 &
	`s™_š_jouº®
(
jouº®
, 
off£t
));

3934 
s™_off£t
 = 
	`SIT_ENTRY_OFFSET
(
s™_i
, 
£gno
);

3935 
	`£g_šfo_to_¿w_s™
(
£
,

3936 &
¿w_s™
->
’Œ›s
[
s™_off£t
]);

3937 
	`check_block_couÁ
(
sbi
, 
£gno
,

3938 &
¿w_s™
->
’Œ›s
[
s™_off£t
]);

3941 
	`__ş—r_b™
(
£gno
, 
b™m­
);

3942 
s™_i
->
dœty_£Ár›s
--;

3943 
£s
->
’Œy_út
--;

3946 ià(
to_jouº®
)

3947 
	`up_wr™e
(&
cur£g
->
jouº®_rw£m
);

3949 
	`f2fs_put_·ge
(
·ge
, 1);

3951 
	`f2fs_bug_Ú
(
sbi
, 
£s
->
’Œy_út
);

3952 
	`»Ëa£_s™_’Œy_£t
(
£s
);

3955 
	`f2fs_bug_Ú
(
sbi
, !
	`li¡_em±y
(
h—d
));

3956 
	`f2fs_bug_Ú
(
sbi
, 
s™_i
->
dœty_£Ár›s
);

3957 
out
:

3958 ià(
ıc
->
»asÚ
 & 
CP_DISCARD
) {

3959 
__u64
 
Œim_¡¬t
 = 
ıc
->trim_start;

3961 ; 
ıc
->
Œim_¡¬t
 <ğıc->
Œim_’d
; cpc->trim_start++)

3962 
	`add_disÿrd_addrs
(
sbi
, 
ıc
, 
çl£
);

3964 
ıc
->
Œim_¡¬t
 =rim_start;

3966 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

3968 
	`£t_´eä“_as_ä“_£gm’ts
(
sbi
);

3969 
	}
}

3971 
	$bud_s™_šfo
(
f2fs_sb_šfo
 *
sbi
)

3973 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

3974 
s™_šfo
 *
s™_i
;

3975 
s™_£gs
, 
¡¬t
;

3976 *
¤c_b™m­
, *
b™m­
;

3977 
b™m­_size
, 
maš_b™m­_size
, 
s™_b™m­_size
;

3980 
s™_i
 = 
	`f2fs_kz®loc
(
sbi
, (
s™_šfo
), 
GFP_KERNEL
);

3981 ià(!
s™_i
)

3982  -
ENOMEM
;

3984 
	`SM_I
(
sbi
)->
s™_šfo
 = 
s™_i
;

3986 
s™_i
->
£Ár›s
 =

3987 
	`f2fs_kvz®loc
(
sbi
, 
	`¬¿y_size
((
£g_’Œy
),

3988 
	`MAIN_SEGS
(
sbi
)),

3989 
GFP_KERNEL
);

3990 ià(!
s™_i
->
£Ár›s
)

3991  -
ENOMEM
;

3993 
maš_b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

3994 
s™_i
->
dœty_£Ár›s_b™m­
 = 
	`f2fs_kvz®loc
(
sbi
, 
maš_b™m­_size
,

3995 
GFP_KERNEL
);

3996 ià(!
s™_i
->
dœty_£Ár›s_b™m­
)

3997  -
ENOMEM
;

3999 #ifdeà
CONFIG_F2FS_CHECK_FS


4000 
b™m­_size
 = 
	`MAIN_SEGS
(
sbi
è* 
SIT_VBLOCK_MAP_SIZE
 * 4;

4002 
b™m­_size
 = 
	`MAIN_SEGS
(
sbi
è* 
SIT_VBLOCK_MAP_SIZE
 * 3;

4004 
s™_i
->
b™m­
 = 
	`f2fs_kvz®loc
(
sbi
, 
b™m­_size
, 
GFP_KERNEL
);

4005 ià(!
s™_i
->
b™m­
)

4006  -
ENOMEM
;

4008 
b™m­
 = 
s™_i
->bitmap;

4010 
¡¬t
 = 0; s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

4011 
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­
 = 
b™m­
;

4012 
b™m­
 +ğ
SIT_VBLOCK_MAP_SIZE
;

4014 
s™_i
->
£Ár›s
[
¡¬t
].
ck±_v®id_m­
 = 
b™m­
;

4015 
b™m­
 +ğ
SIT_VBLOCK_MAP_SIZE
;

4017 #ifdeà
CONFIG_F2FS_CHECK_FS


4018 
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­_mœ
 = 
b™m­
;

4019 
b™m­
 +ğ
SIT_VBLOCK_MAP_SIZE
;

4022 
s™_i
->
£Ár›s
[
¡¬t
].
disÿrd_m­
 = 
b™m­
;

4023 
b™m­
 +ğ
SIT_VBLOCK_MAP_SIZE
;

4026 
s™_i
->
tmp_m­
 = 
	`f2fs_kz®loc
(
sbi
, 
SIT_VBLOCK_MAP_SIZE
, 
GFP_KERNEL
);

4027 ià(!
s™_i
->
tmp_m­
)

4028  -
ENOMEM
;

4030 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
)) {

4031 
s™_i
->
£c_’Œ›s
 =

4032 
	`f2fs_kvz®loc
(
sbi
, 
	`¬¿y_size
((
£c_’Œy
),

4033 
	`MAIN_SECS
(
sbi
)),

4034 
GFP_KERNEL
);

4035 ià(!
s™_i
->
£c_’Œ›s
)

4036  -
ENOMEM
;

4040 
s™_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s™
) >> 1;

4043 
s™_b™m­_size
 = 
	`__b™m­_size
(
sbi
, 
SIT_BITMAP
);

4044 
¤c_b™m­
 = 
	`__b™m­_±r
(
sbi
, 
SIT_BITMAP
);

4046 
s™_i
->
s™_b™m­
 = 
	`kmemdup
(
¤c_b™m­
, 
s™_b™m­_size
, 
GFP_KERNEL
);

4047 ià(!
s™_i
->
s™_b™m­
)

4048  -
ENOMEM
;

4050 #ifdeà
CONFIG_F2FS_CHECK_FS


4051 
s™_i
->
s™_b™m­_mœ
 = 
	`kmemdup
(
¤c_b™m­
,

4052 
s™_b™m­_size
, 
GFP_KERNEL
);

4053 ià(!
s™_i
->
s™_b™m­_mœ
)

4054  -
ENOMEM
;

4056 
s™_i
->
šv®id_£gm­
 = 
	`f2fs_kvz®loc
(
sbi
,

4057 
maš_b™m­_size
, 
GFP_KERNEL
);

4058 ià(!
s™_i
->
šv®id_£gm­
)

4059  -
ENOMEM
;

4063 
s™_i
->
s_İs
 = &
deçuÉ_§Îoc_İs
;

4065 
s™_i
->
s™_ba£_addr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
s™_blkaddr
);

4066 
s™_i
->
s™_blocks
 = 
s™_£gs
 << 
sbi
->
log_blocks_³r_£g
;

4067 
s™_i
->
wr™‹n_v®id_blocks
 = 0;

4068 
s™_i
->
b™m­_size
 = 
s™_b™m­_size
;

4069 
s™_i
->
dœty_£Ár›s
 = 0;

4070 
s™_i
->
£Ás_³r_block
 = 
SIT_ENTRY_PER_BLOCK
;

4071 
s™_i
->
–­£d_time
 = 
	`Ë64_to_ıu
(
sbi
->
ck±
->elapsed_time);

4072 
s™_i
->
mouÁed_time
 = 
	`ktime_g‘_»®_£cÚds
();

4073 
	`š™_rw£m
(&
s™_i
->
£Áry_lock
);

4075 
	}
}

4077 
	$bud_ä“_£gm­
(
f2fs_sb_šfo
 *
sbi
)

4079 
ä“_£gm­_šfo
 *
ä“_i
;

4080 
b™m­_size
, 
£c_b™m­_size
;

4083 
ä“_i
 = 
	`f2fs_kz®loc
(
sbi
, (
ä“_£gm­_šfo
), 
GFP_KERNEL
);

4084 ià(!
ä“_i
)

4085  -
ENOMEM
;

4087 
	`SM_I
(
sbi
)->
ä“_šfo
 = 
ä“_i
;

4089 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

4090 
ä“_i
->
ä“_£gm­
 = 
	`f2fs_kvm®loc
(
sbi
, 
b™m­_size
, 
GFP_KERNEL
);

4091 ià(!
ä“_i
->
ä“_£gm­
)

4092  -
ENOMEM
;

4094 
£c_b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

4095 
ä“_i
->
ä“_£cm­
 = 
	`f2fs_kvm®loc
(
sbi
, 
£c_b™m­_size
, 
GFP_KERNEL
);

4096 ià(!
ä“_i
->
ä“_£cm­
)

4097  -
ENOMEM
;

4100 
	`mem£t
(
ä“_i
->
ä“_£gm­
, 0xff, 
b™m­_size
);

4101 
	`mem£t
(
ä“_i
->
ä“_£cm­
, 0xff, 
£c_b™m­_size
);

4104 
ä“_i
->
¡¬t_£gno
 = 
	`GET_SEGNO_FROM_SEG0
(
sbi
, 
	`MAIN_BLKADDR
(sbi));

4105 
ä“_i
->
ä“_£gm’ts
 = 0;

4106 
ä“_i
->
ä“_£ùiÚs
 = 0;

4107 
	`¥š_lock_š™
(&
ä“_i
->
£gm­_lock
);

4109 
	}
}

4111 
	$bud_cur£g
(
f2fs_sb_šfo
 *
sbi
)

4113 
cur£g_šfo
 *
¬¿y
;

4114 
i
;

4116 
¬¿y
 = 
	`f2fs_kz®loc
(
sbi
, 
	`¬¿y_size
(
NR_CURSEG_TYPE
, (*array)),

4117 
GFP_KERNEL
);

4118 ià(!
¬¿y
)

4119  -
ENOMEM
;

4121 
	`SM_I
(
sbi
)->
cur£g_¬¿y
 = 
¬¿y
;

4123 
i
 = 0; i < 
NR_CURSEG_TYPE
; i++) {

4124 
	`mu‹x_š™
(&
¬¿y
[
i
].
cur£g_mu‹x
);

4125 
¬¿y
[
i
].
sum_blk
 = 
	`f2fs_kz®loc
(
sbi
, 
PAGE_SIZE
, 
GFP_KERNEL
);

4126 ià(!
¬¿y
[
i
].
sum_blk
)

4127  -
ENOMEM
;

4128 
	`š™_rw£m
(&
¬¿y
[
i
].
jouº®_rw£m
);

4129 
¬¿y
[
i
].
jouº®
 = 
	`f2fs_kz®loc
(
sbi
,

4130 (
f2fs_jouº®
), 
GFP_KERNEL
);

4131 ià(!
¬¿y
[
i
].
jouº®
)

4132  -
ENOMEM
;

4133 
¬¿y
[
i
].
£gno
 = 
NULL_SEGNO
;

4134 
¬¿y
[
i
].
Ãxt_blkoff
 = 0;

4136  
	`»¡Üe_cur£g_summ¬›s
(
sbi
);

4137 
	}
}

4139 
	$bud_s™_’Œ›s
(
f2fs_sb_šfo
 *
sbi
)

4141 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

4142 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

4143 
f2fs_jouº®
 *
jouº®
 = 
cur£g
->journal;

4144 
£g_’Œy
 *
£
;

4145 
f2fs_s™_’Œy
 
s™
;

4146 
s™_blk_út
 = 
	`SIT_BLK_CNT
(
sbi
);

4147 
i
, 
¡¬t
, 
’d
;

4148 
»aded
, 
¡¬t_blk
 = 0;

4149 
”r
 = 0;

4150 
block_t
 
tÙ®_node_blocks
 = 0;

4153 
»aded
 = 
	`f2fs_¿_m‘a_·ges
(
sbi
, 
¡¬t_blk
, 
BIO_MAX_PAGES
,

4154 
META_SIT
, 
Œue
);

4156 
¡¬t
 = 
¡¬t_blk
 * 
s™_i
->
£Ás_³r_block
;

4157 
’d
 = (
¡¬t_blk
 + 
»aded
è* 
s™_i
->
£Ás_³r_block
;

4159 ; 
¡¬t
 < 
’d
 && s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

4160 
f2fs_s™_block
 *
s™_blk
;

4161 
·ge
 *page;

4163 
£
 = &
s™_i
->
£Ár›s
[
¡¬t
];

4164 
·ge
 = 
	`g‘_cu¼’t_s™_·ge
(
sbi
, 
¡¬t
);

4165 ià(
	`IS_ERR
(
·ge
))

4166  
	`PTR_ERR
(
·ge
);

4167 
s™_blk
 = (
f2fs_s™_block
 *)
	`·ge_add»ss
(
·ge
);

4168 
s™
 = 
s™_blk
->
’Œ›s
[
	`SIT_ENTRY_OFFSET
(
s™_i
, 
¡¬t
)];

4169 
	`f2fs_put_·ge
(
·ge
, 1);

4171 
”r
 = 
	`check_block_couÁ
(
sbi
, 
¡¬t
, &
s™
);

4172 ià(
”r
)

4173  
”r
;

4174 
	`£g_šfo_äom_¿w_s™
(
£
, &
s™
);

4175 ià(
	`IS_NODESEG
(
£
->
ty³
))

4176 
tÙ®_node_blocks
 +ğ
£
->
v®id_blocks
;

4179 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_TRIMMED_FLAG
)) {

4180 
	`mem£t
(
£
->
disÿrd_m­
, 0xff,

4181 
SIT_VBLOCK_MAP_SIZE
);

4183 
	`memıy
(
£
->
disÿrd_m­
,

4184 
£
->
cur_v®id_m­
,

4185 
SIT_VBLOCK_MAP_SIZE
);

4186 
sbi
->
disÿrd_blks
 +=

4187 
sbi
->
blocks_³r_£g
 -

4188 
£
->
v®id_blocks
;

4191 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
))

4192 
	`g‘_£c_’Œy
(
sbi
, 
¡¬t
)->
v®id_blocks
 +=

4193 
£
->
v®id_blocks
;

4195 
¡¬t_blk
 +ğ
»aded
;

4196 } 
¡¬t_blk
 < 
s™_blk_út
);

4198 
	`down_»ad
(&
cur£g
->
jouº®_rw£m
);

4199 
i
 = 0; i < 
	`s™s_š_cursum
(
jouº®
); i++) {

4200 
Şd_v®id_blocks
;

4202 
¡¬t
 = 
	`Ë32_to_ıu
(
	`£gno_š_jouº®
(
jouº®
, 
i
));

4203 ià(
¡¬t
 >ğ
	`MAIN_SEGS
(
sbi
)) {

4204 
	`f2fs_”r
(
sbi
, "Wrong journalƒntry on segno %u",

4205 
¡¬t
);

4206 
”r
 = -
EFSCORRUPTED
;

4210 
£
 = &
s™_i
->
£Ár›s
[
¡¬t
];

4211 
s™
 = 
	`s™_š_jouº®
(
jouº®
, 
i
);

4213 
Şd_v®id_blocks
 = 
£
->
v®id_blocks
;

4214 ià(
	`IS_NODESEG
(
£
->
ty³
))

4215 
tÙ®_node_blocks
 -ğ
Şd_v®id_blocks
;

4217 
”r
 = 
	`check_block_couÁ
(
sbi
, 
¡¬t
, &
s™
);

4218 ià(
”r
)

4220 
	`£g_šfo_äom_¿w_s™
(
£
, &
s™
);

4221 ià(
	`IS_NODESEG
(
£
->
ty³
))

4222 
tÙ®_node_blocks
 +ğ
£
->
v®id_blocks
;

4224 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_TRIMMED_FLAG
)) {

4225 
	`mem£t
(
£
->
disÿrd_m­
, 0xff, 
SIT_VBLOCK_MAP_SIZE
);

4227 
	`memıy
(
£
->
disÿrd_m­
, se->
cur_v®id_m­
,

4228 
SIT_VBLOCK_MAP_SIZE
);

4229 
sbi
->
disÿrd_blks
 +ğ
Şd_v®id_blocks
;

4230 
sbi
->
disÿrd_blks
 -ğ
£
->
v®id_blocks
;

4233 ià(
	`__is_Ïrge_£ùiÚ
(
sbi
)) {

4234 
	`g‘_£c_’Œy
(
sbi
, 
¡¬t
)->
v®id_blocks
 +=

4235 
£
->
v®id_blocks
;

4236 
	`g‘_£c_’Œy
(
sbi
, 
¡¬t
)->
v®id_blocks
 -=

4237 
Şd_v®id_blocks
;

4240 
	`up_»ad
(&
cur£g
->
jouº®_rw£m
);

4242 ià(!
”r
 && 
tÙ®_node_blocks
 !ğ
	`v®id_node_couÁ
(
sbi
)) {

4243 
	`f2fs_”r
(
sbi
, "SIT is corrupted‚ode# %u vs %u",

4244 
tÙ®_node_blocks
, 
	`v®id_node_couÁ
(
sbi
));

4245 
”r
 = -
EFSCORRUPTED
;

4248  
”r
;

4249 
	}
}

4251 
	$š™_ä“_£gm­
(
f2fs_sb_šfo
 *
sbi
)

4253 
¡¬t
;

4254 
ty³
;

4256 
¡¬t
 = 0; s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

4257 
£g_’Œy
 *
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
¡¬t
);

4258 ià(!
£Áry
->
v®id_blocks
)

4259 
	`__£t_ä“
(
sbi
, 
¡¬t
);

4261 
	`SIT_I
(
sbi
)->
wr™‹n_v®id_blocks
 +=

4262 
£Áry
->
v®id_blocks
;

4266 
ty³
 = 
CURSEG_HOT_DATA
;y³ <ğ
CURSEG_COLD_NODE
;ype++) {

4267 
cur£g_šfo
 *
cur£g_t
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

4268 
	`__£t_‹¡_ªd_šu£
(
sbi
, 
cur£g_t
->
£gno
);

4270 
	}
}

4272 
	$š™_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
)

4274 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

4275 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

4276 
£gno
 = 0, 
off£t
 = 0;

4277 
v®id_blocks
;

4281 
£gno
 = 
	`fšd_Ãxt_šu£
(
ä“_i
, 
	`MAIN_SEGS
(
sbi
), 
off£t
);

4282 ià(
£gno
 >ğ
	`MAIN_SEGS
(
sbi
))

4284 
off£t
 = 
£gno
 + 1;

4285 
v®id_blocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 
çl£
);

4286 ià(
v®id_blocks
 =ğ
sbi
->
blocks_³r_£g
 || !valid_blocks)

4288 ià(
v®id_blocks
 > 
sbi
->
blocks_³r_£g
) {

4289 
	`f2fs_bug_Ú
(
sbi
, 1);

4292 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

4293 
	`__loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

4294 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

4296 
	}
}

4298 
	$š™_viùim_£cm­
(
f2fs_sb_šfo
 *
sbi
)

4300 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

4301 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

4303 
dœty_i
->
viùim_£cm­
 = 
	`f2fs_kvz®loc
(
sbi
, 
b™m­_size
, 
GFP_KERNEL
);

4304 ià(!
dœty_i
->
viùim_£cm­
)

4305  -
ENOMEM
;

4307 
	}
}

4309 
	$bud_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
)

4311 
dœty_£gli¡_šfo
 *
dœty_i
;

4312 
b™m­_size
, 
i
;

4315 
dœty_i
 = 
	`f2fs_kz®loc
(
sbi
, (
dœty_£gli¡_šfo
),

4316 
GFP_KERNEL
);

4317 ià(!
dœty_i
)

4318  -
ENOMEM
;

4320 
	`SM_I
(
sbi
)->
dœty_šfo
 = 
dœty_i
;

4321 
	`mu‹x_š™
(&
dœty_i
->
£gli¡_lock
);

4323 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

4325 
i
 = 0; i < 
NR_DIRTY_TYPE
; i++) {

4326 
dœty_i
->
dœty_£gm­
[
i
] = 
	`f2fs_kvz®loc
(
sbi
, 
b™m­_size
,

4327 
GFP_KERNEL
);

4328 ià(!
dœty_i
->
dœty_£gm­
[
i
])

4329  -
ENOMEM
;

4332 
	`š™_dœty_£gm­
(
sbi
);

4333  
	`š™_viùim_£cm­
(
sbi
);

4334 
	}
}

4336 
	$§n™y_check_cur£g
(
f2fs_sb_šfo
 *
sbi
)

4338 
i
;

4344 
i
 = 0; i < 
NO_CHECK_TYPE
; i++) {

4345 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

4346 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
cur£g
->
£gno
);

4347 
blkofs
 = 
cur£g
->
Ãxt_blkoff
;

4349 ià(
	`f2fs_‹¡_b™
(
blkofs
, 
£
->
cur_v®id_m­
))

4350 
out
;

4352 ià(
cur£g
->
®loc_ty³
 =ğ
SSR
)

4355 
blkofs
 +ğ1; blkof < 
sbi
->
blocks_³r_£g
; blkofs++) {

4356 ià(!
	`f2fs_‹¡_b™
(
blkofs
, 
£
->
cur_v®id_m­
))

4358 
out
:

4359 
	`f2fs_”r
(
sbi
,

4361 
i
, 
cur£g
->
£gno
, cur£g->
®loc_ty³
,

4362 
cur£g
->
Ãxt_blkoff
, 
blkofs
);

4363  -
EFSCORRUPTED
;

4367 
	}
}

4372 
	$š™_mš_max_mtime
(
f2fs_sb_šfo
 *
sbi
)

4374 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

4375 
£gno
;

4377 
	`down_wr™e
(&
s™_i
->
£Áry_lock
);

4379 
s™_i
->
mš_mtime
 = 
ULLONG_MAX
;

4381 
£gno
 = 0; segnØ< 
	`MAIN_SEGS
(
sbi
); segnØ+ğsbi->
£gs_³r_£c
) {

4382 
i
;

4383 
mtime
 = 0;

4385 
i
 = 0; i < 
sbi
->
£gs_³r_£c
; i++)

4386 
mtime
 +ğ
	`g‘_£g_’Œy
(
sbi
, 
£gno
 + 
i
)->mtime;

4388 
mtime
 = 
	`div_u64
(mtime, 
sbi
->
£gs_³r_£c
);

4390 ià(
s™_i
->
mš_mtime
 > 
mtime
)

4391 
s™_i
->
mš_mtime
 = 
mtime
;

4393 
s™_i
->
max_mtime
 = 
	`g‘_mtime
(
sbi
, 
çl£
);

4394 
	`up_wr™e
(&
s™_i
->
£Áry_lock
);

4395 
	}
}

4397 
	$f2fs_bud_£gm’t_mªag”
(
f2fs_sb_šfo
 *
sbi
)

4399 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

4400 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

4401 
f2fs_sm_šfo
 *
sm_šfo
;

4402 
”r
;

4404 
sm_šfo
 = 
	`f2fs_kz®loc
(
sbi
, (
f2fs_sm_šfo
), 
GFP_KERNEL
);

4405 ià(!
sm_šfo
)

4406  -
ENOMEM
;

4409 
sbi
->
sm_šfo
 = sm_info;

4410 
sm_šfo
->
£g0_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t0_blkaddr
);

4411 
sm_šfo
->
maš_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->main_blkaddr);

4412 
sm_šfo
->
£gm’t_couÁ
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count);

4413 
sm_šfo
->
»£rved_£gm’ts
 = 
	`Ë32_to_ıu
(
ck±
->
rsvd_£gm’t_couÁ
);

4414 
sm_šfo
->
ovp_£gm’ts
 = 
	`Ë32_to_ıu
(
ck±
->
ov”´ov_£gm’t_couÁ
);

4415 
sm_šfo
->
maš_£gm’ts
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_maš
);

4416 
sm_šfo
->
s§_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->ssa_blkaddr);

4417 
sm_šfo
->
»c_´eä“_£gm’ts
 = sm_šfo->
maš_£gm’ts
 *

4418 
DEF_RECLAIM_PREFREE_SEGMENTS
 / 100;

4419 ià(
sm_šfo
->
»c_´eä“_£gm’ts
 > 
DEF_MAX_RECLAIM_PREFREE_SEGMENTS
)

4420 
sm_šfo
->
»c_´eä“_£gm’ts
 = 
DEF_MAX_RECLAIM_PREFREE_SEGMENTS
;

4422 ià(!
	`‹¡_İt
(
sbi
, 
LFS
))

4423 
sm_šfo
->
u_pŞicy
 = 1 << 
F2FS_IPU_FSYNC
;

4424 
sm_šfo
->
mš_u_ut
 = 
DEF_MIN_IPU_UTIL
;

4425 
sm_šfo
->
mš_fsync_blocks
 = 
DEF_MIN_FSYNC_BLOCKS
;

4426 
sm_šfo
->
mš_£q_blocks
 = 
sbi
->
blocks_³r_£g
 * sbi->
£gs_³r_£c
;

4427 
sm_šfo
->
mš_hÙ_blocks
 = 
DEF_MIN_HOT_BLOCKS
;

4428 
sm_šfo
->
mš_s¤_£ùiÚs
 = 
	`»£rved_£ùiÚs
(
sbi
);

4430 
	`INIT_LIST_HEAD
(&
sm_šfo
->
s™_’Œy_£t
);

4432 
	`š™_rw£m
(&
sm_šfo
->
cur£g_lock
);

4434 ià(!
	`f2fs_»adÚly
(
sbi
->
sb
)) {

4435 
”r
 = 
	`f2fs_ü—‹_æush_cmd_cÚŒŞ
(
sbi
);

4436 ià(
”r
)

4437  
”r
;

4440 
”r
 = 
	`ü—‹_disÿrd_cmd_cÚŒŞ
(
sbi
);

4441 ià(
”r
)

4442  
”r
;

4444 
”r
 = 
	`bud_s™_šfo
(
sbi
);

4445 ià(
”r
)

4446  
”r
;

4447 
”r
 = 
	`bud_ä“_£gm­
(
sbi
);

4448 ià(
”r
)

4449  
”r
;

4450 
”r
 = 
	`bud_cur£g
(
sbi
);

4451 ià(
”r
)

4452  
”r
;

4455 
”r
 = 
	`bud_s™_’Œ›s
(
sbi
);

4456 ià(
”r
)

4457  
”r
;

4459 
	`š™_ä“_£gm­
(
sbi
);

4460 
”r
 = 
	`bud_dœty_£gm­
(
sbi
);

4461 ià(
”r
)

4462  
”r
;

4464 
”r
 = 
	`§n™y_check_cur£g
(
sbi
);

4465 ià(
”r
)

4466  
”r
;

4468 
	`š™_mš_max_mtime
(
sbi
);

4470 
	}
}

4472 
	$disÿrd_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
,

4473 
dœty_ty³
 dirty_type)

4475 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

4477 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

4478 
	`kvä“
(
dœty_i
->
dœty_£gm­
[
dœty_ty³
]);

4479 
dœty_i
->
Ä_dœty
[
dœty_ty³
] = 0;

4480 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

4481 
	}
}

4483 
	$de¡roy_viùim_£cm­
(
f2fs_sb_šfo
 *
sbi
)

4485 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

4486 
	`kvä“
(
dœty_i
->
viùim_£cm­
);

4487 
	}
}

4489 
	$de¡roy_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
)

4491 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

4492 
i
;

4494 ià(!
dœty_i
)

4498 
i
 = 0; i < 
NR_DIRTY_TYPE
; i++)

4499 
	`disÿrd_dœty_£gm­
(
sbi
, 
i
);

4501 
	`de¡roy_viùim_£cm­
(
sbi
);

4502 
	`SM_I
(
sbi
)->
dœty_šfo
 = 
NULL
;

4503 
	`kvä“
(
dœty_i
);

4504 
	}
}

4506 
	$de¡roy_cur£g
(
f2fs_sb_šfo
 *
sbi
)

4508 
cur£g_šfo
 *
¬¿y
 = 
	`SM_I
(
sbi
)->
cur£g_¬¿y
;

4509 
i
;

4511 ià(!
¬¿y
)

4513 
	`SM_I
(
sbi
)->
cur£g_¬¿y
 = 
NULL
;

4514 
i
 = 0; i < 
NR_CURSEG_TYPE
; i++) {

4515 
	`kvä“
(
¬¿y
[
i
].
sum_blk
);

4516 
	`kvä“
(
¬¿y
[
i
].
jouº®
);

4518 
	`kvä“
(
¬¿y
);

4519 
	}
}

4521 
	$de¡roy_ä“_£gm­
(
f2fs_sb_šfo
 *
sbi
)

4523 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`SM_I
(
sbi
)->
ä“_šfo
;

4524 ià(!
ä“_i
)

4526 
	`SM_I
(
sbi
)->
ä“_šfo
 = 
NULL
;

4527 
	`kvä“
(
ä“_i
->
ä“_£gm­
);

4528 
	`kvä“
(
ä“_i
->
ä“_£cm­
);

4529 
	`kvä“
(
ä“_i
);

4530 
	}
}

4532 
	$de¡roy_s™_šfo
(
f2fs_sb_šfo
 *
sbi
)

4534 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

4536 ià(!
s™_i
)

4539 ià(
s™_i
->
£Ár›s
)

4540 
	`kvä“
(
s™_i
->
b™m­
);

4541 
	`kvä“
(
s™_i
->
tmp_m­
);

4543 
	`kvä“
(
s™_i
->
£Ár›s
);

4544 
	`kvä“
(
s™_i
->
£c_’Œ›s
);

4545 
	`kvä“
(
s™_i
->
dœty_£Ár›s_b™m­
);

4547 
	`SM_I
(
sbi
)->
s™_šfo
 = 
NULL
;

4548 
	`kvä“
(
s™_i
->
s™_b™m­
);

4549 #ifdeà
CONFIG_F2FS_CHECK_FS


4550 
	`kvä“
(
s™_i
->
s™_b™m­_mœ
);

4551 
	`kvä“
(
s™_i
->
šv®id_£gm­
);

4553 
	`kvä“
(
s™_i
);

4554 
	}
}

4556 
	$f2fs_de¡roy_£gm’t_mªag”
(
f2fs_sb_šfo
 *
sbi
)

4558 
f2fs_sm_šfo
 *
sm_šfo
 = 
	`SM_I
(
sbi
);

4560 ià(!
sm_šfo
)

4562 
	`f2fs_de¡roy_æush_cmd_cÚŒŞ
(
sbi
, 
Œue
);

4563 
	`de¡roy_disÿrd_cmd_cÚŒŞ
(
sbi
);

4564 
	`de¡roy_dœty_£gm­
(
sbi
);

4565 
	`de¡roy_cur£g
(
sbi
);

4566 
	`de¡roy_ä“_£gm­
(
sbi
);

4567 
	`de¡roy_s™_šfo
(
sbi
);

4568 
sbi
->
sm_šfo
 = 
NULL
;

4569 
	`kvä“
(
sm_šfo
);

4570 
	}
}

4572 
__š™
 
	$f2fs_ü—‹_£gm’t_mªag”_ÿches
()

4574 
disÿrd_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("discard_entry",

4575 (
disÿrd_’Œy
));

4576 ià(!
disÿrd_’Œy_¦ab
)

4577 
ç
;

4579 
disÿrd_cmd_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("discard_cmd",

4580 (
disÿrd_cmd
));

4581 ià(!
disÿrd_cmd_¦ab
)

4582 
de¡roy_disÿrd_’Œy
;

4584 
s™_’Œy_£t_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("sit_entry_set",

4585 (
s™_’Œy_£t
));

4586 ià(!
s™_’Œy_£t_¦ab
)

4587 
de¡roy_disÿrd_cmd
;

4589 
šmem_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("inmem_page_entry",

4590 (
šmem_·ges
));

4591 ià(!
šmem_’Œy_¦ab
)

4592 
de¡roy_s™_’Œy_£t
;

4595 
de¡roy_s™_’Œy_£t
:

4596 
	`kmem_ÿche_de¡roy
(
s™_’Œy_£t_¦ab
);

4597 
de¡roy_disÿrd_cmd
:

4598 
	`kmem_ÿche_de¡roy
(
disÿrd_cmd_¦ab
);

4599 
de¡roy_disÿrd_’Œy
:

4600 
	`kmem_ÿche_de¡roy
(
disÿrd_’Œy_¦ab
);

4601 
ç
:

4602  -
ENOMEM
;

4603 
	}
}

4605 
	$f2fs_de¡roy_£gm’t_mªag”_ÿches
()

4607 
	`kmem_ÿche_de¡roy
(
s™_’Œy_£t_¦ab
);

4608 
	`kmem_ÿche_de¡roy
(
disÿrd_cmd_¦ab
);

4609 
	`kmem_ÿche_de¡roy
(
disÿrd_’Œy_¦ab
);

4610 
	`kmem_ÿche_de¡roy
(
šmem_’Œy_¦ab
);

4611 
	}
}

	@segment.h

8 
	~<lšux/blkdev.h
>

9 
	~<lšux/backšg-dev.h
>

12 
	#NULL_SEGNO
 (()(~0))

	)

13 
	#NULL_SECNO
 (()(~0))

	)

15 
	#DEF_RECLAIM_PREFREE_SEGMENTS
 5

	)

16 
	#DEF_MAX_RECLAIM_PREFREE_SEGMENTS
 4096

	)

18 
	#F2FS_MIN_SEGMENTS
 9

	)

21 
	#GET_L2R_SEGNO
(
ä“_i
, 
£gno
è((£gnoè- (ä“_i)->
¡¬t_£gno
)

	)

22 
	#GET_R2L_SEGNO
(
ä“_i
, 
£gno
è((£gnoè+ (ä“_i)->
¡¬t_£gno
)

	)

24 
	#IS_DATASEG
(
t
è(Ñè<ğ
CURSEG_COLD_DATA
)

	)

25 
	#IS_NODESEG
(
t
è(Ñè>ğ
CURSEG_HOT_NODE
)

	)

27 
	#IS_HOT
(
t
è(Ñè=ğ
CURSEG_HOT_NODE
 || (tè=ğ
CURSEG_HOT_DATA
)

	)

28 
	#IS_WARM
(
t
è(Ñè=ğ
CURSEG_WARM_NODE
 || (tè=ğ
CURSEG_WARM_DATA
)

	)

29 
	#IS_COLD
(
t
è(Ñè=ğ
CURSEG_COLD_NODE
 || (tè=ğ
CURSEG_COLD_DATA
)

	)

31 
	#IS_CURSEG
(
sbi
, 
£g
) \

32 (((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
)->
£gno
) || \

33 ((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_DATA
)->
£gno
) || \

34 ((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
)->
£gno
) || \

35 ((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_NODE
)->
£gno
) || \

36 ((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
)->
£gno
) || \

37 ((
£g
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_NODE
)->
£gno
))

	)

39 
	#IS_CURSEC
(
sbi
, 
£úo
) \

40 (((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
)->
£gno
 / \

41 (
sbi
)->
£gs_³r_£c
) || \

42 ((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_DATA
)->
£gno
 / \

43 (
sbi
)->
£gs_³r_£c
) || \

44 ((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
)->
£gno
 / \

45 (
sbi
)->
£gs_³r_£c
) || \

46 ((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_NODE
)->
£gno
 / \

47 (
sbi
)->
£gs_³r_£c
) || \

48 ((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
)->
£gno
 / \

49 (
sbi
)->
£gs_³r_£c
) || \

50 ((
£úo
è=ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_NODE
)->
£gno
 / \

51 (
sbi
)->
£gs_³r_£c
)) \

52 

	)

53 
	#MAIN_BLKADDR
(
sbi
) \

54 (
	`SM_I
(
sbi
è? SM_I(sbi)->
maš_blkaddr
 : \

55 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
maš_blkaddr
))

	)

56 
	#SEG0_BLKADDR
(
sbi
) \

57 (
	`SM_I
(
sbi
è? SM_I(sbi)->
£g0_blkaddr
 : \

58 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
£gm’t0_blkaddr
))

	)

60 
	#MAIN_SEGS
(
sbi
è(
	`SM_I
(sbi)->
maš_£gm’ts
)

	)

61 
	#MAIN_SECS
(
sbi
è((sbi)->
tÙ®_£ùiÚs
)

	)

63 
	#TOTAL_SEGS
(
sbi
) \

64 (
	`SM_I
(
sbi
è? SM_I(sbi)->
£gm’t_couÁ
 : \

65 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
£gm’t_couÁ
))

	)

66 
	#TOTAL_BLKS
(
sbi
è(
	`TOTAL_SEGS
(sbiè<< (sbi)->
log_blocks_³r_£g
)

	)

68 
	#MAX_BLKADDR
(
sbi
è(
	`SEG0_BLKADDR
(sbiè+ 
	`TOTAL_BLKS
(sbi))

	)

69 
	#SEGMENT_SIZE
(
sbi
è(1ULL << ((sbi)->
log_blocksize
 + \

70 (
sbi
)->
log_blocks_³r_£g
))

	)

72 
	#START_BLOCK
(
sbi
, 
£gno
è(
	`SEG0_BLKADDR
(sbi) + \

73 (
	`GET_R2L_SEGNO
(
	`FREE_I
(
sbi
), 
£gno
è<< (sbi)->
log_blocks_³r_£g
))

	)

75 
	#NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
) \

76 (
	`START_BLOCK
(
sbi
, (
cur£g
)->
£gno
è+ (cur£g)->
Ãxt_blkoff
)

	)

78 
	#GET_SEGOFF_FROM_SEG0
(
sbi
, 
blk_addr
è((blk_addrè- 
	`SEG0_BLKADDR
(sbi))

	)

79 
	#GET_SEGNO_FROM_SEG0
(
sbi
, 
blk_addr
) \

80 (
	`GET_SEGOFF_FROM_SEG0
(
sbi
, 
blk_addr
è>> (sbi)->
log_blocks_³r_£g
)

	)

81 
	#GET_BLKOFF_FROM_SEG0
(
sbi
, 
blk_addr
) \

82 (
	`GET_SEGOFF_FROM_SEG0
(
sbi
, 
blk_addr
è& ((sbi)->
blocks_³r_£g
 - 1))

	)

84 
	#GET_SEGNO
(
sbi
, 
blk_addr
) \

85 ((!
	`__is_v®id_d©a_blkaddr
(
blk_addr
)) ? \

86 
NULL_SEGNO
 : 
	`GET_L2R_SEGNO
(
	`FREE_I
(
sbi
), \

87 
	`GET_SEGNO_FROM_SEG0
(
sbi
, 
blk_addr
)))

	)

88 
	#BLKS_PER_SEC
(
sbi
) \

89 ((
sbi
)->
£gs_³r_£c
 * (sbi)->
blocks_³r_£g
)

	)

90 
	#GET_SEC_FROM_SEG
(
sbi
, 
£gno
) \

91 ((
£gno
è/ (
sbi
)->
£gs_³r_£c
)

	)

92 
	#GET_SEG_FROM_SEC
(
sbi
, 
£úo
) \

93 ((
£úo
è* (
sbi
)->
£gs_³r_£c
)

	)

94 
	#GET_ZONE_FROM_SEC
(
sbi
, 
£úo
) \

95 ((
£úo
è/ (
sbi
)->
£cs_³r_zÚe
)

	)

96 
	#GET_ZONE_FROM_SEG
(
sbi
, 
£gno
) \

97 
	`GET_ZONE_FROM_SEC
(
sbi
, 
	`GET_SEC_FROM_SEG
(sbi, 
£gno
))

	)

99 
	#GET_SUM_BLOCK
(
sbi
, 
£gno
) \

100 ((
sbi
)->
sm_šfo
->
s§_blkaddr
 + (
£gno
))

	)

102 
	#GET_SUM_TYPE
(
foÙ”
è((foÙ”)->
’Œy_ty³
)

	)

103 
	#SET_SUM_TYPE
(
foÙ”
, 
ty³
è((foÙ”)->
’Œy_ty³
 = (ty³))

	)

105 
	#SIT_ENTRY_OFFSET
(
s™_i
, 
£gno
) \

106 ((
£gno
è% (
s™_i
)->
£Ás_³r_block
)

	)

107 
	#SIT_BLOCK_OFFSET
(
£gno
) \

108 ((
£gno
è/ 
SIT_ENTRY_PER_BLOCK
)

	)

109 
	#START_SEGNO
(
£gno
) \

110 (
	`SIT_BLOCK_OFFSET
(
£gno
è* 
SIT_ENTRY_PER_BLOCK
)

	)

111 
	#SIT_BLK_CNT
(
sbi
) \

112 
	`DIV_ROUND_UP
(
	`MAIN_SEGS
(
sbi
), 
SIT_ENTRY_PER_BLOCK
)

	)

113 
	#f2fs_b™m­_size
(
Ä
) \

114 (
	`BITS_TO_LONGS
(
Ä
è* ())

	)

116 
	#SECTOR_FROM_BLOCK
(
blk_addr
) \

117 (((
£ùÜ_t
)
blk_addr
è<< 
F2FS_LOG_SECTORS_PER_BLOCK
)

	)

118 
	#SECTOR_TO_BLOCK
(
£ùÜs
) \

119 ((
£ùÜs
è>> 
F2FS_LOG_SECTORS_PER_BLOCK
)

	)

127 
	mALLOC_RIGHT
 = 0,

128 
	mALLOC_LEFT


137 
	mLFS
 = 0,

138 
	mSSR


147 
	mGC_CB
 = 0,

148 
	mGC_GREEDY
,

149 
	mALLOC_NEXT
,

150 
	mFLUSH_DEVICE
,

151 
	mMAX_GC_POLICY
,

160 
	mBG_GC
 = 0,

161 
	mFG_GC
,

162 
	mFORCE_FG_GC
,

166 
	sviùim_£l_pŞicy
 {

167 
	m®loc_mode
;

168 
	mgc_mode
;

169 *
	mdœty_£gm­
;

170 
	mmax_£¬ch
;

171 
	moff£t
;

172 
	mofs_un™
;

173 
	mmš_co¡
;

174 
	mmš_£gno
;

177 
	s£g_’Œy
 {

178 
	mty³
:6;

179 
	mv®id_blocks
:10;

180 
	mck±_v®id_blocks
:10;

181 
	m·ddšg
:6;

182 *
	mcur_v®id_m­
;

183 #ifdeà
CONFIG_F2FS_CHECK_FS


184 *
	mcur_v®id_m­_mœ
;

190 *
	mck±_v®id_m­
;

191 *
	mdisÿrd_m­
;

192 
	mmtime
;

195 
	s£c_’Œy
 {

196 
	mv®id_blocks
;

199 
	s£gm’t_®loÿtiÚ
 {

200 (*
	m®loÿ‹_£gm’t
)(
	mf2fs_sb_šfo
 *, , 
	mboŞ
);

207 
	#ATOMIC_WRITTEN_PAGE
 (()-1)

	)

208 
	#DUMMY_WRITTEN_PAGE
 (()-2)

	)

210 
	#IS_ATOMIC_WRITTEN_PAGE
(
·ge
) \

211 (
	`·ge_´iv©e
(
·ge
è=ğ()
ATOMIC_WRITTEN_PAGE
)

	)

212 
	#IS_DUMMY_WRITTEN_PAGE
(
·ge
) \

213 (
	`·ge_´iv©e
(
·ge
è=ğ()
DUMMY_WRITTEN_PAGE
)

	)

215 
	#MAX_SKIP_GC_COUNT
 16

	)

217 
	sšmem_·ges
 {

218 
li¡_h—d
 
	mli¡
;

219 
·ge
 *
	m·ge
;

220 
block_t
 
	mŞd_addr
;

223 
	ss™_šfo
 {

224 cÚ¡ 
£gm’t_®loÿtiÚ
 *
	ms_İs
;

226 
block_t
 
	ms™_ba£_addr
;

227 
block_t
 
	ms™_blocks
;

228 
block_t
 
	mwr™‹n_v®id_blocks
;

229 *
	mb™m­
;

230 *
	ms™_b™m­
;

231 #ifdeà
CONFIG_F2FS_CHECK_FS


232 *
	ms™_b™m­_mœ
;

235 *
	mšv®id_£gm­
;

237 
	mb™m­_size
;

239 *
	mtmp_m­
;

240 *
	mdœty_£Ár›s_b™m­
;

241 
	mdœty_£Ár›s
;

242 
	m£Ás_³r_block
;

243 
rw_£m­hÜe
 
	m£Áry_lock
;

244 
£g_’Œy
 *
	m£Ár›s
;

245 
£c_’Œy
 *
	m£c_’Œ›s
;

248 
	m–­£d_time
;

249 
	mmouÁed_time
;

250 
	mmš_mtime
;

251 
	mmax_mtime
;

253 
	mÏ¡_viùim
[
MAX_GC_POLICY
];

256 
	sä“_£gm­_šfo
 {

257 
	m¡¬t_£gno
;

258 
	mä“_£gm’ts
;

259 
	mä“_£ùiÚs
;

260 
¥šlock_t
 
	m£gm­_lock
;

261 *
	mä“_£gm­
;

262 *
	mä“_£cm­
;

266 
	edœty_ty³
 {

267 
	mDIRTY_HOT_DATA
,

268 
	mDIRTY_WARM_DATA
,

269 
	mDIRTY_COLD_DATA
,

270 
	mDIRTY_HOT_NODE
,

271 
	mDIRTY_WARM_NODE
,

272 
	mDIRTY_COLD_NODE
,

273 
	mDIRTY
,

274 
	mPRE
,

275 
	mNR_DIRTY_TYPE


278 
	sdœty_£gli¡_šfo
 {

279 cÚ¡ 
viùim_£ËùiÚ
 *
	mv_İs
;

280 *
	mdœty_£gm­
[
NR_DIRTY_TYPE
];

281 
mu‹x
 
	m£gli¡_lock
;

282 
	mÄ_dœty
[
NR_DIRTY_TYPE
];

283 *
	mviùim_£cm­
;

287 
	sviùim_£ËùiÚ
 {

288 (*
	mg‘_viùim
)(
	mf2fs_sb_šfo
 *, *,

293 
	scur£g_šfo
 {

294 
mu‹x
 
	mcur£g_mu‹x
;

295 
f2fs_summ¬y_block
 *
	msum_blk
;

296 
rw_£m­hÜe
 
	mjouº®_rw£m
;

297 
f2fs_jouº®
 *
	mjouº®
;

298 
	m®loc_ty³
;

299 
	m£gno
;

300 
	mÃxt_blkoff
;

301 
	mzÚe
;

302 
	mÃxt_£gno
;

305 
	ss™_’Œy_£t
 {

306 
li¡_h—d
 
	m£t_li¡
;

307 
	m¡¬t_£gno
;

308 
	m’Œy_út
;

314 
šlše
 
cur£g_šfo
 *
	$CURSEG_I
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

316  (
cur£g_šfo
 *)(
	`SM_I
(
sbi
)->
cur£g_¬¿y
 + 
ty³
);

317 
	}
}

319 
šlše
 
£g_’Œy
 *
	$g‘_£g_’Œy
(
f2fs_sb_šfo
 *
sbi
,

320 
£gno
)

322 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

323  &
s™_i
->
£Ár›s
[
£gno
];

324 
	}
}

326 
šlše
 
£c_’Œy
 *
	$g‘_£c_’Œy
(
f2fs_sb_šfo
 *
sbi
,

327 
£gno
)

329 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

330  &
s™_i
->
£c_’Œ›s
[
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
)];

331 
	}
}

333 
šlše
 
	$g‘_v®id_blocks
(
f2fs_sb_šfo
 *
sbi
,

334 
£gno
, 
boŞ
 
u£_£ùiÚ
)

340 ià(
u£_£ùiÚ
 && 
	`__is_Ïrge_£ùiÚ
(
sbi
))

341  
	`g‘_£c_’Œy
(
sbi
, 
£gno
)->
v®id_blocks
;

343  
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
v®id_blocks
;

344 
	}
}

346 
šlše
 
	$g‘_ck±_v®id_blocks
(
f2fs_sb_šfo
 *
sbi
,

347 
£gno
)

349  
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
ck±_v®id_blocks
;

350 
	}
}

352 
šlše
 
	$£g_šfo_äom_¿w_s™
(
£g_’Œy
 *
£
,

353 
f2fs_s™_’Œy
 *
rs
)

355 
£
->
v®id_blocks
 = 
	`GET_SIT_VBLOCKS
(
rs
);

356 
£
->
ck±_v®id_blocks
 = 
	`GET_SIT_VBLOCKS
(
rs
);

357 
	`memıy
(
£
->
cur_v®id_m­
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

358 
	`memıy
(
£
->
ck±_v®id_m­
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

359 #ifdeà
CONFIG_F2FS_CHECK_FS


360 
	`memıy
(
£
->
cur_v®id_m­_mœ
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

362 
£
->
ty³
 = 
	`GET_SIT_TYPE
(
rs
);

363 
£
->
mtime
 = 
	`Ë64_to_ıu
(
rs
->mtime);

364 
	}
}

366 
šlše
 
	$__£g_šfo_to_¿w_s™
(
£g_’Œy
 *
£
,

367 
f2fs_s™_’Œy
 *
rs
)

369 
¿w_vblocks
 = (
£
->
ty³
 << 
SIT_VBLOCKS_SHIFT
) |

370 
£
->
v®id_blocks
;

371 
rs
->
vblocks
 = 
	`ıu_to_Ë16
(
¿w_vblocks
);

372 
	`memıy
(
rs
->
v®id_m­
, 
£
->
cur_v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

373 
rs
->
mtime
 = 
	`ıu_to_Ë64
(
£
->mtime);

374 
	}
}

376 
šlše
 
	$£g_šfo_to_s™_·ge
(
f2fs_sb_šfo
 *
sbi
,

377 
·ge
 *·ge, 
¡¬t
)

379 
f2fs_s™_block
 *
¿w_s™
;

380 
£g_’Œy
 *
£
;

381 
f2fs_s™_’Œy
 *
rs
;

382 
’d
 = 
	`mš
(
¡¬t
 + 
SIT_ENTRY_PER_BLOCK
,

383 ()
	`MAIN_SEGS
(
sbi
));

384 
i
;

386 
¿w_s™
 = (
f2fs_s™_block
 *)
	`·ge_add»ss
(
·ge
);

387 
	`mem£t
(
¿w_s™
, 0, 
PAGE_SIZE
);

388 
i
 = 0; i < 
’d
 - 
¡¬t
; i++) {

389 
rs
 = &
¿w_s™
->
’Œ›s
[
i
];

390 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
¡¬t
 + 
i
);

391 
	`__£g_šfo_to_¿w_s™
(
£
, 
rs
);

393 
	}
}

395 
šlše
 
	$£g_šfo_to_¿w_s™
(
£g_’Œy
 *
£
,

396 
f2fs_s™_’Œy
 *
rs
)

398 
	`__£g_šfo_to_¿w_s™
(
£
, 
rs
);

400 
	`memıy
(
£
->
ck±_v®id_m­
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

401 
£
->
ck±_v®id_blocks
 = se->
v®id_blocks
;

402 
	}
}

404 
šlše
 
	$fšd_Ãxt_šu£
(
ä“_£gm­_šfo
 *
ä“_i
,

405 
max
, 
£gno
)

407 
»t
;

408 
	`¥š_lock
(&
ä“_i
->
£gm­_lock
);

409 
»t
 = 
	`fšd_Ãxt_b™
(
ä“_i
->
ä“_£gm­
, 
max
, 
£gno
);

410 
	`¥š_uÆock
(&
ä“_i
->
£gm­_lock
);

411  
»t
;

412 
	}
}

414 
šlše
 
	$__£t_ä“
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

416 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

417 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

418 
¡¬t_£gno
 = 
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

419 
Ãxt
;

421 
	`¥š_lock
(&
ä“_i
->
£gm­_lock
);

422 
	`ş—r_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
);

423 
ä“_i
->
ä“_£gm’ts
++;

425 
Ãxt
 = 
	`fšd_Ãxt_b™
(
ä“_i
->
ä“_£gm­
,

426 
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
, start_segno);

427 ià(
Ãxt
 >ğ
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
) {

428 
	`ş—r_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
);

429 
ä“_i
->
ä“_£ùiÚs
++;

431 
	`¥š_uÆock
(&
ä“_i
->
£gm­_lock
);

432 
	}
}

434 
šlše
 
	$__£t_šu£
(
f2fs_sb_šfo
 *
sbi
,

435 
£gno
)

437 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

438 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

440 
	`£t_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
);

441 
ä“_i
->
ä“_£gm’ts
--;

442 ià(!
	`‹¡_ªd_£t_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
))

443 
ä“_i
->
ä“_£ùiÚs
--;

444 
	}
}

446 
šlše
 
	$__£t_‹¡_ªd_ä“
(
f2fs_sb_šfo
 *
sbi
,

447 
£gno
)

449 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

450 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

451 
¡¬t_£gno
 = 
	`GET_SEG_FROM_SEC
(
sbi
, 
£úo
);

452 
Ãxt
;

454 
	`¥š_lock
(&
ä“_i
->
£gm­_lock
);

455 ià(
	`‹¡_ªd_ş—r_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
)) {

456 
ä“_i
->
ä“_£gm’ts
++;

458 ià(
	`IS_CURSEC
(
sbi
, 
£úo
))

459 
sk_ä“
;

460 
Ãxt
 = 
	`fšd_Ãxt_b™
(
ä“_i
->
ä“_£gm­
,

461 
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
, start_segno);

462 ià(
Ãxt
 >ğ
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
) {

463 ià(
	`‹¡_ªd_ş—r_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
))

464 
ä“_i
->
ä“_£ùiÚs
++;

467 
sk_ä“
:

468 
	`¥š_uÆock
(&
ä“_i
->
£gm­_lock
);

469 
	}
}

471 
šlše
 
	$__£t_‹¡_ªd_šu£
(
f2fs_sb_šfo
 *
sbi
,

472 
£gno
)

474 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

475 
£úo
 = 
	`GET_SEC_FROM_SEG
(
sbi
, 
£gno
);

477 
	`¥š_lock
(&
ä“_i
->
£gm­_lock
);

478 ià(!
	`‹¡_ªd_£t_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
)) {

479 
ä“_i
->
ä“_£gm’ts
--;

480 ià(!
	`‹¡_ªd_£t_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
))

481 
ä“_i
->
ä“_£ùiÚs
--;

483 
	`¥š_uÆock
(&
ä“_i
->
£gm­_lock
);

484 
	}
}

486 
šlše
 
	$g‘_s™_b™m­
(
f2fs_sb_šfo
 *
sbi
,

487 *
d¡_addr
)

489 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

491 #ifdeà
CONFIG_F2FS_CHECK_FS


492 ià(
	`memcmp
(
s™_i
->
s™_b™m­
, s™_i->
s™_b™m­_mœ
,

493 
s™_i
->
b™m­_size
))

494 
	`f2fs_bug_Ú
(
sbi
, 1);

496 
	`memıy
(
d¡_addr
, 
s™_i
->
s™_b™m­
, s™_i->
b™m­_size
);

497 
	}
}

499 
šlše
 
block_t
 
	$wr™‹n_block_couÁ
(
f2fs_sb_šfo
 *
sbi
)

501  
	`SIT_I
(
sbi
)->
wr™‹n_v®id_blocks
;

502 
	}
}

504 
šlše
 
	$ä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

506  
	`FREE_I
(
sbi
)->
ä“_£gm’ts
;

507 
	}
}

509 
šlše
 
	$»£rved_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

511  
	`SM_I
(
sbi
)->
»£rved_£gm’ts
;

512 
	}
}

514 
šlše
 
	$ä“_£ùiÚs
(
f2fs_sb_šfo
 *
sbi
)

516  
	`FREE_I
(
sbi
)->
ä“_£ùiÚs
;

517 
	}
}

519 
šlše
 
	$´eä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

521  
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
PRE
];

522 
	}
}

524 
šlše
 
	$dœty_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

526  
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_HOT_DATA
] +

527 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_WARM_DATA
] +

528 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_COLD_DATA
] +

529 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_HOT_NODE
] +

530 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_WARM_NODE
] +

531 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_COLD_NODE
];

532 
	}
}

534 
šlše
 
	$ov”´ovisiÚ_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

536  
	`SM_I
(
sbi
)->
ovp_£gm’ts
;

537 
	}
}

539 
šlše
 
	$»£rved_£ùiÚs
(
f2fs_sb_šfo
 *
sbi
)

541  
	`GET_SEC_FROM_SEG
(
sbi
, ()
	`»£rved_£gm’ts
(sbi));

542 
	}
}

544 
šlše
 
boŞ
 
	$has_cur£g_’ough_¥aû
(
f2fs_sb_šfo
 *
sbi
)

546 
node_blocks
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
) +

547 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
);

548 
d’t_blocks
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
);

549 
£gno
, 
Ëá_blocks
;

550 
i
;

553 
i
 = 
CURSEG_HOT_NODE
; i <ğ
CURSEG_COLD_NODE
; i++) {

554 
£gno
 = 
	`CURSEG_I
(
sbi
, 
i
)->segno;

555 
Ëá_blocks
 = 
sbi
->
blocks_³r_£g
 -

556 
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
ck±_v®id_blocks
;

558 ià(
node_blocks
 > 
Ëá_blocks
)

559  
çl£
;

563 
£gno
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
)->segno;

564 
Ëá_blocks
 = 
sbi
->
blocks_³r_£g
 -

565 
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
ck±_v®id_blocks
;

566 ià(
d’t_blocks
 > 
Ëá_blocks
)

567  
çl£
;

568  
Œue
;

569 
	}
}

571 
šlše
 
boŞ
 
	$has_nÙ_’ough_ä“_£cs
(
f2fs_sb_šfo
 *
sbi
,

572 
ä“d
, 
Ãeded
)

574 
node_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_NODES
);

575 
d’t_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_DENTS
);

576 
im‘a_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_IMETA
);

578 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

579  
çl£
;

581 ià(
	`ä“_£ùiÚs
(
sbi
è+ 
ä“d
 =ğ
	`»£rved_£ùiÚs
(sbiè+ 
Ãeded
 &&

582 
	`has_cur£g_’ough_¥aû
(
sbi
))

583  
çl£
;

584  (
	`ä“_£ùiÚs
(
sbi
è+ 
ä“d
) <=

585 (
node_£cs
 + 2 * 
d’t_£cs
 + 
im‘a_£cs
 +

586 
	`»£rved_£ùiÚs
(
sbi
è+ 
Ãeded
);

587 
	}
}

589 
šlše
 
boŞ
 
	$f2fs_is_checkpošt_»ady
(
f2fs_sb_šfo
 *
sbi
)

591 ià(
	`lik–y
(!
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)))

592  
Œue
;

593 ià(
	`lik–y
(!
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0, 0)))

594  
Œue
;

595  
çl£
;

596 
	}
}

598 
šlše
 
boŞ
 
	$exûss_´eä“_£gs
(
f2fs_sb_šfo
 *
sbi
)

600  
	`´eä“_£gm’ts
(
sbi
è> 
	`SM_I
(sbi)->
»c_´eä“_£gm’ts
;

601 
	}
}

603 
šlše
 
	$utiz©iÚ
(
f2fs_sb_šfo
 *
sbi
)

605  
	`div_u64
((
u64
)
	`v®id_u£r_blocks
(
sbi
) * 100,

606 
sbi
->
u£r_block_couÁ
);

607 
	}
}

623 
	#DEF_MIN_IPU_UTIL
 70

	)

624 
	#DEF_MIN_FSYNC_BLOCKS
 8

	)

625 
	#DEF_MIN_HOT_BLOCKS
 16

	)

627 
	#SMALL_VOLUME_SEGMENTS
 (16 * 512è

	)

630 
	mF2FS_IPU_FORCE
,

631 
	mF2FS_IPU_SSR
,

632 
	mF2FS_IPU_UTIL
,

633 
	mF2FS_IPU_SSR_UTIL
,

634 
	mF2FS_IPU_FSYNC
,

635 
	mF2FS_IPU_ASYNC
,

638 
šlše
 
	$cur£g_£gno
(
f2fs_sb_šfo
 *
sbi
,

639 
ty³
)

641 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

642  
cur£g
->
£gno
;

643 
	}
}

645 
šlše
 
	$cur£g_®loc_ty³
(
f2fs_sb_šfo
 *
sbi
,

646 
ty³
)

648 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

649  
cur£g
->
®loc_ty³
;

650 
	}
}

652 
šlše
 
	$cur£g_blkoff
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

654 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

655  
cur£g
->
Ãxt_blkoff
;

656 
	}
}

658 
šlše
 
	$check_£g_¿nge
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

660 
	`f2fs_bug_Ú
(
sbi
, 
£gno
 > 
	`TOTAL_SEGS
(sbi) - 1);

661 
	}
}

663 
šlše
 
	$v”ify_fio_blkaddr
(
f2fs_io_šfo
 *
fio
)

665 
f2fs_sb_šfo
 *
sbi
 = 
fio
->sbi;

667 ià(
	`__is_v®id_d©a_blkaddr
(
fio
->
Şd_blkaddr
))

668 
	`v”ify_blkaddr
(
sbi
, 
fio
->
Şd_blkaddr
, 
	`__is_m‘a_io
(fio) ?

669 
META_GENERIC
 : 
DATA_GENERIC
);

670 
	`v”ify_blkaddr
(
sbi
, 
fio
->
Ãw_blkaddr
, 
	`__is_m‘a_io
(fio) ?

671 
META_GENERIC
 : 
DATA_GENERIC_ENHANCE
);

672 
	}
}

677 
šlše
 
	$check_block_couÁ
(
f2fs_sb_šfo
 *
sbi
,

678 
£gno
, 
f2fs_s™_’Œy
 *
¿w_s™
)

680 
boŞ
 
is_v®id
 = 
	`‹¡_b™_Ë
(0, 
¿w_s™
->
v®id_m­
è? 
Œue
 : 
çl£
;

681 
v®id_blocks
 = 0;

682 
cur_pos
 = 0, 
Ãxt_pos
;

686 ià(
is_v®id
) {

687 
Ãxt_pos
 = 
	`fšd_Ãxt_z”o_b™_Ë
(&
¿w_s™
->
v®id_m­
,

688 
sbi
->
blocks_³r_£g
,

689 
cur_pos
);

690 
v®id_blocks
 +ğ
Ãxt_pos
 - 
cur_pos
;

692 
Ãxt_pos
 = 
	`fšd_Ãxt_b™_Ë
(&
¿w_s™
->
v®id_m­
,

693 
sbi
->
blocks_³r_£g
,

694 
cur_pos
);

695 
cur_pos
 = 
Ãxt_pos
;

696 
is_v®id
 = !is_valid;

697 } 
cur_pos
 < 
sbi
->
blocks_³r_£g
);

699 ià(
	`uÆik–y
(
	`GET_SIT_VBLOCKS
(
¿w_s™
è!ğ
v®id_blocks
)) {

700 
	`f2fs_”r
(
sbi
, "Mismatch valid blocks %d vs. %d",

701 
	`GET_SIT_VBLOCKS
(
¿w_s™
), 
v®id_blocks
);

702 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

703  -
EFSCORRUPTED
;

707 ià(
	`uÆik–y
(
	`GET_SIT_VBLOCKS
(
¿w_s™
è> 
sbi
->
blocks_³r_£g


708 || 
£gno
 > 
	`TOTAL_SEGS
(
sbi
) - 1)) {

709 
	`f2fs_”r
(
sbi
, "Wrong valid blocks %d or segno %u",

710 
	`GET_SIT_VBLOCKS
(
¿w_s™
), 
£gno
);

711 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

712  -
EFSCORRUPTED
;

715 
	}
}

717 
šlše
 
pgoff_t
 
	$cu¼’t_s™_addr
(
f2fs_sb_šfo
 *
sbi
,

718 
¡¬t
)

720 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

721 
off£t
 = 
	`SIT_BLOCK_OFFSET
(
¡¬t
);

722 
block_t
 
blk_addr
 = 
s™_i
->
s™_ba£_addr
 + 
off£t
;

724 
	`check_£g_¿nge
(
sbi
, 
¡¬t
);

726 #ifdeà
CONFIG_F2FS_CHECK_FS


727 ià(
	`f2fs_‹¡_b™
(
off£t
, 
s™_i
->
s™_b™m­
) !=

728 
	`f2fs_‹¡_b™
(
off£t
, 
s™_i
->
s™_b™m­_mœ
))

729 
	`f2fs_bug_Ú
(
sbi
, 1);

733 ià(
	`f2fs_‹¡_b™
(
off£t
, 
s™_i
->
s™_b™m­
))

734 
blk_addr
 +ğ
s™_i
->
s™_blocks
;

736  
blk_addr
;

737 
	}
}

739 
šlše
 
pgoff_t
 
	$Ãxt_s™_addr
(
f2fs_sb_šfo
 *
sbi
,

740 
pgoff_t
 
block_addr
)

742 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

743 
block_addr
 -ğ
s™_i
->
s™_ba£_addr
;

744 ià(
block_addr
 < 
s™_i
->
s™_blocks
)

745 
block_addr
 +ğ
s™_i
->
s™_blocks
;

747 
block_addr
 -ğ
s™_i
->
s™_blocks
;

749  
block_addr
 + 
s™_i
->
s™_ba£_addr
;

750 
	}
}

752 
šlše
 
	$£t_to_Ãxt_s™
(
s™_šfo
 *
s™_i
, 
¡¬t
)

754 
block_off
 = 
	`SIT_BLOCK_OFFSET
(
¡¬t
);

756 
	`f2fs_chªge_b™
(
block_off
, 
s™_i
->
s™_b™m­
);

757 #ifdeà
CONFIG_F2FS_CHECK_FS


758 
	`f2fs_chªge_b™
(
block_off
, 
s™_i
->
s™_b™m­_mœ
);

760 
	}
}

762 
šlše
 
	$g‘_mtime
(
f2fs_sb_šfo
 *
sbi
,

763 
boŞ
 
ba£_time
)

765 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

766 
time64_t
 
diff
, 
now
 = 
	`ktime_g‘_»®_£cÚds
();

768 ià(
now
 >ğ
s™_i
->
mouÁed_time
)

769  
s™_i
->
–­£d_time
 + 
now
 - s™_i->
mouÁed_time
;

772 ià(!
ba£_time
) {

773 
diff
 = 
s™_i
->
mouÁed_time
 - 
now
;

774 ià(
s™_i
->
–­£d_time
 >ğ
diff
)

775  
s™_i
->
–­£d_time
 - 
diff
;

778  
s™_i
->
–­£d_time
;

779 
	}
}

781 
šlše
 
	$£t_summ¬y
(
f2fs_summ¬y
 *
sum
, 
nid_t
 
nid
,

782 
ofs_š_node
, 
v”siÚ
)

784 
sum
->
nid
 = 
	`ıu_to_Ë32
(nid);

785 
sum
->
ofs_š_node
 = 
	`ıu_to_Ë16
(ofs_in_node);

786 
sum
->
v”siÚ
 = version;

787 
	}
}

789 
šlše
 
block_t
 
	$¡¬t_sum_block
(
f2fs_sb_šfo
 *
sbi
)

791  
	`__¡¬t_ı_addr
(
sbi
) +

792 
	`Ë32_to_ıu
(
	`F2FS_CKPT
(
sbi
)->
ı_·ck_¡¬t_sum
);

793 
	}
}

795 
šlše
 
block_t
 
	$sum_blk_addr
(
f2fs_sb_šfo
 *
sbi
, 
ba£
, 
ty³
)

797  
	`__¡¬t_ı_addr
(
sbi
) +

798 
	`Ë32_to_ıu
(
	`F2FS_CKPT
(
sbi
)->
ı_·ck_tÙ®_block_couÁ
)

799 - (
ba£
 + 1è+ 
ty³
;

800 
	}
}

802 
šlše
 
boŞ
 
	$£c_u§ge_check
(
f2fs_sb_šfo
 *
sbi
, 
£úo
)

804 ià(
	`IS_CURSEC
(
sbi
, 
£úo
è|| (sbi->
cur_viùim_£c
 == secno))

805  
Œue
;

806  
çl£
;

807 
	}
}

816 
šlše
 
	$Ä_·ges_to_sk
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

818 ià(
sbi
->
sb
->
s_bdi
->
wb
.
dœty_exûeded
)

821 ià(
ty³
 =ğ
DATA
)

822  
sbi
->
blocks_³r_£g
;

823 ià(
ty³
 =ğ
NODE
)

824  8 * 
sbi
->
blocks_³r_£g
;

825 ià(
ty³
 =ğ
META
)

826  8 * 
BIO_MAX_PAGES
;

829 
	}
}

834 
šlše
 
	$Ä_·ges_to_wr™e
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

835 
wr™eback_cÚŒŞ
 *
wbc
)

837 
Ä_to_wr™e
, 
desœed
;

839 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_NONE
)

842 
Ä_to_wr™e
 = 
wbc
->nr_to_write;

843 
desœed
 = 
BIO_MAX_PAGES
;

844 ià(
ty³
 =ğ
NODE
)

845 
desœed
 <<= 1;

847 
wbc
->
Ä_to_wr™e
 = 
desœed
;

848  
desœed
 - 
Ä_to_wr™e
;

849 
	}
}

851 
šlše
 
	$wake_up_disÿrd_th»ad
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
fÜû
)

853 
disÿrd_cmd_cÚŒŞ
 *
dcc
 = 
	`SM_I
(
sbi
)->
dcc_šfo
;

854 
boŞ
 
wakeup
 = 
çl£
;

855 
i
;

857 ià(
fÜû
)

858 
wake_up
;

860 
	`mu‹x_lock
(&
dcc
->
cmd_lock
);

861 
i
 = 
MAX_PLIST_NUM
 - 1; i >= 0; i--) {

862 ià(
i
 + 1 < 
dcc
->
disÿrd_g¿nuÏr™y
)

864 ià(!
	`li¡_em±y
(&
dcc
->
³nd_li¡
[
i
])) {

865 
wakeup
 = 
Œue
;

869 
	`mu‹x_uÆock
(&
dcc
->
cmd_lock
);

870 ià(!
wakeup
 || !
	`is_idË
(
sbi
, 
DISCARD_TIME
))

872 
wake_up
:

873 
dcc
->
disÿrd_wake
 = 1;

874 
	`wake_up_š‹¼u±ibË_®l
(&
dcc
->
disÿrd_wa™_queue
);

875 
	}
}

	@shrinker.c

9 
	~<lšux/fs.h
>

10 
	~<lšux/f2fs_fs.h
>

12 
	~"f2fs.h
"

13 
	~"node.h
"

15 
LIST_HEAD
(
f2fs_li¡
);

16 
DEFINE_SPINLOCK
(
f2fs_li¡_lock
);

17 
	gshršk”_run_no
;

19 
	$__couÁ_Çt_’Œ›s
(
f2fs_sb_šfo
 *
sbi
)

21 
couÁ
 = 
	`NM_I
(
sbi
)->
Çt_út
 - NM_I(sbi)->
dœty_Çt_út
;

23  
couÁ
 > 0 ? count : 0;

24 
	}
}

26 
	$__couÁ_ä“_nids
(
f2fs_sb_šfo
 *
sbi
)

28 
couÁ
 = 
	`NM_I
(
sbi
)->
nid_út
[
FREE_NID
] - 
MAX_FREE_NIDS
;

30  
couÁ
 > 0 ? count : 0;

31 
	}
}

33 
	$__couÁ_ex‹Á_ÿche
(
f2fs_sb_šfo
 *
sbi
)

35  
	`©omic_»ad
(&
sbi
->
tÙ®_zomb›_Œ“
) +

36 
	`©omic_»ad
(&
sbi
->
tÙ®_ext_node
);

37 
	}
}

39 
	$f2fs_shršk_couÁ
(
shršk”
 *
shršk
,

40 
shršk_cÚŒŞ
 *
sc
)

42 
f2fs_sb_šfo
 *
sbi
;

43 
li¡_h—d
 *
p
;

44 
couÁ
 = 0;

46 
	`¥š_lock
(&
f2fs_li¡_lock
);

47 
p
 = 
f2fs_li¡
.
Ãxt
;

48 
p
 !ğ&
f2fs_li¡
) {

49 
sbi
 = 
	`li¡_’Œy
(
p
, 
f2fs_sb_šfo
, 
s_li¡
);

52 ià(!
	`mu‹x_Œylock
(&
sbi
->
umouÁ_mu‹x
)) {

53 
p
 =…->
Ãxt
;

56 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

59 
couÁ
 +ğ
	`__couÁ_ex‹Á_ÿche
(
sbi
);

62 
couÁ
 +ğ
	`__couÁ_Çt_’Œ›s
(
sbi
);

65 
couÁ
 +ğ
	`__couÁ_ä“_nids
(
sbi
);

67 
	`¥š_lock
(&
f2fs_li¡_lock
);

68 
p
 =…->
Ãxt
;

69 
	`mu‹x_uÆock
(&
sbi
->
umouÁ_mu‹x
);

71 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

72  
couÁ
;

73 
	}
}

75 
	$f2fs_shršk_sÿn
(
shršk”
 *
shršk
,

76 
shršk_cÚŒŞ
 *
sc
)

78 
Ä
 = 
sc
->
Ä_to_sÿn
;

79 
f2fs_sb_šfo
 *
sbi
;

80 
li¡_h—d
 *
p
;

81 
run_no
;

82 
ä“d
 = 0;

84 
	`¥š_lock
(&
f2fs_li¡_lock
);

86 
run_no
 = ++
shršk”_run_no
;

87 } 
run_no
 == 0);

88 
p
 = 
f2fs_li¡
.
Ãxt
;

89 
p
 !ğ&
f2fs_li¡
) {

90 
sbi
 = 
	`li¡_’Œy
(
p
, 
f2fs_sb_šfo
, 
s_li¡
);

92 ià(
sbi
->
shršk”_run_no
 =ğ
run_no
)

96 ià(!
	`mu‹x_Œylock
(&
sbi
->
umouÁ_mu‹x
)) {

97 
p
 =…->
Ãxt
;

100 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

102 
sbi
->
shršk”_run_no
 = 
run_no
;

105 
ä“d
 +ğ
	`f2fs_shršk_ex‹Á_Œ“
(
sbi
, 
Ä
 >> 1);

108 ià(
ä“d
 < 
Ä
)

109 
ä“d
 +ğ
	`f2fs_Œy_to_ä“_Çts
(
sbi
, 
Ä
 - freed);

112 ià(
ä“d
 < 
Ä
)

113 
ä“d
 +ğ
	`f2fs_Œy_to_ä“_nids
(
sbi
, 
Ä
 - freed);

115 
	`¥š_lock
(&
f2fs_li¡_lock
);

116 
p
 =…->
Ãxt
;

117 
	`li¡_move_
(&
sbi
->
s_li¡
, &
f2fs_li¡
);

118 
	`mu‹x_uÆock
(&
sbi
->
umouÁ_mu‹x
);

119 ià(
ä“d
 >ğ
Ä
)

122 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

123  
ä“d
;

124 
	}
}

126 
	$f2fs_još_shršk”
(
f2fs_sb_šfo
 *
sbi
)

128 
	`¥š_lock
(&
f2fs_li¡_lock
);

129 
	`li¡_add_
(&
sbi
->
s_li¡
, &
f2fs_li¡
);

130 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

131 
	}
}

133 
	$f2fs_Ëave_shršk”
(
f2fs_sb_šfo
 *
sbi
)

135 
	`f2fs_shršk_ex‹Á_Œ“
(
sbi
, 
	`__couÁ_ex‹Á_ÿche
(sbi));

137 
	`¥š_lock
(&
f2fs_li¡_lock
);

138 
	`li¡_d–_š™
(&
sbi
->
s_li¡
);

139 
	`¥š_uÆock
(&
f2fs_li¡_lock
);

140 
	}
}

	@super.c

8 
	~<lšux/moduË.h
>

9 
	~<lšux/š™.h
>

10 
	~<lšux/fs.h
>

11 
	~<lšux/¡©fs.h
>

12 
	~<lšux/bufãr_h—d.h
>

13 
	~<lšux/backšg-dev.h
>

14 
	~<lšux/kth»ad.h
>

15 
	~<lšux/·r£r.h
>

16 
	~<lšux/mouÁ.h
>

17 
	~<lšux/£q_fe.h
>

18 
	~<lšux/´oc_fs.h
>

19 
	~<lšux/¿ndom.h
>

20 
	~<lšux/expÜtfs.h
>

21 
	~<lšux/blkdev.h
>

22 
	~<lšux/quÙaİs.h
>

23 
	~<lšux/f2fs_fs.h
>

24 
	~<lšux/sysfs.h
>

25 
	~<lšux/quÙa.h
>

26 
	~<lšux/unicode.h
>

28 
	~"f2fs.h
"

29 
	~"node.h
"

30 
	~"£gm’t.h
"

31 
	~"x©Œ.h
"

32 
	~"gc.h
"

33 
	~"Œaû.h
"

35 
	#CREATE_TRACE_POINTS


	)

36 
	~<Œaû/ev’ts/f2fs.h
>

38 
kmem_ÿche
 *
	gf2fs_šode_ÿch•
;

40 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


42 cÚ¡ *
	gf2fs_çuÉ_Çme
[
FAULT_MAX
] = {

43 [
FAULT_KMALLOC
] = "kmalloc",

44 [
FAULT_KVMALLOC
] = "kvmalloc",

45 [
FAULT_PAGE_ALLOC
] = "page‡lloc",

46 [
FAULT_PAGE_GET
] = "page get",

47 [
FAULT_ALLOC_BIO
] = "alloc bio",

48 [
FAULT_ALLOC_NID
] = "alloc‚id",

49 [
FAULT_ORPHAN
] = "orphan",

50 [
FAULT_BLOCK
] = "no more block",

51 [
FAULT_DIR_DEPTH
] = "too big dir depth",

52 [
FAULT_EVICT_INODE
] = "evict_inode fail",

53 [
FAULT_TRUNCATE
] = "truncate fail",

54 [
FAULT_READ_IO
] = "read IOƒrror",

55 [
FAULT_CHECKPOINT
] = "checkpointƒrror",

56 [
FAULT_DISCARD
] = "discardƒrror",

57 [
FAULT_WRITE_IO
] = "write IOƒrror",

60 
	$f2fs_bud_çuÉ_©Œ
(
f2fs_sb_šfo
 *
sbi
, 
¿‹
,

61 
ty³
)

63 
f2fs_çuÉ_šfo
 *
ffi
 = &
	`F2FS_OPTION
(
sbi
).
çuÉ_šfo
;

65 ià(
¿‹
) {

66 
	`©omic_£t
(&
ffi
->
šjeù_İs
, 0);

67 
ffi
->
šjeù_¿‹
 = 
¿‹
;

70 ià(
ty³
)

71 
ffi
->
šjeù_ty³
 = 
ty³
;

73 ià(!
¿‹
 && !
ty³
)

74 
	`mem£t
(
ffi
, 0, (
f2fs_çuÉ_šfo
));

75 
	}
}

79 
shršk”
 
	gf2fs_shršk”_šfo
 = {

80 .
sÿn_objeùs
 = 
f2fs_shršk_sÿn
,

81 .
	gcouÁ_objeùs
 = 
f2fs_shršk_couÁ
,

82 .
	g£eks
 = 
DEFAULT_SEEKS
,

86 
	mO±_gc_background
,

87 
	mO±_di§bË_rŞl_fÜw¬d
,

88 
	mO±_nÜecov”y
,

89 
	mO±_disÿrd
,

90 
	mO±_nodisÿrd
,

91 
	mO±_noh—p
,

92 
	mO±_h—p
,

93 
	mO±_u£r_x©Œ
,

94 
	mO±_nou£r_x©Œ
,

95 
	mO±_aş
,

96 
	mO±_nßş
,

97 
	mO±_aùive_logs
,

98 
	mO±_di§bË_ext_id’tify
,

99 
	mO±_šlše_x©Œ
,

100 
	mO±_nošlše_x©Œ
,

101 
	mO±_šlše_x©Œ_size
,

102 
	mO±_šlše_d©a
,

103 
	mO±_šlše_d’Œy
,

104 
	mO±_nošlše_d’Œy
,

105 
	mO±_æush_m”ge
,

106 
	mO±_noæush_m”ge
,

107 
	mO±_nob¬r›r
,

108 
	mO±_ç¡boÙ
,

109 
	mO±_ex‹Á_ÿche
,

110 
	mO±_nÛx‹Á_ÿche
,

111 
	mO±_nošlše_d©a
,

112 
	mO±_d©a_æush
,

113 
	mO±_»£rve_roÙ
,

114 
	mO±_»sgid
,

115 
	mO±_»suid
,

116 
	mO±_mode
,

117 
	mO±_io_size_b™s
,

118 
	mO±_çuÉ_šjeùiÚ
,

119 
	mO±_çuÉ_ty³
,

120 
	mO±_Ïzytime
,

121 
	mO±_nŞazytime
,

122 
	mO±_quÙa
,

123 
	mO±_noquÙa
,

124 
	mO±_u¤quÙa
,

125 
	mO±_g½quÙa
,

126 
	mO±_´jquÙa
,

127 
	mO±_u¤jquÙa
,

128 
	mO±_g½jquÙa
,

129 
	mO±_´jjquÙa
,

130 
	mO±_offu¤jquÙa
,

131 
	mO±_offg½jquÙa
,

132 
	mO±_ofårjjquÙa
,

133 
	mO±_jqfmt_vfsŞd
,

134 
	mO±_jqfmt_vfsv0
,

135 
	mO±_jqfmt_vfsv1
,

136 
	mO±_whšt
,

137 
	mO±_®loc
,

138 
	mO±_fsync
,

139 
	mO±_‹¡_dummy_’üy±iÚ
,

140 
	mO±_checkpošt_di§bË
,

141 
	mO±_checkpošt_di§bË_ÿp
,

142 
	mO±_checkpošt_di§bË_ÿp_³rc
,

143 
	mO±_checkpošt_’abË
,

144 
	mO±_”r
,

147 
m©ch_bË_t
 
	gf2fs_tok’s
 = {

148 {
O±_gc_background
, "background_gc=%s"},

149 {
O±_di§bË_rŞl_fÜw¬d
, "disable_roll_forward"},

150 {
O±_nÜecov”y
, "norecovery"},

151 {
O±_disÿrd
, "discard"},

152 {
O±_nodisÿrd
, "nodiscard"},

153 {
O±_noh—p
, "no_heap"},

154 {
O±_h—p
, "heap"},

155 {
O±_u£r_x©Œ
, "user_xattr"},

156 {
O±_nou£r_x©Œ
, "nouser_xattr"},

157 {
O±_aş
, "acl"},

158 {
O±_nßş
, "noacl"},

159 {
O±_aùive_logs
, "active_logs=%u"},

160 {
O±_di§bË_ext_id’tify
, "disable_ext_identify"},

161 {
O±_šlše_x©Œ
, "inline_xattr"},

162 {
O±_nošlše_x©Œ
, "noinline_xattr"},

163 {
O±_šlše_x©Œ_size
, "inline_xattr_size=%u"},

164 {
O±_šlše_d©a
, "inline_data"},

165 {
O±_šlše_d’Œy
, "inline_dentry"},

166 {
O±_nošlše_d’Œy
, "noinline_dentry"},

167 {
O±_æush_m”ge
, "flush_merge"},

168 {
O±_noæush_m”ge
, "noflush_merge"},

169 {
O±_nob¬r›r
, "nobarrier"},

170 {
O±_ç¡boÙ
, "fastboot"},

171 {
O±_ex‹Á_ÿche
, "extent_cache"},

172 {
O±_nÛx‹Á_ÿche
, "noextent_cache"},

173 {
O±_nošlše_d©a
, "noinline_data"},

174 {
O±_d©a_æush
, "data_flush"},

175 {
O±_»£rve_roÙ
, "reserve_root=%u"},

176 {
O±_»sgid
, "resgid=%u"},

177 {
O±_»suid
, "resuid=%u"},

178 {
O±_mode
, "mode=%s"},

179 {
O±_io_size_b™s
, "io_bits=%u"},

180 {
O±_çuÉ_šjeùiÚ
, "fault_injection=%u"},

181 {
O±_çuÉ_ty³
, "fault_type=%u"},

182 {
O±_Ïzytime
, "lazytime"},

183 {
O±_nŞazytime
, "nolazytime"},

184 {
O±_quÙa
, "quota"},

185 {
O±_noquÙa
, "noquota"},

186 {
O±_u¤quÙa
, "usrquota"},

187 {
O±_g½quÙa
, "grpquota"},

188 {
O±_´jquÙa
, "prjquota"},

189 {
O±_u¤jquÙa
, "usrjquota=%s"},

190 {
O±_g½jquÙa
, "grpjquota=%s"},

191 {
O±_´jjquÙa
, "prjjquota=%s"},

192 {
O±_offu¤jquÙa
, "usrjquota="},

193 {
O±_offg½jquÙa
, "grpjquota="},

194 {
O±_ofårjjquÙa
, "prjjquota="},

195 {
O±_jqfmt_vfsŞd
, "jqfmt=vfsold"},

196 {
O±_jqfmt_vfsv0
, "jqfmt=vfsv0"},

197 {
O±_jqfmt_vfsv1
, "jqfmt=vfsv1"},

198 {
O±_whšt
, "whint_mode=%s"},

199 {
O±_®loc
, "alloc_mode=%s"},

200 {
O±_fsync
, "fsync_mode=%s"},

201 {
O±_‹¡_dummy_’üy±iÚ
, "test_dummy_encryption"},

202 {
O±_checkpošt_di§bË
, "checkpoint=disable"},

203 {
O±_checkpošt_di§bË_ÿp
, "checkpoint=disable:%u"},

204 {
O±_checkpošt_di§bË_ÿp_³rc
, "checkpoint=disable:%u%%"},

205 {
O±_checkpošt_’abË
, "checkpoint=enable"},

206 {
O±_”r
, 
NULL
},

209 
	$f2fs_´štk
(
f2fs_sb_šfo
 *
sbi
, cÚ¡ *
fmt
, ...)

211 
va_fÜm©
 
vaf
;

212 
va_li¡
 
¬gs
;

213 
Ëv–
;

215 
	`va_¡¬t
(
¬gs
, 
fmt
);

217 
Ëv–
 = 
	`´štk_g‘_Ëv–
(
fmt
);

218 
vaf
.
fmt
 = 
	`´štk_sk_Ëv–
(fmt);

219 
vaf
.
va
 = &
¬gs
;

220 
	`´štk
("%c%cF2FS-fs (%s): %pV\n",

221 
KERN_SOH_ASCII
, 
Ëv–
, 
sbi
->
sb
->
s_id
, &
vaf
);

223 
	`va_’d
(
¬gs
);

224 
	}
}

226 #ifdeà
CONFIG_UNICODE


227 cÚ¡ 
	sf2fs_sb_’codšgs
 {

228 
__u16
 
	mmagic
;

229 *
	mÇme
;

230 *
	mv”siÚ
;

231 } 
	gf2fs_sb_’codšg_m­
[] = {

232 {
F2FS_ENC_UTF8_12_1
, "utf8", "12.1.0"},

235 
	$f2fs_sb_»ad_’codšg
(cÚ¡ 
f2fs_su³r_block
 *
sb
,

236 cÚ¡ 
f2fs_sb_’codšgs
 **
’codšg
,

237 
__u16
 *
æags
)

239 
__u16
 
magic
 = 
	`Ë16_to_ıu
(
sb
->
s_’codšg
);

240 
i
;

242 
i
 = 0; i < 
	`ARRAY_SIZE
(
f2fs_sb_’codšg_m­
); i++)

243 ià(
magic
 =ğ
f2fs_sb_’codšg_m­
[
i
].magic)

246 ià(
i
 >ğ
	`ARRAY_SIZE
(
f2fs_sb_’codšg_m­
))

247  -
EINVAL
;

249 *
’codšg
 = &
f2fs_sb_’codšg_m­
[
i
];

250 *
æags
 = 
	`Ë16_to_ıu
(
sb
->
s_’codšg_æags
);

253 
	}
}

256 
šlše
 
	$lim™_»£rve_roÙ
(
f2fs_sb_šfo
 *
sbi
)

258 
block_t
 
lim™
 = 
	`mš
((
sbi
->
u£r_block_couÁ
 << 1) / 1000,

259 
sbi
->
u£r_block_couÁ
 - sbi->
»£rved_blocks
);

262 ià(
	`‹¡_İt
(
sbi
, 
RESERVE_ROOT
) &&

263 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
 > 
lim™
) {

264 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
 = 
lim™
;

265 
	`f2fs_šfo
(
sbi
, "Reduce„eserved blocks for„oot = %u",

266 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
);

268 ià(!
	`‹¡_İt
(
sbi
, 
RESERVE_ROOT
) &&

269 (!
	`uid_eq
(
	`F2FS_OPTION
(
sbi
).
s_»suid
,

270 
	`make_kuid
(&
š™_u£r_ns
, 
F2FS_DEF_RESUID
)) ||

271 !
	`gid_eq
(
	`F2FS_OPTION
(
sbi
).
s_»sgid
,

272 
	`make_kgid
(&
š™_u£r_ns
, 
F2FS_DEF_RESGID
))))

273 
	`f2fs_šfo
(
sbi
, "Ignore s_resuid=%u, s_resgid=%u w/o„eserve_root",

274 
	`äom_kuid_munged
(&
š™_u£r_ns
,

275 
	`F2FS_OPTION
(
sbi
).
s_»suid
),

276 
	`äom_kgid_munged
(&
š™_u£r_ns
,

277 
	`F2FS_OPTION
(
sbi
).
s_»sgid
));

278 
	}
}

280 
	$š™_Úû
(*
foo
)

282 
f2fs_šode_šfo
 *
fi
 = (f2fs_šode_šfØ*è
foo
;

284 
	`šode_š™_Úû
(&
fi
->
vfs_šode
);

285 
	}
}

287 #ifdeà
CONFIG_QUOTA


288 cÚ¡ * cÚ¡ 
	gquÙ©y³s
[] = 
INITQFNAMES
;

289 
	#QTYPE2NAME
(
t
è(
quÙ©y³s
[t])

	)

290 
	$f2fs_£t_qf_Çme
(
su³r_block
 *
sb
, 
qty³
,

291 
sub¡ršg_t
 *
¬gs
)

293 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

294 *
qÇme
;

295 
»t
 = -
EINVAL
;

297 ià(
	`sb_ªy_quÙa_lßded
(
sb
è&& !
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
]) {

298 
	`f2fs_”r
(
sbi
, "Cannot change journaled quota options when quotaurned on");

299  -
EINVAL
;

301 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
)) {

302 
	`f2fs_šfo
(
sbi
, "QUOTA feature isƒnabled, so ignore qf_name");

306 
qÇme
 = 
	`m©ch_¡rdup
(
¬gs
);

307 ià(!
qÇme
) {

308 
	`f2fs_”r
(
sbi
, "Notƒnough memory for storing quotafile‚ame");

309  -
ENOMEM
;

311 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
]) {

312 ià(
	`¡rcmp
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
], 
qÇme
) == 0)

313 
»t
 = 0;

315 
	`f2fs_”r
(
sbi
, "%s quota file‡lready specified",

316 
	`QTYPE2NAME
(
qty³
));

317 
”rout
;

319 ià(
	`¡rchr
(
qÇme
, '/')) {

320 
	`f2fs_”r
(
sbi
, "quotafile must be on filesystem„oot");

321 
”rout
;

323 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
] = 
qÇme
;

324 
	`£t_İt
(
sbi
, 
QUOTA
);

326 
”rout
:

327 
	`kvä“
(
qÇme
);

328  
»t
;

329 
	}
}

331 
	$f2fs_ş—r_qf_Çme
(
su³r_block
 *
sb
, 
qty³
)

333 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

335 ià(
	`sb_ªy_quÙa_lßded
(
sb
è&& 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
]) {

336 
	`f2fs_”r
(
sbi
, "Cannot change journaled quota options when quotaurned on");

337  -
EINVAL
;

339 
	`kvä“
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
]);

340 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
qty³
] = 
NULL
;

342 
	}
}

344 
	$f2fs_check_quÙa_İtiÚs
(
f2fs_sb_šfo
 *
sbi
)

351 ià(
	`‹¡_İt
(
sbi
, 
PRJQUOTA
è&& !
	`f2fs_sb_has_´ojeù_quÙa
(sbi)) {

352 
	`f2fs_”r
(
sbi
, "Project quota feature‚otƒnabled. Cannotƒnable…roject quotaƒnforcement.");

355 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
USRQUOTA
] ||

356 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
GRPQUOTA
] ||

357 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
PRJQUOTA
]) {

358 ià(
	`‹¡_İt
(
sbi
, 
USRQUOTA
) &&

359 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
USRQUOTA
])

360 
	`ş—r_İt
(
sbi
, 
USRQUOTA
);

362 ià(
	`‹¡_İt
(
sbi
, 
GRPQUOTA
) &&

363 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
GRPQUOTA
])

364 
	`ş—r_İt
(
sbi
, 
GRPQUOTA
);

366 ià(
	`‹¡_İt
(
sbi
, 
PRJQUOTA
) &&

367 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
PRJQUOTA
])

368 
	`ş—r_İt
(
sbi
, 
PRJQUOTA
);

370 ià(
	`‹¡_İt
(
sbi
, 
GRPQUOTA
è||e¡_İt(sbi, 
USRQUOTA
) ||

371 
	`‹¡_İt
(
sbi
, 
PRJQUOTA
)) {

372 
	`f2fs_”r
(
sbi
, "old‡nd‚ew quota format mixing");

376 ià(!
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
) {

377 
	`f2fs_”r
(
sbi
, "journaled quota format‚ot specified");

382 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
è&& 
	`F2FS_OPTION
(sbi).
s_jquÙa_fmt
) {

383 
	`f2fs_šfo
(
sbi
, "QUOTA feature isƒnabled, so ignore jquota_fmt");

384 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
 = 0;

387 
	}
}

390 
	$·r£_İtiÚs
(
su³r_block
 *
sb
, *
İtiÚs
)

392 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

393 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

394 *
p
, *
Çme
;

395 
¬g
 = 0;

396 
kuid_t
 
uid
;

397 
kgid_t
 
gid
;

398 #ifdeà
CONFIG_QUOTA


399 
»t
;

402 ià(!
İtiÚs
)

405 (
p
 = 
	`¡r£p
(&
İtiÚs
, ",")è!ğ
NULL
) {

406 
tok’
;

407 ià(!*
p
)

413 
¬gs
[0].
to
 =‡rgs[0].
äom
 = 
NULL
;

414 
tok’
 = 
	`m©ch_tok’
(
p
, 
f2fs_tok’s
, 
¬gs
);

416 
tok’
) {

417 
O±_gc_background
:

418 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

420 ià(!
Çme
)

421  -
ENOMEM
;

422 ià(
	`¡¾’
(
Çme
è=ğ2 && !
	`¡ºcmp
(name, "on", 2)) {

423 
	`£t_İt
(
sbi
, 
BG_GC
);

424 
	`ş—r_İt
(
sbi
, 
FORCE_FG_GC
);

425 } ià(
	`¡¾’
(
Çme
è=ğ3 && !
	`¡ºcmp
(name, "off", 3)) {

426 
	`ş—r_İt
(
sbi
, 
BG_GC
);

427 
	`ş—r_İt
(
sbi
, 
FORCE_FG_GC
);

428 } ià(
	`¡¾’
(
Çme
è=ğ4 && !
	`¡ºcmp
(name, "sync", 4)) {

429 
	`£t_İt
(
sbi
, 
BG_GC
);

430 
	`£t_İt
(
sbi
, 
FORCE_FG_GC
);

432 
	`kvä“
(
Çme
);

433  -
EINVAL
;

435 
	`kvä“
(
Çme
);

437 
O±_di§bË_rŞl_fÜw¬d
:

438 
	`£t_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
);

440 
O±_nÜecov”y
:

442 
	`£t_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
);

443 ià(!
	`f2fs_»adÚly
(
sb
))

444  -
EINVAL
;

446 
O±_disÿrd
:

447 
	`£t_İt
(
sbi
, 
DISCARD
);

449 
O±_nodisÿrd
:

450 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
)) {

451 
	`f2fs_w¬n
(
sbi
, "discard is„equired for zoned block devices");

452  -
EINVAL
;

454 
	`ş—r_İt
(
sbi
, 
DISCARD
);

456 
O±_noh—p
:

457 
	`£t_İt
(
sbi
, 
NOHEAP
);

459 
O±_h—p
:

460 
	`ş—r_İt
(
sbi
, 
NOHEAP
);

462 #ifdeà
CONFIG_F2FS_FS_XATTR


463 
O±_u£r_x©Œ
:

464 
	`£t_İt
(
sbi
, 
XATTR_USER
);

466 
O±_nou£r_x©Œ
:

467 
	`ş—r_İt
(
sbi
, 
XATTR_USER
);

469 
O±_šlše_x©Œ
:

470 
	`£t_İt
(
sbi
, 
INLINE_XATTR
);

472 
O±_nošlše_x©Œ
:

473 
	`ş—r_İt
(
sbi
, 
INLINE_XATTR
);

475 
O±_šlše_x©Œ_size
:

476 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

477  -
EINVAL
;

478 
	`£t_İt
(
sbi
, 
INLINE_XATTR_SIZE
);

479 
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
 = 
¬g
;

482 
O±_u£r_x©Œ
:

483 
	`f2fs_šfo
(
sbi
, "user_xattr options‚ot supported");

485 
O±_nou£r_x©Œ
:

486 
	`f2fs_šfo
(
sbi
, "nouser_xattr options‚ot supported");

488 
O±_šlše_x©Œ
:

489 
	`f2fs_šfo
(
sbi
, "inline_xattr options‚ot supported");

491 
O±_nošlše_x©Œ
:

492 
	`f2fs_šfo
(
sbi
, "noinline_xattr options‚ot supported");

495 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


496 
O±_aş
:

497 
	`£t_İt
(
sbi
, 
POSIX_ACL
);

499 
O±_nßş
:

500 
	`ş—r_İt
(
sbi
, 
POSIX_ACL
);

503 
O±_aş
:

504 
	`f2fs_šfo
(
sbi
, "acl options‚ot supported");

506 
O±_nßş
:

507 
	`f2fs_šfo
(
sbi
, "noacl options‚ot supported");

510 
O±_aùive_logs
:

511 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

512  -
EINVAL
;

513 ià(
¬g
 !ğ2 &&‡rg !ğ4 &&‡rg !ğ
NR_CURSEG_TYPE
)

514  -
EINVAL
;

515 
	`F2FS_OPTION
(
sbi
).
aùive_logs
 = 
¬g
;

517 
O±_di§bË_ext_id’tify
:

518 
	`£t_İt
(
sbi
, 
DISABLE_EXT_IDENTIFY
);

520 
O±_šlše_d©a
:

521 
	`£t_İt
(
sbi
, 
INLINE_DATA
);

523 
O±_šlše_d’Œy
:

524 
	`£t_İt
(
sbi
, 
INLINE_DENTRY
);

526 
O±_nošlše_d’Œy
:

527 
	`ş—r_İt
(
sbi
, 
INLINE_DENTRY
);

529 
O±_æush_m”ge
:

530 
	`£t_İt
(
sbi
, 
FLUSH_MERGE
);

532 
O±_noæush_m”ge
:

533 
	`ş—r_İt
(
sbi
, 
FLUSH_MERGE
);

535 
O±_nob¬r›r
:

536 
	`£t_İt
(
sbi
, 
NOBARRIER
);

538 
O±_ç¡boÙ
:

539 
	`£t_İt
(
sbi
, 
FASTBOOT
);

541 
O±_ex‹Á_ÿche
:

542 
	`£t_İt
(
sbi
, 
EXTENT_CACHE
);

544 
O±_nÛx‹Á_ÿche
:

545 
	`ş—r_İt
(
sbi
, 
EXTENT_CACHE
);

547 
O±_nošlše_d©a
:

548 
	`ş—r_İt
(
sbi
, 
INLINE_DATA
);

550 
O±_d©a_æush
:

551 
	`£t_İt
(
sbi
, 
DATA_FLUSH
);

553 
O±_»£rve_roÙ
:

554 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

555  -
EINVAL
;

556 ià(
	`‹¡_İt
(
sbi
, 
RESERVE_ROOT
)) {

557 
	`f2fs_šfo
(
sbi
, "Preserve…revious„eserve_root=%u",

558 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
);

560 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
 = 
¬g
;

561 
	`£t_İt
(
sbi
, 
RESERVE_ROOT
);

564 
O±_»suid
:

565 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

566  -
EINVAL
;

567 
uid
 = 
	`make_kuid
(
	`cu¼’t_u£r_ns
(), 
¬g
);

568 ià(!
	`uid_v®id
(
uid
)) {

569 
	`f2fs_”r
(
sbi
, "Inv®id uid v®u%d", 
¬g
);

570  -
EINVAL
;

572 
	`F2FS_OPTION
(
sbi
).
s_»suid
 = 
uid
;

574 
O±_»sgid
:

575 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

576  -
EINVAL
;

577 
gid
 = 
	`make_kgid
(
	`cu¼’t_u£r_ns
(), 
¬g
);

578 ià(!
	`gid_v®id
(
gid
)) {

579 
	`f2fs_”r
(
sbi
, "Inv®id gid v®u%d", 
¬g
);

580  -
EINVAL
;

582 
	`F2FS_OPTION
(
sbi
).
s_»sgid
 = 
gid
;

584 
O±_mode
:

585 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

587 ià(!
Çme
)

588  -
ENOMEM
;

589 ià(
	`¡¾’
(
Çme
) == 8 &&

590 !
	`¡ºcmp
(
Çme
, "adaptive", 8)) {

591 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
)) {

592 
	`f2fs_w¬n
(
sbi
, "adaptive mode is‚ot‡llowed with zoned block device feature");

593 
	`kvä“
(
Çme
);

594  -
EINVAL
;

596 
	`£t_İt_mode
(
sbi
, 
F2FS_MOUNT_ADAPTIVE
);

597 } ià(
	`¡¾’
(
Çme
) == 3 &&

598 !
	`¡ºcmp
(
Çme
, "lfs", 3)) {

599 
	`£t_İt_mode
(
sbi
, 
F2FS_MOUNT_LFS
);

601 
	`kvä“
(
Çme
);

602  -
EINVAL
;

604 
	`kvä“
(
Çme
);

606 
O±_io_size_b™s
:

607 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

608  -
EINVAL
;

609 ià(
¬g
 <ğ0 ||‡rg > 
	`__og2_u32
(
BIO_MAX_PAGES
)) {

610 
	`f2fs_w¬n
(
sbi
, "Not support %d,†argerhan %d",

611 1 << 
¬g
, 
BIO_MAX_PAGES
);

612  -
EINVAL
;

614 
	`F2FS_OPTION
(
sbi
).
wr™e_io_size_b™s
 = 
¬g
;

616 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


617 
O±_çuÉ_šjeùiÚ
:

618 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

619  -
EINVAL
;

620 
	`f2fs_bud_çuÉ_©Œ
(
sbi
, 
¬g
, 
F2FS_ALL_FAULT_TYPE
);

621 
	`£t_İt
(
sbi
, 
FAULT_INJECTION
);

624 
O±_çuÉ_ty³
:

625 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

626  -
EINVAL
;

627 
	`f2fs_bud_çuÉ_©Œ
(
sbi
, 0, 
¬g
);

628 
	`£t_İt
(
sbi
, 
FAULT_INJECTION
);

631 
O±_çuÉ_šjeùiÚ
:

632 
	`f2fs_šfo
(
sbi
, "fault_injection options‚ot supported");

635 
O±_çuÉ_ty³
:

636 
	`f2fs_šfo
(
sbi
, "fault_type options‚ot supported");

639 
O±_Ïzytime
:

640 
sb
->
s_æags
 |ğ
SB_LAZYTIME
;

642 
O±_nŞazytime
:

643 
sb
->
s_æags
 &ğ~
SB_LAZYTIME
;

645 #ifdeà
CONFIG_QUOTA


646 
O±_quÙa
:

647 
O±_u¤quÙa
:

648 
	`£t_İt
(
sbi
, 
USRQUOTA
);

650 
O±_g½quÙa
:

651 
	`£t_İt
(
sbi
, 
GRPQUOTA
);

653 
O±_´jquÙa
:

654 
	`£t_İt
(
sbi
, 
PRJQUOTA
);

656 
O±_u¤jquÙa
:

657 
»t
 = 
	`f2fs_£t_qf_Çme
(
sb
, 
USRQUOTA
, &
¬gs
[0]);

658 ià(
»t
)

659  
»t
;

661 
O±_g½jquÙa
:

662 
»t
 = 
	`f2fs_£t_qf_Çme
(
sb
, 
GRPQUOTA
, &
¬gs
[0]);

663 ià(
»t
)

664  
»t
;

666 
O±_´jjquÙa
:

667 
»t
 = 
	`f2fs_£t_qf_Çme
(
sb
, 
PRJQUOTA
, &
¬gs
[0]);

668 ià(
»t
)

669  
»t
;

671 
O±_offu¤jquÙa
:

672 
»t
 = 
	`f2fs_ş—r_qf_Çme
(
sb
, 
USRQUOTA
);

673 ià(
»t
)

674  
»t
;

676 
O±_offg½jquÙa
:

677 
»t
 = 
	`f2fs_ş—r_qf_Çme
(
sb
, 
GRPQUOTA
);

678 ià(
»t
)

679  
»t
;

681 
O±_ofårjjquÙa
:

682 
»t
 = 
	`f2fs_ş—r_qf_Çme
(
sb
, 
PRJQUOTA
);

683 ià(
»t
)

684  
»t
;

686 
O±_jqfmt_vfsŞd
:

687 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
 = 
QFMT_VFS_OLD
;

689 
O±_jqfmt_vfsv0
:

690 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
 = 
QFMT_VFS_V0
;

692 
O±_jqfmt_vfsv1
:

693 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
 = 
QFMT_VFS_V1
;

695 
O±_noquÙa
:

696 
	`ş—r_İt
(
sbi
, 
QUOTA
);

697 
	`ş—r_İt
(
sbi
, 
USRQUOTA
);

698 
	`ş—r_İt
(
sbi
, 
GRPQUOTA
);

699 
	`ş—r_İt
(
sbi
, 
PRJQUOTA
);

702 
O±_quÙa
:

703 
O±_u¤quÙa
:

704 
O±_g½quÙa
:

705 
O±_´jquÙa
:

706 
O±_u¤jquÙa
:

707 
O±_g½jquÙa
:

708 
O±_´jjquÙa
:

709 
O±_offu¤jquÙa
:

710 
O±_offg½jquÙa
:

711 
O±_ofårjjquÙa
:

712 
O±_jqfmt_vfsŞd
:

713 
O±_jqfmt_vfsv0
:

714 
O±_jqfmt_vfsv1
:

715 
O±_noquÙa
:

716 
	`f2fs_šfo
(
sbi
, "quota operations‚ot supported");

719 
O±_whšt
:

720 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

721 ià(!
Çme
)

722  -
ENOMEM
;

723 ià(
	`¡¾’
(
Çme
) == 10 &&

724 !
	`¡ºcmp
(
Çme
, "user-based", 10)) {

725 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 = 
WHINT_MODE_USER
;

726 } ià(
	`¡¾’
(
Çme
) == 3 &&

727 !
	`¡ºcmp
(
Çme
, "off", 3)) {

728 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 = 
WHINT_MODE_OFF
;

729 } ià(
	`¡¾’
(
Çme
) == 8 &&

730 !
	`¡ºcmp
(
Çme
, "fs-based", 8)) {

731 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 = 
WHINT_MODE_FS
;

733 
	`kvä“
(
Çme
);

734  -
EINVAL
;

736 
	`kvä“
(
Çme
);

738 
O±_®loc
:

739 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

740 ià(!
Çme
)

741  -
ENOMEM
;

743 ià(
	`¡¾’
(
Çme
) == 7 &&

744 !
	`¡ºcmp
(
Çme
, "default", 7)) {

745 
	`F2FS_OPTION
(
sbi
).
®loc_mode
 = 
ALLOC_MODE_DEFAULT
;

746 } ià(
	`¡¾’
(
Çme
) == 5 &&

747 !
	`¡ºcmp
(
Çme
, "reuse", 5)) {

748 
	`F2FS_OPTION
(
sbi
).
®loc_mode
 = 
ALLOC_MODE_REUSE
;

750 
	`kvä“
(
Çme
);

751  -
EINVAL
;

753 
	`kvä“
(
Çme
);

755 
O±_fsync
:

756 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

757 ià(!
Çme
)

758  -
ENOMEM
;

759 ià(
	`¡¾’
(
Çme
) == 5 &&

760 !
	`¡ºcmp
(
Çme
, "posix", 5)) {

761 
	`F2FS_OPTION
(
sbi
).
fsync_mode
 = 
FSYNC_MODE_POSIX
;

762 } ià(
	`¡¾’
(
Çme
) == 6 &&

763 !
	`¡ºcmp
(
Çme
, "strict", 6)) {

764 
	`F2FS_OPTION
(
sbi
).
fsync_mode
 = 
FSYNC_MODE_STRICT
;

765 } ià(
	`¡¾’
(
Çme
) == 9 &&

766 !
	`¡ºcmp
(
Çme
, "nobarrier", 9)) {

767 
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =

768 
FSYNC_MODE_NOBARRIER
;

770 
	`kvä“
(
Çme
);

771  -
EINVAL
;

773 
	`kvä“
(
Çme
);

775 
O±_‹¡_dummy_’üy±iÚ
:

776 #ifdeà
CONFIG_FS_ENCRYPTION


777 ià(!
	`f2fs_sb_has_’üy±
(
sbi
)) {

778 
	`f2fs_”r
(
sbi
, "Encrypt feature is off");

779  -
EINVAL
;

782 
	`F2FS_OPTION
(
sbi
).
‹¡_dummy_’üy±iÚ
 = 
Œue
;

783 
	`f2fs_šfo
(
sbi
, "Test dummyƒncryption modeƒnabled");

785 
	`f2fs_šfo
(
sbi
, "Test dummyƒncryption mount option ignored");

788 
O±_checkpošt_di§bË_ÿp_³rc
:

789 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

790  -
EINVAL
;

791 ià(
¬g
 < 0 ||‡rg > 100)

792  -
EINVAL
;

793 ià(
¬g
 == 100)

794 
	`F2FS_OPTION
(
sbi
).
unu§bË_ÿp
 =

795 
sbi
->
u£r_block_couÁ
;

797 
	`F2FS_OPTION
(
sbi
).
unu§bË_ÿp
 =

798 (
sbi
->
u£r_block_couÁ
 / 100è* 
¬g
;

799 
	`£t_İt
(
sbi
, 
DISABLE_CHECKPOINT
);

801 
O±_checkpošt_di§bË_ÿp
:

802 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

803  -
EINVAL
;

804 
	`F2FS_OPTION
(
sbi
).
unu§bË_ÿp
 = 
¬g
;

805 
	`£t_İt
(
sbi
, 
DISABLE_CHECKPOINT
);

807 
O±_checkpošt_di§bË
:

808 
	`£t_İt
(
sbi
, 
DISABLE_CHECKPOINT
);

810 
O±_checkpošt_’abË
:

811 
	`ş—r_İt
(
sbi
, 
DISABLE_CHECKPOINT
);

814 
	`f2fs_”r
(
sbi
, "Unrecognized mount option \"%s\" or missing value",

815 
p
);

816  -
EINVAL
;

819 #ifdeà
CONFIG_QUOTA


820 ià(
	`f2fs_check_quÙa_İtiÚs
(
sbi
))

821  -
EINVAL
;

823 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
è&& !
	`f2fs_»adÚly
(sbi->
sb
)) {

824 
	`f2fs_šfo
(
sbi
, "Filesystem with quota feature cannot be mounted RDWR without CONFIG_QUOTA");

825  -
EINVAL
;

827 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
sbi
è&& !
	`f2fs_»adÚly
(sbi->
sb
)) {

828 
	`f2fs_”r
(
sbi
, "Filesystem with…roject quota feature cannot be mounted RDWR without CONFIG_QUOTA");

829  -
EINVAL
;

832 #iâdeà
CONFIG_UNICODE


833 ià(
	`f2fs_sb_has_ÿ£fŞd
(
sbi
)) {

834 
	`f2fs_”r
(
sbi
,

836  -
EINVAL
;

840 ià(
	`F2FS_IO_SIZE_BITS
(
sbi
è&& !
	`‹¡_İt
(sbi, 
LFS
)) {

841 
	`f2fs_”r
(
sbi
, "Should set mode=lfs with %uKB-sized IO",

842 
	`F2FS_IO_SIZE_KB
(
sbi
));

843  -
EINVAL
;

846 ià(
	`‹¡_İt
(
sbi
, 
INLINE_XATTR_SIZE
)) {

847 
mš_size
, 
max_size
;

849 ià(!
	`f2fs_sb_has_exŒa_©Œ
(
sbi
) ||

850 !
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
)) {

851 
	`f2fs_”r
(
sbi
, "extra_attr or flexible_inline_xattr feature is off");

852  -
EINVAL
;

854 ià(!
	`‹¡_İt
(
sbi
, 
INLINE_XATTR
)) {

855 
	`f2fs_”r
(
sbi
, "inline_xattr_size option should be set with inline_xattr option");

856  -
EINVAL
;

859 
mš_size
 = (
f2fs_x©Œ_h—d”
è/ (
__Ë32
);

860 
max_size
 = 
MAX_INLINE_XATTR_SIZE
;

862 ià(
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
 < 
mš_size
 ||

863 
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
 > 
max_size
) {

864 
	`f2fs_”r
(
sbi
, "inline xattr size is out of„ange: %d ~ %d",

865 
mš_size
, 
max_size
);

866  -
EINVAL
;

870 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_CHECKPOINT
è&&e¡_İt(sbi, 
LFS
)) {

871 
	`f2fs_”r
(
sbi
, "LFS‚ot compatible with checkpoint=disable\n");

872  -
EINVAL
;

878 ià(
	`F2FS_OPTION
(
sbi
).
aùive_logs
 !ğ
NR_CURSEG_TYPE
)

879 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 = 
WHINT_MODE_OFF
;

881 
	}
}

883 
šode
 *
	$f2fs_®loc_šode
(
su³r_block
 *
sb
)

885 
f2fs_šode_šfo
 *
fi
;

887 
fi
 = 
	`kmem_ÿche_®loc
(
f2fs_šode_ÿch•
, 
GFP_F2FS_ZERO
);

888 ià(!
fi
)

889  
NULL
;

891 
	`š™_Úû
((*è
fi
);

894 
	`©omic_£t
(&
fi
->
dœty_·ges
, 0);

895 
	`š™_rw£m
(&
fi
->
i_£m
);

896 
	`INIT_LIST_HEAD
(&
fi
->
dœty_li¡
);

897 
	`INIT_LIST_HEAD
(&
fi
->
gdœty_li¡
);

898 
	`INIT_LIST_HEAD
(&
fi
->
šmem_i¡
);

899 
	`INIT_LIST_HEAD
(&
fi
->
šmem_·ges
);

900 
	`mu‹x_š™
(&
fi
->
šmem_lock
);

901 
	`š™_rw£m
(&
fi
->
i_gc_rw£m
[
READ
]);

902 
	`š™_rw£m
(&
fi
->
i_gc_rw£m
[
WRITE
]);

903 
	`š™_rw£m
(&
fi
->
i_mm­_£m
);

904 
	`š™_rw£m
(&
fi
->
i_x©Œ_£m
);

907 
fi
->
i_dœ_Ëv–
 = 
	`F2FS_SB
(
sb
)->
dœ_Ëv–
;

909  &
fi
->
vfs_šode
;

910 
	}
}

912 
	$f2fs_drİ_šode
(
šode
 *inode)

914 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

915 
»t
;

921 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
))) {

922 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

923 
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
)) {

924 
	`Œaû_f2fs_drİ_šode
(
šode
, 1);

936 ià((!
	`šode_unhashed
(
šode
è&& inode->
i_¡©e
 & 
I_SYNC
)) {

937 ià(!
šode
->
i_Æšk
 && !
	`is_bad_šode
(inode)) {

939 
	`©omic_šc
(&
šode
->
i_couÁ
);

940 
	`¥š_uÆock
(&
šode
->
i_lock
);

943 ià(
	`f2fs_is_©omic_fe
(
šode
))

944 
	`f2fs_drİ_šmem_·ges
(
šode
);

947 
	`f2fs_de¡roy_ex‹Á_node
(
šode
);

949 
	`sb_¡¬t_štwr™e
(
šode
->
i_sb
);

950 
	`f2fs_i_size_wr™e
(
šode
, 0);

952 
	`f2fs_subm™_m”ged_wr™e_cÚd
(
	`F2FS_I_SB
(
šode
),

953 
šode
, 
NULL
, 0, 
DATA
);

954 
	`Œunÿ‹_šode_·ges_fš®
(
šode
->
i_m­pšg
);

956 ià(
	`F2FS_HAS_BLOCKS
(
šode
))

957 
	`f2fs_Œunÿ‹
(
šode
);

959 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

961 
	`¥š_lock
(&
šode
->
i_lock
);

962 
	`©omic_dec
(&
šode
->
i_couÁ
);

964 
	`Œaû_f2fs_drİ_šode
(
šode
, 0);

967 
»t
 = 
	`g’”ic_drİ_šode
(
šode
);

968 ià(!
»t
)

969 
»t
 = 
	`fsüy±_drİ_šode
(
šode
);

970 
	`Œaû_f2fs_drİ_šode
(
šode
, 
»t
);

971  
»t
;

972 
	}
}

974 
	$f2fs_šode_dœt›d
(
šode
 *šode, 
boŞ
 
sync
)

976 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

977 
»t
 = 0;

979 
	`¥š_lock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

980 ià(
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
)) {

981 
»t
 = 1;

983 
	`£t_šode_æag
(
šode
, 
FI_DIRTY_INODE
);

984 
	`¡©_šc_dœty_šode
(
sbi
, 
DIRTY_META
);

986 ià(
sync
 && 
	`li¡_em±y
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
)) {

987 
	`li¡_add_
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
,

988 &
sbi
->
šode_li¡
[
DIRTY_META
]);

989 
	`šc_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_IMETA
);

991 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

992  
»t
;

993 
	}
}

995 
	$f2fs_šode_synûd
(
šode
 *inode)

997 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

999 
	`¥š_lock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1000 ià(!
	`is_šode_æag_£t
(
šode
, 
FI_DIRTY_INODE
)) {

1001 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1004 ià(!
	`li¡_em±y
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
)) {

1005 
	`li¡_d–_š™
(&
	`F2FS_I
(
šode
)->
gdœty_li¡
);

1006 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_IMETA
);

1008 
	`ş—r_šode_æag
(
šode
, 
FI_DIRTY_INODE
);

1009 
	`ş—r_šode_æag
(
šode
, 
FI_AUTO_RECOVER
);

1010 
	`¡©_dec_dœty_šode
(
	`F2FS_I_SB
(
šode
), 
DIRTY_META
);

1011 
	`¥š_uÆock
(&
sbi
->
šode_lock
[
DIRTY_META
]);

1012 
	}
}

1019 
	$f2fs_dœty_šode
(
šode
 *šode, 
æags
)

1021 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1023 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

1024 
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
))

1027 ià(
æags
 =ğ
I_DIRTY_TIME
)

1030 ià(
	`is_šode_æag_£t
(
šode
, 
FI_AUTO_RECOVER
))

1031 
	`ş—r_šode_æag
(
šode
, 
FI_AUTO_RECOVER
);

1033 
	`f2fs_šode_dœt›d
(
šode
, 
çl£
);

1034 
	}
}

1036 
	$f2fs_ä“_šode
(
šode
 *inode)

1038 
	`fsüy±_ä“_šode
(
šode
);

1039 
	`kmem_ÿche_ä“
(
f2fs_šode_ÿch•
, 
	`F2FS_I
(
šode
));

1040 
	}
}

1042 
	$de¡roy_³rıu_šfo
(
f2fs_sb_šfo
 *
sbi
)

1044 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
®loc_v®id_block_couÁ
);

1045 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
tÙ®_v®id_šode_couÁ
);

1046 
	}
}

1048 
	$de¡roy_deviû_li¡
(
f2fs_sb_šfo
 *
sbi
)

1050 
i
;

1052 
i
 = 0; i < 
sbi
->
s_ndevs
; i++) {

1053 
	`blkdev_put
(
	`FDEV
(
i
).
bdev
, 
FMODE_EXCL
);

1054 #ifdeà
CONFIG_BLK_DEV_ZONED


1055 
	`kvä“
(
	`FDEV
(
i
).
blkz_£q
);

1058 
	`kvä“
(
sbi
->
devs
);

1059 
	}
}

1061 
	$f2fs_put_su³r
(
su³r_block
 *
sb
)

1063 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1064 
i
;

1065 
boŞ
 
drİ³d
;

1067 
	`f2fs_quÙa_off_umouÁ
(
sb
);

1070 
	`mu‹x_lock
(&
sbi
->
umouÁ_mu‹x
);

1077 ià((
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_DIRTY
) ||

1078 !
	`is_£t_ck±_æags
(
sbi
, 
CP_UMOUNT_FLAG
))) {

1079 
ı_cÚŒŞ
 
ıc
 = {

1080 .
»asÚ
 = 
CP_UMOUNT
,

1082 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1086 
drİ³d
 = 
	`f2fs_issue_disÿrd_timeout
(
sbi
);

1088 ià((
	`f2fs_hw_suµÜt_disÿrd
(
sbi
è|| 
	`f2fs_hw_should_disÿrd
(sbi)) &&

1089 !
sbi
->
disÿrd_blks
 && !
drİ³d
) {

1090 
ı_cÚŒŞ
 
ıc
 = {

1091 .
»asÚ
 = 
CP_UMOUNT
 | 
CP_TRIMMED
,

1093 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1100 
	`f2fs_»Ëa£_šo_’Œy
(
sbi
, 
Œue
);

1102 
	`f2fs_Ëave_shršk”
(
sbi
);

1103 
	`mu‹x_uÆock
(&
sbi
->
umouÁ_mu‹x
);

1106 
	`f2fs_æush_m”ged_wr™es
(
sbi
);

1108 
	`f2fs_wa™_Ú_®l_·ges_wr™eback
(
sbi
);

1110 
	`f2fs_bug_Ú
(
sbi
, sbi->
fsync_node_num
);

1112 
	`ut
(
sbi
->
node_šode
);

1113 
sbi
->
node_šode
 = 
NULL
;

1115 
	`ut
(
sbi
->
m‘a_šode
);

1116 
sbi
->
m‘a_šode
 = 
NULL
;

1122 
	`f2fs_de¡roy_¡©s
(
sbi
);

1125 
	`f2fs_de¡roy_node_mªag”
(
sbi
);

1126 
	`f2fs_de¡roy_£gm’t_mªag”
(
sbi
);

1128 
	`kvä“
(
sbi
->
ck±
);

1130 
	`f2fs_uÄegi¡”_sysfs
(
sbi
);

1132 
sb
->
s_fs_šfo
 = 
NULL
;

1133 ià(
sbi
->
s_chksum_driv”
)

1134 
	`üy±o_ä“_shash
(
sbi
->
s_chksum_driv”
);

1135 
	`kvä“
(
sbi
->
¿w_su³r
);

1137 
	`de¡roy_deviû_li¡
(
sbi
);

1138 
	`mempoŞ_de¡roy
(
sbi
->
wr™e_io_dummy
);

1139 #ifdeà
CONFIG_QUOTA


1140 
i
 = 0; i < 
MAXQUOTAS
; i++)

1141 
	`kvä“
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
]);

1143 
	`de¡roy_³rıu_šfo
(
sbi
);

1144 
i
 = 0; i < 
NR_PAGE_TYPE
; i++)

1145 
	`kvä“
(
sbi
->
wr™e_io
[
i
]);

1146 #ifdeà
CONFIG_UNICODE


1147 
	`utf8_uÆßd
(
sbi
->
s_’codšg
);

1149 
	`kvä“
(
sbi
);

1150 
	}
}

1152 
	$f2fs_sync_fs
(
su³r_block
 *
sb
, 
sync
)

1154 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1155 
”r
 = 0;

1157 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1159 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_CP_DISABLED
)))

1162 
	`Œaû_f2fs_sync_fs
(
sb
, 
sync
);

1164 ià(
	`uÆik–y
(
	`is_sbi_æag_£t
(
sbi
, 
SBI_POR_DOING
)))

1165  -
EAGAIN
;

1167 ià(
sync
) {

1168 
ı_cÚŒŞ
 
ıc
;

1170 
ıc
.
»asÚ
 = 
	`__g‘_ı_»asÚ
(
sbi
);

1172 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

1173 
”r
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1174 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

1176 
	`f2fs_Œaû_ios
(
NULL
, 1);

1178  
”r
;

1179 
	}
}

1181 
	$f2fs_ä“ze
(
su³r_block
 *
sb
)

1183 ià(
	`f2fs_»adÚly
(
sb
))

1187 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
	`F2FS_SB
(
sb
))))

1188  -
EIO
;

1191 ià(
	`is_sbi_æag_£t
(
	`F2FS_SB
(
sb
), 
SBI_IS_DIRTY
))

1192  -
EINVAL
;

1194 
	}
}

1196 
	$f2fs_unä“ze
(
su³r_block
 *
sb
)

1199 
	}
}

1201 #ifdeà
CONFIG_QUOTA


1202 
	$f2fs_¡©fs_´ojeù
(
su³r_block
 *
sb
,

1203 
k´ojid_t
 
´ojid
, 
k¡©fs
 *
buf
)

1205 
kqid
 
qid
;

1206 
dquÙ
 *dquot;

1207 
u64
 
lim™
;

1208 
u64
 
curblock
;

1210 
qid
 = 
	`make_kqid_´ojid
(
´ojid
);

1211 
dquÙ
 = 
	`dqg‘
(
sb
, 
qid
);

1212 ià(
	`IS_ERR
(
dquÙ
))

1213  
	`PTR_ERR
(
dquÙ
);

1214 
	`¥š_lock
(&
dquÙ
->
dq_dqb_lock
);

1216 
lim™
 = 
	`mš_nÙ_z”o
(
dquÙ
->
dq_dqb
.
dqb_bsoálim™
,

1217 
dquÙ
->
dq_dqb
.
dqb_bh¬dlim™
);

1218 ià(
lim™
)

1219 
lim™
 >>ğ
sb
->
s_blocksize_b™s
;

1221 ià(
lim™
 && 
buf
->
f_blocks
 >†imit) {

1222 
curblock
 = 
dquÙ
->
dq_dqb
.
dqb_cur¥aû
 >> 
sb
->
s_blocksize_b™s
;

1223 
buf
->
f_blocks
 = 
lim™
;

1224 
buf
->
f_bä“
 = buf->
f_bava
 =

1225 (
buf
->
f_blocks
 > 
curblock
) ?

1226 (
buf
->
f_blocks
 - 
curblock
) : 0;

1229 
lim™
 = 
	`mš_nÙ_z”o
(
dquÙ
->
dq_dqb
.
dqb_isoálim™
,

1230 
dquÙ
->
dq_dqb
.
dqb_ih¬dlim™
);

1232 ià(
lim™
 && 
buf
->
f_fes
 >†imit) {

1233 
buf
->
f_fes
 = 
lim™
;

1234 
buf
->
f_fä“
 =

1235 (
buf
->
f_fes
 > 
dquÙ
->
dq_dqb
.
dqb_curšodes
) ?

1236 (
buf
->
f_fes
 - 
dquÙ
->
dq_dqb
.
dqb_curšodes
) : 0;

1239 
	`¥š_uÆock
(&
dquÙ
->
dq_dqb_lock
);

1240 
	`dqput
(
dquÙ
);

1242 
	}
}

1245 
	$f2fs_¡©fs
(
d’Œy
 *d’Œy, 
k¡©fs
 *
buf
)

1247 
su³r_block
 *
sb
 = 
d’Œy
->
d_sb
;

1248 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1249 
u64
 
id
 = 
	`huge_’code_dev
(
sb
->
s_bdev
->
bd_dev
);

1250 
block_t
 
tÙ®_couÁ
, 
u£r_block_couÁ
, 
¡¬t_couÁ
;

1251 
u64
 
ava_node_couÁ
;

1253 
tÙ®_couÁ
 = 
	`Ë64_to_ıu
(
sbi
->
¿w_su³r
->
block_couÁ
);

1254 
u£r_block_couÁ
 = 
sbi
->user_block_count;

1255 
¡¬t_couÁ
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
£gm’t0_blkaddr
);

1256 
buf
->
f_ty³
 = 
F2FS_SUPER_MAGIC
;

1257 
buf
->
f_bsize
 = 
sbi
->
blocksize
;

1259 
buf
->
f_blocks
 = 
tÙ®_couÁ
 - 
¡¬t_couÁ
;

1260 
buf
->
f_bä“
 = 
u£r_block_couÁ
 - 
	`v®id_u£r_blocks
(
sbi
) -

1261 
sbi
->
cu¼’t_»£rved_blocks
;

1263 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1264 ià(
	`uÆik–y
(
buf
->
f_bä“
 <ğ
sbi
->
unu§bË_block_couÁ
))

1265 
buf
->
f_bä“
 = 0;

1267 
buf
->
f_bä“
 -ğ
sbi
->
unu§bË_block_couÁ
;

1268 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1270 ià(
buf
->
f_bä“
 > 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
)

1271 
buf
->
f_bava
 = buf->
f_bä“
 -

1272 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
;

1274 
buf
->
f_bava
 = 0;

1276 
ava_node_couÁ
 = 
sbi
->
tÙ®_node_couÁ
 - 
F2FS_RESERVED_NODE_NUM
;

1278 ià(
ava_node_couÁ
 > 
u£r_block_couÁ
) {

1279 
buf
->
f_fes
 = 
u£r_block_couÁ
;

1280 
buf
->
f_fä“
 = buf->
f_bava
;

1282 
buf
->
f_fes
 = 
ava_node_couÁ
;

1283 
buf
->
f_fä“
 = 
	`mš
(
ava_node_couÁ
 - 
	`v®id_node_couÁ
(
sbi
),

1284 
buf
->
f_bava
);

1287 
buf
->
f_Çm–’
 = 
F2FS_NAME_LEN
;

1288 
buf
->
f_fsid
.
v®
[0] = (
u32
)
id
;

1289 
buf
->
f_fsid
.
v®
[1] = (
u32
)(
id
 >> 32);

1291 #ifdeà
CONFIG_QUOTA


1292 ià(
	`is_šode_æag_£t
(
d’Œy
->
d_šode
, 
FI_PROJ_INHERIT
) &&

1293 
	`sb_has_quÙa_lim™s_’abËd
(
sb
, 
PRJQUOTA
)) {

1294 
	`f2fs_¡©fs_´ojeù
(
sb
, 
	`F2FS_I
(
d’Œy
->
d_šode
)->
i_´ojid
, 
buf
);

1298 
	}
}

1300 
šlše
 
	$f2fs_show_quÙa_İtiÚs
(
£q_fe
 *
£q
,

1301 
su³r_block
 *
sb
)

1303 #ifdeà
CONFIG_QUOTA


1304 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1306 ià(
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
) {

1307 *
fmŠame
 = "";

1309 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
) {

1310 
QFMT_VFS_OLD
:

1311 
fmŠame
 = "vfsold";

1313 
QFMT_VFS_V0
:

1314 
fmŠame
 = "vfsv0";

1316 
QFMT_VFS_V1
:

1317 
fmŠame
 = "vfsv1";

1320 
	`£q_´štf
(
£q
, ",jqfmt=%s", 
fmŠame
);

1323 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
USRQUOTA
])

1324 
	`£q_show_İtiÚ
(
£q
, "usrjquota",

1325 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
USRQUOTA
]);

1327 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
GRPQUOTA
])

1328 
	`£q_show_İtiÚ
(
£q
, "grpjquota",

1329 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
GRPQUOTA
]);

1331 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
PRJQUOTA
])

1332 
	`£q_show_İtiÚ
(
£q
, "prjjquota",

1333 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
PRJQUOTA
]);

1335 
	}
}

1337 
	$f2fs_show_İtiÚs
(
£q_fe
 *
£q
, 
d’Œy
 *
roÙ
)

1339 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
roÙ
->
d_sb
);

1341 ià(!
	`f2fs_»adÚly
(
sbi
->
sb
è&& 
	`‹¡_İt
(sbi, 
BG_GC
)) {

1342 ià(
	`‹¡_İt
(
sbi
, 
FORCE_FG_GC
))

1343 
	`£q_´štf
(
£q
, ",background_gc=%s", "sync");

1345 
	`£q_´štf
(
£q
, ",background_gc=%s", "on");

1347 
	`£q_´štf
(
£q
, ",background_gc=%s", "off");

1349 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
))

1350 
	`£q_puts
(
£q
, ",disable_roll_forward");

1351 ià(
	`‹¡_İt
(
sbi
, 
DISCARD
))

1352 
	`£q_puts
(
£q
, ",discard");

1354 
	`£q_puts
(
£q
, ",nodiscard");

1355 ià(
	`‹¡_İt
(
sbi
, 
NOHEAP
))

1356 
	`£q_puts
(
£q
, ",no_heap");

1358 
	`£q_puts
(
£q
, ",heap");

1359 #ifdeà
CONFIG_F2FS_FS_XATTR


1360 ià(
	`‹¡_İt
(
sbi
, 
XATTR_USER
))

1361 
	`£q_puts
(
£q
, ",user_xattr");

1363 
	`£q_puts
(
£q
, ",nouser_xattr");

1364 ià(
	`‹¡_İt
(
sbi
, 
INLINE_XATTR
))

1365 
	`£q_puts
(
£q
, ",inline_xattr");

1367 
	`£q_puts
(
£q
, ",noinline_xattr");

1368 ià(
	`‹¡_İt
(
sbi
, 
INLINE_XATTR_SIZE
))

1369 
	`£q_´štf
(
£q
, ",inline_xattr_size=%u",

1370 
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
);

1372 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


1373 ià(
	`‹¡_İt
(
sbi
, 
POSIX_ACL
))

1374 
	`£q_puts
(
£q
, ",acl");

1376 
	`£q_puts
(
£q
, ",noacl");

1378 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_EXT_IDENTIFY
))

1379 
	`£q_puts
(
£q
, ",disable_ext_identify");

1380 ià(
	`‹¡_İt
(
sbi
, 
INLINE_DATA
))

1381 
	`£q_puts
(
£q
, ",inline_data");

1383 
	`£q_puts
(
£q
, ",noinline_data");

1384 ià(
	`‹¡_İt
(
sbi
, 
INLINE_DENTRY
))

1385 
	`£q_puts
(
£q
, ",inline_dentry");

1387 
	`£q_puts
(
£q
, ",noinline_dentry");

1388 ià(!
	`f2fs_»adÚly
(
sbi
->
sb
è&& 
	`‹¡_İt
(sbi, 
FLUSH_MERGE
))

1389 
	`£q_puts
(
£q
, ",flush_merge");

1390 ià(
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

1391 
	`£q_puts
(
£q
, ",nobarrier");

1392 ià(
	`‹¡_İt
(
sbi
, 
FASTBOOT
))

1393 
	`£q_puts
(
£q
, ",fastboot");

1394 ià(
	`‹¡_İt
(
sbi
, 
EXTENT_CACHE
))

1395 
	`£q_puts
(
£q
, ",extent_cache");

1397 
	`£q_puts
(
£q
, ",noextent_cache");

1398 ià(
	`‹¡_İt
(
sbi
, 
DATA_FLUSH
))

1399 
	`£q_puts
(
£q
, ",data_flush");

1401 
	`£q_puts
(
£q
, ",mode=");

1402 ià(
	`‹¡_İt
(
sbi
, 
ADAPTIVE
))

1403 
	`£q_puts
(
£q
, "adaptive");

1404 ià(
	`‹¡_İt
(
sbi
, 
LFS
))

1405 
	`£q_puts
(
£q
, "lfs");

1406 
	`£q_´štf
(
£q
, ",aùive_logs=%u", 
	`F2FS_OPTION
(
sbi
).
aùive_logs
);

1407 ià(
	`‹¡_İt
(
sbi
, 
RESERVE_ROOT
))

1408 
	`£q_´štf
(
£q
, ",reserve_root=%u,resuid=%u,resgid=%u",

1409 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
,

1410 
	`äom_kuid_munged
(&
š™_u£r_ns
,

1411 
	`F2FS_OPTION
(
sbi
).
s_»suid
),

1412 
	`äom_kgid_munged
(&
š™_u£r_ns
,

1413 
	`F2FS_OPTION
(
sbi
).
s_»sgid
));

1414 ià(
	`F2FS_IO_SIZE_BITS
(
sbi
))

1415 
	`£q_´štf
(
£q
, ",io_bits=%u",

1416 
	`F2FS_OPTION
(
sbi
).
wr™e_io_size_b™s
);

1417 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


1418 ià(
	`‹¡_İt
(
sbi
, 
FAULT_INJECTION
)) {

1419 
	`£q_´štf
(
£q
, ",fault_injection=%u",

1420 
	`F2FS_OPTION
(
sbi
).
çuÉ_šfo
.
šjeù_¿‹
);

1421 
	`£q_´štf
(
£q
, ",fault_type=%u",

1422 
	`F2FS_OPTION
(
sbi
).
çuÉ_šfo
.
šjeù_ty³
);

1425 #ifdeà
CONFIG_QUOTA


1426 ià(
	`‹¡_İt
(
sbi
, 
QUOTA
))

1427 
	`£q_puts
(
£q
, ",quota");

1428 ià(
	`‹¡_İt
(
sbi
, 
USRQUOTA
))

1429 
	`£q_puts
(
£q
, ",usrquota");

1430 ià(
	`‹¡_İt
(
sbi
, 
GRPQUOTA
))

1431 
	`£q_puts
(
£q
, ",grpquota");

1432 ià(
	`‹¡_İt
(
sbi
, 
PRJQUOTA
))

1433 
	`£q_puts
(
£q
, ",prjquota");

1435 
	`f2fs_show_quÙa_İtiÚs
(
£q
, 
sbi
->
sb
);

1436 ià(
	`F2FS_OPTION
(
sbi
).
whšt_mode
 =ğ
WHINT_MODE_USER
)

1437 
	`£q_´štf
(
£q
, ",whint_mode=%s", "user-based");

1438 ià(
	`F2FS_OPTION
(
sbi
).
whšt_mode
 =ğ
WHINT_MODE_FS
)

1439 
	`£q_´štf
(
£q
, ",whint_mode=%s", "fs-based");

1440 #ifdeà
CONFIG_FS_ENCRYPTION


1441 ià(
	`F2FS_OPTION
(
sbi
).
‹¡_dummy_’üy±iÚ
)

1442 
	`£q_puts
(
£q
, ",test_dummy_encryption");

1445 ià(
	`F2FS_OPTION
(
sbi
).
®loc_mode
 =ğ
ALLOC_MODE_DEFAULT
)

1446 
	`£q_´štf
(
£q
, ",alloc_mode=%s", "default");

1447 ià(
	`F2FS_OPTION
(
sbi
).
®loc_mode
 =ğ
ALLOC_MODE_REUSE
)

1448 
	`£q_´štf
(
£q
, ",alloc_mode=%s", "reuse");

1450 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_CHECKPOINT
))

1451 
	`£q_´štf
(
£q
, ",checkpoint=disable:%u",

1452 
	`F2FS_OPTION
(
sbi
).
unu§bË_ÿp
);

1453 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_POSIX
)

1454 
	`£q_´štf
(
£q
, ",fsync_mode=%s", "posix");

1455 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_STRICT
)

1456 
	`£q_´štf
(
£q
, ",fsync_mode=%s", "strict");

1457 ià(
	`F2FS_OPTION
(
sbi
).
fsync_mode
 =ğ
FSYNC_MODE_NOBARRIER
)

1458 
	`£q_´štf
(
£q
, ",fsync_mode=%s", "nobarrier");

1460 
	}
}

1462 
	$deçuÉ_İtiÚs
(
f2fs_sb_šfo
 *
sbi
)

1465 
	`F2FS_OPTION
(
sbi
).
aùive_logs
 = 
NR_CURSEG_TYPE
;

1466 
	`F2FS_OPTION
(
sbi
).
šlše_x©Œ_size
 = 
DEFAULT_INLINE_XATTR_ADDRS
;

1467 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 = 
WHINT_MODE_OFF
;

1468 
	`F2FS_OPTION
(
sbi
).
®loc_mode
 = 
ALLOC_MODE_DEFAULT
;

1469 
	`F2FS_OPTION
(
sbi
).
fsync_mode
 = 
FSYNC_MODE_POSIX
;

1470 
	`F2FS_OPTION
(
sbi
).
‹¡_dummy_’üy±iÚ
 = 
çl£
;

1471 
	`F2FS_OPTION
(
sbi
).
s_»suid
 = 
	`make_kuid
(&
š™_u£r_ns
, 
F2FS_DEF_RESUID
);

1472 
	`F2FS_OPTION
(
sbi
).
s_»sgid
 = 
	`make_kgid
(&
š™_u£r_ns
, 
F2FS_DEF_RESGID
);

1474 
	`£t_İt
(
sbi
, 
BG_GC
);

1475 
	`£t_İt
(
sbi
, 
INLINE_XATTR
);

1476 
	`£t_İt
(
sbi
, 
INLINE_DATA
);

1477 
	`£t_İt
(
sbi
, 
INLINE_DENTRY
);

1478 
	`£t_İt
(
sbi
, 
EXTENT_CACHE
);

1479 
	`£t_İt
(
sbi
, 
NOHEAP
);

1480 
	`ş—r_İt
(
sbi
, 
DISABLE_CHECKPOINT
);

1481 
	`F2FS_OPTION
(
sbi
).
unu§bË_ÿp
 = 0;

1482 
sbi
->
sb
->
s_æags
 |ğ
SB_LAZYTIME
;

1483 
	`£t_İt
(
sbi
, 
FLUSH_MERGE
);

1484 
	`£t_İt
(
sbi
, 
DISCARD
);

1485 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
))

1486 
	`£t_İt_mode
(
sbi
, 
F2FS_MOUNT_LFS
);

1488 
	`£t_İt_mode
(
sbi
, 
F2FS_MOUNT_ADAPTIVE
);

1490 #ifdeà
CONFIG_F2FS_FS_XATTR


1491 
	`£t_İt
(
sbi
, 
XATTR_USER
);

1493 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


1494 
	`£t_İt
(
sbi
, 
POSIX_ACL
);

1497 
	`f2fs_bud_çuÉ_©Œ
(
sbi
, 0, 0);

1498 
	}
}

1500 #ifdeà
CONFIG_QUOTA


1501 
f2fs_’abË_quÙas
(
su³r_block
 *
sb
);

1504 
	$f2fs_di§bË_checkpošt
(
f2fs_sb_šfo
 *
sbi
)

1506 
s_æags
 = 
sbi
->
sb
->s_flags;

1507 
ı_cÚŒŞ
 
ıc
;

1508 
”r
 = 0;

1509 
»t
;

1510 
block_t
 
unu§bË
;

1512 ià(
s_æags
 & 
SB_RDONLY
) {

1513 
	`f2fs_”r
(
sbi
, "checkpoint=disable on„eadonly fs");

1514  -
EINVAL
;

1516 
sbi
->
sb
->
s_æags
 |ğ
SB_ACTIVE
;

1518 
	`f2fs_upd©e_time
(
sbi
, 
DISABLE_TIME
);

1520 !
	`f2fs_time_ov”
(
sbi
, 
DISABLE_TIME
)) {

1521 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

1522 
”r
 = 
	`f2fs_gc
(
sbi
, 
Œue
, 
çl£
, 
NULL_SEGNO
);

1523 ià(
”r
 =ğ-
ENODATA
) {

1524 
”r
 = 0;

1527 ià(
”r
 &&ƒ¼ !ğ-
EAGAIN
)

1531 
»t
 = 
	`sync_fesy¡em
(
sbi
->
sb
);

1532 ià(
»t
 || 
”r
) {

1533 
”r
 = 
»t
 ?„et:ƒrr;

1534 
»¡Üe_æag
;

1537 
unu§bË
 = 
	`f2fs_g‘_unu§bË_blocks
(
sbi
);

1538 ià(
	`f2fs_di§bË_ı_agaš
(
sbi
, 
unu§bË
)) {

1539 
”r
 = -
EAGAIN
;

1540 
»¡Üe_æag
;

1543 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

1544 
ıc
.
»asÚ
 = 
CP_PAUSE
;

1545 
	`£t_sbi_æag
(
sbi
, 
SBI_CP_DISABLED
);

1546 
”r
 = 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

1547 ià(
”r
)

1548 
out_uÆock
;

1550 
	`¥š_lock
(&
sbi
->
¡©_lock
);

1551 
sbi
->
unu§bË_block_couÁ
 = 
unu§bË
;

1552 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

1554 
out_uÆock
:

1555 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

1556 
»¡Üe_æag
:

1557 
sbi
->
sb
->
s_æags
 = s_flags;

1558  
”r
;

1559 
	}
}

1561 
	$f2fs_’abË_checkpošt
(
f2fs_sb_šfo
 *
sbi
)

1563 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

1564 
	`f2fs_dœty_to_´eä“
(
sbi
);

1566 
	`ş—r_sbi_æag
(
sbi
, 
SBI_CP_DISABLED
);

1567 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

1568 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

1570 
	`f2fs_sync_fs
(
sbi
->
sb
, 1);

1571 
	}
}

1573 
	$f2fs_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
)

1575 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1576 
f2fs_mouÁ_šfo
 
Üg_mouÁ_İt
;

1577 
Şd_sb_æags
;

1578 
”r
;

1579 
boŞ
 
Ãed_»¡¬t_gc
 = 
çl£
;

1580 
boŞ
 
Ãed_¡İ_gc
 = 
çl£
;

1581 
boŞ
 
no_ex‹Á_ÿche
 = !
	`‹¡_İt
(
sbi
, 
EXTENT_CACHE
);

1582 
boŞ
 
di§bË_checkpošt
 = 
	`‹¡_İt
(
sbi
, 
DISABLE_CHECKPOINT
);

1583 
boŞ
 
no_io_®ign
 = !
	`F2FS_IO_ALIGNED
(
sbi
);

1584 
boŞ
 
checkpošt_chªged
;

1585 #ifdeà
CONFIG_QUOTA


1586 
i
, 
j
;

1593 
Üg_mouÁ_İt
 = 
sbi
->
mouÁ_İt
;

1594 
Şd_sb_æags
 = 
sb
->
s_æags
;

1596 #ifdeà
CONFIG_QUOTA


1597 
Üg_mouÁ_İt
.
s_jquÙa_fmt
 = 
	`F2FS_OPTION
(
sbi
).s_jquota_fmt;

1598 
i
 = 0; i < 
MAXQUOTAS
; i++) {

1599 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
]) {

1600 
Üg_mouÁ_İt
.
s_qf_Çmes
[
i
] =

1601 
	`k¡rdup
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
],

1602 
GFP_KERNEL
);

1603 ià(!
Üg_mouÁ_İt
.
s_qf_Çmes
[
i
]) {

1604 
j
 = 0; j < 
i
; j++)

1605 
	`kvä“
(
Üg_mouÁ_İt
.
s_qf_Çmes
[
j
]);

1606  -
ENOMEM
;

1609 
Üg_mouÁ_İt
.
s_qf_Çmes
[
i
] = 
NULL
;

1615 ià(!(*
æags
 & 
SB_RDONLY
è&& 
	`is_sbi_æag_£t
(
sbi
, 
SBI_NEED_SB_WRITE
)) {

1616 
”r
 = 
	`f2fs_comm™_su³r
(
sbi
, 
çl£
);

1617 
	`f2fs_šfo
(
sbi
, "Tryo„ecover‡llhe superblocks,„et: %d",

1618 
”r
);

1619 ià(!
”r
)

1620 
	`ş—r_sbi_æag
(
sbi
, 
SBI_NEED_SB_WRITE
);

1623 
	`deçuÉ_İtiÚs
(
sbi
);

1626 
”r
 = 
	`·r£_İtiÚs
(
sb
, 
d©a
);

1627 ià(
”r
)

1628 
»¡Üe_İts
;

1629 
checkpošt_chªged
 =

1630 
di§bË_checkpošt
 !ğ
	`‹¡_İt
(
sbi
, 
DISABLE_CHECKPOINT
);

1636 ià(
	`f2fs_»adÚly
(
sb
è&& (*
æags
 & 
SB_RDONLY
))

1637 
sk
;

1639 #ifdeà
CONFIG_QUOTA


1640 ià(!
	`f2fs_»adÚly
(
sb
è&& (*
æags
 & 
SB_RDONLY
)) {

1641 
”r
 = 
	`dquÙ_su¥’d
(
sb
, -1);

1642 ià(
”r
 < 0)

1643 
»¡Üe_İts
;

1644 } ià(
	`f2fs_»adÚly
(
sb
è&& !(*
æags
 & 
SB_RDONLY
)) {

1646 
sb
->
s_æags
 &ğ~
SB_RDONLY
;

1647 ià(
	`sb_ªy_quÙa_su¥’ded
(
sb
)) {

1648 
	`dquÙ_»sume
(
sb
, -1);

1649 } ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
)) {

1650 
”r
 = 
	`f2fs_’abË_quÙas
(
sb
);

1651 ià(
”r
)

1652 
»¡Üe_İts
;

1657 ià(
no_ex‹Á_ÿche
 =ğ!!
	`‹¡_İt
(
sbi
, 
EXTENT_CACHE
)) {

1658 
”r
 = -
EINVAL
;

1659 
	`f2fs_w¬n
(
sbi
, "switchƒxtent_cache option is‚ot‡llowed");

1660 
»¡Üe_İts
;

1663 ià(
no_io_®ign
 =ğ!!
	`F2FS_IO_ALIGNED
(
sbi
)) {

1664 
”r
 = -
EINVAL
;

1665 
	`f2fs_w¬n
(
sbi
, "switch io_bits option is‚ot‡llowed");

1666 
»¡Üe_İts
;

1669 ià((*
æags
 & 
SB_RDONLY
è&& 
	`‹¡_İt
(
sbi
, 
DISABLE_CHECKPOINT
)) {

1670 
”r
 = -
EINVAL
;

1671 
	`f2fs_w¬n
(
sbi
, "disabling checkpoint‚ot compatible with„ead-only");

1672 
»¡Üe_İts
;

1680 ià((*
æags
 & 
SB_RDONLY
è|| !
	`‹¡_İt
(
sbi
, 
BG_GC
)) {

1681 ià(
sbi
->
gc_th»ad
) {

1682 
	`f2fs_¡İ_gc_th»ad
(
sbi
);

1683 
Ãed_»¡¬t_gc
 = 
Œue
;

1685 } ià(!
sbi
->
gc_th»ad
) {

1686 
”r
 = 
	`f2fs_¡¬t_gc_th»ad
(
sbi
);

1687 ià(
”r
)

1688 
»¡Üe_İts
;

1689 
Ãed_¡İ_gc
 = 
Œue
;

1692 ià(*
æags
 & 
SB_RDONLY
 ||

1693 
	`F2FS_OPTION
(
sbi
).
whšt_mode
 !ğ
Üg_mouÁ_İt
.whint_mode) {

1694 
	`wr™eback_šodes_sb
(
sb
, 
WB_REASON_SYNC
);

1695 
	`sync_šodes_sb
(
sb
);

1697 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_DIRTY
);

1698 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_CLOSE
);

1699 
	`f2fs_sync_fs
(
sb
, 1);

1700 
	`ş—r_sbi_æag
(
sbi
, 
SBI_IS_CLOSE
);

1703 ià(
checkpošt_chªged
) {

1704 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_CHECKPOINT
)) {

1705 
”r
 = 
	`f2fs_di§bË_checkpošt
(
sbi
);

1706 ià(
”r
)

1707 
»¡Üe_gc
;

1709 
	`f2fs_’abË_checkpošt
(
sbi
);

1717 ià((*
æags
 & 
SB_RDONLY
è|| !
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
)) {

1718 
	`ş—r_İt
(
sbi
, 
FLUSH_MERGE
);

1719 
	`f2fs_de¡roy_æush_cmd_cÚŒŞ
(
sbi
, 
çl£
);

1721 
”r
 = 
	`f2fs_ü—‹_æush_cmd_cÚŒŞ
(
sbi
);

1722 ià(
”r
)

1723 
»¡Üe_gc
;

1725 
sk
:

1726 #ifdeà
CONFIG_QUOTA


1728 
i
 = 0; i < 
MAXQUOTAS
; i++)

1729 
	`kvä“
(
Üg_mouÁ_İt
.
s_qf_Çmes
[
i
]);

1732 
sb
->
s_æags
 = (sb->s_æag & ~
SB_POSIXACL
) |

1733 (
	`‹¡_İt
(
sbi
, 
POSIX_ACL
è? 
SB_POSIXACL
 : 0);

1735 
	`lim™_»£rve_roÙ
(
sbi
);

1736 *
æags
 = (*æag & ~
SB_LAZYTIME
è| (
sb
->
s_æags
 & SB_LAZYTIME);

1738 
»¡Üe_gc
:

1739 ià(
Ãed_»¡¬t_gc
) {

1740 ià(
	`f2fs_¡¬t_gc_th»ad
(
sbi
))

1741 
	`f2fs_w¬n
(
sbi
, "background gchread has stopped");

1742 } ià(
Ãed_¡İ_gc
) {

1743 
	`f2fs_¡İ_gc_th»ad
(
sbi
);

1745 
»¡Üe_İts
:

1746 #ifdeà
CONFIG_QUOTA


1747 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
 = 
Üg_mouÁ_İt
.s_jquota_fmt;

1748 
i
 = 0; i < 
MAXQUOTAS
; i++) {

1749 
	`kvä“
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
]);

1750 
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
] = 
Üg_mouÁ_İt
.s_qf_names[i];

1753 
sbi
->
mouÁ_İt
 = 
Üg_mouÁ_İt
;

1754 
sb
->
s_æags
 = 
Şd_sb_æags
;

1755  
”r
;

1756 
	}
}

1758 #ifdeà
CONFIG_QUOTA


1760 
ssize_t
 
	$f2fs_quÙa_»ad
(
su³r_block
 *
sb
, 
ty³
, *
d©a
,

1761 
size_t
 
Ën
, 
loff_t
 
off
)

1763 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

1764 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

1765 
block_t
 
blkidx
 = 
	`F2FS_BYTES_TO_BLK
(
off
);

1766 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

1767 
tocİy
;

1768 
size_t
 
tÜ—d
;

1769 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

1770 
·ge
 *page;

1771 *
kaddr
;

1773 ià(
off
 > 
i_size
)

1776 ià(
off
 + 
Ën
 > 
i_size
)

1777 
Ën
 = 
i_size
 - 
off
;

1778 
tÜ—d
 = 
Ën
;

1779 
tÜ—d
 > 0) {

1780 
tocİy
 = 
	`mš_t
(, 
sb
->
s_blocksize
 - 
off£t
, 
tÜ—d
);

1781 
»³©
:

1782 
·ge
 = 
	`»ad_ÿche_·ge_gå
(
m­pšg
, 
blkidx
, 
GFP_NOFS
);

1783 ià(
	`IS_ERR
(
·ge
)) {

1784 ià(
	`PTR_ERR
(
·ge
è=ğ-
ENOMEM
) {

1785 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

1786 
»³©
;

1788 
	`£t_sbi_æag
(
	`F2FS_SB
(
sb
), 
SBI_QUOTA_NEED_REPAIR
);

1789  
	`PTR_ERR
(
·ge
);

1792 
	`lock_·ge
(
·ge
);

1794 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

1795 
	`f2fs_put_·ge
(
·ge
, 1);

1796 
»³©
;

1798 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

1799 
	`f2fs_put_·ge
(
·ge
, 1);

1800 
	`£t_sbi_æag
(
	`F2FS_SB
(
sb
), 
SBI_QUOTA_NEED_REPAIR
);

1801  -
EIO
;

1804 
kaddr
 = 
	`km­_©omic
(
·ge
);

1805 
	`memıy
(
d©a
, 
kaddr
 + 
off£t
, 
tocİy
);

1806 
	`kunm­_©omic
(
kaddr
);

1807 
	`f2fs_put_·ge
(
·ge
, 1);

1809 
off£t
 = 0;

1810 
tÜ—d
 -ğ
tocİy
;

1811 
d©a
 +ğ
tocİy
;

1812 
blkidx
++;

1814  
Ën
;

1815 
	}
}

1818 
ssize_t
 
	$f2fs_quÙa_wr™e
(
su³r_block
 *
sb
, 
ty³
,

1819 cÚ¡ *
d©a
, 
size_t
 
Ën
, 
loff_t
 
off
)

1821 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

1822 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

1823 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 *
a_İs
 = 
m­pšg
->a_ops;

1824 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

1825 
size_t
 
towr™e
 = 
Ën
;

1826 
·ge
 *page;

1827 *
kaddr
;

1828 
”r
 = 0;

1829 
tocİy
;

1831 
towr™e
 > 0) {

1832 
tocİy
 = 
	`mš_t
(, 
sb
->
s_blocksize
 - 
off£t
,

1833 
towr™e
);

1834 
»Œy
:

1835 
”r
 = 
a_İs
->
	`wr™e_begš
(
NULL
, 
m­pšg
, 
off
, 
tocİy
, 0,

1836 &
·ge
, 
NULL
);

1837 ià(
	`uÆik–y
(
”r
)) {

1838 ià(
”r
 =ğ-
ENOMEM
) {

1839 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

1840 
»Œy
;

1842 
	`£t_sbi_æag
(
	`F2FS_SB
(
sb
), 
SBI_QUOTA_NEED_REPAIR
);

1846 
kaddr
 = 
	`km­_©omic
(
·ge
);

1847 
	`memıy
(
kaddr
 + 
off£t
, 
d©a
, 
tocİy
);

1848 
	`kunm­_©omic
(
kaddr
);

1849 
	`æush_dÿche_·ge
(
·ge
);

1851 
a_İs
->
	`wr™e_’d
(
NULL
, 
m­pšg
, 
off
, 
tocİy
,ocopy,

1852 
·ge
, 
NULL
);

1853 
off£t
 = 0;

1854 
towr™e
 -ğ
tocİy
;

1855 
off
 +ğ
tocİy
;

1856 
d©a
 +ğ
tocİy
;

1857 
	`cÚd_»sched
();

1860 ià(
Ën
 =ğ
towr™e
)

1861  
”r
;

1862 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

1863 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

1864  
Ën
 - 
towr™e
;

1865 
	}
}

1867 
dquÙ
 **
	$f2fs_g‘_dquÙs
(
šode
 *inode)

1869  
	`F2FS_I
(
šode
)->
i_dquÙ
;

1870 
	}
}

1872 
qsize_t
 *
	$f2fs_g‘_»£rved_¥aû
(
šode
 *inode)

1874  &
	`F2FS_I
(
šode
)->
i_»£rved_quÙa
;

1875 
	}
}

1877 
	$f2fs_quÙa_Ú_mouÁ
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1879 ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_QUOTA_NEED_FSCK_FLAG
)) {

1880 
	`f2fs_”r
(
sbi
, "quota sysfile may be corrupted, skip†oading it");

1884  
	`dquÙ_quÙa_Ú_mouÁ
(
sbi
->
sb
, 
	`F2FS_OPTION
(sbi).
s_qf_Çmes
[
ty³
],

1885 
	`F2FS_OPTION
(
sbi
).
s_jquÙa_fmt
, 
ty³
);

1886 
	}
}

1888 
	$f2fs_’abË_quÙa_fes
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
rdÚly
)

1890 
’abËd
 = 0;

1891 
i
, 
”r
;

1893 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
è&& 
rdÚly
) {

1894 
”r
 = 
	`f2fs_’abË_quÙas
(
sbi
->
sb
);

1895 ià(
”r
) {

1896 
	`f2fs_”r
(
sbi
, "CªnÙuº oÀquÙa_šo: %d", 
”r
);

1902 
i
 = 0; i < 
MAXQUOTAS
; i++) {

1903 ià(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
]) {

1904 
”r
 = 
	`f2fs_quÙa_Ú_mouÁ
(
sbi
, 
i
);

1905 ià(!
”r
) {

1906 
’abËd
 = 1;

1909 
	`f2fs_”r
(
sbi
, "Cannoturn on quotas: %d on %d",

1910 
”r
, 
i
);

1913  
’abËd
;

1914 
	}
}

1916 
	$f2fs_quÙa_’abË
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

1917 
æags
)

1919 
šode
 *
qf_šode
;

1920 
qf_šum
;

1921 
”r
;

1923 
	`BUG_ON
(!
	`f2fs_sb_has_quÙa_šo
(
	`F2FS_SB
(
sb
)));

1925 
qf_šum
 = 
	`f2fs_qf_šo
(
sb
, 
ty³
);

1926 ià(!
qf_šum
)

1927  -
EPERM
;

1929 
qf_šode
 = 
	`f2fs_ig‘
(
sb
, 
qf_šum
);

1930 ià(
	`IS_ERR
(
qf_šode
)) {

1931 
	`f2fs_”r
(
	`F2FS_SB
(
sb
), "Bad quÙ¨šod%u:%lu", 
ty³
, 
qf_šum
);

1932  
	`PTR_ERR
(
qf_šode
);

1936 
qf_šode
->
i_æags
 |ğ
S_NOQUOTA
;

1937 
”r
 = 
	`dquÙ_’abË
(
qf_šode
, 
ty³
, 
fÜm©_id
, 
æags
);

1938 
	`ut
(
qf_šode
);

1939  
”r
;

1940 
	}
}

1942 
	$f2fs_’abË_quÙas
(
su³r_block
 *
sb
)

1944 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1945 
ty³
, 
”r
 = 0;

1946 
qf_šum
;

1947 
boŞ
 
quÙa_mİt
[
MAXQUOTAS
] = {

1948 
	`‹¡_İt
(
sbi
, 
USRQUOTA
),

1949 
	`‹¡_İt
(
sbi
, 
GRPQUOTA
),

1950 
	`‹¡_İt
(
sbi
, 
PRJQUOTA
),

1953 ià(
	`is_£t_ck±_æags
(
	`F2FS_SB
(
sb
), 
CP_QUOTA_NEED_FSCK_FLAG
)) {

1954 
	`f2fs_”r
(
sbi
, "quota file may be corrupted, skip†oading it");

1958 
	`sb_dqİt
(
sb
)->
æags
 |ğ
DQUOT_QUOTA_SYS_FILE
;

1960 
ty³
 = 0;y³ < 
MAXQUOTAS
;ype++) {

1961 
qf_šum
 = 
	`f2fs_qf_šo
(
sb
, 
ty³
);

1962 ià(
qf_šum
) {

1963 
”r
 = 
	`f2fs_quÙa_’abË
(
sb
, 
ty³
, 
QFMT_VFS_V1
,

1964 
DQUOT_USAGE_ENABLED
 |

1965 (
quÙa_mİt
[
ty³
] ? 
DQUOT_LIMITS_ENABLED
 : 0));

1966 ià(
”r
) {

1967 
	`f2fs_”r
(
sbi
, "Failedoƒnable quotaracking (type=%d,ƒrr=%d). Please„un fscko fix.",

1968 
ty³
, 
”r
);

1969 
ty³
--;ype >= 0;ype--)

1970 
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

1971 
	`£t_sbi_æag
(
	`F2FS_SB
(
sb
),

1972 
SBI_QUOTA_NEED_REPAIR
);

1973  
”r
;

1978 
	}
}

1980 
	$f2fs_quÙa_sync
(
su³r_block
 *
sb
, 
ty³
)

1982 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

1983 
quÙa_šfo
 *
dqİt
 = 
	`sb_dqİt
(
sb
);

1984 
út
;

1985 
»t
;

1996 
	`f2fs_lock_İ
(
sbi
);

1998 
	`down_»ad
(&
sbi
->
quÙa_£m
);

1999 
»t
 = 
	`dquÙ_wr™eback_dquÙs
(
sb
, 
ty³
);

2000 ià(
»t
)

2001 
out
;

2007 
út
 = 0; cÁ < 
MAXQUOTAS
; cnt++) {

2008 
add»ss_¥aû
 *
m­pšg
;

2010 ià(
ty³
 !ğ-1 && 
út
 !=ype)

2012 ià(!
	`sb_has_quÙa_aùive
(
sb
, 
út
))

2015 
m­pšg
 = 
dqİt
->
fes
[
út
]->
i_m­pšg
;

2017 
»t
 = 
	`fem­_fd©awr™e
(
m­pšg
);

2018 ià(
»t
)

2019 
out
;

2022 ià(
	`is_jouº®Ëd_quÙa
(
sbi
))

2025 
»t
 = 
	`fem­_fd©awa™
(
m­pšg
);

2026 ià(
»t
)

2027 
	`£t_sbi_æag
(
	`F2FS_SB
(
sb
), 
SBI_QUOTA_NEED_REPAIR
);

2029 
	`šode_lock
(
dqİt
->
fes
[
út
]);

2030 
	`Œunÿ‹_šode_·ges
(&
dqİt
->
fes
[
út
]->
i_d©a
, 0);

2031 
	`šode_uÆock
(
dqİt
->
fes
[
út
]);

2033 
out
:

2034 ià(
»t
)

2035 
	`£t_sbi_æag
(
	`F2FS_SB
(
sb
), 
SBI_QUOTA_NEED_REPAIR
);

2036 
	`up_»ad
(&
sbi
->
quÙa_£m
);

2037 
	`f2fs_uÆock_İ
(
sbi
);

2038  
»t
;

2039 
	}
}

2041 
	$f2fs_quÙa_Ú
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

2042 cÚ¡ 
·th
 *path)

2044 
šode
 *inode;

2045 
”r
;

2048 ià(
	`f2fs_sb_has_quÙa_šo
(
	`F2FS_SB
(
sb
))) {

2049 
	`f2fs_”r
(
	`F2FS_SB
(
sb
), "quota sysfile‡lreadyƒxists");

2050  -
EBUSY
;

2053 
”r
 = 
	`f2fs_quÙa_sync
(
sb
, 
ty³
);

2054 ià(
”r
)

2055  
”r
;

2057 
”r
 = 
	`dquÙ_quÙa_Ú
(
sb
, 
ty³
, 
fÜm©_id
, 
·th
);

2058 ià(
”r
)

2059  
”r
;

2061 
šode
 = 
	`d_šode
(
·th
->
d’Œy
);

2063 
	`šode_lock
(
šode
);

2064 
	`F2FS_I
(
šode
)->
i_æags
 |ğ
F2FS_NOATIME_FL
 | 
F2FS_IMMUTABLE_FL
;

2065 
	`f2fs_£t_šode_æags
(
šode
);

2066 
	`šode_uÆock
(
šode
);

2067 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

2070 
	}
}

2072 
	$__f2fs_quÙa_off
(
su³r_block
 *
sb
, 
ty³
)

2074 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

2075 
”r
;

2077 ià(!
šode
 || !
	`ig¿b
(inode))

2078  
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

2080 
”r
 = 
	`f2fs_quÙa_sync
(
sb
, 
ty³
);

2081 ià(
”r
)

2082 
out_put
;

2084 
”r
 = 
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

2085 ià(
”r
 || 
	`f2fs_sb_has_quÙa_šo
(
	`F2FS_SB
(
sb
)))

2086 
out_put
;

2088 
	`šode_lock
(
šode
);

2089 
	`F2FS_I
(
šode
)->
i_æags
 &ğ~(
F2FS_NOATIME_FL
 | 
F2FS_IMMUTABLE_FL
);

2090 
	`f2fs_£t_šode_æags
(
šode
);

2091 
	`šode_uÆock
(
šode
);

2092 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
çl£
);

2093 
out_put
:

2094 
	`ut
(
šode
);

2095  
”r
;

2096 
	}
}

2098 
	$f2fs_quÙa_off
(
su³r_block
 *
sb
, 
ty³
)

2100 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

2101 
”r
;

2103 
”r
 = 
	`__f2fs_quÙa_off
(
sb
, 
ty³
);

2110 ià(
	`is_jouº®Ëd_quÙa
(
sbi
))

2111 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
);

2112  
”r
;

2113 
	}
}

2115 
	$f2fs_quÙa_off_umouÁ
(
su³r_block
 *
sb
)

2117 
ty³
;

2118 
”r
;

2120 
ty³
 = 0;y³ < 
MAXQUOTAS
;ype++) {

2121 
”r
 = 
	`__f2fs_quÙa_off
(
sb
, 
ty³
);

2122 ià(
”r
) {

2123 
»t
 = 
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

2125 
	`f2fs_”r
(
	`F2FS_SB
(
sb
), "Failourn off disk quota (type: %d,ƒrr: %d,„et:%d), Please„un fscko fix it.",

2126 
ty³
, 
”r
, 
»t
);

2127 
	`£t_sbi_æag
(
	`F2FS_SB
(
sb
), 
SBI_QUOTA_NEED_REPAIR
);

2135 
	`sync_fesy¡em
(
sb
);

2136 
	}
}

2138 
	$f2fs_Œunÿ‹_quÙa_šode_·ges
(
su³r_block
 *
sb
)

2140 
quÙa_šfo
 *
dqİt
 = 
	`sb_dqİt
(
sb
);

2141 
ty³
;

2143 
ty³
 = 0;y³ < 
MAXQUOTAS
;ype++) {

2144 ià(!
dqİt
->
fes
[
ty³
])

2146 
	`f2fs_šode_synûd
(
dqİt
->
fes
[
ty³
]);

2148 
	}
}

2150 
	$f2fs_dquÙ_comm™
(
dquÙ
 *dquot)

2152 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
dquÙ
->
dq_sb
);

2153 
»t
;

2155 
	`down_»ad
(&
sbi
->
quÙa_£m
);

2156 
»t
 = 
	`dquÙ_comm™
(
dquÙ
);

2157 ià(
»t
 < 0)

2158 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
);

2159 
	`up_»ad
(&
sbi
->
quÙa_£m
);

2160  
»t
;

2161 
	}
}

2163 
	$f2fs_dquÙ_acquœe
(
dquÙ
 *dquot)

2165 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
dquÙ
->
dq_sb
);

2166 
»t
;

2168 
	`down_»ad
(&
sbi
->
quÙa_£m
);

2169 
»t
 = 
	`dquÙ_acquœe
(
dquÙ
);

2170 ià(
»t
 < 0)

2171 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
);

2172 
	`up_»ad
(&
sbi
->
quÙa_£m
);

2173  
»t
;

2174 
	}
}

2176 
	$f2fs_dquÙ_»Ëa£
(
dquÙ
 *dquot)

2178 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
dquÙ
->
dq_sb
);

2179 
»t
;

2181 
	`down_»ad
(&
sbi
->
quÙa_£m
);

2182 
»t
 = 
	`dquÙ_»Ëa£
(
dquÙ
);

2183 ià(
»t
 < 0)

2184 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
);

2185 
	`up_»ad
(&
sbi
->
quÙa_£m
);

2186  
»t
;

2187 
	}
}

2189 
	$f2fs_dquÙ_m¬k_dquÙ_dœty
(
dquÙ
 *dquot)

2191 
su³r_block
 *
sb
 = 
dquÙ
->
dq_sb
;

2192 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

2193 
»t
;

2195 
	`down_»ad
(&
sbi
->
quÙa_£m
);

2196 
»t
 = 
	`dquÙ_m¬k_dquÙ_dœty
(
dquÙ
);

2199 ià(
	`is_jouº®Ëd_quÙa
(
sbi
))

2200 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_FLUSH
);

2202 
	`up_»ad
(&
sbi
->
quÙa_£m
);

2203  
»t
;

2204 
	}
}

2206 
	$f2fs_dquÙ_comm™_šfo
(
su³r_block
 *
sb
, 
ty³
)

2208 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

2209 
»t
;

2211 
	`down_»ad
(&
sbi
->
quÙa_£m
);

2212 
»t
 = 
	`dquÙ_comm™_šfo
(
sb
, 
ty³
);

2213 ià(
»t
 < 0)

2214 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
);

2215 
	`up_»ad
(&
sbi
->
quÙa_£m
);

2216  
»t
;

2217 
	}
}

2219 
	$f2fs_g‘_´ojid
(
šode
 *šode, 
k´ojid_t
 *
´ojid
)

2221 *
´ojid
 = 
	`F2FS_I
(
šode
)->
i_´ojid
;

2223 
	}
}

2225 cÚ¡ 
dquÙ_İ”©iÚs
 
	gf2fs_quÙa_İ”©iÚs
 = {

2226 .
g‘_»£rved_¥aû
 = 
f2fs_g‘_»£rved_¥aû
,

2227 .
	gwr™e_dquÙ
 = 
f2fs_dquÙ_comm™
,

2228 .
	gacquœe_dquÙ
 = 
f2fs_dquÙ_acquœe
,

2229 .
	g»Ëa£_dquÙ
 = 
f2fs_dquÙ_»Ëa£
,

2230 .
	gm¬k_dœty
 = 
f2fs_dquÙ_m¬k_dquÙ_dœty
,

2231 .
	gwr™e_šfo
 = 
f2fs_dquÙ_comm™_šfo
,

2232 .
	g®loc_dquÙ
 = 
dquÙ_®loc
,

2233 .
	gde¡roy_dquÙ
 = 
dquÙ_de¡roy
,

2234 .
	gg‘_´ojid
 = 
f2fs_g‘_´ojid
,

2235 .
	gg‘_Ãxt_id
 = 
dquÙ_g‘_Ãxt_id
,

2238 cÚ¡ 
quÙaùl_İs
 
	gf2fs_quÙaùl_İs
 = {

2239 .
quÙa_Ú
 = 
f2fs_quÙa_Ú
,

2240 .
	gquÙa_off
 = 
f2fs_quÙa_off
,

2241 .
	gquÙa_sync
 = 
f2fs_quÙa_sync
,

2242 .
	gg‘_¡©e
 = 
dquÙ_g‘_¡©e
,

2243 .
	g£t_šfo
 = 
dquÙ_£t_dqšfo
,

2244 .
	gg‘_dqblk
 = 
dquÙ_g‘_dqblk
,

2245 .
	g£t_dqblk
 = 
dquÙ_£t_dqblk
,

2246 .
	gg‘_Ãxtdqblk
 = 
dquÙ_g‘_Ãxt_dqblk
,

2249 
	$f2fs_quÙa_sync
(
su³r_block
 *
sb
, 
ty³
)

2252 
	}
}

2254 
	$f2fs_quÙa_off_umouÁ
(
su³r_block
 *
sb
)

2256 
	}
}

2259 cÚ¡ 
su³r_İ”©iÚs
 
	gf2fs_sİs
 = {

2260 .
®loc_šode
 = 
f2fs_®loc_šode
,

2261 .
	gä“_šode
 = 
f2fs_ä“_šode
,

2262 .
	gdrİ_šode
 = 
f2fs_drİ_šode
,

2263 .
	gwr™e_šode
 = 
f2fs_wr™e_šode
,

2264 .
	gdœty_šode
 = 
f2fs_dœty_šode
,

2265 .
	gshow_İtiÚs
 = 
f2fs_show_İtiÚs
,

2266 #ifdeà
CONFIG_QUOTA


2267 .
	gquÙa_»ad
 = 
f2fs_quÙa_»ad
,

2268 .
	gquÙa_wr™e
 = 
f2fs_quÙa_wr™e
,

2269 .
	gg‘_dquÙs
 = 
f2fs_g‘_dquÙs
,

2271 .
	geviù_šode
 = 
f2fs_eviù_šode
,

2272 .
	gput_su³r
 = 
f2fs_put_su³r
,

2273 .
	gsync_fs
 = 
f2fs_sync_fs
,

2274 .
	gä“ze_fs
 = 
f2fs_ä“ze
,

2275 .
	gunä“ze_fs
 = 
f2fs_unä“ze
,

2276 .
	g¡©fs
 = 
f2fs_¡©fs
,

2277 .
	g»mouÁ_fs
 = 
f2fs_»mouÁ
,

2280 #ifdeà
CONFIG_FS_ENCRYPTION


2281 
	$f2fs_g‘_cÚ‹xt
(
šode
 *šode, *
ùx
, 
size_t
 
Ën
)

2283  
	`f2fs_g‘x©Œ
(
šode
, 
F2FS_XATTR_INDEX_ENCRYPTION
,

2284 
F2FS_XATTR_NAME_ENCRYPTION_CONTEXT
,

2285 
ùx
, 
Ën
, 
NULL
);

2286 
	}
}

2288 
	$f2fs_£t_cÚ‹xt
(
šode
 *šode, cÚ¡ *
ùx
, 
size_t
 
Ën
,

2289 *
fs_d©a
)

2291 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

2299 ià(
	`f2fs_sb_has_lo¡_found
(
sbi
) &&

2300 
šode
->
i_šo
 =ğ
	`F2FS_ROOT_INO
(
sbi
))

2301  -
EPERM
;

2303  
	`f2fs_£tx©Œ
(
šode
, 
F2FS_XATTR_INDEX_ENCRYPTION
,

2304 
F2FS_XATTR_NAME_ENCRYPTION_CONTEXT
,

2305 
ùx
, 
Ën
, 
fs_d©a
, 
XATTR_CREATE
);

2306 
	}
}

2308 
boŞ
 
	$f2fs_dummy_cÚ‹xt
(
šode
 *inode)

2310  
	`DUMMY_ENCRYPTION_ENABLED
(
	`F2FS_I_SB
(
šode
));

2311 
	}
}

2313 cÚ¡ 
fsüy±_İ”©iÚs
 
	gf2fs_üy±İs
 = {

2314 .
key_´efix
 = "f2fs:",

2315 .
	gg‘_cÚ‹xt
 = 
f2fs_g‘_cÚ‹xt
,

2316 .
	g£t_cÚ‹xt
 = 
f2fs_£t_cÚ‹xt
,

2317 .
	gdummy_cÚ‹xt
 = 
f2fs_dummy_cÚ‹xt
,

2318 .
	gem±y_dœ
 = 
f2fs_em±y_dœ
,

2319 .
	gmax_Çm–’
 = 
F2FS_NAME_LEN
,

2323 
šode
 *
	$f2fs_nfs_g‘_šode
(
su³r_block
 *
sb
,

2324 
u64
 
šo
, 
u32
 
g’”©iÚ
)

2326 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

2327 
šode
 *inode;

2329 ià(
	`f2fs_check_nid_¿nge
(
sbi
, 
šo
))

2330  
	`ERR_PTR
(-
ESTALE
);

2337 
šode
 = 
	`f2fs_ig‘
(
sb
, 
šo
);

2338 ià(
	`IS_ERR
(
šode
))

2339  
	`ERR_CAST
(
šode
);

2340 ià(
	`uÆik–y
(
g’”©iÚ
 && 
šode
->
i_g’”©iÚ
 != generation)) {

2342 
	`ut
(
šode
);

2343  
	`ERR_PTR
(-
ESTALE
);

2345  
šode
;

2346 
	}
}

2348 
d’Œy
 *
	$f2fs_fh_to_d’Œy
(
su³r_block
 *
sb
, 
fid
 *fid,

2349 
fh_Ën
, 
fh_ty³
)

2351  
	`g’”ic_fh_to_d’Œy
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

2352 
f2fs_nfs_g‘_šode
);

2353 
	}
}

2355 
d’Œy
 *
	$f2fs_fh_to_·»Á
(
su³r_block
 *
sb
, 
fid
 *fid,

2356 
fh_Ën
, 
fh_ty³
)

2358  
	`g’”ic_fh_to_·»Á
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

2359 
f2fs_nfs_g‘_šode
);

2360 
	}
}

2362 cÚ¡ 
expÜt_İ”©iÚs
 
	gf2fs_expÜt_İs
 = {

2363 .
fh_to_d’Œy
 = 
f2fs_fh_to_d’Œy
,

2364 .
	gfh_to_·»Á
 = 
f2fs_fh_to_·»Á
,

2365 .
	gg‘_·»Á
 = 
f2fs_g‘_·»Á
,

2368 
loff_t
 
	$max_fe_blocks
()

2370 
loff_t
 
»suÉ
 = 0;

2371 
loff_t
 
Ëaf_couÁ
 = 
DEF_ADDRS_PER_BLOCK
;

2381 
»suÉ
 +ğ(
Ëaf_couÁ
 * 2);

2384 
Ëaf_couÁ
 *ğ
NIDS_PER_BLOCK
;

2385 
»suÉ
 +ğ(
Ëaf_couÁ
 * 2);

2388 
Ëaf_couÁ
 *ğ
NIDS_PER_BLOCK
;

2389 
»suÉ
 +ğ
Ëaf_couÁ
;

2391  
»suÉ
;

2392 
	}
}

2394 
	$__f2fs_comm™_su³r
(
bufãr_h—d
 *
bh
,

2395 
f2fs_su³r_block
 *
su³r
)

2397 
	`lock_bufãr
(
bh
);

2398 ià(
su³r
)

2399 
	`memıy
(
bh
->
b_d©a
 + 
F2FS_SUPER_OFFSET
, 
su³r
, (*super));

2400 
	`£t_bufãr_dœty
(
bh
);

2401 
	`uÆock_bufãr
(
bh
);

2404  
	`__sync_dœty_bufãr
(
bh
, 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
);

2405 
	}
}

2407 
šlše
 
boŞ
 
	$§n™y_check_¬—_bound¬y
(
f2fs_sb_šfo
 *
sbi
,

2408 
bufãr_h—d
 *
bh
)

2410 
f2fs_su³r_block
 *
¿w_su³r
 = (f2fs_super_block *)

2411 (
bh
->
b_d©a
 + 
F2FS_SUPER_OFFSET
);

2412 
su³r_block
 *
sb
 = 
sbi
->sb;

2413 
u32
 
£gm’t0_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment0_blkaddr);

2414 
u32
 
ı_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->cp_blkaddr);

2415 
u32
 
s™_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->sit_blkaddr);

2416 
u32
 
Çt_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->nat_blkaddr);

2417 
u32
 
s§_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->ssa_blkaddr);

2418 
u32
 
maš_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->main_blkaddr);

2419 
u32
 
£gm’t_couÁ_ck±
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_ckpt);

2420 
u32
 
£gm’t_couÁ_s™
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_sit);

2421 
u32
 
£gm’t_couÁ_Çt
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_nat);

2422 
u32
 
£gm’t_couÁ_s§
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_ssa);

2423 
u32
 
£gm’t_couÁ_maš
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_main);

2424 
u32
 
£gm’t_couÁ
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count);

2425 
u32
 
log_blocks_³r_£g
 = 
	`Ë32_to_ıu
(
¿w_su³r
->log_blocks_per_seg);

2426 
u64
 
maš_’d_blkaddr
 = 
maš_blkaddr
 +

2427 (
£gm’t_couÁ_maš
 << 
log_blocks_³r_£g
);

2428 
u64
 
£g_’d_blkaddr
 = 
£gm’t0_blkaddr
 +

2429 (
£gm’t_couÁ
 << 
log_blocks_³r_£g
);

2431 ià(
£gm’t0_blkaddr
 !ğ
ı_blkaddr
) {

2432 
	`f2fs_šfo
(
sbi
, "Mismatch start‡ddress, segment0(%u) cp_blkaddr(%u)",

2433 
£gm’t0_blkaddr
, 
ı_blkaddr
);

2434  
Œue
;

2437 ià(
ı_blkaddr
 + (
£gm’t_couÁ_ck±
 << 
log_blocks_³r_£g
) !=

2438 
s™_blkaddr
) {

2439 
	`f2fs_šfo
(
sbi
, "Wrong CP boundary, start(%u)ƒnd(%u) blocks(%u)",

2440 
ı_blkaddr
, 
s™_blkaddr
,

2441 
£gm’t_couÁ_ck±
 << 
log_blocks_³r_£g
);

2442  
Œue
;

2445 ià(
s™_blkaddr
 + (
£gm’t_couÁ_s™
 << 
log_blocks_³r_£g
) !=

2446 
Çt_blkaddr
) {

2447 
	`f2fs_šfo
(
sbi
, "Wrong SIT boundary, start(%u)ƒnd(%u) blocks(%u)",

2448 
s™_blkaddr
, 
Çt_blkaddr
,

2449 
£gm’t_couÁ_s™
 << 
log_blocks_³r_£g
);

2450  
Œue
;

2453 ià(
Çt_blkaddr
 + (
£gm’t_couÁ_Çt
 << 
log_blocks_³r_£g
) !=

2454 
s§_blkaddr
) {

2455 
	`f2fs_šfo
(
sbi
, "Wrong NAT boundary, start(%u)ƒnd(%u) blocks(%u)",

2456 
Çt_blkaddr
, 
s§_blkaddr
,

2457 
£gm’t_couÁ_Çt
 << 
log_blocks_³r_£g
);

2458  
Œue
;

2461 ià(
s§_blkaddr
 + (
£gm’t_couÁ_s§
 << 
log_blocks_³r_£g
) !=

2462 
maš_blkaddr
) {

2463 
	`f2fs_šfo
(
sbi
, "Wrong SSA boundary, start(%u)ƒnd(%u) blocks(%u)",

2464 
s§_blkaddr
, 
maš_blkaddr
,

2465 
£gm’t_couÁ_s§
 << 
log_blocks_³r_£g
);

2466  
Œue
;

2469 ià(
maš_’d_blkaddr
 > 
£g_’d_blkaddr
) {

2470 
	`f2fs_šfo
(
sbi
, "Wrong MAIN_AREA boundary, start(%u)ƒnd(%u) block(%u)",

2471 
maš_blkaddr
,

2472 
£gm’t0_blkaddr
 +

2473 (
£gm’t_couÁ
 << 
log_blocks_³r_£g
),

2474 
£gm’t_couÁ_maš
 << 
log_blocks_³r_£g
);

2475  
Œue
;

2476 } ià(
maš_’d_blkaddr
 < 
£g_’d_blkaddr
) {

2477 
”r
 = 0;

2478 *
»s
;

2481 
¿w_su³r
->
£gm’t_couÁ
 = 
	`ıu_to_Ë32
((
maš_’d_blkaddr
 -

2482 
£gm’t0_blkaddr
è>> 
log_blocks_³r_£g
);

2484 ià(
	`f2fs_»adÚly
(
sb
è|| 
	`bdev_»ad_Úly
(sb->
s_bdev
)) {

2485 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_SB_WRITE
);

2486 
»s
 = "internally";

2488 
”r
 = 
	`__f2fs_comm™_su³r
(
bh
, 
NULL
);

2489 
»s
 = 
”r
 ? "failed" : "done";

2491 
	`f2fs_šfo
(
sbi
, "Fix‡lignment : %s, start(%u)ƒnd(%u) block(%u)",

2492 
»s
, 
maš_blkaddr
,

2493 
£gm’t0_blkaddr
 +

2494 (
£gm’t_couÁ
 << 
log_blocks_³r_£g
),

2495 
£gm’t_couÁ_maš
 << 
log_blocks_³r_£g
);

2496 ià(
”r
)

2497  
Œue
;

2499  
çl£
;

2500 
	}
}

2502 
	$§n™y_check_¿w_su³r
(
f2fs_sb_šfo
 *
sbi
,

2503 
bufãr_h—d
 *
bh
)

2505 
block_t
 
£gm’t_couÁ
, 
£gs_³r_£c
, 
£cs_³r_zÚe
;

2506 
block_t
 
tÙ®_£ùiÚs
, 
blocks_³r_£g
;

2507 
f2fs_su³r_block
 *
¿w_su³r
 = (f2fs_super_block *)

2508 (
bh
->
b_d©a
 + 
F2FS_SUPER_OFFSET
);

2509 
blocksize
;

2510 
size_t
 
üc_off£t
 = 0;

2511 
__u32
 
üc
 = 0;

2513 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
magic
è!ğ
F2FS_SUPER_MAGIC
) {

2514 
	`f2fs_šfo
(
sbi
, "Magic Mismatch, valid(0x%x) -„ead(0x%x)",

2515 
F2FS_SUPER_MAGIC
, 
	`Ë32_to_ıu
(
¿w_su³r
->
magic
));

2516  -
EINVAL
;

2520 ià(
	`__F2FS_HAS_FEATURE
(
¿w_su³r
, 
F2FS_FEATURE_SB_CHKSUM
)) {

2521 
üc_off£t
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
checksum_off£t
);

2522 ià(
üc_off£t
 !=

2523 
	`off£tof
(
f2fs_su³r_block
, 
üc
)) {

2524 
	`f2fs_šfo
(
sbi
, "Invalid SB checksum offset: %zu",

2525 
üc_off£t
);

2526  -
EFSCORRUPTED
;

2528 
üc
 = 
	`Ë32_to_ıu
(
¿w_su³r
->crc);

2529 ià(!
	`f2fs_üc_v®id
(
sbi
, 
üc
, 
¿w_su³r
, 
üc_off£t
)) {

2530 
	`f2fs_šfo
(
sbi
, "Inv®id SB checksum v®ue: %u", 
üc
);

2531  -
EFSCORRUPTED
;

2536 ià(
F2FS_BLKSIZE
 !ğ
PAGE_SIZE
) {

2537 
	`f2fs_šfo
(
sbi
, "Invalid…age_cache_size (%lu), supports only 4KB",

2538 
PAGE_SIZE
);

2539  -
EFSCORRUPTED
;

2543 
blocksize
 = 1 << 
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocksize
);

2544 ià(
blocksize
 !ğ
F2FS_BLKSIZE
) {

2545 
	`f2fs_šfo
(
sbi
, "Invalid blocksize (%u), supports only 4KB",

2546 
blocksize
);

2547  -
EFSCORRUPTED
;

2551 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocks_³r_£g
) != 9) {

2552 
	`f2fs_šfo
(
sbi
, "Invalid†og blocks…er segment (%u)",

2553 
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocks_³r_£g
));

2554  -
EFSCORRUPTED
;

2558 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
) >

2559 
F2FS_MAX_LOG_SECTOR_SIZE
 ||

2560 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
) <

2561 
F2FS_MIN_LOG_SECTOR_SIZE
) {

2562 
	`f2fs_šfo
(
sbi
, "Invalid†og sectorsize (%u)",

2563 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
));

2564  -
EFSCORRUPTED
;

2566 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜs_³r_block
) +

2567 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
) !=

2568 
F2FS_MAX_LOG_SECTOR_SIZE
) {

2569 
	`f2fs_šfo
(
sbi
, "Invalid†og sectors…er block(%u)†og sectorsize(%u)",

2570 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜs_³r_block
),

2571 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
));

2572  -
EFSCORRUPTED
;

2575 
£gm’t_couÁ
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count);

2576 
£gs_³r_£c
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segs_per_sec);

2577 
£cs_³r_zÚe
 = 
	`Ë32_to_ıu
(
¿w_su³r
->secs_per_zone);

2578 
tÙ®_£ùiÚs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£ùiÚ_couÁ
);

2581 
blocks_³r_£g
 = 1 << 
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocks_³r_£g
);

2583 ià(
£gm’t_couÁ
 > 
F2FS_MAX_SEGMENT
 ||

2584 
£gm’t_couÁ
 < 
F2FS_MIN_SEGMENTS
) {

2585 
	`f2fs_šfo
(
sbi
, "Inv®id segm’ˆcouÁ (%u)", 
£gm’t_couÁ
);

2586  -
EFSCORRUPTED
;

2589 ià(
tÙ®_£ùiÚs
 > 
£gm’t_couÁ
 ||

2590 
tÙ®_£ùiÚs
 < 
F2FS_MIN_SEGMENTS
 ||

2591 
£gs_³r_£c
 > 
£gm’t_couÁ
 || !segs_per_sec) {

2592 
	`f2fs_šfo
(
sbi
, "Invalid segment/section count (%u, %u x %u)",

2593 
£gm’t_couÁ
, 
tÙ®_£ùiÚs
, 
£gs_³r_£c
);

2594  -
EFSCORRUPTED
;

2597 ià((
£gm’t_couÁ
 / 
£gs_³r_£c
è< 
tÙ®_£ùiÚs
) {

2598 
	`f2fs_šfo
(
sbi
, "Small segment_count (%u < %u * %u)",

2599 
£gm’t_couÁ
, 
£gs_³r_£c
, 
tÙ®_£ùiÚs
);

2600  -
EFSCORRUPTED
;

2603 ià(
£gm’t_couÁ
 > (
	`Ë64_to_ıu
(
¿w_su³r
->
block_couÁ
) >> 9)) {

2604 
	`f2fs_šfo
(
sbi
, "Wrong segment_count / block_count (%u > %llu)",

2605 
£gm’t_couÁ
, 
	`Ë64_to_ıu
(
¿w_su³r
->
block_couÁ
));

2606  -
EFSCORRUPTED
;

2609 ià(
£cs_³r_zÚe
 > 
tÙ®_£ùiÚs
 || !secs_per_zone) {

2610 
	`f2fs_šfo
(
sbi
, "Wrong secs_per_zone /otal_sections (%u, %u)",

2611 
£cs_³r_zÚe
, 
tÙ®_£ùiÚs
);

2612  -
EFSCORRUPTED
;

2614 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
ex‹nsiÚ_couÁ
è> 
F2FS_MAX_EXTENSION
 ||

2615 
¿w_su³r
->
hÙ_ext_couÁ
 > 
F2FS_MAX_EXTENSION
 ||

2616 (
	`Ë32_to_ıu
(
¿w_su³r
->
ex‹nsiÚ_couÁ
) +

2617 
¿w_su³r
->
hÙ_ext_couÁ
è> 
F2FS_MAX_EXTENSION
) {

2618 
	`f2fs_šfo
(
sbi
, "Corruptedƒxtension count (%u + %u > %u)",

2619 
	`Ë32_to_ıu
(
¿w_su³r
->
ex‹nsiÚ_couÁ
),

2620 
¿w_su³r
->
hÙ_ext_couÁ
,

2621 
F2FS_MAX_EXTENSION
);

2622  -
EFSCORRUPTED
;

2625 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
ı_·ylßd
) >

2626 (
blocks_³r_£g
 - 
F2FS_CP_PACKS
)) {

2627 
	`f2fs_šfo
(
sbi
, "Insane cp_payload (%u > %u)",

2628 
	`Ë32_to_ıu
(
¿w_su³r
->
ı_·ylßd
),

2629 
blocks_³r_£g
 - 
F2FS_CP_PACKS
);

2630  -
EFSCORRUPTED
;

2634 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
node_šo
) != 1 ||

2635 
	`Ë32_to_ıu
(
¿w_su³r
->
m‘a_šo
) != 2 ||

2636 
	`Ë32_to_ıu
(
¿w_su³r
->
roÙ_šo
) != 3) {

2637 
	`f2fs_šfo
(
sbi
, "Invalid Fs Meta Ino:‚ode(%u) meta(%u)„oot(%u)",

2638 
	`Ë32_to_ıu
(
¿w_su³r
->
node_šo
),

2639 
	`Ë32_to_ıu
(
¿w_su³r
->
m‘a_šo
),

2640 
	`Ë32_to_ıu
(
¿w_su³r
->
roÙ_šo
));

2641  -
EFSCORRUPTED
;

2645 ià(
	`§n™y_check_¬—_bound¬y
(
sbi
, 
bh
))

2646  -
EFSCORRUPTED
;

2649 
	}
}

2651 
	$f2fs_§n™y_check_ck±
(
f2fs_sb_šfo
 *
sbi
)

2653 
tÙ®
, 
fsm‘a
;

2654 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

2655 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

2656 
ovp_£gm’ts
, 
»£rved_£gm’ts
;

2657 
maš_£gs
, 
blocks_³r_£g
;

2658 
s™_£gs
, 
Çt_£gs
;

2659 
s™_b™m­_size
, 
Çt_b™m­_size
;

2660 
log_blocks_³r_£g
;

2661 
£gm’t_couÁ_maš
;

2662 
ı_·ck_¡¬t_sum
, 
ı_·ylßd
;

2663 
block_t
 
u£r_block_couÁ
, 
v®id_u£r_blocks
;

2664 
block_t
 
ava_node_couÁ
, 
v®id_node_couÁ
;

2665 
i
, 
j
;

2667 
tÙ®
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ
);

2668 
fsm‘a
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_ck±
);

2669 
s™_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s™
);

2670 
fsm‘a
 +ğ
s™_£gs
;

2671 
Çt_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_Çt
);

2672 
fsm‘a
 +ğ
Çt_£gs
;

2673 
fsm‘a
 +ğ
	`Ë32_to_ıu
(
ck±
->
rsvd_£gm’t_couÁ
);

2674 
fsm‘a
 +ğ
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s§
);

2676 ià(
	`uÆik–y
(
fsm‘a
 >ğ
tÙ®
))

2679 
ovp_£gm’ts
 = 
	`Ë32_to_ıu
(
ck±
->
ov”´ov_£gm’t_couÁ
);

2680 
»£rved_£gm’ts
 = 
	`Ë32_to_ıu
(
ck±
->
rsvd_£gm’t_couÁ
);

2682 ià(
	`uÆik–y
(
fsm‘a
 < 
F2FS_MIN_SEGMENTS
 ||

2683 
ovp_£gm’ts
 =ğ0 || 
»£rved_£gm’ts
 == 0)) {

2684 
	`f2fs_”r
(
sbi
, "Wrong†ayout: check mkfs.f2fs version");

2688 
u£r_block_couÁ
 = 
	`Ë64_to_ıu
(
ck±
->user_block_count);

2689 
£gm’t_couÁ_maš
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count_main);

2690 
log_blocks_³r_£g
 = 
	`Ë32_to_ıu
(
¿w_su³r
->log_blocks_per_seg);

2691 ià(!
u£r_block_couÁ
 || user_block_count >=

2692 
£gm’t_couÁ_maš
 << 
log_blocks_³r_£g
) {

2693 
	`f2fs_”r
(
sbi
, "Wrong user_block_count: %u",

2694 
u£r_block_couÁ
);

2698 
v®id_u£r_blocks
 = 
	`Ë64_to_ıu
(
ck±
->
v®id_block_couÁ
);

2699 ià(
v®id_u£r_blocks
 > 
u£r_block_couÁ
) {

2700 
	`f2fs_”r
(
sbi
, "Wrong valid_user_blocks: %u, user_block_count: %u",

2701 
v®id_u£r_blocks
, 
u£r_block_couÁ
);

2705 
v®id_node_couÁ
 = 
	`Ë32_to_ıu
(
ck±
->valid_node_count);

2706 
ava_node_couÁ
 = 
sbi
->
tÙ®_node_couÁ
 - 
F2FS_RESERVED_NODE_NUM
;

2707 ià(
v®id_node_couÁ
 > 
ava_node_couÁ
) {

2708 
	`f2fs_”r
(
sbi
, "Wrong valid_node_count: %u,‡vail_node_count: %u",

2709 
v®id_node_couÁ
, 
ava_node_couÁ
);

2713 
maš_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_maš
);

2714 
blocks_³r_£g
 = 
sbi
->blocks_per_seg;

2716 
i
 = 0; i < 
NR_CURSEG_NODE_TYPE
; i++) {

2717 ià(
	`Ë32_to_ıu
(
ck±
->
cur_node_£gno
[
i
]è>ğ
maš_£gs
 ||

2718 
	`Ë16_to_ıu
(
ck±
->
cur_node_blkoff
[
i
]è>ğ
blocks_³r_£g
)

2720 
j
 = 
i
 + 1; j < 
NR_CURSEG_NODE_TYPE
; j++) {

2721 ià(
	`Ë32_to_ıu
(
ck±
->
cur_node_£gno
[
i
]) ==

2722 
	`Ë32_to_ıu
(
ck±
->
cur_node_£gno
[
j
])) {

2723 
	`f2fs_”r
(
sbi
, "Node segment (%u, %u) hashe same segno: %u",

2724 
i
, 
j
,

2725 
	`Ë32_to_ıu
(
ck±
->
cur_node_£gno
[
i
]));

2730 
i
 = 0; i < 
NR_CURSEG_DATA_TYPE
; i++) {

2731 ià(
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
i
]è>ğ
maš_£gs
 ||

2732 
	`Ë16_to_ıu
(
ck±
->
cur_d©a_blkoff
[
i
]è>ğ
blocks_³r_£g
)

2734 
j
 = 
i
 + 1; j < 
NR_CURSEG_DATA_TYPE
; j++) {

2735 ià(
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
i
]) ==

2736 
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
j
])) {

2737 
	`f2fs_”r
(
sbi
, "Data segment (%u, %u) hashe same segno: %u",

2738 
i
, 
j
,

2739 
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
i
]));

2744 
i
 = 0; i < 
NR_CURSEG_NODE_TYPE
; i++) {

2745 
j
 = 0; j < 
NR_CURSEG_DATA_TYPE
; j++) {

2746 ià(
	`Ë32_to_ıu
(
ck±
->
cur_node_£gno
[
i
]) ==

2747 
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
j
])) {

2748 
	`f2fs_”r
(
sbi
, "Node segment (%u)‡nd Data segment (%u) hashe same segno: %u",

2749 
i
, 
j
,

2750 
	`Ë32_to_ıu
(
ck±
->
cur_node_£gno
[
i
]));

2756 
s™_b™m­_size
 = 
	`Ë32_to_ıu
(
ck±
->
s™_v”_b™m­_by‹size
);

2757 
Çt_b™m­_size
 = 
	`Ë32_to_ıu
(
ck±
->
Çt_v”_b™m­_by‹size
);

2759 ià(
s™_b™m­_size
 !ğ((
s™_£gs
 / 2è<< 
log_blocks_³r_£g
) / 8 ||

2760 
Çt_b™m­_size
 !ğ((
Çt_£gs
 / 2è<< 
log_blocks_³r_£g
) / 8) {

2761 
	`f2fs_”r
(
sbi
, "Wrong bitmap size: sit: %u,‚at:%u",

2762 
s™_b™m­_size
, 
Çt_b™m­_size
);

2766 
ı_·ck_¡¬t_sum
 = 
	`__¡¬t_sum_addr
(
sbi
);

2767 
ı_·ylßd
 = 
	`__ı_·ylßd
(
sbi
);

2768 ià(
ı_·ck_¡¬t_sum
 < 
ı_·ylßd
 + 1 ||

2769 
ı_·ck_¡¬t_sum
 > 
blocks_³r_£g
 - 1 -

2770 
NR_CURSEG_TYPE
) {

2771 
	`f2fs_”r
(
sbi
, "Wrong cp_pack_start_sum: %u",

2772 
ı_·ck_¡¬t_sum
);

2776 ià(
	`__is_£t_ck±_æags
(
ck±
, 
CP_LARGE_NAT_BITMAP_FLAG
) &&

2777 
	`Ë32_to_ıu
(
ck±
->
checksum_off£t
è!ğ
CP_MIN_CHKSUM_OFFSET
) {

2778 
	`f2fs_w¬n
(
sbi
, "using deprecated†ayout of†arge_nat_bitmap, "

2781 
	`Ë32_to_ıu
(
ck±
->
checksum_off£t
));

2785 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

2786 
	`f2fs_”r
(
sbi
, "A bug case:‚eedo„un fsck");

2790 
	}
}

2792 
	$š™_sb_šfo
(
f2fs_sb_šfo
 *
sbi
)

2794 
f2fs_su³r_block
 *
¿w_su³r
 = 
sbi
->raw_super;

2795 
i
;

2797 
sbi
->
log_£ùÜs_³r_block
 =

2798 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜs_³r_block
);

2799 
sbi
->
log_blocksize
 = 
	`Ë32_to_ıu
(
¿w_su³r
->log_blocksize);

2800 
sbi
->
blocksize
 = 1 << sbi->
log_blocksize
;

2801 
sbi
->
log_blocks_³r_£g
 = 
	`Ë32_to_ıu
(
¿w_su³r
->log_blocks_per_seg);

2802 
sbi
->
blocks_³r_£g
 = 1 << sbi->
log_blocks_³r_£g
;

2803 
sbi
->
£gs_³r_£c
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segs_per_sec);

2804 
sbi
->
£cs_³r_zÚe
 = 
	`Ë32_to_ıu
(
¿w_su³r
->secs_per_zone);

2805 
sbi
->
tÙ®_£ùiÚs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£ùiÚ_couÁ
);

2806 
sbi
->
tÙ®_node_couÁ
 =

2807 (
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_Çt
) / 2)

2808 * 
sbi
->
blocks_³r_£g
 * 
NAT_ENTRY_PER_BLOCK
;

2809 
sbi
->
roÙ_šo_num
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
roÙ_šo
);

2810 
sbi
->
node_šo_num
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
node_šo
);

2811 
sbi
->
m‘a_šo_num
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
m‘a_šo
);

2812 
sbi
->
cur_viùim_£c
 = 
NULL_SECNO
;

2813 
sbi
->
Ãxt_viùim_£g
[
BG_GC
] = 
NULL_SEGNO
;

2814 
sbi
->
Ãxt_viùim_£g
[
FG_GC
] = 
NULL_SEGNO
;

2815 
sbi
->
max_viùim_£¬ch
 = 
DEF_MAX_VICTIM_SEARCH
;

2816 
sbi
->
mig¿tiÚ_g¿nuÏr™y
 = sbi->
£gs_³r_£c
;

2818 
sbi
->
dœ_Ëv–
 = 
DEF_DIR_LEVEL
;

2819 
sbi
->
š‹rv®_time
[
CP_TIME
] = 
DEF_CP_INTERVAL
;

2820 
sbi
->
š‹rv®_time
[
REQ_TIME
] = 
DEF_IDLE_INTERVAL
;

2821 
sbi
->
š‹rv®_time
[
DISCARD_TIME
] = 
DEF_IDLE_INTERVAL
;

2822 
sbi
->
š‹rv®_time
[
GC_TIME
] = 
DEF_IDLE_INTERVAL
;

2823 
sbi
->
š‹rv®_time
[
DISABLE_TIME
] = 
DEF_DISABLE_INTERVAL
;

2824 
sbi
->
š‹rv®_time
[
UMOUNT_DISCARD_TIMEOUT
] =

2825 
DEF_UMOUNT_DISCARD_TIMEOUT
;

2826 
	`ş—r_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

2828 
i
 = 0; i < 
NR_COUNT_TYPE
; i++)

2829 
	`©omic_£t
(&
sbi
->
Ä_·ges
[
i
], 0);

2831 
i
 = 0; i < 
META
; i++)

2832 
	`©omic_£t
(&
sbi
->
wb_sync_»q
[
i
], 0);

2834 
	`INIT_LIST_HEAD
(&
sbi
->
s_li¡
);

2835 
	`mu‹x_š™
(&
sbi
->
umouÁ_mu‹x
);

2836 
	`š™_rw£m
(&
sbi
->
io_Üd”_lock
);

2837 
	`¥š_lock_š™
(&
sbi
->
ı_lock
);

2839 
sbi
->
dœty_deviû
 = 0;

2840 
	`¥š_lock_š™
(&
sbi
->
dev_lock
);

2842 
	`š™_rw£m
(&
sbi
->
sb_lock
);

2843 
	}
}

2845 
	$š™_³rıu_šfo
(
f2fs_sb_šfo
 *
sbi
)

2847 
”r
;

2849 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
®loc_v®id_block_couÁ
, 0, 
GFP_KERNEL
);

2850 ià(
”r
)

2851  
”r
;

2853 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
tÙ®_v®id_šode_couÁ
, 0,

2854 
GFP_KERNEL
);

2855 ià(
”r
)

2856 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
®loc_v®id_block_couÁ
);

2858  
”r
;

2859 
	}
}

2861 #ifdeà
CONFIG_BLK_DEV_ZONED


2862 
	$š™_blkz_šfo
(
f2fs_sb_šfo
 *
sbi
, 
devi
)

2864 
block_deviû
 *
bdev
 = 
	`FDEV
(
devi
).bdev;

2865 
£ùÜ_t
 
Ä_£ùÜs
 = 
bdev
->
bd_·¹
->
Ä_£ùs
;

2866 
£ùÜ_t
 
£ùÜ
 = 0;

2867 
blk_zÚe
 *
zÚes
;

2868 
i
, 
Ä_zÚes
;

2869 
n
 = 0;

2870 
”r
 = -
EIO
;

2872 ià(!
	`f2fs_sb_has_blkzÚed
(
sbi
))

2875 ià(
sbi
->
blocks_³r_blkz
 && sbi->blocks_per_blkz !=

2876 
	`SECTOR_TO_BLOCK
(
	`bdev_zÚe_£ùÜs
(
bdev
)))

2877  -
EINVAL
;

2878 
sbi
->
blocks_³r_blkz
 = 
	`SECTOR_TO_BLOCK
(
	`bdev_zÚe_£ùÜs
(
bdev
));

2879 ià(
sbi
->
log_blocks_³r_blkz
 && sbi->log_blocks_per_blkz !=

2880 
	`__og2_u32
(
sbi
->
blocks_³r_blkz
))

2881  -
EINVAL
;

2882 
sbi
->
log_blocks_³r_blkz
 = 
	`__og2_u32
(sbi->
blocks_³r_blkz
);

2883 
	`FDEV
(
devi
).
Ä_blkz
 = 
	`SECTOR_TO_BLOCK
(
Ä_£ùÜs
) >>

2884 
sbi
->
log_blocks_³r_blkz
;

2885 ià(
Ä_£ùÜs
 & (
	`bdev_zÚe_£ùÜs
(
bdev
) - 1))

2886 
	`FDEV
(
devi
).
Ä_blkz
++;

2888 
	`FDEV
(
devi
).
blkz_£q
 = 
	`f2fs_kz®loc
(
sbi
,

2889 
	`BITS_TO_LONGS
(
	`FDEV
(
devi
).
Ä_blkz
)

2891 
GFP_KERNEL
);

2892 ià(!
	`FDEV
(
devi
).
blkz_£q
)

2893  -
ENOMEM
;

2895 
	#F2FS_REPORT_NR_ZONES
 4096

	)

2897 
zÚes
 = 
	`f2fs_kz®loc
(
sbi
,

2898 
	`¬¿y_size
(
F2FS_REPORT_NR_ZONES
,

2899 (
blk_zÚe
)),

2900 
GFP_KERNEL
);

2901 ià(!
zÚes
)

2902  -
ENOMEM
;

2905 
zÚes
 && 
£ùÜ
 < 
Ä_£ùÜs
) {

2907 
Ä_zÚes
 = 
F2FS_REPORT_NR_ZONES
;

2908 
”r
 = 
	`blkdev_»pÜt_zÚes
(
bdev
, 
£ùÜ
, 
zÚes
, &
Ä_zÚes
);

2909 ià(
”r
)

2911 ià(!
Ä_zÚes
) {

2912 
”r
 = -
EIO
;

2916 
i
 = 0; i < 
Ä_zÚes
; i++) {

2917 ià(
zÚes
[
i
].
ty³
 !ğ
BLK_ZONE_TYPE_CONVENTIONAL
)

2918 
	`£t_b™
(
n
, 
	`FDEV
(
devi
).
blkz_£q
);

2919 
£ùÜ
 +ğ
zÚes
[
i
].
Ën
;

2920 
n
++;

2924 
	`kvä“
(
zÚes
);

2926  
”r
;

2927 
	}
}

2936 
	$»ad_¿w_su³r_block
(
f2fs_sb_šfo
 *
sbi
,

2937 
f2fs_su³r_block
 **
¿w_su³r
,

2938 *
v®id_su³r_block
, *
»cov”y
)

2940 
su³r_block
 *
sb
 = 
sbi
->sb;

2941 
block
;

2942 
bufãr_h—d
 *
bh
;

2943 
f2fs_su³r_block
 *
su³r
;

2944 
”r
 = 0;

2946 
su³r
 = 
	`kz®loc
((
f2fs_su³r_block
), 
GFP_KERNEL
);

2947 ià(!
su³r
)

2948  -
ENOMEM
;

2950 
block
 = 0; block < 2; block++) {

2951 
bh
 = 
	`sb_b»ad
(
sb
, 
block
);

2952 ià(!
bh
) {

2953 
	`f2fs_”r
(
sbi
, "Unableo„ead %dth superblock",

2954 
block
 + 1);

2955 
”r
 = -
EIO
;

2960 
”r
 = 
	`§n™y_check_¿w_su³r
(
sbi
, 
bh
);

2961 ià(
”r
) {

2962 
	`f2fs_”r
(
sbi
, "Can't find valid F2FS filesystem in %dth superblock",

2963 
block
 + 1);

2964 
	`b»l£
(
bh
);

2968 ià(!*
¿w_su³r
) {

2969 
	`memıy
(
su³r
, 
bh
->
b_d©a
 + 
F2FS_SUPER_OFFSET
,

2970 (*
su³r
));

2971 *
v®id_su³r_block
 = 
block
;

2972 *
¿w_su³r
 = 
su³r
;

2974 
	`b»l£
(
bh
);

2978 ià(
”r
 < 0)

2979 *
»cov”y
 = 1;

2982 ià(!*
¿w_su³r
)

2983 
	`kvä“
(
su³r
);

2985 
”r
 = 0;

2987  
”r
;

2988 
	}
}

2990 
	$f2fs_comm™_su³r
(
f2fs_sb_šfo
 *
sbi
, 
boŞ
 
»cov”
)

2992 
bufãr_h—d
 *
bh
;

2993 
__u32
 
üc
 = 0;

2994 
”r
;

2996 ià((
»cov”
 && 
	`f2fs_»adÚly
(
sbi
->
sb
)) ||

2997 
	`bdev_»ad_Úly
(
sbi
->
sb
->
s_bdev
)) {

2998 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_SB_WRITE
);

2999  -
EROFS
;

3003 ià(!
»cov”
 && 
	`f2fs_sb_has_sb_chksum
(
sbi
)) {

3004 
üc
 = 
	`f2fs_üc32
(
sbi
, 
	`F2FS_RAW_SUPER
(sbi),

3005 
	`off£tof
(
f2fs_su³r_block
, 
üc
));

3006 
	`F2FS_RAW_SUPER
(
sbi
)->
üc
 = 
	`ıu_to_Ë32
(crc);

3010 
bh
 = 
	`sb_b»ad
(
sbi
->
sb
, sbi->
v®id_su³r_block
 ? 0 : 1);

3011 ià(!
bh
)

3012  -
EIO
;

3013 
”r
 = 
	`__f2fs_comm™_su³r
(
bh
, 
	`F2FS_RAW_SUPER
(
sbi
));

3014 
	`b»l£
(
bh
);

3017 ià(
»cov”
 || 
”r
)

3018  
”r
;

3021 
bh
 = 
	`sb_b»ad
(
sbi
->
sb
, sbi->
v®id_su³r_block
);

3022 ià(!
bh
)

3023  -
EIO
;

3024 
”r
 = 
	`__f2fs_comm™_su³r
(
bh
, 
	`F2FS_RAW_SUPER
(
sbi
));

3025 
	`b»l£
(
bh
);

3026  
”r
;

3027 
	}
}

3029 
	$f2fs_sÿn_deviûs
(
f2fs_sb_šfo
 *
sbi
)

3031 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

3032 
max_deviûs
 = 
MAX_DEVICES
;

3033 
i
;

3036 ià(!
	`RDEV
(0).
·th
[0]) {

3037 ià(!
	`bdev_is_zÚed
(
sbi
->
sb
->
s_bdev
))

3039 
max_deviûs
 = 1;

3046 
sbi
->
devs
 = 
	`f2fs_kz®loc
(sbi,

3047 
	`¬¿y_size
(
max_deviûs
,

3048 (
f2fs_dev_šfo
)),

3049 
GFP_KERNEL
);

3050 ià(!
sbi
->
devs
)

3051  -
ENOMEM
;

3053 
i
 = 0; i < 
max_deviûs
; i++) {

3055 ià(
i
 > 0 && !
	`RDEV
(i).
·th
[0])

3058 ià(
max_deviûs
 == 1) {

3060 
	`FDEV
(0).
bdev
 =

3061 
	`blkdev_g‘_by_dev
(
sbi
->
sb
->
s_bdev
->
bd_dev
,

3062 
sbi
->
sb
->
s_mode
, sbi->sb->
s_ty³
);

3065 
	`memıy
(
	`FDEV
(
i
).
·th
, 
	`RDEV
(i).·th, 
MAX_PATH_LEN
);

3066 
	`FDEV
(
i
).
tÙ®_£gm’ts
 =

3067 
	`Ë32_to_ıu
(
	`RDEV
(
i
).
tÙ®_£gm’ts
);

3068 ià(
i
 == 0) {

3069 
	`FDEV
(
i
).
¡¬t_blk
 = 0;

3070 
	`FDEV
(
i
).
’d_blk
 = FDEV(i).
¡¬t_blk
 +

3071 (
	`FDEV
(
i
).
tÙ®_£gm’ts
 <<

3072 
sbi
->
log_blocks_³r_£g
) - 1 +

3073 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t0_blkaddr
);

3075 
	`FDEV
(
i
).
¡¬t_blk
 = FDEV(˜- 1).
’d_blk
 + 1;

3076 
	`FDEV
(
i
).
’d_blk
 = FDEV(i).
¡¬t_blk
 +

3077 (
	`FDEV
(
i
).
tÙ®_£gm’ts
 <<

3078 
sbi
->
log_blocks_³r_£g
) - 1;

3080 
	`FDEV
(
i
).
bdev
 = 
	`blkdev_g‘_by_·th
(FDEV(i).
·th
,

3081 
sbi
->
sb
->
s_mode
, sbi->sb->
s_ty³
);

3083 ià(
	`IS_ERR
(
	`FDEV
(
i
).
bdev
))

3084  
	`PTR_ERR
(
	`FDEV
(
i
).
bdev
);

3087 
sbi
->
s_ndevs
 = 
i
 + 1;

3089 #ifdeà
CONFIG_BLK_DEV_ZONED


3090 ià(
	`bdev_zÚed_mod–
(
	`FDEV
(
i
).
bdev
è=ğ
BLK_ZONED_HM
 &&

3091 !
	`f2fs_sb_has_blkzÚed
(
sbi
)) {

3092 
	`f2fs_”r
(
sbi
, "Zoned block device feature‚otƒnabled\n");

3093  -
EINVAL
;

3095 ià(
	`bdev_zÚed_mod–
(
	`FDEV
(
i
).
bdev
è!ğ
BLK_ZONED_NONE
) {

3096 ià(
	`š™_blkz_šfo
(
sbi
, 
i
)) {

3097 
	`f2fs_”r
(
sbi
, "Failedo initialize F2FS blkzone information");

3098  -
EINVAL
;

3100 ià(
max_deviûs
 == 1)

3102 
	`f2fs_šfo
(
sbi
, "Mount Device [%2d]: %20s, %8u, %8x - %8x (zone: %s)",

3103 
i
, 
	`FDEV
(i).
·th
,

3104 
	`FDEV
(
i
).
tÙ®_£gm’ts
,

3105 
	`FDEV
(
i
).
¡¬t_blk
, FDEV(i).
’d_blk
,

3106 
	`bdev_zÚed_mod–
(
	`FDEV
(
i
).
bdev
è=ğ
BLK_ZONED_HA
 ?

3111 
	`f2fs_šfo
(
sbi
, "Mount Device [%2d]: %20s, %8u, %8x - %8x",

3112 
i
, 
	`FDEV
(i).
·th
,

3113 
	`FDEV
(
i
).
tÙ®_£gm’ts
,

3114 
	`FDEV
(
i
).
¡¬t_blk
, FDEV(i).
’d_blk
);

3116 
	`f2fs_šfo
(
sbi
,

3117 "IO Block Size: %8d KB", 
	`F2FS_IO_SIZE_KB
(
sbi
));

3119 
	}
}

3121 
	$f2fs_£tup_ÿ£fŞd
(
f2fs_sb_šfo
 *
sbi
)

3123 #ifdeà
CONFIG_UNICODE


3124 ià(
	`f2fs_sb_has_ÿ£fŞd
(
sbi
è&& !sbi->
s_’codšg
) {

3125 cÚ¡ 
f2fs_sb_’codšgs
 *
’codšg_šfo
;

3126 
unicode_m­
 *
’codšg
;

3127 
__u16
 
’codšg_æags
;

3129 ià(
	`f2fs_sb_has_’üy±
(
sbi
)) {

3130 
	`f2fs_”r
(
sbi
,

3132  -
EINVAL
;

3135 ià(
	`f2fs_sb_»ad_’codšg
(
sbi
->
¿w_su³r
, &
’codšg_šfo
,

3136 &
’codšg_æags
)) {

3137 
	`f2fs_”r
(
sbi
,

3139  -
EINVAL
;

3142 
’codšg
 = 
	`utf8_lßd
(
’codšg_šfo
->
v”siÚ
);

3143 ià(
	`IS_ERR
(
’codšg
)) {

3144 
	`f2fs_”r
(
sbi
,

3147 
’codšg_šfo
->
Çme
,ƒncodšg_šfo->
v”siÚ
,

3148 
’codšg_æags
);

3149  
	`PTR_ERR
(
’codšg
);

3151 
	`f2fs_šfo
(
sbi
, "Usingƒncoding defined by superblock: "

3152 "%s-% w™h fÏg 0x%hx", 
’codšg_šfo
->
Çme
,

3153 
’codšg_šfo
->
v”siÚ
?:"\b", 
’codšg_æags
);

3155 
sbi
->
s_’codšg
 = 
’codšg
;

3156 
sbi
->
s_’codšg_æags
 = 
’codšg_æags
;

3157 
sbi
->
sb
->
s_d_İ
 = &
f2fs_d’Œy_İs
;

3160 ià(
	`f2fs_sb_has_ÿ£fŞd
(
sbi
)) {

3161 
	`f2fs_”r
(
sbi
, "Filesystem with casefold feature cannot be mounted without CONFIG_UNICODE");

3162  -
EINVAL
;

3166 
	}
}

3168 
	$f2fs_tunšg_·¿m‘”s
(
f2fs_sb_šfo
 *
sbi
)

3170 
f2fs_sm_šfo
 *
sm_i
 = 
	`SM_I
(
sbi
);

3173 ià(
sm_i
->
maš_£gm’ts
 <ğ
SMALL_VOLUME_SEGMENTS
) {

3174 
	`F2FS_OPTION
(
sbi
).
®loc_mode
 = 
ALLOC_MODE_REUSE
;

3175 
sm_i
->
dcc_šfo
->
disÿrd_g¿nuÏr™y
 = 1;

3176 
sm_i
->
u_pŞicy
 = 1 << 
F2FS_IPU_FORCE
;

3179 
sbi
->
»addœ_¿
 = 1;

3180 
	}
}

3182 
	$f2fs_fl_su³r
(
su³r_block
 *
sb
, *
d©a
, 
s’t
)

3184 
f2fs_sb_šfo
 *
sbi
;

3185 
f2fs_su³r_block
 *
¿w_su³r
;

3186 
šode
 *
roÙ
;

3187 
”r
;

3188 
boŞ
 
sk_»cov”y
 = 
çl£
, 
Ãed_fsck
 = false;

3189 *
İtiÚs
 = 
NULL
;

3190 
»cov”y
, 
i
, 
v®id_su³r_block
;

3191 
cur£g_šfo
 *
£g_i
;

3192 
»Œy_út
 = 1;

3194 
Œy_ÚemÜe
:

3195 
”r
 = -
EINVAL
;

3196 
¿w_su³r
 = 
NULL
;

3197 
v®id_su³r_block
 = -1;

3198 
»cov”y
 = 0;

3201 
sbi
 = 
	`kz®loc
((
f2fs_sb_šfo
), 
GFP_KERNEL
);

3202 ià(!
sbi
)

3203  -
ENOMEM
;

3205 
sbi
->
sb
 = sb;

3208 
sbi
->
s_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32", 0, 0);

3209 ià(
	`IS_ERR
(
sbi
->
s_chksum_driv”
)) {

3210 
	`f2fs_”r
(
sbi
, "Cannot†oad crc32 driver.");

3211 
”r
 = 
	`PTR_ERR
(
sbi
->
s_chksum_driv”
);

3212 
sbi
->
s_chksum_driv”
 = 
NULL
;

3213 
ä“_sbi
;

3217 ià(
	`uÆik–y
(!
	`sb_£t_blocksize
(
sb
, 
F2FS_BLKSIZE
))) {

3218 
	`f2fs_”r
(
sbi
, "unableo set blocksize");

3219 
ä“_sbi
;

3222 
”r
 = 
	`»ad_¿w_su³r_block
(
sbi
, &
¿w_su³r
, &
v®id_su³r_block
,

3223 &
»cov”y
);

3224 ià(
”r
)

3225 
ä“_sbi
;

3227 
sb
->
s_fs_šfo
 = 
sbi
;

3228 
sbi
->
¿w_su³r
 =„aw_super;

3231 ià(
	`f2fs_sb_has_šode_chksum
(
sbi
))

3232 
sbi
->
s_chksum_£ed
 = 
	`f2fs_chksum
(sbi, ~0, 
¿w_su³r
->
uuid
,

3233 (
¿w_su³r
->
uuid
));

3240 #iâdeà
CONFIG_BLK_DEV_ZONED


3241 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
)) {

3242 
	`f2fs_”r
(
sbi
, "Zoned block device support is‚otƒnabled");

3243 
”r
 = -
EOPNOTSUPP
;

3244 
ä“_sb_buf
;

3247 
	`deçuÉ_İtiÚs
(
sbi
);

3249 
İtiÚs
 = 
	`k¡rdup
((cÚ¡ *)
d©a
, 
GFP_KERNEL
);

3250 ià(
d©a
 && !
İtiÚs
) {

3251 
”r
 = -
ENOMEM
;

3252 
ä“_sb_buf
;

3255 
”r
 = 
	`·r£_İtiÚs
(
sb
, 
İtiÚs
);

3256 ià(
”r
)

3257 
ä“_İtiÚs
;

3259 
sbi
->
max_fe_blocks
 = 
	`max_fe_blocks
();

3260 
sb
->
s_maxby‹s
 = 
sbi
->
max_fe_blocks
 <<

3261 
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocksize
);

3262 
sb
->
s_max_lšks
 = 
F2FS_LINK_MAX
;

3264 
”r
 = 
	`f2fs_£tup_ÿ£fŞd
(
sbi
);

3265 ià(
”r
)

3266 
ä“_İtiÚs
;

3268 #ifdeà
CONFIG_QUOTA


3269 
sb
->
dq_İ
 = &
f2fs_quÙa_İ”©iÚs
;

3270 
sb
->
s_qcİ
 = &
f2fs_quÙaùl_İs
;

3271 
sb
->
s_quÙa_ty³s
 = 
QTYPE_MASK_USR
 | 
QTYPE_MASK_GRP
 | 
QTYPE_MASK_PRJ
;

3273 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
)) {

3274 
i
 = 0; i < 
MAXQUOTAS
; i++) {

3275 ià(
	`f2fs_qf_šo
(
sbi
->
sb
, 
i
))

3276 
sbi
->
nquÙa_fes
++;

3281 
sb
->
s_İ
 = &
f2fs_sİs
;

3282 #ifdeà
CONFIG_FS_ENCRYPTION


3283 
sb
->
s_cİ
 = &
f2fs_üy±İs
;

3285 #ifdeà
CONFIG_FS_VERITY


3286 
sb
->
s_vİ
 = &
f2fs_v”™yİs
;

3288 
sb
->
s_x©Œ
 = 
f2fs_x©Œ_hªdËrs
;

3289 
sb
->
s_expÜt_İ
 = &
f2fs_expÜt_İs
;

3290 
sb
->
s_magic
 = 
F2FS_SUPER_MAGIC
;

3291 
sb
->
s_time_g¿n
 = 1;

3292 
sb
->
s_æags
 = (sb->s_æag & ~
SB_POSIXACL
) |

3293 (
	`‹¡_İt
(
sbi
, 
POSIX_ACL
è? 
SB_POSIXACL
 : 0);

3294 
	`memıy
(&
sb
->
s_uuid
, 
¿w_su³r
->
uuid
, (raw_super->uuid));

3295 
sb
->
s_iæags
 |ğ
SB_I_CGROUPWB
;

3298 
sbi
->
v®id_su³r_block
 = valid_super_block;

3299 
	`mu‹x_š™
(&
sbi
->
gc_mu‹x
);

3300 
	`mu‹x_š™
(&
sbi
->
wr™•ages
);

3301 
	`mu‹x_š™
(&
sbi
->
ı_mu‹x
);

3302 
	`mu‹x_š™
(&
sbi
->
»size_mu‹x
);

3303 
	`š™_rw£m
(&
sbi
->
node_wr™e
);

3304 
	`š™_rw£m
(&
sbi
->
node_chªge
);

3307 
	`£t_sbi_æag
(
sbi
, 
SBI_POR_DOING
);

3308 
	`¥š_lock_š™
(&
sbi
->
¡©_lock
);

3311 
	`¥š_lock_š™
(&
sbi
->
io¡©_lock
);

3312 
sbi
->
io¡©_’abË
 = 
çl£
;

3314 
i
 = 0; i < 
NR_PAGE_TYPE
; i++) {

3315 
n
 = (
i
 =ğ
META
è? 1: 
NR_TEMP_TYPE
;

3316 
j
;

3318 
sbi
->
wr™e_io
[
i
] =

3319 
	`f2fs_km®loc
(
sbi
,

3320 
	`¬¿y_size
(
n
,

3321 (
f2fs_bio_šfo
)),

3322 
GFP_KERNEL
);

3323 ià(!
sbi
->
wr™e_io
[
i
]) {

3324 
”r
 = -
ENOMEM
;

3325 
ä“_bio_šfo
;

3328 
j
 = 
HOT
; j < 
n
; j++) {

3329 
	`š™_rw£m
(&
sbi
->
wr™e_io
[
i
][
j
].
io_rw£m
);

3330 
sbi
->
wr™e_io
[
i
][
j
].sbi = sbi;

3331 
sbi
->
wr™e_io
[
i
][
j
].
bio
 = 
NULL
;

3332 
	`¥š_lock_š™
(&
sbi
->
wr™e_io
[
i
][
j
].
io_lock
);

3333 
	`INIT_LIST_HEAD
(&
sbi
->
wr™e_io
[
i
][
j
].
io_li¡
);

3337 
	`š™_rw£m
(&
sbi
->
ı_rw£m
);

3338 
	`š™_rw£m
(&
sbi
->
quÙa_£m
);

3339 
	`š™_wa™queue_h—d
(&
sbi
->
ı_wa™
);

3340 
	`š™_sb_šfo
(
sbi
);

3342 
”r
 = 
	`š™_³rıu_šfo
(
sbi
);

3343 ià(
”r
)

3344 
ä“_bio_šfo
;

3346 ià(
	`F2FS_IO_ALIGNED
(
sbi
)) {

3347 
sbi
->
wr™e_io_dummy
 =

3348 
	`mempoŞ_ü—‹_·ge_poŞ
(2 * (
	`F2FS_IO_SIZE
(
sbi
) - 1), 0);

3349 ià(!
sbi
->
wr™e_io_dummy
) {

3350 
”r
 = -
ENOMEM
;

3351 
ä“_³rıu
;

3356 
sbi
->
m‘a_šode
 = 
	`f2fs_ig‘
(
sb
, 
	`F2FS_META_INO
(sbi));

3357 ià(
	`IS_ERR
(
sbi
->
m‘a_šode
)) {

3358 
	`f2fs_”r
(
sbi
, "Failedo„ead F2FS meta data inode");

3359 
”r
 = 
	`PTR_ERR
(
sbi
->
m‘a_šode
);

3360 
ä“_io_dummy
;

3363 
”r
 = 
	`f2fs_g‘_v®id_checkpošt
(
sbi
);

3364 ià(
”r
) {

3365 
	`f2fs_”r
(
sbi
, "Failedo get valid F2FS checkpoint");

3366 
ä“_m‘a_šode
;

3369 ià(
	`__is_£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
CP_QUOTA_NEED_FSCK_FLAG
))

3370 
	`£t_sbi_æag
(
sbi
, 
SBI_QUOTA_NEED_REPAIR
);

3371 ià(
	`__is_£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
CP_DISABLED_QUICK_FLAG
)) {

3372 
	`£t_sbi_æag
(
sbi
, 
SBI_CP_DISABLED_QUICK
);

3373 
sbi
->
š‹rv®_time
[
DISABLE_TIME
] = 
DEF_DISABLE_QUICK_INTERVAL
;

3376 ià(
	`__is_£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
CP_FSCK_FLAG
))

3377 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

3380 
”r
 = 
	`f2fs_sÿn_deviûs
(
sbi
);

3381 ià(
”r
) {

3382 
	`f2fs_”r
(
sbi
, "Failedo find devices");

3383 
ä“_deviûs
;

3386 
sbi
->
tÙ®_v®id_node_couÁ
 =

3387 
	`Ë32_to_ıu
(
sbi
->
ck±
->
v®id_node_couÁ
);

3388 
	`³rıu_couÁ”_£t
(&
sbi
->
tÙ®_v®id_šode_couÁ
,

3389 
	`Ë32_to_ıu
(
sbi
->
ck±
->
v®id_šode_couÁ
));

3390 
sbi
->
u£r_block_couÁ
 = 
	`Ë64_to_ıu
(sbi->
ck±
->user_block_count);

3391 
sbi
->
tÙ®_v®id_block_couÁ
 =

3392 
	`Ë64_to_ıu
(
sbi
->
ck±
->
v®id_block_couÁ
);

3393 
sbi
->
Ï¡_v®id_block_couÁ
 = sbi->
tÙ®_v®id_block_couÁ
;

3394 
sbi
->
»£rved_blocks
 = 0;

3395 
sbi
->
cu¼’t_»£rved_blocks
 = 0;

3396 
	`lim™_»£rve_roÙ
(
sbi
);

3398 
i
 = 0; i < 
NR_INODE_TYPE
; i++) {

3399 
	`INIT_LIST_HEAD
(&
sbi
->
šode_li¡
[
i
]);

3400 
	`¥š_lock_š™
(&
sbi
->
šode_lock
[
i
]);

3402 
	`mu‹x_š™
(&
sbi
->
æush_lock
);

3404 
	`f2fs_š™_ex‹Á_ÿche_šfo
(
sbi
);

3406 
	`f2fs_š™_šo_’Œy_šfo
(
sbi
);

3408 
	`f2fs_š™_fsync_node_šfo
(
sbi
);

3411 
”r
 = 
	`f2fs_bud_£gm’t_mªag”
(
sbi
);

3412 ià(
”r
) {

3413 
	`f2fs_”r
(
sbi
, "Failedo initialize F2FS segment manager (%d)",

3414 
”r
);

3415 
ä“_sm
;

3417 
”r
 = 
	`f2fs_bud_node_mªag”
(
sbi
);

3418 ià(
”r
) {

3419 
	`f2fs_”r
(
sbi
, "Failedo initialize F2FS‚ode manager (%d)",

3420 
”r
);

3421 
ä“_nm
;

3425 ià(
sb
->
s_bdev
->
bd_·¹
)

3426 
sbi
->
£ùÜs_wr™‹n_¡¬t
 =

3427 (
u64
)
	`·¹_¡©_»ad
(
sb
->
s_bdev
->
bd_·¹
,

3428 
£ùÜs
[
STAT_WRITE
]);

3431 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_NODE
);

3432 ià(
	`__exi¡_node_summ¬›s
(
sbi
))

3433 
sbi
->
kby‹s_wr™‹n
 =

3434 
	`Ë64_to_ıu
(
£g_i
->
jouº®
->
šfo
.
kby‹s_wr™‹n
);

3436 
	`f2fs_bud_gc_mªag”
(
sbi
);

3438 
”r
 = 
	`f2fs_bud_¡©s
(
sbi
);

3439 ià(
”r
)

3440 
ä“_nm
;

3443 
sbi
->
node_šode
 = 
	`f2fs_ig‘
(
sb
, 
	`F2FS_NODE_INO
(sbi));

3444 ià(
	`IS_ERR
(
sbi
->
node_šode
)) {

3445 
	`f2fs_”r
(
sbi
, "Failedo„ead‚ode inode");

3446 
”r
 = 
	`PTR_ERR
(
sbi
->
node_šode
);

3447 
ä“_¡©s
;

3451 
roÙ
 = 
	`f2fs_ig‘
(
sb
, 
	`F2FS_ROOT_INO
(
sbi
));

3452 ià(
	`IS_ERR
(
roÙ
)) {

3453 
	`f2fs_”r
(
sbi
, "Failedo„ead„oot inode");

3454 
”r
 = 
	`PTR_ERR
(
roÙ
);

3455 
ä“_node_šode
;

3457 ià(!
	`S_ISDIR
(
roÙ
->
i_mode
è|| !roÙ->
i_blocks
 ||

3458 !
roÙ
->
i_size
 || !roÙ->
i_Æšk
) {

3459 
	`ut
(
roÙ
);

3460 
”r
 = -
EINVAL
;

3461 
ä“_node_šode
;

3464 
sb
->
s_roÙ
 = 
	`d_make_roÙ
(
roÙ
);

3465 ià(!
sb
->
s_roÙ
) {

3466 
”r
 = -
ENOMEM
;

3467 
ä“_node_šode
;

3470 
”r
 = 
	`f2fs_»gi¡”_sysfs
(
sbi
);

3471 ià(
”r
)

3472 
ä“_roÙ_šode
;

3474 #ifdeà
CONFIG_QUOTA


3476 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
è&& !
	`f2fs_»adÚly
(
sb
)) {

3477 
”r
 = 
	`f2fs_’abË_quÙas
(
sb
);

3478 ià(
”r
)

3479 
	`f2fs_”r
(
sbi
, "CªnÙuº oÀquÙas:ƒ¼Ü %d", 
”r
);

3483 
”r
 = 
	`f2fs_»cov”_Üphª_šodes
(
sbi
);

3484 ià(
”r
)

3485 
ä“_m‘a
;

3487 ià(
	`uÆik–y
(
	`is_£t_ck±_æags
(
sbi
, 
CP_DISABLED_FLAG
)))

3488 
»£t_checkpošt
;

3491 ià(!
	`‹¡_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
)) {

3496 ià(
	`f2fs_hw_is_»adÚly
(
sbi
)) {

3497 ià(!
	`is_£t_ck±_æags
(
sbi
, 
CP_UMOUNT_FLAG
)) {

3498 
”r
 = -
EROFS
;

3499 
	`f2fs_”r
(
sbi
, "Needo„ecover fsync data, but write‡ccess unavailable");

3500 
ä“_m‘a
;

3502 
	`f2fs_šfo
(
sbi
, "write‡ccess unavailable, skipping„ecovery");

3503 
»£t_checkpošt
;

3506 ià(
Ãed_fsck
)

3507 
	`£t_sbi_æag
(
sbi
, 
SBI_NEED_FSCK
);

3509 ià(
sk_»cov”y
)

3510 
»£t_checkpošt
;

3512 
”r
 = 
	`f2fs_»cov”_fsync_d©a
(
sbi
, 
çl£
);

3513 ià(
”r
 < 0) {

3514 ià(
”r
 !ğ-
ENOMEM
)

3515 
sk_»cov”y
 = 
Œue
;

3516 
Ãed_fsck
 = 
Œue
;

3517 
	`f2fs_”r
(
sbi
, "Cannot„ecover‡ll fsync dataƒrrno=%d",

3518 
”r
);

3519 
ä“_m‘a
;

3522 
”r
 = 
	`f2fs_»cov”_fsync_d©a
(
sbi
, 
Œue
);

3524 ià(!
	`f2fs_»adÚly
(
sb
è&& 
”r
 > 0) {

3525 
”r
 = -
EINVAL
;

3526 
	`f2fs_”r
(
sbi
, "Needo„ecover fsync data");

3527 
ä“_m‘a
;

3530 
»£t_checkpošt
:

3532 
	`ş—r_sbi_æag
(
sbi
, 
SBI_POR_DOING
);

3534 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_CHECKPOINT
)) {

3535 
”r
 = 
	`f2fs_di§bË_checkpošt
(
sbi
);

3536 ià(
”r
)

3537 
sync_ä“_m‘a
;

3538 } ià(
	`is_£t_ck±_æags
(
sbi
, 
CP_DISABLED_FLAG
)) {

3539 
	`f2fs_’abË_checkpošt
(
sbi
);

3546 ià(
	`‹¡_İt
(
sbi
, 
BG_GC
è&& !
	`f2fs_»adÚly
(
sb
)) {

3548 
”r
 = 
	`f2fs_¡¬t_gc_th»ad
(
sbi
);

3549 ià(
”r
)

3550 
sync_ä“_m‘a
;

3552 
	`kvä“
(
İtiÚs
);

3555 ià(
»cov”y
) {

3556 
”r
 = 
	`f2fs_comm™_su³r
(
sbi
, 
Œue
);

3557 
	`f2fs_šfo
(
sbi
, "Tryo„ecover %dth superblock,„et: %d",

3558 
sbi
->
v®id_su³r_block
 ? 1 : 2, 
”r
);

3561 
	`f2fs_još_shršk”
(
sbi
);

3563 
	`f2fs_tunšg_·¿m‘”s
(
sbi
);

3565 
	`f2fs_nÙiû
(
sbi
, "Mounted with checkpoint version = %llx",

3566 
	`cur_ı_v”siÚ
(
	`F2FS_CKPT
(
sbi
)));

3567 
	`f2fs_upd©e_time
(
sbi
, 
CP_TIME
);

3568 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

3569 
	`ş—r_sbi_æag
(
sbi
, 
SBI_CP_DISABLED_QUICK
);

3572 
sync_ä“_m‘a
:

3574 
	`sync_fesy¡em
(
sbi
->
sb
);

3575 
»Œy_út
 = 0;

3577 
ä“_m‘a
:

3578 #ifdeà
CONFIG_QUOTA


3579 
	`f2fs_Œunÿ‹_quÙa_šode_·ges
(
sb
);

3580 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
è&& !
	`f2fs_»adÚly
(
sb
))

3581 
	`f2fs_quÙa_off_umouÁ
(
sbi
->
sb
);

3589 
	`Œunÿ‹_šode_·ges_fš®
(
	`META_MAPPING
(
sbi
));

3591 
	`eviù_šodes
(
sb
);

3592 
	`f2fs_uÄegi¡”_sysfs
(
sbi
);

3593 
ä“_roÙ_šode
:

3594 
	`dput
(
sb
->
s_roÙ
);

3595 
sb
->
s_roÙ
 = 
NULL
;

3596 
ä“_node_šode
:

3597 
	`f2fs_»Ëa£_šo_’Œy
(
sbi
, 
Œue
);

3598 
	`Œunÿ‹_šode_·ges_fš®
(
	`NODE_MAPPING
(
sbi
));

3599 
	`ut
(
sbi
->
node_šode
);

3600 
sbi
->
node_šode
 = 
NULL
;

3601 
ä“_¡©s
:

3602 
	`f2fs_de¡roy_¡©s
(
sbi
);

3603 
ä“_nm
:

3604 
	`f2fs_de¡roy_node_mªag”
(
sbi
);

3605 
ä“_sm
:

3606 
	`f2fs_de¡roy_£gm’t_mªag”
(
sbi
);

3607 
ä“_deviûs
:

3608 
	`de¡roy_deviû_li¡
(
sbi
);

3609 
	`kvä“
(
sbi
->
ck±
);

3610 
ä“_m‘a_šode
:

3611 
	`make_bad_šode
(
sbi
->
m‘a_šode
);

3612 
	`ut
(
sbi
->
m‘a_šode
);

3613 
sbi
->
m‘a_šode
 = 
NULL
;

3614 
ä“_io_dummy
:

3615 
	`mempoŞ_de¡roy
(
sbi
->
wr™e_io_dummy
);

3616 
ä“_³rıu
:

3617 
	`de¡roy_³rıu_šfo
(
sbi
);

3618 
ä“_bio_šfo
:

3619 
i
 = 0; i < 
NR_PAGE_TYPE
; i++)

3620 
	`kvä“
(
sbi
->
wr™e_io
[
i
]);

3622 #ifdeà
CONFIG_UNICODE


3623 
	`utf8_uÆßd
(
sbi
->
s_’codšg
);

3625 
ä“_İtiÚs
:

3626 #ifdeà
CONFIG_QUOTA


3627 
i
 = 0; i < 
MAXQUOTAS
; i++)

3628 
	`kvä“
(
	`F2FS_OPTION
(
sbi
).
s_qf_Çmes
[
i
]);

3630 
	`kvä“
(
İtiÚs
);

3631 
ä“_sb_buf
:

3632 
	`kvä“
(
¿w_su³r
);

3633 
ä“_sbi
:

3634 ià(
sbi
->
s_chksum_driv”
)

3635 
	`üy±o_ä“_shash
(
sbi
->
s_chksum_driv”
);

3636 
	`kvä“
(
sbi
);

3639 ià(
»Œy_út
 > 0 && 
sk_»cov”y
) {

3640 
»Œy_út
--;

3641 
	`shršk_dÿche_sb
(
sb
);

3642 
Œy_ÚemÜe
;

3644  
”r
;

3645 
	}
}

3647 
d’Œy
 *
	$f2fs_mouÁ
(
fe_sy¡em_ty³
 *
fs_ty³
, 
æags
,

3648 cÚ¡ *
dev_Çme
, *
d©a
)

3650  
	`mouÁ_bdev
(
fs_ty³
, 
æags
, 
dev_Çme
, 
d©a
, 
f2fs_fl_su³r
);

3651 
	}
}

3653 
	$kl_f2fs_su³r
(
su³r_block
 *
sb
)

3655 ià(
sb
->
s_roÙ
) {

3656 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

3658 
	`£t_sbi_æag
(
sbi
, 
SBI_IS_CLOSE
);

3659 
	`f2fs_¡İ_gc_th»ad
(
sbi
);

3660 
	`f2fs_¡İ_disÿrd_th»ad
(
sbi
);

3662 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_DIRTY
) ||

3663 !
	`is_£t_ck±_æags
(
sbi
, 
CP_UMOUNT_FLAG
)) {

3664 
ı_cÚŒŞ
 
ıc
 = {

3665 .
»asÚ
 = 
CP_UMOUNT
,

3667 
	`f2fs_wr™e_checkpošt
(
sbi
, &
ıc
);

3670 ià(
	`is_sbi_æag_£t
(
sbi
, 
SBI_IS_RECOVERED
è&& 
	`f2fs_»adÚly
(
sb
))

3671 
sb
->
s_æags
 &ğ~
SB_RDONLY
;

3673 
	`kl_block_su³r
(
sb
);

3674 
	}
}

3676 
fe_sy¡em_ty³
 
	gf2fs_fs_ty³
 = {

3677 .
owÃr
 = 
THIS_MODULE
,

3678 .
	gÇme
 = "f2fs",

3679 .
	gmouÁ
 = 
f2fs_mouÁ
,

3680 .
	gkl_sb
 = 
kl_f2fs_su³r
,

3681 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

3683 
MODULE_ALIAS_FS
("f2fs");

3685 
__š™
 
	$š™_šodeÿche
()

3687 
f2fs_šode_ÿch•
 = 
	`kmem_ÿche_ü—‹
("f2fs_inode_cache",

3688 (
f2fs_šode_šfo
), 0,

3689 
SLAB_RECLAIM_ACCOUNT
|
SLAB_ACCOUNT
, 
NULL
);

3690 ià(!
f2fs_šode_ÿch•
)

3691  -
ENOMEM
;

3693 
	}
}

3695 
	$de¡roy_šodeÿche
()

3701 
	`rcu_b¬r›r
();

3702 
	`kmem_ÿche_de¡roy
(
f2fs_šode_ÿch•
);

3703 
	}
}

3705 
__š™
 
	$š™_f2fs_fs
()

3707 
”r
;

3709 ià(
PAGE_SIZE
 !ğ
F2FS_BLKSIZE
) {

3710 
	`´štk
("F2FS‚ot supported on PAGE_SIZE(%lu) != %d\n",

3711 
PAGE_SIZE
, 
F2FS_BLKSIZE
);

3712  -
EINVAL
;

3715 
	`f2fs_bud_Œaû_ios
();

3717 
”r
 = 
	`š™_šodeÿche
();

3718 ià(
”r
)

3719 
ç
;

3720 
”r
 = 
	`f2fs_ü—‹_node_mªag”_ÿches
();

3721 ià(
”r
)

3722 
ä“_šodeÿche
;

3723 
”r
 = 
	`f2fs_ü—‹_£gm’t_mªag”_ÿches
();

3724 ià(
”r
)

3725 
ä“_node_mªag”_ÿches
;

3726 
”r
 = 
	`f2fs_ü—‹_checkpošt_ÿches
();

3727 ià(
”r
)

3728 
ä“_£gm’t_mªag”_ÿches
;

3729 
”r
 = 
	`f2fs_ü—‹_ex‹Á_ÿche
();

3730 ià(
”r
)

3731 
ä“_checkpošt_ÿches
;

3732 
”r
 = 
	`f2fs_š™_sysfs
();

3733 ià(
”r
)

3734 
ä“_ex‹Á_ÿche
;

3735 
”r
 = 
	`»gi¡”_shršk”
(&
f2fs_shršk”_šfo
);

3736 ià(
”r
)

3737 
ä“_sysfs
;

3738 
”r
 = 
	`»gi¡”_fesy¡em
(&
f2fs_fs_ty³
);

3739 ià(
”r
)

3740 
ä“_shršk”
;

3741 
	`f2fs_ü—‹_roÙ_¡©s
();

3742 
”r
 = 
	`f2fs_š™_po¡_»ad_´oûssšg
();

3743 ià(
”r
)

3744 
ä“_roÙ_¡©s
;

3747 
ä“_roÙ_¡©s
:

3748 
	`f2fs_de¡roy_roÙ_¡©s
();

3749 
	`uÄegi¡”_fesy¡em
(&
f2fs_fs_ty³
);

3750 
ä“_shršk”
:

3751 
	`uÄegi¡”_shršk”
(&
f2fs_shršk”_šfo
);

3752 
ä“_sysfs
:

3753 
	`f2fs_ex™_sysfs
();

3754 
ä“_ex‹Á_ÿche
:

3755 
	`f2fs_de¡roy_ex‹Á_ÿche
();

3756 
ä“_checkpošt_ÿches
:

3757 
	`f2fs_de¡roy_checkpošt_ÿches
();

3758 
ä“_£gm’t_mªag”_ÿches
:

3759 
	`f2fs_de¡roy_£gm’t_mªag”_ÿches
();

3760 
ä“_node_mªag”_ÿches
:

3761 
	`f2fs_de¡roy_node_mªag”_ÿches
();

3762 
ä“_šodeÿche
:

3763 
	`de¡roy_šodeÿche
();

3764 
ç
:

3765  
”r
;

3766 
	}
}

3768 
__ex™
 
	$ex™_f2fs_fs
()

3770 
	`f2fs_de¡roy_po¡_»ad_´oûssšg
();

3771 
	`f2fs_de¡roy_roÙ_¡©s
();

3772 
	`uÄegi¡”_fesy¡em
(&
f2fs_fs_ty³
);

3773 
	`uÄegi¡”_shršk”
(&
f2fs_shršk”_šfo
);

3774 
	`f2fs_ex™_sysfs
();

3775 
	`f2fs_de¡roy_ex‹Á_ÿche
();

3776 
	`f2fs_de¡roy_checkpošt_ÿches
();

3777 
	`f2fs_de¡roy_£gm’t_mªag”_ÿches
();

3778 
	`f2fs_de¡roy_node_mªag”_ÿches
();

3779 
	`de¡roy_šodeÿche
();

3780 
	`f2fs_de¡roy_Œaû_ios
();

3781 
	}
}

3783 
	$moduË_š™
(
š™_f2fs_fs
)

3784 
	$moduË_ex™
(
ex™_f2fs_fs
)

3786 
	`MODULE_AUTHOR
("Samsung Electronics's Praesto Team");

3787 
	`MODULE_DESCRIPTION
("Flash Friendly File System");

3788 
	`MODULE_LICENSE
("GPL");

	@sysfs.c

9 
	~<lšux/comp”.h
>

10 
	~<lšux/´oc_fs.h
>

11 
	~<lšux/f2fs_fs.h
>

12 
	~<lšux/£q_fe.h
>

13 
	~<lšux/unicode.h
>

15 
	~"f2fs.h
"

16 
	~"£gm’t.h
"

17 
	~"gc.h
"

19 
´oc_dœ_’Œy
 *
	gf2fs_´oc_roÙ
;

23 
	mGC_THREAD
,

24 
	mSM_INFO
,

25 
	mDCC_INFO
,

26 
	mNM_INFO
,

27 
	mF2FS_SBI
,

28 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


29 
	mFAULT_INFO_RATE
,

30 
	mFAULT_INFO_TYPE
,

32 
	mRESERVED_BLOCKS
,

35 
	sf2fs_©Œ
 {

36 
©Œibu‹
 
	m©Œ
;

37 
ssize_t
 (*
show
)(
	mf2fs_©Œ
 *, 
	mf2fs_sb_šfo
 *, *);

38 
ssize_t
 (*
¡Üe
)(
	mf2fs_©Œ
 *, 
	mf2fs_sb_šfo
 *,

39 cÚ¡ *, 
	msize_t
);

40 
	m¡ruù_ty³
;

41 
	moff£t
;

42 
	mid
;

45 *
	$__¡ruù_±r
(
f2fs_sb_šfo
 *
sbi
, 
¡ruù_ty³
)

47 ià(
¡ruù_ty³
 =ğ
GC_THREAD
)

48  (*)
sbi
->
gc_th»ad
;

49 ià(
¡ruù_ty³
 =ğ
SM_INFO
)

50  (*)
	`SM_I
(
sbi
);

51 ià(
¡ruù_ty³
 =ğ
DCC_INFO
)

52  (*)
	`SM_I
(
sbi
)->
dcc_šfo
;

53 ià(
¡ruù_ty³
 =ğ
NM_INFO
)

54  (*)
	`NM_I
(
sbi
);

55 ià(
¡ruù_ty³
 =ğ
F2FS_SBI
 || sŒuù_ty³ =ğ
RESERVED_BLOCKS
)

56  (*)
sbi
;

57 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


58 ià(
¡ruù_ty³
 =ğ
FAULT_INFO_RATE
 ||

59 
¡ruù_ty³
 =ğ
FAULT_INFO_TYPE
)

60  (*)&
	`F2FS_OPTION
(
sbi
).
çuÉ_šfo
;

62  
NULL
;

63 
	}
}

65 
ssize_t
 
	$dœty_£gm’ts_show
(
f2fs_©Œ
 *
a
,

66 
f2fs_sb_šfo
 *
sbi
, *
buf
)

68  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

69 ()(
	`dœty_£gm’ts
(
sbi
)));

70 
	}
}

72 
ssize_t
 
	$unu§bË_show
(
f2fs_©Œ
 *
a
,

73 
f2fs_sb_šfo
 *
sbi
, *
buf
)

75 
block_t
 
unu§bË
;

77 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_CHECKPOINT
))

78 
unu§bË
 = 
sbi
->
unu§bË_block_couÁ
;

80 
unu§bË
 = 
	`f2fs_g‘_unu§bË_blocks
(
sbi
);

81  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

82 ()
unu§bË
);

83 
	}
}

85 
ssize_t
 
	$’codšg_show
(
f2fs_©Œ
 *
a
,

86 
f2fs_sb_šfo
 *
sbi
, *
buf
)

88 #ifdeà
CONFIG_UNICODE


89 ià(
	`f2fs_sb_has_ÿ£fŞd
(
sbi
))

90  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s (%d.%d.%d)\n",

91 
sbi
->
s_’codšg
->
ch¬£t
,

92 (
sbi
->
s_’codšg
->
v”siÚ
 >> 16) & 0xff,

93 (
sbi
->
s_’codšg
->
v”siÚ
 >> 8) & 0xff,

94 
sbi
->
s_’codšg
->
v”siÚ
 & 0xff);

96  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "(none)");

97 
	}
}

99 
ssize_t
 
	$liãtime_wr™e_kby‹s_show
(
f2fs_©Œ
 *
a
,

100 
f2fs_sb_šfo
 *
sbi
, *
buf
)

102 
su³r_block
 *
sb
 = 
sbi
->sb;

104 ià(!
sb
->
s_bdev
->
bd_·¹
)

105  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "0\n");

107  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

108 ()(
sbi
->
kby‹s_wr™‹n
 +

109 
	`BD_PART_WRITTEN
(
sbi
)));

110 
	}
}

112 
ssize_t
 
	$ã©u»s_show
(
f2fs_©Œ
 *
a
,

113 
f2fs_sb_šfo
 *
sbi
, *
buf
)

115 
su³r_block
 *
sb
 = 
sbi
->sb;

116 
Ën
 = 0;

118 ià(!
sb
->
s_bdev
->
bd_·¹
)

119  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "0\n");

121 ià(
	`f2fs_sb_has_’üy±
(
sbi
))

122 
Ën
 +ğ
	`¢´štf
(
buf
, 
PAGE_SIZE
 -†en, "%s",

124 ià(
	`f2fs_sb_has_blkzÚed
(
sbi
))

125 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

126 
Ën
 ? ", " : "", "blkzoned");

127 ià(
	`f2fs_sb_has_exŒa_©Œ
(
sbi
))

128 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

129 
Ën
 ? ", " : "", "extra_attr");

130 ià(
	`f2fs_sb_has_´ojeù_quÙa
(
sbi
))

131 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

132 
Ën
 ? ", " : "", "projquota");

133 ià(
	`f2fs_sb_has_šode_chksum
(
sbi
))

134 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

135 
Ën
 ? ", " : "", "inode_checksum");

136 ià(
	`f2fs_sb_has_æexibË_šlše_x©Œ
(
sbi
))

137 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

138 
Ën
 ? ", " : "", "flexible_inline_xattr");

139 ià(
	`f2fs_sb_has_quÙa_šo
(
sbi
))

140 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

141 
Ën
 ? ", " : "", "quota_ino");

142 ià(
	`f2fs_sb_has_šode_ütime
(
sbi
))

143 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

144 
Ën
 ? ", " : "", "inode_crtime");

145 ià(
	`f2fs_sb_has_lo¡_found
(
sbi
))

146 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

147 
Ën
 ? ", " : "", "lost_found");

148 ià(
	`f2fs_sb_has_v”™y
(
sbi
))

149 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

150 
Ën
 ? ", " : "", "verity");

151 ià(
	`f2fs_sb_has_sb_chksum
(
sbi
))

152 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

153 
Ën
 ? ", " : "", "sb_checksum");

154 ià(
	`f2fs_sb_has_ÿ£fŞd
(
sbi
))

155 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s%s",

156 
Ën
 ? ", " : "", "casefold");

157 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "\n");

158  
Ën
;

159 
	}
}

161 
ssize_t
 
	$cu¼’t_»£rved_blocks_show
(
f2fs_©Œ
 *
a
,

162 
f2fs_sb_šfo
 *
sbi
, *
buf
)

164  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n", 
sbi
->
cu¼’t_»£rved_blocks
);

165 
	}
}

167 
ssize_t
 
	$f2fs_sbi_show
(
f2fs_©Œ
 *
a
,

168 
f2fs_sb_šfo
 *
sbi
, *
buf
)

170 *
±r
 = 
NULL
;

171 *
ui
;

173 
±r
 = 
	`__¡ruù_±r
(
sbi
, 
a
->
¡ruù_ty³
);

174 ià(!
±r
)

175  -
EINVAL
;

177 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "extension_list")) {

178 
	`__u8
 (*
exi¡
)[
F2FS_EXTENSION_LEN
] =

179 
sbi
->
¿w_su³r
->
ex‹nsiÚ_li¡
;

180 
cŞd_couÁ
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
);

181 
hÙ_couÁ
 = 
sbi
->
¿w_su³r
->
hÙ_ext_couÁ
;

182 
Ën
 = 0, 
i
;

184 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en,

186 
i
 = 0; i < 
cŞd_couÁ
; i++)

187 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s\n",

188 
exi¡
[
i
]);

190 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en,

192 
i
 = 
cŞd_couÁ
; i < cŞd_couÁ + 
hÙ_couÁ
; i++)

193 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
PAGE_SIZE
 -†en, "%s\n",

194 
exi¡
[
i
]);

195  
Ën
;

198 
ui
 = (*)(
±r
 + 
a
->
off£t
);

200  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n", *
ui
);

201 
	}
}

203 
ssize_t
 
	$__sbi_¡Üe
(
f2fs_©Œ
 *
a
,

204 
f2fs_sb_šfo
 *
sbi
,

205 cÚ¡ *
buf
, 
size_t
 
couÁ
)

207 *
±r
;

208 
t
;

209 *
ui
;

210 
ssize_t
 
»t
;

212 
±r
 = 
	`__¡ruù_±r
(
sbi
, 
a
->
¡ruù_ty³
);

213 ià(!
±r
)

214  -
EINVAL
;

216 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "extension_list")) {

217 cÚ¡ *
Çme
 = 
	`¡rim
((*)
buf
);

218 
boŞ
 
£t
 = 
Œue
, 
hÙ
;

220 ià(!
	`¡ºcmp
(
Çme
, "[h]", 3))

221 
hÙ
 = 
Œue
;

222 ià(!
	`¡ºcmp
(
Çme
, "[c]", 3))

223 
hÙ
 = 
çl£
;

225  -
EINVAL
;

227 
Çme
 += 3;

229 ià(*
Çme
 == '!') {

230 
Çme
++;

231 
£t
 = 
çl£
;

234 ià(
	`¡¾’
(
Çme
è>ğ
F2FS_EXTENSION_LEN
)

235  -
EINVAL
;

237 
	`down_wr™e
(&
sbi
->
sb_lock
);

239 
»t
 = 
	`f2fs_upd©e_ex‹nsiÚ_li¡
(
sbi
, 
Çme
, 
hÙ
, 
£t
);

240 ià(
»t
)

241 
out
;

243 
»t
 = 
	`f2fs_comm™_su³r
(
sbi
, 
çl£
);

244 ià(
»t
)

245 
	`f2fs_upd©e_ex‹nsiÚ_li¡
(
sbi
, 
Çme
, 
hÙ
, !
£t
);

246 
out
:

247 
	`up_wr™e
(&
sbi
->
sb_lock
);

248  
»t
 ?„‘ : 
couÁ
;

251 
ui
 = (*)(
±r
 + 
a
->
off£t
);

253 
»t
 = 
	`k¡¹oul
(
	`sk_¥aûs
(
buf
), 0, &
t
);

254 ià(
»t
 < 0)

255  
»t
;

256 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


257 ià(
a
->
¡ruù_ty³
 =ğ
FAULT_INFO_TYPE
 && 
t
 >ğ(1 << 
FAULT_MAX
))

258  -
EINVAL
;

259 ià(
a
->
¡ruù_ty³
 =ğ
FAULT_INFO_RATE
 && 
t
 >ğ
UINT_MAX
)

260  -
EINVAL
;

262 ià(
a
->
¡ruù_ty³
 =ğ
RESERVED_BLOCKS
) {

263 
	`¥š_lock
(&
sbi
->
¡©_lock
);

264 ià(
t
 > ()(
sbi
->
u£r_block_couÁ
 -

265 
	`F2FS_OPTION
(
sbi
).
roÙ_»£rved_blocks
)) {

266 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

267  -
EINVAL
;

269 *
ui
 = 
t
;

270 
sbi
->
cu¼’t_»£rved_blocks
 = 
	`mš
(sbi->
»£rved_blocks
,

271 
sbi
->
u£r_block_couÁ
 - 
	`v®id_u£r_blocks
(sbi));

272 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

273  
couÁ
;

276 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "discard_granularity")) {

277 ià(
t
 =ğ0 || > 
MAX_PLIST_NUM
)

278  -
EINVAL
;

279 ià(
t
 =ğ*
ui
)

280  
couÁ
;

281 *
ui
 = 
t
;

282  
couÁ
;

285 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "migration_granularity")) {

286 ià(
t
 =ğ0 || > 
sbi
->
£gs_³r_£c
)

287  -
EINVAL
;

290 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "trim_sections"))

291  -
EINVAL
;

293 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "gc_urgent")) {

294 ià(
t
 >= 1) {

295 
sbi
->
gc_mode
 = 
GC_URGENT
;

296 ià(
sbi
->
gc_th»ad
) {

297 
sbi
->
gc_th»ad
->
gc_wake
 = 1;

298 
	`wake_up_š‹¼u±ibË_®l
(

299 &
sbi
->
gc_th»ad
->
gc_wa™_queue_h—d
);

300 
	`wake_up_disÿrd_th»ad
(
sbi
, 
Œue
);

303 
sbi
->
gc_mode
 = 
GC_NORMAL
;

305  
couÁ
;

307 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "gc_idle")) {

308 ià(
t
 =ğ
GC_IDLE_CB
)

309 
sbi
->
gc_mode
 = 
GC_IDLE_CB
;

310 ià(
t
 =ğ
GC_IDLE_GREEDY
)

311 
sbi
->
gc_mode
 = 
GC_IDLE_GREEDY
;

313 
sbi
->
gc_mode
 = 
GC_NORMAL
;

314  
couÁ
;

318 ià(!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "iostat_enable")) {

319 
sbi
->
io¡©_’abË
 = !!
t
;

320 ià(!
sbi
->
io¡©_’abË
)

321 
	`f2fs_»£t_io¡©
(
sbi
);

322  
couÁ
;

325 *
ui
 = ()
t
;

327  
couÁ
;

328 
	}
}

330 
ssize_t
 
	$f2fs_sbi_¡Üe
(
f2fs_©Œ
 *
a
,

331 
f2fs_sb_šfo
 *
sbi
,

332 cÚ¡ *
buf
, 
size_t
 
couÁ
)

334 
ssize_t
 
»t
;

335 
boŞ
 
gc_’Œy
 = (!
	`¡rcmp
(
a
->
©Œ
.
Çme
, "gc_urgent") ||

336 
a
->
¡ruù_ty³
 =ğ
GC_THREAD
);

338 ià(
gc_’Œy
) {

339 ià(!
	`down_»ad_Œylock
(&
sbi
->
sb
->
s_umouÁ
))

340  -
EAGAIN
;

342 
»t
 = 
	`__sbi_¡Üe
(
a
, 
sbi
, 
buf
, 
couÁ
);

343 ià(
gc_’Œy
)

344 
	`up_»ad
(&
sbi
->
sb
->
s_umouÁ
);

346  
»t
;

347 
	}
}

349 
ssize_t
 
	$f2fs_©Œ_show
(
kobjeù
 *
kobj
,

350 
©Œibu‹
 *
©Œ
, *
buf
)

352 
f2fs_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, f2fs_sb_info,

353 
s_kobj
);

354 
f2fs_©Œ
 *
a
 = 
	`cÚš”_of
(
©Œ
, f2fs_attr,‡ttr);

356  
a
->
show
 ?‡->
	`show
×, 
sbi
, 
buf
) : 0;

357 
	}
}

359 
ssize_t
 
	$f2fs_©Œ_¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

360 cÚ¡ *
buf
, 
size_t
 
Ën
)

362 
f2fs_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, f2fs_sb_info,

363 
s_kobj
);

364 
f2fs_©Œ
 *
a
 = 
	`cÚš”_of
(
©Œ
, f2fs_attr,‡ttr);

366  
a
->
¡Üe
 ?‡->
	`¡Üe
×, 
sbi
, 
buf
, 
Ën
) : 0;

367 
	}
}

369 
	$f2fs_sb_»Ëa£
(
kobjeù
 *
kobj
)

371 
f2fs_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, f2fs_sb_info,

372 
s_kobj
);

373 
	`com¶‘e
(&
sbi
->
s_kobj_uÄegi¡”
);

374 
	}
}

376 
	eã©_id
 {

377 
	mFEAT_CRYPTO
 = 0,

378 
	mFEAT_BLKZONED
,

379 
	mFEAT_ATOMIC_WRITE
,

380 
	mFEAT_EXTRA_ATTR
,

381 
	mFEAT_PROJECT_QUOTA
,

382 
	mFEAT_INODE_CHECKSUM
,

383 
	mFEAT_FLEXIBLE_INLINE_XATTR
,

384 
	mFEAT_QUOTA_INO
,

385 
	mFEAT_INODE_CRTIME
,

386 
	mFEAT_LOST_FOUND
,

387 
	mFEAT_VERITY
,

388 
	mFEAT_SB_CHECKSUM
,

389 
	mFEAT_CASEFOLD
,

392 
ssize_t
 
	$f2fs_ã©u»_show
(
f2fs_©Œ
 *
a
,

393 
f2fs_sb_šfo
 *
sbi
, *
buf
)

395 
a
->
id
) {

396 
FEAT_CRYPTO
:

397 
FEAT_BLKZONED
:

398 
FEAT_ATOMIC_WRITE
:

399 
FEAT_EXTRA_ATTR
:

400 
FEAT_PROJECT_QUOTA
:

401 
FEAT_INODE_CHECKSUM
:

402 
FEAT_FLEXIBLE_INLINE_XATTR
:

403 
FEAT_QUOTA_INO
:

404 
FEAT_INODE_CRTIME
:

405 
FEAT_LOST_FOUND
:

406 
FEAT_VERITY
:

407 
FEAT_SB_CHECKSUM
:

408 
FEAT_CASEFOLD
:

409  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "supported\n");

412 
	}
}

414 
	#F2FS_ATTR_OFFSET
(
_¡ruù_ty³
, 
_Çme
, 
_mode
, 
_show
, 
_¡Üe
, 
_off£t
) \

415 
f2fs_©Œ
 
f2fs_©Œ_
##
_Çme
 = { \

416 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

417 .
show
 = 
_show
, \

418 .
¡Üe
 = 
_¡Üe
, \

419 .
¡ruù_ty³
 = 
_¡ruù_ty³
, \

420 .
off£t
 = 
_off£t
 \

421 }

	)

423 
	#F2FS_RW_ATTR
(
¡ruù_ty³
, 
¡ruù_Çme
, 
Çme
, 
–Çme
) \

424 
	`F2FS_ATTR_OFFSET
(
¡ruù_ty³
, 
Çme
, 0644, \

425 
f2fs_sbi_show
, 
f2fs_sbi_¡Üe
, \

426 
	`off£tof
(
¡ruù_Çme
, 
–Çme
))

	)

428 
	#F2FS_GENERAL_RO_ATTR
(
Çme
) \

429 
f2fs_©Œ
 
f2fs_©Œ_
##
Çme
 = 
	`__ATTR
Òame, 0444,‚ame##
_show
, 
NULL
)

	)

431 
	#F2FS_FEATURE_RO_ATTR
(
_Çme
, 
_id
) \

432 
f2fs_©Œ
 
f2fs_©Œ_
##
_Çme
 = { \

433 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 0444 }, \

434 .
show
 = 
f2fs_ã©u»_show
, \

435 .
id
 = 
_id
, \

436 }

	)

438 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_urg’t_¦“p_time
,

439 
urg’t_¦“p_time
);

440 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_mš_¦“p_time
, 
mš_¦“p_time
);

441 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_max_¦“p_time
, 
max_¦“p_time
);

442 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_no_gc_¦“p_time
, 
no_gc_¦“p_time
);

443 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
gc_idË
, 
gc_mode
);

444 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
gc_urg’t
, 
gc_mode
);

445 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
»şaim_£gm’ts
, 
»c_´eä“_£gm’ts
);

446 
F2FS_RW_ATTR
(
DCC_INFO
, 
disÿrd_cmd_cÚŒŞ
, 
max_sm®l_disÿrds
, 
max_disÿrds
);

447 
F2FS_RW_ATTR
(
DCC_INFO
, 
disÿrd_cmd_cÚŒŞ
, 
disÿrd_g¿nuÏr™y
, discard_granularity);

448 
F2FS_RW_ATTR
(
RESERVED_BLOCKS
, 
f2fs_sb_šfo
, 
»£rved_blocks
,„eserved_blocks);

449 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
b©ched_Œim_£ùiÚs
, 
Œim_£ùiÚs
);

450 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
u_pŞicy
, ipu_policy);

451 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_u_ut
, min_ipu_util);

452 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_fsync_blocks
, min_fsync_blocks);

453 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_£q_blocks
, min_seq_blocks);

454 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_hÙ_blocks
, min_hot_blocks);

455 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_s¤_£ùiÚs
, min_ssr_sections);

456 
F2FS_RW_ATTR
(
NM_INFO
, 
f2fs_nm_šfo
, 
¿m_th»sh
,„am_thresh);

457 
F2FS_RW_ATTR
(
NM_INFO
, 
f2fs_nm_šfo
, 
¿_nid_·ges
,„a_nid_pages);

458 
F2FS_RW_ATTR
(
NM_INFO
, 
f2fs_nm_šfo
, 
dœty_Çts_¿tio
, dirty_nats_ratio);

459 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
max_viùim_£¬ch
, max_victim_search);

460 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
mig¿tiÚ_g¿nuÏr™y
, migration_granularity);

461 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
dœ_Ëv–
, dir_level);

462 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
ı_š‹rv®
, 
š‹rv®_time
[
CP_TIME
]);

463 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
idË_š‹rv®
, 
š‹rv®_time
[
REQ_TIME
]);

464 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
disÿrd_idË_š‹rv®
,

465 
š‹rv®_time
[
DISCARD_TIME
]);

466 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
gc_idË_š‹rv®
, 
š‹rv®_time
[
GC_TIME
]);

467 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
,

468 
umouÁ_disÿrd_timeout
, 
š‹rv®_time
[
UMOUNT_DISCARD_TIMEOUT
]);

469 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
io¡©_’abË
, iostat_enable);

470 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
»addœ_¿
,„eaddir_ra);

471 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
gc_pš_fe_th»sh
, 
gc_pš_fe_th»shŞd
);

472 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_su³r_block
, 
ex‹nsiÚ_li¡
,ƒxtension_list);

473 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


474 
F2FS_RW_ATTR
(
FAULT_INFO_RATE
, 
f2fs_çuÉ_šfo
, 
šjeù_¿‹
, inject_rate);

475 
F2FS_RW_ATTR
(
FAULT_INFO_TYPE
, 
f2fs_çuÉ_šfo
, 
šjeù_ty³
, inject_type);

477 
F2FS_GENERAL_RO_ATTR
(
dœty_£gm’ts
);

478 
F2FS_GENERAL_RO_ATTR
(
liãtime_wr™e_kby‹s
);

479 
F2FS_GENERAL_RO_ATTR
(
ã©u»s
);

480 
F2FS_GENERAL_RO_ATTR
(
cu¼’t_»£rved_blocks
);

481 
F2FS_GENERAL_RO_ATTR
(
unu§bË
);

482 
F2FS_GENERAL_RO_ATTR
(
’codšg
);

484 #ifdeà
CONFIG_FS_ENCRYPTION


485 
F2FS_FEATURE_RO_ATTR
(
’üy±iÚ
, 
FEAT_CRYPTO
);

487 #ifdeà
CONFIG_BLK_DEV_ZONED


488 
F2FS_FEATURE_RO_ATTR
(
block_zÚed
, 
FEAT_BLKZONED
);

490 
F2FS_FEATURE_RO_ATTR
(
©omic_wr™e
, 
FEAT_ATOMIC_WRITE
);

491 
F2FS_FEATURE_RO_ATTR
(
exŒa_©Œ
, 
FEAT_EXTRA_ATTR
);

492 
F2FS_FEATURE_RO_ATTR
(
´ojeù_quÙa
, 
FEAT_PROJECT_QUOTA
);

493 
F2FS_FEATURE_RO_ATTR
(
šode_checksum
, 
FEAT_INODE_CHECKSUM
);

494 
F2FS_FEATURE_RO_ATTR
(
æexibË_šlše_x©Œ
, 
FEAT_FLEXIBLE_INLINE_XATTR
);

495 
F2FS_FEATURE_RO_ATTR
(
quÙa_šo
, 
FEAT_QUOTA_INO
);

496 
F2FS_FEATURE_RO_ATTR
(
šode_ütime
, 
FEAT_INODE_CRTIME
);

497 
F2FS_FEATURE_RO_ATTR
(
lo¡_found
, 
FEAT_LOST_FOUND
);

498 #ifdeà
CONFIG_FS_VERITY


499 
F2FS_FEATURE_RO_ATTR
(
v”™y
, 
FEAT_VERITY
);

501 
F2FS_FEATURE_RO_ATTR
(
sb_checksum
, 
FEAT_SB_CHECKSUM
);

502 
F2FS_FEATURE_RO_ATTR
(
ÿ£fŞd
, 
FEAT_CASEFOLD
);

504 
	#ATTR_LIST
(
Çme
è(&
f2fs_©Œ_
##Çme.
©Œ
)

	)

505 
©Œibu‹
 *
	gf2fs_©Œs
[] = {

506 
ATTR_LIST
(
gc_urg’t_¦“p_time
),

507 
ATTR_LIST
(
gc_mš_¦“p_time
),

508 
ATTR_LIST
(
gc_max_¦“p_time
),

509 
ATTR_LIST
(
gc_no_gc_¦“p_time
),

510 
ATTR_LIST
(
gc_idË
),

511 
ATTR_LIST
(
gc_urg’t
),

512 
ATTR_LIST
(
»şaim_£gm’ts
),

513 
ATTR_LIST
(
max_sm®l_disÿrds
),

514 
ATTR_LIST
(
disÿrd_g¿nuÏr™y
),

515 
ATTR_LIST
(
b©ched_Œim_£ùiÚs
),

516 
ATTR_LIST
(
u_pŞicy
),

517 
ATTR_LIST
(
mš_u_ut
),

518 
ATTR_LIST
(
mš_fsync_blocks
),

519 
ATTR_LIST
(
mš_£q_blocks
),

520 
ATTR_LIST
(
mš_hÙ_blocks
),

521 
ATTR_LIST
(
mš_s¤_£ùiÚs
),

522 
ATTR_LIST
(
max_viùim_£¬ch
),

523 
ATTR_LIST
(
mig¿tiÚ_g¿nuÏr™y
),

524 
ATTR_LIST
(
dœ_Ëv–
),

525 
ATTR_LIST
(
¿m_th»sh
),

526 
ATTR_LIST
(
¿_nid_·ges
),

527 
ATTR_LIST
(
dœty_Çts_¿tio
),

528 
ATTR_LIST
(
ı_š‹rv®
),

529 
ATTR_LIST
(
idË_š‹rv®
),

530 
ATTR_LIST
(
disÿrd_idË_š‹rv®
),

531 
ATTR_LIST
(
gc_idË_š‹rv®
),

532 
ATTR_LIST
(
umouÁ_disÿrd_timeout
),

533 
ATTR_LIST
(
io¡©_’abË
),

534 
ATTR_LIST
(
»addœ_¿
),

535 
ATTR_LIST
(
gc_pš_fe_th»sh
),

536 
ATTR_LIST
(
ex‹nsiÚ_li¡
),

537 #ifdeà
CONFIG_F2FS_FAULT_INJECTION


538 
ATTR_LIST
(
šjeù_¿‹
),

539 
ATTR_LIST
(
šjeù_ty³
),

541 
ATTR_LIST
(
dœty_£gm’ts
),

542 
ATTR_LIST
(
unu§bË
),

543 
ATTR_LIST
(
liãtime_wr™e_kby‹s
),

544 
ATTR_LIST
(
ã©u»s
),

545 
ATTR_LIST
(
»£rved_blocks
),

546 
ATTR_LIST
(
cu¼’t_»£rved_blocks
),

547 
ATTR_LIST
(
’codšg
),

548 
NULL
,

550 
ATTRIBUTE_GROUPS
(
f2fs
);

552 
©Œibu‹
 *
	gf2fs_ã©_©Œs
[] = {

553 #ifdeà
CONFIG_FS_ENCRYPTION


554 
ATTR_LIST
(
’üy±iÚ
),

556 #ifdeà
CONFIG_BLK_DEV_ZONED


557 
ATTR_LIST
(
block_zÚed
),

559 
ATTR_LIST
(
©omic_wr™e
),

560 
ATTR_LIST
(
exŒa_©Œ
),

561 
ATTR_LIST
(
´ojeù_quÙa
),

562 
ATTR_LIST
(
šode_checksum
),

563 
ATTR_LIST
(
æexibË_šlše_x©Œ
),

564 
ATTR_LIST
(
quÙa_šo
),

565 
ATTR_LIST
(
šode_ütime
),

566 
ATTR_LIST
(
lo¡_found
),

567 #ifdeà
CONFIG_FS_VERITY


568 
ATTR_LIST
(
v”™y
),

570 
ATTR_LIST
(
sb_checksum
),

571 
ATTR_LIST
(
ÿ£fŞd
),

572 
NULL
,

574 
ATTRIBUTE_GROUPS
(
f2fs_ã©
);

576 cÚ¡ 
sysfs_İs
 
	gf2fs_©Œ_İs
 = {

577 .
show
 = 
f2fs_©Œ_show
,

578 .
	g¡Üe
 = 
f2fs_©Œ_¡Üe
,

581 
kobj_ty³
 
	gf2fs_sb_kty³
 = {

582 .
deçuÉ_groups
 = 
f2fs_groups
,

583 .
	gsysfs_İs
 = &
f2fs_©Œ_İs
,

584 .
	g»Ëa£
 = 
f2fs_sb_»Ëa£
,

587 
kobj_ty³
 
	gf2fs_kty³
 = {

588 .
sysfs_İs
 = &
f2fs_©Œ_İs
,

591 
k£t
 
	gf2fs_k£t
 = {

592 .
kobj
 = {.
kty³
 = &
f2fs_kty³
},

595 
kobj_ty³
 
	gf2fs_ã©_kty³
 = {

596 .
deçuÉ_groups
 = 
f2fs_ã©_groups
,

597 .
	gsysfs_İs
 = &
f2fs_©Œ_İs
,

600 
kobjeù
 
	gf2fs_ã©
 = {

601 .
k£t
 = &
f2fs_k£t
,

604 
__maybe_unu£d
 
	$£gm’t_šfo_£q_show
(
£q_fe
 *
£q
,

605 *
off£t
)

607 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

608 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

609 
tÙ®_£gs
 =

610 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
£gm’t_couÁ_maš
);

611 
i
;

613 
	`£q_puts
(
£q
, "format: segment_type|valid_blocks\n"

616 
i
 = 0; i < 
tÙ®_£gs
; i++) {

617 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
i
);

619 ià((
i
 % 10) == 0)

620 
	`£q_´štf
(
£q
, "%-10d", 
i
);

621 
	`£q_´štf
(
£q
, "%d|%-3u", 
£
->
ty³
, se->
v®id_blocks
);

622 ià((
i
 % 10è=ğ9 || i =ğ(
tÙ®_£gs
 - 1))

623 
	`£q_putc
(
£q
, '\n');

625 
	`£q_putc
(
£q
, ' ');

629 
	}
}

631 
__maybe_unu£d
 
	$£gm’t_b™s_£q_show
(
£q_fe
 *
£q
,

632 *
off£t
)

634 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

635 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

636 
tÙ®_£gs
 =

637 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
£gm’t_couÁ_maš
);

638 
i
, 
j
;

640 
	`£q_puts
(
£q
, "format: segment_type|valid_blocks|bitmaps\n"

643 
i
 = 0; i < 
tÙ®_£gs
; i++) {

644 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
i
);

646 
	`£q_´štf
(
£q
, "%-10d", 
i
);

647 
	`£q_´štf
(
£q
, "%d|%-3u|", 
£
->
ty³
, se->
v®id_blocks
);

648 
j
 = 0; j < 
SIT_VBLOCK_MAP_SIZE
; j++)

649 
	`£q_´štf
(
£q
, " %.2x", 
£
->
cur_v®id_m­
[
j
]);

650 
	`£q_putc
(
£q
, '\n');

653 
	}
}

655 
__maybe_unu£d
 
	$io¡©_šfo_£q_show
(
£q_fe
 *
£q
,

656 *
off£t
)

658 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

659 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

660 
time64_t
 
now
 = 
	`ktime_g‘_»®_£cÚds
();

662 ià(!
sbi
->
io¡©_’abË
)

665 
	`£q_´štf
(
£q
, "time: %-16Îu\n", 
now
);

668 
	`£q_´štf
(
£q
, "app buffered: %-16llu\n",

669 
sbi
->
wr™e_io¡©
[
APP_BUFFERED_IO
]);

670 
	`£q_´štf
(
£q
, "app direct: %-16llu\n",

671 
sbi
->
wr™e_io¡©
[
APP_DIRECT_IO
]);

672 
	`£q_´štf
(
£q
, "app mapped: %-16llu\n",

673 
sbi
->
wr™e_io¡©
[
APP_MAPPED_IO
]);

676 
	`£q_´štf
(
£q
, "fs data: %-16llu\n",

677 
sbi
->
wr™e_io¡©
[
FS_DATA_IO
]);

678 
	`£q_´štf
(
£q
, "fs‚ode: %-16llu\n",

679 
sbi
->
wr™e_io¡©
[
FS_NODE_IO
]);

680 
	`£q_´štf
(
£q
, "fs meta: %-16llu\n",

681 
sbi
->
wr™e_io¡©
[
FS_META_IO
]);

682 
	`£q_´štf
(
£q
, "fs gc data: %-16llu\n",

683 
sbi
->
wr™e_io¡©
[
FS_GC_DATA_IO
]);

684 
	`£q_´štf
(
£q
, "fs gc‚ode: %-16llu\n",

685 
sbi
->
wr™e_io¡©
[
FS_GC_NODE_IO
]);

686 
	`£q_´štf
(
£q
, "fs cp data: %-16llu\n",

687 
sbi
->
wr™e_io¡©
[
FS_CP_DATA_IO
]);

688 
	`£q_´štf
(
£q
, "fs cp‚ode: %-16llu\n",

689 
sbi
->
wr™e_io¡©
[
FS_CP_NODE_IO
]);

690 
	`£q_´štf
(
£q
, "fs cp meta: %-16llu\n",

691 
sbi
->
wr™e_io¡©
[
FS_CP_META_IO
]);

692 
	`£q_´štf
(
£q
, "fs discard: %-16llu\n",

693 
sbi
->
wr™e_io¡©
[
FS_DISCARD
]);

696 
	}
}

698 
__maybe_unu£d
 
	$viùim_b™s_£q_show
(
£q_fe
 *
£q
,

699 *
off£t
)

701 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

702 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

703 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

704 
i
;

706 
	`£q_puts
(
£q
, "format: victim_secmap bitmaps\n");

708 
i
 = 0; i < 
	`MAIN_SECS
(
sbi
); i++) {

709 ià((
i
 % 10) == 0)

710 
	`£q_´štf
(
£q
, "%-10d", 
i
);

711 
	`£q_´štf
(
£q
, "%d", 
	`‹¡_b™
(
i
, 
dœty_i
->
viùim_£cm­
) ? 1 : 0);

712 ià((
i
 % 10è=ğ9 || i =ğ(
	`MAIN_SECS
(
sbi
) - 1))

713 
	`£q_putc
(
£q
, '\n');

715 
	`£q_putc
(
£q
, ' ');

718 
	}
}

720 
__š™
 
	$f2fs_š™_sysfs
()

722 
»t
;

724 
	`kobjeù_£t_Çme
(&
f2fs_k£t
.
kobj
, "f2fs");

725 
f2fs_k£t
.
kobj
.
·»Á
 = 
fs_kobj
;

726 
»t
 = 
	`k£t_»gi¡”
(&
f2fs_k£t
);

727 ià(
»t
)

728  
»t
;

730 
»t
 = 
	`kobjeù_š™_ªd_add
(&
f2fs_ã©
, &
f2fs_ã©_kty³
,

731 
NULL
, "features");

732 ià(
»t
)

733 
	`k£t_uÄegi¡”
(&
f2fs_k£t
);

735 
f2fs_´oc_roÙ
 = 
	`´oc_mkdœ
("fs/f2fs", 
NULL
);

736  
»t
;

737 
	}
}

739 
	$f2fs_ex™_sysfs
()

741 
	`kobjeù_put
(&
f2fs_ã©
);

742 
	`k£t_uÄegi¡”
(&
f2fs_k£t
);

743 
	`»move_´oc_’Œy
("fs/f2fs", 
NULL
);

744 
f2fs_´oc_roÙ
 = 
NULL
;

745 
	}
}

747 
	$f2fs_»gi¡”_sysfs
(
f2fs_sb_šfo
 *
sbi
)

749 
su³r_block
 *
sb
 = 
sbi
->sb;

750 
”r
;

752 
sbi
->
s_kobj
.
k£t
 = &
f2fs_k£t
;

753 
	`š™_com¶‘iÚ
(&
sbi
->
s_kobj_uÄegi¡”
);

754 
”r
 = 
	`kobjeù_š™_ªd_add
(&
sbi
->
s_kobj
, &
f2fs_sb_kty³
, 
NULL
,

755 "%s", 
sb
->
s_id
);

756 ià(
”r
)

757  
”r
;

759 ià(
f2fs_´oc_roÙ
)

760 
sbi
->
s_´oc
 = 
	`´oc_mkdœ
(
sb
->
s_id
, 
f2fs_´oc_roÙ
);

762 ià(
sbi
->
s_´oc
) {

763 
	`´oc_ü—‹_sšgË_d©a
("£gm’t_šfo", 
S_IRUGO
, 
sbi
->
s_´oc
,

764 
£gm’t_šfo_£q_show
, 
sb
);

765 
	`´oc_ü—‹_sšgË_d©a
("£gm’t_b™s", 
S_IRUGO
, 
sbi
->
s_´oc
,

766 
£gm’t_b™s_£q_show
, 
sb
);

767 
	`´oc_ü—‹_sšgË_d©a
("io¡©_šfo", 
S_IRUGO
, 
sbi
->
s_´oc
,

768 
io¡©_šfo_£q_show
, 
sb
);

769 
	`´oc_ü—‹_sšgË_d©a
("viùim_b™s", 
S_IRUGO
, 
sbi
->
s_´oc
,

770 
viùim_b™s_£q_show
, 
sb
);

773 
	}
}

775 
	$f2fs_uÄegi¡”_sysfs
(
f2fs_sb_šfo
 *
sbi
)

777 ià(
sbi
->
s_´oc
) {

778 
	`»move_´oc_’Œy
("io¡©_šfo", 
sbi
->
s_´oc
);

779 
	`»move_´oc_’Œy
("£gm’t_šfo", 
sbi
->
s_´oc
);

780 
	`»move_´oc_’Œy
("£gm’t_b™s", 
sbi
->
s_´oc
);

781 
	`»move_´oc_’Œy
("viùim_b™s", 
sbi
->
s_´oc
);

782 
	`»move_´oc_’Œy
(
sbi
->
sb
->
s_id
, 
f2fs_´oc_roÙ
);

784 
	`kobjeù_d–
(&
sbi
->
s_kobj
);

785 
	}
}

	@trace.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/f2fs_fs.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/¿dix-Œ“.h
>

13 
	~"f2fs.h
"

14 
	~"Œaû.h
"

16 
RADIX_TREE
(
pids
, 
GFP_ATOMIC
);

17 
¥šlock_t
 
	gpids_lock
;

18 
Ï¡_io_šfo
 
	gÏ¡_io
;

20 
šlše
 
	$__´št_Ï¡_io
()

22 ià(!
Ï¡_io
.
Ën
)

25 
	`Œaû_´štk
("%3x:%3x %4x %-16s %2x %5x %5x %12x %4x\n",

26 
Ï¡_io
.
majÜ
,†a¡_io.
mšÜ
,

27 
Ï¡_io
.
pid
, "----------------",

28 
Ï¡_io
.
ty³
,

29 
Ï¡_io
.
fio
.
İ
,†a¡_io.fio.
İ_æags
,

30 
Ï¡_io
.
fio
.
Ãw_blkaddr
,

31 
Ï¡_io
.
Ën
);

32 
	`mem£t
(&
Ï¡_io
, 0, (last_io));

33 
	}
}

35 
	$__fe_ty³
(
šode
 *šode, 
pid_t
 
pid
)

37 ià(
	`f2fs_is_©omic_fe
(
šode
))

38  
__ATOMIC_FILE
;

39 ià(
	`f2fs_is_vŞ©e_fe
(
šode
))

40  
__VOLATILE_FILE
;

41 ià(
	`S_ISDIR
(
šode
->
i_mode
))

42  
__DIR_FILE
;

43 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
	`F2FS_I_SB
(inode)))

44  
__NODE_FILE
;

45 ià(
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
	`F2FS_I_SB
(inode)))

46  
__META_FILE
;

47 ià(
pid
)

48  
__NORMAL_FILE
;

50  
__MISC_FILE
;

51 
	}
}

53 
	$f2fs_Œaû_pid
(
·ge
 *page)

55 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

56 
pid_t
 
pid
 = 
	`sk_pid_Ä
(
cu¼’t
);

57 *
p
;

59 
	`£t_·ge_´iv©e
(
·ge
, ()
pid
);

61 
»Œy
:

62 ià(
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
))

65 
	`¥š_lock
(&
pids_lock
);

66 
p
 = 
	`¿dix_Œ“_lookup
(&
pids
, 
pid
);

67 ià(
p
 =ğ
cu¼’t
)

68 
out
;

69 ià(
p
)

70 
	`¿dix_Œ“_d–‘e
(&
pids
, 
pid
);

72 ià(
	`¿dix_Œ“_š£¹
(&
pids
, 
pid
, 
cu¼’t
)) {

73 
	`¥š_uÆock
(&
pids_lock
);

74 
	`¿dix_Œ“_´–ßd_’d
();

75 
	`cÚd_»sched
();

76 
»Œy
;

79 
	`Œaû_´štk
("%3x:%3x %4x %-16s\n",

80 
	`MAJOR
(
šode
->
i_sb
->
s_dev
), 
	`MINOR
(inode->i_sb->s_dev),

81 
pid
, 
cu¼’t
->
comm
);

82 
out
:

83 
	`¥š_uÆock
(&
pids_lock
);

84 
	`¿dix_Œ“_´–ßd_’d
();

85 
	}
}

87 
	$f2fs_Œaû_ios
(
f2fs_io_šfo
 *
fio
, 
æush
)

89 
šode
 *inode;

90 
pid_t
 
pid
;

91 
majÜ
, 
mšÜ
;

93 ià(
æush
) {

94 
	`__´št_Ï¡_io
();

98 
šode
 = 
fio
->
·ge
->
m­pšg
->
ho¡
;

99 
pid
 = 
	`·ge_´iv©e
(
fio
->
·ge
);

101 
majÜ
 = 
	`MAJOR
(
šode
->
i_sb
->
s_dev
);

102 
mšÜ
 = 
	`MINOR
(
šode
->
i_sb
->
s_dev
);

104 ià(
Ï¡_io
.
majÜ
 =ğmajÜ &&†a¡_io.
mšÜ
 == minor &&

105 
Ï¡_io
.
pid
 ==…id &&

106 
Ï¡_io
.
ty³
 =ğ
	`__fe_ty³
(
šode
, 
pid
) &&

107 
Ï¡_io
.
fio
.
İ
 == fio->op &&

108 
Ï¡_io
.
fio
.
İ_æags
 == fio->op_flags &&

109 
Ï¡_io
.
fio
.
Ãw_blkaddr
 +†a¡_io.
Ën
 ==

110 
fio
->
Ãw_blkaddr
) {

111 
Ï¡_io
.
Ën
++;

115 
	`__´št_Ï¡_io
();

117 
Ï¡_io
.
majÜ
 = major;

118 
Ï¡_io
.
mšÜ
 = minor;

119 
Ï¡_io
.
pid
 =…id;

120 
Ï¡_io
.
ty³
 = 
	`__fe_ty³
(
šode
, 
pid
);

121 
Ï¡_io
.
fio
 = *fio;

122 
Ï¡_io
.
Ën
 = 1;

124 
	}
}

126 
	$f2fs_bud_Œaû_ios
()

128 
	`¥š_lock_š™
(&
pids_lock
);

129 
	}
}

131 
	#PIDVEC_SIZE
 128

	)

132 
	$gªg_lookup_pids
(
pid_t
 *
»suÉs
, 
fœ¡_šdex
,

133 
max_™ems
)

135 
¿dix_Œ“_™”
 
™”
;

136 **
¦Ù
;

137 
»t
 = 0;

139 ià(
	`uÆik–y
(!
max_™ems
))

142 
	`¿dix_Œ“_fÜ_—ch_¦Ù
(
¦Ù
, &
pids
, &
™”
, 
fœ¡_šdex
) {

143 
»suÉs
[
»t
] = 
™”
.
šdex
;

144 ià(++
»t
 =ğ
max_™ems
)

147  
»t
;

148 
	}
}

150 
	$f2fs_de¡roy_Œaû_ios
()

152 
pid_t
 
pid
[
PIDVEC_SIZE
];

153 
pid_t
 
Ãxt_pid
 = 0;

154 
found
;

156 
	`¥š_lock
(&
pids_lock
);

157 (
found
 = 
	`gªg_lookup_pids
(
pid
, 
Ãxt_pid
, 
PIDVEC_SIZE
))) {

158 
idx
;

160 
Ãxt_pid
 = 
pid
[
found
 - 1] + 1;

161 
idx
 = 0; idx < 
found
; idx++)

162 
	`¿dix_Œ“_d–‘e
(&
pids
, 
pid
[
idx
]);

164 
	`¥š_uÆock
(&
pids_lock
);

165 
	}
}

	@trace.h

8 #iâdeà
__F2FS_TRACE_H__


9 
	#__F2FS_TRACE_H__


	)

11 #ifdeà
CONFIG_F2FS_IO_TRACE


12 
	~<Œaû/ev’ts/f2fs.h
>

14 
	efe_ty³
 {

15 
	m__NORMAL_FILE
,

16 
	m__DIR_FILE
,

17 
	m__NODE_FILE
,

18 
	m__META_FILE
,

19 
	m__ATOMIC_FILE
,

20 
	m__VOLATILE_FILE
,

21 
	m__MISC_FILE
,

24 
	sÏ¡_io_šfo
 {

25 
	mmajÜ
, 
	mmšÜ
;

26 
pid_t
 
	mpid
;

27 
fe_ty³
 
	mty³
;

28 
f2fs_io_šfo
 
	mfio
;

29 
block_t
 
	mËn
;

32 
f2fs_Œaû_pid
(
·ge
 *);

33 
f2fs_Œaû_ios
(
f2fs_io_šfo
 *, );

34 
f2fs_bud_Œaû_ios
();

35 
f2fs_de¡roy_Œaû_ios
();

37 
	#f2fs_Œaû_pid
(
p
)

	)

38 
	#f2fs_Œaû_ios
(
i
, 
n
)

	)

39 
	#f2fs_bud_Œaû_ios
()

	)

40 
	#f2fs_de¡roy_Œaû_ios
()

	)

	@verity.c

27 
	~<lšux/f2fs_fs.h
>

29 
	~"f2fs.h
"

30 
	~"x©Œ.h
"

32 
šlše
 
loff_t
 
	$f2fs_v”™y_m‘ad©a_pos
(cÚ¡ 
šode
 *inode)

34  
	`round_up
(
šode
->
i_size
, 65536);

35 
	}
}

41 
	$·geÿche_»ad
(
šode
 *šode, *
buf
, 
size_t
 
couÁ
,

42 
loff_t
 
pos
)

44 
couÁ
) {

45 
size_t
 
n
 = 
	`mš_t
(size_t, 
couÁ
,

46 
PAGE_SIZE
 - 
	`off£t_š_·ge
(
pos
));

47 
·ge
 *page;

48 *
addr
;

50 
·ge
 = 
	`»ad_m­pšg_·ge
(
šode
->
i_m­pšg
, 
pos
 >> 
PAGE_SHIFT
,

51 
NULL
);

52 ià(
	`IS_ERR
(
·ge
))

53  
	`PTR_ERR
(
·ge
);

55 
addr
 = 
	`km­_©omic
(
·ge
);

56 
	`memıy
(
buf
, 
addr
 + 
	`off£t_š_·ge
(
pos
), 
n
);

57 
	`kunm­_©omic
(
addr
);

59 
	`put_·ge
(
·ge
);

61 
buf
 +ğ
n
;

62 
pos
 +ğ
n
;

63 
couÁ
 -ğ
n
;

66 
	}
}

72 
	$·geÿche_wr™e
(
šode
 *šode, cÚ¡ *
buf
, 
size_t
 
couÁ
,

73 
loff_t
 
pos
)

75 ià(
pos
 + 
couÁ
 > 
šode
->
i_sb
->
s_maxby‹s
)

76  -
EFBIG
;

78 
couÁ
) {

79 
size_t
 
n
 = 
	`mš_t
(size_t, 
couÁ
,

80 
PAGE_SIZE
 - 
	`off£t_š_·ge
(
pos
));

81 
·ge
 *page;

82 *
fsd©a
;

83 *
addr
;

84 
»s
;

86 
»s
 = 
	`·geÿche_wr™e_begš
(
NULL
, 
šode
->
i_m­pšg
, 
pos
, 
n
, 0,

87 &
·ge
, &
fsd©a
);

88 ià(
»s
)

89  
»s
;

91 
addr
 = 
	`km­_©omic
(
·ge
);

92 
	`memıy
(
addr
 + 
	`off£t_š_·ge
(
pos
), 
buf
, 
n
);

93 
	`kunm­_©omic
(
addr
);

95 
»s
 = 
	`·geÿche_wr™e_’d
(
NULL
, 
šode
->
i_m­pšg
, 
pos
, 
n
,‚,

96 
·ge
, 
fsd©a
);

97 ià(
»s
 < 0)

98  
»s
;

99 ià(
»s
 !ğ
n
)

100  -
EIO
;

102 
buf
 +ğ
n
;

103 
pos
 +ğ
n
;

104 
couÁ
 -ğ
n
;

107 
	}
}

115 
	sfsv”™y_desütÜ_loÿtiÚ
 {

116 
__Ë32
 
	mv”siÚ
;

117 
__Ë32
 
	msize
;

118 
__Ë64
 
	mpos
;

121 
	$f2fs_begš_’abË_v”™y
(
fe
 *
fp
)

123 
šode
 *šodğ
	`fe_šode
(
fp
);

124 
”r
;

126 ià(
	`f2fs_v”™y_š_´og»ss
(
šode
))

127  -
EBUSY
;

129 ià(
	`f2fs_is_©omic_fe
(
šode
è|| 
	`f2fs_is_vŞ©e_fe
(inode))

130  -
EOPNOTSUPP
;

137 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

138 ià(
”r
)

139  
”r
;

141 
”r
 = 
	`f2fs_cÚv”t_šlše_šode
(
šode
);

142 ià(
”r
)

143  
”r
;

145 
	`£t_šode_æag
(
šode
, 
FI_VERITY_IN_PROGRESS
);

147 
	}
}

149 
	$f2fs_’d_’abË_v”™y
(
fe
 *
fp
, cÚ¡ *
desc
,

150 
size_t
 
desc_size
, 
u64
 
m”kË_Œ“_size
)

152 
šode
 *šodğ
	`fe_šode
(
fp
);

153 
u64
 
desc_pos
 = 
	`f2fs_v”™y_m‘ad©a_pos
(
šode
è+ 
m”kË_Œ“_size
;

154 
fsv”™y_desütÜ_loÿtiÚ
 
dloc
 = {

155 .
v”siÚ
 = 
	`ıu_to_Ë32
(1),

156 .
size
 = 
	`ıu_to_Ë32
(
desc_size
),

157 .
pos
 = 
	`ıu_to_Ë64
(
desc_pos
),

159 
”r
 = 0;

161 ià(
desc
 !ğ
NULL
) {

163 
”r
 = 
	`·geÿche_wr™e
(
šode
, 
desc
, 
desc_size
, 
desc_pos
);

166 ià(!
”r
)

167 
”r
 = 
	`fem­_wr™e_ªd_wa™
(
šode
->
i_m­pšg
);

171 ià(
desc
 =ğ
NULL
 || 
”r
)

172 
	`f2fs_Œunÿ‹
(
šode
);

174 
	`ş—r_šode_æag
(
šode
, 
FI_VERITY_IN_PROGRESS
);

176 ià(
desc
 !ğ
NULL
 && !
”r
) {

177 
”r
 = 
	`f2fs_£tx©Œ
(
šode
, 
F2FS_XATTR_INDEX_VERITY
,

178 
F2FS_XATTR_NAME_VERITY
, &
dloc
, (dloc),

179 
NULL
, 
XATTR_CREATE
);

180 ià(!
”r
) {

181 
	`fe_£t_v”™y
(
šode
);

182 
	`f2fs_£t_šode_æags
(
šode
);

183 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

186  
”r
;

187 
	}
}

189 
	$f2fs_g‘_v”™y_desütÜ
(
šode
 *šode, *
buf
,

190 
size_t
 
buf_size
)

192 
fsv”™y_desütÜ_loÿtiÚ
 
dloc
;

193 
»s
;

194 
u32
 
size
;

195 
u64
 
pos
;

198 
»s
 = 
	`f2fs_g‘x©Œ
(
šode
, 
F2FS_XATTR_INDEX_VERITY
,

199 
F2FS_XATTR_NAME_VERITY
, &
dloc
, (dloc), 
NULL
);

200 ià(
»s
 < 0 &&„e !ğ-
ERANGE
)

201  
»s
;

202 ià(
»s
 !ğ(
dloc
è|| dloc.
v”siÚ
 !ğ
	`ıu_to_Ë32
(1)) {

203 
	`f2fs_w¬n
(
	`F2FS_I_SB
(
šode
), "unknown verity xattr format");

204  -
EINVAL
;

206 
size
 = 
	`Ë32_to_ıu
(
dloc
.size);

207 
pos
 = 
	`Ë64_to_ıu
(
dloc
.pos);

210 ià(
pos
 + 
size
 <…o ||…o + siz> 
šode
->
i_sb
->
s_maxby‹s
 ||

211 
pos
 < 
	`f2fs_v”™y_m‘ad©a_pos
(
šode
è|| 
size
 > 
INT_MAX
) {

212 
	`f2fs_w¬n
(
	`F2FS_I_SB
(
šode
), "invalid verity xattr");

213  -
EFSCORRUPTED
;

215 ià(
buf_size
) {

216 ià(
size
 > 
buf_size
)

217  -
ERANGE
;

218 
»s
 = 
	`·geÿche_»ad
(
šode
, 
buf
, 
size
, 
pos
);

219 ià(
»s
)

220  
»s
;

222  
size
;

223 
	}
}

225 
·ge
 *
	$f2fs_»ad_m”kË_Œ“_·ge
(
šode
 *inode,

226 
pgoff_t
 
šdex
)

228 
šdex
 +ğ
	`f2fs_v”™y_m‘ad©a_pos
(
šode
è>> 
PAGE_SHIFT
;

230  
	`»ad_m­pšg_·ge
(
šode
->
i_m­pšg
, 
šdex
, 
NULL
);

231 
	}
}

233 
	$f2fs_wr™e_m”kË_Œ“_block
(
šode
 *šode, cÚ¡ *
buf
,

234 
u64
 
šdex
, 
log_blocksize
)

236 
loff_t
 
pos
 = 
	`f2fs_v”™y_m‘ad©a_pos
(
šode
è+ (
šdex
 << 
log_blocksize
);

238  
	`·geÿche_wr™e
(
šode
, 
buf
, 1 << 
log_blocksize
, 
pos
);

239 
	}
}

241 cÚ¡ 
fsv”™y_İ”©iÚs
 
	gf2fs_v”™yİs
 = {

242 .
begš_’abË_v”™y
 = 
f2fs_begš_’abË_v”™y
,

243 .
	g’d_’abË_v”™y
 = 
f2fs_’d_’abË_v”™y
,

244 .
	gg‘_v”™y_desütÜ
 = 
f2fs_g‘_v”™y_desütÜ
,

245 .
	g»ad_m”kË_Œ“_·ge
 = 
f2fs_»ad_m”kË_Œ“_·ge
,

246 .
	gwr™e_m”kË_Œ“_block
 = 
f2fs_wr™e_m”kË_Œ“_block
,

	@xattr.c

18 
	~<lšux/rw£m.h
>

19 
	~<lšux/f2fs_fs.h
>

20 
	~<lšux/£cur™y.h
>

21 
	~<lšux/posix_aş_x©Œ.h
>

22 
	~"f2fs.h
"

23 
	~"x©Œ.h
"

24 
	~"£gm’t.h
"

26 
	$f2fs_x©Œ_g’”ic_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

27 
d’Œy
 *
unu£d
, 
šode
 *inode,

28 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

30 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
šode
->
i_sb
);

32 
hªdËr
->
æags
) {

33 
F2FS_XATTR_INDEX_USER
:

34 ià(!
	`‹¡_İt
(
sbi
, 
XATTR_USER
))

35  -
EOPNOTSUPP
;

37 
F2FS_XATTR_INDEX_TRUSTED
:

38 
F2FS_XATTR_INDEX_SECURITY
:

41  -
EINVAL
;

43  
	`f2fs_g‘x©Œ
(
šode
, 
hªdËr
->
æags
, 
Çme
,

44 
bufãr
, 
size
, 
NULL
);

45 
	}
}

47 
	$f2fs_x©Œ_g’”ic_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

48 
d’Œy
 *
unu£d
, 
šode
 *inode,

49 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

50 
size_t
 
size
, 
æags
)

52 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
šode
->
i_sb
);

54 
hªdËr
->
æags
) {

55 
F2FS_XATTR_INDEX_USER
:

56 ià(!
	`‹¡_İt
(
sbi
, 
XATTR_USER
))

57  -
EOPNOTSUPP
;

59 
F2FS_XATTR_INDEX_TRUSTED
:

60 
F2FS_XATTR_INDEX_SECURITY
:

63  -
EINVAL
;

65  
	`f2fs_£tx©Œ
(
šode
, 
hªdËr
->
æags
, 
Çme
,

66 
v®ue
, 
size
, 
NULL
, 
æags
);

67 
	}
}

69 
boŞ
 
	$f2fs_x©Œ_u£r_li¡
(
d’Œy
 *dentry)

71 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
d’Œy
->
d_sb
);

73  
	`‹¡_İt
(
sbi
, 
XATTR_USER
);

74 
	}
}

76 
boŞ
 
	$f2fs_x©Œ_Œu¡ed_li¡
(
d’Œy
 *dentry)

78  
	`ÿ·bË
(
CAP_SYS_ADMIN
);

79 
	}
}

81 
	$f2fs_x©Œ_advi£_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

82 
d’Œy
 *
unu£d
, 
šode
 *inode,

83 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

85 ià(
bufãr
)

86 *((*)
bufãr
èğ
	`F2FS_I
(
šode
)->
i_advi£
;

88 
	}
}

90 
	$f2fs_x©Œ_advi£_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

91 
d’Œy
 *
unu£d
, 
šode
 *inode,

92 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

93 
size_t
 
size
, 
æags
)

95 
Şd_advi£
 = 
	`F2FS_I
(
šode
)->
i_advi£
;

96 
Ãw_advi£
;

98 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

99  -
EPERM
;

100 ià(
v®ue
 =ğ
NULL
)

101  -
EINVAL
;

103 
Ãw_advi£
 = *(*)
v®ue
;

104 ià(
Ãw_advi£
 & ~
FADVISE_MODIFIABLE_BITS
)

105  -
EINVAL
;

107 
Ãw_advi£
 =‚ew_advi£ & 
FADVISE_MODIFIABLE_BITS
;

108 
Ãw_advi£
 |ğ
Şd_advi£
 & ~
FADVISE_MODIFIABLE_BITS
;

110 
	`F2FS_I
(
šode
)->
i_advi£
 = 
Ãw_advi£
;

111 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

113 
	}
}

115 #ifdeà
CONFIG_F2FS_FS_SECURITY


116 
	$f2fs_š™x©Œs
(
šode
 *šode, cÚ¡ 
x©Œ
 *
x©Œ_¬¿y
,

117 *
·ge
)

119 cÚ¡ 
x©Œ
 *xattr;

120 
”r
 = 0;

122 
x©Œ
 = 
x©Œ_¬¿y
; x©Œ->
Çme
 !ğ
NULL
; xattr++) {

123 
”r
 = 
	`f2fs_£tx©Œ
(
šode
, 
F2FS_XATTR_INDEX_SECURITY
,

124 
x©Œ
->
Çme
, x©Œ->
v®ue
,

125 
x©Œ
->
v®ue_Ën
, (
·ge
 *)page, 0);

126 ià(
”r
 < 0)

129  
”r
;

130 
	}
}

132 
	$f2fs_š™_£cur™y
(
šode
 *šode, šod*
dœ
,

133 cÚ¡ 
q¡r
 *q¡r, 
·ge
 *
age
)

135  
	`£cur™y_šode_š™_£cur™y
(
šode
, 
dœ
, 
q¡r
,

136 &
f2fs_š™x©Œs
, 
age
);

137 
	}
}

140 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_u£r_hªdËr
 = {

141 .
´efix
 = 
XATTR_USER_PREFIX
,

142 .
	gæags
 = 
F2FS_XATTR_INDEX_USER
,

143 .
	gli¡
 = 
f2fs_x©Œ_u£r_li¡
,

144 .
	gg‘
 = 
f2fs_x©Œ_g’”ic_g‘
,

145 .
	g£t
 = 
f2fs_x©Œ_g’”ic_£t
,

148 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_Œu¡ed_hªdËr
 = {

149 .
´efix
 = 
XATTR_TRUSTED_PREFIX
,

150 .
	gæags
 = 
F2FS_XATTR_INDEX_TRUSTED
,

151 .
	gli¡
 = 
f2fs_x©Œ_Œu¡ed_li¡
,

152 .
	gg‘
 = 
f2fs_x©Œ_g’”ic_g‘
,

153 .
	g£t
 = 
f2fs_x©Œ_g’”ic_£t
,

156 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_advi£_hªdËr
 = {

157 .
Çme
 = 
F2FS_SYSTEM_ADVISE_NAME
,

158 .
	gæags
 = 
F2FS_XATTR_INDEX_ADVISE
,

159 .
	gg‘
 = 
f2fs_x©Œ_advi£_g‘
,

160 .
	g£t
 = 
f2fs_x©Œ_advi£_£t
,

163 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_£cur™y_hªdËr
 = {

164 .
´efix
 = 
XATTR_SECURITY_PREFIX
,

165 .
	gæags
 = 
F2FS_XATTR_INDEX_SECURITY
,

166 .
	gg‘
 = 
f2fs_x©Œ_g’”ic_g‘
,

167 .
	g£t
 = 
f2fs_x©Œ_g’”ic_£t
,

170 cÚ¡ 
x©Œ_hªdËr
 *
	gf2fs_x©Œ_hªdËr_m­
[] = {

171 [
F2FS_XATTR_INDEX_USER
] = &
f2fs_x©Œ_u£r_hªdËr
,

172 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


173 [
F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
] = &
posix_aş_acûss_x©Œ_hªdËr
,

174 [
F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
] = &
posix_aş_deçuÉ_x©Œ_hªdËr
,

176 [
F2FS_XATTR_INDEX_TRUSTED
] = &
f2fs_x©Œ_Œu¡ed_hªdËr
,

177 #ifdeà
CONFIG_F2FS_FS_SECURITY


178 [
F2FS_XATTR_INDEX_SECURITY
] = &
f2fs_x©Œ_£cur™y_hªdËr
,

180 [
F2FS_XATTR_INDEX_ADVISE
] = &
f2fs_x©Œ_advi£_hªdËr
,

183 cÚ¡ 
x©Œ_hªdËr
 *
	gf2fs_x©Œ_hªdËrs
[] = {

184 &
f2fs_x©Œ_u£r_hªdËr
,

185 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


186 &
posix_aş_acûss_x©Œ_hªdËr
,

187 &
posix_aş_deçuÉ_x©Œ_hªdËr
,

189 &
f2fs_x©Œ_Œu¡ed_hªdËr
,

190 #ifdeà
CONFIG_F2FS_FS_SECURITY


191 &
f2fs_x©Œ_£cur™y_hªdËr
,

193 &
f2fs_x©Œ_advi£_hªdËr
,

194 
NULL
,

197 
šlše
 cÚ¡ 
x©Œ_hªdËr
 *
	$f2fs_x©Œ_hªdËr
(
šdex
)

199 cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
 = 
NULL
;

201 ià(
šdex
 > 0 && index < 
	`ARRAY_SIZE
(
f2fs_x©Œ_hªdËr_m­
))

202 
hªdËr
 = 
f2fs_x©Œ_hªdËr_m­
[
šdex
];

203  
hªdËr
;

204 
	}
}

206 
f2fs_x©Œ_’Œy
 *
	$__fšd_x©Œ
(*
ba£_addr
,

207 *
Ï¡_ba£_addr
, 
šdex
,

208 
size_t
 
Ën
, cÚ¡ *
Çme
)

210 
f2fs_x©Œ_’Œy
 *
’Œy
;

212 
	`li¡_fÜ_—ch_x©Œ
(
’Œy
, 
ba£_addr
) {

213 ià((*)(
’Œy
è+ (
__u32
è> 
Ï¡_ba£_addr
 ||

214 (*)
	`XATTR_NEXT_ENTRY
(
’Œy
è> 
Ï¡_ba£_addr
)

215  
NULL
;

217 ià(
’Œy
->
e_Çme_šdex
 !ğ
šdex
)

219 ià(
’Œy
->
e_Çme_Ën
 !ğ
Ën
)

221 ià(!
	`memcmp
(
’Œy
->
e_Çme
, 
Çme
, 
Ën
))

224  
’Œy
;

225 
	}
}

227 
f2fs_x©Œ_’Œy
 *
	$__fšd_šlše_x©Œ
(
šode
 *inode,

228 *
ba£_addr
, **
Ï¡_addr
, 
šdex
,

229 
size_t
 
Ën
, cÚ¡ *
Çme
)

231 
f2fs_x©Œ_’Œy
 *
’Œy
;

232 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

233 *
max_addr
 = 
ba£_addr
 + 
šlše_size
;

235 
	`li¡_fÜ_—ch_x©Œ
(
’Œy
, 
ba£_addr
) {

236 ià((*)
’Œy
 + (
__u32
è> 
max_addr
 ||

237 (*)
	`XATTR_NEXT_ENTRY
(
’Œy
è> 
max_addr
) {

238 *
Ï¡_addr
 = 
’Œy
;

239  
NULL
;

241 ià(
’Œy
->
e_Çme_šdex
 !ğ
šdex
)

243 ià(
’Œy
->
e_Çme_Ën
 !ğ
Ën
)

245 ià(!
	`memcmp
(
’Œy
->
e_Çme
, 
Çme
, 
Ën
))

250 ià(
	`IS_XATTR_LAST_ENTRY
(
’Œy
) &&

251 (*)
’Œy
 + (
__u32
è> 
max_addr
) {

252 *
Ï¡_addr
 = 
’Œy
;

253  
NULL
;

255  
’Œy
;

256 
	}
}

258 
	$»ad_šlše_x©Œ
(
šode
 *šode, 
·ge
 *
age
,

259 *
tx©Œ_addr
)

261 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

262 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

263 
·ge
 *·gğ
NULL
;

264 *
šlše_addr
;

266 ià(
age
) {

267 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
age
);

269 
·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

270 ià(
	`IS_ERR
(
·ge
))

271  
	`PTR_ERR
(
·ge
);

273 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
·ge
);

275 
	`memıy
(
tx©Œ_addr
, 
šlše_addr
, 
šlše_size
);

276 
	`f2fs_put_·ge
(
·ge
, 1);

279 
	}
}

281 
	$»ad_x©Œ_block
(
šode
 *šode, *
tx©Œ_addr
)

283 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

284 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

285 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

286 
·ge
 *
x·ge
;

287 *
x©Œ_addr
;

290 
x·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
xnid
);

291 ià(
	`IS_ERR
(
x·ge
))

292  
	`PTR_ERR
(
x·ge
);

294 
x©Œ_addr
 = 
	`·ge_add»ss
(
x·ge
);

295 
	`memıy
(
tx©Œ_addr
 + 
šlše_size
, 
x©Œ_addr
, 
VALID_XATTR_BLOCK_SIZE
);

296 
	`f2fs_put_·ge
(
x·ge
, 1);

299 
	}
}

301 
	$lookup_®l_x©Œs
(
šode
 *šode, 
·ge
 *
age
,

302 
šdex
, 
Ën
,

303 cÚ¡ *
Çme
, 
f2fs_x©Œ_’Œy
 **
xe
,

304 **
ba£_addr
, *
ba£_size
)

306 *
cur_addr
, *
tx©Œ_addr
, *
Ï¡_tx©Œ_addr
;

307 *
Ï¡_addr
 = 
NULL
;

308 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

309 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

310 
”r
 = 0;

312 ià(!
xnid
 && !
šlše_size
)

313  -
ENODATA
;

315 *
ba£_size
 = 
	`XATTR_SIZE
(
xnid
, 
šode
è+ 
XATTR_PADDING_SIZE
;

316 
tx©Œ_addr
 = 
	`f2fs_kz®loc
(
	`F2FS_I_SB
(
šode
), *
ba£_size
, 
GFP_NOFS
);

317 ià(!
tx©Œ_addr
)

318  -
ENOMEM
;

320 
Ï¡_tx©Œ_addr
 = (*)
tx©Œ_addr
 + 
	`XATTR_SIZE
(
xnid
, 
šode
);

323 ià(
šlše_size
) {

324 
”r
 = 
	`»ad_šlše_x©Œ
(
šode
, 
age
, 
tx©Œ_addr
);

325 ià(
”r
)

326 
out
;

328 *
xe
 = 
	`__fšd_šlše_x©Œ
(
šode
, 
tx©Œ_addr
, &
Ï¡_addr
,

329 
šdex
, 
Ën
, 
Çme
);

330 ià(*
xe
) {

331 *
ba£_size
 = 
šlše_size
;

332 
check
;

337 ià(
xnid
) {

338 
”r
 = 
	`»ad_x©Œ_block
(
šode
, 
tx©Œ_addr
);

339 ià(
”r
)

340 
out
;

343 ià(
Ï¡_addr
)

344 
cur_addr
 = 
	`XATTR_HDR
(
Ï¡_addr
) - 1;

346 
cur_addr
 = 
tx©Œ_addr
;

348 *
xe
 = 
	`__fšd_x©Œ
(
cur_addr
, 
Ï¡_tx©Œ_addr
, 
šdex
, 
Ën
, 
Çme
);

349 ià(!*
xe
) {

350 
	`f2fs_”r
(
	`F2FS_I_SB
(
šode
), "inode (%lu) has corrupted xattr",

351 
šode
->
i_šo
);

352 
	`£t_sbi_æag
(
	`F2FS_I_SB
(
šode
), 
SBI_NEED_FSCK
);

353 
”r
 = -
EFSCORRUPTED
;

354 
out
;

356 
check
:

357 ià(
	`IS_XATTR_LAST_ENTRY
(*
xe
)) {

358 
”r
 = -
ENODATA
;

359 
out
;

362 *
ba£_addr
 = 
tx©Œ_addr
;

364 
out
:

365 
	`kvä“
(
tx©Œ_addr
);

366  
”r
;

367 
	}
}

369 
	$»ad_®l_x©Œs
(
šode
 *šode, 
·ge
 *
age
,

370 **
ba£_addr
)

372 
f2fs_x©Œ_h—d”
 *
h—d”
;

373 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

374 
size
 = 
VALID_XATTR_BLOCK_SIZE
;

375 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

376 *
tx©Œ_addr
;

377 
”r
;

379 
tx©Œ_addr
 = 
	`f2fs_kz®loc
(
	`F2FS_I_SB
(
šode
),

380 
šlše_size
 + 
size
 + 
XATTR_PADDING_SIZE
, 
GFP_NOFS
);

381 ià(!
tx©Œ_addr
)

382  -
ENOMEM
;

385 ià(
šlše_size
) {

386 
”r
 = 
	`»ad_šlše_x©Œ
(
šode
, 
age
, 
tx©Œ_addr
);

387 ià(
”r
)

388 
ç
;

392 ià(
xnid
) {

393 
”r
 = 
	`»ad_x©Œ_block
(
šode
, 
tx©Œ_addr
);

394 ià(
”r
)

395 
ç
;

398 
h—d”
 = 
	`XATTR_HDR
(
tx©Œ_addr
);

401 ià(
	`Ë32_to_ıu
(
h—d”
->
h_magic
è!ğ
F2FS_XATTR_MAGIC
) {

402 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(
F2FS_XATTR_MAGIC
);

403 
h—d”
->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(1);

405 *
ba£_addr
 = 
tx©Œ_addr
;

407 
ç
:

408 
	`kvä“
(
tx©Œ_addr
);

409  
”r
;

410 
	}
}

412 
šlše
 
	$wr™e_®l_x©Œs
(
šode
 *šode, 
__u32
 
hsize
,

413 *
tx©Œ_addr
, 
·ge
 *
age
)

415 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

416 
size_t
 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

417 
·ge
 *
š_·ge
 = 
NULL
;

418 *
x©Œ_addr
;

419 *
šlše_addr
 = 
NULL
;

420 
·ge
 *
x·ge
;

421 
nid_t
 
Ãw_nid
 = 0;

422 
”r
 = 0;

424 ià(
hsize
 > 
šlše_size
 && !
	`F2FS_I
(
šode
)->
i_x©Œ_nid
)

425 ià(!
	`f2fs_®loc_nid
(
sbi
, &
Ãw_nid
))

426  -
ENOSPC
;

429 ià(
šlše_size
) {

430 ià(
age
) {

431 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
age
);

433 
š_·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

434 ià(
	`IS_ERR
(
š_·ge
)) {

435 
	`f2fs_®loc_nid_çed
(
sbi
, 
Ãw_nid
);

436  
	`PTR_ERR
(
š_·ge
);

438 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
šode
, 
š_·ge
);

441 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
 ? i·g: 
š_·ge
,

442 
NODE
, 
Œue
,rue);

444 ià(
hsize
 <ğ
šlše_size
) {

445 
”r
 = 
	`f2fs_Œunÿ‹_x©Œ_node
(
šode
);

446 
	`f2fs_®loc_nid_çed
(
sbi
, 
Ãw_nid
);

447 ià(
”r
) {

448 
	`f2fs_put_·ge
(
š_·ge
, 1);

449  
”r
;

451 
	`memıy
(
šlše_addr
, 
tx©Œ_addr
, 
šlše_size
);

452 
	`£t_·ge_dœty
(
age
 ? i·g: 
š_·ge
);

453 
š_·ge_out
;

458 ià(
	`F2FS_I
(
šode
)->
i_x©Œ_nid
) {

459 
x·ge
 = 
	`f2fs_g‘_node_·ge
(
sbi
, 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
);

460 ià(
	`IS_ERR
(
x·ge
)) {

461 
”r
 = 
	`PTR_ERR
(
x·ge
);

462 
	`f2fs_®loc_nid_çed
(
sbi
, 
Ãw_nid
);

463 
š_·ge_out
;

465 
	`f2fs_bug_Ú
(
sbi
, 
Ãw_nid
);

466 
	`f2fs_wa™_Ú_·ge_wr™eback
(
x·ge
, 
NODE
, 
Œue
,rue);

468 
dnode_of_d©a
 
dn
;

469 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 
Ãw_nid
);

470 
x·ge
 = 
	`f2fs_Ãw_node_·ge
(&
dn
, 
XATTR_NODE_OFFSET
);

471 ià(
	`IS_ERR
(
x·ge
)) {

472 
”r
 = 
	`PTR_ERR
(
x·ge
);

473 
	`f2fs_®loc_nid_çed
(
sbi
, 
Ãw_nid
);

474 
š_·ge_out
;

476 
	`f2fs_®loc_nid_dÚe
(
sbi
, 
Ãw_nid
);

478 
x©Œ_addr
 = 
	`·ge_add»ss
(
x·ge
);

480 ià(
šlše_size
)

481 
	`memıy
(
šlše_addr
, 
tx©Œ_addr
, 
šlše_size
);

482 
	`memıy
(
x©Œ_addr
, 
tx©Œ_addr
 + 
šlše_size
, 
VALID_XATTR_BLOCK_SIZE
);

484 ià(
šlše_size
)

485 
	`£t_·ge_dœty
(
age
 ? i·g: 
š_·ge
);

486 
	`£t_·ge_dœty
(
x·ge
);

488 
	`f2fs_put_·ge
(
x·ge
, 1);

489 
š_·ge_out
:

490 
	`f2fs_put_·ge
(
š_·ge
, 1);

491  
”r
;

492 
	}
}

494 
	$f2fs_g‘x©Œ
(
šode
 *šode, 
šdex
, cÚ¡ *
Çme
,

495 *
bufãr
, 
size_t
 
bufãr_size
, 
·ge
 *
age
)

497 
f2fs_x©Œ_’Œy
 *
’Œy
 = 
NULL
;

498 
”rÜ
 = 0;

499 
size
, 
Ën
;

500 *
ba£_addr
 = 
NULL
;

501 
ba£_size
;

503 ià(
Çme
 =ğ
NULL
)

504  -
EINVAL
;

506 
Ën
 = 
	`¡¾’
(
Çme
);

507 ià(
Ën
 > 
F2FS_NAME_LEN
)

508  -
ERANGE
;

510 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

511 
”rÜ
 = 
	`lookup_®l_x©Œs
(
šode
, 
age
, 
šdex
, 
Ën
, 
Çme
,

512 &
’Œy
, &
ba£_addr
, &
ba£_size
);

513 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

514 ià(
”rÜ
)

515  
”rÜ
;

517 
size
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_size
);

519 ià(
bufãr
 && 
size
 > 
bufãr_size
) {

520 
”rÜ
 = -
ERANGE
;

521 
out
;

524 ià(
bufãr
) {

525 *
pv®
 = 
’Œy
->
e_Çme
 +ƒÁry->
e_Çme_Ën
;

527 ià(
ba£_size
 - (
pv®
 - (*)
ba£_addr
è< 
size
) {

528 
”rÜ
 = -
ERANGE
;

529 
out
;

531 
	`memıy
(
bufãr
, 
pv®
, 
size
);

533 
”rÜ
 = 
size
;

534 
out
:

535 
	`kvä“
(
ba£_addr
);

536  
”rÜ
;

537 
	}
}

539 
ssize_t
 
	$f2fs_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
bufãr_size
)

541 
šode
 *šodğ
	`d_šode
(
d’Œy
);

542 
f2fs_x©Œ_’Œy
 *
’Œy
;

543 *
ba£_addr
;

544 
”rÜ
 = 0;

545 
size_t
 
»¡
 = 
bufãr_size
;

547 
	`down_»ad
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

548 
”rÜ
 = 
	`»ad_®l_x©Œs
(
šode
, 
NULL
, &
ba£_addr
);

549 
	`up_»ad
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

550 ià(
”rÜ
)

551  
”rÜ
;

553 
	`li¡_fÜ_—ch_x©Œ
(
’Œy
, 
ba£_addr
) {

554 cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
 =

555 
	`f2fs_x©Œ_hªdËr
(
’Œy
->
e_Çme_šdex
);

556 cÚ¡ *
´efix
;

557 
size_t
 
´efix_Ën
;

558 
size_t
 
size
;

560 ià(!
hªdËr
 || (hªdËr->
li¡
 && !hªdËr->
	`li¡
(
d’Œy
)))

563 
´efix
 = 
	`x©Œ_´efix
(
hªdËr
);

564 
´efix_Ën
 = 
	`¡¾’
(
´efix
);

565 
size
 = 
´efix_Ën
 + 
’Œy
->
e_Çme_Ën
 + 1;

566 ià(
bufãr
) {

567 ià(
size
 > 
»¡
) {

568 
”rÜ
 = -
ERANGE
;

569 
ş—nup
;

571 
	`memıy
(
bufãr
, 
´efix
, 
´efix_Ën
);

572 
bufãr
 +ğ
´efix_Ën
;

573 
	`memıy
(
bufãr
, 
’Œy
->
e_Çme
,ƒÁry->
e_Çme_Ën
);

574 
bufãr
 +ğ
’Œy
->
e_Çme_Ën
;

575 *
bufãr
++ = 0;

577 
»¡
 -ğ
size
;

579 
”rÜ
 = 
bufãr_size
 - 
»¡
;

580 
ş—nup
:

581 
	`kvä“
(
ba£_addr
);

582  
”rÜ
;

583 
	}
}

585 
boŞ
 
	$f2fs_x©Œ_v®ue_§me
(
f2fs_x©Œ_’Œy
 *
’Œy
,

586 cÚ¡ *
v®ue
, 
size_t
 
size
)

588 *
pv®
 = 
’Œy
->
e_Çme
 +ƒÁry->
e_Çme_Ën
;

590  (
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_size
è=ğ
size
) &&

591 !
	`memcmp
(
pv®
, 
v®ue
, 
size
);

592 
	}
}

594 
	$__f2fs_£tx©Œ
(
šode
 *šode, 
šdex
,

595 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
size
,

596 
·ge
 *
age
, 
æags
)

598 
f2fs_x©Œ_’Œy
 *
h”e
, *
Ï¡
;

599 *
ba£_addr
, *
Ï¡_ba£_addr
;

600 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

601 
found
, 
Ãwsize
;

602 
size_t
 
Ën
;

603 
__u32
 
Ãw_hsize
;

604 
”rÜ
 = 0;

606 ià(
Çme
 =ğ
NULL
)

607  -
EINVAL
;

609 ià(
v®ue
 =ğ
NULL
)

610 
size
 = 0;

612 
Ën
 = 
	`¡¾’
(
Çme
);

614 ià(
Ën
 > 
F2FS_NAME_LEN
)

615  -
ERANGE
;

617 ià(
size
 > 
	`MAX_VALUE_LEN
(
šode
))

618  -
E2BIG
;

620 
”rÜ
 = 
	`»ad_®l_x©Œs
(
šode
, 
age
, &
ba£_addr
);

621 ià(
”rÜ
)

622  
”rÜ
;

624 
Ï¡_ba£_addr
 = (*)
ba£_addr
 + 
	`XATTR_SIZE
(
xnid
, 
šode
);

627 
h”e
 = 
	`__fšd_x©Œ
(
ba£_addr
, 
Ï¡_ba£_addr
, 
šdex
, 
Ën
, 
Çme
);

628 ià(!
h”e
) {

629 
	`f2fs_”r
(
	`F2FS_I_SB
(
šode
), "inode (%lu) has corrupted xattr",

630 
šode
->
i_šo
);

631 
	`£t_sbi_æag
(
	`F2FS_I_SB
(
šode
), 
SBI_NEED_FSCK
);

632 
”rÜ
 = -
EFSCORRUPTED
;

633 
ex™
;

636 
found
 = 
	`IS_XATTR_LAST_ENTRY
(
h”e
) ? 0 : 1;

638 ià(
found
) {

639 ià((
æags
 & 
XATTR_CREATE
)) {

640 
”rÜ
 = -
EEXIST
;

641 
ex™
;

644 ià(
v®ue
 && 
	`f2fs_x©Œ_v®ue_§me
(
h”e
, v®ue, 
size
))

645 
ex™
;

646 } ià((
æags
 & 
XATTR_REPLACE
)) {

647 
”rÜ
 = -
ENODATA
;

648 
ex™
;

651 
Ï¡
 = 
h”e
;

652 !
	`IS_XATTR_LAST_ENTRY
(
Ï¡
))

653 
Ï¡
 = 
	`XATTR_NEXT_ENTRY
(last);

655 
Ãwsize
 = 
	`XATTR_ALIGN
((
f2fs_x©Œ_’Œy
è+ 
Ën
 + 
size
);

658 ià(
v®ue
) {

659 
ä“
;

664 
ä“
 = 
	`MIN_OFFSET
(
šode
è- ((*)
Ï¡
 - (*)
ba£_addr
);

665 ià(
found
)

666 
ä“
 = f»+ 
	`ENTRY_SIZE
(
h”e
);

668 ià(
	`uÆik–y
(
ä“
 < 
Ãwsize
)) {

669 
”rÜ
 = -
E2BIG
;

670 
ex™
;

675 ià(
found
) {

680 
f2fs_x©Œ_’Œy
 *
Ãxt
 = 
	`XATTR_NEXT_ENTRY
(
h”e
);

681 
Şdsize
 = 
	`ENTRY_SIZE
(
h”e
);

683 
	`memmove
(
h”e
, 
Ãxt
, (*)
Ï¡
 - (*)next);

684 
Ï¡
 = (
f2fs_x©Œ_’Œy
 *)((*îa¡ - 
Şdsize
);

685 
	`mem£t
(
Ï¡
, 0, 
Şdsize
);

688 
Ãw_hsize
 = (*)
Ï¡
 - (*)
ba£_addr
;

691 ià(
v®ue
) {

692 *
pv®
;

697 
Ï¡
->
e_Çme_šdex
 = 
šdex
;

698 
Ï¡
->
e_Çme_Ën
 = 
Ën
;

699 
	`memıy
(
Ï¡
->
e_Çme
, 
Çme
, 
Ën
);

700 
pv®
 = 
Ï¡
->
e_Çme
 + 
Ën
;

701 
	`memıy
(
pv®
, 
v®ue
, 
size
);

702 
Ï¡
->
e_v®ue_size
 = 
	`ıu_to_Ë16
(
size
);

703 
Ãw_hsize
 +ğ
Ãwsize
;

706 
”rÜ
 = 
	`wr™e_®l_x©Œs
(
šode
, 
Ãw_hsize
, 
ba£_addr
, 
age
);

707 ià(
”rÜ
)

708 
ex™
;

710 ià(
	`is_šode_æag_£t
(
šode
, 
FI_ACL_MODE
)) {

711 
šode
->
i_mode
 = 
	`F2FS_I
(šode)->
i_aş_mode
;

712 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

713 
	`ş—r_šode_æag
(
šode
, 
FI_ACL_MODE
);

715 ià(
šdex
 =ğ
F2FS_XATTR_INDEX_ENCRYPTION
 &&

716 !
	`¡rcmp
(
Çme
, 
F2FS_XATTR_NAME_ENCRYPTION_CONTEXT
))

717 
	`f2fs_£t_’üy±ed_šode
(
šode
);

718 
	`f2fs_m¬k_šode_dœty_sync
(
šode
, 
Œue
);

719 ià(!
”rÜ
 && 
	`S_ISDIR
(
šode
->
i_mode
))

720 
	`£t_sbi_æag
(
	`F2FS_I_SB
(
šode
), 
SBI_NEED_CP
);

721 
ex™
:

722 
	`kvä“
(
ba£_addr
);

723  
”rÜ
;

724 
	}
}

726 
	$f2fs_£tx©Œ
(
šode
 *šode, 
šdex
, cÚ¡ *
Çme
,

727 cÚ¡ *
v®ue
, 
size_t
 
size
,

728 
·ge
 *
age
, 
æags
)

730 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

731 
”r
;

733 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

734  -
EIO
;

735 ià(!
	`f2fs_is_checkpošt_»ady
(
sbi
))

736  -
ENOSPC
;

738 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

739 ià(
”r
)

740  
”r
;

743 ià(
age
)

744  
	`__f2fs_£tx©Œ
(
šode
, 
šdex
, 
Çme
, 
v®ue
,

745 
size
, 
age
, 
æags
);

746 
	`f2fs_b®ªû_fs
(
sbi
, 
Œue
);

748 
	`f2fs_lock_İ
(
sbi
);

750 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

751 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

752 
”r
 = 
	`__f2fs_£tx©Œ
(
šode
, 
šdex
, 
Çme
, 
v®ue
, 
size
, 
age
, 
æags
);

753 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_x©Œ_£m
);

754 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

755 
	`f2fs_uÆock_İ
(
sbi
);

757 
	`f2fs_upd©e_time
(
sbi
, 
REQ_TIME
);

758  
”r
;

759 
	}
}

	@xattr.h

14 #iâdeà
__F2FS_XATTR_H__


15 
	#__F2FS_XATTR_H__


	)

17 
	~<lšux/š™.h
>

18 
	~<lšux/x©Œ.h
>

21 
	#F2FS_XATTR_MAGIC
 0xF2F52011

	)

24 
	#F2FS_XATTR_REFCOUNT_MAX
 1024

	)

27 
	#F2FS_SYSTEM_ADVISE_NAME
 "sy¡em.advi£"

	)

28 
	#F2FS_XATTR_INDEX_USER
 1

	)

29 
	#F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
 2

	)

30 
	#F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
 3

	)

31 
	#F2FS_XATTR_INDEX_TRUSTED
 4

	)

32 
	#F2FS_XATTR_INDEX_LUSTRE
 5

	)

33 
	#F2FS_XATTR_INDEX_SECURITY
 6

	)

34 
	#F2FS_XATTR_INDEX_ADVISE
 7

	)

36 
	#F2FS_XATTR_INDEX_ENCRYPTION
 9

	)

37 
	#F2FS_XATTR_INDEX_VERITY
 11

	)

39 
	#F2FS_XATTR_NAME_ENCRYPTION_CONTEXT
 "c"

	)

40 
	#F2FS_XATTR_NAME_VERITY
 "v"

	)

42 
	sf2fs_x©Œ_h—d”
 {

43 
__Ë32
 
	mh_magic
;

44 
__Ë32
 
	mh_»fcouÁ
;

45 
__u32
 
	mh_»£rved
[4];

48 
	sf2fs_x©Œ_’Œy
 {

49 
__u8
 
	me_Çme_šdex
;

50 
__u8
 
	me_Çme_Ën
;

51 
__Ë16
 
	me_v®ue_size
;

52 
	me_Çme
[0];

55 
	#XATTR_HDR
(
±r
è((
f2fs_x©Œ_h—d”
 *)ÕŒ))

	)

56 
	#XATTR_ENTRY
(
±r
è((
f2fs_x©Œ_’Œy
 *)ÕŒ))

	)

57 
	#XATTR_FIRST_ENTRY
(
±r
è(
	`XATTR_ENTRY
(
	`XATTR_HDR
ÕŒè+ 1))

	)

58 
	#XATTR_ROUND
 (3)

	)

60 
	#XATTR_ALIGN
(
size
è(((sizeè+ 
XATTR_ROUND
è& ~XATTR_ROUND)

	)

62 
	#ENTRY_SIZE
(
’Œy
è(
	`XATTR_ALIGN
((
f2fs_x©Œ_’Œy
) + \

63 (
’Œy
)->
e_Çme_Ën
 + 
	`Ë16_to_ıu
(ÓÁry)->
e_v®ue_size
)))

	)

65 
	#XATTR_NEXT_ENTRY
(
’Œy
è((
f2fs_x©Œ_’Œy
 *)((*)(entry) +\

66 
	`ENTRY_SIZE
(
’Œy
)))

	)

68 
	#IS_XATTR_LAST_ENTRY
(
’Œy
è(*(
__u32
 *)ÓÁryè=ğ0)

	)

70 
	#li¡_fÜ_—ch_x©Œ
(
’Œy
, 
addr
) \

71 
’Œy
 = 
	`XATTR_FIRST_ENTRY
(
addr
);\

72 !
	`IS_XATTR_LAST_ENTRY
(
’Œy
);\

73 
’Œy
 = 
	`XATTR_NEXT_ENTRY
ÓÁry))

	)

74 
	#VALID_XATTR_BLOCK_SIZE
 (
PAGE_SIZE
 - (
node_foÙ”
))

	)

75 
	#XATTR_PADDING_SIZE
 ((
__u32
))

	)

76 
	#XATTR_SIZE
(
x
,
i
è(((xè? 
VALID_XATTR_BLOCK_SIZE
 : 0) + \

77 (
	`šlše_x©Œ_size
(
i
)))

	)

78 
	#MIN_OFFSET
(
i
è
	`XATTR_ALIGN
(
	`šlše_x©Œ_size
(i) + \

79 
VALID_XATTR_BLOCK_SIZE
)

	)

81 
	#MAX_VALUE_LEN
(
i
è(
	`MIN_OFFSET
(i) - \

82 (
f2fs_x©Œ_h—d”
) - \

83 (
f2fs_x©Œ_’Œy
))

	)

85 
	#MAX_INLINE_XATTR_SIZE
 \

86 (
DEF_ADDRS_PER_INODE
 - \

87 
F2FS_TOTAL_EXTRA_ATTR_SIZE
 / (
__Ë32
) - \

88 
DEF_INLINE_RESERVED_SIZE
 - \

89 
MIN_INLINE_DENTRY_SIZE
 / (
__Ë32
))

	)

120 #ifdeà
CONFIG_F2FS_FS_XATTR


121 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_u£r_hªdËr
;

122 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_Œu¡ed_hªdËr
;

123 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_advi£_hªdËr
;

124 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_£cur™y_hªdËr
;

126 cÚ¡ 
x©Œ_hªdËr
 *
f2fs_x©Œ_hªdËrs
[];

128 
f2fs_£tx©Œ
(
šode
 *, , const *,

129 cÚ¡ *, 
size_t
, 
·ge
 *, );

130 
f2fs_g‘x©Œ
(
šode
 *, , const *, *,

131 
size_t
, 
·ge
 *);

132 
ssize_t
 
f2fs_li¡x©Œ
(
d’Œy
 *, *, 
size_t
);

135 
	#f2fs_x©Œ_hªdËrs
 
NULL


	)

136 
šlše
 
	$f2fs_£tx©Œ
(
šode
 *šode, 
šdex
,

137 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
size
,

138 
·ge
 *·ge, 
æags
)

140  -
EOPNOTSUPP
;

141 
	}
}

142 
šlše
 
	$f2fs_g‘x©Œ
(
šode
 *šode, 
šdex
,

143 cÚ¡ *
Çme
, *
bufãr
,

144 
size_t
 
bufãr_size
, 
·ge
 *
d·ge
)

146  -
EOPNOTSUPP
;

147 
	}
}

148 
šlše
 
ssize_t
 
	$f2fs_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
,

149 
size_t
 
bufãr_size
)

151  -
EOPNOTSUPP
;

152 
	}
}

155 #ifdeà
CONFIG_F2FS_FS_SECURITY


156 
f2fs_š™_£cur™y
(
šode
 *, inode *,

157 cÚ¡ 
q¡r
 *, 
·ge
 *);

159 
šlše
 
	$f2fs_š™_£cur™y
(
šode
 *šode, šod*
dœ
,

160 cÚ¡ 
q¡r
 *q¡r, 
·ge
 *
age
)

163 
	}
}

	@/usr/include/linux/falloc.h

2 #iâdeà
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fs.h

2 #iâdeà
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<lšux/lim™s.h
>

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/ty³s.h
>

28 #undeà
NR_OPEN


29 
	#INR_OPEN_CUR
 1024

	)

30 
	#INR_OPEN_MAX
 4096

	)

32 
	#BLOCK_SIZE_BITS
 10

	)

33 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

35 
	#SEEK_SET
 0

	)

36 
	#SEEK_CUR
 1

	)

37 
	#SEEK_END
 2

	)

38 
	#SEEK_DATA
 3

	)

39 
	#SEEK_HOLE
 4

	)

40 
	#SEEK_MAX
 
SEEK_HOLE


	)

42 
	#RENAME_NOREPLACE
 (1 << 0è

	)

43 
	#RENAME_EXCHANGE
 (1 << 1è

	)

44 
	#RENAME_WHITEOUT
 (1 << 2è

	)

46 
	sfe_şÚe_¿nge
 {

47 
__s64
 
	m¤c_fd
;

48 
__u64
 
	m¤c_off£t
;

49 
__u64
 
	m¤c_Ëngth
;

50 
__u64
 
	mde¡_off£t
;

53 
	sf¡rim_¿nge
 {

54 
__u64
 
	m¡¬t
;

55 
__u64
 
	mËn
;

56 
__u64
 
	mmšËn
;

60 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

61 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

64 
	sfe_dedu³_¿nge_šfo
 {

65 
__s64
 
	mde¡_fd
;

66 
__u64
 
	mde¡_off£t
;

67 
__u64
 
	mby‹s_dedu³d
;

74 
__s32
 
	m¡©us
;

75 
__u32
 
	m»£rved
;

79 
	sfe_dedu³_¿nge
 {

80 
__u64
 
	m¤c_off£t
;

81 
__u64
 
	m¤c_Ëngth
;

82 
__u16
 
	mde¡_couÁ
;

83 
__u16
 
	m»£rved1
;

84 
__u32
 
	m»£rved2
;

85 
fe_dedu³_¿nge_šfo
 
	mšfo
[0];

89 
	sfes_¡©_¡ruù
 {

90 
	mÄ_fes
;

91 
	mÄ_ä“_fes
;

92 
	mmax_fes
;

95 
	sšodes_¡©_t
 {

96 
	mÄ_šodes
;

97 
	mÄ_unu£d
;

98 
	mdummy
[5];

102 
	#NR_FILE
 8192

	)

108 
	#MS_RDONLY
 1

	)

109 
	#MS_NOSUID
 2

	)

110 
	#MS_NODEV
 4

	)

111 
	#MS_NOEXEC
 8

	)

112 
	#MS_SYNCHRONOUS
 16

	)

113 
	#MS_REMOUNT
 32

	)

114 
	#MS_MANDLOCK
 64

	)

115 
	#MS_DIRSYNC
 128

	)

116 
	#MS_NOATIME
 1024

	)

117 
	#MS_NODIRATIME
 2048

	)

118 
	#MS_BIND
 4096

	)

119 
	#MS_MOVE
 8192

	)

120 
	#MS_REC
 16384

	)

121 
	#MS_VERBOSE
 32768

	)

123 
	#MS_SILENT
 32768

	)

124 
	#MS_POSIXACL
 (1<<16è

	)

125 
	#MS_UNBINDABLE
 (1<<17è

	)

126 
	#MS_PRIVATE
 (1<<18è

	)

127 
	#MS_SLAVE
 (1<<19è

	)

128 
	#MS_SHARED
 (1<<20è

	)

129 
	#MS_RELATIME
 (1<<21è

	)

130 
	#MS_KERNMOUNT
 (1<<22è

	)

131 
	#MS_I_VERSION
 (1<<23è

	)

132 
	#MS_STRICTATIME
 (1<<24è

	)

133 
	#MS_LAZYTIME
 (1<<25è

	)

136 
	#MS_SUBMOUNT
 (1<<26)

	)

137 
	#MS_NOREMOTELOCK
 (1<<27)

	)

138 
	#MS_NOSEC
 (1<<28)

	)

139 
	#MS_BORN
 (1<<29)

	)

140 
	#MS_ACTIVE
 (1<<30)

	)

141 
	#MS_NOUSER
 (1<<31)

	)

146 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

147 
MS_LAZYTIME
)

	)

152 
	#MS_MGC_VAL
 0xC0ED0000

	)

153 
	#MS_MGC_MSK
 0xffff0000

	)

158 
	sfsx©Œ
 {

159 
__u32
 
	mfsx_xæags
;

160 
__u32
 
	mfsx_extsize
;

161 
__u32
 
	mfsx_Ãx‹Ás
;

162 
__u32
 
	mfsx_´ojid
;

163 
__u32
 
	mfsx_cowextsize
;

164 
	mfsx_·d
[8];

170 
	#FS_XFLAG_REALTIME
 0x00000001

	)

171 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

172 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

173 
	#FS_XFLAG_APPEND
 0x00000010

	)

174 
	#FS_XFLAG_SYNC
 0x00000020

	)

175 
	#FS_XFLAG_NOATIME
 0x00000040

	)

176 
	#FS_XFLAG_NODUMP
 0x00000080

	)

177 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

178 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

179 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

180 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

181 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

182 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

183 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

184 
	#FS_XFLAG_DAX
 0x00008000

	)

185 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

186 
	#FS_XFLAG_HASATTR
 0x80000000

	)

191 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

192 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

193 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

194 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

195 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

196 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

197 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

198 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

199 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

200 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

201 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

202 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

204 
	#BLKPG
 
	`_IO
(0x12,105)

	)

208 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

209 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

214 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

215 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

216 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

217 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

218 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

219 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

220 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

221 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

222 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

223 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

224 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

225 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

226 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

227 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

228 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

229 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

235 
	#BMAP_IOCTL
 1

	)

236 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

237 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

238 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

239 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

240 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

241 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

242 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fe_şÚe_¿nge
)

	)

243 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fe_dedu³_¿nge
)

	)

245 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

246 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

247 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

248 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

249 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

250 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

251 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

252 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

253 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

254 
	#FS_IOC_FSGETXATTR
 
	`_IOR
 ('X', 31, 
fsx©Œ
)

	)

255 
	#FS_IOC_FSSETXATTR
 
	`_IOW
 ('X', 32, 
fsx©Œ
)

	)

261 
	#FS_KEY_DESCRIPTOR_SIZE
 8

	)

263 
	#FS_POLICY_FLAGS_PAD_4
 0x00

	)

264 
	#FS_POLICY_FLAGS_PAD_8
 0x01

	)

265 
	#FS_POLICY_FLAGS_PAD_16
 0x02

	)

266 
	#FS_POLICY_FLAGS_PAD_32
 0x03

	)

267 
	#FS_POLICY_FLAGS_PAD_MASK
 0x03

	)

268 
	#FS_POLICY_FLAGS_VALID
 0x03

	)

271 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

272 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 1

	)

273 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

274 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

275 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 4

	)

276 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 5

	)

277 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 6

	)

279 
	sfsüy±_pŞicy
 {

280 
__u8
 
	mv”siÚ
;

281 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

282 
__u8
 
	mf’ames_’üy±iÚ_mode
;

283 
__u8
 
	mæags
;

284 
__u8
 
	mma¡”_key_desütÜ
[
FS_KEY_DESCRIPTOR_SIZE
];

287 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fsüy±_pŞicy
)

	)

288 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

289 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fsüy±_pŞicy
)

	)

292 
	#FS_KEY_DESC_PREFIX
 "fsüy±:"

	)

293 
	#FS_KEY_DESC_PREFIX_SIZE
 8

	)

296 
	#FS_MAX_KEY_SIZE
 64

	)

298 
	sfsüy±_key
 {

299 
__u32
 
	mmode
;

300 
__u8
 
	m¿w
[
FS_MAX_KEY_SIZE
];

301 
__u32
 
	msize
;

324 
	#FS_SECRM_FL
 0x00000001

	)

325 
	#FS_UNRM_FL
 0x00000002

	)

326 
	#FS_COMPR_FL
 0x00000004

	)

327 
	#FS_SYNC_FL
 0x00000008

	)

328 
	#FS_IMMUTABLE_FL
 0x00000010

	)

329 
	#FS_APPEND_FL
 0x00000020

	)

330 
	#FS_NODUMP_FL
 0x00000040

	)

331 
	#FS_NOATIME_FL
 0x00000080

	)

333 
	#FS_DIRTY_FL
 0x00000100

	)

334 
	#FS_COMPRBLK_FL
 0x00000200

	)

335 
	#FS_NOCOMP_FL
 0x00000400

	)

337 
	#FS_ENCRYPT_FL
 0x00000800

	)

338 
	#FS_BTREE_FL
 0x00001000

	)

339 
	#FS_INDEX_FL
 0x00001000

	)

340 
	#FS_IMAGIC_FL
 0x00002000

	)

341 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

342 
	#FS_NOTAIL_FL
 0x00008000

	)

343 
	#FS_DIRSYNC_FL
 0x00010000

	)

344 
	#FS_TOPDIR_FL
 0x00020000

	)

345 
	#FS_HUGE_FILE_FL
 0x00040000

	)

346 
	#FS_EXTENT_FL
 0x00080000

	)

347 
	#FS_EA_INODE_FL
 0x00200000

	)

348 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

349 
	#FS_NOCOW_FL
 0x00800000

	)

350 
	#FS_INLINE_DATA_FL
 0x10000000

	)

351 
	#FS_PROJINHERIT_FL
 0x20000000

	)

352 
	#FS_RESERVED_FL
 0x80000000

	)

354 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

355 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

358 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

359 
	#SYNC_FILE_RANGE_WRITE
 2

	)

360 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

366 
	t__b™wi£
 
	t__k”Ãl_rwf_t
;

369 
	#RWF_HIPRI
 ((
__k”Ãl_rwf_t
)0x00000001)

	)

372 
	#RWF_DSYNC
 ((
__k”Ãl_rwf_t
)0x00000002)

	)

375 
	#RWF_SYNC
 ((
__k”Ãl_rwf_t
)0x00000004)

	)

378 
	#RWF_NOWAIT
 ((
__k”Ãl_rwf_t
)0x00000008)

	)

381 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
)

	)

	@/usr/include/linux/magic.h

2 #iâdeà
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

23 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

24 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

25 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

26 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

27 
	#NILFS_SUPER_MAGIC
 0x3434

	)

28 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

29 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

30 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

31 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

32 
	#PSTOREFS_MAGIC
 0x6165676C

	)

33 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

34 
	#HOSTFS_SUPER_MAGIC
 0x00c0fãe

	)

35 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

37 
	#MINIX_SUPER_MAGIC
 0x137F

	)

38 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

39 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

40 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

41 
	#MINIX3_SUPER_MAGIC
 0x4d5¨

	)

43 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

44 
	#NCP_SUPER_MAGIC
 0x564ø

	)

45 
	#NFS_SUPER_MAGIC
 0x6969

	)

46 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

47 
	#OPENPROM_SUPER_MAGIC
 0x9ç1

	)

48 
	#QNX4_SUPER_MAGIC
 0x002à

	)

49 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

50 
	#AFS_FS_MAGIC
 0x6B414653

	)

52 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

55 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

56 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

57 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

59 
	#SMB_SUPER_MAGIC
 0x517B

	)

60 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

61 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

63 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

65 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

67 
	#TRACEFS_MAGIC
 0x74726163

	)

69 
	#V9FS_MAGIC
 0x01021997

	)

71 
	#BDEVFS_MAGIC
 0x62646576

	)

72 
	#DAXFS_MAGIC
 0x64646178

	)

73 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

74 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

75 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

76 
	#PIPEFS_MAGIC
 0x50495045

	)

77 
	#PROC_SUPER_MAGIC
 0x9ç0

	)

78 
	#SOCKFS_MAGIC
 0x534F434B

	)

79 
	#SYSFS_MAGIC
 0x62656572

	)

80 
	#USBDEVICE_SUPER_MAGIC
 0x9ç2

	)

81 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

82 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

83 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

84 
	#NSFS_MAGIC
 0x6e736673

	)

85 
	#BPF_FS_MAGIC
 0xÿã4a11

	)

86 
	#AAFS_MAGIC
 0x5a3c69f0

	)

89 
	#UDF_SUPER_MAGIC
 0x15013346

	)

90 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

91 
	#ZSMALLOC_MAGIC
 0x58295829

	)

	@/usr/include/linux/module.h

2 #iâdeà
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/posix_acl_xattr.h

18 #iâdeà
__UAPI_POSIX_ACL_XATTR_H


19 
	#__UAPI_POSIX_ACL_XATTR_H


	)

21 
	~<lšux/ty³s.h
>

24 
	#POSIX_ACL_XATTR_VERSION
 0x0002

	)

27 
	#ACL_UNDEFINED_ID
 (-1)

	)

29 
	sposix_aş_x©Œ_’Œy
 {

30 
__Ë16
 
	me_g
;

31 
__Ë16
 
	me_³rm
;

32 
__Ë32
 
	me_id
;

35 
	sposix_aş_x©Œ_h—d”
 {

36 
__Ë32
 
	ma_v”siÚ
;

	@/usr/include/linux/quota.h

33 #iâdeà
_LINUX_QUOTA_


34 
	#_LINUX_QUOTA_


	)

36 
	~<lšux/ty³s.h
>

38 
	#__DQUOT_VERSION__
 "dquÙ_6.6.0"

	)

40 
	#MAXQUOTAS
 3

	)

41 
	#USRQUOTA
 0

	)

42 
	#GRPQUOTA
 1

	)

43 
	#PRJQUOTA
 2

	)

48 
	#INITQFNAMES
 { \

53 };

	)

61 
	#SUBCMDMASK
 0x00ff

	)

62 
	#SUBCMDSHIFT
 8

	)

63 
	#QCMD
(
cmd
, 
ty³
è(((cmdè<< 
SUBCMDSHIFT
è| (Ñy³è& 
SUBCMDMASK
))

	)

65 
	#Q_SYNC
 0x800001

	)

66 
	#Q_QUOTAON
 0x800002

	)

67 
	#Q_QUOTAOFF
 0x800003

	)

68 
	#Q_GETFMT
 0x800004

	)

69 
	#Q_GETINFO
 0x800005

	)

70 
	#Q_SETINFO
 0x800006

	)

71 
	#Q_GETQUOTA
 0x800007

	)

72 
	#Q_SETQUOTA
 0x800008

	)

73 
	#Q_GETNEXTQUOTA
 0x800009

	)

76 
	#QFMT_VFS_OLD
 1

	)

77 
	#QFMT_VFS_V0
 2

	)

78 
	#QFMT_OCFS2
 3

	)

79 
	#QFMT_VFS_V1
 4

	)

83 
	#QIF_DQBLKSIZE_BITS
 10

	)

84 
	#QIF_DQBLKSIZE
 (1 << 
QIF_DQBLKSIZE_BITS
)

	)

91 
	mQIF_BLIMITS_B
 = 0,

92 
	mQIF_SPACE_B
,

93 
	mQIF_ILIMITS_B
,

94 
	mQIF_INODES_B
,

95 
	mQIF_BTIME_B
,

96 
	mQIF_ITIME_B
,

99 
	#QIF_BLIMITS
 (1 << 
QIF_BLIMITS_B
)

	)

100 
	#QIF_SPACE
 (1 << 
QIF_SPACE_B
)

	)

101 
	#QIF_ILIMITS
 (1 << 
QIF_ILIMITS_B
)

	)

102 
	#QIF_INODES
 (1 << 
QIF_INODES_B
)

	)

103 
	#QIF_BTIME
 (1 << 
QIF_BTIME_B
)

	)

104 
	#QIF_ITIME
 (1 << 
QIF_ITIME_B
)

	)

105 
	#QIF_LIMITS
 (
QIF_BLIMITS
 | 
QIF_ILIMITS
)

	)

106 
	#QIF_USAGE
 (
QIF_SPACE
 | 
QIF_INODES
)

	)

107 
	#QIF_TIMES
 (
QIF_BTIME
 | 
QIF_ITIME
)

	)

108 
	#QIF_ALL
 (
QIF_LIMITS
 | 
QIF_USAGE
 | 
QIF_TIMES
)

	)

110 
	sif_dqblk
 {

111 
__u64
 
	mdqb_bh¬dlim™
;

112 
__u64
 
	mdqb_bsoálim™
;

113 
__u64
 
	mdqb_cur¥aû
;

114 
__u64
 
	mdqb_ih¬dlim™
;

115 
__u64
 
	mdqb_isoálim™
;

116 
__u64
 
	mdqb_curšodes
;

117 
__u64
 
	mdqb_btime
;

118 
__u64
 
	mdqb_™ime
;

119 
__u32
 
	mdqb_v®id
;

122 
	sif_Ãxtdqblk
 {

123 
__u64
 
	mdqb_bh¬dlim™
;

124 
__u64
 
	mdqb_bsoálim™
;

125 
__u64
 
	mdqb_cur¥aû
;

126 
__u64
 
	mdqb_ih¬dlim™
;

127 
__u64
 
	mdqb_isoálim™
;

128 
__u64
 
	mdqb_curšodes
;

129 
__u64
 
	mdqb_btime
;

130 
__u64
 
	mdqb_™ime
;

131 
__u32
 
	mdqb_v®id
;

132 
__u32
 
	mdqb_id
;

139 
	#IIF_BGRACE
 1

	)

140 
	#IIF_IGRACE
 2

	)

141 
	#IIF_FLAGS
 4

	)

142 
	#IIF_ALL
 (
IIF_BGRACE
 | 
IIF_IGRACE
 | 
IIF_FLAGS
)

	)

145 
	mDQF_ROOT_SQUASH_B
 = 0,

146 
	mDQF_SYS_FILE_B
 = 16,

148 
	mDQF_PRIVATE


152 
	#DQF_ROOT_SQUASH
 (1 << 
DQF_ROOT_SQUASH_B
)

	)

154 
	#DQF_SYS_FILE
 (1 << 
DQF_SYS_FILE_B
)

	)

156 
	sif_dqšfo
 {

157 
__u64
 
	mdqi_bg¿û
;

158 
__u64
 
	mdqi_ig¿û
;

159 
__u32
 
	mdqi_æags
;

160 
__u32
 
	mdqi_v®id
;

166 
	#QUOTA_NL_NOWARN
 0

	)

167 
	#QUOTA_NL_IHARDWARN
 1

	)

168 
	#QUOTA_NL_ISOFTLONGWARN
 2

	)

169 
	#QUOTA_NL_ISOFTWARN
 3

	)

170 
	#QUOTA_NL_BHARDWARN
 4

	)

171 
	#QUOTA_NL_BSOFTLONGWARN
 5

	)

172 
	#QUOTA_NL_BSOFTWARN
 6

	)

173 
	#QUOTA_NL_IHARDBELOW
 7

	)

174 
	#QUOTA_NL_ISOFTBELOW
 8

	)

175 
	#QUOTA_NL_BHARDBELOW
 9

	)

176 
	#QUOTA_NL_BSOFTBELOW
 10

	)

179 
	mQUOTA_NL_C_UNSPEC
,

180 
	mQUOTA_NL_C_WARNING
,

181 
	m__QUOTA_NL_C_MAX
,

183 
	#QUOTA_NL_C_MAX
 (
__QUOTA_NL_C_MAX
 - 1)

	)

186 
	mQUOTA_NL_A_UNSPEC
,

187 
	mQUOTA_NL_A_QTYPE
,

188 
	mQUOTA_NL_A_EXCESS_ID
,

189 
	mQUOTA_NL_A_WARNING
,

190 
	mQUOTA_NL_A_DEV_MAJOR
,

191 
	mQUOTA_NL_A_DEV_MINOR
,

192 
	mQUOTA_NL_A_CAUSED_ID
,

193 
	mQUOTA_NL_A_PAD
,

194 
	m__QUOTA_NL_A_MAX
,

196 
	#QUOTA_NL_A_MAX
 (
__QUOTA_NL_A_MAX
 - 1)

	)

	@/usr/include/linux/random.h

8 #iâdeà
_LINUX_RANDOM_H


9 
	#_LINUX_RANDOM_H


	)

11 
	~<lšux/ty³s.h
>

12 
	~<lšux/ioùl.h
>

13 
	~<lšux/œqÄ.h
>

18 
	#RNDGETENTCNT
 
	`_IOR
Ğ'R', 0x00, )

	)

21 
	#RNDADDTOENTCNT
 
	`_IOW
Ğ'R', 0x01, )

	)

24 
	#RNDGETPOOL
 
	`_IOR
Ğ'R', 0x02, [2] )

	)

30 
	#RNDADDENTROPY
 
	`_IOW
Ğ'R', 0x03, [2] )

	)

33 
	#RNDZAPENTCNT
 
	`_IO
Ğ'R', 0x04 )

	)

36 
	#RNDCLEARPOOL
 
	`_IO
Ğ'R', 0x06 )

	)

39 
	#RNDRESEEDCRNG
 
	`_IO
Ğ'R', 0x07 )

	)

41 
	s¿nd_poŞ_šfo
 {

42 
	m’Œİy_couÁ
;

43 
	mbuf_size
;

44 
__u32
 
	mbuf
[0];

53 
	#GRND_NONBLOCK
 0x0001

	)

54 
	#GRND_RANDOM
 0x0002

	)

	@/usr/include/linux/sched.h

2 #iâdeà
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

8 
	#CSIGNAL
 0x000000fà

	)

9 
	#CLONE_VM
 0x00000100

	)

10 
	#CLONE_FS
 0x00000200

	)

11 
	#CLONE_FILES
 0x00000400

	)

12 
	#CLONE_SIGHAND
 0x00000800

	)

13 
	#CLONE_PTRACE
 0x00002000

	)

14 
	#CLONE_VFORK
 0x00004000

	)

15 
	#CLONE_PARENT
 0x00008000

	)

16 
	#CLONE_THREAD
 0x00010000

	)

17 
	#CLONE_NEWNS
 0x00020000

	)

18 
	#CLONE_SYSVSEM
 0x00040000

	)

19 
	#CLONE_SETTLS
 0x00080000

	)

20 
	#CLONE_PARENT_SETTID
 0x00100000

	)

21 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

22 
	#CLONE_DETACHED
 0x00400000

	)

23 
	#CLONE_UNTRACED
 0x00800000

	)

24 
	#CLONE_CHILD_SETTID
 0x01000000

	)

25 
	#CLONE_NEWCGROUP
 0x02000000

	)

26 
	#CLONE_NEWUTS
 0x04000000

	)

27 
	#CLONE_NEWIPC
 0x08000000

	)

28 
	#CLONE_NEWUSER
 0x10000000

	)

29 
	#CLONE_NEWPID
 0x20000000

	)

30 
	#CLONE_NEWNET
 0x40000000

	)

31 
	#CLONE_IO
 0x80000000

	)

36 
	#SCHED_NORMAL
 0

	)

37 
	#SCHED_FIFO
 1

	)

38 
	#SCHED_RR
 2

	)

39 
	#SCHED_BATCH
 3

	)

41 
	#SCHED_IDLE
 5

	)

42 
	#SCHED_DEADLINE
 6

	)

45 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

50 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

51 
	#SCHED_FLAG_RECLAIM
 0x02

	)

	@/usr/include/linux/stat.h

2 #iâdeà
_LINUX_STAT_H


3 
	#_LINUX_STAT_H


	)

5 
	~<lšux/ty³s.h
>

7 #ià
defšed
(
__KERNEL__
è|| !defšed(
__GLIBC__
) || (__GLIBC__ < 2)

9 
	#S_IFMT
 00170000

	)

10 
	#S_IFSOCK
 0140000

	)

11 
	#S_IFLNK
 0120000

	)

12 
	#S_IFREG
 0100000

	)

13 
	#S_IFBLK
 0060000

	)

14 
	#S_IFDIR
 0040000

	)

15 
	#S_IFCHR
 0020000

	)

16 
	#S_IFIFO
 0010000

	)

17 
	#S_ISUID
 0004000

	)

18 
	#S_ISGID
 0002000

	)

19 
	#S_ISVTX
 0001000

	)

21 
	#S_ISLNK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFLNK
)

	)

22 
	#S_ISREG
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFREG
)

	)

23 
	#S_ISDIR
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFDIR
)

	)

24 
	#S_ISCHR
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFCHR
)

	)

25 
	#S_ISBLK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFBLK
)

	)

26 
	#S_ISFIFO
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFIFO
)

	)

27 
	#S_ISSOCK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFSOCK
)

	)

29 
	#S_IRWXU
 00700

	)

30 
	#S_IRUSR
 00400

	)

31 
	#S_IWUSR
 00200

	)

32 
	#S_IXUSR
 00100

	)

34 
	#S_IRWXG
 00070

	)

35 
	#S_IRGRP
 00040

	)

36 
	#S_IWGRP
 00020

	)

37 
	#S_IXGRP
 00010

	)

39 
	#S_IRWXO
 00007

	)

40 
	#S_IROTH
 00004

	)

41 
	#S_IWOTH
 00002

	)

42 
	#S_IXOTH
 00001

	)

56 
	s¡©x_time¡amp
 {

57 
__s64
 
	mtv_£c
;

58 
__u32
 
	mtv_n£c
;

59 
__s32
 
	m__»£rved
;

99 
	s¡©x
 {

101 
__u32
 
	m¡x_mask
;

102 
__u32
 
	m¡x_blksize
;

103 
__u64
 
	m¡x_©Œibu‹s
;

105 
__u32
 
	m¡x_Æšk
;

106 
__u32
 
	m¡x_uid
;

107 
__u32
 
	m¡x_gid
;

108 
__u16
 
	m¡x_mode
;

109 
__u16
 
	m__¥¬e0
[1];

111 
__u64
 
	m¡x_šo
;

112 
__u64
 
	m¡x_size
;

113 
__u64
 
	m¡x_blocks
;

114 
__u64
 
	m¡x_©Œibu‹s_mask
;

116 
¡©x_time¡amp
 
	m¡x_©ime
;

117 
¡©x_time¡amp
 
	m¡x_btime
;

118 
¡©x_time¡amp
 
	m¡x_ùime
;

119 
¡©x_time¡amp
 
	m¡x_mtime
;

121 
__u32
 
	m¡x_rdev_majÜ
;

122 
__u32
 
	m¡x_rdev_mšÜ
;

123 
__u32
 
	m¡x_dev_majÜ
;

124 
__u32
 
	m¡x_dev_mšÜ
;

126 
__u64
 
	m__¥¬e2
[14];

138 
	#STATX_TYPE
 0x00000001U

	)

139 
	#STATX_MODE
 0x00000002U

	)

140 
	#STATX_NLINK
 0x00000004U

	)

141 
	#STATX_UID
 0x00000008U

	)

142 
	#STATX_GID
 0x00000010U

	)

143 
	#STATX_ATIME
 0x00000020U

	)

144 
	#STATX_MTIME
 0x00000040U

	)

145 
	#STATX_CTIME
 0x00000080U

	)

146 
	#STATX_INO
 0x00000100U

	)

147 
	#STATX_SIZE
 0x00000200U

	)

148 
	#STATX_BLOCKS
 0x00000400U

	)

149 
	#STATX_BASIC_STATS
 0x000007ffU

	)

150 
	#STATX_BTIME
 0x00000800U

	)

151 
	#STATX_ALL
 0x00000fffU

	)

152 
	#STATX__RESERVED
 0x80000000U

	)

165 
	#STATX_ATTR_COMPRESSED
 0x00000004

	)

166 
	#STATX_ATTR_IMMUTABLE
 0x00000010

	)

167 
	#STATX_ATTR_APPEND
 0x00000020

	)

168 
	#STATX_ATTR_NODUMP
 0x00000040

	)

169 
	#STATX_ATTR_ENCRYPTED
 0x00000800

	)

171 
	#STATX_ATTR_AUTOMOUNT
 0x00001000

	)

	@/usr/include/linux/types.h

2 #iâdeà
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty³s.h
>

7 #iâdeà
__ASSEMBLY__


9 
	~<lšux/posix_ty³s.h
>

17 #ifdeà
__CHECKER__


18 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

20 
	#__b™wi£__


	)

22 
	#__b™wi£
 
__b™wi£__


	)

24 
__u16
 
	t__b™wi£
 
	t__Ë16
;

25 
__u16
 
	t__b™wi£
 
	t__be16
;

26 
__u32
 
	t__b™wi£
 
	t__Ë32
;

27 
__u32
 
	t__b™wi£
 
	t__be32
;

28 
__u64
 
	t__b™wi£
 
	t__Ë64
;

29 
__u64
 
	t__b™wi£
 
	t__be64
;

31 
__u16
 
	t__b™wi£
 
	t__sum16
;

32 
__u32
 
	t__b™wi£
 
	t__wsum
;

43 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

44 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

45 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

	@/usr/include/linux/uio.h

10 #iâdeà
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<lšux/ty³s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__k”Ãl_size_t
 
	miov_Ën
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/uuid.h

18 #iâdeà
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<lšux/ty³s.h
>

22 
	~<lšux/¡ršg.h
>

25 
__u8
 
	mb
[16];

26 } 
	tguid_t
;

28 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

29 ((
guid_t
) \

30 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

31 (
b
) & 0xff, ((b) >> 8) & 0xff, \

32 (
c
) & 0xff, ((c) >> 8) & 0xff, \

33 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
è}})

	)

36 
guid_t
 
	tuuid_Ë
;

37 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

38 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

39 
	#NULL_UUID_LE
 \

40 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

41 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/xattr.h

12 
	~<lšux/libc-com·t.h
>

14 #iâdeà
_LINUX_XATTR_H


15 
	#_LINUX_XATTR_H


	)

17 #ià
__UAPI_DEF_XATTR


18 
	#__USE_KERNEL_XATTR_DEFS


	)

20 
	#XATTR_CREATE
 0x1

	)

21 
	#XATTR_REPLACE
 0x2

	)

25 
	#XATTR_OS2_PREFIX
 "os2."

	)

26 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
è- 1)

	)

28 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

29 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
è- 1)

	)

31 
	#XATTR_BTRFS_PREFIX
 "bŒfs."

	)

32 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
è- 1)

	)

34 
	#XATTR_SECURITY_PREFIX
 "£cur™y."

	)

35 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
è- 1)

	)

37 
	#XATTR_SYSTEM_PREFIX
 "sy¡em."

	)

38 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
è- 1)

	)

40 
	#XATTR_TRUSTED_PREFIX
 "Œu¡ed."

	)

41 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
è- 1)

	)

43 
	#XATTR_USER_PREFIX
 "u£r."

	)

44 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
è- 1)

	)

47 
	#XATTR_EVM_SUFFIX
 "evm"

	)

48 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

50 
	#XATTR_IMA_SUFFIX
 "ima"

	)

51 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

53 
	#XATTR_SELINUX_SUFFIX
 "£lšux"

	)

54 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

56 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

57 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

58 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

59 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

60 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

61 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

62 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

63 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

64 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

65 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

66 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

67 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

69 
	#XATTR_APPARMOR_SUFFIX
 "­·rmÜ"

	)

70 
	#XATTR_NAME_APPARMOR
 
XATTR_SECURITY_PREFIX
 
XATTR_APPARMOR_SUFFIX


	)

72 
	#XATTR_CAPS_SUFFIX
 "ÿ·b™y"

	)

73 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

75 
	#XATTR_POSIX_ACL_ACCESS
 "posix_aş_acûss"

	)

76 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

77 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_aş_deçuÉ"

	)

78 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/asm/types.h

2 #iâdeà
_ASM_X86_TYPES_H


3 
	#_ASM_X86_TYPES_H


	)

5 
	~<asm-g’”ic/ty³s.h
>

	@/usr/include/linux/ioctl.h

2 #iâdeà
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/ioùl.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/libc-compat.h

49 #iâdeà
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #ià
defšed
(
__GLIBC__
)

56 #ià
defšed
(
_NET_IF_H
è&& defšed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #ià
defšed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #ià
defšed
(
__USE_MISC
è|| defšed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #ià
defšed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #ià
defšed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #iâdeà
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #iâdeà
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #iâdeà
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #iâdeà
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #iâdeà
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #iâdeà
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #iâdeà
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #iâdeà
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #iâdeà
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #iâdeà
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #iâdeà
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #iâdeà
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #iâdeà
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #iâdeà
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #iâdeà
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #iâdeà
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #iâdeà
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #iâdeà
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #iâdeà
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #iâdeà
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #iâdeà
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #iâdeà
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #iâdeà
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #iâdeà
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #iâdeà
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #iâdeà
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<lšux/¡ddef.h
>

22 #undeà
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__k”Ãl_fd_£t
;

30 (*
	t__k”Ãl_sighªdËr_t
)();

33 
	t__k”Ãl_key_t
;

34 
	t__k”Ãl_mqd_t
;

36 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/string.h

2 #iâdeà
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<¡ršg.h
>

	@/usr/include/asm-generic/types.h

2 #iâdeà
_ASM_GENERIC_TYPES_H


3 
	#_ASM_GENERIC_TYPES_H


	)

7 
	~<asm-g’”ic/št-Î64.h
>

	@/usr/include/asm/ioctl.h

1 
	~<asm-g’”ic/ioùl.h
>

	@/usr/include/asm/posix_types.h

2 #ifdeà
__i386__


3 
	~<asm/posix_ty³s_32.h
>

4 #–ià
defšed
(
__ILP32__
)

5 
	~<asm/posix_ty³s_x32.h
>

7 
	~<asm/posix_ty³s_64.h
>

	@/usr/include/linux/stddef.h

4 #iâdeà
__®ways_šlše


5 
	#__®ways_šlše
 
__šlše__


	)

	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

28 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

36 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

37 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

42 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

52 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


53 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

54 
__c
, 
size_t
 
__n
)

55 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

63 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

64 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

67 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


70 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

71 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

72 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

75 #ifdeà
__OPTIMIZE__


76 
__ex‹º_®ways_šlše
 *

77 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


79  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

82 
__ex‹º_®ways_šlše
 const *

83 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


85  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

88 
	}
}

90 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

91 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

94 #ifdeà
__USE_GNU


97 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


98 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

99 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

100 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

101 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

108 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


109 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

110 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

112 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

121 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

122 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

124 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

125 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

129 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

132 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

133 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

137 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

139 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

140 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

146 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

147 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

148 
__THROW
 
	`__nÚnuÎ
 ((2));

150 #ifdeà
__USE_XOPEN2K8


152 
	~<b™s/ty³s/loÿË_t.h
>

155 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__l
)

156 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

159 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

160 
loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

163 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8
 \

164 || 
	$__GLIBC_USE
 (
LIB_EXT2
))

166 *
	$¡rdup
 (cÚ¡ *
__s
)

167 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

173 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

174 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

175 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


180 
	#¡rdu·
(
s
) \

181 (
__ex‹nsiÚ__
 \

183 cÚ¡ *
__Şd
 = (
s
); \

184 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

185 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

186 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

187 
	}
}))

	)

190 
	#¡ºdu·
(
s
, 
n
) \

191 (
__ex‹nsiÚ__
 \

193 cÚ¡ *
__Şd
 = (
s
); \

194 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

195 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

196 
__Ãw
[
__Ën
] = '\0'; \

197 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

198 }))

	)

202 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


205 *
¡rchr
 (*
__s
, 
__c
)

206 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

207 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

208 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

210 #ifdeà
__OPTIMIZE__


211 
__ex‹º_®ways_šlše
 *

212 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


214  
__butš_¡rchr
 (
__s
, 
__c
);

217 
__ex‹º_®ways_šlše
 const *

218 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


220  
__butš_¡rchr
 (
__s
, 
__c
);

225 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

226 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

229 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


232 *
	`¡¼chr
 (*
__s
, 
__c
)

233 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

234 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

235 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

237 #ifdeà
__OPTIMIZE__


238 
__ex‹º_®ways_šlše
 *

239 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


241  
	`__butš_¡¼chr
 (
__s
, 
__c
);

244 
__ex‹º_®ways_šlše
 const *

245 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


247  
	`__butš_¡¼chr
 (
__s
, 
__c
);

250 
	}
}

252 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

253 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

256 #ifdeà
__USE_GNU


259 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


260 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

261 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

262 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

263 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

265 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

266 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

276 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

277 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

279 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


282 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

283 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__OPTIMIZE__


288 
__ex‹º_®ways_šlše
 *

289 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


291  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

294 
__ex‹º_®ways_šlše
 const *

295 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


297  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

300 
	}
}

302 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

303 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

306 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


309 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

310 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

311 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

312 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__OPTIMIZE__


315 
__ex‹º_®ways_šlše
 *

316 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


318  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

321 
__ex‹º_®ways_šlše
 const *

322 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


324  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

327 
	}
}

329 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

330 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

335 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

336 
__THROW
 
	`__nÚnuÎ
 ((2));

340 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

341 cÚ¡ *
__»¡riù
 
__d–im
,

342 **
__»¡riù
 
__§ve_±r
)

343 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

344 #ifdeà
__USE_POSIX


345 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

346 **
__»¡riù
 
__§ve_±r
)

347 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

350 #ifdeà
__USE_GNU


352 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


353 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

354 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

355 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

356 cÚ¡ *
__ÃedË
)

357 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

359 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

360 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 #ifdeà
__USE_GNU


368 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

369 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

370 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

374 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

375 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

376 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

377 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

378 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

379 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

384 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

385 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

387 #ifdef 
__USE_XOPEN2K8


390 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

391 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

397 #ifdeà
__USE_XOPEN2K


405 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


408 #ifdeà
__REDIRECT_NTH


409 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

410 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

411 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

413 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

414 
__THROW
 
	`__nÚnuÎ
 ((2));

415 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

420 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

421 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

425 #ifdeà
__USE_XOPEN2K8


427 *
	$¡»¼Ü_l
 (
__”ºum
, 
loÿË_t
 
__l
è
__THROW
;

430 #ifdeà
__USE_MISC


431 
	~<¡ršgs.h
>

435 
	$ex¶ic™_bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

439 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

440 cÚ¡ *
__»¡riù
 
__d–im
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

444 #ifdef 
__USE_XOPEN2K8


446 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

449 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

450 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

451 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

452 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

456 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

457 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

458 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

460 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

461 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

464 #ifdef 
__USE_GNU


466 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

467 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

470 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

473 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

475 #iâdeà
ba£Çme


480 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


481 "C++" *
	$ba£Çme
 (*
__f’ame
)

482 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

483 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

484 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

486 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

491 #ià
	`__GNUC_PREREQ
 (3,4)

492 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


494 
	~<b™s/¡ršg_fÜtif›d.h
>

498 
__END_DECLS


	@/usr/include/asm-generic/int-ll64.h

9 #iâdeà
_ASM_GENERIC_INT_LL64_H


10 
	#_ASM_GENERIC_INT_LL64_H


	)

12 
	~<asm/b™¥”lÚg.h
>

14 #iâdeà
__ASSEMBLY__


20 
__sigÃd__
 
	t__s8
;

21 
	t__u8
;

23 
__sigÃd__
 
	t__s16
;

24 
	t__u16
;

26 
__sigÃd__
 
	t__s32
;

27 
	t__u32
;

29 #ifdeà
__GNUC__


30 
__ex‹nsiÚ__
 
__sigÃd__
 
	t__s64
;

31 
__ex‹nsiÚ__
 
	t__u64
;

33 
__sigÃd__
 
	t__s64
;

34 
	t__u64
;

	@/usr/include/asm-generic/ioctl.h

2 #iâdeà
_ASM_GENERIC_IOCTL_H


3 
	#_ASM_GENERIC_IOCTL_H


	)

23 
	#_IOC_NRBITS
 8

	)

24 
	#_IOC_TYPEBITS
 8

	)

31 #iâdeà
_IOC_SIZEBITS


32 
	#_IOC_SIZEBITS
 14

	)

35 #iâdeà
_IOC_DIRBITS


36 
	#_IOC_DIRBITS
 2

	)

39 
	#_IOC_NRMASK
 ((1 << 
_IOC_NRBITS
)-1)

	)

40 
	#_IOC_TYPEMASK
 ((1 << 
_IOC_TYPEBITS
)-1)

	)

41 
	#_IOC_SIZEMASK
 ((1 << 
_IOC_SIZEBITS
)-1)

	)

42 
	#_IOC_DIRMASK
 ((1 << 
_IOC_DIRBITS
)-1)

	)

44 
	#_IOC_NRSHIFT
 0

	)

45 
	#_IOC_TYPESHIFT
 (
_IOC_NRSHIFT
+
_IOC_NRBITS
)

	)

46 
	#_IOC_SIZESHIFT
 (
_IOC_TYPESHIFT
+
_IOC_TYPEBITS
)

	)

47 
	#_IOC_DIRSHIFT
 (
_IOC_SIZESHIFT
+
_IOC_SIZEBITS
)

	)

57 #iâdeà
_IOC_NONE


58 
	#_IOC_NONE
 0U

	)

61 #iâdeà
_IOC_WRITE


62 
	#_IOC_WRITE
 1U

	)

65 #iâdeà
_IOC_READ


66 
	#_IOC_READ
 2U

	)

69 
	#_IOC
(
dœ
,
ty³
,
Ä
,
size
) \

70 (((
dœ
è<< 
_IOC_DIRSHIFT
) | \

71 ((
ty³
è<< 
_IOC_TYPESHIFT
) | \

72 ((
Ä
è<< 
_IOC_NRSHIFT
) | \

73 ((
size
è<< 
_IOC_SIZESHIFT
))

	)

75 
	#_IOC_TYPECHECK
(
t
è(Ñ))

	)

83 
	#_IO
(
ty³
,
Ä
è
	`_IOC
(
_IOC_NONE
,Ñy³),Òr),0)

	)

84 
	#_IOR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

85 
	#_IOW
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

86 
	#_IOWR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

87 
	#_IOR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(size))

	)

88 
	#_IOW_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(size))

	)

89 
	#_IOWR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(size))

	)

92 
	#_IOC_DIR
(
Ä
è((Òrè>> 
_IOC_DIRSHIFT
è& 
_IOC_DIRMASK
)

	)

93 
	#_IOC_TYPE
(
Ä
è((Òrè>> 
_IOC_TYPESHIFT
è& 
_IOC_TYPEMASK
)

	)

94 
	#_IOC_NR
(
Ä
è((Òrè>> 
_IOC_NRSHIFT
è& 
_IOC_NRMASK
)

	)

95 
	#_IOC_SIZE
(
Ä
è((Òrè>> 
_IOC_SIZESHIFT
è& 
_IOC_SIZEMASK
)

	)

99 
	#IOC_IN
 (
_IOC_WRITE
 << 
_IOC_DIRSHIFT
)

	)

100 
	#IOC_OUT
 (
_IOC_READ
 << 
_IOC_DIRSHIFT
)

	)

101 
	#IOC_INOUT
 ((
_IOC_WRITE
|
_IOC_READ
è<< 
_IOC_DIRSHIFT
)

	)

102 
	#IOCSIZE_MASK
 (
_IOC_SIZEMASK
 << 
_IOC_SIZESHIFT
)

	)

103 
	#IOCSIZE_SHIFT
 (
_IOC_SIZESHIFT
)

	)

	@/usr/include/asm/posix_types_32.h

2 #iâdeà
_ASM_X86_POSIX_TYPES_32_H


3 
	#_ASM_X86_POSIX_TYPES_32_H


	)

11 
	t__k”Ãl_mode_t
;

12 
	#__k”Ãl_mode_t
 
__k”Ãl_mode_t


	)

14 
	t__k”Ãl_c_pid_t
;

15 
	#__k”Ãl_c_pid_t
 
__k”Ãl_c_pid_t


	)

17 
	t__k”Ãl_uid_t
;

18 
	t__k”Ãl_gid_t
;

19 
	#__k”Ãl_uid_t
 
__k”Ãl_uid_t


	)

21 
	t__k”Ãl_Şd_dev_t
;

22 
	#__k”Ãl_Şd_dev_t
 
__k”Ãl_Şd_dev_t


	)

24 
	~<asm-g’”ic/posix_ty³s.h
>

	@/usr/include/asm/posix_types_64.h

2 #iâdeà
_ASM_X86_POSIX_TYPES_64_H


3 
	#_ASM_X86_POSIX_TYPES_64_H


	)

11 
	t__k”Ãl_Şd_uid_t
;

12 
	t__k”Ãl_Şd_gid_t
;

13 
	#__k”Ãl_Şd_uid_t
 
__k”Ãl_Şd_uid_t


	)

15 
	t__k”Ãl_Şd_dev_t
;

16 
	#__k”Ãl_Şd_dev_t
 
__k”Ãl_Şd_dev_t


	)

18 
	~<asm-g’”ic/posix_ty³s.h
>

	@/usr/include/asm/posix_types_x32.h

2 #iâdeà
_ASM_X86_POSIX_TYPES_X32_H


3 
	#_ASM_X86_POSIX_TYPES_X32_H


	)

14 
	t__k”Ãl_lÚg_t
;

15 
	t__k”Ãl_ulÚg_t
;

16 
	#__k”Ãl_lÚg_t
 
__k”Ãl_lÚg_t


	)

18 
	~<asm/posix_ty³s_64.h
>

	@/usr/include/bits/libc-header-start.h

27 #iâdeà
__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


31 #undeà
__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


33 
	~<ã©u»s.h
>

37 #undeà
__GLIBC_USE_LIB_EXT2


38 #ià(
defšed
 
__USE_GNU
 \

39 || (
defšed
 
	g__STDC_WANT_LIB_EXT2__
 && __STDC_WANT_LIB_EXT2__ > 0))

40 
	#__GLIBC_USE_LIB_EXT2
 1

	)

42 
	#__GLIBC_USE_LIB_EXT2
 0

	)

47 #undeà
__GLIBC_USE_IEC_60559_BFP_EXT


48 #ià
defšed
 
__USE_GNU
 || defšed 
__STDC_WANT_IEC_60559_BFP_EXT__


49 
	#__GLIBC_USE_IEC_60559_BFP_EXT
 1

	)

51 
	#__GLIBC_USE_IEC_60559_BFP_EXT
 0

	)

56 #undeà
__GLIBC_USE_IEC_60559_FUNCS_EXT


57 #ià
defšed
 
__USE_GNU
 || defšed 
__STDC_WANT_IEC_60559_FUNCS_EXT__


58 
	#__GLIBC_USE_IEC_60559_FUNCS_EXT
 1

	)

60 
	#__GLIBC_USE_IEC_60559_FUNCS_EXT
 0

	)

65 #undeà
__GLIBC_USE_IEC_60559_TYPES_EXT


66 #ià
defšed
 
__USE_GNU
 || defšed 
__STDC_WANT_IEC_60559_TYPES_EXT__


67 
	#__GLIBC_USE_IEC_60559_TYPES_EXT
 1

	)

69 
	#__GLIBC_USE_IEC_60559_TYPES_EXT
 0

	)

	@/usr/include/bits/string_fortified.h

18 #iâdeà
_BITS_STRING_FORTIFIED_H


19 
	#_BITS_STRING_FORTIFIED_H
 1

	)

21 #iâdeà
_STRING_H


25 #ià!
__GNUC_PREREQ
 (5,0)

26 
__w¬ndeş
 (
__w¬n_mem£t_z”o_Ën
,

30 
__fÜtify_funùiÚ
 *

31 
__NTH
 (
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

32 
size_t
 
__Ën
))

34  
	`__butš___memıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

35 
	}
}

37 
__fÜtify_funùiÚ
 *

38 
__NTH
 (
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__Ën
))

40  
	`__butš___memmove_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

41 
	}
}

43 #ifdeà
__USE_GNU


44 
__fÜtify_funùiÚ
 *

45 
__NTH
 (
	$mempıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

46 
size_t
 
__Ën
))

48  
	`__butš___mempıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

49 
	}
}

58 
__fÜtify_funùiÚ
 *

59 
__NTH
 (
	$mem£t
 (*
__de¡
, 
__ch
, 
size_t
 
__Ën
))

63 #ià!
	`__GNUC_PREREQ
 (5,0)

64 ià(
	`__butš_cÚ¡ªt_p
 (
__Ën
) && __len == 0

65 && (!
	`__butš_cÚ¡ªt_p
 (
__ch
) || __ch != 0))

67 
	`__w¬n_mem£t_z”o_Ën
 ();

68  
__de¡
;

71  
	`__butš___mem£t_chk
 (
__de¡
, 
__ch
, 
__Ën
, 
	`__bos0
 (__dest));

72 
	}
}

74 #ifdeà
__USE_MISC


75 
	~<b™s/¡ršgs_fÜtif›d.h
>

77 
	$__ex¶ic™_bz”o_chk
 (*
__de¡
, 
size_t
 
__Ën
, size_ˆ
__de¡Ën
)

78 
__THROW
 
	`__nÚnuÎ
 ((1));

80 
__fÜtify_funùiÚ
 

81 
	`__NTH
 (
	$ex¶ic™_bz”o
 (*
__de¡
, 
size_t
 
__Ën
))

83 
	`__ex¶ic™_bz”o_chk
 (
__de¡
, 
__Ën
, 
	`__bos0
 (__dest));

84 
	}
}

87 
__fÜtify_funùiÚ
 *

88 
__NTH
 (
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
))

90  
	`__butš___¡rıy_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

91 
	}
}

93 #ifdeà
__USE_GNU


94 
__fÜtify_funùiÚ
 *

95 
__NTH
 (
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
))

97  
	`__butš___¡pıy_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

98 
	}
}

102 
__fÜtify_funùiÚ
 *

103 
__NTH
 (
	$¡ºıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

104 
size_t
 
__Ën
))

106  
	`__butš___¡ºıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dest));

107 
	}
}

110 *
	$__¡²ıy_chk
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

111 
size_t
 
__de¡Ën
è
__THROW
;

112 *
	`__REDIRECT_NTH
 (
__¡²ıy_®Ÿs
, (*
__de¡
, cÚ¡ *
__¤c
,

113 
size_t
 
__n
), 
¡²ıy
);

115 
__fÜtify_funùiÚ
 *

116 
	`__NTH
 (
	$¡²ıy
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
))

118 ià(
	`__bos
 (
__de¡
è!ğ(
size_t
) -1

119 && (!
	`__butš_cÚ¡ªt_p
 (
__n
è|| __À> 
	`__bos
 (
__de¡
)))

120  
	`__¡²ıy_chk
 (
__de¡
, 
__¤c
, 
__n
, 
	`__bos
 (__dest));

121  
	`__¡²ıy_®Ÿs
 (
__de¡
, 
__¤c
, 
__n
);

122 
	}
}

125 
__fÜtify_funùiÚ
 *

126 
__NTH
 (
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
))

128  
	`__butš___¡rÿt_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

129 
	}
}

132 
__fÜtify_funùiÚ
 *

133 
__NTH
 (
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

134 
size_t
 
__Ën
))

136  
	`__butš___¡ºÿt_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dest));

137 
	}
}

	@/usr/include/bits/types/locale_t.h

19 #iâdeà
_BITS_TYPES_LOCALE_T_H


20 
	#_BITS_TYPES_LOCALE_T_H
 1

	)

22 
	~<b™s/ty³s/__loÿË_t.h
>

24 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/strings.h

18 #iâdef 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	#__Ãed_size_t


	)

23 
	~<¡ddef.h
>

26 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


34 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

38 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

39 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

42 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

45 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`šdex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

50 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

53 #ià
defšed
 
__OPTIMIZE__


54 
__ex‹º_®ways_šlše
 *

55 
	`šdex
 (*
__s
, 
__c
è
__THROW


57  
	`__butš_šdex
 (
__s
, 
__c
);

60 
__ex‹º_®ways_šlše
 const *

61 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


63  
	`__butš_šdex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

69 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

73 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`ršdex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ià
defšed
 
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`ršdex
 (*
__s
, 
__c
è
__THROW


85  
	`__butš_ršdex
 (
__s
, 
__c
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


91  
	`__butš_ršdex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

101 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8
 || defšed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
è
__THROW
 
__©Œibu‹_cÚ¡__
;

109 #ifdef 
__USE_MISC


110 
	$ff¦
 (
__l
è
__THROW
 
__©Œibu‹_cÚ¡__
;

111 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

112 
__THROW
 
__©Œibu‹_cÚ¡__
;

116 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

117 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

120 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<b™s/ty³s/loÿË_t.h
>

128 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__loc
)

129 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

133 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

134 
size_t
 
__n
, 
loÿË_t
 
__loc
)

135 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

138 
__END_DECLS


140 #ià
	`__GNUC_PREREQ
 (3,4è&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
defšed
 
__fÜtify_funùiÚ


143 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


144 
	~<b™s/¡ršgs_fÜtif›d.h
>

	@/usr/include/asm-generic/posix_types.h

2 #iâdeà
__ASM_GENERIC_POSIX_TYPES_H


3 
	#__ASM_GENERIC_POSIX_TYPES_H


	)

5 
	~<asm/b™¥”lÚg.h
>

14 #iâdeà
__k”Ãl_lÚg_t


15 
	t__k”Ãl_lÚg_t
;

16 
	t__k”Ãl_ulÚg_t
;

19 #iâdeà
__k”Ãl_šo_t


20 
__k”Ãl_ulÚg_t
 
	t__k”Ãl_šo_t
;

23 #iâdeà
__k”Ãl_mode_t


24 
	t__k”Ãl_mode_t
;

27 #iâdeà
__k”Ãl_pid_t


28 
	t__k”Ãl_pid_t
;

31 #iâdeà
__k”Ãl_c_pid_t


32 
	t__k”Ãl_c_pid_t
;

35 #iâdeà
__k”Ãl_uid_t


36 
	t__k”Ãl_uid_t
;

37 
	t__k”Ãl_gid_t
;

40 #iâdeà
__k”Ãl_su£cÚds_t


41 
__k”Ãl_lÚg_t
 
	t__k”Ãl_su£cÚds_t
;

44 #iâdeà
__k”Ãl_daddr_t


45 
	t__k”Ãl_daddr_t
;

48 #iâdeà
__k”Ãl_uid32_t


49 
	t__k”Ãl_uid32_t
;

50 
	t__k”Ãl_gid32_t
;

53 #iâdeà
__k”Ãl_Şd_uid_t


54 
__k”Ãl_uid_t
 
	t__k”Ãl_Şd_uid_t
;

55 
__k”Ãl_gid_t
 
	t__k”Ãl_Şd_gid_t
;

58 #iâdeà
__k”Ãl_Şd_dev_t


59 
	t__k”Ãl_Şd_dev_t
;

66 #iâdeà
__k”Ãl_size_t


67 #ià
__BITS_PER_LONG
 != 64

68 
	t__k”Ãl_size_t
;

69 
	t__k”Ãl_ssize_t
;

70 
	t__k”Ãl_±rdiff_t
;

72 
__k”Ãl_ulÚg_t
 
	t__k”Ãl_size_t
;

73 
__k”Ãl_lÚg_t
 
	t__k”Ãl_ssize_t
;

74 
__k”Ãl_lÚg_t
 
	t__k”Ãl_±rdiff_t
;

78 #iâdeà
__k”Ãl_fsid_t


80 
	mv®
[2];

81 } 
	t__k”Ãl_fsid_t
;

87 
__k”Ãl_lÚg_t
 
	t__k”Ãl_off_t
;

88 
	t__k”Ãl_loff_t
;

89 
__k”Ãl_lÚg_t
 
	t__k”Ãl_time_t
;

90 
__k”Ãl_lÚg_t
 
	t__k”Ãl_şock_t
;

91 
	t__k”Ãl_tim”_t
;

92 
	t__k”Ãl_şockid_t
;

93 * 
	t__k”Ãl_ÿddr_t
;

94 
	t__k”Ãl_uid16_t
;

95 
	t__k”Ãl_gid16_t
;

	@/usr/include/asm/bitsperlong.h

2 #iâdeà
__ASM_X86_BITSPERLONG_H


3 
	#__ASM_X86_BITSPERLONG_H


	)

5 #ià
defšed
(
__x86_64__
è&& !defšed(
__ILP32__
)

6 
	#__BITS_PER_LONG
 64

	)

8 
	#__BITS_PER_LONG
 32

	)

11 
	~<asm-g’”ic/b™¥”lÚg.h
>

	@/usr/include/bits/strings_fortified.h

19 #iâdeà
__STRINGS_FORTIFIED


20 
	#__STRINGS_FORTIFIED
 1

	)

22 
__fÜtify_funùiÚ
 

23 
__NTH
 (
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__Ën
))

25 (è
	`__butš___memmove_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

26 
	}
}

28 
__fÜtify_funùiÚ
 

29 
__NTH
 (
	$bz”o
 (*
__de¡
, 
size_t
 
__Ën
))

31 (è
	`__butš___mem£t_chk
 (
__de¡
, '\0', 
__Ën
, 
	`__bos0
 (__dest));

32 
	}
}

	@/usr/include/bits/types/__locale_t.h

20 #iâdeà
_BITS_TYPES___LOCALE_T_H


21 
	#_BITS_TYPES___LOCALE_T_H
 1

	)

28 
	s__loÿË_¡ruù


31 
__loÿË_d©a
 *
	m__loÿËs
[13];

34 cÚ¡ *
	m__ùy³_b
;

35 cÚ¡ *
	m__ùy³_tŞow”
;

36 cÚ¡ *
	m__ùy³_touµ”
;

39 cÚ¡ *
	m__Çmes
[13];

42 
__loÿË_¡ruù
 *
	t__loÿË_t
;

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

119 #undeà
__USE_ISOC11


120 #undeà
__USE_ISOC99


121 #undeà
__USE_ISOC95


122 #undeà
__USE_ISOCXX11


123 #undeà
__USE_POSIX


124 #undeà
__USE_POSIX2


125 #undeà
__USE_POSIX199309


126 #undeà
__USE_POSIX199506


127 #undeà
__USE_XOPEN


128 #undeà
__USE_XOPEN_EXTENDED


129 #undeà
__USE_UNIX98


130 #undeà
__USE_XOPEN2K


131 #undeà
__USE_XOPEN2KXSI


132 #undeà
__USE_XOPEN2K8


133 #undeà
__USE_XOPEN2K8XSI


134 #undeà
__USE_LARGEFILE


135 #undeà
__USE_LARGEFILE64


136 #undeà
__USE_FILE_OFFSET64


137 #undeà
__USE_MISC


138 #undeà
__USE_ATFILE


139 #undeà
__USE_GNU


140 #undeà
__USE_FORTIFY_LEVEL


141 #undeà
__KERNEL_STRICT_NAMES


142 #undeà
__GLIBC_USE_DEPRECATED_GETS


146 #iâdeà
_LOOSE_KERNEL_NAMES


147 
	#__KERNEL_STRICT_NAMES


	)

157 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


158 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

159 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

161 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

168 #ià
defšed
 
__şªg_majÜ__
 && defšed 
__şªg_mšÜ__


169 
	#__glibc_şªg_´”eq
(
maj
, 
mš
) \

170 ((
__şªg_majÜ__
 << 16è+ 
__şªg_mšÜ__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

172 
	#__glibc_şªg_´”eq
(
maj
, 
mš
è0

	)

176 
	#__GLIBC_USE
(
F
è
__GLIBC_USE_
 ## 
	)
F

182 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

183 && !
defšed
 
	g_DEFAULT_SOURCE


185 #undeà
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

190 #ifdeà
_GNU_SOURCE


191 #undeà
_ISOC95_SOURCE


192 
	#_ISOC95_SOURCE
 1

	)

193 #undeà
_ISOC99_SOURCE


194 
	#_ISOC99_SOURCE
 1

	)

195 #undeà
_ISOC11_SOURCE


196 
	#_ISOC11_SOURCE
 1

	)

197 #undeà
_POSIX_SOURCE


198 
	#_POSIX_SOURCE
 1

	)

199 #undeà
_POSIX_C_SOURCE


200 
	#_POSIX_C_SOURCE
 200809L

	)

201 #undeà
_XOPEN_SOURCE


202 
	#_XOPEN_SOURCE
 700

	)

203 #undeà
_XOPEN_SOURCE_EXTENDED


204 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

205 #undeà
_LARGEFILE64_SOURCE


206 
	#_LARGEFILE64_SOURCE
 1

	)

207 #undeà
_DEFAULT_SOURCE


208 
	#_DEFAULT_SOURCE
 1

	)

209 #undeà
_ATFILE_SOURCE


210 
	#_ATFILE_SOURCE
 1

	)

215 #ià(
defšed
 
_DEFAULT_SOURCE
 \

216 || (!
defšed
 
	g__STRICT_ANSI__
 \

217 && !
defšed
 
	g_ISOC99_SOURCE
 \

218 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

219 && !
defšed
 
	g_XOPEN_SOURCE
))

220 #undeà
_DEFAULT_SOURCE


221 
	#_DEFAULT_SOURCE
 1

	)

225 #ià(
defšed
 
_ISOC11_SOURCE
 \

226 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

227 
	#__USE_ISOC11
 1

	)

231 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

232 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

233 
	#__USE_ISOC99
 1

	)

237 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

238 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

239 
	#__USE_ISOC95
 1

	)

242 #ifdeà
__ılu¥lus


244 #ià
__ılu¥lus
 >= 201703L

245 
	#__USE_ISOC11
 1

	)

249 #ià
__ılu¥lus
 >ğ201103L || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__


250 
	#__USE_ISOCXX11
 1

	)

251 
	#__USE_ISOC99
 1

	)

258 #ifdeà
_DEFAULT_SOURCE


259 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


260 
	#__USE_POSIX_IMPLICITLY
 1

	)

262 #undeà
_POSIX_SOURCE


263 
	#_POSIX_SOURCE
 1

	)

264 #undeà
_POSIX_C_SOURCE


265 
	#_POSIX_C_SOURCE
 200809L

	)

268 #ià((!
defšed
 
__STRICT_ANSI__
 \

269 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

270 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

271 
	#_POSIX_SOURCE
 1

	)

272 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

273 
	#_POSIX_C_SOURCE
 2

	)

274 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

275 
	#_POSIX_C_SOURCE
 199506L

	)

276 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

277 
	#_POSIX_C_SOURCE
 200112L

	)

279 
	#_POSIX_C_SOURCE
 200809L

	)

281 
	#__USE_POSIX_IMPLICITLY
 1

	)

290 #ià((!
defšed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

291 && (
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE
))

292 
	#_POSIX_SOURCE
 1

	)

293 #undeà
_POSIX_C_SOURCE


294 
	#_POSIX_C_SOURCE
 199506L

	)

297 #ià(
defšed
 
_POSIX_SOURCE
 \

298 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

299 || 
defšed
 
_XOPEN_SOURCE
)

300 
	#__USE_POSIX
 1

	)

303 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


304 
	#__USE_POSIX2
 1

	)

307 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

308 
	#__USE_POSIX199309
 1

	)

311 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

312 
	#__USE_POSIX199506
 1

	)

315 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

316 
	#__USE_XOPEN2K
 1

	)

317 #undeà
__USE_ISOC95


318 
	#__USE_ISOC95
 1

	)

319 #undeà
__USE_ISOC99


320 
	#__USE_ISOC99
 1

	)

323 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

324 
	#__USE_XOPEN2K8
 1

	)

325 #undeà
_ATFILE_SOURCE


326 
	#_ATFILE_SOURCE
 1

	)

329 #ifdef 
_XOPEN_SOURCE


330 
	#__USE_XOPEN
 1

	)

331 #ià(
_XOPEN_SOURCE
 - 0) >= 500

332 
	#__USE_XOPEN_EXTENDED
 1

	)

333 
	#__USE_UNIX98
 1

	)

334 #undeà
_LARGEFILE_SOURCE


335 
	#_LARGEFILE_SOURCE
 1

	)

336 #ià(
_XOPEN_SOURCE
 - 0) >= 600

337 #ià(
_XOPEN_SOURCE
 - 0) >= 700

338 
	#__USE_XOPEN2K8
 1

	)

339 
	#__USE_XOPEN2K8XSI
 1

	)

341 
	#__USE_XOPEN2K
 1

	)

342 
	#__USE_XOPEN2KXSI
 1

	)

343 #undeà
__USE_ISOC95


344 
	#__USE_ISOC95
 1

	)

345 #undeà
__USE_ISOC99


346 
	#__USE_ISOC99
 1

	)

349 #ifdeà
_XOPEN_SOURCE_EXTENDED


350 
	#__USE_XOPEN_EXTENDED
 1

	)

355 #ifdeà
_LARGEFILE_SOURCE


356 
	#__USE_LARGEFILE
 1

	)

359 #ifdeà
_LARGEFILE64_SOURCE


360 
	#__USE_LARGEFILE64
 1

	)

363 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

364 
	#__USE_FILE_OFFSET64
 1

	)

367 #ià
defšed
 
_DEFAULT_SOURCE


368 
	#__USE_MISC
 1

	)

371 #ifdef 
_ATFILE_SOURCE


372 
	#__USE_ATFILE
 1

	)

375 #ifdef 
_GNU_SOURCE


376 
	#__USE_GNU
 1

	)

379 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

380 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

381 #ià
_FORTIFY_SOURCE
 > 1

382 
	#__USE_FORTIFY_LEVEL
 2

	)

384 
	#__USE_FORTIFY_LEVEL
 1

	)

387 
	#__USE_FORTIFY_LEVEL
 0

	)

394 #ià
defšed
 
__ılu¥lus
 ? __ılu¥lu >ğ201402L : defšed 
__USE_ISOC11


395 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

397 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

402 
	~<¡dc-´edef.h
>

410 #undeà
__GNU_LIBRARY__


411 
	#__GNU_LIBRARY__
 6

	)

415 
	#__GLIBC__
 2

	)

416 
	#__GLIBC_MINOR__
 27

	)

418 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

419 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

422 #iâdeà
__ASSEMBLER__


423 #iâdeà
_SYS_CDEFS_H


424 
	~<sys/cdefs.h
>

429 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


430 
	#__USE_LARGEFILE
 1

	)

431 
	#__USE_LARGEFILE64
 1

	)

437 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

438 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

439 && 
defšed
 
	g__ex‹º_šlše


440 
	#__USE_EXTERN_INLINES
 1

	)

448 
	~<gnu/¡ubs.h
>

	@/usr/include/asm-generic/bitsperlong.h

2 #iâdeà
__ASM_GENERIC_BITS_PER_LONG


3 
	#__ASM_GENERIC_BITS_PER_LONG


	)

12 #iâdeà
__BITS_PER_LONG


13 
	#__BITS_PER_LONG
 32

	)

	@/usr/include/gnu/stubs.h

6 #ià!
defšed
 
__x86_64__


7 
	~<gnu/¡ubs-32.h
>

9 #ià
defšed
 
__x86_64__
 && defšed 
__LP64__


10 
	~<gnu/¡ubs-64.h
>

12 #ià
defšed
 
__x86_64__
 && defšed 
__ILP32__


13 
	~<gnu/¡ubs-x32.h
>

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

61 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/sys/cdefs.h

18 #iâdef 
_SYS_CDEFS_H


19 
	#_SYS_CDEFS_H
 1

	)

22 #iâdeà
_FEATURES_H


23 
	~<ã©u»s.h
>

29 #ià
defšed
 
__GNUC__
 && !defšed 
__STDC__


34 #undeà
__P


35 #undeà
__PMT


37 #ifdeà
__GNUC__


41 #ià
__GNUC_PREREQ
 (4, 6è&& !
defšed
 
_LIBC


42 
	#__LEAF
 , 
__Ëaf__


	)

43 
	#__LEAF_ATTR
 
	`__©Œibu‹__
 ((
__Ëaf__
))

	)

45 
	#__LEAF


	)

46 
	#__LEAF_ATTR


	)

54 #ià!
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (3, 3)

55 
	#__THROW
 
	`__©Œibu‹__
 ((
__nÙhrow__
 
__LEAF
))

	)

56 
	#__THROWNL
 
	`__©Œibu‹__
 ((
__nÙhrow__
))

	)

57 
	#__NTH
(
fù
è
	`__©Œibu‹__
 ((
__nÙhrow__
 
__LEAF
)è
	)
fct

58 
	#__NTHNL
(
fù
è
	`__©Œibu‹__
 ((
__nÙhrow__
)è
	)
fct

60 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

61 
	#__THROW
 
	`throw
 ()

	)

62 
	#__THROWNL
 
	`throw
 ()

	)

63 
	#__NTH
(
fù
è
__LEAF_ATTR
 fù 
	`throw
 ()

	)

64 
	#__NTHNL
(
fù
èfù 
	`throw
 ()

	)

66 
	#__THROW


	)

67 
	#__THROWNL


	)

68 
	#__NTH
(
fù
è
	)
fct

69 
	#__NTHNL
(
fù
è
	)
fct

75 
	#__šlše


	)

77 
	#__THROW


	)

78 
	#__THROWNL


	)

79 
	#__NTH
(
fù
è
	)
fct

86 #ià
defšed
 
__şªg__
 && defšed 
__has_ex‹nsiÚ


87 
	#__glibc_şªg_has_ex‹nsiÚ
(
ext
è
	`__has_ex‹nsiÚ
 (ext)

	)

89 
	#__glibc_şªg_has_ex‹nsiÚ
(
ext
è0

	)

94 
	#__P
(
¬gs
è
	)
args

95 
	#__PMT
(
¬gs
è
	)
args

100 
	#__CONCAT
(
x
,
y
èx ## 
	)
y

101 
	#__STRING
(
x
è#x

	)

104 
	#__±r_t
 *

	)

108 #ifdef 
__ılu¥lus


109 
	#__BEGIN_DECLS
 "C" {

	)

110 
	#__END_DECLS
 }

	)

112 
	#__BEGIN_DECLS


	)

113 
	#__END_DECLS


	)

118 
	#__bos
(
±r
è
	`__butš_objeù_size
 (±r, 
__USE_FORTIFY_LEVEL
 > 1)

	)

119 
	#__bos0
(
±r
è
	`__butš_objeù_size
 (±r, 0)

	)

121 #ià
__GNUC_PREREQ
 (4,3)

122 
	#__w¬ndeş
(
Çme
, 
msg
) \

123 
	`Çme
 (è
	`__©Œibu‹__
((
	`__w¬nšg__
 (
msg
)))

	)

124 
	#__w¬Ç‰r
(
msg
è
	`__©Œibu‹__
((
	`__w¬nšg__
 (msg)))

	)

125 
	#__”rÜdeş
(
Çme
, 
msg
) \

126 
	`Çme
 (è
	`__©Œibu‹__
((
	`__”rÜ__
 (
msg
)))

	)

128 
	#__w¬ndeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

129 
	#__w¬Ç‰r
(
msg
)

	)

130 
	#__”rÜdeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

137 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

138 
	#__æex¬r
 []

	)

139 
	#__glibc_c99_æex¬r_avaabË
 1

	)

140 #–ià
__GNUC_PREREQ
 (2,97)

143 
	#__æex¬r
 []

	)

144 
	#__glibc_c99_æex¬r_avaabË
 1

	)

145 #–ià
defšed
 
__GNUC__


148 
	#__æex¬r
 [0]

	)

149 
	#__glibc_c99_æex¬r_avaabË
 1

	)

152 
	#__æex¬r
 [1]

	)

153 
	#__glibc_c99_æex¬r_avaabË
 0

	)

167 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

169 
	#__REDIRECT
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

170 #ifdeà
__ılu¥lus


171 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

172 
Çme
 
´Ùo
 
__THROW
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

173 
	#__REDIRECT_NTHNL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

174 
Çme
 
´Ùo
 
__THROWNL
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

176 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

177 
Çme
 
´Ùo
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs)è
__THROW


	)

178 
	#__REDIRECT_NTHNL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

179 
Çme
 
´Ùo
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs)è
__THROWNL


	)

181 
	#__ASMNAME
(
úame
è
	`__ASMNAME2
 (
__USER_LABEL_PREFIX__
, cÇme)

	)

182 
	#__ASMNAME2
(
´efix
, 
úame
è
	`__STRING
 (´efixè
	)
cname

195 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

196 
	#__©Œibu‹__
(
xyz
è

	)

202 #ià
__GNUC_PREREQ
 (2,96)

203 
	#__©Œibu‹_m®loc__
 
	`__©Œibu‹__
 ((
__m®loc__
))

	)

205 
	#__©Œibu‹_m®loc__


	)

210 #ià
__GNUC_PREREQ
 (4, 3)

211 
	#__©Œibu‹_®loc_size__
(
·¿ms
) \

212 
	`__©Œibu‹__
 ((
__®loc_size__
 
·¿ms
))

	)

214 
	#__©Œibu‹_®loc_size__
(
·¿ms
è

	)

220 #ià
__GNUC_PREREQ
 (2,96)

221 
	#__©Œibu‹_pu»__
 
	`__©Œibu‹__
 ((
__pu»__
))

	)

223 
	#__©Œibu‹_pu»__


	)

227 #ià
__GNUC_PREREQ
 (2,5)

228 
	#__©Œibu‹_cÚ¡__
 
	`__©Œibu‹__
 ((
__cÚ¡__
))

	)

230 
	#__©Œibu‹_cÚ¡__


	)

236 #ià
__GNUC_PREREQ
 (3,1)

237 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__u£d__
))

	)

238 
	#__©Œibu‹_nošlše__
 
	`__©Œibu‹__
 ((
__nošlše__
))

	)

240 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__unu£d__
))

	)

241 
	#__©Œibu‹_nošlše__


	)

245 #ià
__GNUC_PREREQ
 (3,2)

246 
	#__©Œibu‹_d•»ÿ‹d__
 
	`__©Œibu‹__
 ((
__d•»ÿ‹d__
))

	)

248 
	#__©Œibu‹_d•»ÿ‹d__


	)

254 #ià
__GNUC_PREREQ
 (4,5) || \

255 
	$__glibc_şªg_has_ex‹nsiÚ
 (
__©Œibu‹_d•»ÿ‹d_w™h_mes§ge__
)

256 
	#__©Œibu‹_d•»ÿ‹d_msg__
(
msg
) \

257 
	`__©Œibu‹__
 ((
	`__d•»ÿ‹d__
 (
msg
)))

	)

259 
	#__©Œibu‹_d•»ÿ‹d_msg__
(
msg
è
__©Œibu‹_d•»ÿ‹d__


	)

268 #ià
	`__GNUC_PREREQ
 (2,8)

269 
	#__©Œibu‹_fÜm©_¬g__
(
x
è
	`__©Œibu‹__
 ((
	`__fÜm©_¬g__
 (x)))

	)

271 
	#__©Œibu‹_fÜm©_¬g__
(
x
è

	)

278 #ià
	`__GNUC_PREREQ
 (2,97)

279 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
) \

280 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__¡rfmÚ__
, 
a
, 
b
)))

	)

282 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
è

	)

287 #ià
	`__GNUC_PREREQ
 (3,3)

288 
	#__nÚnuÎ
(
·¿ms
è
	`__©Œibu‹__
 ((
__nÚnuÎ__
…¬ams))

	)

290 
	#__nÚnuÎ
(
·¿ms
)

	)

295 #ià
	`__GNUC_PREREQ
 (3,4)

296 
	#__©Œibu‹_w¬n_unu£d_»suÉ__
 \

297 
	`__©Œibu‹__
 ((
__w¬n_unu£d_»suÉ__
))

	)

298 #ià
__USE_FORTIFY_LEVEL
 > 0

299 
	#__wur
 
__©Œibu‹_w¬n_unu£d_»suÉ__


	)

302 
	#__©Œibu‹_w¬n_unu£d_»suÉ__


	)

304 #iâdeà
__wur


305 
	#__wur


	)

309 #ià
	`__GNUC_PREREQ
 (3,2)

313 #undeà
__®ways_šlše


314 
	#__®ways_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__®ways_šlše__
))

	)

316 #undeà
__®ways_šlše


317 
	#__®ways_šlše
 
__šlše


	)

322 #ià
	`__GNUC_PREREQ
 (4,3)

323 
	#__©Œibu‹_¬tificŸl__
 
	`__©Œibu‹__
 ((
__¬tificŸl__
))

	)

325 
	#__©Œibu‹_¬tificŸl__


	)

337 #ià(!
defšed
 
__ılu¥lus
 || 
	`__GNUC_PREREQ
 (4,3) \

338 || (
defšed
 
__şªg__
 && (defšed 
__GNUC_STDC_INLINE__
 \

339 || 
defšed
 
__GNUC_GNU_INLINE__
)))

340 #ià
defšed
 
__GNUC_STDC_INLINE__
 || defšed 
__ılu¥lus


341 
	#__ex‹º_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

342 
	#__ex‹º_®ways_šlše
 \

343 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

345 
	#__ex‹º_šlše
 
__šlše


	)

346 
	#__ex‹º_®ways_šlše
 
__®ways_šlše


	)

350 #ifdeà
__ex‹º_®ways_šlše


351 
	#__fÜtify_funùiÚ
 
__ex‹º_®ways_šlše
 
__©Œibu‹_¬tificŸl__


	)

356 #ià
	`__GNUC_PREREQ
 (4,3)

357 
	#__va_¬g_·ck
(è
	`__butš_va_¬g_·ck
 ()

	)

358 
	#__va_¬g_·ck_Ën
(è
	`__butš_va_¬g_·ck_Ën
 ()

	)

365 #ià!
	`__GNUC_PREREQ
 (2,8)

366 
	#__ex‹nsiÚ__


	)

370 #ià!
	`__GNUC_PREREQ
 (2,92)

371 
	#__»¡riù


	)

377 #ià
	`__GNUC_PREREQ
 (3,1è&& !
defšed
 
__GNUG__


378 
	#__»¡riù_¬r
 
__»¡riù


	)

380 #ifdeà
__GNUC__


381 
	#__»¡riù_¬r


	)

383 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

384 
	#__»¡riù_¬r
 
»¡riù


	)

387 
	#__»¡riù_¬r


	)

392 #ià
__GNUC__
 >= 3

393 
	#__glibc_uÆik–y
(
cÚd
è
	`__butš_ex³ù
 ((cÚd), 0)

	)

394 
	#__glibc_lik–y
(
cÚd
è
	`__butš_ex³ù
 ((cÚd), 1)

	)

396 
	#__glibc_uÆik–y
(
cÚd
è(cÚd)

	)

397 
	#__glibc_lik–y
(
cÚd
è(cÚd)

	)

400 #ià(!
defšed
 
_NÜ‘uº
 \

401 && (
defšed
 
__STDC_VERSION__
 ? __STDC_VERSION__ : 0) < 201112 \

402 && !
	$__GNUC_PREREQ
 (4,7))

403 #ià
	`__GNUC_PREREQ
 (2,8)

404 
	#_NÜ‘uº
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

	)

406 
	#_NÜ‘uº


	)

410 #ià
	`__GNUC_PREREQ
 (8, 0)

414 
	#__©Œibu‹_nÚ¡ršg__
 
	`__©Œibu‹__
 ((
__nÚ¡ršg__
))

	)

416 
	#__©Œibu‹_nÚ¡ršg__


	)

419 #ià(!
defšed
 
_Stic_as£¹
 && !defšed 
__ılu¥lus
 \

420 && (
defšed
 
__STDC_VERSION__
 ? __STDC_VERSION__ : 0) < 201112 \

421 && (!
	`__GNUC_PREREQ
 (4, 6è|| 
defšed
 
__STRICT_ANSI__
))

422 
	#_Stic_as£¹
(
ex´
, 
dŸgno¡ic
) \

423 (*
	`__Stic_as£¹_funùiÚ
 ()) \

424 [!! (¡ruù { 
__”rÜ_if_Ãg©ive
: (
ex´
è? 2 : -1; })]

	)

427 
	~<b™s/wÜdsize.h
>

428 
	~<b™s/lÚg-doubË.h
>

430 #ià
defšed
 
__LONG_DOUBLE_MATH_OPTIONAL
 && defšed 
__NO_LONG_DOUBLE_MATH


431 
	#__LDBL_COMPAT
 1

	)

432 #ifdeà
__REDIRECT


433 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

434 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
) \

435 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

436 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT_NTH
 (Çme,…rÙo,‡lŸs)

	)

437 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
) \

438 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

439 
	#__LDBL_REDIR1_DECL
(
Çme
, 
®Ÿs
) \

440 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 (#®Ÿs));

	)

441 
	#__LDBL_REDIR_DECL
(
Çme
) \

442 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 ("__Ædbl_" #Çme));

	)

443 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

444 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

445 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

446 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

449 #ià!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT


450 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm
	)
proto

451 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
èÇm
	)
proto

452 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
__THROW


	)

453 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
èÇm´ÙØ
__THROW


	)

454 
	#__LDBL_REDIR_DECL
(
Çme
)

	)

455 #ifdeà
__REDIRECT


456 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

457 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

458 
	`__REDIRECT_NTH
 (
Çme
, 
´Ùo
, 
®Ÿs
)

	)

467 #ià
	`__GNUC_PREREQ
 (4,8è|| 
	`__glibc_şªg_´”eq
 (3,5)

468 
	#__glibc_maüo_w¬nšg1
(
mes§ge
è
	`_P¿gma
 (#mes§ge)

	)

469 
	#__glibc_maüo_w¬nšg
(
mes§ge
) \

470 
	`__glibc_maüo_w¬nšg1
 (
GCC
 
w¬nšg
 
mes§ge
)

	)

472 
	#__glibc_maüo_w¬nšg
(
msg
)

	)

482 #ià!
defšed
 
__ılu¥lus
 \

483 && (
	`__GNUC_PREREQ
 (4, 9) \

484 || 
	`__glibc_şªg_has_ex‹nsiÚ
 (
c_g’”ic_£ËùiÚs
) \

485 || (!
defšed
 
__GNUC__
 && defšed 
__STDC_VERSION__
 \

486 && 
__STDC_VERSION__
 >= 201112L))

487 
	#__HAVE_GENERIC_SELECTION
 1

	)

489 
	#__HAVE_GENERIC_SELECTION
 0

	)

	@/usr/include/bits/long-double.h

	@/usr/include/bits/wordsize.h

3 #ià
defšed
 
__x86_64__
 && !defšed 
__ILP32__


4 
	#__WORDSIZE
 64

	)

6 
	#__WORDSIZE
 32

	)

7 
	#__WORDSIZE32_SIZE_ULONG
 0

	)

8 
	#__WORDSIZE32_PTRDIFF_LONG
 0

	)

11 #ifdeà
__x86_64__


12 
	#__WORDSIZE_TIME64_COMPAT32
 1

	)

14 
	#__SYSCALL_WORDSIZE
 64

	)

16 
	#__WORDSIZE_TIME64_COMPAT32
 0

	)

	@/usr/include/gnu/stubs-32.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub_chæags


	)

11 
	#__¡ub_ç‰ach


	)

12 
	#__¡ub_fchæags


	)

13 
	#__¡ub_fd‘ach


	)

14 
	#__¡ub_g‰y


	)

15 
	#__¡ub_lchmod


	)

16 
	#__¡ub_»voke


	)

17 
	#__¡ub_£ogš


	)

18 
	#__¡ub_sig»tuº


	)

19 
	#__¡ub_s¡k


	)

20 
	#__¡ub_¡ty


	)

	@/usr/include/gnu/stubs-64.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub___com·t_bdæush


	)

11 
	#__¡ub_chæags


	)

12 
	#__¡ub_ç‰ach


	)

13 
	#__¡ub_fchæags


	)

14 
	#__¡ub_fd‘ach


	)

15 
	#__¡ub_g‘msg


	)

16 
	#__¡ub_g‰y


	)

17 
	#__¡ub_lchmod


	)

18 
	#__¡ub_putmsg


	)

19 
	#__¡ub_»voke


	)

20 
	#__¡ub_£ogš


	)

21 
	#__¡ub_sig»tuº


	)

22 
	#__¡ub_s¡k


	)

23 
	#__¡ub_¡ty


	)

	@/usr/include/gnu/stubs-x32.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub___com·t_bdæush


	)

11 
	#__¡ub___com·t_ü—‹_moduË


	)

12 
	#__¡ub___com·t_g‘_k”Ãl_syms


	)

13 
	#__¡ub___com·t_qu”y_moduË


	)

14 
	#__¡ub___com·t_u£lib


	)

15 
	#__¡ub_chæags


	)

16 
	#__¡ub_ç‰ach


	)

17 
	#__¡ub_fchæags


	)

18 
	#__¡ub_fd‘ach


	)

19 
	#__¡ub_g‘msg


	)

20 
	#__¡ub_g‰y


	)

21 
	#__¡ub_lchmod


	)

22 
	#__¡ub_nfs£rvùl


	)

23 
	#__¡ub_putmsg


	)

24 
	#__¡ub_»voke


	)

25 
	#__¡ub_£ogš


	)

26 
	#__¡ub_sig»tuº


	)

27 
	#__¡ub_s¡k


	)

28 
	#__¡ub_¡ty


	)

	@
1
.
1
/usr/include
77
1674
acl.c
acl.h
checkpoint.c
data.c
debug.c
dir.c
extent_cache.c
f2fs.h
f2fs.mod.c
file.c
gc.c
gc.h
hash.c
inline.c
inode.c
namei.c
node.c
node.h
recovery.c
segment.c
segment.h
shrinker.c
super.c
sysfs.c
trace.c
trace.h
verity.c
xattr.c
xattr.h
/usr/include/linux/falloc.h
/usr/include/linux/fs.h
/usr/include/linux/magic.h
/usr/include/linux/module.h
/usr/include/linux/posix_acl_xattr.h
/usr/include/linux/quota.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stat.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/uuid.h
/usr/include/linux/xattr.h
/usr/include/asm/types.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/string.h
/usr/include/asm-generic/types.h
/usr/include/asm/ioctl.h
/usr/include/asm/posix_types.h
/usr/include/linux/stddef.h
/usr/include/string.h
/usr/include/asm-generic/int-ll64.h
/usr/include/asm-generic/ioctl.h
/usr/include/asm/posix_types_32.h
/usr/include/asm/posix_types_64.h
/usr/include/asm/posix_types_x32.h
/usr/include/bits/libc-header-start.h
/usr/include/bits/string_fortified.h
/usr/include/bits/types/locale_t.h
/usr/include/strings.h
/usr/include/asm-generic/posix_types.h
/usr/include/asm/bitsperlong.h
/usr/include/bits/strings_fortified.h
/usr/include/bits/types/__locale_t.h
/usr/include/features.h
/usr/include/asm-generic/bitsperlong.h
/usr/include/gnu/stubs.h
/usr/include/stdc-predef.h
/usr/include/sys/cdefs.h
/usr/include/bits/long-double.h
/usr/include/bits/wordsize.h
/usr/include/gnu/stubs-32.h
/usr/include/gnu/stubs-64.h
/usr/include/gnu/stubs-x32.h
